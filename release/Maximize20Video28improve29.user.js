// ==UserScript==
// @name                Maximize Video(improve)
// @name:zh-CN          视频网页全屏（改）
// @namespace           https://github.com/ryomahan
// @description         Maximize all video players.Support Piture-in-picture.
// @description:zh-CN   让所有视频网页全屏，开启画中画功能
// @author              冻猫, ryomahan
// @include             *
// @exclude             *www.w3school.com.cn*
// @version             12.5
// @run-at              document-end
// @license             MIT
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Maximize20Video28improve29.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Maximize20Video28improve29.meta.js
// ==/UserScript==
(()=>{const e={isFull:!1,isIframe:!1,autoCheckCount:0},t={"www.acfun.cn":[".player-container .player"],"www.bilibili.com":["#bilibiliPlayer"],"www.douyu.com":["#js-player-video-case"],"www.huya.com":["#videoContainer"],"www.twitch.tv":[".player"],"www.youtube.com":["#ytd-player"],"www.miguvideo.com":["#mod-player"],"www.yy.com":["#player"],"*weibo.com":['[aria-label="Video Player"]',".html5-video-live .html5-video"],"v.huya.com":["#video_embed_flash>div"]},o=[".dplayer",".video-js",".jwplayer","[data-player]"];window.top!==window.self&&(e.isIframe=!0),"zh-cn"==navigator.language.toLocaleLowerCase()?e.btnText={max:"网页全屏",pip:"画中画",tip:"Iframe内视频，请用鼠标点击视频后重试"}:e.btnText={max:"Maximize",pip:"PicInPic",tip:"Iframe video. Please click on the video and try again"};const i={print(e){const t=new Date,o="["+t.getFullYear()+"-"+((t.getMonth()+1<10?"0":"")+(t.getMonth()+1))+"-"+((t.getDate()<10?"0":"")+t.getDate())+" "+((t.getHours()<10?"0":"")+t.getHours())+":"+((t.getMinutes()<10?"0":"")+t.getMinutes())+":"+((t.getSeconds()<10?"0":"")+t.getSeconds())+"]";console.log(o+"[Maximize Video] > "+e)},getRect(e){const t=e.getBoundingClientRect(),o=i.getScroll();return{pageX:t.left+o.left,pageY:t.top+o.top,screenX:t.left,screenY:t.top}},isHalfFullClient(e){const t=i.getClient(),o=i.getRect(e);return(Math.abs(t.width-e.offsetWidth)<21&&o.screenX<20||Math.abs(t.height-e.offsetHeight)<21&&o.screenY<10)&&(Math.abs(e.offsetWidth/2+o.screenX-t.width/2)<21&&Math.abs(e.offsetHeight/2+o.screenY-t.height/2)<21)},isAllFullClient(e){const t=i.getClient(),o=i.getRect(e);return Math.abs(t.width-e.offsetWidth)<21&&o.screenX<20&&Math.abs(t.height-e.offsetHeight)<21&&o.screenY<10},getScroll:()=>({left:document.documentElement.scrollLeft||document.body.scrollLeft,top:document.documentElement.scrollTop||document.body.scrollTop}),getClient:()=>({width:"CSS1Compat"==document.compatMode?document.documentElement.clientWidth:document.body.clientWidth,height:"CSS1Compat"==document.compatMode?document.documentElement.clientHeight:document.body.clientHeight}),addStyle(e){const t=document.createElement("style");t.type="text/css";const o=document.createTextNode(e);return t.appendChild(o),document.head.appendChild(t),t},matchRule:(e,t)=>new RegExp("^"+t.split("*").join(".*")+"$").test(e),createButton(e){const t=document.createElement("tbdiv");return t.id=e,t.onclick=()=>{r.playerControl()},document.body.appendChild(t),t},async addTip(e){if(!document.getElementById("catTip")){const t=document.createElement("tbdiv");t.id="catTip",t.innerHTML=e,t.style.cssText='transition: all 0.8s ease-out;background: none repeat scroll 0 0 #27a9d8;color: #FFFFFF;font: 1.1em "微软雅黑";margin-left: -250px;overflow: hidden;padding: 10px;position: fixed;text-align: center;bottom: 100px;z-index: 300;',document.body.appendChild(t),t.style.right=-t.offsetWidth-5+"px",await new Promise((e=>{t.style.display="block",setTimeout((()=>{t.style.right="25px",e("OK")}),300)})),await new Promise((e=>{setTimeout((()=>{t.style.right=-t.offsetWidth-5+"px",e("OK")}),3500)})),await new Promise((e=>{setTimeout((()=>{document.body.removeChild(t),e("OK")}),1e3)}))}}},n={init(){document.getElementById("playerControlBtn")||a(),e.isIframe&&i.isHalfFullClient(e.player)?window.parent.postMessage("iframeVideo","*"):this.show()},show(){e.player.removeEventListener("mouseleave",l.leavePlayer,!1),e.player.addEventListener("mouseleave",l.leavePlayer,!1),e.isFull||(document.removeEventListener("scroll",l.scrollFix,!1),document.addEventListener("scroll",l.scrollFix,!1)),e.controlBtn.style.display="block",e.controlBtn.style.visibility="visible",document.pictureInPictureEnabled&&"OBJECT"!=e.player.nodeName&&"EMBED"!=e.player.nodeName&&(e.picinpicBtn.style.display="block",e.picinpicBtn.style.visibility="visible"),this.locate()},locate(){let t;const o=Boolean(window.trustedTypes&&window.trustedTypes.createPolicy);o&&(t=window.trustedTypes.createPolicy("myEscapePolicy",{createHTML:(e,t)=>e}));const n=i.getRect(e.player);e.controlBtn.style.opacity="0.5",e.controlBtn.innerHTML=o?t.createHTML(e.btnText.max):e.btnText.max,e.controlBtn.style.top=n.screenY-20+"px",e.controlBtn.style.left=n.screenX-64+e.player.offsetWidth+"px",e.picinpicBtn.style.opacity="0.5",e.picinpicBtn.innerHTML=o?t.createHTML(e.btnText.pip):e.btnText.pip,e.picinpicBtn.style.top=e.controlBtn.style.top,e.picinpicBtn.style.left=n.screenX-64+e.player.offsetWidth-54+"px"}},l={getPlayer(r){if(e.isFull)return;e.mouseoverEl=r.target;const a=document.location.hostname;let s=[];for(let e in t)if(i.matchRule(a,e)){for(let o of t[e])if(document.querySelectorAll(o).length>0)for(let e of document.querySelectorAll(o))s.push(e);break}if(0==s.length)for(let e of o)if(document.querySelectorAll(e).length>0)for(let t of document.querySelectorAll(e))s.push(t);if(0==s.length&&"VIDEO"!=r.target.nodeName&&document.querySelectorAll("video").length>0){const t=document.querySelectorAll("video");for(let o of t){const t=o.getBoundingClientRect();if(r.clientX>=t.x-2&&r.clientX<=t.x+t.width+2&&r.clientY>=t.y-2&&r.clientY<=t.y+t.height+2&&o.offsetWidth>399&&o.offsetHeight>220){s=[],s[0]=l.autoCheck(o),e.autoCheckCount=1;break}}}if(s.length>0){const t=r.path||r.composedPath();for(let o of s)if(t.indexOf(o)>-1)return e.player=o,void n.init()}switch(r.target.nodeName){case"VIDEO":case"OBJECT":case"EMBED":r.target.offsetWidth>399&&r.target.offsetHeight>220&&(e.player=r.target,n.init());break;default:l.leavePlayer()}},autoCheck(t){let o,i=t;for(e.playerChilds=[],e.playerChilds.push(t);(i=i.parentNode)&&Math.abs(t.offsetWidth-i.offsetWidth)<15&&Math.abs(t.offsetHeight-i.offsetHeight)<15;)o=i,e.playerChilds.push(i);return o},leavePlayer(){"visible"==e.controlBtn.style.visibility&&(e.controlBtn.style.opacity="",e.controlBtn.style.visibility="",e.picinpicBtn.style.opacity="",e.picinpicBtn.style.visibility="",e.player.removeEventListener("mouseleave",l.leavePlayer,!1),document.removeEventListener("scroll",l.scrollFix,!1))},scrollFix(t){clearTimeout(e.scrollFixTimer),e.scrollFixTimer=setTimeout((()=>{n.locate()}),20)},hotKey(e){27==e.keyCode&&r.playerControl(),113==e.keyCode&&l.pictureInPicture()},async receiveMessage(t){switch(t.data){case"iframePicInPic":i.print("messege:iframePicInPic"),document.pictureInPictureElement?await document.exitPictureInPicture():await document.querySelector("video").requestPictureInPicture().catch((t=>{i.addTip(e.btnText.tip)}));break;case"iframeVideo":i.print("messege:iframeVideo"),e.isFull||(e.player=e.mouseoverEl,n.init());break;case"parentFull":i.print("messege:parentFull"),e.player=e.mouseoverEl,e.isIframe&&window.parent.postMessage("parentFull","*"),r.checkParent(),r.fullWin(),"0px"!=getComputedStyle(e.player).left&&i.addStyle("#htmlToothbrush #bodyToothbrush .playerToothbrush {left:0px !important;width:100vw !important;}"),e.isFull=!0;break;case"parentSmall":i.print("messege:parentSmall"),e.isIframe&&window.parent.postMessage("parentSmall","*"),r.smallWin();break;case"innerFull":i.print("messege:innerFull"),"IFRAME"==e.player.nodeName&&e.player.contentWindow.postMessage("innerFull","*"),r.checkParent(),r.fullWin();break;case"innerSmall":i.print("messege:innerSmall"),"IFRAME"==e.player.nodeName&&e.player.contentWindow.postMessage("innerSmall","*"),r.smallWin()}},pictureInPicture(){document.pictureInPictureElement?document.exitPictureInPicture():e.player?"IFRAME"==e.player.nodeName?e.player.contentWindow.postMessage("iframePicInPic","*"):e.player.parentNode.querySelector("video").requestPictureInPicture():document.querySelector("video").requestPictureInPicture()}},r={playerControl(){if(e.player)if(this.checkParent(),e.isFull)e.isIframe&&window.parent.postMessage("parentSmall","*"),"IFRAME"==e.player.nodeName&&e.player.contentWindow.postMessage("innerSmall","*"),this.smallWin();else if(e.isIframe&&window.parent.postMessage("parentFull","*"),"IFRAME"==e.player.nodeName&&e.player.contentWindow.postMessage("innerFull","*"),this.fullWin(),e.autoCheckCount>0&&!i.isHalfFullClient(e.playerChilds[0])){if(e.autoCheckCount>10){for(let t of e.playerChilds)t.classList.add("videoToothbrush");return}const t=l.autoCheck(e.playerChilds[0]);e.autoCheckCount++,r.playerControl(),e.player=t,r.playerControl()}else e.autoCheckCount=0},checkParent(){if(e.isFull)return;e.playerParents=[];let t=e.player;for(;(t=t.parentNode)&&"BODY"!=t.nodeName;)t.getAttribute&&e.playerParents.push(t)},fullWin(){if(!e.isFull){document.removeEventListener("mouseover",l.getPlayer,!1),e.backHtmlId=document.body.parentNode.id,e.backBodyId=document.body.id,e.leftBtn.style.display="block",e.rightBtn.style.display="block",e.picinpicBtn.style.display="",e.controlBtn.style.display="",this.addClass();const t=document.location.hostname;t.includes("www.youtube.com")&&!document.querySelector("#player-theater-container #movie_player")&&document.querySelector(".html5-video-container").clientWidth-document.querySelector(".ytp-chrome-bottom").clientWidth>24&&(document.querySelector("#movie_player .ytp-size-button").click(),e.ytbStageChange=!0),t.includes("bilibili")&&(document.querySelector(".right-container").style.display="none",document.querySelector("#biliMainHeader").style.display="none")}e.isFull=!0},addClass(){document.body.parentNode.id="htmlToothbrush",document.body.id="bodyToothbrush";for(let t of e.playerParents)t.classList.add("parentToothbrush"),"fixed"==getComputedStyle(t).position&&t.classList.add("absoluteToothbrush");e.player.classList.add("playerToothbrush"),"VIDEO"==e.player.nodeName&&(e.backControls=e.player.controls,e.player.controls=!0),window.dispatchEvent(new Event("resize"))},smallWin(){document.body.parentNode.id=e.backHtmlId,document.body.id=e.backBodyId;for(let t of e.playerParents)t.classList.remove("parentToothbrush"),t.classList.remove("absoluteToothbrush");e.player.classList.remove("playerToothbrush"),"www.youtube.com"==document.location.hostname&&e.ytbStageChange&&document.querySelector("#player-theater-container #movie_player")&&(document.querySelector("#movie_player .ytp-size-button").click(),e.ytbStageChange=!1),"VIDEO"==e.player.nodeName&&(e.player.controls=e.backControls),e.leftBtn.style.display="",e.rightBtn.style.display="",e.controlBtn.style.display="",document.addEventListener("mouseover",l.getPlayer,!1),window.dispatchEvent(new Event("resize"));document.location.hostname.includes("bilibili")&&(document.querySelector(".right-container").style.removeProperty("display"),document.querySelector("#biliMainHeader").style.removeProperty("display")),e.isFull=!1}},a=()=>{e.picinpicBtn=document.createElement("tbdiv"),e.picinpicBtn.id="picinpicBtn",e.picinpicBtn.onclick=()=>{l.pictureInPicture()},document.body.appendChild(e.picinpicBtn),e.controlBtn=i.createButton("playerControlBtn"),e.leftBtn=i.createButton("leftFullStackButton"),e.rightBtn=i.createButton("rightFullStackButton"),"fixed"!=getComputedStyle(e.controlBtn).position&&i.addStyle(["#htmlToothbrush #bodyToothbrush .parentToothbrush .bilibili-player-video {margin:0 !important;}","#htmlToothbrush, #bodyToothbrush {overflow:hidden !important;zoom:100% !important;}","#htmlToothbrush #bodyToothbrush .parentToothbrush {overflow:visible !important;z-index:auto !important;transform:none !important;-webkit-transform-style:flat !important;transition:none !important;contain:none !important;}","#htmlToothbrush #bodyToothbrush .absoluteToothbrush {position:absolute !important;}","#htmlToothbrush #bodyToothbrush .playerToothbrush {position:fixed !important;top:0px !important;left:0px !important;width:100vw !important;height:100vh !important;max-width:none !important;max-height:none !important;min-width:0 !important;min-height:0 !important;margin:0 !important;padding:0 !important;z-index:2147483646 !important;border:none !important;background-color:#000 !important;transform:none !important;}","#htmlToothbrush #bodyToothbrush .parentToothbrush video {object-fit:contain !important;}","#htmlToothbrush #bodyToothbrush .parentToothbrush .videoToothbrush {width:100vw !important;height:100vh !important;}",'#playerControlBtn {text-shadow: none;visibility:hidden;opacity:0;display:none;transition: all 0.5s ease;cursor: pointer;font: 12px "微软雅黑";margin:0;width:64px;height:20px;line-height:20px;border:none;text-align: center;position: fixed;z-index:2147483647;background-color: #27A9D8;color: #FFF;} #playerControlBtn:hover {visibility:visible;opacity:1;background-color:#2774D8;}','#picinpicBtn {text-shadow: none;visibility:hidden;opacity:0;display:none;transition: all 0.5s ease;cursor: pointer;font: 12px "微软雅黑";margin:0;width:53px;height:20px;line-height:20px;border:none;text-align: center;position: fixed;z-index:2147483647;background-color: #27A9D8;color: #FFF;} #picinpicBtn:hover {visibility:visible;opacity:1;background-color:#2774D8;}',"#leftFullStackButton{display:none;position:fixed;width:1px;height:100vh;top:0;left:0;z-index:2147483647;background:#000;}","#rightFullStackButton{display:none;position:fixed;width:1px;height:100vh;top:0;right:0;z-index:2147483647;background:#000;}"].join("\n")),document.addEventListener("mouseover",l.getPlayer,!1),document.addEventListener("keydown",l.hotKey,!1),window.addEventListener("message",l.receiveMessage,!1),i.print("Ready")};a()})();