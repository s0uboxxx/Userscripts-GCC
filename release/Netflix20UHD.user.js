// ==UserScript==
// @name                 Netflix UHD
// @name:zh-CN           Netflix UHD
// @namespace            http://tampermonkey.net/
// @version              1.23
// @description          Play Netflix UHD content on any screen resolution
// @description:zh-CN    让 Netflix 在任何分辨率的显示器上播放 UHD 内容
// @author               TGSAN
// @match                https://www.netflix.com/*
// @icon                 https://www.google.com/s2/favicons?sz=64&domain=netflix.com
// @run-at               document-start
// @grant                unsafeWindow
// @grant                GM_registerMenuCommand
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Netflix20UHD.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Netflix20UHD.meta.js
// ==/UserScript==
!function(){let e;self.unsafeWindow?(console.log("use unsafeWindow mode"),e=self.unsafeWindow):(console.log("use window mode"),e=self.window),delete e.screen,e.__defineGetter__("screen",(function(){let e=[];return e.width=7680,e.height=4320,e.availWidth=7680,e.availHeight=4320,e.availLeft=0,e.availTop=0,e.colorDepth=32,e.isExtended=!1,e.pixelDepth=32,e})),delete e.devicePixelRatio,e.devicePixelRatio=4,e.MSMediaKeys&&(e.MSMediaKeys.isTypeSupportedWithFeaturesOriginal=e.MSMediaKeys.isTypeSupportedWithFeatures,e.MSMediaKeys.isTypeSupportedWithFeatures=function(e,i){return i=i.replace(/,display-res-[x|y]=\d+,display-res-[x|y]=\d+/,""),this.isTypeSupportedWithFeaturesOriginal(e,i)}),e.WebKitMediaKeys&&(e.WebKitMediaKeys.isTypeSupportedOriginal=e.WebKitMediaKeys.isTypeSupported,e.WebKitMediaKeys.isTypeSupported=function(e,i){let t=this.isTypeSupportedOriginal(e,i);return console.log("Hook WebKitMediaKeys",e,i,t),t}),e.navigator.requestMediaKeySystemAccess&&(e.navigator.requestMediaKeySystemAccessOriginal=e.navigator.requestMediaKeySystemAccess,e.navigator.requestMediaKeySystemAccess=async function(i,t){let a=i;i.indexOf("playready");for(let e=0;t.length>e;e++)if(null!=t[e].videoCapabilities)for(let i=0;t[e].videoCapabilities.length>i;i++)t[e].videoCapabilities[i].robustness;return await e.navigator.requestMediaKeySystemAccessOriginal(a,t)}),e.MediaCapabilities.prototype&&(e.MediaCapabilities.prototype.decodingInfoOriginal=e.MediaCapabilities.prototype.decodingInfo,e.MediaCapabilities.prototype.decodingInfo=function(e){let i=this.decodingInfoOriginal(e);return new Promise(((e,t)=>{i.then((i=>{i.powerEfficient=i.supported,i.smooth=i.supported,e(i)})).catch((e=>{t(e)}))}))});!async function(){if(self.GM_registerMenuCommand&&window.MSMediaKeys){let e=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; features="hdcp=0"'),i=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; features="hdcp=1"'),t=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; features="hdcp=2"'),a=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; codecs="hev1,mp4a"; features="hdcp=2"'),o=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.hardware",'video/mp4; codecs="hev1,mp4a"; features="decode-res-x=3840,decode-res-y=2160,decode-bpc=10,hdcp=2"'),r=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; features="hdcp=0"'),d=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; features="hdcp=1"'),s=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; features="hdcp=2"'),n=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; codecs="hev1,mp4a"; features="hdcp=2"'),y=""!=window.MSMediaKeys.isTypeSupportedWithFeaturesOriginal("com.microsoft.playready.software",'video/mp4; codecs="hev1,mp4a"; features="decode-res-x=3840,decode-res-y=2160,decode-bpc=10,hdcp=2"'),p=function(e){return e?"✓":"✕"};GM_registerMenuCommand("PlayReady DRM Info ("+(o?"UHD Ready":"Restricted")+")",(function(){let l="PlayReady DRM (without HDCP 2.2):\n";l+="Hardware: "+p(e)+"    Software: "+p(r)+"\n\n",l+="PlayReady DRM (HDCP 2.2):\n",l+="Hardware: "+p(i)+"    Software: "+p(d)+"\n\n",l+="PlayReady DRM (HDCP 2.2 Type 1):\n",l+="Hardware: "+p(t)+"    Software: "+p(s)+"\n\n",l+="PlayReady DRM (HDCP 2.2 Type 1) with HEVC:\n",l+="Hardware: "+p(a)+"    Software: "+p(n)+"\n\n",l+="PlayReady DRM (HDCP 2.2 Type 1) with HEVC UHD:\n",l+="Hardware: "+p(o)+"    Software: "+p(y)+"\n\n",alert(l)}))}}();GM_registerMenuCommand("Player Info",(function(){console.log("switch player info"),e.dispatchEvent(new KeyboardEvent("keydown",{keyCode:68,ctrlKey:!0,altKey:!0,shiftKey:!0}))})),GM_registerMenuCommand("Stream Selector",(function(){console.log("switch player info"),e.dispatchEvent(new KeyboardEvent("keydown",{keyCode:83,ctrlKey:!0,altKey:!0,shiftKey:!0})),e.dispatchEvent(new KeyboardEvent("keydown",{keyCode:66,ctrlKey:!0,altKey:!0,shiftKey:!0}))})),GM_registerMenuCommand("Player Log",(function(){console.log("switch player log"),e.dispatchEvent(new KeyboardEvent("keydown",{keyCode:76,ctrlKey:!0,altKey:!0,shiftKey:!0}))})),GM_registerMenuCommand("Load Local Subtitle (.DFXP)",(function(){console.log("load local subtitle"),e.dispatchEvent(new KeyboardEvent("keydown",{keyCode:84,ctrlKey:!0,altKey:!0,shiftKey:!0}))}))}();