// ==UserScript==
// @name         Tiktok Video & Slideshow Downloader ðŸŽ¬ðŸ–¼ï¸
// @namespace    https://greasyfork.org/en/scripts/431826
// @version      2.6
// @description  Download TikTok videos without watermark and slideshow images
// @author       YAD
// @match        *://*.tiktok.com/*
// @grant        GM_xmlhttpRequest
// @grant        GM_download
// @require      https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js
// @icon         https://miro.medium.com/v2/resize:fit:512/1*KX6NTUUHWlCP4sCXz28TBA.png
// @license      MIT
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Tiktok20Video20DownloaderF09F8EAC.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Tiktok20Video20DownloaderF09F8EAC.meta.js
// ==/UserScript==
!function(){"use strict";const e=(e,t)=>{const o=e.split("/").pop().split("?")[0];return"video"===t?`TikTok_Video_${o}.mp4`:`TikTok_Image_${o}.jpeg`},t=(e,t,o)=>{const n=document.createElement("div");return Object.assign(n.style,{position:"absolute",right:"15px",top:"27%",transform:"translateY(-50%)",width:"50px",height:"50px",backgroundColor:t,color:"#ffffff",fontSize:"18px",textShadow:"3px 3px 0px #9C1331",textAlign:"center",lineHeight:"50px",borderRadius:"50%",cursor:"pointer",zIndex:"999999"}),n.textContent=e,n.onclick=o,n},o=(e,t,o,n,r=!1)=>{e?(n.textContent="â³",GM_xmlhttpRequest({method:"GET",url:e,responseType:"blob",onload:({response:e})=>{e?r?t.file(o,e):GM_download({url:URL.createObjectURL(e),name:t,onload:()=>{n.textContent="âœ”ï¸",setTimeout((()=>n.remove()),2e3)},onerror:()=>{n.textContent="âœ–ï¸",setTimeout((()=>n.remove()),1500)}}):(n.textContent="âœ–ï¸",setTimeout((()=>n.remove()),1500))},onerror:()=>{n.textContent="âœ–ï¸",setTimeout((()=>n.remove()),1500)},ontimeout:()=>{n.textContent="âœ–ï¸",setTimeout((()=>n.remove()),1500)}})):n.textContent="âœ–ï¸"},n=n=>{let r;n.addEventListener("mouseover",(()=>{r||(r=(n=>{const r=t("ðŸŽžï¸","#ff3b5c",(async t=>{t.stopPropagation(),t.preventDefault(),r.textContent="â³";const s=n.src||n.querySelector("source")?.src;if(s&&s.startsWith("blob:")){r.style.backgroundColor="#ffa700";const t=document.querySelector('[id^="xgwrapper-"]'),n=t?.id.split("-")[2],s=`https://www.tiktok.com/@YAD/video/${n}`,i=document.createElement("iframe");i.style.position="fixed",i.style.visibility="hidden",i.src=s,document.body.appendChild(i);const l=()=>{const t=(i.contentDocument||i.contentWindow.document).querySelector("video");t&&!t.src.startsWith("blob:")?(o(t.src,e(t.src,"video"),"video",r),i.remove()):setTimeout(l,1e3)};setTimeout(l,8e3)}else r.style.backgroundColor="#ff3b5c",o(s,e(s,"video"),"video",r)}));return n.parentNode.style.position="relative",n.parentNode.appendChild(r),r})(n))})),n.addEventListener("mouseout",(e=>{!r||n.contains(e.relatedTarget)||r.contains(e.relatedTarget)||"â³"!==r.textContent&&(r.remove(),r=null)}))},r=e=>{if(e.querySelector(".image-download-btn"))return;const o=t("ðŸ–¼ï¸","#16b1c6",(async()=>{o.textContent="âŒ›";const t=e.querySelectorAll("img");if(!t.length)return alert("No images found!"),void(o.textContent="âœ–ï¸");const n=Array.from(t).map((e=>e.src)),r=[...new Set(n)];if(await new Promise((e=>{e(confirm("Do you want to download images as a ZIP file? Cancel will download individually"))}))){const e=new JSZip;let t=0;r.forEach(((n,s)=>{GM_xmlhttpRequest({method:"GET",url:n,responseType:"blob",onload:n=>{e.file(`image${s+1}.jpeg`,n.response),t++,t===r.length&&e.generateAsync({type:"blob"}).then((e=>{const t=URL.createObjectURL(e);GM_download({url:t,name:"TikTok_Slideshow.zip"}),o.textContent="âœ”ï¸"}))}})}))}else r.forEach(((e,t)=>{GM_download({url:e,name:`image${t+1}.jpeg`,onload:()=>{o.textContent="âœ”ï¸"}})}))}));e.style.position="relative",e.appendChild(o)};new MutationObserver((()=>{document.querySelectorAll('div[class*="DivPhotoVideoContainer"]:not(.processed)').forEach((e=>{e.classList.add("processed"),r(e)}))})).observe(document.body,{childList:!0,subtree:!0}),new MutationObserver((()=>{document.querySelectorAll("video:not(.processed)").forEach((e=>{e.classList.add("processed"),n(e)}))})).observe(document.body,{childList:!0,subtree:!0})}();