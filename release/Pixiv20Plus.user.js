// ==UserScript==
// @name        Pixiv Plus
// @name:zh-CN  Pixiv 增强
// @name:zh-TW  Pixiv 增強
// @namespace   https://github.com/Ahaochan/Tampermonkey
// @version     0.8.6
// @icon        https://www.pixiv.net/favicon.ico
// @description Focus on immersive experience, 1. Block ads, directly access popular pictures 2. Use user to enter the way to search 3. Search pid and uid 4. Display original image and size, picture rename, download original image | gif map | Zip|multiple map zip 5. display artist id, artist background image 6. auto load comment 7. dynamic markup work type 8. remove redirection 9. single page sort 10. control panel select desired function github: https:/ /github.com/Ahaochan/Tampermonkey, welcome to star and fork.
// @description:ja    没入型体験に焦点を当てる、1.人気の写真に直接アクセスする広告をブロックする2.検索する方法を入力するためにユーザーを使用する3.検索pidとuid 4.元の画像とサイズを表示する Zip | multiple map zip 5.アーティストID、アーティストの背景画像を表示します。6.自動ロードコメントを追加します。7.動的マークアップ作業タイプを指定します。8.リダイレクトを削除します。9.シングルページソート10.コントロールパネルを選択します。github：https：/ /github.com/Ahaochan/Tampermonkey、スターとフォークへようこそ。
// @description:zh-CN 专注沉浸式体验，1.屏蔽广告,直接访问热门图片 2.使用users入り的方式搜索 3.搜索pid和uid 4.显示原图及尺寸，图片重命名，下载原图|gif图|动图帧zip|多图zip 5.显示画师id、画师背景图 6.自动加载评论 7.对动态标记作品类型 8.去除重定向 9.单页排序 10.控制面板选择想要的功能 github:https://github.com/Ahaochan/Tampermonkey，欢迎star和fork。
// @description:zh-TW 專注沉浸式體驗，1.屏蔽廣告,直接訪問熱門圖片2.使用users入り的方式搜索3.搜索pid和uid 4.顯示原圖及尺寸，圖片重命名，下載原圖|gif圖|動圖幀zip|多圖zip 5.顯示畫師id、畫師背景圖6.自動加載評論7.對動態標記作品類型8.去除重定向9.單頁排序10.控制面板選擇想要的功能github:https:/ /github.com/Ahaochan/Tampermonkey，歡迎star和fork。
// @author      Ahaochan
// @include     http*://www.pixiv.net*
// @match       http://www.pixiv.net/
// @connect     i.pximg.net
// @connect     i-f.pximg.net
// @connect     i-cf.pximg.net
// @license     GPL-3.0
// @supportURL  https://github.com/Ahaochan/Tampermonkey
// @grant       unsafeWindow
// @grant       GM.xmlHttpRequest
// @grant       GM.setClipboard
// @grant       GM.setValue
// @grant       GM.getValue
// @grant       GM_addStyle
// @grant       GM_xmlhttpRequest
// @grant       GM_registerMenuCommand
// @grant       GM_unregisterMenuCommand
// @grant       GM_setClipboard
// @grant       GM_setValue
// @grant       GM_getValue
// @require     https://cdn.bootcdn.net/ajax/libs/jquery/2.2.4/jquery.min.js
// @require     https://cdn.bootcss.com/jszip/3.1.4/jszip.min.js
// @require     https://cdn.bootcss.com/FileSaver.js/1.3.2/FileSaver.min.js
// @require     https://greasyfork.org/scripts/2963-gif-js/code/gifjs.js?version=8596
// @require     https://greasyfork.org/scripts/375359-gm4-polyfill-1-0-1/code/gm4-polyfill-101.js?version=652238
// @run-at      document-end
// @noframes
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Pixiv20Plus.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Pixiv20Plus.meta.js
// ==/UserScript==
jQuery((t=>{"use strict";t.fn.extend({fitWindow(){this.css("width","auto").css("height","auto").css("max-width","").css("max-height",t(window).height())},replaceTagName(e){const n=[];let o=this.length;for(;o--;){const a=document.createElement(e),i=this[o],r=i.attributes;for(let t=r.length-1;t>=0;t--){const e=r[t];a.setAttribute(e.name,e.value)}a.innerHTML=i.innerHTML,t(i).after(a).remove(),n[o]=a}return t(n)},getBackgroundUrl(){const e=[];return this.each((function(n,{style:o}){let a=t(this).css("background-image")||o.backgroundImage||'url("")';const i=a.match(/url\((['"])(.*?)\1\)/);a=i&&i.length>=2?i[2]:"",e.push(a)})),1===e.length?e[0]:e}});const[e,n]=[console.log,console.error];let o,a;const i=()=>{t.ajax({url:location.href,async:!1,success:e=>{const n=document.createElement("html");n.innerHTML=e,o=JSON.parse(t(n).find('meta[name="global-data"]').attr("content")||"{}"),a=JSON.parse(t(n).find('meta[name="preload-data"]').attr("content")||"{}")}})},r=(document.documentElement.getAttribute("lang")||"en").toLowerCase();let l={};const s=()=>{const e=t("body").attr("ahao_illust_id"),n=location.href.match(/artworks\/(\d*)$/),o=n&&n.length>0?n[1]:"";return parseInt(e)===parseInt(o)||o&&(t("body").attr("ahao_illust_id",o),t.ajax({url:`/ajax/illust/${o}`,dataType:"json",async:!1,success:({body:t})=>l=t})),l},c=()=>(a&&a.user&&Object.keys(a.user)[0]||i(),a&&a.user&&Object.keys(a.user)[0]),d=function(e){let n;n="function"==typeof e?{callback:e,node:document.getElementsByTagName("body")[0],option:{childList:!0,subtree:!0}}:t.extend({callback:()=>{},node:document.getElementsByTagName("body")[0],option:{childList:!0,subtree:!0}},e);const o=new(window.MutationObserver||window.WebKitMutationObserver||window.MozMutationObserver)(((t,e)=>{n.callback.call(this,t,e)}));return o.observe(n.node,n.option),o},u="MO",h="selectorShareBtn",p="switch-img-size",g="switch-img-preload",f="switch-comment",m="switchImgMulti",_="download-name",w={ja:{load_origin:"load_origin",ad_disable:"ad_disable",search_enhance:"search_enhance",download_able:"download_able",artist_info:"artist_info",comment_load:"comment_load",artwork_tag:"artwork_tag",redirect_cancel:"redirect_cancel",watchlist:"ウォッチリストに追加",favorites:"users入り",author:"創作家"},en:{load_origin:"load_origin",ad_disable:"ad_disable",search_enhance:"search_enhance",download_able:"download_able",artist_info:"artist_info",comment_load:"comment_load",artwork_tag:"artwork_tag",redirect_cancel:"redirect_cancel",watchlist:"Add to Watchlist",favorites:"favorites",author:"Author",illegal:"illegal",download:"download",download_wait:"please wait download completed",copy_to_clipboard:"copy to Clipboard",background:"background",background_not_found:"no-background",loginWarning:"Pixiv Plus Script Warning! Please login to Pixiv for a better experience! Failure to login may result in unpredictable bugs!",illust_type_single:"[single pic]",illust_type_multiple:"[multiple pic]",illust_type_gif:"[gif pic]",sort_by_popularity:"Sort_by_popularity(single page)"},ko:{},zh:{load_origin:"加载原图",ad_disable:"屏蔽广告",search_enhance:"搜索增强",download_able:"开启下载",artist_info:"显示作者信息",comment_load:"加载评论",artwork_tag:"作品标记",redirect_cancel:"取消重定向",watchlist:"加入追更列表",favorites:"收藏人数",author:"作者",illegal:"不合法",download:"下载",download_wait:"请等待下载完成",copy_to_clipboard:"已复制到剪贴板",background:"背景图",background_not_found:"无背景图",loginWarning:"Pixiv增强 脚本警告! 请登录Pixiv获得更好的体验! 未登录可能产生不可预料的bug!",illust_type_single:"[单图]",illust_type_multiple:"[多图]",illust_type_gif:"[gif图]",sort_by_popularity:"按收藏数搜索(单页)"},"zh-cn":{},"zh-tw":{load_origin:"加載原圖",ad_disable:"屏蔽廣告",search_enhance:"搜索增強",download_able:"開啟下載",artist_info:"顯示作者信息",comment_load:"加載評論",artwork_tag:"作品標記",redirect_cancel:"取消重定向",watchlist:"加入追蹤列表",favorites:"收藏人數",author:"作者",illegal:"不合法",download:"下載",download_wait:"請等待下載完成",copy_to_clipboard:"已復製到剪貼板",background:"背景圖",background_not_found:"無背景圖",loginWarning:"Pixiv增強 腳本警告! 請登錄Pixiv獲得更好的體驗! 未登錄可能產生不可預料的bug!",illust_type_single:"[單圖]",illust_type_multiple:"[多圖]",illust_type_gif:"[gif圖]",sort_by_popularity:"按收藏數搜索(單頁)"}};w["zh-cn"]=t.extend({},w.zh),w.ja=t.extend({},w.en,w.ja),w.ko=t.extend({},w.en,w.ko);const b=t=>w[r][t]||`i18n[${r}][${t}] not found`;let v=[];const y=()=>{if(v.length){const t=v.length;for(let e=0;e<t;e++)GM_unregisterMenuCommand(v[e])}const t=[["ad_disable",!0],["search_enhance",!0],["download_able",!0],["artist_info",!0],["comment_load",!0],["artwork_tag",!0],["redirect_cancel",!0],["load_origin",!0]],e=t.length;for(let n=0;n<e;n++){const e=t[n][0];t[n][1]=GM_getValue(e),null!==t[n][1]&&void 0!==t[n][1]||(GM_setValue(e,!0),t[n][1]=!0),v[n]=GM_registerMenuCommand(`${t[n][1]?"✅":"❌"} ${b(e)}`,(()=>{GM_setValue(e,!t[n][1]),y()}))}return Object.freeze({ad_disable:t[0][1],search_enhance:t[1][1],download_able:t[2][1],artist_info:t[3][1],comment_load:t[4][1],artwork_tag:t[5][1],redirect_cancel:t[6][1],load_origin:t[7][1]})},x=y(),$=()=>/.+artworks\/\d+.*/.test(location.href),k=()=>/.+\/users\/\d+.*/.test(location.href);(()=>{let e=0;return t.ajax({url:"https://www.pixiv.net/setting_user.php",async:!1}).done(((t,n,o)=>e=o.status)),200===e})()||alert(b("loginWarning"));const M=[["ad_disable",null,()=>{t(".ad").remove(),t("._premium-lead-tag-search-bar").hide(),t(".popular-introduction-overlay").hide(),t(".ad-footer").remove();const e=["iframe","._premium-lead-promotion-banner",'a[href="/premium/lead/lp/?g=anchor&i=popular_works_list&p=popular&page=visitor"]','a[href="/premium/lead/lp/?g=anchor&i=work_detail_remove_ads"]'];return d(((n,o)=>{for(const o of n)for(const n of o.addedNodes)if(n.nodeType===Node.ELEMENT_NODE)for(const o of e)t(n).find(o).hide()}))},()=>!0],["search_enhance",null,()=>d(((o,a)=>{for(let i=0,r=o.length;i<r;i++){const r=o[i],l=t('#js-mount-point-header form:not([action]), #root div[style="position: static; z-index: auto;"] form:not([action])');if("childList"===r.type&&l.length){e("搜索增强 初始化"),l.parent().parent().css("grid-template-columns","1fr minmax(100px, auto) minmax(100px, auto) 2fr 2fr 1fr 2fr"),(e=>{const o=!0,a=e=>{const a=t.extend({$form:null,placeholder:"",url:"",searchType:o},e);a.$form||n("搜索UID和PID 初始化失败, form元素获取失败");const i=a.$form.parent().clone(),r=i.find("form");r.children("div").eq(1).remove(),r.attr("class","ahao-search"),a.$form.parent().before(i);const l=r.find('input[type="text"]:first');l.attr("placeholder",a.placeholder),l.val(""),r.submit((t=>{t.preventDefault();const n=encodeURIComponent(l.val());if(a.searchType&&!/^[0-9]+$/.test(n)){const t=a.placeholder+b("illegal");return void alert(t)}const o=e.url+n;window.open(o),l.val("")}))};a({$form:e,placeholder:"UID",url:"https://www.pixiv.net/users/",searchType:o}),a({$form:e,placeholder:"PID",url:"https://www.pixiv.net/artworks/",searchType:o}),a({$form:e,placeholder:b("author"),url:"https://www.pixiv.net/search_user.php?nick=",searchType:!1})})(l),(e=>{b("favorites");const n=e.find('input[type="text"]:first'),o=t('\n                    <select id="select-ahao-favorites">\n                        <option value=""></option>\n                        <option value="30000users入り">30000users入り</option>\n                        <option value="20000users入り">20000users入り</option>\n                        <option value="10000users入り">10000users入り</option>\n                        <option value="5000users入り" > 5000users入り</option>\n                        <option value="1000users入り" > 1000users入り</option>\n                        <option value="500users入り"  >  500users入り</option>\n                        <option value="300users入り"  >  300users入り</option>\n                        <option value="100users入り"  >  100users入り</option>\n                        <option value="50users入り"   >   50users入り</option>\n                    </select>');o.on("change",(()=>{n.val()&&e.submit()})),e.parent().after(o),e.submit((t=>{t.preventDefault(),o.val()&&(n.val(((t,e)=>e.replace(/\d*users入り/g,""))),n.val(((t,e)=>e.replace(/\d*$/g,""))),n.val(((t,e)=>e.replace(/\s\s*/g,""))),n.val(((t,e)=>`${e} `)),n.val(((t,e)=>`${e}${o.val()}`)));const e=encodeURIComponent(n.val());e&&(location.href=`https://www.pixiv.net/tags/${e}/artworks?s_mode=s_tag`)}))})(l),a.disconnect();break}}})),()=>!0],["download_able",null,async()=>{const n=e=>{const n=t.extend({$shareButtonContainer:void 0,id:"",text:"",clickFun:()=>{}},e),o=n.$shareButtonContainer.clone();return o.addClass("ahao-download-btn").attr("id",n.id).removeClass(n.$shareButtonContainer.attr("class")).css("margin-right","10px").css("position","relative").css("border","1px solid").css("padding","1px 10px").append(`<p style="display: inline">${n.text}</p>`),o.find("button").css("transform","rotate(180deg)").on("click",n.clickFun),n.$shareButtonContainer.after(o),o},o=async e=>{const n=t.extend({$img:void 0,position:"absolute"},e),o=n.$img,a=n.position;1===o.length&&GM.getValue(p,!0).then((e=>{if(e){let e=o.next("span");if(e.length<=0&&(t("body").find(".ahao-img-size").each((function(){const e=t(this);e.prev("canvas, img").length<=0&&e.remove()})),o.after(`<span class="ahao-img-size" style="position: ${a}; right: 0; top: 28px;\n                    color: #ffffff; font-size: x-large; font-weight: bold; -webkit-text-stroke: 1.0px #000000;"></span>`),e=o.next("span")),"IMG"===o.prop("tagName")){const t=new Image;t.src=o.attr("src"),t.onload=function(){e.text(`${this.width}x${this.height}`)}}else{const t=o.attr("width")||o.css("width").replace("px","")||o.css("max-width").replace("px","")||0,n=o.attr("height")||o.css("height").replace("px","")||o.css("max-height").replace("px","")||0;e.text(`${t}x${n}`)}}}))},a=t=>({png:"image/png",jpg:"image/jpeg",gif:"image/gif"}[t]||`mimeType[${t}] not found`),i=t=>t=(t=(t=(t=t.replace("{pid}",s().illustId)).replace("{uid}",s().userId)).replace("{pname}",s().illustTitle)).replace("{uname}",s().userName),r=await GM.getValue(h,".UXmvz"),l=()=>d(((e,n)=>{for(let o=0,a=e.length;o<a;o++){const a=e[o],i=t(a.target);if("section"!==i.prop("tagName").toLowerCase())continue;const r=i.find("section");if(r.length<=0)continue;const l=r.eq(0).children("div").eq(1).attr("class").split(" ")[1];return GM.setValue(h,`.${l}`),void n.disconnect()}})),c=()=>d({callback(e,n){for(let n=0,a=e.length;n<a;n++){const a=e[n],i=t(a.target),r=(t,e,n)=>{const o=t.attr(e);new RegExp(`https?://i(-f|-cf)?.pximg.net.*/${s().id}_.*`).test(o)&&!new RegExp("https?://i(-f|-cf)?.pximg.net/img-original.*").test(o)&&(t.attr(e,n).css("filter","none"),t.fitWindow())};i.find("img[src]").each((function(){const e=t(this),n=e.parent("a").attr("href");n&&(n.endsWith("jpg")||n.endsWith("png"))&&(x.load_origin&&r(e,"src",n),o({$img:e}))}))}},option:{attributes:!0,childList:!0,subtree:!0,attributeFilter:["src","href"]}}),f=()=>d(((l,c)=>{for(let d=0,h=l.length;d<h;d++){const h=l[d],p=t(h.target),f=p.find(r),m=p.find("canvas");if(o({$img:m}),2!==s().illustType||"childList"!==h.type||f.length<=0||p.find("#ahao-download-zip").length>0)continue;e("下载gif图");const w=n({$shareButtonContainer:f,id:"ahao-download-zip",text:"zip"}),b=n({$shareButtonContainer:f,id:"ahao-download-gif",text:"gif",clickFun(){t.ajax({url:`/ajax/illust/${s().illustId}/ugoira_meta`,dataType:"json",success:({body:e})=>{let n;const o=[],r=new GIF({workers:1,quality:10,workerScript:GIF_worker_URL});for(let n=0,i=e.frames,l=i.length;n<l;n++){const e=i[n],c=s().urls.original.replace("ugoira0.",`ugoira${n}.`);GM.xmlHttpRequest({method:"GET",url:c,headers:{referer:"https://www.pixiv.net/"},overrideMimeType:"text/plain; charset=x-user-defined",onload({responseText:i}){const d=i,u=new Uint8Array(d.length);let h=0;for(;h<d.length;)u[h]=d.charCodeAt(h),h++;const p=c.split(".").splice(-1),g=new Blob([u],{type:a(p)}),f=document.createElement("img");f.src=URL.createObjectURL(g),f.width=s().width,f.height=s().height,f.onload=()=>{o[n]={frame:f,option:{delay:e.delay}},Object.keys(o).length>=l&&(t.each(o,((t,e)=>r.addFrame(e.frame,e.option))),r.render())}}})}r.on("progress",(t=>{b.find("p").text(`gif ${parseInt(100*t)}%`)})),r.on("finished",(e=>{n=URL.createObjectURL(e),GM.getValue(_,"{pid}").then((e=>{const o=t(`<a href="${n}" download="${i(e)}"></a>`);b.find("button").wrap(o)}))})),b.find("button").off("click").on("click",(()=>{n||alert("Gif未加载完毕, 请稍等片刻!")}))}})}});t.ajax({url:`/ajax/illust/${s().illustId}/ugoira_meta`,dataType:"json",success:({body:e})=>{GM.getValue(_,"{pid}").then((n=>{const o=t(`<a href="${e.originalSrc}" download="${i(n)}"></a>`);w.find("button").wrap(o)}))}}),GM.getValue(g,!0).then((t=>{t&&b.find("button").click()})),GM.getValue(u,!0).then((t=>{t||c.disconnect()}))}})),w=()=>d(((o,l)=>{for(let c=0,d=o.length;c<d;c++){const d=o[c],h=t(d.target),p=h.find(r);if(!(s().pageCount>1)||"childList"!==d.type||!p.length||h.find("#ahao-download-zip").length)continue;e("下载多图"),GM.getValue(m,!0).then((t=>{t&&p.parent("section").next("button").click()}));const f=new JSZip;let w=0;const v=s().pageCount,y=s().urls.original,x=Array(parseInt(v)).fill().map(((t,e)=>y.replace(/_p\d\./,`_p${e}.`))),$=n({$shareButtonContainer:p,id:"ahao-download-zip",text:`${b("download")}`,clickFun(){if("true"!==t(this).attr("start"))return t(this).attr("start",!0),void t.each(x,((t,e)=>{GM.xmlHttpRequest({method:"GET",url:e,headers:{referer:"https://www.pixiv.net/"},overrideMimeType:"text/plain; charset=x-user-defined",onload({responseText:n}){const o=n,r=new Uint8Array(o.length);let l=0;for(;l<o.length;)r[l]=o.charCodeAt(l),l++;const s=e.split(".").splice(-1),c=new Blob([r],{type:a(s)});GM.getValue(_,"{pid}").then((e=>{f.file(`${i(e)}_${t}.${s}`,c,{binary:!0})})),w++,$.find("p").html(`${b("download")}${w}/${v}`)}})}));w<v?alert(b("download_wait")):GM.getValue(_,"{pid}").then((t=>{f.generateAsync({type:"blob",base64:!0}).then((e=>saveAs(e,i(t))))}))}});GM.getValue(g,!0).then((t=>{t&&$.find("button").click()})),GM.getValue(u,!0).then((t=>{t||l.disconnect()}))}}));return[[l(),l],[c(),c],[f(),f],[w(),w]]},()=>$()],["artist_info",null,()=>{const e=()=>d(((e,n)=>{for(let o=0,i=e.length;o<i;o++){const i=e[o],r=(t(i.target),t(`ul.${"_2AOtfl9"}`).parent());if("childList"!==i.type||r.length<=0||t("body").find("#uid").length>0)continue;const l=r.clone(),s=l.children("ul");l.children(":not(ul)").remove(),s.empty(),r.before(l);const d=c(),h=t(`<li id="uid"><div style="font-size: 20px;font-weight: 700;color: #333;margin-right: 8px;line-height: 1">UID:${d}</div></li>`).on("click",(function(){const e=t(this);e.html(`<span>UID${b("copy_to_clipboard")}</span>`),GM.setClipboard(d),setTimeout((()=>{e.html(`<span>UID${d}</span>`)}),2e3)}));s.append(h);const p=a.user[d].background,g=p&&p.url||"",f=t('<li><div style="font-size: 20px;font-weight: 700;color: #333;margin-right: 8px;line-height: 1"></div></li>'),m=f.find("div");g&&"none"!==g?m.append(`<img src="${g}" width="30px"><a target="_blank" href="${g}">${b("background")}</a>`):m.append(`<span>${b("background_not_found")}</span>`),s.append(f),GM.getValue(u,!0).then((t=>{t||n.disconnect()}))}})),n=()=>d(((e,n)=>{for(let o=0,i=e.length;o<i;o++){const i=e[o],r=t(i.target).parent().find("main").next("aside");if("childList"!==i.type||r.length<=0)continue;const l=r.find("section:first").find("h2");if(l.length<=0||r.find("#ahao-background").length>0)continue;const s=c(),d=a.user[s].background,h=d&&d.url||"",p=l.clone().attr("id","ahao-background");p.children("a").remove(),p.children("div").children("div").remove(),p.prepend(`<img src="${h}" width="10%"/>`),p.find("div a").attr("href",h||"javascript:void(0)").attr("target","_blank").text(b(h?"background":"background_not_found")),l.after(p);const g=l.clone();g.children("a").remove(),g.children("div").children("div").remove(),g.find("a").attr("href","javascript:void(0)").attr("id","ahao-uid").text(`UID: ${s}`),g.on("click",(function(){const e=t(this);e.find("a").text(`UID${b("copy_to_clipboard")}`),GM.setClipboard(s),setTimeout((()=>{e.find("a").text(`UID: ${s}`)}),2e3)})),p.after(g),GM.getValue(u,!0).then((t=>{t||n.disconnect()}))}})),o=()=>d(((e,n)=>{for(let n=0,o=e.length;n<o;n++){const o=e[n];if("childList"!==o.type)continue;const a=t(o.target);a.find('div[role="img"]').each((function(){const e=t(this),n=e.prop("tagName"),o=e.getBackgroundUrl();if(!o)return;const a=t('<img class="ahao-user-img" src=""/>').attr("src",o);return a.css("width",e.css("width")).css("height",e.css("height")),"div"===n.toLowerCase()?(a.attr("class",e.attr("class")),a.html(e.html()),void e.replaceWith((()=>a))):void 0})),a.find("a[data-user_id][data-src]").each((function(){const e=t(this),n=e.find("div"),o=t("<img/>");o.attr("src",e.attr("data-src")),n.length&&(o.attr("class",n.attr("class")).css("width",n.css("width")).css("height",n.css("height")),e.html(o))}))}}));return[[e(),e,()=>k()],[n(),n,()=>$()],[o(),o,()=>!0]]},()=>!0],["comment_load",null,()=>{let n=null;return e("加载评论 初始化"),GM.getValue(f,!0).then((e=>{const o=b("watchlist");n=d(((n,a)=>{if(e&&$())for(let e=0,a=n.length;e<a;e++){const a=n[e];if("childList"!==a.type)continue;const i=t("div > div:eq(2) > div div[role='button']");let r=i[0];r&&(r.textContent===o?i.length>1&&(r=i[1],r.click()):r.click());t(a.target).find("._28zR1MQ").click()}}))})),n},()=>!0],["artwork_tag",null,()=>{e("标记作品 初始化");return d(((e,n)=>{for(let n=0,o=e.length;n<o;n++){const o=e[n],a=t(o.target).find(".stacc_ref_illust_title");"childList"===o.type&&a.length&&a.each((function(){const e=t(this).find("a");if(e.attr("ahao-illust-id"))return;const n=new URL(`${location.origin}/${e.attr("href")}`).searchParams.get("illust_id");e.attr("ahao-illust-id",n),t.ajax({url:`/ajax/illust/${n}`,dataType:"json",success:({body:t})=>{const n=parseInt(t.illustType),o=parseInt(t.pageCount)>1;switch(n){case 0:case 1:e.after(`<p>${b(o?"illust_type_multiple":"illust_type_single")}</p>`);break;case 2:e.after(`<p>${b("illust_type_gif")}</p>`)}}})}))}}))},()=>/.+\/stacc.+/.test(location.href)],["redirect_cancel",null,()=>d(((e,n)=>{for(let n=0,o=e.length;n<o;n++){const o=e[n];if("childList"!==o.type)continue;t(o.target).find('a[href*="jump.php"]').each((function(){const e=t(this),n=e.attr("href").match(/jump\.php\?(url=)?(.*)$/)[2];e.attr("href",decodeURIComponent(n))}))}})),()=>!0]],j=M.length;for(let t=0;t<j;t++)if(x[M[t][0]]&&null===M[t][1]){const e=M[t][2]();e instanceof Promise?e.then((e=>M[t][1]=e)):M[t][1]=e}window.navigation.addEventListener("navigate",(()=>{for(let t=0;t<j;t++)if(x[M[t][0]]){if(M[t][3]())if(M[t][1]instanceof Array){const e=M[t][1];for(let n=0;n<e;n++){const e=M[t][1][n];e[2]()?null===e[0]&&(e[0]=e[1]()):null!==[0]&&(e[0].disconnect(),e[0]=null)}}else null===M[t][1]&&(M[t][1]=M[t][2]());else if(null!==M[t][1])if(M[t][1]instanceof Array){const e=M[t][1];for(let n=0;n<e;n++){const e=M[t][1][n];e[0].disconnect(),e[0]=null}}else M[t][1].disconnect(),M[t][1]=null}else if(null!==M[t][1])if(M[t][1]instanceof Array){const e=M[t][1];for(let n=0;n<e;n++){const e=M[t][1][n];null!==e[0]&&(e[0].disconnect(),e[0]=null)}}else M[t][1].disconnect(),M[t][1]=null})),!/.+\/search\.php.*/.test(location.href)&&/.+\/tags\/.*\/artworks.*/.test(location.href),window.history}));