// ==UserScript==
// @name         Bilibili international subtitle downloader
// @version      0.7.5
// @description  Download subtitle from bilibili.tv
// @author       AdvMaple
// @match        /\:\/\/.*.bilibili.*\/(\w\/|)(play|video)\/.*$/
// @include      /\:\/\/.*.bilibili.*\/(\w\/|)(play|video)\/.*$/
// @icon         https://www.google.com/s2/favicons?domain=biliintl.com
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/download.meta.js
// @grant        GM_addStyle

// ==/UserScript==
!function(){const e="en",t="srt",n=112,i=12,o=[{id:"en",label:"English"},{id:"th",label:"ภาษาไทย"},{id:"vi",label:"Tiếng Việt"},{id:"id",label:"Bahasa Indonesia"},{id:"ms",label:"Bahasa Melayu"},{id:"zh-Hans",label:"中文（简体）"},{id:"zh-Hant",label:"中文（繁体）"}],a=["ass","srt","vtt","json"],l=[{id:7,label:"AVC"},{id:12,label:"HEVC"}],d=[{id:120,label:"4K"},{id:112,label:"1080P(HD)"},{id:80,label:"1080P"},{id:64,label:"720P"},{id:32,label:"480P"},{id:16,label:"320P"},{id:6,label:"240P"},{id:5,label:"144P"}],s={en:{gen_this_link:"Generate Links for this EP",gen_links:"Generate Links",subtitle:"Subtitle",video:"Video",audio:"Audio"},th:{gen_this_link:"สร้างการดาวน์โหลดสำหรับ EP นี้",gen_links:"สร้างการดาวน์โหลด",subtitle:"คำบรรยาย",video:"วิดีโอ",audio:"เสียง"}};let r=localStorage.getItem("SUB_LANGUAGE");r||(localStorage.setItem("SUB_LANGUAGE",e),r=e);let c=localStorage.getItem("SUB_FORMAT");c||(localStorage.setItem("SUB_FORMAT",t),c=t);let u=localStorage.getItem("VIDEO_QUALITY");u||(localStorage.setItem("VIDEO_QUALITY",n),u=n);let p=localStorage.getItem("VIDEO_CODEC");p||(localStorage.setItem("VIDEO_CODEC",i),p=i);let b=location.pathname.split("/")[1];Object.keys(s).includes(b)||(b="en");const{ep_id:m,video_id:_,season_id:g}=x();function f({ep_url:e,ep_title:t}){const n=document.createElement("a");n.textContent=t,n.href=e,n.download=`${t}.mp4`,n.type="video/mp4",document.getElementById("videoList").appendChild(n)}(m>0||g>0||_>0)&&function e({ep_id:t,season_id:n,video_id:i}){const o=i>0,a=t>0,s=n>0,r=a||s?a?`ep_id=${t}`:`season_id=${n}`:`aid=${i}`;fetch(`https://api.bilibili.tv/intl/gateway/web/playurl?${r}&platform=web&device=wap&qn=64&tf=0&type=0`,{credentials:"include"}).then((e=>e.json())).then((({data:t})=>{if(a||o){const e=function(e){const t=e=>(l.find((t=>t.id===e))||{}).label||"Unknown Codec",n=(e="")=>(t,n)=>t[e]<n[e]?1:t[e]>n[e]?-1:0,i=e||d;let o="";return i.sort(n("codec_id")).sort(n("id")).forEach((e=>{o+=`<option value="${e.id};${e.codec_id}" ${u===`${e.id}`&&p===`${e.codec_id}`?"selected":""}>[${t(e.codec_id)}] ${e.label} </option>`})),o}(t.playurl.video.filter((e=>!!e.video_resource.url)).map((e=>({codec_id:e.video_resource.codec_id,id:e.video_resource.quality,label:e.stream_info.desc_words}))));document.getElementById("changeQuality").innerHTML=e}else if(t?.sections?.length>0){const n=t?.sections[0].episodes;if(n.length>0){const t=n[0].episode_id;e(t)}}}))}({ep_id:m,season_id:g,video_id:_});let v=document.createElement("div");v.innerHTML=`\n    <button id="down-this" class="btn" type="button"> ${s[b].gen_this_link} </button>\n\n    <select id="changeLanguage" class="subtitleSelect" name="lang">\n      ${o.map((e=>`<option value="${e.id}" ${r===e.id?"selected":""}> ${e.label} </option>`))}\n    </select>\n\n    <select id="changeSubFormat" class="subtitleSelect" name="lang-format">\n      ${a.map((e=>`<option value="${e}" ${c===e?"selected":""}> ${e.toUpperCase()} </option>`))}\n    </select>\n\n    <select id="changeQuality" class="subtitleSelect" name="quality">\n\n    </select>\n\n    <div class="linkContainer" id="jsonSubtitleList">${s[b].subtitle}&nbsp;:&nbsp;</div>\n\n    <div class="linkContainer" id="videoList" >${s[b].video}&nbsp;:&nbsp;</div>\n\n    <div class="linkContainer" id="audioList" >${s[b].audio}&nbsp;:&nbsp;</div>\n\n    <div id="plugin_notice"></div>\n\n    <div id="snackbar"></div>\n  `,v.setAttribute("id","downloadBiliintScript"),document.body.appendChild(v),document.getElementById("down-this").addEventListener("click",S,!1),document.getElementById("changeLanguage").addEventListener("change",(function(e){localStorage.setItem("SUB_LANGUAGE",e.target.value),r=e.target.value,S()}),!1),document.getElementById("changeSubFormat").addEventListener("change",(function(e){localStorage.setItem("SUB_FORMAT",e.target.value),c=e.target.value,S()}),!1),document.getElementById("changeQuality").addEventListener("change",(function(e){const t=e.target.value.split(";");localStorage.setItem("VIDEO_QUALITY",t[0]),u=e.target.value,localStorage.setItem("VIDEO_CODEC",t[1]),p=e.target.value,S()}),!1);const y=e=>{try{JSON.parse(e)}catch(e){return!1}return!0},h=async({ep_title:e,ep_sub_url:t})=>{const n=await fetch(t),i=await n.text();let o="unknown format",a=c;if(y(i)){o="json";const t=JSON.parse(i);let n,l="";if("vtt"===c||"srt"===c||"ass"===c){const e=e=>{let t=new Date(0),n=new Date(1e3*e);return new Date(n.getTime()-t.getTime()).toISOString().split("T")[1].split("Z")[0]};"vtt"===c&&(l+=`WEBVTT\nKind: captions\nLanguage: ${r}\n\n`),t.body.forEach(((t,n)=>{const i=e(void 0!==t.from?t.from:0),o=e(t.to);l+=n+1+"\n",l+=`${i.replace(".",",")} --\x3e ${o.replace(".",",")}\n`,l+=t.content+"\n\n"})),n=new Blob([l],{type:"text/"+("vtt"===c?"vtt":"plain")})}else n=new Blob([JSON.stringify(t)],{type:"application/json"});"ass"===c&&(a="srt",E(".ass format subtitles are not available, the plugin will automatically create subtitle links in .srt format!")),$({file_name:e,blob:n,file_format:a})}else if(i.includes("[V4+ Styles]")){o="ass";$({file_name:e,blob:new Blob([i],{type:"text/plain"}),file_format:a})}else alert("Format subtitles .ass problematic, please contact DEV");!function(e){const t=document.getElementById("snackbar");t.className="show",t.innerText=e,I&&(I=clearTimeout(I));I=setTimeout((function(){t.className=t.className.replace("show","")}),3e3)}(`The server is returning ${o} file. The generated link is .${a} file`)};function $({file_name:e,blob:t,file_format:n=c}){const i=document.createElement("a");i.download=`${e}.${r}.${n}`,i.textContent=`${e}`,i.href=URL.createObjectURL(t),document.getElementById("jsonSubtitleList").appendChild(i)}function w(){const e=function(){const e=function(){const e=document.head.querySelector("[property='og:title'][content]")?.content?.replace(" HD | bilibili",""),t=document.body.querySelector(".video-play .video-play__meta .bstar-meta .bstar-meta__title")?.innerText,n=document.body.querySelector(".video-play .video-play__meta .bstar-meta .bstar-meta__extra .bstar-meta__origin-name .bstar-meta__origin-name-content")?.innerText,i=document.body.querySelector(".video-play .video-play__meta .bstar-meta .bstar-meta__extra .bstar-meta__alias .bstar-meta__alias-content")?.innerText;return e||t||i||n}(),t=document.title?.replace(" - BiliBili","")?.replace(`${e} `,""),n=document.body.querySelector(".video-play__breadcrumb .breadcrumb__item:last-child > .breadcrumb__item-text")?.innerText,i=n||t,o=i.split(" - ")[0],a=i.split(" - ")[1];let l,d=o?.replace(/[^0-9]/g,"");"string"==typeof d&&(d=Number.parseInt(d));l=d>=0?`E${d}${a?` - ${a}`:""}`:`${o||e} - ${a||i}`;return l}(),{ep_id:t,video_id:n}=x();(t>0||n>0)&&(async function({ep_id:e,video_id:t,ep_title:n}){const i=`https://api.bilibili.tv/intl/gateway/web/v2/subtitle?s_locale=${r}&platform=web&${e>0?`episode_id=${e}`:`aid=${t}`}`,o=await fetch(i,{credentials:"include"}),a=await o.text();if(y(a)){const{data:e}=JSON.parse(a);null!==e.subtitles&&null!==e.video_subtitle||alert("There is no suitable subtitle data");const t=e.subtitles||e.video_subtitle||[];let i;for(let n=0;n<t.length;n++)if(t[n].lang_key===r&&!i){const t=e.subtitles[n].url,o=e.video_subtitle[n].srt?.url||t;i=["srt","ass"].includes(c)&&(e.video_subtitle[n][c]?.url||t)||o}i?h({ep_title:n,ep_sub_url:i}):E("The language you selected, does not have subtitle files!")}else alert("Can't get subtitles data, please contact DEV")}({ep_id:t,video_id:n,ep_title:`${e} [${t||n}]`}),function({ep_id:e,video_id:t,ep_title:n}){fetch(`https://api.bilibili.tv/intl/gateway/web/playurl?${e>0?`ep_id=${e}`:`aid=${t}`}&device=wap&platform=web&qn=64&tf=0&type=0`,{credentials:"include"}).then((e=>e.json())).then((({data:e})=>{var t=0,i=0;const o=e.playurl,a=Number(u),l=Number(p),d=o.video.findIndex((e=>e.video_resource.quality===a&&e.video_resource.codec_id===l));let s=!1;if(d>-1){const e=o.video[d].video_resource.url;e?f({ep_url:e,ep_title:n}):s=!0}else s=!0;if(s)for(let e=0;e<o.video.length;e++){const i=o.video[e].video_resource.url;""!==i&&t<o.video[e].video_resource.quality&&(t=o.video[e].video_resource.quality,f({ep_url:i,ep_title:n}))}for(let e=0;e<o.audio_resource.length;e++){const t=o.audio_resource[e].url;if(""!==t&&i<o.audio_resource[e].quality){i=o.audio_resource[e].quality;const a=document.createElement("a");a.textContent=`${n} `,a.href=t,a.download="audio_url",a.type="video/mp4",document.getElementById("audioList").appendChild(a)}}}))}({ep_id:t,video_id:n,ep_title:`${e} [${t||n}]`}))}function x(){const e="play",t="video",n=(e=[],t="")=>{if(e.length>0)return e.findIndex((e=>e===t))},i=location.pathname.split("/"),o=location.pathname.includes(e),a=location.pathname.includes(t),l=n(i,o?e:t);let d,s,r;if(o?(d=i[l+2],r=i[l+1],d=Number.parseInt(d)||void 0,r=Number.parseInt(r)||void 0):a&&(s=i[l+1],s=Number.parseInt(s)||void 0),d>0||s>0);else if(o){const t=document.body.querySelector(".video-play .ep-section .ep-list .ep-item--active"),i=t?.href?.split("?")?.shift()?.split("/")||[];if(i&&i.length>0){d=i[n(i,e)+2],d=Number.parseInt(d)||void 0}d>0||alert("Can't identify episode ID, please contact dev")}else alert("Can't identify video ID, please contact dev");return{ep_id:d,video_id:s,season_id:r}}function S(){document.getElementById("jsonSubtitleList").innerHTML=`${s[b].subtitle}&nbsp;:&nbsp;`,document.getElementById("videoList").innerHTML=`${s[b].video}&nbsp;:&nbsp;`,document.getElementById("audioList").innerHTML=`${s[b].audio}&nbsp;:&nbsp;`,E(""),w()}let I;function E(e){document.getElementById("plugin_notice").innerText=e}GM_addStyle("\n\n    #downloadBiliintScript {\n      position: fixed;\n      bottom: 2.2vw;\n      left: 2.2vw;\n      z-index: 9999;\n      opacity: 0.97;\n      background: black;\n      padding: 16px;\n    }\n\n    #down-this {\n      background: #4c93ff;\n      margin-bottom: 16px;\n\n      color: white;\n      font-weight: 700;\n    }\n\n    .linkContainer {\n      margin-top: 16px;\n\n      color: black;\n      background: white;\n      opacity: 0.97;\n      border-radius: 20px;\n      padding: 8px;\n      font-size: 15px\n    }\n\n    .btn {\n      cursor: pointer;\n      padding: 3px;\n      opacity:0.97;\n      border-radius: 20px;\n      padding: 8px;\n    }\n\n    .btn:hover {\n      background-color: #6b9f25;\n      color: white;\n    }\n\n    #BtnContainer{\n      margin-top: 3px;\n      margin-bottom: 6px;\n      opacity: 0.97;\n    }\n\n    #mySortBtn {\n      cursor: pointer;\n      padding: 3px;\n      border-radius:20px;\n      width: 100%;\n      background-color: #23427f;\n      color: white;\n      opacity: 0.99;\n    }\n    #mySortBtn:hover {\n      background-color: #38548b;\n      color: #d3d9e5;\n    }\n\n    #downloadBiliintScript a {\n      color: #4c93ff;\n      background: white;\n      opacity: 0.97;\n    }\n\n    #downloadBiliintScript a:hover {\n      color: #4078cb;\n      background: white;\n      opacity: 0.97;\n    }\n\n    .subtitleSelect {\n      margin-right: 8px;\n\n      border-radius: 20px;\n      padding: 8px;\n      background: white;\n      opacity: 0.97;\n    }\n\n    #plugin_notice {\n      margin-top: 16px;\n\n      color: red;\n      font-size: 13px;\n      font-style: italic;\n    }\n    #plugin_notice:empty {\n      display: none;\n    }\n\n    #snackbar {\n      visibility: hidden;\n      min-width: 250px;\n      margin-left: -125px;\n      background-color: #333;\n      color: #fff;\n      text-align: center;\n      border-radius: 2px;\n      padding: 16px;\n      position: fixed;\n      z-index: 1;\n      left: 50%;\n      bottom: 30px;\n      font-size: 17px;\n    }\n\n    #snackbar.show {\n      visibility: visible;\n      -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;\n      animation: fadein 0.5s, fadeout 0.5s 2.5s;\n    }\n\n    @-webkit-keyframes fadein {\n      from {bottom: 0; opacity: 0;}\n      to {bottom: 30px; opacity: 1;}\n    }\n\n    @keyframes fadein {\n      from {bottom: 0; opacity: 0;}\n      to {bottom: 30px; opacity: 1;}\n    }\n\n    @-webkit-keyframes fadeout {\n      from {bottom: 30px; opacity: 1;}\n      to {bottom: 0; opacity: 0;}\n    }\n\n    @keyframes fadeout {\n      from {bottom: 30px; opacity: 1;}\n      to {bottom: 0; opacity: 0;}\n    }\n")}();