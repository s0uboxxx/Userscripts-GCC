// ==UserScript==
// @name         Return YouTube Dislike
// @namespace    https://www.returnyoutubedislike.com/
// @homepage     https://www.returnyoutubedislike.com/
// @version      3.1.5
// @encoding     utf-8
// @description  Return of the YouTube Dislike, Based off https://www.returnyoutubedislike.com/
// @icon         https://github.com/Anarios/return-youtube-dislike/raw/main/Icons/Return%20Youtube%20Dislike%20-%20Transparent.png
// @author       Anarios & JRWR
// @match        *://*.youtube.com/*
// @exclude      *://music.youtube.com/*
// @exclude      *://*.music.youtube.com/*
// @compatible   chrome
// @compatible   firefox
// @compatible   opera
// @compatible   safari
// @compatible   edge
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Return20Youtube20Dislike.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Return20Youtube20Dislike.meta.js
// @grant        GM.xmlHttpRequest
// @connect      youtube.com
// @grant        GM_addStyle
// @run-at       document-end
// ==/UserScript==
const extConfig={showUpdatePopup:!1,disableVoteSubmission:!1,disableLogging:!0,coloredThumbs:!1,coloredBar:!1,colorTheme:"classic",numberDisplayFormat:"compactShort",numberDisplayRoundDown:!0,tooltipPercentageMode:"none",numberDisplayReformatLikes:!1,rateBarEnabled:!1},LIKED_STATE="LIKED_STATE",DISLIKED_STATE="DISLIKED_STATE",NEUTRAL_STATE="NEUTRAL_STATE";let previousState=3,likesvalue=0,dislikesvalue=0,preNavigateLikeButton=null,isMobile="m.youtube.com"==location.hostname,isShorts=()=>location.pathname.startsWith("/shorts"),mobileDislikes=0;function cLog(e,t=""){extConfig.disableLogging||(t=""===t.trim()?"":`(${t})`,console.log(`[Return YouTube Dislikes] ${e} ${t}`))}function isInViewport(e){const t=e.getBoundingClientRect(),n=innerHeight||document.documentElement.clientHeight,o=innerWidth||document.documentElement.clientWidth;return!(0==t.top&&0==t.left&&0==t.bottom&&0==t.right)&&t.top>=0&&t.left>=0&&t.bottom<=n&&t.right<=o}function getButtons(){if(isShorts()){let e=document.querySelectorAll(isMobile?"ytm-like-button-renderer":"#like-button > ytd-like-button-renderer");for(let t of e)if(isInViewport(t))return t}return isMobile?document.querySelector(".slim-video-action-bar-actions .segmented-buttons")??document.querySelector(".slim-video-action-bar-actions"):null===document.getElementById("menu-container")?.offsetParent?document.querySelector("ytd-menu-renderer.ytd-watch-metadata > div")??document.querySelector("ytd-menu-renderer.ytd-video-primary-info-renderer > div"):document.getElementById("menu-container")?.querySelector("#top-level-buttons-computed")}function getDislikeButton(){if("YTD-SEGMENTED-LIKE-DISLIKE-BUTTON-RENDERER"===getButtons().children[0].tagName)return void 0===getButtons().children[0].children[1]?document.querySelector("#segmented-dislike-button"):getButtons().children[0].children[1];if(getButtons().querySelector("segmented-like-dislike-button-view-model")){const e=getButtons().querySelector("dislike-button-view-model");return e||cLog("Dislike button wasn't added to DOM yet..."),e}return getButtons().children[1]}function getLikeButton(){return"YTD-SEGMENTED-LIKE-DISLIKE-BUTTON-RENDERER"===getButtons().children[0].tagName?null!==document.querySelector("#segmented-like-button")?document.querySelector("#segmented-like-button"):getButtons().children[0].children[0]:getButtons().querySelector("like-button-view-model")??getButtons().children[0]}function getLikeTextContainer(){return getLikeButton().querySelector("#text")??getLikeButton().getElementsByTagName("yt-formatted-string")[0]??getLikeButton().querySelector("span[role='text']")}function getDislikeTextContainer(){const e=getDislikeButton();let t=e?.querySelector("#text")??e?.getElementsByTagName("yt-formatted-string")[0]??e?.querySelector("span[role='text']");if(null===t){let n=document.createElement("span");n.id="text",n.style.marginLeft="6px",e?.querySelector("button").appendChild(n),e&&(e.querySelector("button").style.width="auto"),t=n}return t}function createObserver(e,t){const n=new Object;return n.options=e,n.observer=new MutationObserver(t),n.observe=function(e){this.observer.observe(e,this.options)},n.disconnect=function(){this.observer.disconnect()},n}let shortsObserver=null;function isVideoLiked(){return isMobile?"true"==getLikeButton().querySelector("button").getAttribute("aria-label"):getLikeButton().classList.contains("style-default-active")}function isVideoDisliked(){return isMobile?"true"==getDislikeButton()?.querySelector("button").getAttribute("aria-label"):getDislikeButton()?.classList.contains("style-default-active")}function isVideoNotLiked(){return isMobile?!isVideoLiked():getLikeButton().classList.contains("style-text")}function isVideoNotDisliked(){return isMobile?!isVideoDisliked():getDislikeButton()?.classList.contains("style-text")}function checkForUserAvatarButton(){if(!isMobile)return!!document.querySelector("#avatar-btn")}function getState(){return isVideoLiked()?LIKED_STATE:isVideoDisliked()?DISLIKED_STATE:NEUTRAL_STATE}function setLikes(e){isMobile?getButtons().children[0].querySelector(".button-renderer-text").innerText=e:getLikeTextContainer().innerText=e}function setDislikes(e){if(isMobile)return void(mobileDislikes=e);const t=getDislikeTextContainer();t?.removeAttribute("is-empty"),t?.innerText!==e&&(t.innerText=e)}function getLikeCountFromButton(){try{if(isShorts())return!1;let e=(getLikeButton().querySelector("yt-formatted-string#text")??getLikeButton().querySelector("button")).getAttribute("aria-label").replace(/\D/g,"");return e.length>0&&parseInt(e)}catch{return!1}}function createRateBar(e,t){if(isMobile||!extConfig.rateBarEnabled)return;let n=document.getElementById("return-youtube-dislike-bar-container");const o=getLikeButton().clientWidth+(getDislikeButton()?.clientWidth??52),i=e+t>0?e/(e+t)*100:50;var r=parseFloat(i.toFixed(1));const s=(100-r).toLocaleString();var l;switch(r=r.toLocaleString(),extConfig.tooltipPercentageMode){case"dash_like":l=`${e.toLocaleString()}&nbsp;/&nbsp;${t.toLocaleString()}&nbsp;&nbsp;-&nbsp;&nbsp;${r}%`;break;case"dash_dislike":l=`${e.toLocaleString()}&nbsp;/&nbsp;${t.toLocaleString()}&nbsp;&nbsp;-&nbsp;&nbsp;${s}%`;break;case"both":l=`${r}%&nbsp;/&nbsp;${s}%`;break;case"only_like":l=`${r}%`;break;case"only_dislike":l=`${s}%`;break;default:l=`${e.toLocaleString()}&nbsp;/&nbsp;${t.toLocaleString()}`}if(n||isMobile)document.querySelector(".ryd-tooltip").style.width=o+"px",document.getElementById("return-youtube-dislike-bar").style.width=i+"%",extConfig.coloredBar&&(document.getElementById("return-youtube-dislike-bar-container").style.backgroundColor=getColorFromTheme(!1),document.getElementById("return-youtube-dislike-bar").style.backgroundColor=getColorFromTheme(!0));else{let e="",t="";extConfig.coloredBar&&(e="; background-color: "+getColorFromTheme(!0),t="; background-color: "+getColorFromTheme(!1)),getButtons().insertAdjacentHTML("beforeend",`\n        <div class="ryd-tooltip" style="width: ${o}px">\n        <div class="ryd-tooltip-bar-container">\n           <div\n              id="return-youtube-dislike-bar-container"\n              style="width: 100%; height: 2px;${t}"\n              >\n              <div\n                 id="return-youtube-dislike-bar"\n                 style="width: ${i}%; height: 100%${t}"\n                 ></div>\n           </div>\n        </div>\n        <tp-yt-paper-tooltip position="top" id="ryd-dislike-tooltip" class="style-scope ytd-sentiment-bar-renderer" role="tooltip" tabindex="-1">\n           \x3c!--css-build:shady--\x3e${l}\n        </tp-yt-paper-tooltip>\n        </div>\n`);let n=document.getElementById("top-row");n.style.borderBottom="1px solid var(--yt-spec-10-percent-layer)",n.style.paddingBottom="10px"}}function setState(){cLog("Fetching votes...");fetch(`https://returnyoutubedislikeapi.com/votes?videoId=${getVideoId()}`).then((e=>{e.json().then((t=>{if(t&&!("traceId"in e)){const{dislikes:e,likes:n}=t;if(cLog(`Received count: ${e}`),likesvalue=n,dislikesvalue=e,setDislikes(numberFormat(e)),!0===extConfig.numberDisplayReformatLikes){const e=getLikeCountFromButton();!1!==e&&setLikes(numberFormat(e))}if(createRateBar(n,e),!0===extConfig.coloredThumbs){const e=getDislikeButton();if(isShorts()){const t=getLikeButton().querySelector("tp-yt-paper-button#button"),n=e?.querySelector("tp-yt-paper-button#button");"true"===t.getAttribute("aria-pressed")&&(t.style.color=getColorFromTheme(!0)),n&&"true"===n.getAttribute("aria-pressed")&&(n.style.color=getColorFromTheme(!1)),shortsObserver.observe(t),shortsObserver.observe(n)}else getLikeButton().style.color=getColorFromTheme(!0),e&&(e.style.color=getColorFromTheme(!1))}}}))}))}function updateDOMDislikes(){setDislikes(numberFormat(dislikesvalue)),createRateBar(likesvalue,dislikesvalue)}function likeClicked(){if(1==checkForUserAvatarButton()&&(1==previousState?(likesvalue--,updateDOMDislikes(),previousState=3):2==previousState?(likesvalue++,dislikesvalue--,updateDOMDislikes(),previousState=1):3==previousState&&(likesvalue++,updateDOMDislikes(),previousState=1),!0===extConfig.numberDisplayReformatLikes)){const e=getLikeCountFromButton();!1!==e&&setLikes(numberFormat(e))}}function dislikeClicked(){if(1==checkForUserAvatarButton())if(3==previousState)dislikesvalue++,updateDOMDislikes(),previousState=2;else if(2==previousState)dislikesvalue--,updateDOMDislikes(),previousState=3;else if(1==previousState&&(likesvalue--,dislikesvalue++,updateDOMDislikes(),previousState=2,!0===extConfig.numberDisplayReformatLikes)){const e=getLikeCountFromButton();!1!==e&&setLikes(numberFormat(e))}}function setInitialState(){setState()}function getVideoId(){const e=new URL(window.location.href),t=e.pathname;return t.startsWith("/clip")?(document.querySelector("meta[itemprop='videoId']")||document.querySelector("meta[itemprop='identifier']")).content:t.startsWith("/shorts")?t.slice(8):e.searchParams.get("v")}function isVideoLoaded(){if(isMobile)return"false"==document.getElementById("player").getAttribute("loading");const e=getVideoId();return null!==document.querySelector(`ytd-watch-grid[video-id='${e}']`)||null!==document.querySelector(`ytd-watch-flexy[video-id='${e}']`)||null!==document.querySelector('#player[loading="false"]:not([hidden])')}function roundDown(e){if(e<1e3)return e;const t=Math.floor(Math.log10(e)-2),n=t+(t%3?1:0);return Math.floor(e/10**n)*10**n}function numberFormat(e){let t;return t=!1===extConfig.numberDisplayRoundDown?e:roundDown(e),getNumberFormatter(extConfig.numberDisplayFormat).format(t)}function getNumberFormatter(e){let t,n,o;if(document.documentElement.lang)t=document.documentElement.lang;else if(navigator.language)t=navigator.language;else try{t=new URL(Array.from(document.querySelectorAll("head > link[rel='search']"))?.find((e=>e?.getAttribute("href")?.includes("?locale=")))?.getAttribute("href"))?.searchParams?.get("locale")}catch{cLog("Cannot find browser locale. Use en as default for number formatting."),t="en"}switch(e){case"compactLong":n="compact",o="long";break;case"standard":n="standard",o="short";break;default:n="compact",o="short"}return Intl.NumberFormat(t,{notation:n,compactDisplay:o})}function getColorFromTheme(e){let t;switch(extConfig.colorTheme){case"accessible":t=!0===e?"dodgerblue":"gold";break;case"neon":t=!0===e?"aqua":"magenta";break;default:t=!0===e?"lime":"red"}return t}isShorts()&&!shortsObserver&&(cLog("Initializing shorts mutation observer"),shortsObserver=createObserver({attributes:!0},(e=>{e.forEach((e=>{if("attributes"===e.type&&"TP-YT-PAPER-BUTTON"===e.target.nodeName&&"button"===e.target.id)return cLog("Short thumb button status changed"),void("true"===e.target.getAttribute("aria-pressed")?e.target.style.color="like-button"===e.target.parentElement.parentElement.id?getColorFromTheme(!0):getColorFromTheme(!1):e.target.style.color="unset");cLog("Unexpected mutation observer event: "+e.target+e.type)}))}))),("undefined"!=typeof GM_addStyle?GM_addStyle:e=>{let t=document.createElement("style");t.type="text/css",t.innerText=e,document.head.appendChild(t)})("\n    #return-youtube-dislike-bar-container {\n      background: var(--yt-spec-icon-disabled);\n      border-radius: 2px;\n    }\n\n    #return-youtube-dislike-bar {\n      background: var(--yt-spec-text-primary);\n      border-radius: 2px;\n      transition: all 0.15s ease-in-out;\n    }\n\n    .ryd-tooltip {\n      position: absolute;\n      display: block;\n      height: 2px;\n      bottom: -10px;\n    }\n\n    .ryd-tooltip-bar-container {\n      width: 100%;\n      height: 2px;\n      position: absolute;\n      padding-top: 6px;\n      padding-bottom: 12px;\n      top: -6px;\n    }\n\n    ytd-menu-renderer.ytd-watch-metadata {\n      overflow-y: visible !important;\n    }\n    \n    #top-level-buttons-computed {\n      position: relative !important;\n    }\n  ");let smartimationObserver=null;function setEventListeners(e){let t;cLog("Setting up..."),t=setInterval((function(){if(isShorts()||getButtons()?.offsetParent&&isVideoLoaded()){const e=getButtons(),n=getDislikeButton();if(preNavigateLikeButton!==getLikeButton()&&n){cLog("Registering button listeners...");try{getLikeButton().addEventListener("click",likeClicked),n?.addEventListener("click",dislikeClicked),getLikeButton().addEventListener("touchstart",likeClicked),n?.addEventListener("touchstart",dislikeClicked),n?.addEventListener("focusin",updateDOMDislikes),n?.addEventListener("focusout",updateDOMDislikes),preNavigateLikeButton=getLikeButton(),smartimationObserver||(smartimationObserver=createObserver({attributes:!0,subtree:!0,childList:!0},updateDOMDislikes),smartimationObserver.container=null);const t=e.querySelector("yt-smartimation");t&&smartimationObserver.container!=t&&(cLog("Initializing smartimation mutation observer"),smartimationObserver.disconnect(),smartimationObserver.observe(t),smartimationObserver.container=t)}catch{return}}n&&(setInitialState(),clearInterval(t))}}),111)}if(function(){"use strict";window.addEventListener("yt-navigate-finish",setEventListeners,!0),setEventListeners()}(),isMobile){let e=history.pushState;history.pushState=function(...t){return window.returnDislikeButtonlistenersSet=!1,setEventListeners(t[2]),e.apply(history,t)},setInterval((()=>{const e=getDislikeButton();null===e?.querySelector(".button-renderer-text")?getDislikeTextContainer().innerText=mobileDislikes:e&&(e.querySelector(".button-renderer-text").innerText=mobileDislikes)}),1e3)}