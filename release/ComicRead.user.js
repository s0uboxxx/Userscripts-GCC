// ==UserScript==
// @name            ComicRead
// @namespace       ComicRead
// @version         10.11.0
// @description     为漫画站增加双页阅读、翻译等优化体验的增强功能。百合会（记录阅读历史、自动签到等）、百合会新站、动漫之家（解锁隐藏漫画）、E-Hentai（关联 nhentai、快捷收藏、标签染色、识别广告页等）、nhentai（彻底屏蔽漫画、无限滚动）、Yurifans（自动签到）、拷贝漫画(copymanga)（显示最后阅读记录、解锁隐藏漫画）、PonpomuYuri、再漫画、明日方舟泰拉记事社、禁漫天堂、漫画柜(manhuagui)、漫画DB(manhuadb)、动漫屋(dm5)、绅士漫画(wnacg)、mangabz、komiic、MangaDex、NoyAcg、無限動漫、新新漫画、熱辣漫畫、hitomi、SchaleNetwork、kemono、nekohouse、welovemanga
// @description:en  Add enhanced features to the comic site for optimized experience, including dual-page reading and translation. E-Hentai (Associate nhentai, Quick favorite, Colorize tags, Floating tag list, etc.) | nhentai (Totally block comics, Auto page turning) | hitomi | Anchira | kemono | nekohouse | welovemanga.
// @description:ru  Добавляет расширенные функции для удобства на сайт, такие как двухстраничный режим и перевод.
// @author          hymbz
// @license         AGPL-3.0-or-later
// @noframes
// @match           *://*/*
// @connect         yamibo.com
// @connect         dmzj.com
// @connect         idmzj.com
// @connect         exhentai.org
// @connect         e-hentai.org
// @connect         hath.network
// @connect         nhentai.net
// @connect         hypergryph.com
// @connect         mangabz.com
// @connect         copymanga.site
// @connect         copymanga.info
// @connect         copymanga.net
// @connect         copymanga.org
// @connect         copymanga.tv
// @connect         mangacopy.com
// @connect         xsskc.com
// @connect         schale.network
// @connect         self
// @connect         127.0.0.1
// @connect         *
// @grant           GM_addElement
// @grant           GM_getResourceText
// @grant           GM_addStyle
// @grant           GM_xmlhttpRequest
// @grant           GM.addValueChangeListener
// @grant           GM.removeValueChangeListener
// @grant           GM.getResourceText
// @grant           GM.getValue
// @grant           GM.setValue
// @grant           GM.listValues
// @grant           GM.deleteValue
// @grant           GM.registerMenuCommand
// @grant           GM.unregisterMenuCommand
// @grant           unsafeWindow
// @icon            data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAACBUExURUxpcWB9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i2B9i////198il17idng49DY3PT297/K0MTP1M3X27rHzaCxupmstbTByK69xOfr7bfFy3WOmqi4wPz9/X+XomSBjqW1vZOmsN/l6GmFkomeqe7x8vn6+kv+1vUAAAAOdFJOUwDsAoYli9zV+lIqAZEDwV05SQAAAUZJREFUOMuFk+eWgjAUhGPBiLohjZACUqTp+z/gJkqJy4rzg3Nn+MjhwB0AANjv4BEtdITBHjhtQ4g+CIZbC4Qb9FGb0J4P0YrgCezQqgIA14EDGN8fYz+f3BGMASFkTJ+GDAYMUSONzrFL7SVvjNQIz4B9VERRmV0rbJWbrIwidnsd6ACMlEoip3uad3X2HJmqb3gCkkJELwk5DExRDxA6HnKaDEPSsBnAsZoANgJaoAkg12IJqBiPACImXQKF9IDULIHUkOk7kDpeAMykHqCEWACy8ACdSM7LGSg5F3HtAU1rrkaK9uGAshXS2lZ5QH/nVhmlD8rKlmbO3ZsZwLe8qnpdxJRnLaci1X1V5R32fjd5CndVkfYdGpy3D+htU952C/ypzPtdt3JflzZYBy7fi/O1euvl/XH1Pp+Cw3/1P1xOZwB+AWMcP/iw0AlKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC
// @resource        solid-js https://registry.npmmirror.com/solid-js/1.9.1/files/dist/solid.cjs
// @resource        fflate https://registry.npmmirror.com/fflate/0.8.2/files/umd/index.js
// @resource        jsqr https://registry.npmmirror.com/jsqr/1.4.0/files/dist/jsQR.js
// @resource        comlink https://registry.npmmirror.com/comlink/4.4.1/files/dist/umd/comlink.js
// @resource        dmzjDecrypt https://greasyfork.org/scripts/467177/code/dmzjDecrypt.js?version=1207199
// @resource        solid-js|store https://registry.npmmirror.com/solid-js/1.9.1/files/store/dist/store.cjs
// @resource        solid-js|web https://registry.npmmirror.com/solid-js/1.9.1/files/web/dist/web.cjs
// @supportURL      https://github.com/hymbz/ComicReadScript/issues
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/ComicRead.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/ComicRead.meta.js
// ==/UserScript==
let supportWorker="undefined"!=typeof Worker;const gmApi={GM:GM,GM_addElement:"undefined"==typeof GM_addElement?void 0:GM_addElement,GM_getResourceText:GM_getResourceText,GM_xmlhttpRequest:GM_xmlhttpRequest,GM_addStyle:GM_addStyle,unsafeWindow:unsafeWindow},gmApiList=Object.keys(gmApi),crsLib={process:{env:{NODE_ENV:"production"}},...gmApi},tempName=Math.random().toString(36).slice(2),evalCode=e=>{if(e)return gmApi.GM_addElement?GM_addElement("script",{textContent:e})?.remove():void eval.call(unsafeWindow,e)},selfImportSync=e=>{let n;switch(e){case"helper/languages":n="\nconst langList = ['zh', 'en', 'ru'];\n/** 判断传入的字符串是否是支持的语言类型代码 */\nconst isLanguages = lang => Boolean(lang) && langList.includes(lang);\n\n/** 返回浏览器偏好语言 */\nconst getBrowserLang = () => {\n  let newLang;\n  for (let i = 0; i < navigator.languages.length; i++) {\n    const language = navigator.languages[i];\n    const matchLang = langList.find(l => l === language || l === language.split('-')[0]);\n    if (matchLang) {\n      newLang = matchLang;\n      break;\n    }\n  }\n  return newLang;\n};\nconst getSaveLang = async () => typeof GM === 'undefined' ? localStorage.getItem('Languages') : GM.getValue('Languages');\nconst setSaveLang = async val => typeof GM === 'undefined' ? localStorage.setItem('Languages', val) : GM.setValue('Languages', val);\nconst getInitLang = async () => {\n  const saveLang = await getSaveLang();\n  if (isLanguages(saveLang)) return saveLang;\n  const lang = getBrowserLang() ?? 'zh';\n  setSaveLang(lang);\n  return lang;\n};\n\nexports.getInitLang = getInitLang;\nexports.isLanguages = isLanguages;\nexports.langList = langList;\nexports.setSaveLang = setSaveLang;\n";break;case"helper":n='\nconst solidJs = require(\'solid-js\');\nconst web = require(\'solid-js/web\');\nconst store = require(\'solid-js/store\');\nconst languages = require(\'helper/languages\');\n\n// src/index.ts\nvar debounce$1 = (callback, wait) => {\n  if (web.isServer) {\n    return Object.assign(() => void 0, { clear: () => void 0 });\n  }\n  let timeoutId;\n  const clear = () => clearTimeout(timeoutId);\n  if (solidJs.getOwner())\n    solidJs.onCleanup(clear);\n  const debounced = (...args) => {\n    if (timeoutId !== void 0)\n      clear();\n    timeoutId = setTimeout(() => callback(...args), wait);\n  };\n  return Object.assign(debounced, { clear });\n};\nvar throttle$1 = (callback, wait) => {\n  if (web.isServer) {\n    return Object.assign(() => void 0, { clear: () => void 0 });\n  }\n  let isThrottled = false, timeoutId, lastArgs;\n  const throttled = (...args) => {\n    lastArgs = args;\n    if (isThrottled)\n      return;\n    isThrottled = true;\n    timeoutId = setTimeout(() => {\n      callback(...lastArgs);\n      isThrottled = false;\n    }, wait);\n  };\n  const clear = () => {\n    clearTimeout(timeoutId);\n    isThrottled = false;\n  };\n  if (solidJs.getOwner())\n    solidJs.onCleanup(clear);\n  return Object.assign(throttled, { clear });\n};\nfunction leadingAndTrailing(schedule, callback, wait) {\n  if (web.isServer) {\n    let called = false;\n    const scheduled2 = (...args) => {\n      if (called)\n        return;\n      called = true;\n      callback(...args);\n    };\n    return Object.assign(scheduled2, { clear: () => void 0 });\n  }\n  let State;\n  ((State2) => {\n    State2[State2["Ready"] = 0] = "Ready";\n    State2[State2["Leading"] = 1] = "Leading";\n    State2[State2["Trailing"] = 2] = "Trailing";\n  })(State || (State = {}));\n  let state = 0 /* Ready */;\n  const scheduled = schedule((args) => {\n    state === 2 /* Trailing */ && callback(...args);\n    state = 0 /* Ready */;\n  }, wait);\n  const fn = (...args) => {\n    if (state !== 2 /* Trailing */) {\n      if (state === 0 /* Ready */)\n        callback(...args);\n      state += 1;\n    }\n    scheduled(args);\n  };\n  const clear = () => {\n    state = 0 /* Ready */;\n    scheduled.clear();\n  };\n  if (solidJs.getOwner())\n    solidJs.onCleanup(clear);\n  return Object.assign(fn, { clear });\n}\nfunction createScheduled(schedule) {\n  let listeners = 0;\n  let isDirty = false;\n  const [track, dirty] = solidJs.createSignal(void 0, { equals: false });\n  const call = schedule(() => {\n    isDirty = true;\n    dirty();\n  });\n  return () => {\n    if (!isDirty)\n      call(), track();\n    if (isDirty) {\n      isDirty = !!listeners;\n      return true;\n    }\n    if (solidJs.getListener()) {\n      listeners++;\n      solidJs.onCleanup(() => listeners--);\n    }\n    return false;\n  };\n}\n\nfunction getDefaultExportFromCjs (x) {\n\treturn x && x.__esModule && Object.prototype.hasOwnProperty.call(x, \'default\') ? x[\'default\'] : x;\n}\n\nvar es6 = function equal(a, b) {\n  if (a === b) return true;\n\n  if (a && b && typeof a == \'object\' && typeof b == \'object\') {\n    if (a.constructor !== b.constructor) return false;\n\n    var length, i, keys;\n    if (Array.isArray(a)) {\n      length = a.length;\n      if (length != b.length) return false;\n      for (i = length; i-- !== 0;)\n        if (!equal(a[i], b[i])) return false;\n      return true;\n    }\n\n\n    if ((a instanceof Map) && (b instanceof Map)) {\n      if (a.size !== b.size) return false;\n      for (i of a.entries())\n        if (!b.has(i[0])) return false;\n      for (i of a.entries())\n        if (!equal(i[1], b.get(i[0]))) return false;\n      return true;\n    }\n\n    if ((a instanceof Set) && (b instanceof Set)) {\n      if (a.size !== b.size) return false;\n      for (i of a.entries())\n        if (!b.has(i[0])) return false;\n      return true;\n    }\n\n    if (ArrayBuffer.isView(a) && ArrayBuffer.isView(b)) {\n      length = a.length;\n      if (length != b.length) return false;\n      for (i = length; i-- !== 0;)\n        if (a[i] !== b[i]) return false;\n      return true;\n    }\n\n\n    if (a.constructor === RegExp) return a.source === b.source && a.flags === b.flags;\n    if (a.valueOf !== Object.prototype.valueOf) return a.valueOf() === b.valueOf();\n    if (a.toString !== Object.prototype.toString) return a.toString() === b.toString();\n\n    keys = Object.keys(a);\n    length = keys.length;\n    if (length !== Object.keys(b).length) return false;\n\n    for (i = length; i-- !== 0;)\n      if (!Object.prototype.hasOwnProperty.call(b, keys[i])) return false;\n\n    for (i = length; i-- !== 0;) {\n      var key = keys[i];\n\n      if (!equal(a[key], b[key])) return false;\n    }\n\n    return true;\n  }\n\n  // true if both NaN, false otherwise\n  return a!==a && b!==b;\n};\n\nconst isEqual = /*@__PURE__*/getDefaultExportFromCjs(es6);\n\nconst throttle = (fn, wait = 100) => leadingAndTrailing(throttle$1, fn, wait);\nconst debounce = (fn, wait = 100) => debounce$1(fn, wait);\nconst sleep = ms => new Promise(resolve => {\n  window.setTimeout(resolve, ms);\n});\nconst clamp = (min, val, max) => Math.max(Math.min(max, val), min);\nconst inRange = (min, val, max) => val >= min && val <= max;\n\n/** 判断两个数是否在指定误差范围内相等 */\nconst approx = (val, target, range) => Math.abs(target - val) <= range;\n\nfunction range(a, b, c) {\n  switch (typeof b) {\n    case \'undefined\':\n      return [...Array.from({\n        length: a + 1\n      }).keys()];\n    case \'number\':\n      {\n        const list = [];\n        for (let i = a; i <= b; i++) list.push(c ? c(i) : i);\n        return list;\n      }\n    case \'function\':\n      return Array.from({\n        length: a\n      }, (_, i) => b(i));\n  }\n}\n\n/**\n * 对 document.querySelector 的封装\n * 将默认返回类型改为 HTMLElement\n */\nconst querySelector = selector => document.querySelector(selector);\n\n/**\n * 对 document.querySelector 的封装\n * 将默认返回类型改为 HTMLElement\n */\nconst querySelectorAll = selector => [...document.querySelectorAll(selector)];\n\n/** 返回 Dom 的点击函数 */\nconst querySelectorClick = (selector, textContent) => {\n  let getDom;\n  if (typeof selector === \'function\') getDom = selector;else if (textContent) {\n    getDom = () => querySelectorAll(selector).find(e => e.textContent?.includes(textContent));\n  } else getDom = () => querySelector(selector);\n  if (getDom()) return () => getDom()?.click();\n};\n\n/** 找出数组中出现最多次的元素 */\nconst getMostItem = list => {\n  const counts = new Map();\n  for (const val of list) counts.set(val, (counts.get(val) ?? 0) + 1);\n\n  // eslint-disable-next-line unicorn/no-array-reduce\n  return [...counts.entries()].reduce((maxItem, item) => maxItem[1] > item[1] ? maxItem : item)[0];\n};\n\n/** 创建顺序数组 */\nconst createSequence = length => [...Array.from({\n  length\n}).keys()];\n\n/** 判断字符串是否为 URL */\nconst isUrl = text => {\n  // 等浏览器版本上来后可以直接使用 URL.canParse\n  try {\n    return Boolean(new URL(text));\n  } catch {\n    return false;\n  }\n};\n\n/** 将 blob 数据作为文件保存至本地 */\nconst saveAs = (blob, name = \'download\') => {\n  const a = document.createElementNS(\'http://www.w3.org/1999/xhtml\', \'a\');\n  a.download = name;\n  a.rel = \'noopener\';\n  a.href = URL.createObjectURL(blob);\n  setTimeout(() => a.dispatchEvent(new MouseEvent(\'click\')));\n};\n\n/** 滚动页面到指定元素的所在位置 */\nconst scrollIntoView = (selector, behavior = \'instant\') => querySelector(selector)?.scrollIntoView({\n  behavior\n});\n\n/** 使指定函数延迟运行期间的多次调用直到运行结束 */\nconst singleThreaded = (callback, defaultContinueRun = true) => {\n  const state = {\n    running: false,\n    continueRun: false\n  };\n  const fn = async (...args) => {\n    if (state.continueRun) return;\n    if (state.running) {\n      state.continueRun = defaultContinueRun;\n      return;\n    }\n    let res;\n    try {\n      state.running = true;\n      res = await callback(state, ...args);\n    } catch (error) {\n      state.continueRun = false;\n      await sleep(100);\n      throw error;\n    } finally {\n      state.running = false;\n    }\n    if (state.continueRun) {\n      state.continueRun = false;\n      setTimeout(fn, 0, ...args);\n    } else state.running = false;\n    return res;\n  };\n  return fn;\n};\n\n/**\n * 限制 Promise 并发\n * @param fnList 任务函数列表\n * @param callBack 成功执行一个 Promise 后调用，主要用于显示进度\n * @param limit 限制数\n * @returns 所有 Promise 的返回值\n */\nconst plimit = async (fnList, callBack = undefined, limit = 10) => {\n  let doneNum = 0;\n  const totalNum = fnList.length;\n  const resList = [];\n  const execPool = new Set();\n  const taskList = fnList.map((fn, i) => {\n    let p;\n    return () => {\n      p = (async () => {\n        resList[i] = await fn();\n        doneNum += 1;\n        execPool.delete(p);\n        callBack?.(doneNum, totalNum, resList, i);\n      })();\n      execPool.add(p);\n    };\n  });\n\n  // eslint-disable-next-line no-unmodified-loop-condition\n  while (doneNum !== totalNum) {\n    while (taskList.length > 0 && execPool.size < limit) taskList.shift()();\n    await Promise.race(execPool);\n  }\n  return resList;\n};\n\n/**\n * 判断使用参数颜色作为默认值时是否需要切换为黑暗模式\n * @param hexColor 十六进制颜色。例如 #112233\n */\nconst needDarkMode = hexColor => {\n  // by: https://24ways.org/2010/calculating-color-contrast\n  const r = Number.parseInt(hexColor.slice(1, 3), 16);\n  const g = Number.parseInt(hexColor.slice(3, 5), 16);\n  const b = Number.parseInt(hexColor.slice(5, 7), 16);\n  const yiq = (r * 299 + g * 587 + b * 114) / 1000;\n  return yiq < 128;\n};\n\nasync function wait(fn, timeout = Number.POSITIVE_INFINITY, waitTime = 100) {\n  let res = await fn();\n  let _timeout = timeout;\n  while (_timeout > 0 && !res) {\n    await sleep(waitTime);\n    _timeout -= waitTime;\n    res = await fn();\n  }\n  return res;\n}\n\n/** 等到指定的 dom 出现 */\nconst waitDom = selector => wait(() => querySelector(selector));\n\n/** 等待指定的图片元素加载完成 */\nconst waitImgLoad = (target, timeout) => new Promise((resolve, reject) => {\n  const img = typeof target === \'string\' ? new Image() : target;\n  if (img.complete && img.naturalHeight) resolve(img);\n  const id = timeout ? window.setTimeout(() => reject(new Error(\'timeout\')), timeout) : undefined;\n  const handleError = e => {\n    window.clearTimeout(id);\n    reject(new Error(e.message));\n  };\n  const handleLoad = () => {\n    window.clearTimeout(id);\n    img.removeEventListener(\'error\', handleError);\n    resolve(img);\n  };\n  img.addEventListener(\'load\', handleLoad, {\n    once: true\n  });\n  img.addEventListener(\'error\', handleError, {\n    once: true\n  });\n  if (typeof target === \'string\') img.src = target;\n});\n\n/** 将指定的布尔值转换为字符串或未定义 */\nconst boolDataVal = val => val ? \'\' : undefined;\n\n/** 测试图片 url 能否正确加载 */\nconst testImgUrl = url => new Promise(resolve => {\n  const img = new Image();\n  img.onload = () => resolve(true);\n  img.onerror = () => resolve(false);\n  img.src = url;\n});\nconst canvasToBlob = async (canvas, type, quality = 1) => {\n  if (canvas instanceof OffscreenCanvas) return canvas.convertToBlob({\n    type,\n    quality\n  });\n  return new Promise((resolve, reject) => {\n    canvas.toBlob(blob => blob ? resolve(blob) : reject(new Error(\'Canvas toBlob failed\')), type, quality);\n  });\n};\n\n/**\n * 求 a 和 b 的差集，相当于从 a 中删去和 b 相同的属性\n *\n * 不会修改参数对象，返回的是新对象\n */\nconst difference = (a, b) => {\n  const res = {};\n  const keys = Object.keys(a);\n  for (const key of keys) {\n    if (typeof a[key] === \'object\' && typeof b[key] === \'object\') {\n      const _res = difference(a[key], b[key]);\n      if (Object.keys(_res).length > 0) res[key] = _res;\n    } else if (a[key] !== b?.[key]) res[key] = a[key];\n  }\n  return res;\n};\nconst _assign = (a, b) => {\n  const res = JSON.parse(JSON.stringify(a));\n  const keys = Object.keys(b);\n  for (const key of keys) {\n    if (res[key] === undefined) res[key] = b[key];else if (typeof b[key] === \'object\') {\n      const _res = _assign(res[key], b[key]);\n      if (Object.keys(_res).length > 0) res[key] = _res;\n    } else if (res[key] !== b[key]) res[key] = b[key];\n  }\n  return res;\n};\n\n/**\n * Object.assign 的深拷贝版，不会导致子对象属性的缺失\n *\n * 不会修改参数对象，返回的是新对象\n */\nconst assign = (target, ...sources) => {\n  let res = target;\n  for (const source of sources) if (typeof source === \'object\') res = _assign(res, source);\n  return res;\n};\n\n/** 根据路径获取对象下的指定值 */\nconst byPath = (obj, path, handleVal) => {\n  const keys = path.split(\'.\');\n  let target = obj;\n  for (let i = 0; i < keys.length; i++) {\n    let key = keys[i];\n\n    // 兼容含有「.」的 key\n    while (!Reflect.has(target, key) && i < keys.length) {\n      i += 1;\n      if (keys[i] === undefined) break;\n      key += `.${keys[i]}`;\n    }\n    if (handleVal && i > keys.length - 2 && Reflect.has(target, key)) {\n      const res = handleVal(target, key);\n      while (i < keys.length - 1) {\n        target = target[key];\n        i += 1;\n        key = keys[i];\n      }\n      if (res !== undefined) target[key] = res;\n      break;\n    }\n    target = target[key];\n  }\n  if (target === obj) return null;\n  return target;\n};\nconst requestIdleCallback = (callback, timeout) => {\n  if (Reflect.has(window, \'requestIdleCallback\')) return window.requestIdleCallback(callback, {\n    timeout\n  });\n  return window.setTimeout(callback, 16);\n};\n\n/** 获取键盘事件的编码 */\nconst getKeyboardCode = e => {\n  let {\n    key\n  } = e;\n  switch (key) {\n    case \'Shift\':\n    case \'Control\':\n    case \'Alt\':\n      return key;\n  }\n  if (e.ctrlKey) key = `Ctrl + ${key}`;\n  if (e.altKey) key = `Alt + ${key}`;\n  if (e.shiftKey) key = `Shift + ${key}`;\n  return key;\n};\n\n/** 将快捷键的编码转换成更易读的形式 */\nconst keyboardCodeToText = code => code.replace(\'Control\', \'Ctrl\').replace(\'ArrowUp\', \'↑\').replace(\'ArrowDown\', \'↓\').replace(\'ArrowLeft\', \'←\').replace(\'ArrowRight\', \'→\').replace(/^\\s$/, \'Space\');\n\n/** 将 HTML 字符串转换为 DOM 对象 */\nconst domParse = html => new DOMParser().parseFromString(html, \'text/html\');\n\n/** 监听键盘事件 */\nconst linstenKeydown = handler => window.addEventListener(\'keydown\', e => {\n  // 跳过输入框的键盘事件\n  switch (e.target.tagName) {\n    case \'INPUT\':\n    case \'TEXTAREA\':\n      return;\n  }\n  return handler(e);\n});\n\n/**\n * 劫持修改原网页上的函数\n *\n * 如果传入函数的所需参数为零，将在原函数执行完后自动调用\n */\nconst hijackFn = (fnName, fn) => {\n  const rawFn = unsafeWindow[fnName];\n  unsafeWindow[fnName] = fn.length === 0 ? (...args) => {\n    const res = rawFn(...args);\n    fn();\n    return res;\n  } : (...args) => fn(rawFn, args);\n};\nasync function getGmValue(name, setValueFn) {\n  const value = await GM.getValue(name);\n  if (value !== undefined) return value;\n  await setValueFn();\n  return await GM.getValue(name);\n}\n\n/** 根据范围文本提取指定范围的元素的 index */\nconst extractRange = (rangeText, length) => {\n  const list = new Set();\n  for (const text of rangeText.replaceAll(/[^\\d,-]/g, \'\').split(\',\')) {\n    if (/^\\d+$/.test(text)) list.add(Number(text) - 1);else if (/^\\d*-\\d*$/.test(text)) {\n      let [start, end] = text.split(\'-\').map(Number);\n      end ||= length;\n      for (start--, end--; start <= end; start++) list.add(start);\n    }\n  }\n  return list;\n};\n\n/** extractRange 的逆向，按照相同的语法表述一个结果数组 */\nconst descRange = (list, length) => {\n  let text = \'\';\n  const nowRange = [];\n  const pushRange = newIndex => {\n    if (nowRange.length === 0) return;\n    if (text.length > 0) text += \', \';\n    if (nowRange.length === 1) text += nowRange[0] + 1;else {\n      const end = newIndex === undefined && nowRange[1] === length - 1 ? \'\' : nowRange[1] + 1;\n      text += `${nowRange[0] + 1}-${end}`;\n    }\n    nowRange.length = 0;\n    if (newIndex !== undefined) nowRange[0] = newIndex;\n  };\n  for (const i of list) {\n    switch (nowRange.length) {\n      case 0:\n        nowRange[0] = i;\n        break;\n      case 1:\n        if (i === nowRange[0] + 1) nowRange[1] = i;else pushRange(i);\n        break;\n      case 2:\n        if (i === nowRange[1] + 1) nowRange[1] = i;else pushRange(i);\n        break;\n    }\n  }\n  pushRange();\n  return text;\n};\n\nlet publicOwner;\nsolidJs.createRoot(() => {\n  publicOwner = solidJs.getOwner();\n});\n\n/** 会自动设置 equals 的 createSignal */\nconst createEqualsSignal = (init, options) => solidJs.createSignal(init, {\n  equals: isEqual,\n  ...options\n});\n\n/** 会自动设置 equals 和 createRoot 的 createMemo */\nconst createRootMemo = (fn, init, options) => {\n  // 如果函数已经是 createMemo 创建的，就直接使用\n  if (fn.name === \'bound readSignal\') return fn;\n  const _init = init ?? fn(undefined);\n  // 自动为对象类型设置 equals\n  const _options = options?.equals === undefined && typeof _init === \'object\' ? {\n    ...options,\n    equals: isEqual\n  } : options;\n  return solidJs.getOwner() ? solidJs.createMemo(fn, _init, _options) : solidJs.runWithOwner(publicOwner, () => solidJs.createMemo(fn, _init, _options));\n};\n\n/** 节流的 createMemo */\nconst createThrottleMemo = (fn, wait = 100, init = fn(undefined), options = undefined) => {\n  const scheduled = createScheduled(_fn => throttle(_fn, wait));\n  return createRootMemo(prev => scheduled() ? fn(prev) : prev, init, options);\n};\nconst createMemoMap = fnMap => {\n  const memoMap = Object.fromEntries(Object.entries(fnMap).map(([key, fn]) => [key, createRootMemo(fn)]));\n  const map = createRootMemo(() => {\n    const obj = {};\n    for (const key of Object.keys(memoMap)) Reflect.set(obj, key, memoMap[key]());\n    return obj;\n  });\n  return map;\n};\nconst createRootEffect = (fn, val, options) => solidJs.getOwner() ? solidJs.createEffect(fn, val, options) : solidJs.runWithOwner(publicOwner, () => solidJs.createEffect(fn, val, options));\nconst createEffectOn = (deps, fn, options) => createRootEffect(solidJs.on(deps, fn, options));\nconst onAutoMount = fn => {\n  const owner = solidJs.getOwner();\n  if (!owner) return fn(owner);\n  solidJs.onMount(() => {\n    const cleanFn = fn(owner);\n    if (cleanFn) solidJs.onCleanup(cleanFn);\n  });\n};\n\nconst promisifyRequest = request => new Promise((resolve, reject) => {\n  request.onsuccess = () => resolve(request.result);\n  request.onerror = () => reject(request.error);\n});\nconst openDb = (version, initSchema) => new Promise((resolve, reject) => {\n  const request = indexedDB.open(\'ComicReadScript\', version);\n  request.onupgradeneeded = () => initSchema(request.result);\n  request.onsuccess = () => resolve(request.result);\n  request.onerror = error => {\n    console.error(\'数据库打开失败\', error);\n    reject(new Error(\'数据库打开失败\'));\n  };\n});\nconst useCache = async (initSchema, version = 1) => {\n  const db = await openDb(version, initSchema);\n  return {\n    set: (storeName, value) => promisifyRequest(db.transaction(storeName, \'readwrite\').objectStore(storeName).put(value)),\n    get: async (storeName, query) => promisifyRequest(db.transaction(storeName, \'readonly\').objectStore(storeName).get(query)),\n    del: (storeName, query) => promisifyRequest(db.transaction(storeName, \'readwrite\').objectStore(storeName).delete(query))\n  };\n};\n\nconst createPointerState = (e, type = \'down\') => {\n  const xy = [e.clientX, e.clientY];\n  return {\n    id: e.pointerId,\n    type,\n    xy,\n    initial: xy,\n    last: xy,\n    startTime: performance.now(),\n    target: e.target\n  };\n};\nconst useDrag = ({\n  ref,\n  handleDrag,\n  easyMode,\n  handleClick,\n  skip,\n  touches = new Map()\n}) => {\n  onAutoMount(() => {\n    const controller = new AbortController();\n    const options = {\n      capture: false,\n      passive: true,\n      signal: controller.signal\n    };\n    const handleDown = e => {\n      if (skip?.(e)) return;\n      e.stopPropagation();\n      if (!easyMode?.() && e.buttons !== 1) return;\n      ref.setPointerCapture(e.pointerId);\n      const state = createPointerState(e);\n      touches.set(e.pointerId, state);\n      handleDrag(state, e);\n    };\n    const handleMove = e => {\n      e.preventDefault();\n      if (!easyMode?.() && e.buttons !== 1) return;\n      const state = touches.get(e.pointerId);\n      if (!state) return;\n      state.type = \'move\';\n      state.xy = [e.clientX, e.clientY];\n      handleDrag(state, e);\n      state.last = state.xy;\n    };\n    const handleUp = e => {\n      e.stopPropagation();\n      ref.releasePointerCapture(e.pointerId);\n      const state = touches.get(e.pointerId);\n      if (!state) return;\n      touches.delete(e.pointerId);\n      state.type = \'up\';\n      state.xy = [e.clientX, e.clientY];\n\n      // 判断单击\n      if (handleClick && touches.size === 0 && approx(state.xy[0] - state.initial[0], 0, 5) && approx(state.xy[1] - state.initial[1], 0, 5) && performance.now() - state.startTime < 300) handleClick(e, state.target);\n      handleDrag(state, e);\n    };\n    ref.addEventListener(\'pointerdown\', handleDown, options);\n    ref.addEventListener(\'pointermove\', handleMove, {\n      ...options,\n      passive: false\n    });\n    ref.addEventListener(\'pointerup\', handleUp, options);\n    ref.addEventListener(\'pointercancel\', e => {\n      e.stopPropagation();\n      const state = touches.get(e.pointerId);\n      if (!state) return;\n      state.type = \'cancel\';\n      handleDrag(state, e);\n      touches.clear();\n    }, {\n      capture: false,\n      passive: true,\n      signal: controller.signal\n    });\n    if (easyMode) {\n      ref.addEventListener(\'pointerover\', handleDown, options);\n      ref.addEventListener(\'pointerout\', handleUp, options);\n    }\n    return () => controller.abort();\n  });\n};\n\nconst useStore = initState => {\n  const [_state, _setState] = store.createStore(initState);\n  return {\n    _state,\n    _setState,\n    setState: fn => _setState(store.produce(fn)),\n    store: _state\n  };\n};\n\nconst useStyleSheet = e => {\n  const styleSheet = new CSSStyleSheet();\n  onAutoMount(() => {\n    const root = e?.getRootNode() ?? document;\n    root.adoptedStyleSheets = [...root.adoptedStyleSheets, styleSheet];\n    return () => {\n      const index = root.adoptedStyleSheets.indexOf(styleSheet);\n      if (index !== -1) root.adoptedStyleSheets.splice(index, 1);\n    };\n  });\n  return styleSheet;\n};\nconst useStyle = (css, e) => {\n  const styleSheet = useStyleSheet(e);\n  if (typeof css === \'string\') styleSheet.replaceSync(css);else createEffectOn(createRootMemo(css), style => styleSheet.replaceSync(style));\n};\n/** 用 CSSStyleSheet 实现和修改 style 一样的效果 */\nconst useStyleMemo = (selector, styleMapArg, e) => {\n  const styleSheet = useStyleSheet(e);\n  styleSheet.insertRule(`${selector} { }`);\n  const {\n    style\n  } = styleSheet.cssRules[0];\n  // 等火狐实现了 CSS Typed OM 后改用 styleMap 性能会更好，也能使用 CSS Typed OM 的 单位\n\n  const setStyle = (key, val) => {\n    if (val === undefined || val === \'\') return style.removeProperty(key);\n    style.setProperty(key, typeof val === \'string\' ? val : `${val}`);\n  };\n  const styleMapList = Array.isArray(styleMapArg) ? styleMapArg : [styleMapArg];\n  for (const styleMap of styleMapList) {\n    if (typeof styleMap === \'object\') {\n      for (const [key, val] of Object.entries(styleMap)) {\n        const styleText = createRootMemo(val);\n        createEffectOn(styleText, newVal => setStyle(key, newVal));\n      }\n    } else {\n      const styleMemoMap = createRootMemo(styleMap);\n      createEffectOn(styleMemoMap, map => {\n        for (const [key, val] of Object.entries(map)) setStyle(key, val);\n      });\n    }\n  }\n};\n\nconst zh = {alert:{comic_load_error:"漫画加载出错",download_failed:"下载失败",fetch_comic_img_failed:"获取漫画图片失败",img_load_failed:"图片加载失败",no_img_download:"没有能下载的图片",repeat_load:"加载图片中，请稍候",server_connect_failed:"无法连接到服务器"},button:{close_current_page_translation:"关闭当前页的翻译",download:"下载",download_completed:"下载完成",downloading:"下载中",exit:"退出",grid_mode:"网格模式",packaging:"打包中",page_fill:"页面填充",page_mode_double:"双页模式",page_mode_single:"单页模式",scroll_mode:"卷轴模式",setting:"设置",translate_current_page:"翻译当前页",zoom_in:"放大",zoom_out:"缩小"},description:"为漫画站增加双页阅读、翻译等优化体验的增强功能。",eh_tag_lint:{combo:"存在 [tag] 时，一般也存在 [tag]",conflict:"存在 [tag] 时，不应该存在 [tag]",miss_female:"缺少男性标签，可能需要",miss_parody:"缺少原作标签，可能需要",possible_conflict:"存在 [tag] 时，一般不应该存在 [tag]",prerequisite:"[tag] 的前置标签 [tag] 不存在"},end_page:{next_button:"下一话",prev_button:"上一话",tip:{end_jump:"已到结尾，继续向下翻页将跳至下一话",exit:"已到结尾，继续翻页将退出",start_jump:"已到开头，继续向上翻页将跳至上一话"}},hotkeys:{enter_read_mode:"进入阅读模式",float_tag_list:"悬浮标签列表",jump_to_end:"跳至尾页",jump_to_home:"跳至首页",page_down:"向下翻页",page_up:"向上翻页",scroll_down:"向下滚动",scroll_left:"向左滚动",scroll_right:"向右滚动",scroll_up:"向上滚动",switch_auto_enlarge:"切换图片自动放大选项",switch_dir:"切换阅读方向",switch_grid_mode:"切换网格模式",switch_page_fill:"切换页面填充",switch_scroll_mode:"切换卷轴模式",switch_single_double_page_mode:"切换单双页模式"},img_status:{error:"加载出错",loading:"正在加载",wait:"等待加载"},other:{"default":"默认",disable:"禁用",enabled:"启用",enter_comic_read_mode:"进入漫画阅读模式",fab_hidden:"隐藏悬浮按钮",fab_show:"显示悬浮按钮",fill_page:"填充页",img_loading:"图片加载中",loading_img:"加载图片中",or:"或",page_range:"请输入页码范围：\\n（例如：「1, 3-5, 9-」)",read_mode:"阅读模式"},pwa:{alert:{img_data_error:"图片数据错误",img_not_found:"找不到图片",img_not_found_files:"请选择图片文件或含有图片文件的压缩包",img_not_found_folder:"文件夹下没有图片文件或含有图片文件的压缩包",not_valid_url:"不是有效的 URL",repeat_load:"正在加载其他文件中……",unzip_error:"解压出错",unzip_password_error:"解压密码错误",userscript_not_installed:"未安装 ComicRead 脚本"},button:{enter_url:"输入 URL",install:"安装",no_more_prompt:"不再提示",resume_read:"恢复阅读",select_files:"选择文件",select_folder:"选择文件夹"},install_md:"### 每次都要打开这个网页很麻烦？\\n如果你希望\\n1. 能有独立的窗口，像是在使用本地软件一样\\n1. 加入本地压缩文件的打开方式之中，方便直接打开\\n1. 离线使用~~（主要是担心国内网络抽风无法访问这个网页~~\\n### 欢迎将本页面作为 PWA 应用安装到电脑上😃👍",message:{enter_password:"请输入密码",unzipping:"解压缩中"},tip_enter_url:"请输入压缩包 URL",tip_md:"# ComicRead PWA\\n使用 [ComicRead](https://github.com/hymbz/ComicReadScript) 的阅读模式阅读**本地**漫画\\n---\\n### 将图片文件、文件夹、压缩包直接拖入即可开始阅读\\n*也可以选择**直接粘贴**或**输入**压缩包 URL 下载阅读*"},setting:{hotkeys:{add:"添加新快捷键",restore:"恢复默认快捷键"},language:"语言",option:{abreast_duplicate:"每列重复比例",abreast_mode:"并排卷轴模式",always_load_all_img:"始终加载所有图片",autoHiddenMouse:"自动隐藏鼠标",auto_switch_page_mode:"自动切换单双页模式",background_color:"背景颜色",click_page_turn_area:"点击区域",click_page_turn_enabled:"点击翻页",click_page_turn_swap_area:"左右点击区域交换",click_page_turn_vertical:"上下翻页",dark_mode:"夜间模式",dir_ltr:"从左到右（美漫）",dir_rtl:"从右到左（日漫）",disable_auto_enlarge:"禁止图片自动放大",first_page_fill:"默认启用首页填充",fit_to_width:"图片适合宽度",img_recognition:"图像识别",img_recognition_background:"识别背景色",img_recognition_pageFill:"自动调整页面填充",img_recognition_warn:"❗ 当前浏览器不支持 Web Worker，开启此功能可能导致页面卡顿，建议升级或更换浏览器。",img_recognition_warn_2:"❗ 当前网站不支持 Web Worker，开启此功能可能导致页面卡顿。",jump_to_next_chapter:"翻页至上/下一话",paragraph_dir:"阅读方向",paragraph_display:"显示",paragraph_hotkeys:"快捷键",paragraph_operation:"操作",paragraph_other:"其他",paragraph_scrollbar:"滚动条",paragraph_translation:"翻译",preload_page_num:"预加载页数",scroll_mode_img_scale:"卷轴图片缩放",scroll_mode_img_spacing:"卷轴图片间距",scrollbar_auto_hidden:"自动隐藏",scrollbar_easy_scroll:"快捷滚动",scrollbar_position:"位置",scrollbar_position_auto:"自动",scrollbar_position_bottom:"底部",scrollbar_position_hidden:"隐藏",scrollbar_position_right:"右侧",scrollbar_position_top:"顶部",scrollbar_show_img_status:"显示图片加载状态",show_clickable_area:"显示点击区域",show_comments:"在结束页显示评论",swap_page_turn_key:"左右翻页键交换",zoom:"图片缩放"},translation:{cotrans_tip:"<p>将使用 <a href=\\"https://cotrans.touhou.ai\\" target=\\"_blank\\">Cotrans</a> 提供的接口翻译图片，该服务器由其维护者用爱发电自费维护</p>\\n<p>多人同时使用时需要排队等待，等待队列达到上限后再上传新图片会报错，需要过段时间再试</p>\\n<p>所以还请 <b>注意用量</b></p>\\n<p>更推荐使用自己本地部署的项目，既不占用服务器资源也不需要排队</p>",options:{detection_resolution:"文本扫描清晰度",direction:"渲染字体方向",direction_auto:"原文一致",direction_horizontal:"仅限水平",direction_vertical:"仅限垂直",forceRetry:"忽略缓存强制重试",localUrl:"自定义服务器 URL",onlyDownloadTranslated:"只下载完成翻译的图片",target_language:"目标语言",text_detector:"文本扫描器",translator:"翻译服务"},range:"翻译范围",server:"翻译服务器",server_selfhosted:"本地部署",translate_all:"翻译全部图片",translate_to_end:"翻译当前页至结尾"}},site:{add_feature:{associate_nhentai:"关联nhentai",auto_adjust_option:"自动调整阅读配置",auto_page_turn:"无限滚动",auto_show:"自动进入阅读模式",block_totally:"彻底屏蔽漫画",colorize_tag:"标签染色",detect_ad:"识别广告页",float_tag_list:"悬浮标签列表",hotkeys:"快捷键",load_original_image:"加载原图",lock_option:"锁定站点配置",open_link_new_page:"在新页面中打开链接",quick_favorite:"快捷收藏",quick_rating:"快捷评分",quick_tag_define:"快捷查看标签定义",remember_current_site:"记住当前站点",tag_lint:"标签检查"},changed_load_failed:"网站发生变化，无法加载漫画",ehentai:{change_favorite_failed:"收藏夹修改失败",change_favorite_success:"收藏夹修改成功",change_rating_failed:"评分修改失败",change_rating_success:"评分修改成功",fetch_favorite_failed:"获取收藏夹信息失败",fetch_img_page_source_failed:"获取图片页源码失败",fetch_img_page_url_failed:"从详情页获取图片页地址失败",fetch_img_url_failed:"从图片页获取图片地址失败",html_changed_nhentai_failed:"页面结构发生改变，关联 nhentai 漫画功能无法正常生效",ip_banned:"IP地址被禁",nhentai_error:"nhentai 匹配出错",nhentai_failed:"匹配失败，请在确认登录 {{nhentai}} 后刷新"},need_captcha:"需要人机验证",nhentai:{fetch_next_page_failed:"获取下一页漫画数据失败",tag_blacklist_fetch_failed:"标签黑名单获取失败"},settings_tip:"设置",show_settings_menu:"显示设置菜单",simple:{auto_read_mode_message:"已默认开启「自动进入阅读模式」",no_img:"未找到合适的漫画图片，\\n如有需要可点此关闭简易阅读模式",simple_read_mode:"使用简易阅读模式"}},touch_area:{menu:"菜单",next:"下页",prev:"上页",type:{edge:"边缘",l:"L",left_right:"左右",up_down:"上下"}},translation:{status:{colorizing:"正在上色","default":"未知状态",detection:"正在检测文本",downscaling:"正在缩小图片",error:"翻译出错","error-lang":"你选择的翻译服务不支持你选择的语言","error-translating":"翻译服务没有返回任何文本","error-with-id":"翻译出错",finished:"正在整理结果",inpainting:"正在修补图片","mask-generation":"正在生成文本掩码",ocr:"正在识别文本",pending:"正在等待","pending-pos":"正在等待",preparing:"等待空闲窗口",rendering:"正在渲染",saved:"保存结果","skip-no-regions":"图片中没有检测到文本区域","skip-no-text":"图片中没有检测到文本",textline_merge:"正在整合文本",translating:"正在翻译文本",upscaling:"正在放大图片"},tip:{check_img_status_failed:"检查图片状态失败",download_img_failed:"下载图片失败",error:"翻译出错",get_translator_list_error:"获取可用翻译服务列表时出错",id_not_returned:"未返回 id",img_downloading:"下载图片中",img_not_fully_loaded:"图片未加载完毕",pending:"正在等待，列队还有 {{pos}} 张图片",resize_img_failed:"缩放图片失败",translation_completed:"翻译完成",upload:"上传图片中",upload_error:"上传图片出错",upload_return_error:"服务器翻译出错",wait_translation:"等待翻译"},translator:{baidu:"百度",deepl:"DeepL",google:"谷歌","gpt3.5":"GPT-3.5",none:"删除文本",offline:"离线模型",original:"原文",youdao:"有道"}}};\n\nconst en = {alert:{comic_load_error:"Comic loading error",download_failed:"Download failed",fetch_comic_img_failed:"Failed to fetch comic images",img_load_failed:"Image loading failed",no_img_download:"No images available for download",repeat_load:"Loading image, please wait",server_connect_failed:"Unable to connect to the server"},button:{close_current_page_translation:"Close translation of the current page",download:"Download",download_completed:"Download completed",downloading:"Downloading",exit:"Exit",grid_mode:"Grid mode",packaging:"Packaging",page_fill:"Page fill",page_mode_double:"Double page mode",page_mode_single:"Single page mode",scroll_mode:"Scroll mode",setting:"Settings",translate_current_page:"Translate current page",zoom_in:"Zoom in",zoom_out:"Zoom out"},description:"Add enhanced features to the comic site for optimized experience, including dual-page reading and translation.",eh_tag_lint:{combo:"[tag]: In most cases, Should coexist with [tag]",conflict:"[tag]: Should not coexist with [tag]",miss_female:"Missing male tag, might need",miss_parody:"Missing parody tag, might need",possible_conflict:"[tag]: In most cases, Should not coexist with [tag]",prerequisite:"[tag]: The prerequisite tag [tag] does not exist"},end_page:{next_button:"Next chapter",prev_button:"Prev chapter",tip:{end_jump:"Reached the last page, scrolling down will jump to the next chapter",exit:"Reached the last page, scrolling down will exit",start_jump:"Reached the first page, scrolling up will jump to the previous chapter"}},hotkeys:{enter_read_mode:"Enter reading mode",float_tag_list:"Floating tag list",jump_to_end:"Jump to the last page",jump_to_home:"Jump to the first page",page_down:"Turn the page to the down",page_up:"Turn the page to the up",scroll_down:"Scroll down",scroll_left:"Scroll left",scroll_right:"Scroll right",scroll_up:"Scroll up",switch_auto_enlarge:"Switch auto image enlarge option",switch_dir:"Switch reading direction",switch_grid_mode:"Switch grid mode",switch_page_fill:"Switch page fill",switch_scroll_mode:"Switch scroll mode",switch_single_double_page_mode:"Switch single/double page mode"},img_status:{error:"Load Error",loading:"Loading",wait:"Waiting for load"},other:{"default":"Default",disable:"Disable",enabled:"Enabled",enter_comic_read_mode:"Enter comic reading mode",fab_hidden:"Hide floating button",fab_show:"Show floating button",fill_page:"Fill Page",img_loading:"Image loading",loading_img:"Loading image",or:"or",page_range:"Please enter the page range.:\\n (e.g., \\"1, 3-5, 9-\\")",read_mode:"Reading mode"},pwa:{alert:{img_data_error:"Image data error",img_not_found:"Image not found",img_not_found_files:"Please select an image file or a compressed file containing image files",img_not_found_folder:"No image files or compressed files containing image files in the folder",not_valid_url:"Not a valid URL",repeat_load:"Loading other files…",unzip_error:"Decompression error",unzip_password_error:"Decompression password error",userscript_not_installed:"ComicRead userscript not installed"},button:{enter_url:"Enter URL",install:"Install",no_more_prompt:"Do not prompt again",resume_read:"Restore reading",select_files:"Select File",select_folder:"Select folder"},install_md:"### Tired of opening this webpage every time?\\nIf you wish to:\\n1. Have an independent window, as if using local software\\n1. Add to the local compressed file opening method for easy direct opening\\n1. Use offline\\n### Welcome to install this page as a PWA app on your computer😃👍",message:{enter_password:"Please enter your password",unzipping:"Unzipping"},tip_enter_url:"Please enter the URL of the compressed file",tip_md:"# ComicRead PWA\\nRead **local** comics using [ComicRead](https://github.com/hymbz/ComicReadScript) reading mode.\\n---\\n### Drag and drop image files, folders, or compressed files directly to start reading\\n*You can also choose to **paste directly** or **enter** the URL of the compressed file for downloading and reading*"},setting:{hotkeys:{add:"Add new hotkeys",restore:"Restore default hotkeys"},language:"Language",option:{abreast_duplicate:"Column duplicates ratio",abreast_mode:"Abreast scroll mode",always_load_all_img:"Always load all images",autoHiddenMouse:"Auto hide mouse",auto_switch_page_mode:"Auto switch single/double page mode",background_color:"Background Color",click_page_turn_area:"Touch area",click_page_turn_enabled:"Click to turn page",click_page_turn_swap_area:"Swap LR clickable areas",click_page_turn_vertical:"Vertically arranged clickable areas",dark_mode:"Dark mode",dir_ltr:"LTR (American comics)",dir_rtl:"RTL (Japanese manga)",disable_auto_enlarge:"Disable automatic image enlarge",first_page_fill:"Enable first page fill by default",fit_to_width:"Fit to width",img_recognition:"Image Recognition",img_recognition_background:"Recognition background color",img_recognition_pageFill:"Auto switch page fill",img_recognition_warn:"❗ The current browser does not support Web Workers. Enabling this feature may cause page lag. It\'s recommended to upgrade or switch browsers.",img_recognition_warn_2:"❗ The current website does not support Web Workers. Enabling this feature may cause page lag.",jump_to_next_chapter:"Turn to the next/previous chapter",paragraph_dir:"Reading direction",paragraph_display:"Display",paragraph_hotkeys:"Hotkeys",paragraph_operation:"Operation",paragraph_other:"Other",paragraph_scrollbar:"Scrollbar",paragraph_translation:"Translation",preload_page_num:"Preload page number",scroll_mode_img_scale:"Scroll mode image zoom ratio",scroll_mode_img_spacing:"Scroll mode image spacing",scrollbar_auto_hidden:"Auto hide",scrollbar_easy_scroll:"Easy scroll",scrollbar_position:"position",scrollbar_position_auto:"Auto",scrollbar_position_bottom:"Bottom",scrollbar_position_hidden:"Hidden",scrollbar_position_right:"Right",scrollbar_position_top:"Top",scrollbar_show_img_status:"Show image loading status",show_clickable_area:"Show clickable areas",show_comments:"Show comments on the end page",swap_page_turn_key:"Swap LR page-turning keys",zoom:"Image zoom ratio"},translation:{cotrans_tip:"<p>Using the interface provided by <a href=\\"https://cotrans.touhou.ai\\" target=\\"_blank\\">Cotrans</a> to translate images, which is maintained by its maintainer at their own expense.</p>\\n<p>When multiple people use it at the same time, they need to queue and wait. If the waiting queue reaches its limit, uploading new images will result in an error. Please try again after a while.</p>\\n<p>So please <b>mind the frequency of use</b>.</p>\\n<p>It is highly recommended to use your own locally deployed project, as it does not consume server resources and does not require queuing.</p>",options:{detection_resolution:"Text detection resolution",direction:"Render text orientation",direction_auto:"Follow source",direction_horizontal:"Horizontal only",direction_vertical:"Vertical only",forceRetry:"Force retry (ignore cache)",localUrl:"customize server URL",onlyDownloadTranslated:"Download only the translated images",target_language:"Target language",text_detector:"Text detector",translator:"Translator"},range:"Scope of Translation",server:"Translation server",server_selfhosted:"Selfhosted",translate_all:"Translate all images",translate_to_end:"Translate the current page to the end"}},site:{add_feature:{associate_nhentai:"Associate nhentai",auto_adjust_option:"Auto adjust reading option",auto_page_turn:"Infinite scroll",auto_show:"Auto enter reading mode",block_totally:"Totally block comics",colorize_tag:"Colorize tags",detect_ad:"Detect advertise page",float_tag_list:"Floating tag list",hotkeys:"Hotkeys",load_original_image:"Load original image",lock_option:"Lock site option",open_link_new_page:"Open links in a new page",quick_favorite:"Quick favorite",quick_rating:"Quick rating",quick_tag_define:"Quick view tag define",remember_current_site:"Remember the current site",tag_lint:"Tag Lint"},changed_load_failed:"The website has undergone changes, unable to load comics",ehentai:{change_favorite_failed:"Failed to change the favorite",change_favorite_success:"Successfully changed the favorite",change_rating_failed:"Failed to change the rating",change_rating_success:"Successfully changed the rating",fetch_favorite_failed:"Failed to get favorite info",fetch_img_page_source_failed:"Failed to get the source code of the image page",fetch_img_page_url_failed:"Failed to get the image page address from the detail page",fetch_img_url_failed:"Failed to get the image address from the image page",html_changed_nhentai_failed:"The web page structure has changed, the function to associate nhentai comics is not working properly",ip_banned:"IP address is banned",nhentai_error:"Error in nhentai matching",nhentai_failed:"Matching failed, please refresh after confirming login to {{nhentai}}"},need_captcha:"Need CAPTCHA verification",nhentai:{fetch_next_page_failed:"Failed to get next page of comic data",tag_blacklist_fetch_failed:"Failed to fetch tag blacklist"},settings_tip:"Settings",show_settings_menu:"Show settings menu",simple:{auto_read_mode_message:"\\"Auto enter reading mode\\" is enabled by default",no_img:"No suitable comic images were found.\\nIf necessary, you can click here to close the simple reading mode.",simple_read_mode:"Enter simple reading mode"}},touch_area:{menu:"Menu",next:"Next Page",prev:"Prev Page",type:{edge:"Edge",l:"L",left_right:"Left Right",up_down:"Up Down"}},translation:{status:{colorizing:"Colorizing","default":"Unknown status",detection:"Detecting text",downscaling:"Downscaling",error:"Error during translation","error-lang":"The target language is not supported by the chosen translator","error-translating":"Did not get any text back from the text translation service","error-with-id":"Error during translation",finished:"Finishing",inpainting:"Inpainting","mask-generation":"Generating mask",ocr:"Scanning text",pending:"Pending","pending-pos":"Pending",preparing:"Waiting for idle window",rendering:"Rendering",saved:"Saved","skip-no-regions":"No text regions detected in the image","skip-no-text":"No text detected in the image",textline_merge:"Merging text lines",translating:"Translating",upscaling:"Upscaling"},tip:{check_img_status_failed:"Failed to check image status",download_img_failed:"Failed to download image",error:"Translation error",get_translator_list_error:"Error occurred while getting the list of available translation services",id_not_returned:"No id returned",img_downloading:"Downloading images",img_not_fully_loaded:"Image has not finished loading",pending:"Pending, {{pos}} in queue",resize_img_failed:"Failed to resize image",translation_completed:"Translation completed",upload:"Uploading image",upload_error:"Image upload error",upload_return_error:"Error during server translation",wait_translation:"Waiting for translation"},translator:{baidu:"baidu",deepl:"DeepL",google:"Google","gpt3.5":"GPT-3.5",none:"Remove texts",offline:"offline translator",original:"Original",youdao:"youdao"}}};\n\nconst ru = {alert:{comic_load_error:"Ошибка загрузки комикса",download_failed:"Ошибка загрузки",fetch_comic_img_failed:"Не удалось загрузить изображения",img_load_failed:"Не удалось загрузить изображение",no_img_download:"Нет доступных картинок для загрузки",repeat_load:"Загрузка изображения, пожалуйста подождите",server_connect_failed:"Не удалось подключиться к серверу"},button:{close_current_page_translation:"Скрыть перевод текущей страницы",download:"Скачать",download_completed:"Загрузка завершена",downloading:"Скачивание",exit:"Выход",grid_mode:"Режим сетки",packaging:"Упаковка",page_fill:"Заполнить страницу",page_mode_double:"Двухчастичный режим",page_mode_single:"Одностраничный режим",scroll_mode:"Режим прокрутки",setting:"Настройки",translate_current_page:"Перевести текущую страницу",zoom_in:"Приблизить",zoom_out:"Уменьшить"},description:"Добавляет расширенные функции для удобства на сайт, такие как двухстраничный режим и перевод.",eh_tag_lint:{combo:"[тег]: В большинстве случаев должен сосуществовать с [тегом]",conflict:"[tag]: Не должен сосуществовать с [tag]",miss_female:"Отсутствует мужской тег, возможно, понадобится",miss_parody:"Отсутствует тег пародии, возможно, понадобится",possible_conflict:"[tag]: В большинстве случаев не должен сосуществовать с [tag]",prerequisite:"[tag]: Предварительный тег [tag] не существует"},end_page:{next_button:"Следующая глава",prev_button:"Предыдущая глава",tip:{end_jump:"Последняя страница, следующая глава ниже",exit:"Последняя страница, ниже комикс будет закрыт",start_jump:"Первая страница, выше будет загружена предыдущая глава"}},hotkeys:{enter_read_mode:"Режим чтения",float_tag_list:"Плавающий список тегов",jump_to_end:"Перейти к последней странице",jump_to_home:"Перейти к первой странице",page_down:"Перелистнуть страницу вниз",page_up:"Перелистнуть страницу вверх",scroll_down:"Прокрутить вниз",scroll_left:"Прокрутить влево",scroll_right:"Прокрутите вправо",scroll_up:"Прокрутите вверх",switch_auto_enlarge:"Автоматическое приближение",switch_dir:"Направление чтения",switch_grid_mode:"Режим сетки",switch_page_fill:"Заполнение страницы",switch_scroll_mode:"Режим прокрутки",switch_single_double_page_mode:"Одностраничный/Двухстраничный режим"},img_status:{error:"Ошибка загрузки",loading:"Загрузка",wait:"Ожидание загрузки"},other:{"default":"Дефолт",disable:"Отключить",enabled:"Включено",enter_comic_read_mode:"Режим чтения комиксов",fab_hidden:"Скрыть плавающую кнопку",fab_show:"Показать плавающую кнопку",fill_page:"Заполнить страницу",img_loading:"Изображение загружается",loading_img:"Загрузка изображения",or:"или",page_range:"Введите диапазон страниц.:\\n (например, \\"1, 3-5, 9-\\")",read_mode:"Режим чтения"},pwa:{alert:{img_data_error:"Ошибка данных изображения",img_not_found:"Изображение не найдено",img_not_found_files:"Пожалуйста выберите файл или архив с изображениями",img_not_found_folder:"В папке не найдены изображения или архивы с изображениями",not_valid_url:"Невалидный URL",repeat_load:"Загрузка других файлов…",unzip_error:"Ошибка распаковки",unzip_password_error:"Неверный пароль от архива",userscript_not_installed:"ComicRead не установлен"},button:{enter_url:"Ввести URL",install:"Установить",no_more_prompt:"Больше не показывать",resume_read:"Продолжить чтение",select_files:"Выбрать файл",select_folder:"Выбрать папку"},install_md:"### Устали открывать эту страницу каждый раз?\\nЕсли вы хотите:\\n1. Иметь отдельное окно, как если бы вы использовали обычное программное обеспечение\\n1. Открывать архивы напрямую\\n1. Пользоваться оффлайн\\n### Установите эту страницу в качестве [PWA](https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%BE%D0%B3%D1%80%D0%B5%D1%81%D1%81%D0%B8%D0%B2%D0%BD%D0%BE%D0%B5_%D0%B2%D0%B5%D0%B1-%D0%BF%D1%80%D0%B8%D0%BB%D0%BE%D0%B6%D0%B5%D0%BD%D0%B8%D0%B5) на свой компьютер 🐺☝️",message:{enter_password:"Пожалуйста введите пароль",unzipping:"Распаковка"},tip_enter_url:"Введите URL архива",tip_md:"# ComicRead PWA\\nИспользуйте [ComicRead](https://github.com/hymbz/ComicReadScript) для чтения комиксов **локально**.\\n---\\n### Перетащите изображения, папки или архивы чтобы начать читать\\n*Вы так же можете **открыть** или **вставить** URL архива на напрямую*"},setting:{hotkeys:{add:"Добавить горячие клавиши",restore:"Восстановить горячие клавиши по умолчанию"},language:"Язык",option:{abreast_duplicate:"Коэффициент дублирования столбцов",abreast_mode:"Режим прокрутки в ряд",always_load_all_img:"Всегда загружать все изображения",autoHiddenMouse:"Автоматически скрывать курсор мыши",auto_switch_page_mode:"Автоматическое переключение режима одиночной/двойной страницы",background_color:"Цвет фона",click_page_turn_area:"Область нажатия",click_page_turn_enabled:"Перелистывать по клику",click_page_turn_swap_area:"Поменять местами правую и левую области переключения страниц",click_page_turn_vertical:"Вертикальная область переключения страниц",dark_mode:"Ночная тема",dir_ltr:"Чтение слева направо (Американские комиксы)",dir_rtl:"Чтение справа налево (Японская манга)",disable_auto_enlarge:"Отключить автоматическое масштабирование изображений",first_page_fill:"Включить заполнение первой страницы по умолчанию",fit_to_width:"По ширине",img_recognition:"распознавание изображений",img_recognition_background:"Определить цвет фона",img_recognition_pageFill:"Автоматическое переключение заполнения страницы",img_recognition_warn:"❗ Текущий браузер не поддерживает Web Workers. Включение этой функции может вызвать задержку страницы. Рекомендуется обновить или сменить браузер.",img_recognition_warn_2:"❗ Текущий веб-сайт не поддерживает Web Workers. Включение этой функции может привести к задержке страницы.",jump_to_next_chapter:"Перелистнуть главу",paragraph_dir:"Направление чтения",paragraph_display:"Отображение",paragraph_hotkeys:"Горячие клавиши",paragraph_operation:"Управление",paragraph_other:"Другое",paragraph_scrollbar:"Полоса прокрутки",paragraph_translation:"Перевод",preload_page_num:"Предзагружать страниц",scroll_mode_img_scale:"Коэффициент масштабирования изображения в режиме скроллинга",scroll_mode_img_spacing:"Расстояние между страницами в режиме скроллинга",scrollbar_auto_hidden:"Автоматически скрывать",scrollbar_easy_scroll:"Лёгкая прокрутка",scrollbar_position:"Позиция",scrollbar_position_auto:"Авто",scrollbar_position_bottom:"Снизу",scrollbar_position_hidden:"Спрятано",scrollbar_position_right:"Справа",scrollbar_position_top:"Сверху",scrollbar_show_img_status:"Показывать статус загрузки изображения",show_clickable_area:"Показывать кликабельные области",show_comments:"Показывать комментарии на последней странице",swap_page_turn_key:"Поменять местами клавиши переключения страниц",zoom:"Коэффициент масштабирования изображения"},translation:{cotrans_tip:"<p>Использует для перевода <a href=\\"https://cotrans.touhou.ai\\" target=\\"_blank\\">Cotrans API</a>, работающий исключительно за счёт своего создателя.</p>\\n<p>Запросы обрабатываются по одному в порядке синхронной очереди. Когда очередь превышает лимит новые запросы будут приводить к ошибке. Если такое случилось попробуйте позже.</p>\\n<p>Так что пожалуйста <b>учитывайте загруженность при выборе</b></p>\\n<p>Настоятельно рекомендовано использовать проект развёрнутый локально т.к. это не потребляет серверные ресурсы и вы не ограничены очередью.</p>",options:{detection_resolution:"Разрешение распознавания текста",direction:"Ориетнация текста",direction_auto:"Следование оригиналу",direction_horizontal:"Только горизонтально",direction_vertical:"Только вертикально",forceRetry:"Принудительный повтор(Игнорировать кэш)",localUrl:"Настроить URL сервера",onlyDownloadTranslated:"Скачать только переведённые изображения",target_language:"Целевой язык",text_detector:"Детектор текста",translator:"Переводчик"},range:"Объем перевода",server:"Сервер",server_selfhosted:"Свой",translate_all:"Перевести все изображения",translate_to_end:"Переводить страницу до конца"}},site:{add_feature:{associate_nhentai:"Ассоциация с nhentai",auto_adjust_option:"Автоматическая настройка параметра чтения",auto_page_turn:"Автопереворот страниц",auto_show:"Автоматически включать режим чтения",block_totally:"Глобально заблокировать комиксы",colorize_tag:"Раскрасить теги",detect_ad:"Detect advertise page",float_tag_list:"Плавающий список тегов",hotkeys:"Горячие клавиши",load_original_image:"Загружать оригинальное изображение",lock_option:"Блокировка опции сайта",open_link_new_page:"Открывать ссылки в новой вкладке",quick_favorite:"Быстрый фаворит",quick_rating:"Быстрый рейтинг",quick_tag_define:"Определение тега быстрого просмотра",remember_current_site:"Запомнить текущий сайт",tag_lint:"Тэг Линт"},changed_load_failed:"Страница изменилась, невозможно загрузить комикс",ehentai:{change_favorite_failed:"Не удалось изменить избранное",change_favorite_success:"Избранное успешно изменено",change_rating_failed:"Не удалось изменить оценку",change_rating_success:"Успешно изменен рейтинг",fetch_favorite_failed:"Не удалось получить информацию о избранном",fetch_img_page_source_failed:"Не удалось получить исходный код страницы с изображениями",fetch_img_page_url_failed:"Не удалось получить адрес страницы изображений из деталей",fetch_img_url_failed:"Не удалось получить адрес изображения",html_changed_nhentai_failed:"Структура страницы изменилась, функция nhentai manga работает некорректно",ip_banned:"IP адрес забанен",nhentai_error:"Ошибка сопоставления с nhentai",nhentai_failed:"Ошибка сопостовления. Пожалуйста перезагрузите страницу после входа на {{nhentai}}"},need_captcha:"CAPTCHA",nhentai:{fetch_next_page_failed:"Не удалось получить следующую страницу",tag_blacklist_fetch_failed:"Не удалось получить заблокированные теги"},settings_tip:"Настройки",show_settings_menu:"Показать меню настроек",simple:{auto_read_mode_message:"\\"Автоматически включать режим чтения\\" по умолчанию",no_img:"Не найдено подходящих изображений. Можно нажать тут что бы выключить режим простого чтения.",simple_read_mode:"Включить простой режим чтения"}},touch_area:{menu:"Меню",next:"Следующая страница",prev:"Предыдущая страница",type:{edge:"Грань",l:"L",left_right:"Лево Право",up_down:"Верх Низ"}},translation:{status:{colorizing:"Раскрашивание","default":"Неизвестный статус",detection:"Распознавание текста",downscaling:"Уменьшение масштаба",error:"Ошибка перевода","error-lang":"Целевой язык не поддерживается выбранным переводчиком","error-translating":"Ошибка перевода(пустой ответ)","error-with-id":"Ошибка во время перевода",finished:"Завершение",inpainting:"Наложение","mask-generation":"Генерация маски",ocr:"Распознавание текста",pending:"Ожидание","pending-pos":"Ожидание",preparing:"Ожидание окна бездействия",rendering:"Отрисовка",saved:"Сохранено","skip-no-regions":"На изображении не обнаружено текстовых областей.","skip-no-text":"Текст на изображении не обнаружен",textline_merge:"Обьединение текста",translating:"Переводится",upscaling:"Увеличение изображения"},tip:{check_img_status_failed:"Не удалось проверить статус изображения",download_img_failed:"Не удалось скачать изображение",error:"Ошибка перевода",get_translator_list_error:"Произошла ошибка во время получения списка доступных переводчиков",id_not_returned:"ID не вернули(",img_downloading:"Скачивание изображений",img_not_fully_loaded:"Изображение всё ещё загружается",pending:"Ожидение, позиция в очереди {{pos}}",resize_img_failed:"Не удалось изменить размер изображения",translation_completed:"Перевод завершён",upload:"Загрузка изображения",upload_error:"Ошибка загрузки изображения",upload_return_error:"Ошибка перевода на сервере",wait_translation:"Ожидание перевода"},translator:{baidu:"baidu",deepl:"DeepL",google:"Google","gpt3.5":"GPT-3.5",none:"Убрать текст",offline:"Оффлайн переводчик",original:"Оригинал",youdao:"youdao"}}};\n\n/* eslint-disable no-console */\n\nconst prefix = [\'%cComicRead\', \'background-color: #607d8b; color: white; padding: 2px 4px; border-radius: 4px;\'];\nconst log = (...args) => console.log(...prefix, ...args);\nlog.warn = (...args) => console.warn(...prefix, ...args);\nlog.error = (...args) => {\n  console.error(...prefix, ...args);\n  if (args[0] instanceof Error) throw args[0];\n};\n\nconst [lang, setLang] = solidJs.createSignal(\'zh\');\nconst setInitLang = async () => setLang(await languages.getInitLang());\nconst t = solidJs.createRoot(() => {\n  solidJs.createEffect(solidJs.on(lang, async () => languages.setSaveLang(lang()), {\n    defer: true\n  }));\n  const locales = solidJs.createMemo(() => {\n    switch (lang()) {\n      case \'en\':\n        return en;\n      case \'ru\':\n        return ru;\n      default:\n        return zh;\n    }\n  });\n  return (keys, variables) => {\n    let text = byPath(locales(), keys) ?? \'\';\n    if (variables) for (const [k, v] of Object.entries(variables)) text = text.replaceAll(`{{${k}}}`, `${String(v)}`);\n    return text;\n  };\n});\n\nconst getDom = id => {\n  let dom = document.getElementById(id);\n  if (dom) {\n    dom.innerHTML = \'\';\n    return dom;\n  }\n  dom = document.createElement(\'div\');\n  dom.id = id;\n  document.body.append(dom);\n  return dom;\n};\n\n/** 挂载 solid-js 组件 */\nconst mountComponents = (id, fc) => {\n  const dom = getDom(id);\n  dom.style.setProperty(\'display\', \'unset\', \'important\');\n  const shadowDom = dom.attachShadow({\n    mode: \'closed\'\n  });\n  web.render(fc, shadowDom);\n  return dom;\n};\n\nexports.approx = approx;\nexports.assign = assign;\nexports.boolDataVal = boolDataVal;\nexports.byPath = byPath;\nexports.canvasToBlob = canvasToBlob;\nexports.clamp = clamp;\nexports.createEffectOn = createEffectOn;\nexports.createEqualsSignal = createEqualsSignal;\nexports.createMemoMap = createMemoMap;\nexports.createRootEffect = createRootEffect;\nexports.createRootMemo = createRootMemo;\nexports.createScheduled = createScheduled;\nexports.createSequence = createSequence;\nexports.createThrottleMemo = createThrottleMemo;\nexports.debounce = debounce;\nexports.descRange = descRange;\nexports.difference = difference;\nexports.domParse = domParse;\nexports.extractRange = extractRange;\nexports.getGmValue = getGmValue;\nexports.getKeyboardCode = getKeyboardCode;\nexports.getMostItem = getMostItem;\nexports.hijackFn = hijackFn;\nexports.inRange = inRange;\nexports.isEqual = isEqual;\nexports.isUrl = isUrl;\nexports.keyboardCodeToText = keyboardCodeToText;\nexports.lang = lang;\nexports.linstenKeydown = linstenKeydown;\nexports.log = log;\nexports.mountComponents = mountComponents;\nexports.needDarkMode = needDarkMode;\nexports.onAutoMount = onAutoMount;\nexports.plimit = plimit;\nexports.querySelector = querySelector;\nexports.querySelectorAll = querySelectorAll;\nexports.querySelectorClick = querySelectorClick;\nexports.range = range;\nexports.requestIdleCallback = requestIdleCallback;\nexports.saveAs = saveAs;\nexports.scrollIntoView = scrollIntoView;\nexports.setInitLang = setInitLang;\nexports.setLang = setLang;\nexports.singleThreaded = singleThreaded;\nexports.sleep = sleep;\nexports.t = t;\nexports.testImgUrl = testImgUrl;\nexports.throttle = throttle;\nexports.useCache = useCache;\nexports.useDrag = useDrag;\nexports.useStore = useStore;\nexports.useStyle = useStyle;\nexports.useStyleMemo = useStyleMemo;\nexports.wait = wait;\nexports.waitDom = waitDom;\nexports.waitImgLoad = waitImgLoad;\n';break;case"request":n="\nconst helper = require('helper');\nconst Toast = require('components/Toast');\n\n// 将 xmlHttpRequest 包装为 Promise\nconst xmlHttpRequest = details => new Promise((resolve, reject) => {\n  const handleError = error => {\n    details.onerror?.(error);\n    reject(new Error(error?.responseText));\n  };\n  const abort = GM_xmlhttpRequest({\n    ...details,\n    onload(res) {\n      details.onload?.call(res, res);\n      resolve(res);\n    },\n    onerror: handleError,\n    ontimeout: handleError,\n    onabort: handleError\n  });\n  details.signal?.addEventListener('abort', abort.abort);\n});\n/** 发起请求 */\nconst request = async (url, details, retryNum = 0, errorNum = 0) => {\n  const headers = {\n    Referer: window.location.href\n  };\n  const errorText = `${details?.errorText ?? helper.t('alert.comic_load_error')}\\nurl: ${url}`;\n  try {\n    // 虽然 GM_xmlhttpRequest 有 fetch 选项，但在 stay 上不太稳定\n    // 为了支持 ios 端只能自己实现一下了\n    if (details?.fetch ?? (url.startsWith('/') || url.startsWith(window.location.origin))) {\n      const res = await fetch(url, {\n        method: 'GET',\n        headers,\n        signal: AbortSignal.timeout?.(details?.timeout ?? 1000 * 10),\n        // eslint-disable-next-line unicorn/no-invalid-fetch-options\n        body: details?.data,\n        ...details\n      });\n      if (!details?.noCheckCode && res.status !== 200) {\n        helper.log.error(errorText, res);\n        throw new Error(errorText);\n      }\n      let response = null;\n      switch (details?.responseType) {\n        case 'arraybuffer':\n          response = await res.arrayBuffer();\n          break;\n        case 'blob':\n          response = await res.blob();\n          break;\n        case 'json':\n          response = await res.json();\n          break;\n      }\n      return {\n        status: res.status,\n        statusText: res.statusText,\n        response,\n        responseText: response ? '' : await res.text()\n      };\n    }\n    if (typeof GM_xmlhttpRequest === 'undefined') throw new Error(helper.t('pwa.alert.userscript_not_installed'));\n    let targetUrl = url;\n    // https://github.com/hymbz/ComicReadScript/issues/195\n    // 在某些情况下 Tampermonkey 无法正确处理相对协议的 url\n    // 实际 finalUrl 会变成 `///xxx.xxx` 莫名多了一个斜杠\n    // 然而在修改代码发出正确的请求后，就再也无法复现了\n    // 不过以防万一还是在这里手动处理下\n    if (url.startsWith('//')) targetUrl = `http:${url}`;\n    // stay 没法处理相对路径，也得转换一下\n    else if (url.startsWith('/')) targetUrl = `${window.location.origin}${url}`;\n    const res = await xmlHttpRequest({\n      method: 'GET',\n      url: targetUrl,\n      headers,\n      timeout: 1000 * 10,\n      ...details\n    });\n    if (!details?.noCheckCode && res.status !== 200) {\n      helper.log.error(errorText, res);\n      throw new Error(errorText);\n    }\n\n    // stay 好像没有正确处理 json，只能再单独判断处理一下\n    if (details?.responseType === 'json' && (typeof res.response !== 'object' || Object.keys(res.response).length === 0)) {\n      try {\n        Reflect.set(res, 'response', JSON.parse(res.responseText));\n      } catch {}\n    }\n    return res;\n  } catch (error) {\n    if (errorNum >= retryNum) {\n      (details?.noTip ? console.error : Toast.toast.error)(`${errorText}\\nerror: ${error.message}`);\n      throw new Error(errorText);\n    }\n    helper.log.error(errorText, error);\n    await helper.sleep(1000);\n    return request(url, details, retryNum, errorNum + 1);\n  }\n};\n\n/** 轮流向多个 api 发起请求 */\nconst eachApi = async (url, baseUrlList, details) => {\n  for (const baseUrl of baseUrlList) {\n    try {\n      return await request(`${baseUrl}${url}`, {\n        ...details,\n        noTip: true\n      });\n    } catch {}\n  }\n  const errorText = details?.errorText ?? helper.t('alert.comic_load_error');\n  if (!details?.noTip) Toast.toast.error(errorText);\n  helper.log.error('所有 api 请求均失败', url, baseUrlList, details);\n  throw new Error(errorText);\n};\n\nexports.eachApi = eachApi;\nexports.request = request;\n";break;case"components/Manga":n="\nconst web = require('solid-js/web');\nconst solidJs = require('solid-js');\nconst helper = require('helper');\nconst request = require('request');\nconst store$1 = require('solid-js/store');\nconst Comlink = require('comlink');\nconst worker = require('worker/ImageRecognition');\n\nconst imgState = {\n  imgMap: {},\n  imgList: [],\n  pageList: [],\n  fillEffect: {\n    '-1': true\n  },\n  showRange: [0, 0],\n  renderRange: [0, 0],\n  loadingRange: [0, 0],\n  defaultImgType: ''\n};\n\nconst LanguageMap = {\n  zh: 'CHS',\n  en: 'ENG'\n};\nconst targetLanguage = LanguageMap[helper.lang()] ?? 'CHS';\nconst _defaultOption = {\n  dir: 'rtl',\n  scrollbar: {\n    position: 'auto',\n    autoHidden: false,\n    showImgStatus: true,\n    easyScroll: false\n  },\n  clickPageTurn: {\n    enabled: 'ontouchstart' in document.documentElement,\n    reverse: false,\n    area: 'left_right'\n  },\n  firstPageFill: true,\n  disableZoom: false,\n  darkMode: false,\n  swapPageTurnKey: false,\n  jumpToNext: true,\n  alwaysLoadAllImg: false,\n  showComment: true,\n  preloadPageNum: 20,\n  pageNum: 0,\n  autoSwitchPageMode: true,\n  autoHiddenMouse: true,\n  zoom: {\n    ratio: 100,\n    offset: {\n      x: 0,\n      y: 0\n    }\n  },\n  scrollMode: {\n    enabled: false,\n    spacing: 0,\n    imgScale: 1,\n    fitToWidth: false,\n    abreastMode: false,\n    abreastDuplicate: 0.1\n  },\n  imgRecognition: {\n    enabled: false,\n    background: true,\n    pageFill: true\n  },\n  translation: {\n    server: 'disable',\n    localUrl: undefined,\n    forceRetry: false,\n    options: {\n      size: 'M',\n      detector: 'default',\n      translator: 'gpt3.5',\n      direction: 'auto',\n      targetLanguage\n    },\n    onlyDownloadTranslated: false\n  }\n};\nconst defaultOption = () => JSON.parse(JSON.stringify(_defaultOption));\nconst optionState = {\n  defaultOption: defaultOption(),\n  option: defaultOption()\n};\n\nconst otherState = {\n  title: '',\n  /**\n   * 用于防止滚轮连续滚动导致过快触发事件的锁\n   *\n   * - 在首次触发结束页时开启，一段时间关闭。开启时禁止触发结束页的上下话切换功能。\n   */\n  scrollLock: false,\n  rootSize: {\n    width: 0,\n    height: 0\n  },\n  scrollbarSize: {\n    width: 0,\n    height: 0\n  },\n  supportWorker: false\n};\n\nconst propState = {\n  commentList: undefined,\n  hotkeys: {},\n  prop: {\n    Exit: undefined,\n    Prev: undefined,\n    Next: undefined,\n    Loading: undefined,\n    OptionChange: undefined,\n    HotkeysChange: undefined,\n    editButtonList: list => list,\n    editSettingList: list => list\n  }\n};\n\nconst showState = {\n  isMobile: false,\n  isDragMode: false,\n  activePageIndex: 0,\n  gridMode: false,\n  show: {\n    toolbar: false,\n    scrollbar: false,\n    touchArea: false,\n    endPage: undefined\n  },\n  page: {\n    anima: '',\n    vertical: false,\n    offset: {\n      x: {\n        pct: 0,\n        px: 0\n      },\n      y: {\n        pct: 0,\n        px: 0\n      }\n    }\n  }\n};\n\nconst initStore = {\n  ...imgState,\n  ...showState,\n  ...propState,\n  ...optionState,\n  ...otherState\n};\nconst {\n  store,\n  setState,\n  _state,\n  _setState\n} = helper.useStore({\n  ...initStore\n});\nconst refs = {\n  root: undefined,\n  mangaBox: undefined,\n  mangaFlow: undefined,\n  touchArea: undefined,\n  scrollbar: undefined,\n  settingPanel: undefined,\n  // 结束页上的按钮\n  prev: undefined,\n  next: undefined,\n  exit: undefined\n};\n\nconst useStyle = css => solidJs.onMount(() => helper.useStyle(css, refs.root));\nconst useStyleMemo = (selector, styleMapArg) => solidJs.onMount(() => helper.useStyleMemo(selector, styleMapArg, refs.root));\n\n/** 在鼠标静止一段时间后自动隐藏 */\nconst useHiddenMouse = () => {\n  const [hiddenMouse, setHiddenMouse] = solidJs.createSignal(true);\n  const hidden = helper.debounce(() => setHiddenMouse(true), 1000);\n  return {\n    hiddenMouse,\n    /** 鼠标移动 */\n    onMouseMove() {\n      setHiddenMouse(false);\n      hidden();\n    }\n  };\n};\n\nconst getImg = (i, state = store) => state.imgMap[state.imgList[i]];\nconst getImgIndex = url => {\n  const indexList = [];\n  for (const [i, imgUrl] of store.imgList.entries()) if (imgUrl === url) indexList.push(i);\n  return indexList;\n};\nconst getImgEle = url => refs.mangaFlow.querySelector(`img[data-src=\"${url}\"]`);\n\n/** 找到指定页面所处的图片流 */\nconst findFillIndex = (pageIndex, fillEffect) => {\n  let nowFillIndex = pageIndex;\n  while (!Reflect.has(fillEffect, nowFillIndex)) nowFillIndex -= 1;\n  return nowFillIndex;\n};\n\n/** 触发 onOptionChange */\nconst triggerOnOptionChange = helper.throttle(() => store.prop.OptionChange?.(helper.difference(store.option, store.defaultOption)), 1000);\n\n/** 在 option 后手动触发 onOptionChange */\nconst setOption = fn => {\n  setState(state => fn(state.option, state));\n  triggerOnOptionChange();\n};\n\n/** 创建一个专门用于修改指定配置项的函数 */\nconst createStateSetFn = name => val => setOption(draftOption => helper.byPath(draftOption, name, () => val));\n\n/** 创建用于将 ref 绑定到对应 state 上的工具函数 */\nconst bindRef = name => e => Reflect.set(refs, name, e);\nconst watchDomSize = (name, e) => {\n  const resizeObserver = new ResizeObserver(([{\n    contentRect\n  }]) => {\n    if (!contentRect.width || !contentRect.height) return;\n    setState(state => {\n      state[name] = {\n        width: contentRect.width,\n        height: contentRect.height\n      };\n    });\n  });\n  resizeObserver.disconnect();\n  resizeObserver.observe(e);\n  solidJs.onCleanup(() => resizeObserver.disconnect());\n};\n\n/** 将界面恢复到正常状态 */\nconst resetUI = state => {\n  state.show.toolbar = false;\n  state.show.scrollbar = false;\n  state.show.touchArea = false;\n};\n\nconst [defaultHotkeys, setDefaultHotkeys] = solidJs.createSignal({\n  scroll_up: ['w', 'Shift + W', 'ArrowUp'],\n  scroll_down: ['s', 'Shift + S', 'ArrowDown', ' '],\n  scroll_left: ['a', 'Shift + A', ',', 'ArrowLeft'],\n  scroll_right: ['d', 'Shift + D', '.', 'ArrowRight'],\n  page_up: ['PageUp'],\n  page_down: [' ', 'PageDown'],\n  jump_to_home: ['Home'],\n  jump_to_end: ['End'],\n  exit: ['Escape'],\n  switch_page_fill: ['/', 'm', 'z'],\n  switch_scroll_mode: [],\n  switch_grid_mode: [],\n  switch_single_double_page_mode: [],\n  switch_dir: [],\n  switch_auto_enlarge: [],\n  translate_current_page: [],\n  translate_all: [],\n  translate_to_end: []\n});\n\n/** 快捷键配置 */\nconst hotkeysMap = helper.createRootMemo(() => Object.fromEntries(Object.entries(store.hotkeys).flatMap(([name, key]) => key.map(k => [k, name]))));\n\n// 1. 因为不同汉化组处理情况不同不可能全部适配，所以只能是尽量适配*出现频率更多*的情况\n/** 判断图片是否是跨页图 */\nconst isWideImg = img => {\n  switch (img.type ?? store.defaultImgType) {\n    case 'long':\n    case 'wide':\n      return true;\n    default:\n      return false;\n  }\n};\n\n/** 根据填充页设置双页排列单页图片 */\nconst arrangeImg = (pageList, fill) => {\n  if (pageList.length === 0) return [];\n  const newPageList = [];\n  let imgCache = fill ? [-1] : [];\n  for (const i of pageList) {\n    imgCache.push(i);\n    if (imgCache.length === 2) {\n      newPageList.push(imgCache);\n      imgCache = [];\n    }\n  }\n  if (imgCache.length === 1 && imgCache[0] !== -1) {\n    imgCache.push(-1);\n    newPageList.push(imgCache);\n  }\n  return newPageList;\n};\n\n/** 计算指定图片流中的左右页位置正确的页数 */\nconst computeAccuracy = (imgList, pageList) => {\n  let accuracy = 0;\n  for (const [a, b] of pageList) {\n    if ((imgList[a]?.blankMargin?.left ?? 0) > 0.04) accuracy += 1;\n    if (b === undefined) break;\n    if ((imgList[b]?.blankMargin?.right ?? 0) > 0.04) accuracy += 1;\n  }\n  return accuracy;\n};\n\n/** 自动切换填充页设置到左右页正确率更高的情况 */\nconst arrangePage = (pageList, {\n  imgList,\n  fillEffect,\n  nowFillIndex,\n  switchFill\n}) => {\n  const fill = Boolean(fillEffect[nowFillIndex]);\n  const newPageList = arrangeImg(pageList, fill);\n  if (!switchFill || typeof fillEffect[nowFillIndex] === 'number') return newPageList;\n  const anotherPageList = arrangeImg(pageList, !fill);\n  const anotherAccuracy = computeAccuracy(imgList, anotherPageList);\n  if (anotherAccuracy === 0) return newPageList;\n  const nowAccuracy = computeAccuracy(imgList, newPageList);\n  if (anotherAccuracy <= nowAccuracy) return newPageList;\n  helper.log(`${nowFillIndex} 自动切换页面填充`);\n  fillEffect[nowFillIndex] = !fill;\n  return anotherPageList;\n};\n\n/** 根据图片比例和填充页设置对漫画图片进行排列 */\nconst handleComicData = (imgList, fillEffect, switchFill) => {\n  const context = {\n    imgList,\n    fillEffect,\n    nowFillIndex: -1,\n    switchFill\n  };\n  let pageList = [];\n  let cacheList = [];\n  for (let i = 0; i < imgList.length; i += 1) {\n    const img = imgList[i];\n    if (!isWideImg(img)) {\n      cacheList.push(i);\n      if (Reflect.has(fillEffect, i)) Reflect.deleteProperty(fillEffect, i);\n      continue;\n    }\n\n    // 在除结尾（可能是汉化组图）外的位置出现了跨页图的话，那张跨页图大概率是页序的「正确答案」\n    // 如果这张跨页导致了上面一页缺页，就说明在这之前的填充有误，应该据此调整之前的填充\n    if (typeof fillEffect[context.nowFillIndex] === 'boolean' && i < imgList.length - 2 && (cacheList.length + (fillEffect[context.nowFillIndex] ? 1 : 0)) % 2 === 1) {\n      fillEffect[context.nowFillIndex] = !fillEffect[context.nowFillIndex];\n      return handleComicData(imgList, fillEffect, switchFill);\n    }\n    pageList = [...pageList, ...arrangePage(cacheList, context), [i]];\n    cacheList = [];\n    if (fillEffect[i] === undefined) fillEffect[i] = false;\n    context.nowFillIndex = i;\n  }\n  if (cacheList.length > 0) pageList = [...pageList, ...arrangePage(cacheList, context)];\n  return pageList;\n};\n\nconst imgList = helper.createRootMemo(() => store.imgList.map(url => store.imgMap[url]));\n\n/** 当前是否为并排卷轴模式 */\nconst isAbreastMode = helper.createRootMemo(() => store.option.scrollMode.enabled && store.option.scrollMode.abreastMode);\n\n/** 当前是否为普通卷轴模式 */\nconst isScrollMode = helper.createRootMemo(() => store.option.scrollMode.enabled && !store.option.scrollMode.abreastMode);\n\n/** 当前是否开启了识别背景色 */\nconst isEnableBg = helper.createRootMemo(() => store.option.imgRecognition.enabled && store.option.imgRecognition.background);\n\n/** 当前显示页面 */\nconst activePage = helper.createRootMemo(() => store.pageList[store.activePageIndex] ?? []);\n\n/** 当前显示的第一张图片的 index */\nconst activeImgIndex = helper.createRootMemo(() => activePage().find(i => i !== -1) ?? 0);\n\n/** 当前所处的图片流 */\nconst nowFillIndex = helper.createRootMemo(() => findFillIndex(activeImgIndex(), store.fillEffect));\n\n/** 预加载页数 */\nconst preloadNum = helper.createRootMemo(() => ({\n  back: store.option.preloadPageNum,\n  front: Math.floor(store.option.preloadPageNum / 2)\n}));\n\n/** 获取图片列表中指定属性的中位数 */\nconst getImgMedian = sizeFn => {\n  const list = imgList().filter(img => img.loadType === 'loaded' && img.width).map(sizeFn).sort((a, b) => a - b);\n  // 因为涉及到图片默认类型的计算，所以至少等到加载完三张图片再计算，避免被首页大图干扰\n  if (list.length < 3) return null;\n  return list[Math.floor(list.length / 2)];\n};\n\n/** 图片占位尺寸 */\nconst placeholderSize = helper.createThrottleMemo(() => ({\n  width: getImgMedian(img => img.width) ?? 800,\n  height: getImgMedian(img => img.height) ?? 1200\n}), 500);\n\n/** 并排卷轴模式下的列宽度 */\nconst abreastColumnWidth = helper.createRootMemo(() => isAbreastMode() ? placeholderSize().width * store.option.scrollMode.imgScale : 0);\nconst autoPageNum = helper.createThrottleMemo(() => store.rootSize.width >= store.rootSize.height ? 2 : 1);\nconst pageNum = helper.createRootMemo(() => store.option.pageNum || autoPageNum());\n\n/** 是否为单页模式 */\nconst isOnePageMode = helper.createRootMemo(() => pageNum() === 1 || store.option.scrollMode.enabled || store.isMobile || store.imgList.length <= 1);\n\n/** 重新计算图片排列 */\nconst updatePageData = state => {\n  const lastActiveImgIndex = activeImgIndex();\n  let newPageList = [];\n  newPageList = isOnePageMode() ? state.imgList.map((_, i) => [i]) : handleComicData(state.imgList.map(url => state.imgMap[url]), state.fillEffect, state.option.imgRecognition.pageFill);\n  if (helper.isEqual(state.pageList, newPageList)) return;\n  state.pageList = newPageList;\n\n  // 在图片排列改变后自动跳转回原先显示图片所在的页数\n  if (lastActiveImgIndex !== activeImgIndex()) {\n    const newActivePageIndex = state.pageList.findIndex(page => page.includes(lastActiveImgIndex));\n    if (newActivePageIndex !== -1) state.activePageIndex = newActivePageIndex;\n  }\n};\nupdatePageData.throttle = helper.throttle(() => setState(updatePageData), 100);\n\n/**\n * 将处理图片的相关变量恢复到初始状态\n *\n * 必须按照以下顺序调用\n * 1. 修改 imgList\n * 2. resetImgState\n * 3. updatePageData\n */\nconst resetImgState = state => {\n  // 如果用户没有手动修改过首页填充，才将其恢复初始\n  if (typeof state.fillEffect['-1'] === 'boolean') state.fillEffect['-1'] = state.option.firstPageFill && state.imgList.length > 3;\n};\nhelper.createEffectOn([pageNum, isOnePageMode], () => setState(updatePageData));\n\n/** 记录每张图片所在的页面 */\nconst imgPageMap = helper.createRootMemo(() => {\n  const map = {};\n  for (let i = 0; i < store.pageList.length; i++) {\n    for (const imgIndex of store.pageList[i]) if (imgIndex !== -1) map[imgIndex] = i;\n  }\n  return map;\n});\nconst [_scrollTop, setScrollTop] = solidJs.createSignal(0);\n/** 卷轴模式下的滚动距离 */\nconst scrollModTop = _scrollTop;\n/** 滚动距离 */\nconst scrollTop = helper.createRootMemo(() => isAbreastMode() ? store.page.offset.x.px : scrollModTop());\nconst bindScrollTop = dom => {\n  dom.addEventListener('scroll', () => setScrollTop(dom.scrollTop), {\n    passive: true\n  });\n};\n\n// 窗口宽度小于800像素时，标记为移动端\nhelper.createEffectOn(() => store.rootSize.width, width => {\n  const isMobile = helper.inRange(1, width, 800);\n  if (isMobile === store.isMobile) return;\n  setState(state => {\n    state.isMobile = isMobile;\n    resetImgState(state);\n    updatePageData(state);\n  });\n});\n\nconst isWideType = type => type === 'wide' || type === 'long';\n\n// https://www.figma.com/design/h0x2ZHVh3P3bCbnszonRqk/漫画双页阅读比例图\n// https://github.com/hymbz/ComicReadScript/issues/174#issuecomment-2252114640\n// 用于判断图片类型的比例\nconst 单页比例 = 1920 / 2 / 1080;\nconst 横幅比例 = 1920 / 1080;\nconst 条漫比例 = 1920 / 2 / 1080 / 2;\n\n/** 根据比例判断图片类型 */\nconst getImgType = img => {\n  const imgRatio = img.width / img.height;\n  if (imgRatio <= 单页比例) return imgRatio < 条漫比例 ? 'vertical' : '';\n  return imgRatio > 横幅比例 ? 'long' : 'wide';\n};\n\n/** 更新图片类型。返回是否修改了图片类型 */\nconst updateImgType = (state, draftImg) => {\n  const {\n    type\n  } = draftImg;\n  if (!draftImg.width || !draftImg.height) return false;\n  draftImg.type = getImgType(draftImg);\n  if (isWideType(type) !== isWideType(draftImg.type)) updatePageData.throttle();\n  return (type ?? state.defaultImgType) !== draftImg.type;\n};\n\n/** 是否自动开启过卷轴模式 */\nlet autoScrollMode = false;\nhelper.createRootEffect(prevIsWide => {\n  if (store.rootSize.width === 0 || store.rootSize.height === 0) return;\n  const defaultImgType = getImgType(placeholderSize());\n  if (defaultImgType === store.defaultImgType) return prevIsWide;\n  const isWide = isWideType(defaultImgType);\n  setState(state => {\n    state.defaultImgType = defaultImgType;\n\n    // 连续出现多张长图后，自动开启卷轴模式\n    if (defaultImgType === 'vertical' && !autoScrollMode && !state.option.scrollMode.enabled) {\n      state.option.scrollMode.enabled = true;\n      autoScrollMode = true;\n      return;\n    }\n    if (isWide !== prevIsWide) updatePageData(state);\n  });\n  return isWide;\n}, false);\n\n/** 获取指定图片的显示尺寸 */\nconst getImgDisplaySize = (state, url) => {\n  const img = state.imgMap[url];\n  let height = img.height ?? placeholderSize().height;\n  let width = img.width ?? placeholderSize().width;\n  const setWidth = w => {\n    height *= w / width;\n    width = w;\n    return {\n      height,\n      width\n    };\n  };\n  if (!state.option.scrollMode.enabled) return {\n    height,\n    width\n  };\n  if (isAbreastMode()) return setWidth(abreastColumnWidth());\n  if (state.option.scrollMode.fitToWidth) return setWidth(state.rootSize.width);\n  height *= state.option.scrollMode.imgScale;\n  width *= state.option.scrollMode.imgScale;\n  if (width > state.rootSize.width) return setWidth(state.rootSize.width);\n  return {\n    height,\n    width\n  };\n};\n\n/** 更新图片尺寸 */\nconst updateImgSize = (url, width, height) => setState(state => {\n  const img = state.imgMap[url];\n  if (img.width === width && img.height === height) return;\n  img.width = width;\n  img.height = height;\n  img.size = getImgDisplaySize(state, url);\n  updateImgType(state, img);\n});\nhelper.createEffectOn([imgList, () => store.option.scrollMode.enabled, () => store.option.scrollMode.abreastMode, () => store.option.scrollMode.fitToWidth, () => store.option.scrollMode.imgScale, () => store.rootSize, placeholderSize], ([{\n  length\n}]) => {\n  if (length === 0) return;\n  setState(state => {\n    for (const url of state.imgList) state.imgMap[url].size = getImgDisplaySize(state, url);\n  });\n});\n\n/** 卷轴模式下每张图片的位置 */\nconst imgTopList = helper.createRootMemo(() => {\n  if (!store.option.scrollMode.enabled) return [];\n  const list = Array.from({\n    length: store.imgList.length\n  });\n  let top = 0;\n  for (let i = 0; i < store.imgList.length; i++) {\n    list[i] = top;\n    top += getImg(i).size.height + store.option.scrollMode.spacing * 7;\n  }\n  return list;\n});\n\n/** 卷轴模式下漫画流的总高度 */\nconst contentHeight = helper.createRootMemo(() => (imgTopList().at(-1) ?? 0) + (imgList().at(-1)?.size.height ?? 0));\n\n// /** 预加载图片尺寸 */\n// const preloadImgSize = singleThreaded(async () => {\n//   let index = 0;\n//   for (; index < store.imgList.length; index++) {\n//     const img = store.imgList[index];\n//     if (img.size === undefined) continue;\n//     const size = await getImgSize(img.src);\n//     if (!size) continue;\n//     // 防止加载过程中 imgList 变了的情况\n//     if (store.imgList[index].src !== img.src) break;\n//     // eslint-disable-next-line @typescript-eslint/no-loop-func\n//     setState((state) => updateImgSize(state, index, ...size));\n//   }\n//\n//   if (index < store.imgList.length) requestIdleCallback(preloadImgSize);\n// });\n//\n// 空闲期间预加载所有图片的尺寸\n// 卷轴模式下需要提前知道尺寸方便正确布局\n// 翻页模式下也需要提前发现跨页图重新排序\n// requestIdleCallback(preloadImgSize);\nvar css$1 = \".img____hash_base64_5_ img{display:block;height:100%;object-fit:contain;width:100%}.img____hash_base64_5_{align-content:center;content-visibility:hidden;display:none;height:100%;margin-left:auto;margin-right:auto;position:relative;width:100%}.img____hash_base64_5_[data-show]{content-visibility:visible;display:block}.img____hash_base64_5_>picture{display:block;height:auto;inset:0;margin-bottom:auto;margin-left:inherit;margin-right:inherit;margin-top:auto;max-height:100%;max-width:100%;position:absolute;width:auto}.img____hash_base64_5_>picture,.img____hash_base64_5_>picture:after{background-color:var(--hover-bg-color,#fff3);background-image:var(--md-photo);background-position:50%;background-repeat:no-repeat;background-size:30%}.img____hash_base64_5_[data-load-type=error]>picture:after{background-color:#eee;background-image:var(--md-image-not-supported);content:\\\"\\\";height:100%;pointer-events:none;position:absolute;right:0;top:0;width:100%}.img____hash_base64_5_[data-load-type=loading]>picture{background-image:var(--md-cloud-download)}:is(.img____hash_base64_5_[data-load-type=loading]>picture) img{animation:show____hash_base64_5_ .1s forwards}.mangaFlow____hash_base64_5_[dir=ltr] .img____hash_base64_5_[data-show=\\\"1\\\"],.mangaFlow____hash_base64_5_[dir=rtl] .img____hash_base64_5_[data-show=\\\"0\\\"]{margin-left:0;margin-right:auto}.mangaFlow____hash_base64_5_[dir=ltr] .img____hash_base64_5_[data-show=\\\"0\\\"],.mangaFlow____hash_base64_5_[dir=rtl] .img____hash_base64_5_[data-show=\\\"1\\\"]{margin-left:auto;margin-right:0}.mangaFlow____hash_base64_5_{display:grid;grid-auto-columns:100%;grid-auto-flow:column;grid-auto-rows:100%;touch-action:none;transform-origin:0 0;-webkit-user-select:none;user-select:none;grid-row-gap:0;backface-visibility:hidden;color:var(--text);height:100%;place-items:center;width:100%}.mangaFlow____hash_base64_5_[data-disable-zoom] .img____hash_base64_5_>picture{height:fit-content;width:fit-content}.mangaFlow____hash_base64_5_[data-hidden-mouse=true]{cursor:none}.mangaFlow____hash_base64_5_[data-vertical]{grid-auto-flow:row}.mangaBox____hash_base64_5_{contain:layout style;height:100%;transform-origin:0 0;transition-duration:0s;width:100%}.mangaBox____hash_base64_5_[data-animation=page] .mangaFlow____hash_base64_5_,.mangaBox____hash_base64_5_[data-animation=zoom]{transition-duration:.3s}.root____hash_base64_5_:not([data-grid-mode]) .mangaBox____hash_base64_5_{scrollbar-width:none}:is(.root____hash_base64_5_:not([data-grid-mode]) .mangaBox____hash_base64_5_)::-webkit-scrollbar{display:none}.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_{grid-auto-columns:1fr;grid-auto-flow:row;grid-auto-rows:max-content;overflow:auto;grid-row-gap:1.5em;align-items:end;box-sizing:border-box;grid-template-rows:unset}:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_{cursor:pointer;margin-left:auto;margin-right:auto}:is(:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_)>picture{position:relative}:is(:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_)>.gridModeTip____hash_base64_5_{bottom:-1.5em;cursor:auto;direction:ltr;line-height:1.5em;opacity:.5;overflow:hidden;position:absolute;text-align:center;text-overflow:ellipsis;white-space:nowrap;width:100%}[data-load-type=error]:is(:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_),[data-load-type=wait]:is(:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_),[src=\\\"\\\"]:is(:is(.root____hash_base64_5_[data-grid-mode] .mangaFlow____hash_base64_5_) .img____hash_base64_5_){height:100%}.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_{overflow:auto}:is(.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_) .mangaFlow____hash_base64_5_{grid-row-gap:calc(var(--scroll-mode-spacing)*7px);height:fit-content}[data-abreast-scroll]:is(.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_){overflow:hidden}[data-abreast-scroll]:is(.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_) .mangaFlow____hash_base64_5_{grid-column-gap:calc(var(--scroll-mode-spacing)*7px);align-items:start;height:100%}:is([data-abreast-scroll]:is(.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_) .mangaFlow____hash_base64_5_) .img____hash_base64_5_{height:auto;width:100%;will-change:transform}:is(:is([data-abreast-scroll]:is(.root____hash_base64_5_[data-scroll-mode]:not([data-grid-mode]) .mangaBox____hash_base64_5_) .mangaFlow____hash_base64_5_) .img____hash_base64_5_)>picture{position:relative}@keyframes show____hash_base64_5_{0%{opacity:0}90%{opacity:0}to{opacity:1}}.endPage____hash_base64_5_{align-items:center;background-color:#333d;color:#fff;display:flex;height:100%;justify-content:center;left:0;opacity:0;pointer-events:none;position:absolute;top:0;transition:opacity .5s;width:100%;z-index:10}.endPage____hash_base64_5_>button{animation:jello____hash_base64_5_ .3s forwards;background-color:initial;color:inherit;cursor:pointer;font-size:1.2em;transform-origin:center}[data-is-end]:is(.endPage____hash_base64_5_>button){font-size:3em;margin:2em}.endPage____hash_base64_5_>.tip____hash_base64_5_{margin:auto;position:absolute}.endPage____hash_base64_5_[data-show]{opacity:1;pointer-events:all}.endPage____hash_base64_5_[data-type=start]>.tip____hash_base64_5_{transform:translateY(-10em)}.endPage____hash_base64_5_[data-type=end]>.tip____hash_base64_5_{transform:translateY(10em)}.root____hash_base64_5_[data-mobile] .endPage____hash_base64_5_>button{width:1em}.comments____hash_base64_5_{align-items:flex-end;display:flex;flex-direction:column;max-height:80%;opacity:.3;overflow:auto;padding-right:.5em;position:absolute;right:1em;width:20em}.comments____hash_base64_5_>p{background-color:#333b;border-radius:.5em;margin:.5em .1em;padding:.2em .5em}.comments____hash_base64_5_:hover{opacity:1}.root____hash_base64_5_[data-mobile] .comments____hash_base64_5_{max-height:15em;opacity:.8;top:calc(50% + 15em)}@keyframes jello____hash_base64_5_{0%,11.1%,to{transform:translateZ(0)}22.2%{transform:skewX(-12.5deg) skewY(-12.5deg)}33.3%{transform:skewX(6.25deg) skewY(6.25deg)}44.4%{transform:skewX(-3.125deg) skewY(-3.125deg)}55.5%{transform:skewX(1.5625deg) skewY(1.5625deg)}66.6%{transform:skewX(-.7812deg) skewY(-.7812deg)}77.7%{transform:skewX(.3906deg) skewY(.3906deg)}88.8%{transform:skewX(-.1953deg) skewY(-.1953deg)}}.toolbar____hash_base64_5_{align-items:center;display:flex;height:100%;justify-content:flex-start;position:fixed;top:0;z-index:9}.toolbarPanel____hash_base64_5_{display:flex;flex-direction:column;padding:.5em;position:relative;transform:translateX(-100%);transition:transform .2s}:is(.toolbar____hash_base64_5_[data-show],.toolbar____hash_base64_5_:hover) .toolbarPanel____hash_base64_5_{transform:none}.toolbar____hash_base64_5_[data-close] .toolbarPanel____hash_base64_5_{transform:translateX(-100%);visibility:hidden}.toolbarBg____hash_base64_5_{background-color:var(--page-bg);border-bottom-right-radius:1em;border-top-right-radius:1em;filter:opacity(.8);height:100%;position:absolute;right:0;top:0;width:100%}.root____hash_base64_5_[data-mobile] .toolbar____hash_base64_5_{font-size:1.3em}.root____hash_base64_5_[data-mobile] .toolbar____hash_base64_5_:not([data-show]){pointer-events:none}.root____hash_base64_5_[data-mobile] .toolbarBg____hash_base64_5_{filter:opacity(.8)}.SettingPanelPopper____hash_base64_5_{height:0!important;padding:0!important;pointer-events:unset!important;transform:none!important}.SettingPanel____hash_base64_5_{background-color:var(--page-bg);border-radius:.3em;bottom:0;box-shadow:0 3px 1px -2px #0003,0 2px 2px 0 #00000024,0 1px 5px 0 #0000001f;color:var(--text);font-size:1.2em;height:fit-content;margin:auto;max-height:95%;max-width:calc(100% - 5em);overflow:auto;position:fixed;top:0;-webkit-user-select:text;user-select:text;z-index:1}.SettingPanel____hash_base64_5_ hr{color:#fff;margin:0}.SettingBlock____hash_base64_5_{display:grid;grid-template-rows:max-content 1fr;transition:grid-template-rows .2s ease-out}.SettingBlock____hash_base64_5_ .SettingBlockBody____hash_base64_5_{overflow:hidden;padding:0 .5em 1em;z-index:0}:is(.SettingBlock____hash_base64_5_ .SettingBlockBody____hash_base64_5_)>div+:is(.SettingBlock____hash_base64_5_ .SettingBlockBody____hash_base64_5_)>div{margin-top:1em}.SettingBlock____hash_base64_5_[data-show=false]{grid-template-rows:max-content 0fr;padding-bottom:unset}.SettingBlock____hash_base64_5_[data-show=false] .SettingBlockBody____hash_base64_5_{padding:unset}.SettingBlockSubtitle____hash_base64_5_{background-color:var(--page-bg);color:var(--text-secondary);cursor:pointer;font-size:.7em;height:3em;line-height:3em;margin-bottom:.1em;position:sticky;text-align:center;top:0;z-index:1}.SettingsItem____hash_base64_5_{align-items:center;display:flex;justify-content:space-between}:is(.SettingsItem____hash_base64_5_,.SettingsShowItem____hash_base64_5_)+.SettingsItem____hash_base64_5_{margin-top:1em}.SettingsItemName____hash_base64_5_{font-size:.9em;max-width:calc(100% - 4em);overflow-wrap:anywhere;text-align:start;white-space:pre-wrap}.SettingsItemSwitch____hash_base64_5_{align-items:center;background-color:var(--switch-bg);border:0;border-radius:1em;cursor:pointer;display:inline-flex;height:.8em;margin:.3em;padding:0;width:2.3em}.SettingsItemSwitchRound____hash_base64_5_{background:var(--switch);border-radius:100%;box-shadow:0 2px 1px -1px #0003,0 1px 1px 0 #00000024,0 1px 3px 0 #0000001f;height:1.15em;transform:translateX(-10%);transition:transform .1s;width:1.15em}.SettingsItemSwitch____hash_base64_5_[data-checked=true]{background:var(--secondary-bg)}.SettingsItemSwitch____hash_base64_5_[data-checked=true] .SettingsItemSwitchRound____hash_base64_5_{background:var(--secondary);transform:translateX(110%)}.SettingsItemIconButton____hash_base64_5_{background-color:initial;border:none;color:var(--text);cursor:pointer;font-size:1.7em;height:1em;margin:0 .2em 0 0;padding:0}.SettingsItemSelect____hash_base64_5_{background-color:var(--hover-bg-color);border:none;border-radius:5px;cursor:pointer;font-size:.9em;margin:0;max-width:6.5em;outline:none;padding:.3em}.closeCover____hash_base64_5_{height:100%;left:0;position:fixed;top:0;width:100%}.SettingsShowItem____hash_base64_5_{display:grid;transition:grid-template-rows .2s ease-out}.SettingsShowItem____hash_base64_5_>.SettingsShowItemBody____hash_base64_5_{display:flex;flex-direction:column;overflow:hidden}:is(.SettingsShowItem____hash_base64_5_>.SettingsShowItemBody____hash_base64_5_)>.SettingsItem____hash_base64_5_{margin-top:1em}:is(.SettingsShowItem____hash_base64_5_>.SettingsShowItemBody____hash_base64_5_)>:is(textarea,input){line-height:1.2;margin:.4em .2em 0}[data-only-number]{padding:0 .2em}[data-only-number]+span{margin-left:-.1em}.hotkeys____hash_base64_5_{align-items:center;border-bottom:1px solid var(--secondary-bg);color:var(--text);display:flex;flex-grow:1;flex-wrap:wrap;font-size:.9em;padding:2em .2em .2em;position:relative;z-index:1}.hotkeys____hash_base64_5_+.hotkeys____hash_base64_5_{margin-top:.5em}.hotkeys____hash_base64_5_:last-child{border-bottom:none}.hotkeysItem____hash_base64_5_{align-items:center;border-radius:.3em;box-sizing:initial;cursor:pointer;display:flex;font-family:serif;height:1em;margin:.3em;outline:1px solid;outline-color:var(--secondary-bg);padding:.2em 1.2em}.hotkeysItem____hash_base64_5_>svg{background-color:var(--text);border-radius:1em;color:var(--page-bg);display:none;height:1em;margin-left:.4em;opacity:.5}:is(.hotkeysItem____hash_base64_5_>svg):hover{opacity:.9}.hotkeysItem____hash_base64_5_:hover{padding:.2em .5em}.hotkeysItem____hash_base64_5_:hover>svg{display:unset}.hotkeysItem____hash_base64_5_:focus,.hotkeysItem____hash_base64_5_:focus-visible{outline:var(--text) solid 2px}.hotkeysHeader____hash_base64_5_{align-items:center;box-sizing:border-box;display:flex;left:0;padding:0 .5em;position:absolute;top:0;width:100%}.hotkeysHeader____hash_base64_5_>p{background-color:var(--page-bg);line-height:1em;overflow-wrap:anywhere;text-align:start;white-space:pre-wrap}.hotkeysHeader____hash_base64_5_>div[title]{background-color:var(--page-bg);cursor:pointer;display:flex;transform:scale(0);transition:transform .1s}:is(.hotkeysHeader____hash_base64_5_>div[title])>svg{width:1.6em}.hotkeys____hash_base64_5_:hover div[title]{transform:scale(1)}.scrollbar____hash_base64_5_{--arrow-y:clamp(0.45em,calc(var(--slider-midpoint)),calc(var(--scroll-length) - 0.45em));border-left:max(6vw,1em) solid #0000;display:flex;flex-direction:column;height:98%;position:absolute;right:3px;top:1%;touch-action:none;-webkit-user-select:none;user-select:none;width:5px;z-index:9}.scrollbar____hash_base64_5_>div{align-items:center;display:flex;flex-direction:column;flex-grow:1;justify-content:center;pointer-events:none}.scrollbarPage____hash_base64_5_{background-color:var(--secondary);flex-grow:1;height:100%;transform:scaleY(1);transform-origin:bottom;transition:transform 1s;width:100%}.scrollbarPage____hash_base64_5_[data-type=loaded]{transform:scaleY(0)}.scrollbarPage____hash_base64_5_[data-type=wait]{opacity:.5}.scrollbarPage____hash_base64_5_[data-type=error]{background-color:#f005}.scrollbarPage____hash_base64_5_[data-null]{background-color:#fbc02d}.scrollbarPage____hash_base64_5_[data-translation-type]{background-color:initial;transform:scaleY(1);transform-origin:top}.scrollbarPage____hash_base64_5_[data-translation-type=wait]{background-color:#81c784}.scrollbarPage____hash_base64_5_[data-translation-type=show]{background-color:#4caf50}.scrollbarPage____hash_base64_5_[data-translation-type=error]{background-color:#f005}.scrollbarSlider____hash_base64_5_{background-color:#fff5;border-radius:1em;height:var(--slider-height);justify-content:center;opacity:1;position:absolute;transform:translateY(var(--slider-top));transition:transform .15s,opacity .15s;width:100%;z-index:1}.scrollbarPoper____hash_base64_5_{--poper-top:clamp(0%,calc(var(--slider-midpoint) - 50%),calc(var(--scroll-length) - 100%));background-color:#303030;border-radius:.3em;color:#fff;font-size:.8em;line-height:1.5em;min-height:1.5em;min-width:1em;padding:.2em .5em;position:absolute;right:2em;text-align:center;transform:translateY(var(--poper-top));white-space:pre;width:fit-content}.scrollbar____hash_base64_5_:before{background-color:initial;border:.4em solid #0000;border-left:.5em solid #303030;content:\\\"\\\";position:absolute;right:2em;transform:translate(140%,calc(var(--arrow-y) - 50%))}.scrollbarPoper____hash_base64_5_,.scrollbar____hash_base64_5_:before{opacity:0;transition:opacity .15s,transform .15s}:is(.scrollbar____hash_base64_5_:hover,.scrollbar____hash_base64_5_[data-force-show]) .scrollbarPoper____hash_base64_5_,:is(.scrollbar____hash_base64_5_:hover,.scrollbar____hash_base64_5_[data-force-show]) .scrollbarSlider____hash_base64_5_,:is(.scrollbar____hash_base64_5_:hover,.scrollbar____hash_base64_5_[data-force-show]):before{opacity:1}.scrollbar____hash_base64_5_[data-drag] .scrollbarPoper____hash_base64_5_,.scrollbar____hash_base64_5_[data-drag] .scrollbarSlider____hash_base64_5_,.scrollbar____hash_base64_5_[data-drag]:before{transition:opacity .15s}.scrollbar____hash_base64_5_[data-auto-hidden]:not([data-force-show]) .scrollbarSlider____hash_base64_5_{opacity:0}.scrollbar____hash_base64_5_[data-auto-hidden]:not([data-force-show]):hover .scrollbarSlider____hash_base64_5_{opacity:1}.scrollbar____hash_base64_5_[data-position=hidden]{display:none}.scrollbar____hash_base64_5_[data-position=top]{border-bottom:max(6vh,1em) solid #0000;top:1px}.scrollbar____hash_base64_5_[data-position=top]:before{border-bottom:.5em solid #303030;right:0;top:1.2em;transform:translate(var(--arrow-x),-120%)}.scrollbar____hash_base64_5_[data-position=top] .scrollbarPoper____hash_base64_5_{top:1.2em}.scrollbar____hash_base64_5_[data-position=bottom]{border-top:max(6vh,1em) solid #0000;bottom:1px;top:unset}.scrollbar____hash_base64_5_[data-position=bottom]:before{border-top:.5em solid #303030;bottom:1.2em;right:0;transform:translate(var(--arrow-x),120%)}.scrollbar____hash_base64_5_[data-position=bottom] .scrollbarPoper____hash_base64_5_{bottom:1.2em}.scrollbar____hash_base64_5_[data-position=bottom],.scrollbar____hash_base64_5_[data-position=top]{--arrow-x:calc(var(--arrow-y)*-1 + 50%);border-left:none;flex-direction:row-reverse;height:5px;right:1%;width:98%}:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]):before{border-left:.4em solid #0000}:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarSlider____hash_base64_5_{height:100%;transform:translateX(calc(var(--slider-top)*-1));width:var(--slider-height)}:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarPoper____hash_base64_5_{padding:.1em .3em;right:unset;transform:translateX(calc(var(--poper-top)*-1))}[data-dir=ltr]:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]){--arrow-x:calc(var(--arrow-y) - 50%);flex-direction:row}[data-dir=ltr]:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]):before{left:0;right:unset}[data-dir=ltr]:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarSlider____hash_base64_5_{transform:translateX(var(--top))}[data-dir=ltr]:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarPoper____hash_base64_5_{transform:translateX(var(--poper-top))}:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarPage____hash_base64_5_{transform:scaleX(1)}[data-type=loaded]:is(:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarPage____hash_base64_5_){transform:scaleX(0)}[data-translation-type]:is(:is(.scrollbar____hash_base64_5_[data-position=top],.scrollbar____hash_base64_5_[data-position=bottom]) .scrollbarPage____hash_base64_5_){transform:scaleX(1)}.scrollbar____hash_base64_5_[data-is-abreast-mode] .scrollbarPoper____hash_base64_5_{line-height:1.5em;text-orientation:upright;writing-mode:vertical-rl}.scrollbar____hash_base64_5_[data-is-abreast-mode][data-dir=ltr] .scrollbarPoper____hash_base64_5_{writing-mode:vertical-lr}.root____hash_base64_5_[data-scroll-mode] .scrollbar____hash_base64_5_:before,.root____hash_base64_5_[data-scroll-mode] :is(.scrollbarSlider____hash_base64_5_,.scrollbarPoper____hash_base64_5_){transition:opacity .15s}:is(.root____hash_base64_5_[data-mobile] .scrollbar____hash_base64_5_:hover) .scrollbarPoper____hash_base64_5_,:is(.root____hash_base64_5_[data-mobile] .scrollbar____hash_base64_5_:hover):before{opacity:0}.touchAreaRoot____hash_base64_5_{color:#fff;display:grid;font-size:3em;grid-template-columns:1fr min(30%,10em) 1fr;grid-template-rows:1fr min(20%,10em) 1fr;height:100%;letter-spacing:.5em;opacity:0;pointer-events:none;position:absolute;top:0;transition:opacity .4s;-webkit-user-select:none;user-select:none;width:100%}.touchAreaRoot____hash_base64_5_[data-show]{opacity:1}.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_{align-items:center;display:flex;justify-content:center;text-align:center}[data-area=PREV]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_),[data-area=prev]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_){background-color:#95e1d3e6}[data-area=MENU]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_),[data-area=menu]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_){background-color:#fce38ae6}[data-area=NEXT]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_),[data-area=next]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_){background-color:#f38181e6}[data-area=PREV]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_):after{content:var(--i18n-touch-area-prev)}[data-area=MENU]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_):after{content:var(--i18n-touch-area-menu)}[data-area=NEXT]:is(.touchAreaRoot____hash_base64_5_ .touchArea____hash_base64_5_):after{content:var(--i18n-touch-area-next)}.touchAreaRoot____hash_base64_5_[data-vert=true]{flex-direction:column!important}.touchAreaRoot____hash_base64_5_:not([data-turn-page]) .touchArea____hash_base64_5_[data-area=NEXT],.touchAreaRoot____hash_base64_5_:not([data-turn-page]) .touchArea____hash_base64_5_[data-area=PREV],.touchAreaRoot____hash_base64_5_:not([data-turn-page]) .touchArea____hash_base64_5_[data-area=next],.touchAreaRoot____hash_base64_5_:not([data-turn-page]) .touchArea____hash_base64_5_[data-area=prev]{visibility:hidden}.touchAreaRoot____hash_base64_5_[data-area=edge]{grid-template-columns:1fr min(30%,10em) 1fr}.root____hash_base64_5_[data-mobile] .touchAreaRoot____hash_base64_5_{flex-direction:column!important;letter-spacing:0}.root____hash_base64_5_[data-mobile] [data-area]:after{font-size:.8em}.root____hash_base64_5_{background-color:var(--bg);font-size:1em;height:100%;outline:0;overflow:hidden;position:relative;width:100%}.root____hash_base64_5_ a{color:var(--text-secondary)}.root____hash_base64_5_[data-mobile]{font-size:.8em}.hidden____hash_base64_5_{display:none!important}.invisible____hash_base64_5_{visibility:hidden!important}.beautifyScrollbar____hash_base64_5_{scrollbar-color:var(--scrollbar-slider) #0000;scrollbar-width:thin}.beautifyScrollbar____hash_base64_5_::-webkit-scrollbar{height:10px;width:5px}.beautifyScrollbar____hash_base64_5_::-webkit-scrollbar-track{background:#0000}.beautifyScrollbar____hash_base64_5_::-webkit-scrollbar-thumb{background:var(--scrollbar-slider)}img,p{margin:0}:where(div,div:focus,div:focus-within,div:focus-visible,button){border:none;outline:none}blockquote{border-left:.25em solid var(--text-secondary,#607d8b);color:var(--text-secondary);font-size:.9em;font-style:italic;line-height:1.2em;margin:.5em 0 0;overflow-wrap:anywhere;padding:0 0 0 1em;text-align:start;white-space:pre-wrap}svg{width:1em}\";\nvar modules_c21c94f2$1 = {\"img\":\"img____hash_base64_5_\",\"show\":\"show____hash_base64_5_\",\"mangaFlow\":\"mangaFlow____hash_base64_5_\",\"mangaBox\":\"mangaBox____hash_base64_5_\",\"root\":\"root____hash_base64_5_\",\"gridModeTip\":\"gridModeTip____hash_base64_5_\",\"endPage\":\"endPage____hash_base64_5_\",\"jello\":\"jello____hash_base64_5_\",\"tip\":\"tip____hash_base64_5_\",\"comments\":\"comments____hash_base64_5_\",\"toolbar\":\"toolbar____hash_base64_5_\",\"toolbarPanel\":\"toolbarPanel____hash_base64_5_\",\"toolbarBg\":\"toolbarBg____hash_base64_5_\",\"SettingPanelPopper\":\"SettingPanelPopper____hash_base64_5_\",\"SettingPanel\":\"SettingPanel____hash_base64_5_\",\"SettingBlock\":\"SettingBlock____hash_base64_5_\",\"SettingBlockBody\":\"SettingBlockBody____hash_base64_5_\",\"SettingBlockSubtitle\":\"SettingBlockSubtitle____hash_base64_5_\",\"SettingsItem\":\"SettingsItem____hash_base64_5_\",\"SettingsShowItem\":\"SettingsShowItem____hash_base64_5_\",\"SettingsItemName\":\"SettingsItemName____hash_base64_5_\",\"SettingsItemSwitch\":\"SettingsItemSwitch____hash_base64_5_\",\"SettingsItemSwitchRound\":\"SettingsItemSwitchRound____hash_base64_5_\",\"SettingsItemIconButton\":\"SettingsItemIconButton____hash_base64_5_\",\"SettingsItemSelect\":\"SettingsItemSelect____hash_base64_5_\",\"closeCover\":\"closeCover____hash_base64_5_\",\"SettingsShowItemBody\":\"SettingsShowItemBody____hash_base64_5_\",\"hotkeys\":\"hotkeys____hash_base64_5_\",\"hotkeysItem\":\"hotkeysItem____hash_base64_5_\",\"hotkeysHeader\":\"hotkeysHeader____hash_base64_5_\",\"scrollbar\":\"scrollbar____hash_base64_5_\",\"scrollbarPage\":\"scrollbarPage____hash_base64_5_\",\"scrollbarSlider\":\"scrollbarSlider____hash_base64_5_\",\"scrollbarPoper\":\"scrollbarPoper____hash_base64_5_\",\"touchAreaRoot\":\"touchAreaRoot____hash_base64_5_\",\"touchArea\":\"touchArea____hash_base64_5_\",\"hidden\":\"hidden____hash_base64_5_\",\"invisible\":\"invisible____hash_base64_5_\",\"beautifyScrollbar\":\"beautifyScrollbar____hash_base64_5_\"};\n\nconst touches = new Map();\nconst bound = helper.createMemoMap({\n  x: () => -store.rootSize.width * (store.option.zoom.ratio / 100 - 1),\n  y: () => -store.rootSize.height * (store.option.zoom.ratio / 100 - 1)\n});\nconst checkBound = state => {\n  state.option.zoom.offset.x = helper.clamp(bound().x, state.option.zoom.offset.x, 0);\n  state.option.zoom.offset.y = helper.clamp(bound().y, state.option.zoom.offset.y, 0);\n};\nconst zoom = (val, focal, animation = false) => {\n  const newScale = helper.clamp(100, val, 300);\n  if (newScale === store.option.zoom.ratio) return;\n\n  // 消除放大导致的偏移\n  const {\n    left,\n    top\n  } = refs.mangaBox.getBoundingClientRect();\n  const x = (focal?.x ?? store.rootSize.width / 2) - left;\n  const y = (focal?.y ?? store.rootSize.height / 2) - top;\n\n  // 当前直接放大后的基准点坐标\n  const newX = x / (store.option.zoom.ratio / 100) * (newScale / 100);\n  const newY = y / (store.option.zoom.ratio / 100) * (newScale / 100);\n\n  // 放大后基准点的偏移距离\n  const dx = newX - x;\n  const dy = newY - y;\n  setOption((draftOption, state) => {\n    draftOption.zoom.ratio = newScale;\n    draftOption.zoom.offset.x -= dx;\n    draftOption.zoom.offset.y -= dy;\n    checkBound(state);\n    if (animation) state.page.anima = 'zoom';\n  });\n};\n\n//\n// 惯性滑动\n//\n\n/** 摩擦系数 */\nconst FRICTION_COEFF$1 = 0.91;\nconst mouse = {\n  x: 0,\n  y: 0\n};\nconst last = {\n  x: 0,\n  y: 0\n};\nconst velocity = {\n  x: 0,\n  y: 0\n};\nlet animationId$2 = null;\nconst cancelAnimation = () => {\n  if (!animationId$2) return;\n  cancelAnimationFrame(animationId$2);\n  animationId$2 = null;\n};\nlet lastTime$1 = 0;\n\n/** 逐帧计算惯性滑动 */\nconst handleSlideAnima = timestamp => {\n  // 当速率足够小时停止计算动画\n  if (helper.approx(velocity.x, 0, 1) && helper.approx(velocity.y, 0, 1)) {\n    animationId$2 = null;\n    return;\n  }\n\n  // 在拖拽后模拟惯性滑动\n  setOption((draftOption, state) => {\n    draftOption.zoom.offset.x += velocity.x;\n    draftOption.zoom.offset.y += velocity.y;\n    checkBound(state);\n\n    // 确保每16毫秒才减少一次速率，防止在高刷新率显示器上衰减过快\n    if (timestamp - lastTime$1 > 16) {\n      velocity.x *= FRICTION_COEFF$1;\n      velocity.y *= FRICTION_COEFF$1;\n      lastTime$1 = timestamp;\n    }\n  });\n  animationId$2 = requestAnimationFrame(handleSlideAnima);\n};\n\n/** 逐帧根据鼠标坐标移动元素，并计算速率 */\nconst handleDragAnima$1 = () => {\n  // 当停着不动时退出循环\n  if (mouse.x === store.option.zoom.offset.x && mouse.y === store.option.zoom.offset.y) {\n    animationId$2 = null;\n    return;\n  }\n  setOption((draftOption, state) => {\n    last.x = draftOption.zoom.offset.x;\n    last.y = draftOption.zoom.offset.y;\n    draftOption.zoom.offset.x = mouse.x;\n    draftOption.zoom.offset.y = mouse.y;\n    checkBound(state);\n    velocity.x = draftOption.zoom.offset.x - last.x;\n    velocity.y = draftOption.zoom.offset.y - last.y;\n  });\n  animationId$2 = requestAnimationFrame(handleDragAnima$1);\n};\n\n/** 一段时间没有移动后应该将速率归零 */\nconst resetVelocity = helper.debounce(() => {\n  velocity.x = 0;\n  velocity.y = 0;\n}, 200);\n\n/** 是否正在双指捏合缩放中 */\nlet pinchZoom = false;\n\n/** 处理放大后的拖拽移动 */\nconst handleZoomDrag = ({\n  type,\n  xy: [x, y],\n  last: [lx, ly]\n}) => {\n  if (store.option.zoom.ratio === 100) return;\n  switch (type) {\n    case 'down':\n      {\n        mouse.x = store.option.zoom.offset.x;\n        mouse.y = store.option.zoom.offset.y;\n        if (animationId$2) cancelAnimation();\n        break;\n      }\n    case 'move':\n      {\n        if (animationId$2) cancelAnimation();\n        mouse.x += x - lx;\n        mouse.y += y - ly;\n        if (animationId$2 === null) animationId$2 = requestAnimationFrame(handleDragAnima$1);\n        resetVelocity();\n        break;\n      }\n    case 'up':\n      {\n        resetVelocity.clear();\n\n        // 当双指捏合结束，一个手指抬起时，将剩余的指针当作刚点击来处理\n        if (pinchZoom) {\n          pinchZoom = false;\n          mouse.x = store.option.zoom.offset.x;\n          mouse.y = store.option.zoom.offset.y;\n          return;\n        }\n        if (animationId$2) cancelAnimationFrame(animationId$2);\n        animationId$2 = requestAnimationFrame(handleSlideAnima);\n      }\n  }\n};\n\n//\n// 双指捏合缩放\n//\n\n/** 初始双指距离 */\nlet initDistance = 0;\n/** 初始缩放比例 */\nlet initScale = 100;\n\n/** 获取两个指针之间的距离 */\nconst getDistance = (a, b) => Math.hypot(b.xy[0] - a.xy[0], b.xy[1] - a.xy[1]);\n\n/** 逐帧计算当前屏幕上两点之间的距离，并换算成缩放比例 */\nconst handlePinchZoomAnima = () => {\n  if (touches.size < 2) {\n    animationId$2 = null;\n    return;\n  }\n  const [a, b] = [...touches.values()];\n  const distance = getDistance(a, b);\n  zoom(distance / initDistance * initScale, {\n    x: (a.xy[0] + b.xy[0]) / 2,\n    y: (a.xy[1] + b.xy[1]) / 2\n  });\n  animationId$2 = requestAnimationFrame(handlePinchZoomAnima);\n};\n\n/** 处理双指捏合缩放 */\nconst handlePinchZoom = ({\n  type\n}) => {\n  if (touches.size < 2) return;\n  switch (type) {\n    case 'down':\n      {\n        pinchZoom = true;\n        const [a, b] = [...touches.values()];\n        initDistance = getDistance(a, b);\n        initScale = store.option.zoom.ratio;\n        break;\n      }\n    case 'up':\n      {\n        const [a, b] = [...touches.values()];\n        initDistance = getDistance(a, b);\n        break;\n      }\n    case 'move':\n      {\n        if (animationId$2 === null) animationId$2 = requestAnimationFrame(handlePinchZoomAnima);\n        break;\n      }\n    case 'cancel':\n      {\n        const [a, b] = [...touches.values()];\n        initDistance = getDistance(a, b);\n        break;\n      }\n  }\n};\n\n/** 并排卷轴模式下的全局滚动填充 */\nconst [abreastScrollFill, _setAbreastScrollFill] = solidJs.createSignal(0);\n/** 并排卷轴模式下的每列布局 */\nconst abreastArea = helper.createRootMemo(prev => {\n  if (!isAbreastMode()) return prev;\n  const columns = [[]];\n  const position = {};\n  let length = 0;\n  const rootHeight = store.rootSize.height;\n  if (!rootHeight || store.imgList.length === 0) return {\n    columns,\n    position,\n    length\n  };\n  const repeatHeight = rootHeight * store.option.scrollMode.abreastDuplicate;\n\n  /** 当前图片在当前列的所在高度 */\n  let top = abreastScrollFill();\n  while (top > rootHeight) {\n    top -= rootHeight - repeatHeight;\n    columns.push([]);\n  }\n  for (let i = 0; i < store.imgList.length; i++) {\n    const img = getImg(i);\n    const imgPosition = [];\n    const imgHeight = img.size.height;\n    length += imgHeight;\n    let height = imgHeight;\n    while (height > 0) {\n      columns.at(-1).push(i);\n      imgPosition.push({\n        column: columns.length - 1,\n        top\n      });\n      if (top < 0 && imgPosition.length > 1) top = 0;\n      const availableHeight = rootHeight - top;\n      top += height;\n      height -= availableHeight;\n\n      // 填满一列后换行\n      if (top < rootHeight) continue;\n      columns.push([]);\n      top = height - imgHeight;\n\n      // 复现上列结尾\n      if (!repeatHeight || columns.length === 1) continue;\n      top += repeatHeight;\n      height = Math.min(imgHeight, height + repeatHeight);\n\n      /** 为了复现而出现的空白部分高度 */\n      let emptyTop = top;\n      let prevImgIndex = i;\n      while (prevImgIndex >= 1 && emptyTop > 0) {\n        prevImgIndex -= 1;\n        // 把上一张图片加进来填补空白\n        columns.at(-1).push(prevImgIndex);\n        const prevImgHeight = getImg(prevImgIndex).size.height;\n        emptyTop -= prevImgHeight;\n        position[prevImgIndex].push({\n          column: columns.length - 1,\n          top: emptyTop\n        });\n      }\n    }\n    position[i] = imgPosition;\n  }\n  return {\n    columns,\n    position,\n    length\n  };\n}, {\n  columns: [],\n  position: {},\n  length: 0\n});\n\n/** 头尾滚动的限制值 */\nconst scrollFillLimit = helper.createRootMemo(() => abreastArea().length - store.rootSize.height);\nconst setAbreastScrollFill = val => _setAbreastScrollFill(helper.clamp(-scrollFillLimit(), val, scrollFillLimit()));\n\n/** 并排卷轴模式下当前要显示的列 */\nconst abreastShowColumn = helper.createThrottleMemo(() => {\n  if (!isAbreastMode() || abreastArea().columns.length === 0) return {\n    start: 0,\n    end: 0\n  };\n  const columnWidth = abreastColumnWidth() + store.option.scrollMode.spacing * 7;\n  return {\n    start: helper.clamp(0, Math.floor(store.page.offset.x.px / columnWidth), abreastArea().columns.length - 1),\n    end: helper.clamp(0, Math.floor((store.page.offset.x.px + store.rootSize.width) / columnWidth), abreastArea().columns.length - 1)\n  };\n});\n\n/** 并排卷轴模式下的漫画流宽度 */\nconst abreastContentWidth = helper.createRootMemo(() => abreastArea().columns.length * abreastColumnWidth() + (abreastArea().columns.length - 1) * store.option.scrollMode.spacing * 7);\n\n/** 并排卷轴模式下的最大滚动距离 */\nconst abreastScrollWidth = helper.createRootMemo(() => abreastContentWidth() - store.rootSize.width);\n\n/** 并排卷轴模式下每个图片所在位置的样式 */\nconst imgAreaStyle = helper.createRootMemo(() => {\n  if (!isAbreastMode() || store.gridMode) return '';\n  let styleText = '';\n  for (const index of store.imgList.keys()) {\n    let imgNum = 0;\n    for (const {\n      column,\n      top\n    } of abreastArea().position[index] ?? []) {\n      const itemStyle = `grid-area: _${column} !important; transform: translateY(${top}px);`;\n      styleText += `#_${index}_${imgNum} { ${itemStyle} }\\n`;\n      imgNum += 1;\n    }\n  }\n  return styleText;\n});\n\n/** 滚动内容的长度 */\nconst scrollLength = helper.createRootMemo(() => {\n  if (isScrollMode()) return contentHeight();\n  if (isAbreastMode()) return abreastContentWidth();\n  return store.pageList.length;\n});\n\n/** 滚动内容的滚动进度 */\nconst scrollProgress = helper.createRootMemo(() => {\n  if (isScrollMode()) return scrollTop();\n  if (isAbreastMode()) return store.page.offset.x.px;\n  return store.activePageIndex;\n});\n\n/** 滚动内容的滚动进度百分比 */\nconst scrollPercentage = helper.createRootMemo(() => scrollProgress() / scrollLength());\n\n/** 滚动条滑块长度 */\nconst sliderHeight = helper.createRootMemo(() => {\n  let itemLength = 1;\n  if (isScrollMode()) itemLength = store.rootSize.height;\n  if (isAbreastMode()) itemLength = store.rootSize.width;\n  return itemLength / scrollLength();\n});\n\n/** 当前是否已经滚动到底部 */\nconst isBottom = helper.createRootMemo(() => scrollPercentage() + sliderHeight() >= 0.9999);\n\n/** 当前是否已经滚动到顶部 */\nconst isTop = helper.createRootMemo(() => scrollPercentage() === 0);\n\n/** 在卷轴模式下滚动到指定进度 */\nconst scrollTo = (x, smooth = false) => {\n  if (!store.option.scrollMode.enabled) return;\n  if (store.option.scrollMode.abreastMode) {\n    refs.mangaBox.scrollTo({\n      top: 0,\n      behavior: 'instant'\n    });\n    const val = helper.clamp(0, x, abreastScrollWidth());\n    return _setState('page', 'offset', 'x', 'px', val);\n  }\n  refs.mangaBox.scrollTo({\n    top: x,\n    behavior: smooth ? 'smooth' : 'instant'\n  });\n};\n\n/** 保存当前滚动进度，并在之后恢复 */\nconst saveScrollProgress = () => {\n  const oldScrollPercentage = scrollPercentage();\n  return () => scrollTo(oldScrollPercentage * scrollLength());\n};\n\n/** 在卷轴模式下，滚动到能显示指定图片的位置 */\nconst scrollViewImg = i => {\n  if (!store.option.scrollMode.enabled) return;\n  if (store.option.scrollMode.abreastMode) {\n    const columnNum = abreastArea().columns.findIndex(column => column.includes(i));\n    scrollTo(columnNum * abreastColumnWidth());\n  } else scrollTo(imgTopList()[i]);\n};\n\n/** 在卷轴模式下进行缩放，并且保持滚动进度不变 */\nconst zoomScrollModeImg = (zoomLevel, set = false) => {\n  const jump = saveScrollProgress();\n  setOption(draftOption => {\n    const newVal = set ? zoomLevel : store.option.scrollMode.imgScale + zoomLevel;\n    draftOption.scrollMode.imgScale = helper.clamp(0.1, Number(newVal.toFixed(2)), 3);\n  });\n  jump();\n\n  // 并排卷轴模式下并没有一个明确直观的滚动进度，\n  // 也想不出有什么实现效果能和普通卷轴模式的效果一致,\n  // 所以就摆烂不管了，反正现在这样也已经能避免乱跳了\n};\n\n/** 切换页面填充 */\nconst switchFillEffect = () => {\n  setState(state => {\n    // 如果当前页不是双页显示的就跳过，避免在显示跨页图的页面切换却没看到效果的疑惑\n    if (state.pageList[state.activePageIndex].length !== 2) return;\n    state.fillEffect[nowFillIndex()] = Number(!state.fillEffect[nowFillIndex()]);\n    updatePageData(state);\n  });\n};\n\n/** 切换卷轴模式 */\nconst switchScrollMode = () => {\n  zoom(100);\n  setOption((draftOption, state) => {\n    draftOption.scrollMode.enabled = !draftOption.scrollMode.enabled;\n    state.page.offset.x.px = 0;\n    state.page.offset.y.px = 0;\n  });\n  // 切换到卷轴模式后自动定位到对应页\n  scrollViewImg(store.activePageIndex);\n};\n\n/** 切换单双页模式 */\nconst switchOnePageMode = () => {\n  setOption((draftOption, state) => {\n    const newPageNum = pageNum() === 1 ? 2 : 1;\n    draftOption.pageNum = state.option.autoSwitchPageMode && newPageNum === autoPageNum() ? 0 : newPageNum;\n  });\n};\n\n/** 切换阅读方向 */\nconst switchDir = () => {\n  setOption(draftOption => {\n    draftOption.dir = draftOption.dir === 'rtl' ? 'ltr' : 'rtl';\n  });\n};\n\n/** 切换网格模式 */\nconst switchGridMode = () => {\n  zoom(100);\n  setState(state => {\n    state.gridMode = !state.gridMode;\n    if (store.option.zoom.ratio !== 100) zoom(100);\n    state.page.anima = '';\n  });\n  // 切换到网格模式后自动定位到当前页\n  if (store.gridMode) requestAnimationFrame(() => {\n    refs.mangaFlow.children[activeImgIndex()]?.scrollIntoView({\n      block: 'center',\n      inline: 'center'\n    });\n  });\n};\n\n/** 切换卷轴模式下图片适应宽度 */\nconst switchFitToWidth = () => {\n  const jump = saveScrollProgress();\n  setOption(draftOption => {\n    draftOption.scrollMode.fitToWidth = !draftOption.scrollMode.fitToWidth;\n  });\n  jump();\n};\n\nlet clickTimeout = null;\nconst useDoubleClick = (click, doubleClick, timeout = 200) => {\n  return event => {\n    // 如果点击触发时还有上次计时器的记录，说明这次是双击\n    if (clickTimeout) {\n      clearTimeout(clickTimeout);\n      clickTimeout = null;\n      doubleClick?.(event);\n      return;\n    }\n\n    // 单击事件延迟触发\n    clickTimeout = window.setTimeout(() => {\n      click(event);\n      clickTimeout = null;\n    }, timeout);\n  };\n};\n\n/** 找到普通卷轴模式下指定高度上的图片 */\nconst findTopImg = (top, initIndex = 0) => {\n  if (top > contentHeight()) return imgTopList().length - 1;\n  let i = initIndex;\n  for (; i < imgTopList().length; i++) if (imgTopList()[i] > top) return i === 0 ? 0 : i - 1;\n  return imgTopList().length - 1;\n};\n\n/** 获取并排卷轴模式下指定列的指定图片 */\nconst getAbreastColumnImg = (column, img) => {\n  const {\n    columns\n  } = abreastArea();\n  return columns[helper.clamp(0, column, columns.length - 1)]?.at(img) ?? 0;\n};\n\n/** 计算显示页面 */\nconst updateShowRange = state => {\n  if (scrollLength() === 0) {\n    state.showRange = [0, 0];\n    state.renderRange = state.showRange;\n  } else if (!state.option.scrollMode.enabled) {\n    // 翻页模式\n    state.showRange = [state.activePageIndex, state.activePageIndex];\n    state.renderRange = [helper.clamp(0, state.activePageIndex - 1, state.pageList.length - 1), helper.clamp(0, state.activePageIndex + 1, state.pageList.length - 1)];\n  } else if (state.option.scrollMode.abreastMode) {\n    // 并排卷轴模式\n    const {\n      start,\n      end\n    } = abreastShowColumn();\n    state.showRange = [getAbreastColumnImg(start, 0), getAbreastColumnImg(end, -1)];\n    state.renderRange = [getAbreastColumnImg(start - 2, 0), getAbreastColumnImg(end + 2, -1)];\n  } else {\n    // 普通卷轴模式\n    const top = scrollTop();\n    const bottom = scrollTop() + state.rootSize.height;\n    const renderTop = top - state.rootSize.height;\n    const rednerBottom = bottom + state.rootSize.height;\n    const renderTopImg = findTopImg(renderTop);\n    const topImg = findTopImg(top, renderTopImg);\n    const bottomImg = findTopImg(bottom, topImg);\n    const renderBottomImg = findTopImg(rednerBottom, bottomImg);\n    state.showRange = [topImg, bottomImg];\n    state.renderRange = [renderTopImg, renderBottomImg];\n  }\n};\nhelper.createEffectOn([scrollLength, () => store.gridMode, () => store.option.scrollMode.enabled, () => store.activePageIndex, () => store.option.scrollMode.abreastMode, () => store.rootSize, abreastShowColumn, scrollTop], helper.throttle(() => setState(updateShowRange))\n// 两种卷轴模式下都可以通过在每次滚动后记录\n// 当前 `显示的第一张图片的 bottom` 和 `最后一张图片的 top` 作为忽略范围，\n// 在每次滚动后检查是否超出了这个范围，没超出就说明本次滚动不会显示或消失任何图片\n// 以此进行性能优化\n// 不过两个卷轴模式都要这么处理挺麻烦的，姑且先用 throttle 顶上，后面有需要再优化\n);\n\n/** 获取指定范围内页面所包含的图片 */\nconst getRangeImgList = range => {\n  if (range[0] === range[1]) return new Set(store.pageList[range[0]]);\n  const list = new Set();\n  for (const [a, b] of store.pageList.slice(range[0], range[1] + 1)) {\n    list.add(a);\n    if (b !== undefined) list.add(b);\n  }\n  list.delete(-1);\n  return list;\n};\nconst renderImgList = helper.createRootMemo(() => getRangeImgList(store.renderRange));\nconst showImgList = helper.createRootMemo(() => getRangeImgList(store.showRange));\n\n/**\n * 图片显示状态\n *\n * 0 - 页面中的第一张图片\n * 1 - 页面中的最后一张图片\n * '' - 页面中的唯一一张图片\n */\nconst imgShowState = helper.createRootMemo(() => {\n  if (store.pageList.length === 0) return new Map();\n  const showRange = store.gridMode ? [0, store.pageList.length - 1] : store.renderRange;\n  const stateList = new Map();\n  for (let i = showRange[0]; i <= showRange[1]; i++) {\n    const page = store.pageList[i];\n    if (!page) continue;\n    const [a, b] = page;\n    if (b === undefined) {\n      stateList.set(a, '');\n    } else {\n      stateList.set(a, 0);\n      stateList.set(b, 1);\n    }\n  }\n  return stateList;\n});\n\n// 卷轴模式下，将当前显示的第一页作为当前页\nhelper.createEffectOn(() => store.showRange, ([firstPage]) => {\n  if (!store.gridMode && store.option.scrollMode.enabled) _setState('activePageIndex', firstPage ?? 0);\n});\n\n/** 将页面移回原位 */\nconst resetPage = (state, animation = false) => {\n  updateShowRange(state);\n  state.page.offset.x.pct = 0;\n  state.page.offset.y.pct = 0;\n  if (state.option.scrollMode.enabled) {\n    state.page.anima = '';\n    return;\n  }\n  let i = -1;\n  if (helper.inRange(state.renderRange[0], state.activePageIndex, state.renderRange[1])) i = state.activePageIndex - state.renderRange[0];\n  if (store.page.vertical) state.page.offset.y.pct = i === -1 ? 0 : -i;else state.page.offset.x.pct = i === -1 ? 0 : i;\n  state.page.anima = animation ? 'page' : '';\n};\n\n/** 获取指定图片的提示文本 */\nconst getImgTip = i => {\n  if (i === -1) return helper.t('other.fill_page');\n  const img = getImg(i);\n\n  // 如果图片未加载完毕则在其 index 后增加显示当前加载状态\n  if (img.loadType !== 'loaded') return `${i + 1} (${helper.t(`img_status.${img.loadType}`)})`;\n  if (img.translationType && img.translationType !== 'hide' && img.translationMessage) return `${i + 1}：${img.translationMessage}`;\n  return `${i + 1}`;\n};\n\n/** 获取指定页面的提示文本 */\nconst getPageTip = pageIndex => {\n  const page = store.pageList[pageIndex];\n  if (!page) return 'null';\n  const pageIndexText = page.map(index => getImgTip(index));\n  if (pageIndexText.length === 1) return pageIndexText[0];\n  if (store.option.dir === 'rtl') pageIndexText.reverse();\n  return pageIndexText.join(store.option.scrollMode.enabled ? '\\n' : ' | ');\n};\nhelper.createEffectOn(() => store.activePageIndex, () => store.show.endPage && _setState('show', 'endPage', undefined), {\n  defer: true\n});\nhelper.createEffectOn(activePage, helper.throttle(() => store.isDragMode || setState(resetPage)));\n\n// 在关闭工具栏的同时关掉滚动条的强制显示\nhelper.createEffectOn(() => store.show.toolbar, () => store.show.scrollbar && !store.show.toolbar && _setState('show', 'scrollbar', false), {\n  defer: true\n});\n\n// 在切换网格模式后关掉 滚动条和工具栏 的强制显示\nhelper.createEffectOn(() => store.gridMode, () => setState(resetUI), {\n  defer: true\n});\n\nconst closeScrollLock = helper.debounce(() => _setState('scrollLock', false), 100);\n\n/** 翻页。返回是否成功改变了当前页数 */\nconst turnPageFn = (state, dir) => {\n  if (state.gridMode) return false;\n  if (dir === 'prev') {\n    switch (state.show.endPage) {\n      case 'start':\n        if (!state.scrollLock && state.option.jumpToNext) state.prop.Prev?.();\n        return false;\n      case 'end':\n        state.show.endPage = undefined;\n        return false;\n      default:\n        // 弹出卷首结束页\n        if (isTop()) {\n          if (!state.prop.Exit) return false;\n          // 没有 onPrev 时不弹出\n          if (!state.prop.Prev || !state.option.jumpToNext) return false;\n          state.show.endPage = 'start';\n          state.scrollLock = true;\n          closeScrollLock();\n          return false;\n        }\n        if (state.option.scrollMode.enabled) return false;\n        state.activePageIndex -= 1;\n        return true;\n    }\n  } else {\n    switch (state.show.endPage) {\n      case 'end':\n        if (state.scrollLock) return false;\n        if (state.prop.Next && state.option.jumpToNext) {\n          state.prop.Next();\n          return false;\n        }\n        state.prop.Exit?.(true);\n        return false;\n      case 'start':\n        state.show.endPage = undefined;\n        return false;\n      default:\n        // 弹出卷尾结束页\n        if (isBottom()) {\n          if (!state.prop.Exit) return false;\n          state.show.endPage = 'end';\n          state.scrollLock = true;\n          closeScrollLock();\n          return false;\n        }\n        if (state.option.scrollMode.enabled) return false;\n        state.activePageIndex += 1;\n        return true;\n    }\n  }\n};\nconst turnPage = dir => setState(state => turnPageFn(state, dir));\nconst turnPageAnimation = dir => {\n  setState(state => {\n    // 无法翻页就恢复原位\n    if (!turnPageFn(state, dir)) {\n      state.page.offset.x.px = 0;\n      state.page.offset.y.px = 0;\n      resetPage(state, true);\n      state.isDragMode = false;\n      return;\n    }\n    state.isDragMode = true;\n    resetPage(state);\n    if (store.page.vertical) state.page.offset.y.pct += dir === 'next' ? 1 : -1;else state.page.offset.x.pct += dir === 'next' ? -1 : 1;\n    setTimeout(() => {\n      setState(draftState => {\n        resetPage(draftState, true);\n        draftState.page.offset.x.px = 0;\n        draftState.page.offset.y.px = 0;\n        draftState.isDragMode = false;\n      });\n    }, 16);\n  });\n};\n\n/** 根据坐标判断点击的元素 */\nconst findClickEle = (eleList, {\n  x,\n  y\n}) => [...eleList].find(e => {\n  const rect = e.getBoundingClientRect();\n  return x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;\n});\n\n/** 触发点击区域操作 */\nconst handlePageClick = e => {\n  const targetArea = findClickEle(refs.touchArea.children, e);\n  if (!targetArea) return;\n  const areaName = targetArea.dataset.area;\n  if (!areaName) return;\n  if (areaName === 'menu' || areaName === 'MENU') return setState(state => {\n    state.show.scrollbar = !state.show.scrollbar;\n    state.show.toolbar = !state.show.toolbar;\n  });\n  if (!store.option.clickPageTurn.enabled || store.option.zoom.ratio !== 100) return;\n  setState(state => {\n    resetUI(state);\n    turnPageFn(state, areaName.toLowerCase());\n  });\n};\n\n/** 网格模式下点击图片跳到对应页 */\nconst handleGridClick = e => {\n  const target = findClickEle(refs.root.getElementsByClassName(modules_c21c94f2$1.img), e);\n  if (!target) return;\n  const pageNum = imgPageMap()[Number(/_(\\d+)_/.exec(target.id)?.[1])];\n  if (pageNum === undefined) return;\n  setState(state => {\n    state.activePageIndex = pageNum;\n    state.gridMode = false;\n  });\n  scrollViewImg(pageNum);\n};\n\n/** 双击放大 */\nconst doubleClickZoom = e => !store.gridMode && zoom(store.option.zoom.ratio === 100 ? 350 : 100, e, true);\nconst handleClick = useDoubleClick(e => store.gridMode ? handleGridClick(e) : handlePageClick(e), doubleClickZoom);\n\n/** 判断翻页方向 */\nconst getTurnPageDir = startTime => {\n  let dir;\n  let move;\n  let total;\n  if (store.page.vertical) {\n    move = -store.page.offset.y.px;\n    total = refs.root.clientHeight;\n  } else {\n    move = store.page.offset.x.px;\n    total = refs.root.clientWidth;\n  }\n\n  // 处理无关速度不考虑时间单纯根据当前滚动距离来判断的情况\n  if (!startTime) {\n    if (Math.abs(move) > total / 2) dir = move > 0 ? 'next' : 'prev';\n    return dir;\n  }\n\n  // 滑动距离超过总长度三分之一判定翻页\n  if (Math.abs(move) > total / 3) dir = move > 0 ? 'next' : 'prev';\n  if (dir) return dir;\n\n  // 滑动速度超过 0.4 判定翻页\n  const velocity = move / (performance.now() - startTime);\n  if (velocity < -0.4) dir = 'prev';\n  if (velocity > 0.4) dir = 'next';\n  return dir;\n};\nlet dx$1 = 0;\nlet dy$1 = 0;\nlet animationId$1 = null;\nconst handleDragAnima = () => {\n  // 当停着不动时退出循环\n  if (dx$1 === store.page.offset.x.px && dy$1 === store.page.offset.y.px) {\n    animationId$1 = null;\n    return;\n  }\n  setState(state => {\n    if (state.page.vertical) state.page.offset.y.px = dy$1;else state.page.offset.x.px = dx$1;\n  });\n  animationId$1 = requestAnimationFrame(handleDragAnima);\n};\nconst handleDragEnd = startTime => {\n  dx$1 = 0;\n  dy$1 = 0;\n  if (animationId$1) {\n    cancelAnimationFrame(animationId$1);\n    animationId$1 = null;\n  }\n\n  // 将拖动的页面移回正常位置\n  const dir = getTurnPageDir(startTime);\n  if (dir) return turnPageAnimation(dir);\n  setState(state => {\n    state.page.offset.x.px = 0;\n    state.page.offset.y.px = 0;\n    state.page.anima = 'page';\n    state.isDragMode = false;\n  });\n};\nhandleDragEnd.debounce = helper.debounce(handleDragEnd, 200);\nconst handleMangaFlowDrag = ({\n  type,\n  xy: [x, y],\n  initial: [ix, iy],\n  startTime\n}) => {\n  switch (type) {\n    case 'move':\n      {\n        dx$1 = store.option.dir === 'rtl' ? x - ix : ix - x;\n        dy$1 = y - iy;\n        if (store.isDragMode) {\n          animationId$1 ||= requestAnimationFrame(handleDragAnima);\n          return;\n        }\n\n        // 判断滑动方向\n        let slideDir;\n        const dxAbs = Math.abs(dx$1);\n        const dyAbs = Math.abs(dy$1);\n        if (dxAbs > 5 && dyAbs < 5) slideDir = 'horizontal';\n        if (dyAbs > 5 && dxAbs < 5) slideDir = 'vertical';\n        if (!slideDir) return;\n        setState(state => {\n          // 根据滑动方向自动切换排列模式\n          state.page.vertical = slideDir === 'vertical';\n          state.isDragMode = true;\n          resetPage(state);\n        });\n        return;\n      }\n    case 'up':\n      return handleDragEnd(startTime);\n  }\n};\nlet lastDeltaY$1 = 0;\nlet retardStartTime = 0;\nlet lastWheel = 0;\nconst handleTrackpadWheel = e => {\n  let deltaY = Math.floor(-e.deltaY);\n  let absDeltaY = Math.abs(deltaY);\n  if (absDeltaY < 2) return;\n  let time = 0;\n  let now = 0;\n  // 为了避免被触摸板的滚动惯性触发，限定一下滚动距离\n  if (absDeltaY > 50) {\n    now = performance.now();\n    time = now - lastWheel;\n    lastWheel = now;\n  }\n  if (store.option.scrollMode.enabled) {\n    if (time > 200 && (isTop() && e.deltaY < 0 || isBottom() && e.deltaY > 0)) turnPage(e.deltaY > 0 ? 'next' : 'prev');\n    return;\n  }\n\n  // 加速度小于指定值后逐渐缩小滚动距离，实现减速效果\n  if (Math.abs(absDeltaY - lastDeltaY$1) <= 6) {\n    retardStartTime ||= Date.now();\n    deltaY *= 1 - Math.min(1, (Date.now() - retardStartTime) / 10 * 0.002);\n    absDeltaY = Math.abs(deltaY);\n    if (absDeltaY < 2) return;\n  } else retardStartTime = 0;\n  lastDeltaY$1 = absDeltaY;\n  dy$1 += deltaY;\n  setState(state => {\n    // 滚动至漫画头尾尽头时\n    if (isTop() && dy$1 > 0 || isBottom() && dy$1 < 0) {\n      if (time > 200) turnPageFn(state, dy$1 < 0 ? 'next' : 'prev');\n      dy$1 = 0;\n    }\n\n    // 滚动过一页时\n    if (dy$1 <= -state.rootSize.height) {\n      if (turnPageFn(state, 'next')) dy$1 += state.rootSize.height;\n    } else if (dy$1 >= state.rootSize.height && turnPageFn(state, 'prev')) dy$1 -= state.rootSize.height;\n    state.page.vertical = true;\n    state.isDragMode = true;\n    resetPage(state);\n  });\n  animationId$1 ||= requestAnimationFrame(handleDragAnima);\n  handleDragEnd.debounce();\n};\n\nconst setMessage = (url, msg) => _setState('imgMap', url, 'translationMessage', msg);\nconst download = async imgUrl => {\n  const url = store.imgMap[imgUrl]?.blobUrl ?? imgUrl;\n  if (url.startsWith('blob:')) {\n    const res = await fetch(url);\n    return res.blob();\n  }\n  const res = await request.request(url, {\n    fetch: false,\n    responseType: 'blob',\n    errorText: helper.t('translation.tip.download_img_failed')\n  });\n  return res.response;\n};\nconst createFormData = (imgBlob, type) => {\n  const file = new File([imgBlob], `image.${imgBlob.type.split('/').at(-1)}`, {\n    type: imgBlob.type\n  });\n  const {\n    size,\n    detector,\n    direction,\n    translator,\n    targetLanguage\n  } = store.option.translation.options;\n  const formData = new FormData();\n  formData.append('file', file);\n  formData.append('mime', file.type);\n  formData.append('size', size);\n  formData.append('detector', detector);\n  formData.append('direction', direction);\n  formData.append('translator', translator);\n  if (type === 'cotrans') formData.append('target_language', targetLanguage);else formData.append('target_lang', targetLanguage);\n  formData.append('retry', `${store.option.translation.forceRetry}`);\n  return formData;\n};\n\n/** 将站点列表转为选择器中的选项 */\nconst createOptions = list => list.map(name => [name, helper.t(`translation.translator.${name}`) || name]);\n\nconst apiUrl = () => store.option.translation.localUrl || 'http://127.0.0.1:5003';\n\n/** 使用自部署服务器翻译指定图片 */\nconst selfhostedTranslation = async url => {\n  await request.request(`${apiUrl()}`, {\n    method: 'HEAD',\n    errorText: helper.t('alert.server_connect_failed')\n  });\n  setMessage(url, helper.t('translation.tip.img_downloading'));\n  let imgBlob;\n  try {\n    imgBlob = await download(url);\n  } catch (error) {\n    helper.log.error(error);\n    throw new Error(helper.t('translation.tip.download_img_failed'));\n  }\n  setMessage(url, helper.t('translation.tip.upload'));\n  let task_id;\n  // 上传图片取得任务 id\n  try {\n    const res = await request.request(`${apiUrl()}/submit`, {\n      method: 'POST',\n      responseType: 'json',\n      data: createFormData(imgBlob, 'selfhosted')\n    });\n    task_id = res.response.task_id;\n  } catch (error) {\n    helper.log.error(error);\n    throw new Error(helper.t('translation.tip.upload_error'));\n  }\n  let errorNum = 0;\n  let taskState;\n  // 等待翻译完成\n  while (!taskState?.finished) {\n    try {\n      await helper.sleep(200);\n      const res = await request.request(`${apiUrl()}/task-state?taskid=${task_id}`, {\n        responseType: 'json'\n      });\n      taskState = res.response;\n      setMessage(url, `${helper.t(`translation.status.${taskState.state}`) || taskState.state}`);\n    } catch (error) {\n      helper.log.error(error);\n      if (errorNum > 5) throw new Error(helper.t('translation.tip.check_img_status_failed'));\n      errorNum += 1;\n    }\n  }\n  return URL.createObjectURL(await download(`${apiUrl()}/result/${task_id}`));\n};\nconst [selfhostedOptions, setSelfOptions] = helper.createEqualsSignal([]);\n\n/** 更新部署服务的可用翻译 */\nconst updateSelfhostedOptions = async noTip => {\n  if (store.option.translation.server !== 'selfhosted') return;\n  try {\n    const res = await request.request(`${apiUrl()}`, {\n      noTip,\n      errorText: helper.t('alert.server_connect_failed')\n    });\n    const translatorsText = /(?<=validTranslators: ).+?(?=,\\n)/.exec(res.responseText)?.[0];\n    if (!translatorsText) return undefined;\n    const list = JSON.parse(translatorsText.replaceAll(`'`, `\"`));\n    setSelfOptions(createOptions(list));\n  } catch (error) {\n    helper.log.error(helper.t('translation.tip.get_translator_list_error'), error);\n    setSelfOptions([]);\n  }\n\n  // 如果切换服务器后原先选择的翻译服务失效了，就换成谷歌翻译\n  if (!selfhostedOptions().some(([val]) => val === store.option.translation.options.translator)) {\n    setOption(draftOption => {\n      draftOption.translation.options.translator = 'google';\n    });\n  }\n};\n\n// 在切换翻译服务器的同时切换可用翻译的选项列表\nhelper.createEffectOn([() => store.option.translation.server, () => store.option.translation.localUrl, helper.lang], () => updateSelfhostedOptions(true), {\n  defer: true\n});\n\nconst handleMessage = (msg, url) => {\n  switch (msg.type) {\n    case 'result':\n      return msg.result.translation_mask;\n    case 'pending':\n      setMessage(url, helper.t('translation.tip.pending', {\n        pos: msg.pos\n      }));\n      break;\n    case 'status':\n      setMessage(url, helper.t(`translation.status.${msg.status}`) || msg.status);\n      break;\n    case 'error':\n      throw new Error(`${helper.t('translation.tip.error')}：id ${msg.error_id}`);\n    case 'not_found':\n      throw new Error(`${helper.t('translation.tip.error')}：Not Found`);\n  }\n};\nconst waitTranslationPolling = async (id, url) => {\n  let result;\n  while (result === undefined) {\n    const res = await request.request(`https://api.cotrans.touhou.ai/task/${id}/status/v1`, {\n      responseType: 'json'\n    });\n    result = handleMessage(res.response, url);\n    await helper.sleep(1000);\n  }\n  return result;\n};\n\n/** 等待翻译完成 */\nconst waitTranslation = (id, url) => {\n  const ws = new WebSocket(`wss://api.cotrans.touhou.ai/task/${id}/event/v1`);\n\n  // 如果网站设置了 CSP connect-src 就只能轮询了\n  if (ws.readyState > 1) return waitTranslationPolling(id, url);\n  return new Promise((resolve, reject) => {\n    ws.onmessage = e => {\n      try {\n        const result = handleMessage(JSON.parse(e.data), url);\n        if (result) resolve(result);\n      } catch (error) {\n        reject(error);\n      }\n    };\n  });\n};\n\n/** 将翻译后的内容覆盖到原图上 */\nconst mergeImage = async (rawImage, maskUri) => {\n  const img = await helper.waitImgLoad(URL.createObjectURL(rawImage));\n  const canvas = new OffscreenCanvas(img.naturalWidth, img.naturalHeight);\n  const canvasCtx = canvas.getContext('2d');\n  canvasCtx.drawImage(img, 0, 0);\n  const img2 = new Image();\n  img2.src = URL.createObjectURL(await download(maskUri));\n  await helper.waitImgLoad(img2);\n  canvasCtx.drawImage(img2, 0, 0);\n  return URL.createObjectURL(await helper.canvasToBlob(canvas));\n};\n\n/** 缩小过大的图片 */\nconst resize = async (blob, w, h) => {\n  if (w <= 4096 && h <= 4096) return blob;\n  const scale = Math.min(4096 / w, 4096 / h);\n  const width = Math.floor(w * scale);\n  const height = Math.floor(h * scale);\n  const img = await helper.waitImgLoad(URL.createObjectURL(blob));\n  const canvas = new OffscreenCanvas(width, height);\n  const ctx = canvas.getContext('2d');\n  ctx.imageSmoothingQuality = 'high';\n  ctx.drawImage(img, 0, 0, width, height);\n  URL.revokeObjectURL(img.src);\n  return helper.canvasToBlob(canvas);\n};\n\n/** 使用 cotrans 翻译指定图片 */\nconst cotransTranslation = async url => {\n  const img = store.imgMap[url];\n  setMessage(url, helper.t('translation.tip.img_downloading'));\n  let imgBlob;\n  try {\n    imgBlob = await download(img.src);\n  } catch (error) {\n    helper.log.error(error);\n    throw new Error(helper.t('translation.tip.download_img_failed'));\n  }\n  try {\n    imgBlob = await resize(imgBlob, img.width, img.height);\n  } catch (error) {\n    helper.log.error(error);\n    throw new Error(helper.t('translation.tip.resize_img_failed'));\n  }\n  setMessage(url, helper.t('translation.tip.upload'));\n  let res;\n  try {\n    res = await request.request('https://api.cotrans.touhou.ai/task/upload/v1', {\n      method: 'POST',\n      data: createFormData(imgBlob, 'cotrans'),\n      headers: {\n        Origin: 'https://cotrans.touhou.ai',\n        Referer: 'https://cotrans.touhou.ai/'\n      }\n    });\n  } catch (error) {\n    helper.log.error(error);\n    throw new Error(helper.t('translation.tip.upload_error'));\n  }\n  let resData;\n  try {\n    resData = JSON.parse(res.responseText);\n    helper.log(resData);\n  } catch {\n    throw new Error(`${helper.t('translation.tip.upload_return_error')}：${res.responseText}`);\n  }\n  if ('error_id' in resData) throw new Error(`${helper.t('translation.tip.upload_return_error')}：${resData.error_id}`);\n  if (!resData.id) throw new Error(helper.t('translation.tip.id_not_returned'));\n  const translation_mask = resData.result?.translation_mask || (await waitTranslation(resData.id, url));\n  return mergeImage(imgBlob, translation_mask);\n};\nconst cotransTranslators = ['google', 'youdao', 'baidu', 'deepl', 'gpt3.5', 'offline', 'none'];\n\n/** 翻译指定图片 */\nconst translationImage = async url => {\n  try {\n    if (typeof GM_xmlhttpRequest === 'undefined') {\n      toast?.error(helper.t('pwa.alert.userscript_not_installed'));\n      throw new Error(helper.t('pwa.alert.userscript_not_installed'));\n    }\n    if (!url) return;\n    const img = store.imgMap[url];\n    if (img.translationType !== 'wait') return;\n    if (img.translationUrl) return _setState('imgMap', url, 'translationType', 'show');\n    if (img.loadType !== 'loaded') return setMessage(url, helper.t('translation.tip.img_not_fully_loaded'));\n    const translationUrl = await (store.option.translation.server === 'cotrans' ? cotransTranslation : selfhostedTranslation)(url);\n    _setState('imgMap', url, {\n      translationUrl,\n      translationMessage: helper.t('translation.tip.translation_completed'),\n      translationType: 'show'\n    });\n  } catch (error) {\n    _setState('imgMap', url, 'translationType', 'error');\n    if (error?.message) _setState('imgMap', url, 'translationMessage', error.message);\n  }\n};\n\n/** 逐个翻译状态为等待翻译的图片 */\nconst translationAll = helper.singleThreaded(async () => {\n  for (const img of Object.values(store.imgMap)) {\n    if (img.loadType !== 'loaded' || img.translationType !== 'wait') continue;\n    await translationImage(img.src);\n  }\n});\n\n/** 开启或关闭指定图片的翻译 */\nconst setImgTranslationEnbale = (list, enbale) => {\n  setState(state => {\n    for (const i of list) {\n      const img = state.imgMap[state.imgList[i]];\n      if (!img) continue;\n      const url = img.src;\n      if (enbale) {\n        if (state.option.translation.forceRetry) {\n          img.translationType = 'wait';\n          img.translationUrl = undefined;\n          setMessage(url, helper.t('translation.tip.wait_translation'));\n        } else {\n          switch (img.translationType) {\n            case 'hide':\n              {\n                img.translationType = 'show';\n                break;\n              }\n            case 'error':\n            case undefined:\n              {\n                img.translationType = 'wait';\n                setMessage(url, helper.t('translation.tip.wait_translation'));\n                break;\n              }\n          }\n        }\n      } else {\n        switch (img.translationType) {\n          case 'show':\n            {\n              img.translationType = 'hide';\n              break;\n            }\n          case 'error':\n          case 'wait':\n            {\n              img.translationType = undefined;\n              break;\n            }\n        }\n      }\n    }\n  });\n  return translationAll();\n};\nconst translatorOptions = helper.createRootMemo(() => store.option.translation.server === 'selfhosted' ? selfhostedOptions() : createOptions(cotransTranslators));\n\n/** 当前显示的图片是否正在翻译 */\nconst isTranslatingImage = helper.createRootMemo(() => activePage().some(i => {\n  const img = getImg(i);\n  return img?.translationType && img.translationType !== 'hide';\n}));\n\n/** 翻译当前页 */\nconst translateCurrent = () => setImgTranslationEnbale(activePage(), !isTranslatingImage());\nconst createTranslateRange = imgs => {\n  const isTranslating = helper.createRootMemo(() => {\n    for (const i of imgs()) if (imgList()[i]?.translationType === undefined) return false;\n    return true;\n  });\n  const translateRange = () => {\n    if (store.option.translation.server !== 'selfhosted') return;\n    setImgTranslationEnbale(imgs(), !isTranslating());\n  };\n  return [isTranslating, translateRange];\n};\n\n// 翻译全部图片\nconst [isTranslatingAll, translateAll] = createTranslateRange(helper.createRootMemo(() => helper.range(store.imgList.length - 1)));\n\n// 翻译当前页以后的全部图片\nconst [isTranslatingToEnd, translateToEnd] = createTranslateRange(helper.createRootMemo(() => helper.range(activeImgIndex(), store.imgList.length - 1)));\n\n// 特意使用 requestAnimationFrame 和 .click() 是为了能和 Vimium 兼容\n// （虽然因为使用了 shadow dom 的缘故实际还是不能兼容，但说不定之后就改了呢\nconst focus = () => requestAnimationFrame(() => {\n  refs.mangaBox?.click();\n  refs.mangaBox?.focus();\n});\nconst handleMouseDown = e => {\n  if (e.button !== 1 || store.option.scrollMode.enabled) return;\n  e.stopPropagation();\n  e.preventDefault();\n  switchFillEffect();\n};\n\n/** 卷轴模式下的页面滚动 */\nconst scrollModeScrollPage = dir => {\n  if (!store.show.endPage) {\n    scrollTo(scrollTop() + store.rootSize.height * 0.8 * (dir === 'next' ? 1 : -1));\n    _setState('scrollLock', true);\n  }\n  closeScrollLock();\n};\n\n/** 根据是否开启了 左右翻页键交换 来切换翻页方向 */\nconst handleSwapPageTurnKey = nextPage => {\n  const next = store.option.swapPageTurnKey ? !nextPage : nextPage;\n  return next ? 'next' : 'prev';\n};\nconst handleKeyDown = e => {\n  switch (e.target.tagName) {\n    case 'INPUT':\n    case 'TEXTAREA':\n      return;\n  }\n  if (e.target.className === modules_c21c94f2$1.hotkeysItem) return;\n  const code = helper.getKeyboardCode(e);\n\n  // esc 在触发配置操作前，先用于退出一些界面\n  if (e.key === 'Escape') {\n    if (store.gridMode) {\n      e.stopPropagation();\n      e.preventDefault();\n      return _setState('gridMode', false);\n    }\n    if (store.show.endPage) {\n      e.stopPropagation();\n      e.preventDefault();\n      return _setState('show', 'endPage', undefined);\n    }\n  }\n\n  // 处理标注了 data-only-number 的元素\n  if (e.target.dataset.onlyNumber !== undefined) {\n    // 拦截能输入数字外的按键\n    if (/^(Shift \\+ )?[a-zA-Z]$/.test(code)) {\n      e.stopPropagation();\n      e.preventDefault();\n    }\n    return;\n  }\n\n  // 卷轴、网格模式下跳过用于移动的按键\n  if ((isScrollMode() || store.gridMode) && !store.show.endPage) {\n    switch (e.key) {\n      case 'Home':\n      case 'End':\n      case 'ArrowRight':\n      case 'ArrowLeft':\n        e.stopPropagation();\n        return;\n      case 'ArrowUp':\n      case 'PageUp':\n        e.stopPropagation();\n        return store.gridMode || turnPage('prev');\n      case 'ArrowDown':\n      case 'PageDown':\n      case ' ':\n        e.stopPropagation();\n        return store.gridMode || turnPage('next');\n    }\n  }\n\n  // 拦截已注册的快捷键\n  if (Reflect.has(hotkeysMap(), code)) {\n    e.stopPropagation();\n    e.preventDefault();\n  } else return;\n\n  // 并排卷轴模式下的快捷键\n  if (isAbreastMode()) {\n    switch (hotkeysMap()[code]) {\n      case 'scroll_up':\n        setAbreastScrollFill(abreastScrollFill() - store.rootSize.height * 0.02);\n        return;\n      case 'scroll_down':\n        setAbreastScrollFill(abreastScrollFill() + store.rootSize.height * 0.02);\n        return;\n      case 'scroll_left':\n        return scrollTo(scrollProgress() + abreastColumnWidth());\n      case 'scroll_right':\n        return scrollTo(scrollProgress() - abreastColumnWidth());\n      case 'page_up':\n        return scrollTo(scrollProgress() - store.rootSize.width * 0.8);\n      case 'page_down':\n        return scrollTo(scrollProgress() + store.rootSize.width * 0.8);\n      case 'jump_to_home':\n        return scrollTo(0);\n      case 'jump_to_end':\n        return scrollTo(scrollLength());\n    }\n  }\n  switch (hotkeysMap()[code]) {\n    case 'page_up':\n    case 'scroll_up':\n      {\n        if (isScrollMode()) scrollModeScrollPage('prev');\n        return turnPage('prev');\n      }\n    case 'page_down':\n    case 'scroll_down':\n      {\n        if (isScrollMode()) scrollModeScrollPage('next');\n        return turnPage('next');\n      }\n    case 'scroll_left':\n      return turnPage(handleSwapPageTurnKey(store.option.dir === 'rtl'));\n    case 'scroll_right':\n      return turnPage(handleSwapPageTurnKey(store.option.dir !== 'rtl'));\n    case 'jump_to_home':\n      return _setState('activePageIndex', 0);\n    case 'jump_to_end':\n      return _setState('activePageIndex', Math.max(0, store.pageList.length - 1));\n    case 'switch_page_fill':\n      return switchFillEffect();\n    case 'switch_scroll_mode':\n      return switchScrollMode();\n    case 'switch_single_double_page_mode':\n      return switchOnePageMode();\n    case 'switch_dir':\n      return switchDir();\n    case 'switch_grid_mode':\n      return switchGridMode();\n    case 'translate_current_page':\n      return translateCurrent();\n    case 'translate_all':\n      return translateAll();\n    case 'translate_to_end':\n      return translateToEnd();\n    case 'switch_auto_enlarge':\n      return setOption(draftOption => {\n        draftOption.disableZoom = !draftOption.disableZoom;\n      });\n    case 'exit':\n      return store.prop.Exit?.();\n\n    // 阅读模式以外的快捷键转发到网页上去处理\n    default:\n      document.body.dispatchEvent(new KeyboardEvent('keydown', e));\n      document.body.dispatchEvent(new KeyboardEvent('keyup', e));\n  }\n};\n\n/** 判断两个数值是否是整数倍的关系 */\nconst isMultipleOf = (a, b) => {\n  const decimal = `${a < b ? b / a : a / b}`.split('.')?.[1];\n  return !decimal || decimal.startsWith('0000') || decimal.startsWith('9999');\n};\nlet lastDeltaY = -1;\nlet timeoutId = 0;\nlet lastPageNum = -1;\nlet wheelType;\nlet equalNum = 0;\nlet diffNum = 0;\nconst handleWheel = e => {\n  if (store.gridMode) return;\n  e.stopPropagation();\n  if (e.ctrlKey || e.altKey) e.preventDefault();\n  const isWheelDown = e.deltaY > 0;\n  if (store.show.endPage) return turnPage(isWheelDown ? 'next' : 'prev');\n\n  // 卷轴模式下的图片缩放\n  if ((e.ctrlKey || e.altKey) && store.option.scrollMode.enabled && store.option.zoom.ratio === 100) {\n    e.preventDefault();\n    if (store.option.scrollMode.fitToWidth) return;\n    return zoomScrollModeImg(isWheelDown ? -0.05 : 0.05);\n  }\n  if (e.ctrlKey || e.altKey) {\n    e.preventDefault();\n    return zoom(store.option.zoom.ratio + (isWheelDown ? -25 : 25), e);\n  }\n  const nowDeltaY = Math.abs(e.deltaY);\n\n  // 并排卷轴模式下\n  if (isAbreastMode() && store.option.zoom.ratio === 100) {\n    e.preventDefault();\n    // 先触发翻页判断再滚动，防止在滚动到底时立刻触发结束页\n    turnPage(isWheelDown ? 'next' : 'prev');\n    scrollTo(scrollTop() + e.deltaY);\n  }\n\n  // 防止滚动到网页\n  if (!isScrollMode()) e.preventDefault();\n\n  // 通过`两次滚动距离是否成倍数`和`滚动距离是否过小`来判断是否是触摸板\n  if (wheelType !== 'trackpad' && (nowDeltaY < 2 || !Number.isInteger(lastDeltaY) && !Number.isInteger(nowDeltaY) && !isMultipleOf(lastDeltaY, nowDeltaY))) {\n    wheelType = 'trackpad';\n    if (timeoutId) clearTimeout(timeoutId);\n    // 如果是触摸板滚动，且上次成功触发了翻页，就重新翻页回去\n    if (lastPageNum !== -1) _setState('activePageIndex', lastPageNum);\n  }\n\n  // 为了避免因临时卡顿而误判为触摸板\n  // 在连续几次滚动量均相同的情况下，将 wheelType 相关变量重置回初始状态\n  if (diffNum < 10) {\n    if (lastDeltaY === nowDeltaY && nowDeltaY > 5) equalNum += 1;else {\n      diffNum += 1;\n      equalNum = 0;\n    }\n    if (equalNum >= 3) {\n      wheelType = undefined;\n      lastPageNum = -1;\n    }\n  }\n  lastDeltaY = nowDeltaY;\n  switch (wheelType) {\n    case undefined:\n      {\n        if (lastPageNum === -1) {\n          // 第一次触发滚动没法判断类型，就当作滚轮来处理\n          // 但为了避免触摸板前两次滚动事件间隔大于帧生成时间导致得重新翻页回去的闪烁，加个延迟等待下\n          lastPageNum = store.activePageIndex;\n          timeoutId = window.setTimeout(() => turnPage(isWheelDown ? 'next' : 'prev'), 16);\n          return;\n        }\n        wheelType = 'mouse';\n      }\n    // falls through\n\n    case 'mouse':\n      return turnPage(isWheelDown ? 'next' : 'prev');\n    case 'trackpad':\n      return handleTrackpadWheel(e);\n  }\n};\n\n/** 滚动条元素的长度 */\nconst scrollDomLength = helper.createRootMemo(() => Math.max(store.scrollbarSize.width, store.scrollbarSize.height));\n\n/** 滚动条滑块的中心点高度 */\nconst sliderMidpoint = helper.createRootMemo(() => scrollDomLength() * (scrollPercentage() + sliderHeight() / 2));\n\n/** 滚动条滑块的位置 */\nconst sliderTop = helper.createRootMemo(() => `${scrollPercentage() * scrollDomLength()}px`);\n\n/** 滚动条位置 */\nconst scrollPosition = helper.createRootMemo(() => {\n  if (store.option.scrollbar.position === 'auto') {\n    if (store.isMobile) return 'top';\n    if (isAbreastMode()) return 'bottom';\n    // 大部分图片都是宽图时，将滚动条移至底部\n    return store.defaultImgType === 'long' ? 'bottom' : 'right';\n  }\n  return store.option.scrollbar.position;\n});\n\n/** 判断点击位置在滚动条上的位置比率 */\nconst getClickTop = (x, y, e) => {\n  switch (scrollPosition()) {\n    case 'bottom':\n    case 'top':\n      return store.option.dir === 'rtl' ? 1 - x / e.offsetWidth : x / e.offsetWidth;\n    default:\n      return y / e.offsetHeight;\n  }\n};\n\n/** 计算在滚动条上的拖动距离 */\nconst getSliderDist = ([x, y], [ix, iy], e) => {\n  switch (scrollPosition()) {\n    case 'bottom':\n    case 'top':\n      return store.option.dir === 'rtl' ? (1 - (x - ix)) / e.offsetWidth : (x - ix) / e.offsetWidth;\n    default:\n      return (y - iy) / e.offsetHeight;\n  }\n};\nconst [isDrag, setIsDrag] = solidJs.createSignal(false);\nconst closeDrag = helper.debounce(() => setIsDrag(false), 200);\nlet lastType = 'up';\n\n/** 开始拖拽时的 sliderTop 值 */\nlet startTop = 0;\nconst handleScrollbarSlider = ({\n  type,\n  xy,\n  initial\n}, e) => {\n  const [x, y] = xy;\n\n  // 检测是否是拖动操作\n  if (type === 'move' && lastType === type) {\n    setIsDrag(true);\n    closeDrag();\n  }\n  lastType = type;\n\n  // 跳过拖拽结束事件（单击时会同时触发开始和结束，就用开始事件来完成单击的效果\n  if (type === 'up') return focus();\n  if (!refs.mangaFlow) return;\n  const scrollbarDom = e.target;\n\n  /** 点击位置在滚动条上的位置比率 */\n  const clickTop = getClickTop(x, y, e.target);\n  if (store.option.scrollMode.enabled) {\n    if (type === 'move') {\n      const top = helper.clamp(0, startTop + getSliderDist(xy, initial, scrollbarDom), 1) * scrollLength();\n      scrollTo(top);\n    } else {\n      // 确保滚动条的中心会在点击位置\n      startTop = clickTop - sliderHeight() / 2;\n      const top = startTop * scrollLength();\n      scrollTo(top, true);\n    }\n  } else {\n    let newPageIndex = Math.floor(clickTop * store.pageList.length);\n    // 处理超出范围的情况\n    if (newPageIndex < 0) newPageIndex = 0;else if (newPageIndex >= store.pageList.length) newPageIndex = store.pageList.length - 1;\n    if (newPageIndex !== store.activePageIndex) _setState('activePageIndex', newPageIndex);\n  }\n};\n\n/** 摩擦系数 */\nconst FRICTION_COEFF = 0.96;\nlet lastTop = 0;\nlet dy = 0;\nlet lastLeft = 0;\nlet dx = 0;\nlet animationId = null;\nlet lastTime = 0;\n\n/** 逐帧计算速率 */\nconst calcVelocity = () => {\n  const nowTop = store.option.scrollMode.abreastMode ? abreastScrollFill() : scrollTop();\n  dy = nowTop - lastTop;\n  lastTop = nowTop;\n  dx = store.page.offset.x.px - lastLeft;\n  lastLeft = store.page.offset.x.px;\n  animationId = requestAnimationFrame(calcVelocity);\n};\n\n/** 逐帧计算惯性滑动 */\nconst handleSlide = timestamp => {\n  // 当速率足够小时停止计算动画\n  if (Math.abs(dx) + Math.abs(dy) < 1) {\n    animationId = null;\n    return;\n  }\n\n  // 确保每16毫秒才减少一次速率，防止在高刷新率显示器上衰减过快\n  if (timestamp - lastTime > 16) {\n    dy *= FRICTION_COEFF;\n    dx *= FRICTION_COEFF;\n    lastTime = timestamp;\n  }\n  if (store.option.scrollMode.abreastMode) {\n    scrollTo(scrollTop() + dx);\n    setAbreastScrollFill(abreastScrollFill() + dy);\n  } else scrollTo(scrollTop() + dy);\n  animationId = requestAnimationFrame(handleSlide);\n};\nlet initTop = 0;\nlet initLeft = 0;\nlet initAbreastScrollFill = 0;\nconst handleScrollModeDrag = ({\n  type,\n  xy: [x, y],\n  initial: [ix, iy]\n}) => {\n  switch (type) {\n    case 'down':\n      {\n        if (animationId) cancelAnimationFrame(animationId);\n        initTop = refs.mangaBox.scrollTop;\n        initLeft = store.page.offset.x.px * (store.option.dir === 'rtl' ? 1 : -1);\n        initAbreastScrollFill = abreastScrollFill();\n        requestAnimationFrame(calcVelocity);\n        return;\n      }\n    case 'move':\n      {\n        if (store.option.scrollMode.abreastMode) {\n          const _dx = x - ix;\n          const _dy = y - iy;\n          scrollTo((initLeft + _dx) * (store.option.dir === 'rtl' ? 1 : -1));\n          setAbreastScrollFill(initAbreastScrollFill + _dy);\n        } else scrollTo(initTop + iy - y);\n        return;\n      }\n    case 'up':\n      {\n        if (animationId) cancelAnimationFrame(animationId);\n        animationId = requestAnimationFrame(handleSlide);\n      }\n  }\n};\n\nconst getImageData = img => {\n  const {\n    naturalWidth: width,\n    naturalHeight: height\n  } = img;\n  const canvas = new OffscreenCanvas(width, height);\n  const ctx = canvas.getContext('2d', {\n    willReadFrequently: true\n  });\n  ctx.drawImage(img, 0, 0);\n  return ctx.getImageData(0, 0, width, height);\n};\nconst handleImgRecognition = (img, url) => {\n  const {\n    data,\n    width,\n    height\n  } = getImageData(img);\n  return worker.handleImg(Comlink.transfer(data, [data.buffer]), width, height, url, store$1.unwrap(store.option.imgRecognition));\n};\nconst mainFn = {\n  log: helper.log,\n  updatePageData: helper.throttle(() => setState(updatePageData), 1000),\n  setImg: (url, key, val) => Reflect.has(store.imgMap, url) && _setState('imgMap', url, key, val)\n};\nworker.setMainFn(Comlink.proxy(mainFn), Object.keys(mainFn));\n\n/** 图片加载完毕的回调 */\nconst handleImgLoaded = (url, e) => {\n  // 内联图片元素被创建后立刻就会触发 load 事件，如果在调用这个函数前 url 发生改变\n  // 就会导致这里获得的是上个 url 图片的尺寸\n  if (e && !e.isConnected) return;\n  const img = store.imgMap[url];\n  if (img.loadType !== 'loaded') {\n    _setState('imgMap', url, 'loadType', 'loaded');\n    updateImgLoadType();\n    store.prop.Loading?.(imgList(), store.imgMap[url]);\n  }\n  if (!e) return;\n  updateImgSize(url, e.naturalWidth, e.naturalHeight);\n  if (store.option.imgRecognition.enabled && e.src === img.blobUrl) setTimeout(handleImgRecognition, 0, e, url);\n};\n\n/** 图片加载出错的次数 */\nconst imgErrorNum = new Map();\n\n/** 图片加载出错的回调 */\nconst handleImgError = (url, e) => {\n  if (e && !e.isConnected) return;\n  imgErrorNum.set(url, (imgErrorNum.get(url) ?? 0) + 1);\n  setState(state => {\n    const img = state.imgMap[url];\n    if (!img) return;\n    const imgIndex = getImgIndex(url);\n    helper.log.error(imgIndex, helper.t('alert.img_load_failed'), e);\n    img.loadType = 'error';\n    img.type = undefined;\n    if (imgIndex.some(i => renderImgList().has(i)) && (imgErrorNum.get(img.src) ?? 0) < 2) img.loadType = 'wait';\n  });\n  store.prop.Loading?.(imgList(), store.imgMap[url]);\n  updateImgLoadType();\n};\n\n/** 需要加载的图片 */\nconst needLoadImgList = helper.createRootMemo(() => {\n  const list = new Set();\n  for (const [index, img] of imgList().entries()) if (img.loadType !== 'loaded' && img.src) list.add(index);\n  return list;\n});\n\n/** 当前需要加载的图片 */\nconst loadImgList = new Set();\n\n/** 加载指定图片。返回是否已加载完成 */\nconst loadImg = index => {\n  if (index === -1 || !needLoadImgList().has(index)) return true;\n  const img = getImg(index);\n  if (img.loadType === 'error') return true;\n  loadImgList.add(index);\n  return false;\n};\n\n/** 获取指定页数下的头/尾图片 */\nconst getPageImg = (pageNum, imgType) => {\n  const page = store.pageList[pageNum].filter(i => i !== -1);\n  if (page.length === 1) return page[0];\n  return imgType === 'start' ? Math.min(...page) : Math.max(...page);\n};\n\n/**\n * 以当前显示页为基准，预加载附近指定页数的图片，并取消其他预加载的图片\n * @param target 加载目标页\n * @param loadNum 加载图片数量\n * @returns 返回指定范围内是否还有未加载的图片\n */\nconst loadRangeImg = (target = 0, loadNum = 2) => {\n  let start = getPageImg(store.showRange[0], 'start');\n  let end = getPageImg(store.showRange[1], 'end');\n  if (target !== 0) {\n    if (target < 0) {\n      end = start + target;\n      start -= 1;\n    } else {\n      start = end + 1;\n      end += target;\n    }\n    start = helper.clamp(0, start, store.imgList.length - 1);\n    end = helper.clamp(0, end, store.imgList.length - 1);\n  }\n\n  /** 是否还有未加载的图片 */\n  let hasUnloadedImg = false;\n  let index = start;\n  const condition = start <= end ? () => index <= end : () => index >= end;\n  const step = start <= end ? 1 : -1;\n  while (condition()) {\n    if (!loadImg(index)) hasUnloadedImg = true;\n    if (loadImgList.size >= loadNum) return index !== end || hasUnloadedImg;\n    index += step;\n  }\n  return hasUnloadedImg;\n};\n\n/** 加载期间尽快获取图片尺寸 */\nconst checkImgSize = url => {\n  const imgDom = getImgEle(url);\n  if (!imgDom) return;\n  const timeoutId = setInterval(() => {\n    if (!imgDom?.isConnected || store.option.imgRecognition.enabled) return clearInterval(timeoutId);\n    const img = store.imgMap[url];\n    if (!img || img.loadType !== 'loading') return clearInterval(timeoutId);\n    if (imgDom.naturalWidth && imgDom.naturalHeight) {\n      updateImgSize(url, imgDom.naturalWidth, imgDom.naturalHeight);\n      return clearInterval(timeoutId);\n    }\n  }, 200);\n};\nconst updateImgLoadType = helper.singleThreaded(() => {\n  if (needLoadImgList().size === 0) return;\n  loadImgList.clear();\n  if (store.imgList.length > 0) {\n    // 优先加载当前显示的图片\n    loadRangeImg() ||\n    // 再加载后面几页\n    loadRangeImg(preloadNum().back) ||\n    // 再加载前面几页\n    loadRangeImg(-preloadNum().front) ||\n    // 根据设置决定是否要继续加载其余图片\n    !store.option.alwaysLoadAllImg ||\n    // 加载当前页后面的图片\n    loadRangeImg(Number.POSITIVE_INFINITY, 5) ||\n    // 加载当前页前面的图片\n    loadRangeImg(Number.NEGATIVE_INFINITY, 5);\n  }\n  setState(state => {\n    for (const index of needLoadImgList()) {\n      const img = getImg(index, state);\n      if (loadImgList.has(index)) {\n        if (img.loadType !== 'loading') {\n          img.loadType = 'loading';\n          if (!store.option.imgRecognition.enabled && img.width === undefined) setTimeout(checkImgSize, 0, img.src);\n        }\n      } else if (img.loadType === 'loading') img.loadType = 'wait';\n    }\n  });\n});\nhelper.createEffectOn([preloadNum, helper.createRootMemo(() => [...renderImgList()].map(i => store.imgList[i])), () => store.option.alwaysLoadAllImg], updateImgLoadType);\nhelper.createEffectOn(showImgList, helper.debounce(_showImgList => {\n  // 如果当前显示页面有出错的图片，就重新加载一次\n  for (const img of [..._showImgList].map(i => getImg(i))) {\n    if (img?.loadType !== 'error') continue;\n    _setState('imgMap', img.src, 'loadType', 'wait');\n    updateImgLoadType();\n  }\n}, 500), {\n  defer: true\n});\n\n/** 加载中的图片 */\nconst loadingImgList = helper.createRootMemo(() => {\n  const list = new Set();\n  for (const [url, img] of Object.entries(store.imgMap)) if (img.loadType === 'loading') list.add(url);\n  return list;\n});\nconst abortMap = new Map();\nconst timeoutAbort = url => {\n  if (!abortMap.has(url)) return;\n  abortMap.get(url).abort();\n  abortMap.delete(url);\n  handleImgError(url);\n};\nhelper.createEffectOn(loadingImgList, async (downImgList, prevImgList) => {\n  if (!store.option.imgRecognition.enabled) return;\n  if (prevImgList) {\n    // 中断取消下载的图片\n    for (const url of prevImgList) {\n      if (downImgList.has(url) || !abortMap.has(url)) continue;\n      abortMap.get(url)?.abort();\n      abortMap.delete(url);\n      helper.log(`中断下载 ${url}`);\n    }\n  }\n  for (const url of downImgList.values()) {\n    if (abortMap.has(url) || store.imgMap[url].blobUrl) continue;\n    const controller = new AbortController();\n    const handleTimeout = helper.debounce(() => timeoutAbort(url), 1000 * 3);\n    controller.signal.addEventListener('abort', handleTimeout.clear);\n    abortMap.set(url, controller);\n    handleTimeout();\n    request.request(url, {\n      responseType: 'blob',\n      fetch: false,\n      signal: controller.signal,\n      timeout: undefined,\n      noTip: true,\n      onerror: () => handleImgError(url),\n      onprogress({\n        loaded,\n        total\n      }) {\n        _setState('imgMap', url, 'progress', loaded / total * 100);\n        // 一段时间内都没进度后超时中断\n        handleTimeout();\n      },\n      onload({\n        response\n      }) {\n        abortMap.delete(url);\n        _setState('imgMap', url, {\n          blobUrl: URL.createObjectURL(response),\n          progress: undefined\n        });\n        handleImgLoaded(url);\n      }\n    });\n  }\n});\n\nconst EmptyTip = () => {\n  let ref;\n  helper.onAutoMount(() => {\n    let timeoutId = 0;\n    const observer = new IntersectionObserver(([{\n      isIntersecting\n    }]) => {\n      if (!isIntersecting) return;\n      timeoutId = window.setTimeout(() => {\n        ref?.style.removeProperty('opacity');\n        timeoutId = 0;\n      }, 2000);\n    }, {\n      threshold: 1\n    });\n    observer.observe(ref);\n    return () => {\n      observer.disconnect();\n      if (timeoutId) clearTimeout(timeoutId);\n    };\n  });\n  return (() => {\n    var _el$ = web.template(`<h1>`)();\n    var _ref$ = ref;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$) : ref = _el$;\n    _el$.style.setProperty(\"opacity\", \"0\");\n    _el$.textContent = \"NULL\";\n    return _el$;\n  })();\n};\n\nconst ComicImg = img => {\n  const showState = () => imgShowState().get(img.index);\n  const src = () => {\n    if (img.loadType === 'wait') return '';\n    if (img.translationType === 'show') return img.translationUrl;\n    if (store.option.imgRecognition.enabled) return img.blobUrl;\n    // 有些浏览器不支持显示带有 hash 标识的图片 url\n    if (img.src.startsWith('blob:')) return img.src.replace(/#\\..+/, '');\n    return img.src;\n  };\n\n  /** 并排卷轴模式下需要复制的图片数量 */\n  const cloneNum = solidJs.createMemo(() => {\n    if (!isAbreastMode()) return 0;\n    const imgPosition = abreastArea().position[img.index];\n    return imgPosition ? imgPosition.length - 1 : 0;\n  });\n\n  /** 是否要渲染复制图片 */\n  const renderClone = () => !store.gridMode && showState() !== undefined && cloneNum() > 0;\n  const selector = `.${modules_c21c94f2$1.img}[id^=\"_${img.index}_\"]`;\n  useStyleMemo(selector, {\n    'grid-area': () => isAbreastMode() ? 'none' : `_${img.index}`,\n    'background-color': () => isEnableBg() ? img.background : undefined\n  });\n  useStyleMemo(`${selector} > picture`, {\n    'aspect-ratio': () => `${img.size.width} / ${img.size.height}`,\n    background: () => img.progress && `linear-gradient(\n          to bottom,\n          var(--secondary-bg) ${img.progress}%,\n          var(--hover-bg-color,#fff3) ${img.progress}%\n        )`\n  });\n  const _ComicImg = props => (() => {\n    var _el$ = web.template(`<div><picture>`)(),\n      _el$2 = _el$.firstChild;\n    web.insert(_el$2, web.createComponent(solidJs.Show, {\n      get when() {\n        return web.memo(() => img.loadType !== 'wait')() && src();\n      },\n      get children() {\n        var _el$3 = web.template(`<img draggable=false decoding=sync>`)();\n        _el$3.addEventListener(\"error\", e => handleImgError(img.src, e.currentTarget));\n        _el$3.addEventListener(\"load\", e => handleImgLoaded(img.src, e.currentTarget));\n        web.effect(_p$ => {\n          var _v$ = src(),\n            _v$2 = `${img.index}`,\n            _v$3 = img.src;\n          _v$ !== _p$.e && web.setAttribute(_el$3, \"src\", _p$.e = _v$);\n          _v$2 !== _p$.t && web.setAttribute(_el$3, \"alt\", _p$.t = _v$2);\n          _v$3 !== _p$.a && web.setAttribute(_el$3, \"data-src\", _p$.a = _v$3);\n          return _p$;\n        }, {\n          e: undefined,\n          t: undefined,\n          a: undefined\n        });\n        return _el$3;\n      }\n    }));\n    web.insert(_el$, web.createComponent(solidJs.Show, {\n      get when() {\n        return store.gridMode;\n      },\n      get children() {\n        var _el$4 = web.template(`<div>`)();\n        web.insert(_el$4, (() => {\n          var _c$ = web.memo(() => !!store.gridMode);\n          return () => _c$() ? getImgTip(img.index) : '';\n        })());\n        web.effect(() => web.className(_el$4, modules_c21c94f2$1.gridModeTip));\n        return _el$4;\n      }\n    }), null);\n    web.effect(_p$ => {\n      var _v$4 = modules_c21c94f2$1.img,\n        _v$5 = `_${img.index}_${props.cloneIndex ?? 0}`,\n        _v$6 = showState(),\n        _v$7 = img.type ?? store.defaultImgType,\n        _v$8 = img.loadType === 'loaded' ? undefined : img.loadType;\n      _v$4 !== _p$.e && web.className(_el$, _p$.e = _v$4);\n      _v$5 !== _p$.t && web.setAttribute(_el$, \"id\", _p$.t = _v$5);\n      _v$6 !== _p$.a && web.setAttribute(_el$, \"data-show\", _p$.a = _v$6);\n      _v$7 !== _p$.o && web.setAttribute(_el$, \"data-type\", _p$.o = _v$7);\n      _v$8 !== _p$.i && web.setAttribute(_el$, \"data-load-type\", _p$.i = _v$8);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined\n    });\n    return _el$;\n  })();\n  return [web.createComponent(_ComicImg, {}), web.createComponent(solidJs.Show, {\n    get when() {\n      return renderClone();\n    },\n    get children() {\n      return web.createComponent(solidJs.For, {\n        get each() {\n          return Array.from({\n            length: cloneNum()\n          });\n        },\n        children: (_, i) => web.createComponent(_ComicImg, {\n          get cloneIndex() {\n            return i() + 1;\n          }\n        })\n      });\n    }\n  })];\n};\n\n// 目前即使是不显示的图片也必须挂载上，否则解析好的图片会被浏览器垃圾回收掉，\n// 导致在 ehentai 上无法正常加载图片。但这样会在图片过多时造成性能问题，\n// 虽然也尝试了将解析好的 Image 对象存储起来挂上引用和另外放到一个避免渲染的 dom 下，\n// 但也都失败了，只能暂时先不管了。\n// 之后尝试新方案时必须经过如下测试：开个几百页的漫画加载完毕后，再打开二十个标签页切换过去，\nconst ComicImgFlow = () => {\n  const {\n    hiddenMouse,\n    onMouseMove\n  } = useHiddenMouse();\n  const handleDrag = (state, e) => {\n    if (store.gridMode) return;\n    if (touches.size > 1) return handlePinchZoom(state);\n    if (store.option.zoom.ratio !== 100) return handleZoomDrag(state);\n    if (store.option.scrollMode.enabled) return handleScrollModeDrag(state);\n    return handleMangaFlowDrag(state);\n  };\n  solidJs.onMount(() => {\n    helper.useDrag({\n      ref: refs.mangaBox,\n      handleDrag,\n      handleClick,\n      touches\n    });\n    bindScrollTop(refs.mangaBox);\n  });\n  const handleTransitionEnd = () => {\n    if (store.isDragMode) return;\n    setState(state => {\n      if (store.option.zoom.ratio === 100) resetPage(state, false);else state.page.anima = '';\n    });\n  };\n\n  /** 在当前页之前有图片被加载出来，导致内容高度发生变化后，重新滚动页面，确保当前显示位置不变 */\n  helper.createEffectOn([() => store.showRange[0], () => imgTopList()[store.showRange[0]], imgTopList], ([showImg, height, topList], prev) => {\n    if (!prev || !height || !isScrollMode()) return;\n    const [prevShowImg, prevHeight, prevTopList] = prev;\n    if (showImg !== prevShowImg || prevTopList === topList || prevHeight === height) return;\n    scrollTo(scrollTop() + height - prevHeight);\n    // 目前还是会有轻微偏移，但考虑到大部分情况下都是顺序阅读，本身出现概率就低，就不继续排查优化了\n  });\n  const pageToText = page => `${(page.length === 1 ? [page[0], page[0]] : page).map(i => i === -1 ? '.' : `_${i}`).join(' ')}`;\n  const gridAreas = solidJs.createMemo(() => {\n    if (store.pageList.length === 0) return undefined;\n    if (store.gridMode) {\n      let columnNum;\n      if (store.isMobile) columnNum = 2;else if (store.defaultImgType === 'vertical') columnNum = 6;else if (isOnePageMode()) columnNum = 4;else columnNum = 2;\n      const areaList = [[]];\n      for (const page of store.pageList) {\n        if (areaList.at(-1).length === columnNum) areaList.push([]);\n        areaList.at(-1).push(pageToText(page));\n      }\n      while (areaList.at(-1).length !== columnNum) areaList.at(-1).push('. .');\n      return areaList.map(line => `\"${line.join(' ')}\"`).join('\\n') || undefined;\n    }\n    if (store.option.scrollMode.enabled) {\n      if (!store.option.scrollMode.abreastMode) return helper.createSequence(store.imgList.length).map(i => `\"_${i}\"`).join('\\n');\n      return `\"${helper.createSequence(abreastArea().columns.length).map(i => `_${i}`).join(' ')}\"`;\n    }\n    return store.page.vertical ? store.pageList.slice(store.renderRange[0], store.renderRange[1] + 1).map(page => `\"${pageToText(page)}\"`).join('\\n') : `\"${store.pageList.slice(store.renderRange[0], store.renderRange[1] + 1).map(pageToText).join(' ')}\"`;\n  });\n  useStyleMemo(`.${modules_c21c94f2$1.mangaBox}`, {\n    transform: () => `translate(${store.option.zoom.offset.x}px, ${store.option.zoom.offset.y}px)\n        scale(${store.option.zoom.ratio / 100})`\n  });\n  const pageX = solidJs.createMemo(() => {\n    if (store.gridMode || isScrollMode()) return 0;\n    let x = store.page.offset.x.pct * store.rootSize.width + store.page.offset.x.px;\n    if (store.option.dir !== 'rtl') x = -x;\n    return x;\n  });\n  useStyleMemo(`#${modules_c21c94f2$1.mangaFlow}`, {\n    transform: () => `translate(\n        ${pageX()}px,\n        ${store.page.offset.y.pct * store.rootSize.height + store.page.offset.y.px}px\n      ) translateZ(0)`,\n    'touch-action'() {\n      if (store.gridMode) return 'auto';\n      if (store.option.zoom.ratio !== 100) {\n        if (!store.option.scrollMode.enabled) return 'none';\n        if (store.option.zoom.offset.y === 0) return 'pan-up';\n        if (store.option.zoom.offset.y === bound().y) return 'pan-down';\n      }\n    },\n    'grid-template-areas': gridAreas,\n    'grid-template-columns'() {\n      if (store.imgList.length === 0 || store.gridMode) return undefined;\n      if (isAbreastMode()) return `repeat(${abreastArea().columns.length}, ${abreastColumnWidth()}px)`;\n      if (isScrollMode()) return undefined;\n      if (store.page.vertical) return '50% 50%';\n      return `repeat(${gridAreas()?.split(' ').length ?? 0}, 50%)`;\n    },\n    'grid-template-rows'() {\n      if (!isScrollMode() || store.gridMode) return undefined;\n      return imgList().map(({\n        size: {\n          height\n        }\n      }) => `${height}px`).join(' ');\n    },\n    'background-color': () => isEnableBg() ? getImg(activeImgIndex())?.background : undefined\n  });\n  useStyle(imgAreaStyle);\n  return (() => {\n    var _el$ = web.template(`<div tabindex=-1><div tabindex=-1>`)(),\n      _el$2 = _el$.firstChild;\n    _el$.addEventListener(\"transitionend\", handleTransitionEnd);\n    var _ref$ = bindRef('mangaBox');\n    typeof _ref$ === \"function\" && web.use(_ref$, _el$);\n    _el$2.addEventListener(\"transitionend\", handleTransitionEnd);\n    web.addEventListener(_el$2, \"mousemove\", onMouseMove);\n    var _ref$2 = bindRef('mangaFlow');\n    typeof _ref$2 === \"function\" && web.use(_ref$2, _el$2);\n    web.insert(_el$2, web.createComponent(solidJs.Index, {\n      get each() {\n        return imgList();\n      },\n      get fallback() {\n        return web.createComponent(EmptyTip, {});\n      },\n      children: (img, i) => web.createComponent(ComicImg, web.mergeProps({\n        index: i\n      }, img))\n    }));\n    web.effect(_p$ => {\n      var _v$ = `${modules_c21c94f2$1.mangaBox} ${modules_c21c94f2$1.beautifyScrollbar}`,\n        _v$2 = store.page.anima,\n        _v$3 = helper.boolDataVal(store.option.scrollMode.abreastMode),\n        _v$4 = modules_c21c94f2$1.mangaFlow,\n        _v$5 = store.option.dir,\n        _v$6 = `${modules_c21c94f2$1.mangaFlow} ${modules_c21c94f2$1.beautifyScrollbar}`,\n        _v$7 = helper.boolDataVal(store.option.disableZoom && !store.option.scrollMode.enabled),\n        _v$8 = helper.boolDataVal(store.option.zoom.ratio !== 100),\n        _v$9 = helper.boolDataVal(store.page.vertical),\n        _v$10 = !store.gridMode && store.option.autoHiddenMouse && hiddenMouse(),\n        _v$11 = helper.boolDataVal(store.option.scrollMode.fitToWidth);\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"data-animation\", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$, \"data-abreast-scroll\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.setAttribute(_el$2, \"id\", _p$.o = _v$4);\n      _v$5 !== _p$.i && web.setAttribute(_el$2, \"dir\", _p$.i = _v$5);\n      _v$6 !== _p$.n && web.className(_el$2, _p$.n = _v$6);\n      _v$7 !== _p$.s && web.setAttribute(_el$2, \"data-disable-zoom\", _p$.s = _v$7);\n      _v$8 !== _p$.h && web.setAttribute(_el$2, \"data-scale-mode\", _p$.h = _v$8);\n      _v$9 !== _p$.r && web.setAttribute(_el$2, \"data-vertical\", _p$.r = _v$9);\n      _v$10 !== _p$.d && web.setAttribute(_el$2, \"data-hidden-mouse\", _p$.d = _v$10);\n      _v$11 !== _p$.l && web.setAttribute(_el$2, \"data-fit-width\", _p$.l = _v$11);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined,\n      s: undefined,\n      h: undefined,\n      r: undefined,\n      d: undefined,\n      l: undefined\n    });\n    return _el$;\n  })();\n};\n\nconst MdLooksOne = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-6 14c-.55 0-1-.45-1-1V9h-1c-.55 0-1-.45-1-1s.45-1 1-1h2c.55 0 1 .45 1 1v8c0 .55-.45 1-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdLooksTwo = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-4 8c0 1.1-.9 2-2 2h-2v2h3c.55 0 1 .45 1 1s-.45 1-1 1h-4c-.55 0-1-.45-1-1v-3c0-1.1.9-2 2-2h2V9h-3c-.55 0-1-.45-1-1s.45-1 1-1h3c1.1 0 2 .9 2 2z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdViewDay = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M3 21h17c.55 0 1-.45 1-1v-1c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1v1c0 .55.45 1 1 1M20 8H3c-.55 0-1 .45-1 1v6c0 .55.45 1 1 1h17c.55 0 1-.45 1-1V9c0-.55-.45-1-1-1M2 4v1c0 .55.45 1 1 1h17c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1H3c-.55 0-1 .45-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdQueue = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M3 6c-.55 0-1 .45-1 1v13c0 1.1.9 2 2 2h13c.55 0 1-.45 1-1s-.45-1-1-1H5c-.55 0-1-.45-1-1V7c0-.55-.45-1-1-1m17-4H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m-2 9h-3v3c0 .55-.45 1-1 1s-1-.45-1-1v-3h-3c-.55 0-1-.45-1-1s.45-1 1-1h3V6c0-.55.45-1 1-1s1 .45 1 1v3h3c.55 0 1 .45 1 1s-.45 1-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdSettings = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M19.5 12c0-.23-.01-.45-.03-.68l1.86-1.41c.4-.3.51-.86.26-1.3l-1.87-3.23a.987.987 0 0 0-1.25-.42l-2.15.91c-.37-.26-.76-.49-1.17-.68l-.29-2.31c-.06-.5-.49-.88-.99-.88h-3.73c-.51 0-.94.38-1 .88l-.29 2.31c-.41.19-.8.42-1.17.68l-2.15-.91c-.46-.2-1-.02-1.25.42L2.41 8.62c-.25.44-.14.99.26 1.3l1.86 1.41a7.3 7.3 0 0 0 0 1.35l-1.86 1.41c-.4.3-.51.86-.26 1.3l1.87 3.23c.25.44.79.62 1.25.42l2.15-.91c.37.26.76.49 1.17.68l.29 2.31c.06.5.49.88.99.88h3.73c.5 0 .93-.38.99-.88l.29-2.31c.41-.19.8-.42 1.17-.68l2.15.91c.46.2 1 .02 1.25-.42l1.87-3.23c.25-.44.14-.99-.26-1.3l-1.86-1.41c.03-.23.04-.45.04-.68m-7.46 3.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdTranslate = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M12.65 15.67c.14-.36.05-.77-.23-1.05l-2.09-2.06.03-.03A17.5 17.5 0 0 0 14.07 6h1.94c.54 0 .99-.45.99-.99v-.02c0-.54-.45-.99-.99-.99H10V3c0-.55-.45-1-1-1s-1 .45-1 1v1H1.99c-.54 0-.99.45-.99.99 0 .55.45.99.99.99h10.18A15.7 15.7 0 0 1 9 11.35c-.81-.89-1.49-1.86-2.06-2.88A.89.89 0 0 0 6.16 8c-.69 0-1.13.75-.79 1.35.63 1.13 1.4 2.21 2.3 3.21L3.3 16.87a.99.99 0 0 0 0 1.42c.39.39 1.02.39 1.42 0L9 14l2.02 2.02c.51.51 1.38.32 1.63-.35M17.5 10c-.6 0-1.14.37-1.35.94l-3.67 9.8c-.24.61.22 1.26.87 1.26.39 0 .74-.24.88-.61l.89-2.39h4.75l.9 2.39c.14.36.49.61.88.61.65 0 1.11-.65.88-1.26l-3.67-9.8c-.22-.57-.76-.94-1.36-.94m-1.62 7 1.62-4.33L19.12 17z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdGrid = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M22 6c0-.55-.45-1-1-1h-2V3c0-.55-.45-1-1-1s-1 .45-1 1v2h-4V3c0-.55-.45-1-1-1s-1 .45-1 1v2H7V3c0-.55-.45-1-1-1s-1 .45-1 1v2H3c-.55 0-1 .45-1 1s.45 1 1 1h2v4H3c-.55 0-1 .45-1 1s.45 1 1 1h2v4H3c-.55 0-1 .45-1 1s.45 1 1 1h2v2c0 .55.45 1 1 1s1-.45 1-1v-2h4v2c0 .55.45 1 1 1s1-.45 1-1v-2h4v2c0 .55.45 1 1 1s1-.45 1-1v-2h2c.55 0 1-.45 1-1s-.45-1-1-1h-2v-4h2c.55 0 1-.45 1-1s-.45-1-1-1h-2V7h2c.55 0 1-.45 1-1M7 7h4v4H7zm0 10v-4h4v4zm10 0h-4v-4h4zm0-6h-4V7h4z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdZoomIn = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34-4.23-.52-7.78 3.04-7.27 7.27.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.26 4.25c.41.41 1.07.41 1.48 0l.01-.01c.41-.41.41-1.07 0-1.48zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14m0-7c-.28 0-.5.22-.5.5V9H7.5c-.28 0-.5.22-.5.5s.22.5.5.5H9v1.5c0 .28.22.5.5.5s.5-.22.5-.5V10h1.5c.28 0 .5-.22.5-.5s-.22-.5-.5-.5H10V7.5c0-.28-.22-.5-.5-.5\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdZoomOut = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l4.26 4.25c.41.41 1.07.41 1.48 0l.01-.01c.41-.41.41-1.07 0-1.48zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14m-2-5h4c.28 0 .5.22.5.5s-.22.5-.5.5h-4c-.28 0-.5-.22-.5-.5s.22-.5.5-.5\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nvar css = \".iconButtonItem____hash_base64_5_{align-items:center;display:flex;position:relative}.iconButton____hash_base64_5_{align-items:center;background-color:initial;border-radius:9999px;border-style:none;color:var(--text,#fff);cursor:pointer;display:flex;font-size:1.5em;height:1.5em;justify-content:center;margin:.1em;outline:none;padding:0;width:1.5em}.iconButton____hash_base64_5_:focus,.iconButton____hash_base64_5_:hover{background-color:var(--hover-bg-color,#fff3)}.iconButton____hash_base64_5_.enabled____hash_base64_5_{background-color:var(--text,#fff);color:var(--text-bg,#121212)}.iconButton____hash_base64_5_.enabled____hash_base64_5_:focus,.iconButton____hash_base64_5_.enabled____hash_base64_5_:hover{background-color:var(--hover-bg-color-enable,#fffa)}.iconButton____hash_base64_5_>svg{width:1em}.iconButtonPopper____hash_base64_5_{align-items:center;background-color:#303030;border-radius:.3em;color:#fff;display:flex;font-size:.8em;opacity:0;padding:.4em .5em;pointer-events:none;position:absolute;top:50%;transform:translateY(-50%);-webkit-user-select:none;user-select:none;white-space:nowrap}.iconButtonPopper____hash_base64_5_[data-placement=right]{left:calc(100% + 1.5em)}.iconButtonPopper____hash_base64_5_[data-placement=right]:before{border-right-color:var(--switch-bg,#6e6e6e);border-right-width:.5em;right:calc(100% + .5em)}.iconButtonPopper____hash_base64_5_[data-placement=left]{right:calc(100% + 1.5em)}.iconButtonPopper____hash_base64_5_[data-placement=left]:before{border-left-color:var(--switch-bg,#6e6e6e);border-left-width:.5em;left:calc(100% + .5em)}.iconButtonPopper____hash_base64_5_:before{background-color:initial;border:.4em solid #0000;content:\\\"\\\";pointer-events:none;position:absolute;transition:opacity .15s}.iconButtonItem____hash_base64_5_:is(:hover,:focus,[data-show=true]) .iconButtonPopper____hash_base64_5_{opacity:1}.hidden____hash_base64_5_{display:none}\";\nvar modules_c21c94f2 = {\"iconButtonItem\":\"iconButtonItem____hash_base64_5_\",\"iconButton\":\"iconButton____hash_base64_5_\",\"enabled\":\"enabled____hash_base64_5_\",\"iconButtonPopper\":\"iconButtonPopper____hash_base64_5_\",\"hidden\":\"hidden____hash_base64_5_\"};\n\n/** 图标按钮 */\nconst IconButton = _props => {\n  const props = solidJs.mergeProps({\n    placement: 'right'\n  }, _props);\n  let buttonRef;\n  const handleClick = e => {\n    props.onClick?.(e);\n    // 在每次点击后取消焦点\n    buttonRef?.blur();\n  };\n  return (() => {\n    var _el$ = web.template(`<div><button type=button tabindex=0>`)(),\n      _el$2 = _el$.firstChild;\n    web.use(ref => helper.useStyle(css, ref), _el$);\n    web.addEventListener(_el$2, \"click\", handleClick);\n    var _ref$ = buttonRef;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$2) : buttonRef = _el$2;\n    web.insert(_el$2, () => props.children);\n    web.insert(_el$, (() => {\n      var _c$ = web.memo(() => !!(props.popper || props.tip));\n      return () => _c$() ? (() => {\n        var _el$3 = web.template(`<div>`)();\n        web.insert(_el$3, () => props.popper || props.tip);\n        web.effect(_p$ => {\n          var _v$6 = [modules_c21c94f2.iconButtonPopper, props.popperClassName].join(' '),\n            _v$7 = props.placement;\n          _v$6 !== _p$.e && web.className(_el$3, _p$.e = _v$6);\n          _v$7 !== _p$.t && web.setAttribute(_el$3, \"data-placement\", _p$.t = _v$7);\n          return _p$;\n        }, {\n          e: undefined,\n          t: undefined\n        });\n        return _el$3;\n      })() : null;\n    })(), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2.iconButtonItem,\n        _v$2 = props.showTip,\n        _v$3 = props.tip,\n        _v$4 = modules_c21c94f2.iconButton,\n        _v$5 = {\n          [modules_c21c94f2.hidden]: props.hidden,\n          [modules_c21c94f2.enabled]: props.enabled\n        };\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"data-show\", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$2, \"aria-label\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.className(_el$2, _p$.o = _v$4);\n      _p$.i = web.classList(_el$2, _v$5, _p$.i);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined\n    });\n    return _el$;\n  })();\n};\n\nconst MdOutlineFormatTextdirectionLToR = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M9 10v4c0 .55.45 1 1 1s1-.45 1-1V4h2v10c0 .55.45 1 1 1s1-.45 1-1V4h1c.55 0 1-.45 1-1s-.45-1-1-1H9.17C7.08 2 5.22 3.53 5.02 5.61A4 4 0 0 0 9 10m11.65 7.65-2.79-2.79a.501.501 0 0 0-.86.35V17H6c-.55 0-1 .45-1 1s.45 1 1 1h11v1.79c0 .45.54.67.85.35l2.79-2.79c.2-.19.2-.51.01-.7\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdOutlineFormatTextdirectionRToL = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M10 10v4c0 .55.45 1 1 1s1-.45 1-1V4h2v10c0 .55.45 1 1 1s1-.45 1-1V4h1c.55 0 1-.45 1-1s-.45-1-1-1h-6.83C8.08 2 6.22 3.53 6.02 5.61A4 4 0 0 0 10 10m-2 7v-1.79c0-.45-.54-.67-.85-.35l-2.79 2.79c-.2.2-.2.51 0 .71l2.79 2.79a.5.5 0 0 0 .85-.36V19h11c.55 0 1-.45 1-1s-.45-1-1-1z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\n/** 设置菜单项 */\nconst SettingsItem = props => (() => {\n  var _el$ = web.template(`<div><div> <!> `)(),\n    _el$2 = _el$.firstChild,\n    _el$3 = _el$2.firstChild,\n    _el$5 = _el$3.nextSibling;\n    _el$5.nextSibling;\n  web.insert(_el$2, () => props.name, _el$5);\n  web.insert(_el$, () => props.children, null);\n  web.effect(_p$ => {\n    var _v$ = props.class ? `${modules_c21c94f2$1.SettingsItem} ${props.class}` : modules_c21c94f2$1.SettingsItem,\n      _v$2 = {\n        [props.class ?? '']: Boolean(props.class?.length),\n        ...props.classList\n      },\n      _v$3 = props.style,\n      _v$4 = modules_c21c94f2$1.SettingsItemName;\n    _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n    _p$.t = web.classList(_el$, _v$2, _p$.t);\n    _p$.a = web.style(_el$, _v$3, _p$.a);\n    _v$4 !== _p$.o && web.className(_el$2, _p$.o = _v$4);\n    return _p$;\n  }, {\n    e: undefined,\n    t: undefined,\n    a: undefined,\n    o: undefined\n  });\n  return _el$;\n})();\n\n/** 开关式菜单项 */\nconst SettingsItemSwitch = props => {\n  const handleClick = () => props.onChange(!props.value);\n  return web.createComponent(SettingsItem, {\n    get name() {\n      return props.name;\n    },\n    get [\"class\"]() {\n      return props.class;\n    },\n    get classList() {\n      return props.classList;\n    },\n    get children() {\n      var _el$ = web.template(`<button type=button><div>`)(),\n        _el$2 = _el$.firstChild;\n      web.addEventListener(_el$, \"click\", handleClick);\n      web.effect(_p$ => {\n        var _v$ = modules_c21c94f2$1.SettingsItemSwitch,\n          _v$2 = props.value,\n          _v$3 = modules_c21c94f2$1.SettingsItemSwitchRound;\n        _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n        _v$2 !== _p$.t && web.setAttribute(_el$, \"data-checked\", _p$.t = _v$2);\n        _v$3 !== _p$.a && web.className(_el$2, _p$.a = _v$3);\n        return _p$;\n      }, {\n        e: undefined,\n        t: undefined,\n        a: undefined\n      });\n      return _el$;\n    }\n  });\n};\n\nconst MdClose = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdRefresh = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M17.65 6.35a7.95 7.95 0 0 0-6.48-2.31c-3.67.37-6.69 3.35-7.1 7.02C3.52 15.91 7.27 20 12 20a7.98 7.98 0 0 0 7.21-4.56c.32-.67-.16-1.44-.9-1.44-.37 0-.72.2-.88.53a5.994 5.994 0 0 1-6.8 3.31c-2.22-.49-4.01-2.3-4.48-4.52A6.002 6.002 0 0 1 12 6c1.66 0 3.14.69 4.22 1.78l-1.51 1.51c-.63.63-.19 1.71.7 1.71H19c.55 0 1-.45 1-1V6.41c0-.89-1.08-1.34-1.71-.71z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdAdd = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M18 13h-5v5c0 .55-.45 1-1 1s-1-.45-1-1v-5H6c-.55 0-1-.45-1-1s.45-1 1-1h5V6c0-.55.45-1 1-1s1 .45 1 1v5h5c.55 0 1 .45 1 1s-.45 1-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst setHotkeys = (...args) => {\n  _setState(...['hotkeys', ...args]);\n  store.prop.HotkeysChange?.(Object.fromEntries(Object.entries(store.hotkeys).filter(([name, keys]) => !helper.isEqual(keys.filter(Boolean), defaultHotkeys()[name]))));\n};\nconst delHotkeys = code => {\n  for (const [name, keys] of Object.entries(store.hotkeys)) {\n    const i = keys.indexOf(code);\n    if (i === -1) continue;\n    const newKeys = [...store.hotkeys[name]];\n    newKeys.splice(i, 1);\n    setHotkeys(name, newKeys);\n  }\n};\nconst getHotkeyName = code => helper.t(`hotkeys.${code}`) || helper.t(`button.${code}`) || helper.t(`setting.translation.${code}`) || code;\nconst KeyItem = props => {\n  const code = () => store.hotkeys[props.operateName][props.i];\n  const del = () => delHotkeys(code());\n  const handleKeyDown = e => {\n    e.stopPropagation();\n    e.preventDefault();\n    switch (e.key) {\n      case 'Tab':\n      case 'Enter':\n      case 'Escape':\n        focus();\n        return;\n      case 'Backspace':\n        setHotkeys(props.operateName, props.i, '');\n        return;\n    }\n    const newCode = helper.getKeyboardCode(e);\n    if (!Reflect.has(hotkeysMap(), newCode)) setHotkeys(props.operateName, props.i, newCode);\n  };\n  return (() => {\n    var _el$ = web.template(`<div tabindex=0>`)();\n    _el$.addEventListener(\"blur\", () => code() || del());\n    web.use(ref => code() || setTimeout(() => ref.focus()), _el$);\n    web.addEventListener(_el$, \"keydown\", handleKeyDown);\n    web.insert(_el$, () => helper.keyboardCodeToText(code()), null);\n    web.insert(_el$, web.createComponent(MdClose, {\n      \"on:click\": del\n    }), null);\n    web.effect(() => web.className(_el$, modules_c21c94f2$1.hotkeysItem));\n    return _el$;\n  })();\n};\nconst ShowHotkeys = props => web.createComponent(solidJs.For, {\n  get each() {\n    return props.keys;\n  },\n  children: name => (() => {\n    var _el$2 = web.template(`<div><div><p></p><span></span><div></div><div>`)(),\n      _el$3 = _el$2.firstChild,\n      _el$4 = _el$3.firstChild,\n      _el$5 = _el$4.nextSibling,\n      _el$6 = _el$5.nextSibling,\n      _el$7 = _el$6.nextSibling;\n    web.insert(_el$4, () => getHotkeyName(name));\n    _el$5.style.setProperty(\"flex-grow\", \"1\");\n    web.addEventListener(_el$6, \"click\", () => setHotkeys(name, store.hotkeys[name].length, ''));\n    web.insert(_el$6, web.createComponent(MdAdd, {}));\n    web.addEventListener(_el$7, \"click\", () => {\n      const newKeys = defaultHotkeys()[name] ?? [];\n      for (const code of defaultHotkeys()[name]) delHotkeys(code);\n      setHotkeys(name, newKeys);\n    });\n    web.insert(_el$7, web.createComponent(MdRefresh, {}));\n    web.insert(_el$2, web.createComponent(solidJs.Index, {\n      get each() {\n        return store.hotkeys[name];\n      },\n      children: (_, i) => web.createComponent(KeyItem, {\n        operateName: name,\n        i: i\n      })\n    }), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2$1.hotkeys,\n        _v$2 = modules_c21c94f2$1.hotkeysHeader,\n        _v$3 = helper.t('setting.hotkeys.add'),\n        _v$4 = helper.t('setting.hotkeys.restore');\n      _v$ !== _p$.e && web.className(_el$2, _p$.e = _v$);\n      _v$2 !== _p$.t && web.className(_el$3, _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$6, \"title\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.setAttribute(_el$7, \"title\", _p$.o = _v$4);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined\n    });\n    return _el$2;\n  })()\n});\nconst OtherHotkeys = props => {\n  let ref;\n  const handleChange = e => {\n    const name = e.target.value;\n    setHotkeys(name, store.hotkeys[name].length, '');\n    ref.value = '';\n  };\n  return (() => {\n    var _el$8 = web.template(`<div><select><option value=\"\"disabled hidden selected> …`)(),\n      _el$9 = _el$8.firstChild,\n      _el$10 = _el$9.firstChild,\n      _el$11 = _el$10.firstChild;\n    _el$9.addEventListener(\"change\", handleChange);\n    var _ref$ = ref;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$9) : ref = _el$9;\n    _el$9.style.setProperty(\"height\", \"100%\");\n    web.insert(_el$10, () => helper.t('setting.option.paragraph_other'), _el$11);\n    web.insert(_el$9, web.createComponent(solidJs.For, {\n      get each() {\n        return props.keys;\n      },\n      children: name => (() => {\n        var _el$12 = web.template(`<option>`)();\n        _el$12.value = name;\n        web.insert(_el$12, () => getHotkeyName(name));\n        return _el$12;\n      })()\n    }), null);\n    web.effect(_p$ => {\n      var _v$5 = modules_c21c94f2$1.hotkeys,\n        _v$6 = modules_c21c94f2$1.hotkeysHeader;\n      _v$5 !== _p$.e && web.className(_el$8, _p$.e = _v$5);\n      _v$6 !== _p$.t && web.className(_el$9, _p$.t = _v$6);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined\n    });\n    return _el$8;\n  })();\n};\nconst SettingHotkeys = () => {\n  const hotkeys = helper.createRootMemo(() => {\n    const show = [];\n    const other = [];\n    for (const [name, keys] of Object.entries(store.hotkeys)) (keys.length > 0 ? show : other).push(name);\n    return {\n      show,\n      other\n    };\n  });\n  return [web.createComponent(ShowHotkeys, {\n    get keys() {\n      return hotkeys().show;\n    }\n  }), web.createComponent(solidJs.Show, {\n    get when() {\n      return hotkeys().other.length;\n    },\n    get children() {\n      return web.createComponent(OtherHotkeys, {\n        get keys() {\n          return hotkeys().other;\n        }\n      });\n    }\n  })];\n};\n\n/** 范围输入框 */\nconst RangeInput = props => {\n  let ref;\n\n  /** 在保持光标位置不变的情况下修改文本 */\n  const editText = text => {\n    const offset = ref.selectionStart;\n    ref.value = text;\n    if (offset) requestAnimationFrame(() => {\n      ref.selectionStart = offset;\n      ref.selectionEnd = offset;\n    });\n  };\n\n  /** 修改文本中的数字 */\n  const replaceTextNumer = (text, offset, fn) => {\n    const isNumber = num => /\\d/.test(text[num]);\n    let start = offset;\n    if (!isNumber(offset)) {\n      if (isNumber(start - 1)) start--;else if (isNumber(start + 1)) start++;else return text;\n    }\n    let end = start;\n    while (isNumber(start - 1)) start--;\n    while (isNumber(end + 1)) end++;\n    return text.slice(0, start) + fn(Number(text.slice(start, end + 1))) + text.slice(end + 1);\n  };\n  const handleKeyDown = e => {\n    switch (e.key) {\n      case 'ArrowUp':\n      case 'ArrowDown':\n        editText(replaceTextNumer(ref.value, ref.selectionStart, num => e.key === 'ArrowUp' ? num + 1 : num - 1));\n    }\n  };\n  return (() => {\n    var _el$ = web.template(`<textarea autocomplete=off rows=2>`)();\n    _el$.addEventListener(\"blur\", () => {\n      try {\n        props.onChange?.(ref.value);\n      } finally {\n        ref.value = props.value;\n      }\n    });\n    web.addEventListener(_el$, \"keydown\", handleKeyDown);\n    var _ref$ = ref;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$) : ref = _el$;\n    web.effect(() => web.setAttribute(_el$, \"placeholder\", props.placeholder));\n    web.effect(() => _el$.value = props.value);\n    return _el$;\n  })();\n};\n\n/** 选择器式菜单项 */\nconst SettingsItemSelect = props => {\n  let ref;\n  solidJs.createEffect(() => {\n    ref.value = props.options?.some(([val]) => val === props.value) ? props.value : '';\n  });\n  return web.createComponent(SettingsItem, {\n    get name() {\n      return props.name;\n    },\n    get [\"class\"]() {\n      return props.class;\n    },\n    get classList() {\n      return props.classList;\n    },\n    get children() {\n      var _el$ = web.template(`<select>`)();\n      web.addEventListener(_el$, \"click\", () => props.onClick?.());\n      _el$.addEventListener(\"change\", e => props.onChange(e.target.value));\n      var _ref$ = ref;\n      typeof _ref$ === \"function\" ? web.use(_ref$, _el$) : ref = _el$;\n      web.insert(_el$, web.createComponent(solidJs.For, {\n        get each() {\n          return props.options;\n        },\n        children: ([val, label]) => (() => {\n          var _el$2 = web.template(`<option>`)();\n          _el$2.value = val;\n          web.insert(_el$2, label ?? val);\n          return _el$2;\n        })()\n      }));\n      web.effect(() => web.className(_el$, modules_c21c94f2$1.SettingsItemSelect));\n      return _el$;\n    }\n  });\n};\n\n\n/** 带有动画过渡的切换显示设置项 */\nconst SettingsShowItem = props => (() => {\n  var _el$ = web.template(`<div><div>`)(),\n    _el$2 = _el$.firstChild;\n  web.insert(_el$2, () => props.children);\n  web.effect(_p$ => {\n    var _v$ = modules_c21c94f2$1.SettingsShowItem,\n      _v$2 = props.when ? '1fr' : '0fr',\n      _v$3 = modules_c21c94f2$1.SettingsShowItemBody;\n    _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n    _v$2 !== _p$.t && ((_p$.t = _v$2) != null ? _el$.style.setProperty(\"grid-template-rows\", _v$2) : _el$.style.removeProperty(\"grid-template-rows\"));\n    _v$3 !== _p$.a && web.className(_el$2, _p$.a = _v$3);\n    return _p$;\n  }, {\n    e: undefined,\n    t: undefined,\n    a: undefined\n  });\n  return _el$;\n})();\n\nconst TranslateRange = () => {\n  const [rangeText, setRangeText] = solidJs.createSignal('');\n  helper.createEffectOn(rangeText, () => {\n    const imgImgs = helper.extractRange(rangeText(), store.imgList.length);\n    const openImgs = [...imgImgs].filter(i => {\n      // 过滤掉翻译完成和等待翻译的图片，避免因为范围变化而重新发起翻译\n      switch (imgList()[i].translationType) {\n        case 'show':\n        case 'wait':\n          return false;\n        default:\n          return true;\n      }\n    });\n    if (openImgs.length > 0) setImgTranslationEnbale(openImgs, true);\n    const closeImgs = new Set();\n    for (let i = 0; i < store.imgList.length; i++) if (!imgImgs.has(i)) closeImgs.add(i);\n    if (closeImgs.size > 0) setImgTranslationEnbale(closeImgs, false);\n    setRangeText(helper.descRange(imgImgs, store.imgList.length));\n  });\n\n  // 实时更新翻译范围\n  helper.createEffectOn(() => {\n    const list = new Set();\n    for (const [i, img] of imgList().entries()) {\n      switch (img.translationType) {\n        case 'error':\n        case 'show':\n        case 'wait':\n          list.add(i);\n          break;\n      }\n    }\n    return list;\n  }, translationImgs => {\n    setRangeText(helper.descRange(translationImgs, store.imgList.length));\n  });\n  return [web.createComponent(SettingsItem, {\n    get name() {\n      return helper.t('setting.translation.range');\n    }\n  }), web.createComponent(RangeInput, {\n    get [\"class\"]() {\n      return modules_c21c94f2$1.SettingsItem;\n    },\n    get placeholder() {\n      return helper.t('other.page_range');\n    },\n    get value() {\n      return rangeText();\n    },\n    onChange: setRangeText\n  })];\n};\nconst SettingTranslation = () => [web.createComponent(SettingsItemSelect, {\n  get name() {\n    return helper.t('setting.translation.server');\n  },\n  get options() {\n    return [['disable', helper.t('other.disable')], ['selfhosted', helper.t('setting.translation.server_selfhosted')], ['cotrans']];\n  },\n  get value() {\n    return store.option.translation.server;\n  },\n  get onChange() {\n    return createStateSetFn('translation.server');\n  }\n}), web.createComponent(SettingsShowItem, {\n  get when() {\n    return store.option.translation.server === 'cotrans';\n  },\n  get children() {\n    var _el$ = web.template(`<blockquote>`)();\n    web.effect(() => _el$.innerHTML = helper.t('setting.translation.cotrans_tip'));\n    return _el$;\n  }\n}), web.createComponent(SettingsShowItem, {\n  get when() {\n    return store.option.translation.server !== 'disable';\n  },\n  get children() {\n    return [web.createComponent(SettingsItemSelect, {\n      get name() {\n        return helper.t('setting.translation.options.detection_resolution');\n      },\n      options: [['S', '1024px'], ['M', '1536px'], ['L', '2048px'], ['X', '2560px']],\n      get value() {\n        return store.option.translation.options.size;\n      },\n      get onChange() {\n        return createStateSetFn('translation.options.size');\n      }\n    }), web.createComponent(SettingsItemSelect, {\n      get name() {\n        return helper.t('setting.translation.options.text_detector');\n      },\n      options: [['default'], ['ctd', 'Comic Text Detector']],\n      get value() {\n        return store.option.translation.options.detector;\n      },\n      get onChange() {\n        return createStateSetFn('translation.options.detector');\n      }\n    }), web.createComponent(SettingsItemSelect, {\n      get name() {\n        return helper.t('setting.translation.options.translator');\n      },\n      get options() {\n        return translatorOptions();\n      },\n      get value() {\n        return store.option.translation.options.translator;\n      },\n      get onChange() {\n        return createStateSetFn('translation.options.translator');\n      },\n      onClick: () => updateSelfhostedOptions(false)\n    }), web.createComponent(SettingsItemSelect, {\n      get name() {\n        return helper.t('setting.translation.options.direction');\n      },\n      get options() {\n        return [['auto', helper.t('setting.translation.options.direction_auto')], ['h', helper.t('setting.translation.options.direction_horizontal')], ['v', helper.t('setting.translation.options.direction_vertical')]];\n      },\n      get value() {\n        return store.option.translation.options.direction;\n      },\n      get onChange() {\n        return createStateSetFn('translation.options.direction');\n      }\n    }), web.createComponent(SettingsItemSelect, {\n      get name() {\n        return helper.t('setting.translation.options.target_language');\n      },\n      options: [['CHS', '简体中文'], ['CHT', '繁體中文'], ['JPN', '日本語'], ['ENG', 'English'], ['KOR', '한국어'], ['VIN', 'Tiếng Việt'], ['CSY', 'čeština'], ['NLD', 'Nederlands'], ['FRA', 'français'], ['DEU', 'Deutsch'], ['HUN', 'magyar nyelv'], ['ITA', 'italiano'], ['PLK', 'polski'], ['PTB', 'português'], ['ROM', 'limba română'], ['RUS', 'русский язык'], ['ESP', 'español'], ['TRK', 'Türk dili']],\n      get value() {\n        return store.option.translation.options.targetLanguage;\n      },\n      get onChange() {\n        return createStateSetFn('translation.options.targetLanguage');\n      }\n    }), web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('setting.translation.options.forceRetry');\n      },\n      get value() {\n        return store.option.translation.forceRetry;\n      },\n      get onChange() {\n        return createStateSetFn('translation.forceRetry');\n      }\n    }), web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('setting.translation.options.onlyDownloadTranslated');\n      },\n      get value() {\n        return store.option.translation.onlyDownloadTranslated;\n      },\n      get onChange() {\n        return createStateSetFn('translation.onlyDownloadTranslated');\n      }\n    }), web.createComponent(solidJs.Show, {\n      get when() {\n        return store.option.translation.server === 'selfhosted';\n      },\n      get children() {\n        return [web.createComponent(SettingsItemSwitch, {\n          get name() {\n            return helper.t('setting.translation.options.localUrl');\n          },\n          get value() {\n            return store.option.translation.localUrl !== undefined;\n          },\n          onChange: val => {\n            setOption(draftOption => {\n              draftOption.translation.localUrl = val ? '' : undefined;\n            });\n          }\n        }), web.createComponent(solidJs.Show, {\n          get when() {\n            return store.option.translation.localUrl !== undefined;\n          },\n          get children() {\n            var _el$2 = web.template(`<input type=url>`)();\n            _el$2.addEventListener(\"change\", e => {\n              setOption(draftOption => {\n                // 删掉末尾的斜杠\n                const url = e.target.value.replace(/\\/$/, '');\n                draftOption.translation.localUrl = url;\n              });\n            });\n            web.effect(() => _el$2.value = store.option.translation.localUrl);\n            return _el$2;\n          }\n        }), web.createComponent(SettingsItemSwitch, {\n          get name() {\n            return helper.t('setting.translation.translate_all');\n          },\n          get value() {\n            return isTranslatingAll();\n          },\n          onChange: translateAll\n        }), web.createComponent(SettingsItemSwitch, {\n          get name() {\n            return helper.t('setting.translation.translate_to_end');\n          },\n          get value() {\n            return isTranslatingToEnd();\n          },\n          onChange: translateToEnd\n        }), web.createComponent(TranslateRange, {})];\n      }\n    })];\n  }\n})];\n\n/** 数值输入框 */\nconst NumberInput = props => {\n  const handleInput = e => props.maxLength !== undefined && e.currentTarget.textContent.length > props.maxLength && e.currentTarget.blur();\n  const handleKeyDown = e => {\n    switch (e.key) {\n      case 'ArrowUp':\n        return props.onChange(Number(e.target.textContent) + (props.step ?? 1));\n      case 'ArrowDown':\n        return props.onChange(Number(e.target.textContent) - (props.step ?? 1));\n      case 'Enter':\n        return e.target.blur();\n    }\n  };\n  return [(() => {\n    var _el$ = web.template(`<span contenteditable data-only-number>`)();\n    _el$.addEventListener(\"blur\", e => {\n      try {\n        props.onChange(Number(e.currentTarget.textContent));\n      } finally {\n        e.currentTarget.textContent = `${props.value}`;\n      }\n    });\n    web.addEventListener(_el$, \"keydown\", handleKeyDown);\n    web.addEventListener(_el$, \"input\", handleInput);\n    web.insert(_el$, () => `${props.value}`);\n    return _el$;\n  })(), web.createComponent(solidJs.Show, {\n    get when() {\n      return props.suffix;\n    },\n    get children() {\n      return props.suffix;\n    }\n  })];\n};\n\n/** 数值输入框菜单项 */\nconst SettingsItemNumber = props => web.createComponent(SettingsItem, {\n  get name() {\n    return props.name;\n  },\n  get [\"class\"]() {\n    return props.class;\n  },\n  get classList() {\n    return props.classList;\n  },\n  get children() {\n    var _el$ = web.template(`<div>`)();\n    web.insert(_el$, web.createComponent(NumberInput, props));\n    web.effect(_$p => (_$p = props.suffix ? '.3em' : '.6em') != null ? _el$.style.setProperty(\"margin-right\", _$p) : _el$.style.removeProperty(\"margin-right\"));\n    return _el$;\n  }\n});\n\n\nconst areaArrayMap = {\n  left_right: [['prev', 'menu', 'next'], ['PREV', 'MENU', 'NEXT'], ['prev', 'menu', 'next']],\n  up_down: [['prev', 'PREV', 'prev'], ['menu', 'MENU', 'menu'], ['next', 'NEXT', 'next']],\n  edge: [['next', 'menu', 'next'], ['NEXT', 'MENU', 'NEXT'], ['next', 'PREV', 'next']],\n  l: [['PREV', 'prev', 'prev'], ['prev', 'MENU', 'next'], ['next', 'next', 'NEXT']]\n};\nconst areaType = helper.createRootMemo(() => Reflect.has(areaArrayMap, store.option.clickPageTurn.area) ? store.option.clickPageTurn.area : 'left_right');\nconst dir = helper.createRootMemo(() => {\n  if (!store.option.clickPageTurn.reverse) return store.option.dir;\n  return store.option.dir === 'rtl' ? 'ltr' : 'rtl';\n});\nconst TouchArea = () => (() => {\n  var _el$ = web.template(`<div>`)();\n  var _ref$ = bindRef('touchArea');\n  typeof _ref$ === \"function\" && web.use(_ref$, _el$);\n  web.insert(_el$, web.createComponent(solidJs.For, {\n    get each() {\n      return areaArrayMap[areaType()];\n    },\n    children: rows => web.createComponent(solidJs.For, {\n      each: rows,\n      children: area => (() => {\n        var _el$2 = web.template(`<div role=button tabindex=-1>`)();\n        web.setAttribute(_el$2, \"data-area\", area);\n        web.effect(() => web.className(_el$2, modules_c21c94f2$1.touchArea));\n        return _el$2;\n      })()\n    })\n  }));\n  web.effect(_p$ => {\n    var _v$ = modules_c21c94f2$1.touchAreaRoot,\n      _v$2 = dir(),\n      _v$3 = helper.boolDataVal(store.show.touchArea),\n      _v$4 = areaType(),\n      _v$5 = helper.boolDataVal(store.option.clickPageTurn.enabled && !store.option.scrollMode.enabled);\n    _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n    _v$2 !== _p$.t && web.setAttribute(_el$, \"dir\", _p$.t = _v$2);\n    _v$3 !== _p$.a && web.setAttribute(_el$, \"data-show\", _p$.a = _v$3);\n    _v$4 !== _p$.o && web.setAttribute(_el$, \"data-area\", _p$.o = _v$4);\n    _v$5 !== _p$.i && web.setAttribute(_el$, \"data-turn-page\", _p$.i = _v$5);\n    return _p$;\n  }, {\n    e: undefined,\n    t: undefined,\n    a: undefined,\n    o: undefined,\n    i: undefined\n  });\n  return _el$;\n})();\n\n/** 默认菜单项 */\nconst defaultSettingList = () => [[helper.t('setting.option.paragraph_dir'), () => web.createComponent(SettingsItem, {\n  get name() {\n    return web.memo(() => store.option.dir === 'rtl')() ? helper.t('setting.option.dir_rtl') : helper.t('setting.option.dir_ltr');\n  },\n  get children() {\n    var _el$ = web.template(`<button type=button>`)();\n    web.addEventListener(_el$, \"click\", switchDir);\n    web.insert(_el$, (() => {\n      var _c$ = web.memo(() => store.option.dir === 'rtl');\n      return () => _c$() ? web.createComponent(MdOutlineFormatTextdirectionRToL, {}) : web.createComponent(MdOutlineFormatTextdirectionLToR, {});\n    })());\n    web.effect(() => web.className(_el$, modules_c21c94f2$1.SettingsItemIconButton));\n    return _el$;\n  }\n})], [helper.t('setting.option.paragraph_scrollbar'), () => [web.createComponent(SettingsItemSelect, {\n  get name() {\n    return helper.t('setting.option.scrollbar_position');\n  },\n  get options() {\n    return [['auto', helper.t('setting.option.scrollbar_position_auto')], ['right', helper.t('setting.option.scrollbar_position_right')], ['top', helper.t('setting.option.scrollbar_position_top')], ['bottom', helper.t('setting.option.scrollbar_position_bottom')], ['hidden', helper.t('setting.option.scrollbar_position_hidden')]];\n  },\n  get value() {\n    return store.option.scrollbar.position;\n  },\n  get onChange() {\n    return createStateSetFn('scrollbar.position');\n  }\n}), web.createComponent(SettingsShowItem, {\n  get when() {\n    return store.option.scrollbar.position !== 'hidden';\n  },\n  get children() {\n    return [web.createComponent(solidJs.Show, {\n      get when() {\n        return !store.isMobile;\n      },\n      get children() {\n        return web.createComponent(SettingsItemSwitch, {\n          get name() {\n            return helper.t('setting.option.scrollbar_auto_hidden');\n          },\n          get value() {\n            return store.option.scrollbar.autoHidden;\n          },\n          get onChange() {\n            return createStateSetFn('scrollbar.autoHidden');\n          }\n        });\n      }\n    }), web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('setting.option.scrollbar_show_img_status');\n      },\n      get value() {\n        return store.option.scrollbar.showImgStatus;\n      },\n      get onChange() {\n        return createStateSetFn('scrollbar.showImgStatus');\n      }\n    }), web.createComponent(solidJs.Show, {\n      get when() {\n        return store.option.scrollMode.enabled;\n      },\n      get children() {\n        return web.createComponent(SettingsItemSwitch, {\n          get name() {\n            return helper.t('setting.option.scrollbar_easy_scroll');\n          },\n          get value() {\n            return store.option.scrollbar.easyScroll;\n          },\n          get onChange() {\n            return createStateSetFn('scrollbar.easyScroll');\n          }\n        });\n      }\n    })];\n  }\n})]], [helper.t('setting.option.paragraph_operation'), () => [web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.jump_to_next_chapter');\n  },\n  get value() {\n    return store.option.jumpToNext;\n  },\n  get onChange() {\n    return createStateSetFn('jumpToNext');\n  }\n}), web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.click_page_turn_enabled');\n  },\n  get value() {\n    return store.option.clickPageTurn.enabled;\n  },\n  get onChange() {\n    return createStateSetFn('clickPageTurn.enabled');\n  }\n}), web.createComponent(SettingsShowItem, {\n  get when() {\n    return store.option.clickPageTurn.enabled;\n  },\n  get children() {\n    return [web.createComponent(SettingsItemSelect, {\n      get name() {\n        return helper.t('setting.option.click_page_turn_area');\n      },\n      get options() {\n        return Object.keys(areaArrayMap).map(key => [key, helper.t(`touch_area.type.${key}`)]);\n      },\n      get value() {\n        return store.option.clickPageTurn.area;\n      },\n      get onChange() {\n        return createStateSetFn('clickPageTurn.area');\n      }\n    }), web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('setting.option.click_page_turn_swap_area');\n      },\n      get value() {\n        return store.option.clickPageTurn.reverse;\n      },\n      get onChange() {\n        return createStateSetFn('clickPageTurn.reverse');\n      }\n    })];\n  }\n}), web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.show_clickable_area');\n  },\n  get value() {\n    return store.show.touchArea;\n  },\n  onChange: () => _setState('show', 'touchArea', !store.show.touchArea)\n})]], [helper.t('setting.option.paragraph_display'), () => [web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.dark_mode');\n  },\n  get value() {\n    return store.option.darkMode;\n  },\n  get onChange() {\n    return createStateSetFn('darkMode');\n  }\n}), web.createComponent(solidJs.Show, {\n  get when() {\n    return !store.option.scrollMode.enabled;\n  },\n  get children() {\n    return web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('setting.option.disable_auto_enlarge');\n      },\n      get value() {\n        return store.option.disableZoom;\n      },\n      get onChange() {\n        return createStateSetFn('disableZoom');\n      }\n    });\n  }\n}), web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.auto_switch_page_mode');\n  },\n  get value() {\n    return store.option.autoSwitchPageMode;\n  },\n  onChange: val => {\n    setOption((draftOption, state) => {\n      draftOption.autoSwitchPageMode = val;\n      state.option.pageNum = val ? 0 : autoPageNum();\n    });\n  }\n}), web.createComponent(solidJs.Show, {\n  get when() {\n    return store.option.scrollMode.enabled;\n  },\n  get children() {\n    return [web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('setting.option.abreast_mode');\n      },\n      get value() {\n        return store.option.scrollMode.abreastMode;\n      },\n      onChange: val => {\n        const jump = saveScrollProgress();\n        setOption(draftOption => {\n          draftOption.scrollMode.abreastMode = val;\n        });\n        jump();\n      }\n    }), web.createComponent(SettingsItemNumber, {\n      get name() {\n        return helper.t('setting.option.scroll_mode_img_scale');\n      },\n      maxLength: 3,\n      suffix: \"%\",\n      step: 5,\n      onChange: val => {\n        if (!Number.isNaN(val)) zoomScrollModeImg(val / 100, true);\n      },\n      get value() {\n        return Math.round(store.option.scrollMode.imgScale * 100);\n      }\n    }), web.createComponent(SettingsItemNumber, {\n      get name() {\n        return helper.t('setting.option.scroll_mode_img_spacing');\n      },\n      maxLength: 5,\n      onChange: val => {\n        if (Number.isNaN(val)) return;\n        const newVal = helper.clamp(0, val, Number.POSITIVE_INFINITY);\n        setOption(draftOption => {\n          draftOption.scrollMode.spacing = newVal;\n        });\n      },\n      get value() {\n        return Math.round(store.option.scrollMode.spacing);\n      }\n    }), web.createComponent(solidJs.Show, {\n      get when() {\n        return store.option.scrollMode.abreastMode;\n      },\n      get children() {\n        return web.createComponent(SettingsItemNumber, {\n          get name() {\n            return helper.t('setting.option.abreast_duplicate');\n          },\n          maxLength: 3,\n          suffix: \"%\",\n          step: 5,\n          onChange: val => {\n            if (Number.isNaN(val)) return;\n            setOption(draftOption => {\n              const newVal = helper.clamp(0, val / 100, 0.95);\n              draftOption.scrollMode.abreastDuplicate = newVal;\n            });\n          },\n          get value() {\n            return Math.round(store.option.scrollMode.abreastDuplicate * 100);\n          }\n        });\n      }\n    }), web.createComponent(solidJs.Show, {\n      get when() {\n        return !store.option.scrollMode.abreastMode;\n      },\n      get children() {\n        return web.createComponent(SettingsItemSwitch, {\n          get name() {\n            return helper.t('setting.option.fit_to_width');\n          },\n          get value() {\n            return store.option.scrollMode.fitToWidth;\n          },\n          onChange: switchFitToWidth\n        });\n      }\n    })];\n  }\n}), web.createComponent(solidJs.Show, {\n  get when() {\n    return !store.option.scrollMode.enabled;\n  },\n  get children() {\n    return web.createComponent(SettingsItemNumber, {\n      get name() {\n        return helper.t('setting.option.zoom');\n      },\n      maxLength: 3,\n      suffix: \"%\",\n      step: 5,\n      onChange: val => Number.isNaN(val) || zoom(val),\n      get value() {\n        return Math.round(store.option.zoom.ratio);\n      }\n    });\n  }\n})]], [helper.t('setting.option.paragraph_hotkeys'), SettingHotkeys, true], [helper.t('setting.option.img_recognition'), () => [web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('other.enabled');\n  },\n  get value() {\n    return store.option.imgRecognition.enabled;\n  },\n  onChange: () => setOption((draftOption, state) => {\n    const enabled = !draftOption.imgRecognition.enabled;\n    draftOption.imgRecognition.enabled = enabled;\n    if (!enabled) return;\n    for (const img of Object.values(state.imgMap)) if (!img.blobUrl) img.loadType = 'wait';\n    updateImgLoadType();\n  })\n}), web.createComponent(solidJs.Show, {\n  when: typeof Worker === 'undefined',\n  get children() {\n    var _el$2 = web.template(`<blockquote><p>`)(),\n      _el$3 = _el$2.firstChild;\n    web.effect(() => _el$3.innerHTML = helper.t('setting.option.img_recognition_warn'));\n    return _el$2;\n  }\n}), web.createComponent(solidJs.Show, {\n  get when() {\n    return !store.supportWorker;\n  },\n  get children() {\n    var _el$4 = web.template(`<blockquote><p>`)(),\n      _el$5 = _el$4.firstChild;\n    web.effect(() => _el$5.innerHTML = helper.t('setting.option.img_recognition_warn_2'));\n    return _el$4;\n  }\n}), web.createComponent(SettingsShowItem, {\n  get when() {\n    return store.option.imgRecognition.enabled;\n  },\n  get children() {\n    return [web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('setting.option.img_recognition_background');\n      },\n      get value() {\n        return store.option.imgRecognition.background;\n      },\n      onChange: () => setOption((draftOption, state) => {\n        const enabled = !draftOption.imgRecognition.background;\n        draftOption.imgRecognition.background = enabled;\n        if (!enabled) return;\n        for (const img of Object.values(state.imgMap)) {\n          if (img.background === undefined && img.loadType === 'loaded') handleImgRecognition(getImgEle(img.src), img.src);\n        }\n      })\n    }), web.createComponent(SettingsItemSwitch, {\n      get name() {\n        return helper.t('setting.option.img_recognition_pageFill');\n      },\n      get value() {\n        return store.option.imgRecognition.pageFill;\n      },\n      onChange: () => setOption((draftOption, state) => {\n        const enabled = !draftOption.imgRecognition.pageFill;\n        draftOption.imgRecognition.pageFill = enabled;\n        if (!enabled) return;\n        for (const img of Object.values(state.imgMap)) {\n          if (img.blankMargin === undefined && img.loadType === 'loaded') handleImgRecognition(getImgEle(img.src), img.src);\n        }\n      })\n    })];\n  }\n})], true], [helper.t('setting.option.paragraph_translation'), SettingTranslation, true], [helper.t('setting.option.paragraph_other'), () => [web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.always_load_all_img');\n  },\n  get value() {\n    return store.option.alwaysLoadAllImg;\n  },\n  get onChange() {\n    return createStateSetFn('alwaysLoadAllImg');\n  }\n}), web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.first_page_fill');\n  },\n  get value() {\n    return store.option.firstPageFill;\n  },\n  get onChange() {\n    return createStateSetFn('firstPageFill');\n  }\n}), web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.show_comments');\n  },\n  get value() {\n    return store.option.showComment;\n  },\n  get onChange() {\n    return createStateSetFn('showComment');\n  }\n}), web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.swap_page_turn_key');\n  },\n  get value() {\n    return store.option.swapPageTurnKey;\n  },\n  get onChange() {\n    return createStateSetFn('swapPageTurnKey');\n  }\n}), web.createComponent(SettingsItemSwitch, {\n  get name() {\n    return helper.t('setting.option.autoHiddenMouse');\n  },\n  get value() {\n    return store.option.autoHiddenMouse;\n  },\n  get onChange() {\n    return createStateSetFn('autoHiddenMouse');\n  }\n}), web.createComponent(SettingsItemNumber, {\n  get name() {\n    return helper.t('setting.option.preload_page_num');\n  },\n  maxLength: 5,\n  onChange: val => {\n    if (Number.isNaN(val)) return;\n    setOption(draftOption => {\n      draftOption.preloadPageNum = helper.clamp(0, val, 99_999);\n    });\n  },\n  get value() {\n    return store.option.preloadPageNum;\n  }\n}), web.createComponent(SettingsItem, {\n  get name() {\n    return helper.t('setting.option.background_color');\n  },\n  get children() {\n    var _el$6 = web.template(`<input type=color>`)();\n    web.addEventListener(_el$6, \"input\", helper.throttle(e => {\n      if (!e.target.value) return;\n      setOption(draftOption => {\n        // 在拉到纯黑或纯白时改回初始值\n        draftOption.customBackground = e.target.value === '#000000' || e.target.value === '#ffffff' ? undefined : e.target.value;\n        if (draftOption.customBackground) draftOption.darkMode = helper.needDarkMode(draftOption.customBackground);\n      });\n    }, 20));\n    _el$6.style.setProperty(\"width\", \"2em\");\n    _el$6.style.setProperty(\"margin-right\", \".4em\");\n    web.effect(() => _el$6.value = store.option.customBackground ?? (store.option.darkMode ? '#000000' : '#ffffff'));\n    return _el$6;\n  }\n}), web.createComponent(SettingsItemSelect, {\n  get name() {\n    return helper.t('setting.language');\n  },\n  options: [['zh', '中文'], ['en', 'English'], ['ru', 'Русский']],\n  get value() {\n    return helper.lang();\n  },\n  onChange: helper.setLang\n})], true]];\n\n/** 阻止事件冒泡 */\nconst stopPropagation = e => {\n  e.stopPropagation();\n};\n\n/** 从头开始播放元素的动画 */\nconst playAnimation = e => {\n  if (!e) return;\n  for (const animation of e.getAnimations()) {\n    animation.cancel();\n    animation.play();\n  }\n};\n\n\n/** 判断滚动事件是否会导致滚动 */\nconst canScroll = (e, container) => {\n  const {\n    scrollHeight,\n    clientHeight,\n    scrollTop\n  } = container;\n  return scrollHeight > clientHeight && (e.deltaY < 0 && scrollTop > 0 || e.deltaY > 0 && Math.ceil(scrollTop) < scrollHeight - clientHeight);\n};\n\n/** 菜单面板 */\nconst SettingPanel = () => {\n  const settingList = helper.createRootMemo(() => store.prop.editSettingList(defaultSettingList()));\n  return (() => {\n    var _el$ = web.template(`<div>`)();\n    web.addEventListener(_el$, \"click\", stopPropagation);\n    web.addEventListener(_el$, \"scroll\", stopPropagation);\n    _el$.addEventListener(\"wheel\", e => canScroll(e, refs.settingPanel) && e.stopPropagation());\n    var _ref$ = bindRef('settingPanel');\n    typeof _ref$ === \"function\" && web.use(_ref$, _el$);\n    web.insert(_el$, web.createComponent(solidJs.For, {\n      get each() {\n        return settingList();\n      },\n      children: ([name, SettingItem, hidden], i) => {\n        const [show, setShwo] = solidJs.createSignal(!hidden);\n        return [web.memo(() => web.memo(() => !!i())() ? web.template(`<hr>`)() : null), (() => {\n          var _el$2 = web.template(`<div><div></div><div>`)(),\n            _el$3 = _el$2.firstChild,\n            _el$4 = _el$3.nextSibling;\n          web.addEventListener(_el$3, \"click\", () => setShwo(prev => !prev));\n          web.insert(_el$3, name, null);\n          web.insert(_el$3, () => show() ? null : ' …', null);\n          web.insert(_el$4, web.createComponent(SettingItem, {}));\n          web.effect(_p$ => {\n            var _v$3 = modules_c21c94f2$1.SettingBlock,\n              _v$4 = show(),\n              _v$5 = modules_c21c94f2$1.SettingBlockSubtitle,\n              _v$6 = modules_c21c94f2$1.SettingBlockBody;\n            _v$3 !== _p$.e && web.className(_el$2, _p$.e = _v$3);\n            _v$4 !== _p$.t && web.setAttribute(_el$2, \"data-show\", _p$.t = _v$4);\n            _v$5 !== _p$.a && web.className(_el$3, _p$.a = _v$5);\n            _v$6 !== _p$.o && web.className(_el$4, _p$.o = _v$6);\n            return _p$;\n          }, {\n            e: undefined,\n            t: undefined,\n            a: undefined,\n            o: undefined\n          });\n          return _el$2;\n        })()];\n      }\n    }));\n    web.effect(_p$ => {\n      var _v$ = `${modules_c21c94f2$1.SettingPanel} ${modules_c21c94f2$1.beautifyScrollbar}`,\n        _v$2 = helper.lang() === 'zh' ? '15em' : '20em';\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && ((_p$.t = _v$2) != null ? _el$.style.setProperty(\"width\", _v$2) : _el$.style.removeProperty(\"width\"));\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined\n    });\n    return _el$;\n  })();\n};\n\n/** 工具栏按钮分隔栏 */\nconst buttonListDivider = () => (() => {\n  var _el$ = web.template(`<div>`)();\n  _el$.style.setProperty(\"height\", \"1em\");\n  return _el$;\n})();\nconst ZoomButton = () => web.createComponent(IconButton, {\n  get tip() {\n    return web.memo(() => store.option.zoom.ratio === 100)() ? helper.t('button.zoom_in') : helper.t('button.zoom_out');\n  },\n  get enabled() {\n    return store.option.zoom.ratio !== 100;\n  },\n  onClick: () => doubleClickZoom(),\n  get children() {\n    return web.createComponent(solidJs.Show, {\n      get when() {\n        return store.option.zoom.ratio === 100;\n      },\n      get fallback() {\n        return web.createComponent(MdZoomOut, {});\n      },\n      get children() {\n        return web.createComponent(MdZoomIn, {});\n      }\n    });\n  }\n});\n\n/** 工具栏的默认按钮列表 */\nconst defaultButtonList = [\n// 单双页模式\n() => web.createComponent(IconButton, {\n  get tip() {\n    return web.memo(() => !!isOnePageMode())() ? helper.t('button.page_mode_single') : helper.t('button.page_mode_double');\n  },\n  get hidden() {\n    return store.isMobile || store.option.scrollMode.enabled;\n  },\n  onClick: switchOnePageMode,\n  get children() {\n    return web.memo(() => !!isOnePageMode())() ? web.createComponent(MdLooksOne, {}) : web.createComponent(MdLooksTwo, {});\n  }\n}),\n// 卷轴模式\n() => web.createComponent(IconButton, {\n  get tip() {\n    return helper.t('button.scroll_mode');\n  },\n  get enabled() {\n    return store.option.scrollMode.enabled;\n  },\n  onClick: switchScrollMode,\n  get children() {\n    return web.createComponent(MdViewDay, {});\n  }\n}),\n// 页面填充\n() => web.createComponent(IconButton, {\n  get tip() {\n    return helper.t('button.page_fill');\n  },\n  get enabled() {\n    return Boolean(store.fillEffect[nowFillIndex()]);\n  },\n  get hidden() {\n    return isOnePageMode();\n  },\n  onClick: switchFillEffect,\n  get children() {\n    return web.createComponent(MdQueue, {});\n  }\n}),\n// 网格模式\n() => web.createComponent(IconButton, {\n  get tip() {\n    return helper.t('button.grid_mode');\n  },\n  get enabled() {\n    return store.gridMode;\n  },\n  onClick: switchGridMode,\n  get children() {\n    return web.createComponent(MdGrid, {});\n  }\n}), buttonListDivider,\n// 放大模式\n() => web.createComponent(solidJs.Show, {\n  get when() {\n    return store.option.scrollMode.enabled;\n  },\n  get fallback() {\n    return web.createComponent(ZoomButton, {});\n  },\n  get children() {\n    return [web.createComponent(IconButton, {\n      get tip() {\n        return helper.t('button.zoom_in');\n      },\n      get enabled() {\n        return store.option.scrollMode.imgScale >= 3;\n      },\n      onClick: () => zoomScrollModeImg(0.05),\n      get children() {\n        return web.createComponent(MdZoomIn, {});\n      }\n    }), web.createComponent(IconButton, {\n      get tip() {\n        return helper.t('button.zoom_out');\n      },\n      get enabled() {\n        return store.option.scrollMode.imgScale <= 0.1;\n      },\n      onClick: () => zoomScrollModeImg(-0.05),\n      get children() {\n        return web.createComponent(MdZoomOut, {});\n      }\n    })];\n  }\n}),\n// 翻译设置\n() => web.createComponent(IconButton, {\n  get tip() {\n    return web.memo(() => !!isTranslatingImage())() ? helper.t('button.close_current_page_translation') : helper.t('button.translate_current_page');\n  },\n  get enabled() {\n    return isTranslatingImage();\n  },\n  get hidden() {\n    return store.option.translation.server === 'disable';\n  },\n  onClick: translateCurrent,\n  get children() {\n    return web.createComponent(MdTranslate, {});\n  }\n}),\n// 设置\n() => {\n  const [showPanel, setShowPanel] = solidJs.createSignal(false);\n  const handleClick = () => {\n    const _showPanel = !showPanel();\n    _setState('show', 'toolbar', _showPanel);\n    setShowPanel(_showPanel);\n  };\n  helper.createEffectOn(() => store.show.toolbar, showToolbar => showToolbar || setShowPanel(false));\n  const popper = solidJs.createMemo(() => [web.createComponent(SettingPanel, {}), (() => {\n    var _el$2 = web.template(`<div role=button tabindex=-1>`)();\n    _el$2.addEventListener(\"wheel\", e => {\n      if (isScrollMode()) refs.mangaBox.scrollBy({\n        top: e.deltaY\n      });\n    });\n    web.addEventListener(_el$2, \"click\", handleClick);\n    web.effect(() => web.className(_el$2, modules_c21c94f2$1.closeCover));\n    return _el$2;\n  })()]);\n  return web.createComponent(IconButton, {\n    get tip() {\n      return helper.t('button.setting');\n    },\n    get enabled() {\n      return showPanel();\n    },\n    get showTip() {\n      return showPanel();\n    },\n    onClick: handleClick,\n    get popperClassName() {\n      return showPanel() && modules_c21c94f2$1.SettingPanelPopper;\n    },\n    get popper() {\n      return web.memo(() => !!showPanel())() && popper();\n    },\n    get children() {\n      return web.createComponent(MdSettings, {});\n    }\n  });\n}];\n\n\n/** 左侧工具栏 */\nconst Toolbar = () => {\n  helper.createEffectOn(() => store.show.toolbar, show => show || focus());\n  return (() => {\n    var _el$ = web.template(`<div role=toolbar><div><div>`)(),\n      _el$2 = _el$.firstChild,\n      _el$3 = _el$2.firstChild;\n    web.addEventListener(_el$2, \"click\", focus);\n    web.insert(_el$2, web.createComponent(solidJs.For, {\n      get each() {\n        return store.prop.editButtonList(defaultButtonList);\n      },\n      children: ButtonItem => web.createComponent(ButtonItem, {})\n    }), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2$1.toolbar,\n        _v$2 = helper.boolDataVal(store.show.toolbar),\n        _v$3 = helper.boolDataVal(store.isMobile && store.gridMode),\n        _v$4 = store.isDragMode ? 'none' : undefined,\n        _v$5 = modules_c21c94f2$1.toolbarPanel,\n        _v$6 = modules_c21c94f2$1.toolbarBg;\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"data-show\", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$, \"data-close\", _p$.a = _v$3);\n      _v$4 !== _p$.o && ((_p$.o = _v$4) != null ? _el$.style.setProperty(\"pointer-events\", _v$4) : _el$.style.removeProperty(\"pointer-events\"));\n      _v$5 !== _p$.i && web.className(_el$2, _p$.i = _v$5);\n      _v$6 !== _p$.n && web.className(_el$3, _p$.n = _v$6);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined\n    });\n    return _el$;\n  })();\n};\n\nconst getScrollbarPage = (img, i, double = false) => {\n  let num;\n  if (store.option.scrollMode.enabled) num = getImg(i).size.height;else num = double ? 2 : 1;\n  return {\n    num,\n    loadType: img.loadType,\n    isNull: !img.src,\n    translationType: img.translationType\n  };\n};\nconst ScrollbarPage = props => {\n  const flexBasis = solidJs.createMemo(() => props.num / (store.option.scrollMode.enabled ? contentHeight() : store.imgList.length));\n  return (() => {\n    var _el$ = web.template(`<div>`)();\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2$1.scrollbarPage,\n        _v$2 = `${flexBasis() * 100}%`,\n        _v$3 = props.loadType,\n        _v$4 = helper.boolDataVal(props.isNull),\n        _v$5 = props.translationType;\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && ((_p$.t = _v$2) != null ? _el$.style.setProperty(\"flex-basis\", _v$2) : _el$.style.removeProperty(\"flex-basis\"));\n      _v$3 !== _p$.a && web.setAttribute(_el$, \"data-type\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.setAttribute(_el$, \"data-null\", _p$.o = _v$4);\n      _v$5 !== _p$.i && web.setAttribute(_el$, \"data-translation-type\", _p$.i = _v$5);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined\n    });\n    return _el$;\n  })();\n};\n\n/** 显示对应图片加载情况的元素 */\nconst ScrollbarPageStatus = () => {\n  // 将相同类型的页面合并显示\n  const scrollbarPageList = helper.createThrottleMemo(() => {\n    if (store.pageList.length === 0) return [];\n    const list = [];\n    let item;\n    const handleImg = (i, double = false) => {\n      const img = getImg(i);\n      if (!item) {\n        item = getScrollbarPage(img, i, double);\n        return;\n      }\n      if (img.loadType === item.loadType && !img.src === item.isNull && img.translationType === item.translationType) {\n        if (store.option.scrollMode.enabled) item.num += img.size.height;else item.num += double ? 2 : 1;\n      } else {\n        list.push(item);\n        item = getScrollbarPage(img, i, double);\n      }\n    };\n    for (let i = 0; i < store.pageList.length; i++) {\n      const [a, b] = store.pageList[i];\n      if (b === undefined) handleImg(a, !isOnePageMode());else if (a === -1) {\n        handleImg(b);\n        handleImg(b);\n      } else if (b === -1) {\n        handleImg(a);\n        handleImg(a);\n      } else {\n        handleImg(a);\n        handleImg(b);\n      }\n    }\n    if (item) list.push(item);\n    return list;\n  }, 200);\n  return web.createComponent(solidJs.For, {\n    get each() {\n      return scrollbarPageList();\n    },\n    children: page => web.createComponent(ScrollbarPage, page)\n  });\n};\n\n\n/** 滚动条 */\nconst Scrollbar = () => {\n  solidJs.onMount(() => {\n    helper.useDrag({\n      ref: refs.scrollbar,\n      handleDrag: handleScrollbarSlider,\n      easyMode: () => isScrollMode() && store.option.scrollbar.easyScroll\n    });\n    watchDomSize('scrollbarSize', refs.scrollbar);\n  });\n\n  // 在被滚动时使自身可穿透，以便在卷轴模式下触发页面的滚动\n  const [penetrate, setPenetrate] = solidJs.createSignal(false);\n  const resetPenetrate = helper.debounce(() => setPenetrate(false));\n  const handleWheel = () => {\n    setPenetrate(true);\n    resetPenetrate();\n  };\n\n  /** 是否强制显示滚动条 */\n  const showScrollbar = solidJs.createMemo(() => store.show.scrollbar || Boolean(penetrate()));\n\n  /** 滚动条提示文本 */\n  const tipText = helper.createThrottleMemo(() => {\n    if (store.showRange[0] === store.showRange[1]) return getPageTip(store.showRange[0]);\n\n    /** 并排卷轴模式下的滚动条提示文本 */\n    if (isAbreastMode()) {\n      const columns = abreastArea().columns.slice(abreastShowColumn().start, abreastShowColumn().end + 1).map(column => column.map(getPageTip));\n      if (store.option.dir !== 'rtl') columns.reverse();\n      return columns.map(column => column.join(' ')).join('\\n');\n    }\n    const tipList = [];\n    for (let i = store.showRange[0]; i <= store.showRange[1]; i++) tipList.push(getPageTip(i));\n    if (isOnePageMode()) return tipList.join('\\n');\n    if (tipList.length === 1) return tipList[0];\n    if (store.option.dir === 'rtl') tipList.reverse();\n    return tipList.join('   ');\n  });\n  useStyleMemo(`.${modules_c21c94f2$1.scrollbar}`, {\n    'pointer-events': () => penetrate() || store.isDragMode || store.gridMode ? 'none' : 'auto',\n    '--scroll-length': () => `${scrollDomLength()}px`,\n    '--slider-midpoint': () => `${sliderMidpoint()}px`,\n    '--slider-height': () => `${sliderHeight() * scrollDomLength()}px`,\n    '--slider-top': sliderTop\n  });\n  const _Scrollbar = props => (() => {\n    var _el$ = web.template(`<div role=scrollbar tabindex=-1>`)();\n    _el$.addEventListener(\"wheel\", handleWheel);\n    var _ref$ = props.ref;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$) : props.ref = _el$;\n    web.insert(_el$, () => props.children);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2$1.scrollbar,\n        _v$2 = modules_c21c94f2$1.mangaFlow,\n        _v$3 = store.activePageIndex || -1,\n        _v$4 = helper.boolDataVal(store.option.scrollbar.autoHidden),\n        _v$5 = helper.boolDataVal(showScrollbar()),\n        _v$6 = store.option.dir,\n        _v$7 = scrollPosition(),\n        _v$8 = helper.boolDataVal(isAbreastMode()),\n        _v$9 = helper.boolDataVal(isDrag()),\n        _v$10 = props.style;\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"aria-controls\", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$, \"aria-valuenow\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.setAttribute(_el$, \"data-auto-hidden\", _p$.o = _v$4);\n      _v$5 !== _p$.i && web.setAttribute(_el$, \"data-force-show\", _p$.i = _v$5);\n      _v$6 !== _p$.n && web.setAttribute(_el$, \"data-dir\", _p$.n = _v$6);\n      _v$7 !== _p$.s && web.setAttribute(_el$, \"data-position\", _p$.s = _v$7);\n      _v$8 !== _p$.h && web.setAttribute(_el$, \"data-is-abreast-mode\", _p$.h = _v$8);\n      _v$9 !== _p$.r && web.setAttribute(_el$, \"data-drag\", _p$.r = _v$9);\n      _p$.d = web.style(_el$, _v$10, _p$.d);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined,\n      s: undefined,\n      h: undefined,\n      r: undefined,\n      d: undefined\n    });\n    return _el$;\n  })();\n  return [web.createComponent(_Scrollbar, {\n    ref(r$) {\n      var _ref$2 = bindRef('scrollbar');\n      typeof _ref$2 === \"function\" && _ref$2(r$);\n    },\n    get children() {\n      return [(() => {\n        var _el$2 = web.template(`<div>`)();\n        web.insert(_el$2, tipText);\n        web.effect(() => web.className(_el$2, modules_c21c94f2$1.scrollbarPoper));\n        return _el$2;\n      })(), web.createComponent(solidJs.Show, {\n        get when() {\n          return store.option.scrollbar.showImgStatus;\n        },\n        get children() {\n          return web.createComponent(ScrollbarPageStatus, {});\n        }\n      })];\n    }\n  }), web.createComponent(_Scrollbar, {\n    style: {\n      'mix-blend-mode': 'difference',\n      'pointer-events': 'none'\n    },\n    get children() {\n      var _el$3 = web.template(`<div>`)();\n      web.effect(_p$ => {\n        var _v$11 = modules_c21c94f2$1.scrollbarSlider,\n          _v$12 = {\n            [modules_c21c94f2$1.hidden]: store.gridMode\n          };\n        _v$11 !== _p$.e && web.className(_el$3, _p$.e = _v$11);\n        _p$.t = web.classList(_el$3, _v$12, _p$.t);\n        return _p$;\n      }, {\n        e: undefined,\n        t: undefined\n      });\n      return _el$3;\n    }\n  })];\n};\n\nlet delayTypeTimer = 0;\nconst EndPage = () => {\n  const handleClick = e => {\n    e.stopPropagation();\n    if (e.target?.nodeName !== 'BUTTON') _setState('show', 'endPage', undefined);\n    focus();\n  };\n  let ref;\n  solidJs.onMount(() => {\n    ref.addEventListener('wheel', e => {\n      e.preventDefault();\n      e.stopPropagation();\n      turnPage(e.deltaY > 0 ? 'next' : 'prev');\n    }, {\n      passive: false\n    });\n  });\n\n  // state.show.endPage 变量的延时版本，在隐藏的动画效果结束之后才会真正改变\n  // 防止在动画效果结束前 tip 就消失或改变了位置\n  const [delayType, setDelayType] = solidJs.createSignal();\n  solidJs.createEffect(() => {\n    if (store.show.endPage) {\n      window.clearTimeout(delayTypeTimer);\n      setDelayType(store.show.endPage);\n    } else {\n      delayTypeTimer = window.setTimeout(() => setDelayType(store.show.endPage), 500);\n    }\n  });\n  const tip = solidJs.createMemo(() => {\n    switch (delayType()) {\n      case 'start':\n        if (store.prop.Prev && store.option.jumpToNext) return helper.t('end_page.tip.start_jump');\n        break;\n      case 'end':\n        if (store.prop.Next && store.option.jumpToNext) return helper.t('end_page.tip.end_jump');\n        if (store.prop.Exit) return helper.t('end_page.tip.exit');\n        break;\n    }\n    return '';\n  });\n  return (() => {\n    var _el$ = web.template(`<div role=button tabindex=-1><p></p><button type=button></button><button type=button data-is-end></button><button type=button>`)(),\n      _el$2 = _el$.firstChild,\n      _el$3 = _el$2.nextSibling,\n      _el$4 = _el$3.nextSibling,\n      _el$5 = _el$4.nextSibling;\n    web.addEventListener(_el$, \"click\", handleClick);\n    var _ref$ = ref;\n    typeof _ref$ === \"function\" ? web.use(_ref$, _el$) : ref = _el$;\n    web.insert(_el$2, tip);\n    web.addEventListener(_el$3, \"click\", () => store.prop.Prev?.());\n    var _ref$2 = bindRef('prev');\n    typeof _ref$2 === \"function\" && web.use(_ref$2, _el$3);\n    web.insert(_el$3, () => helper.t('end_page.prev_button'));\n    web.addEventListener(_el$4, \"click\", () => store.prop.Exit?.(store.show.endPage === 'end'));\n    var _ref$3 = bindRef('exit');\n    typeof _ref$3 === \"function\" && web.use(_ref$3, _el$4);\n    web.insert(_el$4, () => helper.t('button.exit'));\n    web.addEventListener(_el$5, \"click\", () => store.prop.Next?.());\n    var _ref$4 = bindRef('next');\n    typeof _ref$4 === \"function\" && web.use(_ref$4, _el$5);\n    web.insert(_el$5, () => helper.t('end_page.next_button'));\n    web.insert(_el$, web.createComponent(solidJs.Show, {\n      get when() {\n        return web.memo(() => !!store.option.showComment)() && delayType() === 'end';\n      },\n      get children() {\n        var _el$6 = web.template(`<div>`)();\n        web.addEventListener(_el$6, \"wheel\", stopPropagation);\n        web.insert(_el$6, web.createComponent(solidJs.For, {\n          get each() {\n            return store.commentList;\n          },\n          children: comment => (() => {\n            var _el$7 = web.template(`<p>`)();\n            web.insert(_el$7, comment);\n            return _el$7;\n          })()\n        }));\n        web.effect(() => web.className(_el$6, `${modules_c21c94f2$1.comments} ${modules_c21c94f2$1.beautifyScrollbar}`));\n        return _el$6;\n      }\n    }), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2$1.endPage,\n        _v$2 = store.show.endPage,\n        _v$3 = delayType(),\n        _v$4 = dir() === 'rtl' ? 'row-reverse' : undefined,\n        _v$5 = modules_c21c94f2$1.tip,\n        _v$6 = {\n          [modules_c21c94f2$1.invisible]: !store.prop.Prev\n        },\n        _v$7 = store.show.endPage ? 0 : -1,\n        _v$8 = store.show.endPage ? 0 : -1,\n        _v$9 = {\n          [modules_c21c94f2$1.invisible]: !store.prop.Next\n        },\n        _v$10 = store.show.endPage ? 0 : -1;\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"data-show\", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$, \"data-type\", _p$.a = _v$3);\n      _v$4 !== _p$.o && ((_p$.o = _v$4) != null ? _el$.style.setProperty(\"flex-direction\", _v$4) : _el$.style.removeProperty(\"flex-direction\"));\n      _v$5 !== _p$.i && web.className(_el$2, _p$.i = _v$5);\n      _p$.n = web.classList(_el$3, _v$6, _p$.n);\n      _v$7 !== _p$.s && web.setAttribute(_el$3, \"tabindex\", _p$.s = _v$7);\n      _v$8 !== _p$.h && web.setAttribute(_el$4, \"tabindex\", _p$.h = _v$8);\n      _p$.r = web.classList(_el$5, _v$9, _p$.r);\n      _v$10 !== _p$.d && web.setAttribute(_el$5, \"tabindex\", _p$.d = _v$10);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined,\n      s: undefined,\n      h: undefined,\n      r: undefined,\n      d: undefined\n    });\n    return _el$;\n  })();\n};\n\nconst createComicImg = src => ({\n  src,\n  loadType: 'wait',\n  size: placeholderSize(),\n  blobUrl: src.startsWith('blob:') ? src : undefined\n});\nconst useInit = props => {\n  watchDomSize('rootSize', refs.root);\n  const updateOption = state => {\n    state.option = props.option ? helper.assign(state.defaultOption, props.option) : state.defaultOption;\n  };\n  const watchProps = {\n    option: updateOption,\n    defaultOption(state) {\n      state.defaultOption = helper.assign(defaultOption(), props.defaultOption);\n      updateOption(state);\n    },\n    fillEffect(state) {\n      state.fillEffect = props.fillEffect ?? {\n        '-1': true\n      };\n      updatePageData(state);\n    },\n    onExit(state) {\n      state.prop.Exit = isEnd => {\n        playAnimation(refs.exit);\n        props.onExit?.(Boolean(isEnd));\n        setState(draftState => {\n          if (isEnd) draftState.activePageIndex = 0;\n          draftState.show.endPage = undefined;\n        });\n      };\n    },\n    onPrev(state) {\n      state.prop.Prev = props.onPrev ? helper.throttle(() => {\n        playAnimation(refs.prev);\n        props.onPrev?.();\n      }, 1000) : undefined;\n    },\n    onNext(state) {\n      state.prop.Next = props.onNext ? helper.throttle(() => {\n        playAnimation(refs.next);\n        props.onNext?.();\n      }, 1000) : undefined;\n    },\n    editButtonList(state) {\n      state.prop.editButtonList = props.editButtonList ?? (list => list);\n    },\n    editSettingList(state) {\n      state.prop.editSettingList = props.editSettingList ?? (list => list);\n    },\n    onLoading(state) {\n      state.prop.Loading = props.onLoading ? helper.debounce(props.onLoading) : undefined;\n    },\n    onOptionChange(state) {\n      state.prop.OptionChange = props.onOptionChange ? helper.debounce(props.onOptionChange) : undefined;\n    },\n    onHotkeysChange(state) {\n      state.prop.HotkeysChange = props.onHotkeysChange ? helper.debounce(props.onHotkeysChange) : undefined;\n    },\n    commentList(state) {\n      state.commentList = props.commentList;\n    },\n    title(state) {\n      state.title = props.title ?? '';\n    }\n  };\n  for (const [key, fn] of Object.entries(watchProps)) {\n    solidJs.createEffect(solidJs.on(() => props[key], () => setState(fn)));\n  }\n  solidJs.createEffect(() => {\n    setState(state => {\n      state.hotkeys = {\n        ...JSON.parse(JSON.stringify(defaultHotkeys())),\n        ...props.hotkeys\n      };\n    });\n  });\n  const handleImgList = () => {\n    setState(state => {\n      // 使用相对协议路径，防止 Mixed Content 报错\n      const imgList = props.imgList.map(url => url?.replace(/^http:/, ''));\n      state.show.endPage = undefined;\n\n      /** 修改前的当前显示图片 */\n      const oldActiveImg = state.pageList[state.activePageIndex]?.map(i => state.imgList?.[i]) ?? [];\n\n      /** 是否需要重置页面填充 */\n      let needResetFillEffect = false;\n      const fillEffectList = Object.keys(state.fillEffect).map(Number);\n      for (const pageIndex of fillEffectList) {\n        if (pageIndex === -1) continue;\n        if (state.imgList[pageIndex] === imgList[pageIndex]) continue;\n        needResetFillEffect = true;\n        break;\n      }\n      const newImgList = new Set(imgList);\n      const oldImgList = new Set(state.imgList);\n\n      /** 被删除的图片 */\n      const deleteList = [...oldImgList].filter(url => !newImgList.has(url));\n      for (const url of deleteList) if (state.imgMap[url].blobUrl && state.imgMap[url].blobUrl !== url) URL.revokeObjectURL(state.imgMap[url].blobUrl);\n\n      /** 删除图片数 */\n      const deleteNum = deleteList.length;\n\n      /** 传入的是否是新漫画 */\n      const isNew = deleteNum === oldImgList.size; // 旧图一张不剩才算是新漫画\n\n      /** 是否需要更新页面 */\n      const needUpdatePageData = needResetFillEffect || state.imgList.length !== imgList.length || deleteNum > 0;\n      const newImgMap = {};\n      for (const url of imgList) newImgMap[url] = state.imgMap[url] ?? createComicImg(url);\n      state.imgMap = newImgMap;\n      state.imgList = imgList;\n      state.prop.Loading?.(state.imgList.map(url => state.imgMap[url]));\n      if (isNew || needResetFillEffect) state.fillEffect = props.fillEffect ?? {\n        '-1': true\n      };\n      if (isNew || needUpdatePageData) {\n        updatePageData(state);\n\n        // 当前位于最后一页时最后一页被删的处理\n        if (state.activePageIndex >= state.pageList.length) state.activePageIndex = state.pageList.length - 1;\n        updateShowRange(state);\n      }\n      if (isNew || state.pageList.length === 0) {\n        resetImgState(state);\n        state.activePageIndex = 0;\n        scrollTo(0);\n        return;\n      }\n\n      // 尽量使当前显示的图片在修改后依然不变\n      oldActiveImg.some(url => {\n        // 跳过填充页和已被删除的图片\n        if (!url || imgList.includes(url)) return false;\n        const newPageIndex = state.pageList.findIndex(page => page.some(index => state.imgList?.[index] === url));\n        if (newPageIndex === -1) return false;\n        state.activePageIndex = newPageIndex;\n        return true;\n      });\n\n      // 如果已经翻到了最后一页，且最后一页的图片被删掉了，那就保持在末页显示\n      if (state.activePageIndex > state.pageList.length - 1) state.activePageIndex = state.pageList.length - 1;\n    });\n  };\n\n  // 处理 imgList 参数的初始化和修改\n  helper.createEffectOn(helper.createRootMemo(() => props.imgList), helper.throttle(handleImgList, 500));\n\n  // 通过手动创建一个 Worker 来检测是否支持 Worker，避免因为 CSP 限制而出错\n  setTimeout(() => {\n    const codeUrl = URL.createObjectURL(new Blob(['self.close();'], {\n      type: 'text/javascript'\n    }));\n    setTimeout(URL.revokeObjectURL, 0, codeUrl);\n    _setState('supportWorker', Boolean(new Worker(codeUrl)));\n  }, 0);\n  focus();\n};\n\n/** 深色模式 */\nconst darkStyle = {\n  '--hover-bg-color': '#FFF3',\n  '--hover-bg-color-enable': '#FFFa',\n  '--switch': '#BDBDBD',\n  '--switch-bg': '#6E6E6E',\n  '--page-bg': '#303030',\n  '--secondary': '#7A909A',\n  '--secondary-bg': '#556065',\n  '--text': 'white',\n  '--text-secondary': '#FFFC',\n  '--text-bg': '#121212',\n  'color-scheme': 'dark'\n};\n\n/** 浅色模式 */\nconst lightStyle = {\n  '--hover-bg-color': '#0001',\n  '--hover-bg-color-enable': '#0009',\n  '--switch': '#FAFAFA',\n  '--switch-bg': '#9C9C9C',\n  '--page-bg': 'white',\n  '--secondary': '#7A909A',\n  '--secondary-bg': '#BAC5CA',\n  '--text': 'black',\n  '--text-secondary': '#0008',\n  '--text-bg': '#FAFAFA',\n  'color-scheme': 'light'\n};\nconst createSvgIcon = (fill, d) => `url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='${fill}' viewBox='0 0 24 24'%3E%3Cpath d='${d}'/%3E%3C/svg%3E\")`;\nconst MdImageNotSupported = `m21.9 21.9-8.49-8.49-9.82-9.82L2.1 2.1.69 3.51 3 5.83V19c0 1.1.9 2 2 2h13.17l2.31 2.31 1.42-1.41zM5 18l3.5-4.5 2.5 3.01L12.17 15l3 3H5zm16 .17L5.83 3H19c1.1 0 2 .9 2 2v13.17z`;\nconst MdCloudDownload = `M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM17 13l-4.65 4.65c-.2.2-.51.2-.71 0L7 13h3V9h4v4h3z`;\nconst MdPhoto = `M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86-3 3.87L9 13.14 6 17h12l-3.86-5.14z`;\nconst useCssVar = () => {\n  const svg = () => {\n    const fill = store.option.darkMode ? 'rgb(156,156,156)' : 'rgb(110,110,110)';\n    return {\n      '--md-image-not-supported': `${createSvgIcon(fill, MdImageNotSupported)}`,\n      '--md-cloud-download': `${createSvgIcon(fill, MdCloudDownload)}`,\n      '--md-photo': `${createSvgIcon(fill, MdPhoto)}`\n    };\n  };\n  const i18n = () => ({\n    '--i18n-touch-area-prev': `\"${helper.t('touch_area.prev')}\"`,\n    '--i18n-touch-area-next': `\"${helper.t('touch_area.next')}\"`,\n    '--i18n-touch-area-menu': `\"${helper.t('touch_area.menu')}\"`\n  });\n  useStyleMemo(`.${modules_c21c94f2$1.root}`, [{\n    '--bg': () => `${store.option.customBackground ?? (store.option.darkMode ? '#000' : '#fff')}`,\n    '--scroll-mode-img-scale': () => store.option.scrollMode.imgScale,\n    '--scroll-mode-spacing': () => store.option.scrollMode.spacing\n  }, () => store.option.darkMode ? darkStyle : lightStyle, svg, i18n]);\n};\n\nsolidJs.enableScheduling();\n/** 漫画组件 */\nconst Manga = props => {\n  useStyle(css$1);\n  useCssVar();\n  solidJs.onMount(() => useInit(props));\n  solidJs.createEffect(() => props.show && focus());\n  return (() => {\n    var _el$ = web.template(`<div>`)();\n    web.addEventListener(_el$, \"wheel\", handleWheel);\n    web.addEventListener(_el$, \"mousedown\", handleMouseDown);\n    web.addEventListener(_el$, \"click\", stopPropagation);\n    var _ref$ = bindRef('root');\n    typeof _ref$ === \"function\" && web.use(_ref$, _el$);\n    _el$.addEventListener(\"keydown\", handleKeyDown, true);\n    _el$.addEventListener(\"keypress\", stopPropagation, true);\n    _el$.addEventListener(\"keyup\", stopPropagation, true);\n    web.insert(_el$, web.createComponent(ComicImgFlow, {}), null);\n    web.insert(_el$, web.createComponent(TouchArea, {}), null);\n    web.insert(_el$, web.createComponent(Scrollbar, {}), null);\n    web.insert(_el$, web.createComponent(EndPage, {}), null);\n    web.insert(_el$, web.createComponent(Toolbar, {}), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2$1.root,\n        _v$2 = {\n          [modules_c21c94f2$1.hidden]: props.show === false,\n          [props.class ?? '']: Boolean(props.class),\n          ...props.classList\n        },\n        _v$3 = helper.boolDataVal(store.isMobile),\n        _v$4 = helper.boolDataVal(store.option.scrollMode.enabled),\n        _v$5 = helper.boolDataVal(store.gridMode);\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _p$.t = web.classList(_el$, _v$2, _p$.t);\n      _v$3 !== _p$.a && web.setAttribute(_el$, \"data-mobile\", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.setAttribute(_el$, \"data-scroll-mode\", _p$.o = _v$4);\n      _v$5 !== _p$.i && web.setAttribute(_el$, \"data-grid-mode\", _p$.i = _v$5);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined\n    });\n    return _el$;\n  })();\n};\n\nexports.Manga = Manga;\nexports._setAbreastScrollFill = _setAbreastScrollFill;\nexports._setState = _setState;\nexports.abreastArea = abreastArea;\nexports.abreastColumnWidth = abreastColumnWidth;\nexports.abreastContentWidth = abreastContentWidth;\nexports.abreastScrollFill = abreastScrollFill;\nexports.abreastScrollWidth = abreastScrollWidth;\nexports.abreastShowColumn = abreastShowColumn;\nexports.activeImgIndex = activeImgIndex;\nexports.activePage = activePage;\nexports.autoPageNum = autoPageNum;\nexports.bindRef = bindRef;\nexports.bindScrollTop = bindScrollTop;\nexports.bound = bound;\nexports.buttonListDivider = buttonListDivider;\nexports.checkImgSize = checkImgSize;\nexports.closeScrollLock = closeScrollLock;\nexports.contentHeight = contentHeight;\nexports.createStateSetFn = createStateSetFn;\nexports.createTranslateRange = createTranslateRange;\nexports.defaultHotkeys = defaultHotkeys;\nexports.doubleClickZoom = doubleClickZoom;\nexports.findFillIndex = findFillIndex;\nexports.focus = focus;\nexports.getImg = getImg;\nexports.getImgEle = getImgEle;\nexports.getImgIndex = getImgIndex;\nexports.getImgTip = getImgTip;\nexports.getPageTip = getPageTip;\nexports.handleClick = handleClick;\nexports.handleComicData = handleComicData;\nexports.handleImgError = handleImgError;\nexports.handleImgLoaded = handleImgLoaded;\nexports.handleKeyDown = handleKeyDown;\nexports.handleMangaFlowDrag = handleMangaFlowDrag;\nexports.handleMouseDown = handleMouseDown;\nexports.handlePinchZoom = handlePinchZoom;\nexports.handleScrollModeDrag = handleScrollModeDrag;\nexports.handleScrollbarSlider = handleScrollbarSlider;\nexports.handleTrackpadWheel = handleTrackpadWheel;\nexports.handleWheel = handleWheel;\nexports.handleZoomDrag = handleZoomDrag;\nexports.hotkeysMap = hotkeysMap;\nexports.imgAreaStyle = imgAreaStyle;\nexports.imgList = imgList;\nexports.imgPageMap = imgPageMap;\nexports.imgShowState = imgShowState;\nexports.imgTopList = imgTopList;\nexports.isAbreastMode = isAbreastMode;\nexports.isBottom = isBottom;\nexports.isDrag = isDrag;\nexports.isEnableBg = isEnableBg;\nexports.isOnePageMode = isOnePageMode;\nexports.isScrollMode = isScrollMode;\nexports.isTop = isTop;\nexports.isTranslatingAll = isTranslatingAll;\nexports.isTranslatingImage = isTranslatingImage;\nexports.isTranslatingToEnd = isTranslatingToEnd;\nexports.loadingImgList = loadingImgList;\nexports.nowFillIndex = nowFillIndex;\nexports.pageNum = pageNum;\nexports.placeholderSize = placeholderSize;\nexports.preloadNum = preloadNum;\nexports.renderImgList = renderImgList;\nexports.resetImgState = resetImgState;\nexports.resetPage = resetPage;\nexports.resetUI = resetUI;\nexports.saveScrollProgress = saveScrollProgress;\nexports.scrollDomLength = scrollDomLength;\nexports.scrollLength = scrollLength;\nexports.scrollModTop = scrollModTop;\nexports.scrollPercentage = scrollPercentage;\nexports.scrollPosition = scrollPosition;\nexports.scrollProgress = scrollProgress;\nexports.scrollTo = scrollTo;\nexports.scrollTop = scrollTop;\nexports.scrollViewImg = scrollViewImg;\nexports.setAbreastScrollFill = setAbreastScrollFill;\nexports.setDefaultHotkeys = setDefaultHotkeys;\nexports.setImgTranslationEnbale = setImgTranslationEnbale;\nexports.setIsDrag = setIsDrag;\nexports.setOption = setOption;\nexports.setState = setState;\nexports.showImgList = showImgList;\nexports.sliderHeight = sliderHeight;\nexports.sliderMidpoint = sliderMidpoint;\nexports.sliderTop = sliderTop;\nexports.store = store;\nexports.switchDir = switchDir;\nexports.switchFillEffect = switchFillEffect;\nexports.switchFitToWidth = switchFitToWidth;\nexports.switchGridMode = switchGridMode;\nexports.switchOnePageMode = switchOnePageMode;\nexports.switchScrollMode = switchScrollMode;\nexports.touches = touches;\nexports.translateAll = translateAll;\nexports.translateCurrent = translateCurrent;\nexports.translateToEnd = translateToEnd;\nexports.translationImage = translationImage;\nexports.translatorOptions = translatorOptions;\nexports.turnPage = turnPage;\nexports.turnPageAnimation = turnPageAnimation;\nexports.turnPageFn = turnPageFn;\nexports.updateImgLoadType = updateImgLoadType;\nexports.updateImgSize = updateImgSize;\nexports.updateImgType = updateImgType;\nexports.updatePageData = updatePageData;\nexports.updateShowRange = updateShowRange;\nexports.watchDomSize = watchDomSize;\nexports.zoom = zoom;\nexports.zoomScrollModeImg = zoomScrollModeImg;\n";break;case"components/IconButton":n='\nconst web = require(\'solid-js/web\');\nconst solidJs = require(\'solid-js\');\nconst helper = require(\'helper\');\n\nvar css = ".iconButtonItem____hash_base64_5_{align-items:center;display:flex;position:relative}.iconButton____hash_base64_5_{align-items:center;background-color:initial;border-radius:9999px;border-style:none;color:var(--text,#fff);cursor:pointer;display:flex;font-size:1.5em;height:1.5em;justify-content:center;margin:.1em;outline:none;padding:0;width:1.5em}.iconButton____hash_base64_5_:focus,.iconButton____hash_base64_5_:hover{background-color:var(--hover-bg-color,#fff3)}.iconButton____hash_base64_5_.enabled____hash_base64_5_{background-color:var(--text,#fff);color:var(--text-bg,#121212)}.iconButton____hash_base64_5_.enabled____hash_base64_5_:focus,.iconButton____hash_base64_5_.enabled____hash_base64_5_:hover{background-color:var(--hover-bg-color-enable,#fffa)}.iconButton____hash_base64_5_>svg{width:1em}.iconButtonPopper____hash_base64_5_{align-items:center;background-color:#303030;border-radius:.3em;color:#fff;display:flex;font-size:.8em;opacity:0;padding:.4em .5em;pointer-events:none;position:absolute;top:50%;transform:translateY(-50%);-webkit-user-select:none;user-select:none;white-space:nowrap}.iconButtonPopper____hash_base64_5_[data-placement=right]{left:calc(100% + 1.5em)}.iconButtonPopper____hash_base64_5_[data-placement=right]:before{border-right-color:var(--switch-bg,#6e6e6e);border-right-width:.5em;right:calc(100% + .5em)}.iconButtonPopper____hash_base64_5_[data-placement=left]{right:calc(100% + 1.5em)}.iconButtonPopper____hash_base64_5_[data-placement=left]:before{border-left-color:var(--switch-bg,#6e6e6e);border-left-width:.5em;left:calc(100% + .5em)}.iconButtonPopper____hash_base64_5_:before{background-color:initial;border:.4em solid #0000;content:\\"\\";pointer-events:none;position:absolute;transition:opacity .15s}.iconButtonItem____hash_base64_5_:is(:hover,:focus,[data-show=true]) .iconButtonPopper____hash_base64_5_{opacity:1}.hidden____hash_base64_5_{display:none}";\nvar modules_c21c94f2 = {"iconButtonItem":"iconButtonItem____hash_base64_5_","iconButton":"iconButton____hash_base64_5_","enabled":"enabled____hash_base64_5_","iconButtonPopper":"iconButtonPopper____hash_base64_5_","hidden":"hidden____hash_base64_5_"};\n\n/** 图标按钮 */\nconst IconButton = _props => {\n  const props = solidJs.mergeProps({\n    placement: \'right\'\n  }, _props);\n  let buttonRef;\n  const handleClick = e => {\n    props.onClick?.(e);\n    // 在每次点击后取消焦点\n    buttonRef?.blur();\n  };\n  return (() => {\n    var _el$ = web.template(`<div><button type=button tabindex=0>`)(),\n      _el$2 = _el$.firstChild;\n    web.use(ref => helper.useStyle(css, ref), _el$);\n    web.addEventListener(_el$2, "click", handleClick);\n    var _ref$ = buttonRef;\n    typeof _ref$ === "function" ? web.use(_ref$, _el$2) : buttonRef = _el$2;\n    web.insert(_el$2, () => props.children);\n    web.insert(_el$, (() => {\n      var _c$ = web.memo(() => !!(props.popper || props.tip));\n      return () => _c$() ? (() => {\n        var _el$3 = web.template(`<div>`)();\n        web.insert(_el$3, () => props.popper || props.tip);\n        web.effect(_p$ => {\n          var _v$6 = [modules_c21c94f2.iconButtonPopper, props.popperClassName].join(\' \'),\n            _v$7 = props.placement;\n          _v$6 !== _p$.e && web.className(_el$3, _p$.e = _v$6);\n          _v$7 !== _p$.t && web.setAttribute(_el$3, "data-placement", _p$.t = _v$7);\n          return _p$;\n        }, {\n          e: undefined,\n          t: undefined\n        });\n        return _el$3;\n      })() : null;\n    })(), null);\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2.iconButtonItem,\n        _v$2 = props.showTip,\n        _v$3 = props.tip,\n        _v$4 = modules_c21c94f2.iconButton,\n        _v$5 = {\n          [modules_c21c94f2.hidden]: props.hidden,\n          [modules_c21c94f2.enabled]: props.enabled\n        };\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, "data-show", _p$.t = _v$2);\n      _v$3 !== _p$.a && web.setAttribute(_el$2, "aria-label", _p$.a = _v$3);\n      _v$4 !== _p$.o && web.className(_el$2, _p$.o = _v$4);\n      _p$.i = web.classList(_el$2, _v$5, _p$.i);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined\n    });\n    return _el$;\n  })();\n};\n\nexports.IconButton = IconButton;\n';break;case"components/Fab":n='\nconst web = require(\'solid-js/web\');\nconst solidJs = require(\'solid-js\');\nconst helper = require(\'helper\');\n\nconst MdMenuBook = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24"stroke=currentColor fill=currentColor stroke-width=0><path d="M17.5 4.5c-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5-1.45 0-2.99.22-4.28.79C1.49 5.62 1 6.33 1 7.14v11.28c0 1.3 1.22 2.26 2.48 1.94.98-.25 2.02-.36 3.02-.36 1.56 0 3.22.26 4.56.92.6.3 1.28.3 1.87 0 1.34-.67 3-.92 4.56-.92 1 0 2.04.11 3.02.36 1.26.33 2.48-.63 2.48-1.94V7.14c0-.81-.49-1.52-1.22-1.85-1.28-.57-2.82-.79-4.27-.79M21 17.23c0 .63-.58 1.09-1.2.98-.75-.14-1.53-.2-2.3-.2-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5.92 0 1.83.09 2.7.28.46.1.8.51.8.98z"></path><path d="M13.98 11.01c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.54-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.71-.83.66c-1.62-.19-3.39-.04-4.73.39-.08.01-.16.03-.23.03m0 2.66c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.53-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.71-.83.66c-1.62-.19-3.39-.04-4.73.39a1 1 0 0 1-.23.03m0 2.66c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.53-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.7-.83.66c-1.62-.19-3.39-.04-4.73.39a1 1 0 0 1-.23.03">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nvar css = ".fabRoot____hash_base64_5_{font-size:1.1em;transition:transform .2s}.fabRoot____hash_base64_5_[data-show=false]{pointer-events:none}.fabRoot____hash_base64_5_[data-show=false]>button{transform:scale(0)}.fabRoot____hash_base64_5_[data-trans=true]{opacity:.8}.fabRoot____hash_base64_5_[data-trans=true]:focus,.fabRoot____hash_base64_5_[data-trans=true]:focus-visible,.fabRoot____hash_base64_5_[data-trans=true]:hover{opacity:1}.fab____hash_base64_5_{align-items:center;background-color:var(--fab,#607d8b);border:none;border-radius:100%;box-shadow:0 3px 5px -1px #0003,0 6px 10px 0 #00000024,0 1px 18px 0 #0000001f;color:#fff;cursor:pointer;display:flex;font-size:1em;height:3.6em;justify-content:center;transform:scale(1);transition:transform .2s;width:3.6em}.fab____hash_base64_5_>svg{font-size:1.5em;width:1em}.fab____hash_base64_5_:focus,.fab____hash_base64_5_:focus-visible{box-shadow:0 3px 5px -1px #00000080,0 6px 10px 0 #00000057,0 1px 18px 0 #00000052;outline:none}.progress____hash_base64_5_{color:#b0bec5;display:inline-block;height:100%;position:absolute;transform:rotate(-90deg);transition:transform .3s cubic-bezier(.4,0,.2,1) 0s;width:100%}.progress____hash_base64_5_>svg{stroke:currentcolor;stroke-dasharray:290%;stroke-dashoffset:100%;stroke-linecap:round;transition:stroke-dashoffset .3s cubic-bezier(.4,0,.2,1) 0s}.progress____hash_base64_5_:hover{color:#cfd8dc}.progress____hash_base64_5_[aria-valuenow=\\"1\\"]{opacity:0;transition:opacity .2s .15s}.popper____hash_base64_5_{align-items:center;background-color:#303030;border-radius:.3em;color:#fff;display:flex;font-size:.8em;opacity:0;padding:.4em .5em;pointer-events:none;position:absolute;right:calc(100% + 1.5em);top:50%;transform:translateY(-50%) scale(0);transform-origin:right;transition:transform .23s,opacity .15s;transition-delay:var(--hide-delay);white-space:nowrap}:is(.fab____hash_base64_5_:hover,.fabRoot____hash_base64_5_[data-focus=true]) .popper____hash_base64_5_{opacity:1;transform:translateY(-50%) scale(1);transition-delay:0s}.speedDial____hash_base64_5_{align-items:center;bottom:0;display:flex;flex-direction:column-reverse;font-size:1.1em;padding-bottom:120%;pointer-events:none;position:absolute;width:100%;z-index:-1}.speedDialItem____hash_base64_5_{margin:.1em 0;opacity:0;transform:scale(0);transition-delay:var(--hide-delay);transition-duration:.23s;transition-property:transform,opacity}.speedDial____hash_base64_5_:hover,:is(.fabRoot____hash_base64_5_:hover:not([data-show=false]),.fabRoot____hash_base64_5_[data-focus=true])>.speedDial____hash_base64_5_{pointer-events:all}:is(:is(.fabRoot____hash_base64_5_:hover:not([data-show=false]),.fabRoot____hash_base64_5_[data-focus=true])>.speedDial____hash_base64_5_)>.speedDialItem____hash_base64_5_{opacity:unset;transform:unset;transition-delay:var(--show-delay)}.backdrop____hash_base64_5_{background:#000;height:100vh;left:0;opacity:0;pointer-events:none;position:fixed;top:0;transition:opacity .5s;width:100vw}.fabRoot____hash_base64_5_[data-focus=true] .backdrop____hash_base64_5_{pointer-events:unset}:is(.fabRoot____hash_base64_5_:hover:not([data-show=false]),.fabRoot____hash_base64_5_[data-focus=true],.speedDial____hash_base64_5_:hover) .backdrop____hash_base64_5_{opacity:.4}";\nvar modules_c21c94f2 = {"fabRoot":"fabRoot____hash_base64_5_","fab":"fab____hash_base64_5_","progress":"progress____hash_base64_5_","popper":"popper____hash_base64_5_","speedDial":"speedDial____hash_base64_5_","speedDialItem":"speedDialItem____hash_base64_5_","backdrop":"backdrop____hash_base64_5_"};\n\n/**\n * Fab 按钮\n */\nconst Fab = _props => {\n  const props = solidJs.mergeProps({\n    progress: 0,\n    initialShow: true,\n    autoTrans: false\n  }, _props);\n\n  // 上次滚动位置\n  let lastY = window.scrollY;\n  const [show, setShow] = solidJs.createSignal(props.initialShow);\n\n  // 绑定滚动事件\n  const handleScroll = helper.throttle(e => {\n    // 跳过非用户操作的滚动\n    if (!e.isTrusted) return;\n    if (window.scrollY === lastY) return;\n    setShow(\n    // 滚动到底部时显示\n    window.scrollY + window.innerHeight >= document.body.scrollHeight ||\n    // 向上滚动时显示，反之隐藏\n    window.scrollY - lastY < 0);\n    lastY = window.scrollY;\n  }, 200);\n  solidJs.onMount(() => window.addEventListener(\'scroll\', handleScroll));\n  solidJs.onCleanup(() => window.removeEventListener(\'scroll\', handleScroll));\n\n  // 将 forceShow 的变化同步到 show 上\n  solidJs.createEffect(() => props.show && setShow(props.show));\n  return (() => {\n    var _el$ = web.template(`<div><button type=button tabindex=-1><span role=progressbar><svg viewBox="22 22 44 44"><circle cx=44 cy=44 r=20.2 fill=none stroke-width=3.6>`)(),\n      _el$2 = _el$.firstChild,\n      _el$3 = _el$2.firstChild,\n      _el$4 = _el$3.firstChild;\n    web.use(ref => helper.useStyle(css, ref), _el$);\n    web.addEventListener(_el$2, "click", () => props.onClick?.());\n    web.insert(_el$2, () => props.children ?? web.createComponent(MdMenuBook, {}), _el$3);\n    web.insert(_el$2, (() => {\n      var _c$ = web.memo(() => !!props.tip);\n      return () => _c$() ? (() => {\n        var _el$7 = web.template(`<div>`)();\n        web.insert(_el$7, () => props.tip);\n        web.effect(() => web.className(_el$7, modules_c21c94f2.popper));\n        return _el$7;\n      })() : null;\n    })(), null);\n    web.insert(_el$, web.createComponent(solidJs.Show, {\n      get when() {\n        return props.speedDial?.length;\n      },\n      get children() {\n        var _el$5 = web.template(`<div><div>`)(),\n          _el$6 = _el$5.firstChild;\n        web.addEventListener(_el$6, "click", () => props.onBackdropClick?.());\n        web.insert(_el$5, web.createComponent(solidJs.For, {\n          get each() {\n            return props.speedDial;\n          },\n          children: (SpeedDialItem, i) => (() => {\n            var _el$8 = web.template(`<div>`)();\n            web.insert(_el$8, web.createComponent(SpeedDialItem, {}));\n            web.effect(_p$ => {\n              var _v$12 = modules_c21c94f2.speedDialItem,\n                _v$13 = `${(i() + 1) * 30}ms`,\n                _v$14 = `${(props.speedDial.length - 1 - i()) * 50}ms`,\n                _v$15 = i() * 30;\n              _v$12 !== _p$.e && web.className(_el$8, _p$.e = _v$12);\n              _v$13 !== _p$.t && ((_p$.t = _v$13) != null ? _el$8.style.setProperty("--show-delay", _v$13) : _el$8.style.removeProperty("--show-delay"));\n              _v$14 !== _p$.a && ((_p$.a = _v$14) != null ? _el$8.style.setProperty("--hide-delay", _v$14) : _el$8.style.removeProperty("--hide-delay"));\n              _v$15 !== _p$.o && web.setAttribute(_el$8, "data-i", _p$.o = _v$15);\n              return _p$;\n            }, {\n              e: undefined,\n              t: undefined,\n              a: undefined,\n              o: undefined\n            });\n            return _el$8;\n          })()\n        }), null);\n        web.effect(_p$ => {\n          var _v$ = modules_c21c94f2.speedDial,\n            _v$2 = modules_c21c94f2.backdrop;\n          _v$ !== _p$.e && web.className(_el$5, _p$.e = _v$);\n          _v$2 !== _p$.t && web.className(_el$6, _p$.t = _v$2);\n          return _p$;\n        }, {\n          e: undefined,\n          t: undefined\n        });\n        return _el$5;\n      }\n    }), null);\n    web.effect(_p$ => {\n      var _v$3 = modules_c21c94f2.fabRoot,\n        _v$4 = props.show ?? show(),\n        _v$5 = props.autoTrans,\n        _v$6 = props.focus,\n        _v$7 = {\n          ...props.style,\n          \'--hide-delay\': `${props.speedDial.length * 50}ms`\n        },\n        _v$8 = modules_c21c94f2.fab,\n        _v$9 = modules_c21c94f2.progress,\n        _v$10 = props.progress,\n        _v$11 = `${(1 - props.progress) * 290}%`;\n      _v$3 !== _p$.e && web.className(_el$, _p$.e = _v$3);\n      _v$4 !== _p$.t && web.setAttribute(_el$, "data-show", _p$.t = _v$4);\n      _v$5 !== _p$.a && web.setAttribute(_el$, "data-trans", _p$.a = _v$5);\n      _v$6 !== _p$.o && web.setAttribute(_el$, "data-focus", _p$.o = _v$6);\n      _p$.i = web.style(_el$, _v$7, _p$.i);\n      _v$8 !== _p$.n && web.className(_el$2, _p$.n = _v$8);\n      _v$9 !== _p$.s && web.className(_el$3, _p$.s = _v$9);\n      _v$10 !== _p$.h && web.setAttribute(_el$3, "aria-valuenow", _p$.h = _v$10);\n      _v$11 !== _p$.r && ((_p$.r = _v$11) != null ? _el$4.style.setProperty("stroke-dashoffset", _v$11) : _el$4.style.removeProperty("stroke-dashoffset"));\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined,\n      n: undefined,\n      s: undefined,\n      h: undefined,\n      r: undefined\n    });\n    return _el$;\n  })();\n};\n\nexports.Fab = Fab;\n';break;case"components/Toast":n="\nconst web = require('solid-js/web');\nconst solidJs = require('solid-js');\nconst helper = require('helper');\nconst store$1 = require('solid-js/store');\n\nconst [_state, _setState] = store$1.createStore({\n  ref: null,\n  list: [],\n  map: {}\n});\nconst setState = fn => _setState(store$1.produce(fn));\nconst store = _state;\nconst creatId = () => {\n  let id = `${Date.now()}`;\n  while (Reflect.has(store.map, id)) id += '_';\n  return id;\n};\nconst dismiss = id => {\n  if (!Reflect.has(store.map, id)) return;\n  _setState('map', id, 'exit', true);\n};\n\nconst MdCheckCircle = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2M9.29 16.29 5.7 12.7a.996.996 0 1 1 1.41-1.41L10 14.17l6.88-6.88a.996.996 0 1 1 1.41 1.41l-7.59 7.59a.996.996 0 0 1-1.41 0\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdWarning = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M4.47 21h15.06c1.54 0 2.5-1.67 1.73-3L13.73 4.99c-.77-1.33-2.69-1.33-3.46 0L2.74 18c-.77 1.33.19 3 1.73 3M12 14c-.55 0-1-.45-1-1v-2c0-.55.45-1 1-1s1 .45 1 1v2c0 .55-.45 1-1 1m1 4h-2v-2h2z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdError = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 11c-.55 0-1-.45-1-1V8c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1m1 4h-2v-2h2z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdInfo = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 15c-.55 0-1-.45-1-1v-4c0-.55.45-1 1-1s1 .45 1 1v4c0 .55-.45 1-1 1m1-8h-2V7h2z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nvar css = \".root____hash_base64_5_{align-items:flex-end;bottom:0;display:flex;flex-direction:column;font-size:16px;pointer-events:none;position:fixed;right:0;z-index:2147483647}.item____hash_base64_5_{align-items:center;animation:bounceInRight____hash_base64_5_ .5s 1;background:#fff;border-radius:4px;box-shadow:0 1px 10px 0 #0000001a,0 2px 15px 0 #0000000d;color:#000;cursor:pointer;display:flex;margin:1em;max-width:min(30em,100vw);overflow:hidden;padding:.8em 1em;pointer-events:auto;position:relative;width:fit-content}.item____hash_base64_5_>svg{color:var(--theme);margin-right:.5em;width:1.5em}.item____hash_base64_5_[data-exit]{animation:bounceOutRight____hash_base64_5_ .5s 1}.schedule____hash_base64_5_{background-color:var(--theme);bottom:0;height:.2em;left:0;position:absolute;transform-origin:left;width:100%}.item____hash_base64_5_[data-schedule] .schedule____hash_base64_5_{transition:transform .1s}.item____hash_base64_5_:not([data-schedule]) .schedule____hash_base64_5_{animation:schedule____hash_base64_5_ linear 1 forwards}:is(.item____hash_base64_5_:hover,.item____hash_base64_5_[data-schedule],.root____hash_base64_5_[data-paused]) .schedule____hash_base64_5_{animation-play-state:paused}.msg____hash_base64_5_{line-height:1.4em;text-align:start;white-space:break-spaces;width:fit-content;word-break:break-word}.msg____hash_base64_5_ h2{margin:0}.msg____hash_base64_5_ h3{margin:.7em 0}.msg____hash_base64_5_ ul{margin:0;text-align:left}.msg____hash_base64_5_ button{background-color:#eee;border:none;border-radius:.4em;cursor:pointer;font-size:inherit;margin:0 .5em;outline:none;padding:.2em .6em}:is(.msg____hash_base64_5_ button):hover{background:#e0e0e0}p{margin:0}@keyframes schedule____hash_base64_5_{0%{transform:scaleX(1)}to{transform:scaleX(0)}}@keyframes bounceInRight____hash_base64_5_{0%,60%,75%,90%,to{animation-timing-function:cubic-bezier(.215,.61,.355,1)}0%{opacity:0;transform:translate3d(3000px,0,0) scaleX(3)}60%{opacity:1;transform:translate3d(-25px,0,0) scaleX(1)}75%{transform:translate3d(10px,0,0) scaleX(.98)}90%{transform:translate3d(-5px,0,0) scaleX(.995)}to{transform:translateZ(0)}}@keyframes bounceOutRight____hash_base64_5_{20%{opacity:1;transform:translate3d(-20px,0,0) scaleX(.9)}to{opacity:0;transform:translate3d(2000px,0,0) scaleX(2)}}\";\nvar modules_c21c94f2 = {\"root\":\"root____hash_base64_5_\",\"item\":\"item____hash_base64_5_\",\"bounceInRight\":\"bounceInRight____hash_base64_5_\",\"bounceOutRight\":\"bounceOutRight____hash_base64_5_\",\"schedule\":\"schedule____hash_base64_5_\",\"msg\":\"msg____hash_base64_5_\"};\n\nconst iconMap = {\n  info: MdInfo,\n  success: MdCheckCircle,\n  warn: MdWarning,\n  error: MdError\n};\nconst colorMap = {\n  info: '#3a97d7',\n  success: '#23bb35',\n  warn: '#f0c53e',\n  error: '#e45042',\n  custom: '#1f2936'\n};\n\n/** 删除 toast */\nconst dismissToast = id => setState(state => {\n  state.map[id].onDismiss?.({\n    ...state.map[id]\n  });\n  const i = state.list.indexOf(id);\n  if (i !== -1) state.list.splice(i, 1);\n  Reflect.deleteProperty(state.map, id);\n});\n\n/** 重置 toast 的 update 属性 */\nconst resetToastUpdate = id => _setState('map', id, 'update', undefined);\nconst ToastItem = props => {\n  /** 是否要显示进度 */\n  const showSchedule = solidJs.createMemo(() => props.duration === Number.POSITIVE_INFINITY && props.schedule ? true : undefined);\n  const _dismiss = e => {\n    e.stopPropagation();\n    if (showSchedule() && 'animationName' in e) return;\n    dismiss(props.id);\n  };\n\n  // 在退出动画结束后才真的删除\n  const handleAnimationEnd = () => {\n    if (!props.exit) return;\n    dismissToast(props.id);\n  };\n  let scheduleRef;\n  solidJs.createEffect(() => {\n    if (!props.update) return;\n    resetToastUpdate(props.id);\n    if (!scheduleRef) return;\n    for (const animation of scheduleRef.getAnimations()) {\n      animation.cancel();\n      animation.play();\n    }\n  });\n  const handleClick = e => {\n    props.onClick?.();\n    _dismiss(e);\n  };\n  return (() => {\n    var _el$ = web.template(`<div><div>`)(),\n      _el$2 = _el$.firstChild;\n    _el$.addEventListener(\"animationend\", handleAnimationEnd);\n    web.addEventListener(_el$, \"click\", handleClick);\n    web.insert(_el$, web.createComponent(web.Dynamic, {\n      get component() {\n        return iconMap[props.type];\n      }\n    }), _el$2);\n    web.insert(_el$2, (() => {\n      var _c$ = web.memo(() => typeof props.msg === 'string');\n      return () => _c$() ? props.msg : web.createComponent(props.msg, {});\n    })());\n    web.insert(_el$, web.createComponent(solidJs.Show, {\n      get when() {\n        return props.duration !== Number.POSITIVE_INFINITY || props.schedule !== undefined;\n      },\n      get children() {\n        var _el$3 = web.template(`<div>`)();\n        _el$3.addEventListener(\"animationend\", _dismiss);\n        var _ref$ = scheduleRef;\n        typeof _ref$ === \"function\" ? web.use(_ref$, _el$3) : scheduleRef = _el$3;\n        web.effect(_p$ => {\n          var _v$ = modules_c21c94f2.schedule,\n            _v$2 = `${props.duration}ms`,\n            _v$3 = showSchedule() ? `scaleX(${props.schedule})` : undefined;\n          _v$ !== _p$.e && web.className(_el$3, _p$.e = _v$);\n          _v$2 !== _p$.t && ((_p$.t = _v$2) != null ? _el$3.style.setProperty(\"animation-duration\", _v$2) : _el$3.style.removeProperty(\"animation-duration\"));\n          _v$3 !== _p$.a && ((_p$.a = _v$3) != null ? _el$3.style.setProperty(\"transform\", _v$3) : _el$3.style.removeProperty(\"transform\"));\n          return _p$;\n        }, {\n          e: undefined,\n          t: undefined,\n          a: undefined\n        });\n        return _el$3;\n      }\n    }), null);\n    web.effect(_p$ => {\n      var _v$4 = modules_c21c94f2.item,\n        _v$5 = colorMap[props.type],\n        _v$6 = showSchedule(),\n        _v$7 = props.exit,\n        _v$8 = modules_c21c94f2.msg;\n      _v$4 !== _p$.e && web.className(_el$, _p$.e = _v$4);\n      _v$5 !== _p$.t && ((_p$.t = _v$5) != null ? _el$.style.setProperty(\"--theme\", _v$5) : _el$.style.removeProperty(\"--theme\"));\n      _v$6 !== _p$.a && web.setAttribute(_el$, \"data-schedule\", _p$.a = _v$6);\n      _v$7 !== _p$.o && web.setAttribute(_el$, \"data-exit\", _p$.o = _v$7);\n      _v$8 !== _p$.i && web.className(_el$2, _p$.i = _v$8);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined,\n      a: undefined,\n      o: undefined,\n      i: undefined\n    });\n    return _el$;\n  })();\n};\n\nconst Toaster = () => {\n  const [visible, setVisible] = solidJs.createSignal(document.visibilityState === 'visible');\n  solidJs.onMount(() => {\n    helper.useStyle(css, store.ref);\n    const handleVisibilityChange = () => {\n      setVisible(document.visibilityState === 'visible');\n    };\n    document.addEventListener('visibilitychange', handleVisibilityChange);\n    solidJs.onCleanup(() => document.removeEventListener('visibilitychange', handleVisibilityChange));\n  });\n  return (() => {\n    var _el$ = web.template(`<div>`)();\n    web.use(ref => _setState('ref', ref), _el$);\n    web.insert(_el$, web.createComponent(solidJs.For, {\n      get each() {\n        return store.list;\n      },\n      children: id => web.createComponent(ToastItem, web.mergeProps(() => store.map[id]))\n    }));\n    web.effect(_p$ => {\n      var _v$ = modules_c21c94f2.root,\n        _v$2 = visible() ? undefined : '';\n      _v$ !== _p$.e && web.className(_el$, _p$.e = _v$);\n      _v$2 !== _p$.t && web.setAttribute(_el$, \"data-paused\", _p$.t = _v$2);\n      return _p$;\n    }, {\n      e: undefined,\n      t: undefined\n    });\n    return _el$;\n  })();\n};\nlet dom;\nconst init = () => {\n  if (dom || store.ref) return;\n  dom = helper.mountComponents('toast', () => web.createComponent(Toaster, {}));\n  dom.style.setProperty('z-index', '2147483647', 'important');\n};\n\nconst toast = (msg, options) => {\n  if (!msg) return;\n  init();\n  const id = options?.id ?? (typeof msg === 'string' ? msg : creatId());\n  setState(state => {\n    if (Reflect.has(state.map, id)) {\n      Object.assign(state.map[id], {\n        msg,\n        ...options,\n        update: true\n      });\n      return;\n    }\n    state.map[id] = {\n      id,\n      type: 'info',\n      duration: 3000,\n      msg,\n      ...options\n    };\n    state.list.push(id);\n  });\n\n  /** 弹窗后记录一下 */\n  let fn = helper.log;\n  switch (options?.type) {\n    case 'warn':\n      fn = helper.log.warn;\n      break;\n    case 'error':\n      fn = helper.log.error;\n      break;\n  }\n  fn('Toast:', msg);\n  if (options?.throw && typeof msg === 'string') throw new Error(msg);\n};\ntoast.dismiss = dismiss;\ntoast.set = (id, options) => {\n  if (!Reflect.has(store.map, id)) return;\n  setState(state => Object.assign(state.map[id], options));\n};\ntoast.success = (msg, options) => toast(msg, {\n  ...options,\n  exit: undefined,\n  type: 'success'\n});\ntoast.warn = (msg, options) => toast(msg, {\n  ...options,\n  exit: undefined,\n  type: 'warn'\n});\ntoast.error = (msg, options) => toast(msg, {\n  ...options,\n  exit: undefined,\n  type: 'error'\n});\n\nexports.Toaster = Toaster;\nexports.toast = toast;\n";break;case"userscript/dmzjApi":n="\nconst store = require('solid-js/store');\nconst solidJs = require('solid-js');\nconst main = require('main');\nconst dmzjDecrypt = require('dmzjDecrypt');\nconst helper = require('helper');\n\n/** 根据漫画 id 和章节 id 获取章节数据 */\nconst getChapterInfo = async (comicId, chapterId) => {\n  const res = await main.request(`https://m.dmzj.com/chapinfo/${comicId}/${chapterId}.html`, {\n    responseType: 'json',\n    errorText: '获取章节数据失败'\n  });\n  return res.response;\n};\n\n/** 根据漫画 id 和章节 id 获取章节评论 */\nconst getViewpoint = async (comicId, chapterId) => {\n  try {\n    const res = await main.request(`https://manhua.dmzj.com/tpi/api/viewpoint/getViewpoint?type=0&type_id=${comicId}&chapter_id=${chapterId}&more=1`, {\n      responseType: 'json',\n      errorText: '获取章节评论失败'\n    });\n\n    // 还有另一个 api\n    // http://v3api.dmzj.com/viewPoint/0/${comic_id}/${chapter_id}.json\n\n    return res.response.data.list.map(({\n      title,\n      num\n    }) => `${title} [+${num}]`);\n  } catch {\n    return [];\n  }\n};\nconst getComicDetail_base = async comicId => {\n  const res = await main.request(`https://api.dmzj.com/dynamic/comicinfo/${comicId}.json`, {\n    responseType: 'json'\n  });\n  const {\n    info: {\n      last_updatetime,\n      title\n    },\n    list\n  } = res.response.data;\n  return {\n    title,\n    last_updatetime,\n    last_update_chapter_id: undefined,\n    chapters: [{\n      name: '连载',\n      list: list.map(({\n        id,\n        chapter_name,\n        updatetime\n      }) => ({\n        id,\n        title: chapter_name,\n        updatetime\n      }))\n    }]\n  };\n};\nconst getComicDetail_v4Api = async comicId => {\n  const res = await main.request(`https://v4api.idmzj.com/comic/detail/${comicId}?uid=2665531&disable_level=1`);\n  const {\n    comicInfo: {\n      last_update_chapter_id,\n      last_updatetime,\n      chapters,\n      title\n    }\n  } = dmzjDecrypt(res.responseText);\n  for (const chapter of Object.values(chapters)) chapter.data.sort((a, b) => a.chapter_order - b.chapter_order);\n  return {\n    title,\n    last_updatetime,\n    last_update_chapter_id,\n    chapters: chapters.map(({\n      data,\n      title: name\n    }) => ({\n      name,\n      list: data.map(({\n        chapter_id,\n        chapter_title,\n        updatetime\n      }) => ({\n        id: chapter_id,\n        title: chapter_title,\n        updatetime\n      }))\n    }))\n  };\n};\nconst getComicDetail_traversal = async (comicId, draftData) => {\n  let nextId = draftData.last_update_chapter_id;\n  if (!nextId) {\n    helper.log.warn('last_update_chapter_id 为空，无法通过遍历获取章节');\n    return;\n  }\n  draftData.chapters[0] = {\n    name: '连载',\n    list: []\n  };\n  main.toast.warn('正在通过遍历获取所有章节，耗时可能较长', {\n    id: 'traversalTip',\n    duration: Number.POSITIVE_INFINITY\n  });\n  while (nextId) {\n    try {\n      const {\n        chapter_name,\n        updatetime,\n        prev_chap_id\n      } = await getChapterInfo(comicId, nextId);\n      draftData.chapters[0].list.push({\n        id: nextId,\n        title: chapter_name,\n        updatetime\n      });\n      nextId = prev_chap_id;\n    } catch {\n      nextId = undefined;\n    }\n  }\n  main.toast.dismiss('traversalTip');\n};\n\n/** 返回可变 store 类型的漫画数据 */\nconst useComicDetail = comicId => {\n  const data = store.createMutable({});\n  const apiFn = [getComicDetail_v4Api, getComicDetail_base, getComicDetail_traversal];\n  solidJs.onMount(async () => {\n    for (const api of apiFn) {\n      try {\n        Object.assign(data, await api(comicId, data));\n        if (data.chapters?.some(chapter => chapter.list.length)) return;\n      } catch {}\n    }\n    main.toast.error('漫画数据获取失败', {\n      duration: Number.POSITIVE_INFINITY\n    });\n  });\n  return data;\n};\n\n/** 根据漫画拼音简称找到对应的 id */\nconst getComicId = async py => {\n  const res = await main.request(`https://manhua.dmzj.com/api/v1/comic2/comic/detail?${new URLSearchParams({\n    channel: 'pc',\n    app_name: 'comic',\n    version: '1.0.0',\n    timestamp: `${Date.now()}`,\n    uid: '',\n    comic_py: py\n  }).toString()}`, {\n    responseType: 'json'\n  });\n  return res.response.data?.comicInfo?.id;\n};\n\nexports.getChapterInfo = getChapterInfo;\nexports.getComicId = getComicId;\nexports.getViewpoint = getViewpoint;\nexports.useComicDetail = useComicDetail;\n";break;case"userscript/detectAd":n="\nconst main = require('main');\nconst Comlink = require('comlink');\nconst worker = require('worker/detectAd');\nconst helper = require('helper');\n\nconst getAdPage = async (list, isAdPage, adList) => {\n  let i = list.length - 1;\n  let normalNum = 0;\n  // 只检查最后十张\n  for (; i >= list.length - 10; i--) {\n    // 开头肯定不会是广告\n    if (i <= 2) break;\n    if (adList.has(i)) continue;\n    const item = list[i];\n    if (!item) break;\n    if (await isAdPage(item)) adList.add(i);\n    // 找到连续三张正常漫画页后中断\n    else if (normalNum >= 2) break;else normalNum += 1;\n  }\n  let adNum = 0;\n  for (i = Math.min(...adList); i < list.length; i++) {\n    if (adList.has(i)) {\n      adNum += 1;\n      continue;\n    }\n\n    // 连续两张广告后面的肯定也都是广告\n    if (adNum >= 2) adList.add(i);\n    // 夹在两张广告中间的肯定也是广告\n    else if (adList.has(i - 1) && adList.has(i + 1)) adList.add(i);else adNum = 0;\n  }\n  return adList;\n};\nconst imgToCanvas = async img => {\n  if (typeof img !== 'string') {\n    await helper.waitImgLoad(img);\n    try {\n      const canvas = new OffscreenCanvas(img.width, img.height);\n      const ctx = canvas.getContext('2d');\n      ctx.drawImage(img, 0, 0);\n      // 没被 CORS 污染就直接使用\n      if (ctx.getImageData(0, 0, 1, 1)) {\n        const imgBitmap = canvas.transferToImageBitmap();\n        return Comlink.transfer(imgBitmap, [imgBitmap]);\n      }\n    } catch {}\n  }\n  const url = typeof img === 'string' ? img : img.src;\n  const res = await main.request(url, {\n    responseType: 'blob'\n  });\n  const imgBitmap = await createImageBitmap(res.response);\n  return Comlink.transfer(imgBitmap, [imgBitmap]);\n};\n\n/** 通过文件名判断是否是广告 */\nconst getAdPageByFileName = async (fileNameList, adList) => getAdPage(fileNameList, fileName => /^[zZ]+/.test(fileName), adList);\nconst isAdImg = imgBitmap => worker.isAdImg(Comlink.transfer(imgBitmap, [imgBitmap]));\n\n/** 通过图片内容判断是否是广告 */\nconst getAdPageByContent = async (imgList, adList) => getAdPage(imgList, async img => isAdImg(await imgToCanvas(img)), adList);\nconst mainFn = {\n  log: helper.log\n};\nworker.setMainFn(Comlink.proxy(mainFn), Object.keys(mainFn));\n\nexports.getAdPageByContent = getAdPageByContent;\nexports.getAdPageByFileName = getAdPageByFileName;\nexports.isAdImg = isAdImg;\n";break;case"worker/ImageRecognition":n="\nconst getEdgeScope = (width, height) => Math.min(Math.ceil((width + height) * 0.01), 10);\n\n/** 对指定数值取整 */\nconst round = (n, int) => {\n  const remainder = n % int;\n  return remainder < int / 2 ? n - remainder : n + (int - remainder);\n};\n\n/** 计算 rgb 的灰度 */\nconst toGray = (r, g, b) => Math.round(0.299 * r + 0.587 * g + 0.114 * b);\n\n/** 获取图片的灰度表 */\nconst toGrayList = (imgData, roundNum) => {\n  const grayList = new Uint8ClampedArray(new ArrayBuffer(imgData.length / 4));\n  for (let i = 0, gi = 0; i < imgData.length; i += 4, gi++) {\n    const r = imgData[i];\n    const g = imgData[i + 1];\n    const b = imgData[i + 2];\n    grayList[gi] = round(toGray(r, g, b), roundNum);\n  }\n  return grayList;\n};\n\n/** 遍历图片的指定行 */\nconst forEachRows = (width, y, fn, start = 0, end = width) => {\n  for (let i = start; i < end; i++) fn(width * y + i);\n};\n\n/** 遍历图片的指定列 */\nconst forEachCols = (width, height, x, fn, start = 0, end = height) => {\n  for (let i = start; i < end; i++) fn(i * width + x);\n};\n\n/** 遍历图片的边缘 */\nconst forEachEdge = (width, height, scope, fn) => {\n  for (let i = 0; i < scope; i++) {\n    forEachRows(width, i, fn);\n    forEachRows(width, height - i - 1, fn);\n    forEachCols(width, height, i, fn, scope, height - scope);\n    forEachCols(width, height, width - i - 1, fn, scope, height - scope);\n  }\n};\nconst mainFn = {};\nconst setMainFn = (helper, keys) => {\n  for (const name of keys) Reflect.set(mainFn, name, (...args) => Reflect.apply(helper[name], helper, args));\n};\n\n/** 缩小图像 */\nconst resizeImg = (rawImgData, width, height) => {\n  // const scale = 1;\n  const scale = Math.min(200 / width, 200 / height);\n  const w = Math.floor(width * scale);\n  const h = Math.floor(height * scale);\n  const data = new Uint8ClampedArray(new ArrayBuffer(w * h * 4));\n  for (let y = 0; y < h; y++) {\n    for (let x = 0; x < w; x++) {\n      // 使用最简单的采样方式，避免出现原图所没有的颜色\n      const i = (y * w + x) * 4;\n      const tx = Math.floor(x / scale);\n      const ty = Math.floor(y / scale);\n      const target = (width * ty + tx) * 4;\n      data[i] = rawImgData[target];\n      data[i + 1] = rawImgData[target + 1];\n      data[i + 2] = rawImgData[target + 2];\n      data[i + 3] = 255;\n    }\n  }\n  return {\n    scale,\n    w,\n    h,\n    data\n  };\n};\n\n/** 通过互相比较数组项求出最终项 */\nconst boil = (array, compareFunc) => {\n  if (!array || (array.length ?? 0) === 0) return null;\n  return array.reduce(compareFunc); // eslint-disable-line unicorn/no-array-reduce\n};\n\n/** 获取颜色区域在边缘区域上的占比 */\nconst getAreaEdgeRatio = (pixelList, width, height) => {\n  let size = 0;\n  const edgeScope = getEdgeScope(width, height);\n  const add = i => pixelList.has(i) && size++;\n  forEachEdge(width, height, edgeScope, add);\n  return size / (width * edgeScope * 2 + (height - 2 * edgeScope) * edgeScope * 2);\n};\n\n/** 根据灰度值获取图片边缘相似颜色的区域 */\nconst getEdgeArea = (grayList, width, height) => {\n  const maximum = width * height * 0.4;\n  const areaMap = new Map();\n\n  /** 待检查相邻像素的像素 */\n  const seedPixel = new Set();\n  const addSeedPixel = index => {\n    const gray = grayList[index];\n    if (gray === undefined) return;\n    seedPixel.add(index);\n    if (!areaMap.has(gray)) areaMap.set(gray, new Set());\n    areaMap.get(gray).add(index);\n  };\n  const popSeedPixel = () => {\n    if (seedPixel.size === 0) return undefined;\n    const index = seedPixel.values().next().value;\n    seedPixel.delete(index);\n    return index;\n  };\n\n  // 将边缘区域的像素设为种子\n  const edgeScope = getEdgeScope(width, height);\n  forEachEdge(width, height, edgeScope, addSeedPixel);\n\n  /** 获取相邻像素 */\n  const getAdjacentPixel = i => {\n    const adjacentPixel = [];\n    const x = i % width;\n    const y = Math.floor(i / width);\n    const left = x !== 0;\n    const up = y >= 1;\n    const right = x < width - 1;\n    const down = y < height - 1;\n    if (left) adjacentPixel.push(i - 1); // ←\n    if (up) adjacentPixel.push(i - width); // ↑\n    if (right) adjacentPixel.push(i + 1); // →\n    if (down) adjacentPixel.push(i + width); // ↓\n    if (left && up) adjacentPixel.push(i - width - 1); // ↖\n    if (left && down) adjacentPixel.push(i + width - 1); // ↙\n    if (right && up) adjacentPixel.push(i - width + 1); // ↗\n    if (right && down) adjacentPixel.push(i + width + 1); // ↘\n\n    return adjacentPixel;\n  };\n\n  // 从种子像素开始不断合并相同灰度的像素形成区域\n  for (let i = popSeedPixel(); i !== undefined; i = popSeedPixel()) {\n    const gray = grayList[i];\n    const areaPixelList = areaMap.get(gray);\n    const adjacentPixelList = getAdjacentPixel(i);\n    for (const adjacentPixel of adjacentPixelList) {\n      if (areaPixelList.has(adjacentPixel)) continue;\n      const pixelGray = grayList[adjacentPixel];\n      if (pixelGray !== gray) continue;\n      addSeedPixel(adjacentPixel);\n    }\n\n    // 如果当前区域像素数量超过阈值，就直接认定其为背景\n    if (areaPixelList.size > maximum) return [areaPixelList];\n  }\n  const areaList = [];\n  for (const pixelList of areaMap.values()) {\n    if (pixelList.size < 100) continue;\n    areaList.push(pixelList);\n  }\n  return areaList;\n};\n\n/** 获取图像指定区域中的主色 */\nconst getAreaColor = (imgData, pixelList) => {\n  const colorMap = new Map();\n  const maximum = pixelList.size * 0.5;\n  let maxColor = '';\n  let maxCount = 0;\n  for (const i of pixelList.values()) {\n    const index = i * 4;\n    const r = imgData[index];\n    const g = imgData[index + 1];\n    const b = imgData[index + 2];\n    const color = `rgb(${r}, ${g}, ${b})`;\n    if (!colorMap.has(color)) colorMap.set(color, 0);\n    const colorCount = colorMap.get(color) + 1;\n    colorMap.set(color, colorCount);\n    if (colorCount > maxCount) {\n      maxColor = color;\n      maxCount = colorCount;\n    }\n    if (colorCount > maximum) break;\n  }\n  return maxColor;\n};\n\n/** 获取图像指定矩形区域中的主色 */\nconst getSquareAreaColor = (imgData, _topLeftX, _topLeftY, _bottomRightX, _bottomRightY) => {\n  const topLeftX = Math.floor(_topLeftX);\n  const topLeftY = Math.floor(_topLeftY);\n  const bottomRightX = Math.floor(_bottomRightX);\n  const bottomRightY = Math.floor(_bottomRightY);\n  const colorMap = new Map();\n  const maximum = (bottomRightX - topLeftX) * (bottomRightY - topLeftY) * 0.5;\n  let maxColor = '';\n  let maxCount = 0;\n  for (let x = topLeftX; x < bottomRightX; x++) {\n    for (let y = topLeftY; y < bottomRightY; y++) {\n      const index = (x + y * bottomRightX) * 4;\n      const r = imgData[index];\n      const g = imgData[index + 1];\n      const b = imgData[index + 2];\n      const color = `rgb(${r}, ${g}, ${b})`;\n      if (!colorMap.has(color)) colorMap.set(color, 0);\n      const colorCount = colorMap.get(color) + 1;\n      colorMap.set(color, colorCount);\n      if (colorCount > maxCount) {\n        maxColor = color;\n        maxCount = colorCount;\n      }\n      if (colorCount > maximum) break;\n    }\n  }\n  return maxColor;\n};\n\n/** 根据边缘颜色区域获取背景颜色 */\nconst byEdgeArea = ({\n  data,\n  grayList,\n  width,\n  height\n}) => {\n  const areaList = getEdgeArea(grayList, width, height);\n  // if (false) mainFn.showColorArea?.(data, width, height, ...areaList);\n\n  if (areaList.length === 0) return undefined;\n  const minimum = width * height * 0.02;\n  let maxArea;\n  let maxRatio = 0.1;\n\n  // 过滤总体占比和边缘占比过小的区域\n  for (const pixelList of areaList) {\n    if (pixelList.size < minimum) continue;\n    const edgeRatio = getAreaEdgeRatio(pixelList, width, height);\n    if (edgeRatio < maxRatio) continue;\n    maxArea = pixelList;\n    maxRatio = edgeRatio;\n  }\n  if (!maxArea) return undefined;\n  return getAreaColor(data, maxArea);\n};\nconst getPosAreaColor = (pos, {\n  data,\n  blankMargin,\n  width: w,\n  height: h\n}) => {\n  switch (pos) {\n    case 'top':\n      return getSquareAreaColor(data, 0, 0, w, blankMargin.top * h);\n    case 'bottom':\n      return getSquareAreaColor(data, 0, h - blankMargin.bottom * h, w, h);\n    case 'left':\n      return getSquareAreaColor(data, 0, 0, blankMargin.left * w, h);\n    case 'right':\n      return getSquareAreaColor(data, w - blankMargin.right * w, 0, w, h);\n  }\n};\n\n/** 从足够大的空白边缘中获取背景颜色 */\nconst byBlankMargin = context => {\n  const colorMap = {};\n  for (const pos of ['top', 'bottom', 'left', 'right']) {\n    if (!context.blankMargin[pos]) continue;\n    const color = getPosAreaColor(pos, context);\n    if (!color) continue;\n    colorMap[color] = (colorMap[color] || 0) + context.blankMargin[pos];\n  }\n\n  // 过滤占比过低的空白边缘\n  const colorList = Object.entries(colorMap).filter(([, v]) => v > 0.04);\n  if (colorList.length === 0) return undefined;\n  return boil(colorList, (a, b) => a[1] > b[1] ? a : b)?.[0];\n};\n\n/** 判断图像的背景色 */\nconst getBackground = context => 'blankMargin' in context && byBlankMargin(context) || byEdgeArea(context);\n\n/** 获取图片空白边缘的长度 */\nconst getBlankMargin = ({\n  grayList,\n  width,\n  height\n}) => {\n  let blankColor;\n\n  // 检查指定行或列上是否全是相同颜色\n  const isBlankLine = (x, y) => {\n    const colorMap = new Map();\n    const eachFn = i => {\n      const gray = grayList[i];\n      colorMap.set(gray, (colorMap.get(gray) || 0) + 1);\n      // grayList[i] = Math.abs(gray - 255);\n    };\n    if (x < 0) forEachRows(width, y, eachFn);else forEachCols(width, height, x, eachFn);\n    let maxColor;\n    // 为了能跳过些微色差和漫画水印，阈值就只设为 90%\n    let maxNum = height * 0.9;\n    for (const [gray, num] of colorMap.entries()) {\n      if (num < maxNum) continue;\n      maxColor = gray;\n      maxNum = num;\n    }\n    if (maxColor === undefined) return false;\n    blankColor ||= maxColor;\n    if (maxColor !== blankColor) return false;\n    return true;\n  };\n  let left = 0;\n  for (let x = 0, end = width * 0.4; x < end; x++, left++) if (!isBlankLine(x, -1)) break;\n  blankColor = undefined;\n  let right = 0;\n  for (let x = width - 1, end = width * 0.6; x >= end; x--, right++) if (!isBlankLine(x, -1)) break;\n  blankColor = undefined;\n  let top = 0;\n  for (let y = 0, end = height * 0.4; y < end; y++, top++) if (!isBlankLine(-1, y)) break;\n  blankColor = undefined;\n  let bottom = 0;\n  for (let y = height - 1, end = height * 0.6; y >= end; y--, bottom++) if (!isBlankLine(-1, y)) break;\n\n  // if (false) mainFn.showGrayList?.(grayList, width, height);\n\n  if (left || right || top || bottom) return {\n    left,\n    right,\n    top,\n    bottom\n  };\n  return undefined;\n};\n\nconst handleImg = async (imgData, width, height, url, option) => {\n  const startTime = Date.now();\n  const {\n    w,\n    h,\n    data\n  } = resizeImg(imgData, width, height);\n  // if (false) mainFn.showCanvas?.(data, w, h);\n\n  const grayList = toGrayList(data, 5);\n  // if (false) mainFn.showGrayList?.(grayList, w, h);\n\n  const context = {\n    data,\n    grayList,\n    width: w,\n    height: h\n  };\n  let blankMargin;\n  if (option.pageFill || option.background) {\n    blankMargin = getBlankMargin(context);\n    if (blankMargin) {\n      for (const key of ['top', 'bottom', 'left', 'right']) blankMargin[key] &&= blankMargin[key] / w;\n      mainFn.setImg(url, 'blankMargin', {\n        left: blankMargin.left,\n        right: blankMargin.right\n      });\n      mainFn.updatePageData();\n      context.blankMargin = blankMargin;\n    } else mainFn.setImg(url, 'blankMargin', null);\n  }\n  let bgColor;\n  if (option.background) {\n    // 虽然也想支持渐变背景，但浏览器上不像手机端那样只需要显示上下背景，可以无视中间的渐变\n    // 大部分时候都要显示左右区域的背景，不能和实际背景一致的话就会很突兀\n    // 要是图片能一直占满屏幕的话，那还能通过单独显示上下或左右部分的背景色来实现\n    // 但偏偏又有「禁止图片自动放大」功能，需要把图片的四边背景都显示出来\n    bgColor = getBackground(context);\n    if (bgColor) mainFn.setImg(url, 'background', bgColor);\n  }\n  let logText = `${url}\\n耗时 ${Date.now() - startTime}ms 处理完成`;\n  const resList = [];\n  if (blankMargin) resList.push(`空白边缘：${Object.entries(blankMargin).filter(([, v]) => v).map(([k, v]) => `${k}:${v && (v * 100).toFixed(2)}%`).join(' ')}`);\n  if (bgColor) resList.push(`背景色: ${bgColor}`);\n  if (resList.length > 0) logText += `\\n${resList.join('\\n')}`;\n  mainFn.log?.(logText);\n};\n\nexports.handleImg = handleImg;\nexports.setMainFn = setMainFn;\n";break;case"worker/detectAd":n="\nconst jsQR = require('jsqr');\n\nconst mainFn = {};\nconst setMainFn = (helper, keys) => {\n  for (const name of keys) Reflect.set(mainFn, name, (...args) => Reflect.apply(helper[name], helper, args));\n};\n\n/** 计算 rgb 的灰度 */\nconst toGray = (r, g, b) => Math.round(0.299 * r + 0.587 * g + 0.114 * b);\n\n// jsQR 最为简洁，但不支持包含多个二维码的图片\n// https://github.com/cozmo/jsQR/issues/24\n//\n// ZXing 可以扫描包含多个二维码的图片，但因为同时支持多种编码，\n// 包含了很多根本不需要的代码，用在这里感觉太牛刀杀鸡了\n//\n// qr-scanner 基于上述两个库进行开发，是最优选。但会收到 CSP 限制而无法使用\n/** 判断一张图是否是彩图 */\nconst isColorImg = data => {\n  for (let i = 0; i < data.length; i += 16) {\n    const r = data[i];\n    const g = data[i + 1];\n    const b = data[i + 2];\n    if (!(r === g && r === b)) return true;\n  }\n  return false;\n};\n\n/** 二维码白名单 */\nconst qrCodeWhiteList = [\n// fanbox\n/^https:\\/\\/[^.]+\\.fanbox\\.cc/,\n// twitter\n/^https:\\/\\/twitter\\.com/, /^https:\\/\\/x\\.com/,\n// fantia\n/^https:\\/\\/fantia\\.jp/,\n// 棉花糖\n/^https:\\/\\/marshmallow-qa\\.com/,\n// dlsite\n/^https:\\/\\/www\\.dlsite\\.com/,\n// hitomi\n/^https:\\/\\/hitomi\\.la/];\nconst options = {\n  inversionAttempts: 'attemptBoth'\n};\n\n/** 识别图像上的二维码 */\nconst getQrCode = (img, width, height) => {\n  try {\n    const binaryData = jsQR(img, width, height, options)?.binaryData;\n    if (!binaryData) return false;\n    // 因为 jsqr 默认的输出不支持特殊符号，为以防万一，手动进行转换\n    const text = new TextDecoder().decode(Uint8Array.from(binaryData));\n    mainFn.log(`检测到二维码： ${text}`);\n    return text;\n  } catch {\n    return undefined;\n  }\n};\n\n// zxing 方案\n//\n// import {\n//   MultiFormatReader,\n//   BarcodeFormat,\n//   DecodeHintType,\n//   RGBLuminanceSource,\n//   BinaryBitmap,\n//   HybridBinarizer,\n// } from '@zxing/library';\n//\n// const hints = new Map();\n// // 只识别二维码\n// hints.set(DecodeHintType.POSSIBLE_FORMATS, [\n//   BarcodeFormat.QR_CODE,\n//   BarcodeFormat.DATA_MATRIX,\n// ]);\n// // 花更多时间尝试寻找条形码\n// hints.set(DecodeHintType.TRY_HARDER, true);\n//\n// /** 识别图像上的二维码 */\n// const getQrCode = (\n//   data: Uint8ClampedArray,\n//   width: number,\n//   height: number,\n// ) => {\n//   try {\n//     const luminance = new Uint8ClampedArray(width * height);\n//     for (let i = 0; i < data.length; i += 4) {\n//       const r = data[i];\n//       const g = data[i + 1];\n//       const b = data[i + 2];\n//       luminance[i / 4] = (r + g + b) / 3;\n//     }\n//     const luminanceSource = new RGBLuminanceSource(luminance, width, height);\n//     const binaryBitmap = new BinaryBitmap(new HybridBinarizer(luminanceSource));\n//     const res = new MultiFormatReader().decode(binaryBitmap, hints);\n//     const text = res.getText();\n//     if (!text) return false;\n//     mainFn.log(`检测到二维码： ${text}`);\n//     return text;\n//   } catch (error) {\n//     console.log(error);\n//     debugger;\n//     return false;\n//   }\nconst getImgData = img => {\n  const canvas = new OffscreenCanvas(img.width, img.height);\n  const ctx = canvas.getContext('2d');\n  ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\n  return ctx.getImageData(0, 0, canvas.width, canvas.height);\n};\nconst scanImgBlock = (img, sx, sy, w, h) => {\n  if (w === img.width && h === img.height) return getQrCode(img.data, w, h);\n  const data = new Uint8ClampedArray(new ArrayBuffer(w * h * 4));\n  for (let y = 0, height = sy + h; y < height; y++) for (let x = 0, width = sx + w; x < width; x++) {\n    const i = (y * w + x) * 4;\n    const target = ((y + sy) * img.width + (x + sx)) * 4;\n    data[i] = img.data[target];\n    data[i + 1] = img.data[target + 1];\n    data[i + 2] = img.data[target + 2];\n    data[i + 3] = img.data[target + 3];\n  }\n  return getQrCode(data, w, h);\n};\nconst isAdImg = async imgBitmap => {\n  const imgData = getImgData(imgBitmap);\n\n  // 黑白图肯定不是广告\n  if (!isColorImg(imgData.data)) return false;\n\n  // 以 200 灰度为阈值，将图片二值化，以便识别彩色二维码\n  for (let i = 0; i < imgData.data.length; i += 4) {\n    const gray = toGray(imgData.data[i], imgData.data[i + 1], imgData.data[i + 2]);\n    const val = gray < 200 ? 0 : 255;\n    imgData.data[i] = val;\n    imgData.data[i + 1] = val;\n    imgData.data[i + 2] = val;\n    imgData.data[i + 3] = 255;\n  }\n\n  // mainFn.showCanvas?.(imgData.data, imgBitmap.width, imgBitmap.height);\n\n  let text = getQrCode(imgData.data, imgData.width, imgData.height);\n\n  // 分区块扫描图片\n  if (!text) {\n    const w = Math.floor(imgData.width / 2);\n    const h = Math.floor(imgData.height / 2);\n    for (const args of [[w, h],\n    // ↘\n    [0, h],\n    // ↙\n    [w, 0],\n    // ↗\n    [0, 0] // ↖\n    ]) {\n      text = scanImgBlock(imgData, ...args, w, h);\n      if (text) break;\n    }\n  }\n  if (text) return qrCodeWhiteList.every(reg => !reg.test(text));\n  return false;\n};\n\nexports.isAdImg = isAdImg;\nexports.setMainFn = setMainFn;\n";break;case"userscript/otherSite":n="\nconst web = require('solid-js/web');\nconst helper = require('helper');\nconst Manga = require('components/Manga');\nconst main = require('main');\n\nconst prevRe = /^(上一((章|章节|話|话))|prev chapter|前の章)$/i;\nconst nextRe = /^(下一((章|章节|話|话))|next chapter|次の章)$/i;\nconst handleSwitchChapter = setManga => {\n  let onPrev;\n  let onNext;\n  for (const element of helper.querySelectorAll('a, button')) {\n    const text = element.textContent?.trim();\n    if (!text) continue;\n    if (!onPrev && prevRe.test(text)) onPrev = () => element.click();\n    if (!onNext && nextRe.test(text)) onNext = () => element.click();\n    if (onPrev && onNext) break;\n  }\n  setManga({\n    onPrev,\n    onNext\n  });\n};\n\nconst getTagText = ele => {\n  let text = ele.nodeName;\n  if (ele.id && !/\\d/.test(ele.id)) text += `#${ele.id}`;\n  return text;\n};\n\n/** 获取元素仅记录了层级结构关系的选择器 */\nconst getEleSelector = ele => {\n  const parents = [ele.nodeName];\n  const root = ele.getRootNode();\n  let e = ele;\n  while (e.parentNode && e.parentNode !== root) {\n    e = e.parentNode;\n    parents.push(getTagText(e));\n  }\n  return parents.reverse().join('>');\n};\n\n/** 判断指定元素是否符合选择器 */\nconst isEleSelector = (ele, selector) => {\n  const parents = selector.split('>').reverse();\n  let e = ele;\n  for (let i = 0; e && i < parents.length; i++) {\n    if (getTagText(e) !== parents[i]) return false;\n    e = e.parentNode;\n  }\n  return e === e.getRootNode();\n};\n\n// 目录页和漫画页的图片层级相同\n// https://www.biliplus.com/manga/\n// 图片路径上有 id 元素并且 id 含有漫画 id，不同话数 id 也不同\nconst createImgData = (oldSrc = '') => ({\n  triggedNum: 0,\n  observerTimeout: 0,\n  oldSrc\n});\n\n/** 用于判断是否是图片 url 的正则 */\nconst isImgUrlRe = /^(((https?|ftp|file):)?\\/)?\\/[-\\w+&@#/%?=~|!:,.;]+[-\\w+&@#%=~|]$/;\n\n/** 找出格式为图片 url 的元素属性 */\nconst getDatasetUrl = e => {\n  for (const key of e.getAttributeNames()) {\n    // 跳过白名单\n    switch (key) {\n      case 'src':\n      case 'alt':\n      case 'class':\n      case 'style':\n      case 'id':\n      case 'title':\n      case 'onload':\n      case 'onerror':\n        continue;\n    }\n    const val = e.getAttribute(key).trim();\n    if (!isImgUrlRe.test(val)) continue;\n    return val;\n  }\n};\n\n/**\n *\n * 通过滚动到指定图片元素位置并停留一会来触发图片的懒加载，返回图片 src 是否发生变化\n *\n * 会在触发后重新滚回原位，当 time 为 0 时，因为滚动速度很快所以是无感的\n */\nconst triggerEleLazyLoad = async (e, time, isLazyLoaded, runCondition) => {\n  const nowScroll = window.scrollY;\n  e.scrollIntoView({\n    behavior: 'instant'\n  });\n  e.dispatchEvent(new Event('scroll', {\n    bubbles: true\n  }));\n  try {\n    if (isLazyLoaded && time) return await helper.wait(isLazyLoaded, time);\n  } finally {\n    if (runCondition()) window.scroll({\n      top: nowScroll,\n      behavior: 'instant'\n    });\n  }\n};\n\n/** 判断一个元素是否已经成功触发完懒加载 */\nconst isLazyLoaded = (e, oldSrc) => {\n  if (!e.src) return false;\n  if (!e.offsetParent) return false;\n  // 有些网站会使用 svg 占位\n  if (e.src.startsWith('data:image/svg')) return false;\n  if (e.naturalWidth > 500 || e.naturalHeight > 500) return true;\n  if (oldSrc !== undefined && e.src !== oldSrc) return true;\n  return false;\n};\nconst imgMap = new WeakMap();\n// eslint-disable-next-line no-autofix/prefer-const\nlet imgShowObserver;\nconst getImg = e => imgMap.get(e) ?? createImgData();\nconst MAX_TRIGGED_NUM = 5;\n\n/** 判断图片元素是否需要触发懒加载 */\nconst needTrigged = e => !isLazyLoaded(e, imgMap.get(e)?.oldSrc) && (imgMap.get(e)?.triggedNum ?? 0) < MAX_TRIGGED_NUM;\n\n/** 图片懒加载触发完后调用 */\nconst handleTrigged = e => {\n  const img = getImg(e);\n  img.observerTimeout = 0;\n  img.triggedNum += 1;\n  if (isLazyLoaded(e, img.oldSrc) && img.triggedNum < MAX_TRIGGED_NUM) img.triggedNum = MAX_TRIGGED_NUM;\n  imgMap.set(e, img);\n  if (!needTrigged(e)) imgShowObserver.unobserve(e);\n};\n\n/** 监视图片是否被显示的 Observer */\nimgShowObserver = new IntersectionObserver(entries => {\n  for (const img of entries) {\n    const e = img.target;\n    if (img.isIntersecting) {\n      imgMap.set(e, {\n        ...getImg(e),\n        observerTimeout: window.setTimeout(handleTrigged, 290, e)\n      });\n    } else window.clearTimeout(imgMap.get(e)?.observerTimeout);\n  }\n});\nconst turnPageScheduled = helper.createScheduled(fn => helper.throttle(fn, 1000));\n/** 触发翻页 */\nconst triggerTurnPage = async (waitTime, runCondition) => {\n  if (!turnPageScheduled()) return;\n  const nowScroll = window.scrollY;\n  // 滚到底部再滚回来，触发可能存在的自动翻页脚本\n  window.scroll({\n    top: document.body.scrollHeight,\n    behavior: 'instant'\n  });\n  document.body.dispatchEvent(new Event('scroll', {\n    bubbles: true\n  }));\n  if (waitTime) await helper.sleep(waitTime);\n  if (runCondition()) window.scroll({\n    top: nowScroll,\n    behavior: 'instant'\n  });\n};\nconst waitTime = 300;\n\n/** 触发页面上图片元素的懒加载 */\nconst triggerLazyLoad = helper.singleThreaded(async (state, targetImgList, runCondition) => {\n  for (const e of targetImgList) {\n    imgShowObserver.observe(e);\n    if (!imgMap.has(e)) imgMap.set(e, createImgData(e.src));\n  }\n  for (const e of targetImgList) {\n    await helper.wait(runCondition);\n    await triggerTurnPage(0, runCondition);\n    if (!needTrigged(e)) continue;\n    const datasetUrl = getDatasetUrl(e);\n    if (datasetUrl) e.setAttribute('src', datasetUrl);\n    if (await triggerEleLazyLoad(e, waitTime, () => isLazyLoaded(e, imgMap.get(e)?.oldSrc), runCondition)) handleTrigged(e);\n  }\n  await triggerTurnPage(waitTime, runCondition);\n  if (targetImgList.length > 0) state.continueRun = true;\n});\n\n\n// 测试案例\n// https://www.177picyy.com/html/2023/03/5505307.html\n// 需要配合其他翻页脚本使用\n// https://www.colamanga.com/manga-za76213/1/5.html\n// 直接跳转到图片元素不会立刻触发，还需要停留20ms\n// https://www.colamanga.com/manga-kg45140/1/2.html\n/** 执行脚本操作。如果中途中断，将返回 true */\nconst otherSite = async () => {\n  let laseScroll = window.scrollY;\n  const {\n    options,\n    setComicLoad,\n    setComicMap,\n    setImgList,\n    setManga,\n    setFab,\n    setOptions,\n    isStored,\n    mangaProps\n  } = await main.useInit(window.location.hostname, {\n    remember_current_site: true,\n    selector: ''\n  });\n\n  // 通过 options 来迂回的实现禁止记住当前站点\n  if (!options.remember_current_site) {\n    await GM.deleteValue(window.location.hostname);\n    return true;\n  }\n  if (!isStored) main.toast(() => (() => {\n    var _el$ = web.template(`<div><button>`)(),\n      _el$2 = _el$.firstChild;\n    web.insert(_el$, () => helper.t('site.simple.auto_read_mode_message'), _el$2);\n    web.addEventListener(_el$2, \"click\", () => setOptions({\n      autoShow: false\n    }));\n    web.insert(_el$2, () => helper.t('other.disable'));\n    return _el$;\n  })(), {\n    duration: 1000 * 7\n  });\n\n  // 为避免卡死，提供一个删除 selector 的菜单项\n  const menuId = await GM.registerMenuCommand(helper.t('site.simple.simple_read_mode'), () => setOptions({\n    selector: ''\n  }));\n\n  // 等待 selector 匹配到目标后再继续执行，避免在漫画页外的其他地方运行\n  await helper.wait(() => !options.selector || helper.querySelectorAll(options.selector).length >= 2);\n  await GM.unregisterMenuCommand(menuId);\n\n  /** 记录传入的图片元素中最常见的那个 selector */\n  const saveImgEleSelector = imgEleList => {\n    if (imgEleList.length < 7) return;\n    const selector = helper.getMostItem(imgEleList.map(getEleSelector));\n    if (selector !== options.selector) setOptions({\n      selector\n    });\n  };\n  const blobUrlMap = new Map();\n  // 处理那些 URL.createObjectURL 后马上 URL.revokeObjectURL 的图片\n  const handleBlobImg = async e => {\n    if (blobUrlMap.has(e.src)) return blobUrlMap.get(e.src);\n    if (!e.src.startsWith('blob:')) return e.src;\n    if (await helper.testImgUrl(e.src)) return e.src;\n    const canvas = new OffscreenCanvas(e.naturalWidth, e.naturalHeight);\n    const canvasCtx = canvas.getContext('2d');\n    canvasCtx.drawImage(e, 0, 0);\n    const url = URL.createObjectURL(await helper.canvasToBlob(canvas));\n    blobUrlMap.set(e.src, url);\n    return url;\n  };\n  const handleImgUrl = async e => {\n    const url = await handleBlobImg(e);\n    if (url.startsWith('http:') && window.location.protocol === 'https:') return url.replace('http:', 'https:');\n    return url;\n  };\n\n  /** 重复的加载占位图 */\n  const placeholderImgList = new Set();\n  helper.createEffectOn(() => mangaProps.imgList.filter(url => url && !placeholderImgList.has(url)), helper.throttle(imgList => {\n    if (!imgList?.length || imgList.length - new Set(imgList).size <= 4) return;\n    const repeatNumMap = new Map();\n    for (const url of imgList) {\n      const repeatNum = (repeatNumMap.get(url) ?? 0) + 1;\n      repeatNumMap.set(url, repeatNum);\n      if (repeatNum > 5) placeholderImgList.add(url);\n    }\n  }));\n\n  /** 根据元素所在高度进行排序 */\n  const eleSortFn = (a, b) => a === undefined || b === undefined ? 0 : a.getBoundingClientRect().y - b.getBoundingClientRect().y;\n  const imgBlackList = [\n  // 东方永夜机的预加载图片\n  '#pagetual-preload',\n  // 177picyy 上会在图片下加一个 noscript\n  // 本来只是图片元素的 html 代码，但经过东方永夜机加载后就会变成真的图片元素，导致重复\n  'noscript'];\n  const getAllImg = () => helper.querySelectorAll(`:not(${imgBlackList.join(',')}) > img`);\n\n  /** 获取大概率是漫画图片的图片元素 */\n  const getExpectImgList = () => helper.querySelectorAll(options.selector).filter(e => isLazyLoaded(e, imgMap.get(e)?.oldSrc) || !imgMap.has(e) || imgMap.get(e).triggedNum <= 5);\n\n  /** 判断一个图片元素是否符合标准 */\n  const isDisplayImg = e => e.offsetHeight > 100 && e.offsetWidth > 100 && (e.naturalHeight > 500 && e.naturalWidth > 500 || isEleSelector(e, options.selector));\n  let imgEleList;\n\n  /** 检查筛选符合标准的图片元素用于更新 imgList */\n  const updateImgList = helper.singleThreaded(async state => {\n    imgEleList = await helper.wait(() => {\n      /** 大概率是漫画图片的图片元素 */\n      const expectImgs = options.selector ? new Set(getExpectImgList()) : undefined;\n      let imgNum = 0;\n      const newImgList = [];\n      for (const e of getAllImg()) {\n        if (isDisplayImg(e)) {\n          newImgList.push(e);\n          imgNum += 1;\n        } else if (expectImgs?.has(e) && needTrigged(e)) newImgList.push(undefined);\n      }\n      return imgNum >= 2 && newImgList.sort(eleSortFn);\n    });\n    if (imgEleList.length === 0) {\n      setFab('show', false);\n      setManga('show', false);\n      return;\n    }\n\n    // 随着图片的增加，需要补上空缺位置，避免变成稀疏数组\n    if (mangaProps.imgList.length < imgEleList.length) setComicMap('', 'imgList', [...mangaProps.imgList, ...Array.from({\n      length: imgEleList.length - mangaProps.imgList.length\n    }, () => '')]);\n    // colamanga 会创建随机个数的假 img 元素，导致刚开始时高估页数，需要删掉多余的页数\n    else if (mangaProps.imgList.length > imgEleList.length) setComicMap('', 'imgList', mangaProps.imgList.slice(0, imgEleList.length));\n    let isEdited = false;\n    await helper.plimit(imgEleList.map((e, i) => async () => {\n      let newUrl = '';\n      if (e) {\n        newUrl = await handleImgUrl(e);\n        if (placeholderImgList.has(newUrl)) newUrl = getDatasetUrl(e) ?? '';\n      }\n      if (newUrl === mangaProps.imgList[i]) return;\n      isEdited ||= true;\n      setImgList('', i, newUrl);\n    }));\n    if (isEdited) saveImgEleSelector(imgEleList.filter(Boolean));\n    if (isEdited || imgEleList.some(e => !e || needTrigged(e))) {\n      await helper.sleep(1000);\n      state.continueRun = true;\n    }\n  });\n  let timeout = false;\n\n  /** 只在`开启了阅读模式`和`当前可显示图片数量不足`时通过滚动触发懒加载 */\n  const runCondition = () => mangaProps.show || !timeout && mangaProps.imgList.length === 0;\n\n  /** 触发大概率是漫画图片的懒加载 */\n  const triggerExpectImg = (num, time) => helper.wait(async () => {\n    let expectImgList = getExpectImgList().filter(needTrigged);\n    if (num) expectImgList = expectImgList.slice(0, num);\n    await triggerLazyLoad(expectImgList, runCondition);\n    return expectImgList.every(e => !needTrigged(e));\n  }, time);\n  const triggerAllLazyLoad = helper.singleThreaded(async () => {\n    // 优先触发大概率是漫画图片的懒加载\n    if (options.selector) {\n      await triggerExpectImg(3, 1000 * 5);\n      await triggerExpectImg();\n    }\n    await triggerLazyLoad(getAllImg().filter(needTrigged).sort(eleSortFn), runCondition);\n  });\n  const handleMutation = () => {\n    updateImgList();\n    triggerAllLazyLoad();\n    handleSwitchChapter(setManga);\n  };\n  /** 监视页面元素发生变化的 Observer */\n  const imgDomObserver = new MutationObserver(handleMutation);\n  setComicLoad(async () => {\n    if (!imgEleList) {\n      imgEleList = [];\n      imgDomObserver.observe(document.body, {\n        subtree: true,\n        childList: true,\n        attributes: true,\n        attributeFilter: ['src']\n      });\n      handleMutation();\n      setTimeout(() => {\n        timeout = true;\n        if (mangaProps.imgList.length > 0) return;\n        main.toast.warn(helper.t('site.simple.no_img'), {\n          id: 'no_img',\n          duration: Number.POSITIVE_INFINITY,\n          async onClick() {\n            await setOptions({\n              remember_current_site: false\n            });\n            window.location.reload();\n          }\n        });\n      }, 3000);\n    }\n    await helper.wait(() => mangaProps.imgList.length);\n    main.toast.dismiss('no_img');\n    return mangaProps.imgList;\n  });\n\n  // 同步滚动显示网页上的图片，用于以防万一保底触发漏网之鱼\n  helper.createEffectOn(Manga.renderImgList, helper.throttle(list => {\n    if (list.size === 0 || !mangaProps.show) return;\n    const lastImgIndex = [...list].at(-1);\n    if (lastImgIndex === undefined) return;\n    imgEleList[lastImgIndex]?.scrollIntoView({\n      behavior: 'instant',\n      block: 'end'\n    });\n  }, 1000), {\n    defer: true\n  });\n\n  // 在退出阅读模式时跳回之前的滚动位置\n  helper.createEffectOn(() => mangaProps.show, show => {\n    if (show) laseScroll = window.scrollY;else window.scroll({\n      top: laseScroll,\n      behavior: 'instant'\n    });\n  });\n};\n\nexports.otherSite = otherSite;\n";break;case"userscript/ehTagRules":n='\n// 使用 i18n-ally 扩展查看对应的中文翻译\n\n// 概率标签的标准：有A标签的本子中，只有 10% 的本子没有 B 标签\n// 「`A标签 -B标签` 的搜索结果数」<「`A标签` 的搜索结果数」的 10%\n// 有没有必要加上复杂规则呢？\n// - 组合标签\n//   - 单扶她 + 单女主 = 大概率「扶上女」\n// - 根据条件将「大概率」限定为「必须」\n//   - 单萝莉 + 贫乳 + (单女主) = 肯定无法共存\n// - 把画廊类型也加进标签，方便过滤 CG 集等图库\nconst rules = {"prerequisite":{"(x|f):incest":["f:cousin","f:aunt","f:daughter","f:mother","f:granddaughter","f:sister","f:grandmother","f:niece"],"(x|m):incest":["m:cousin"],"f:incest":["f:inseki","f:low_incest"],"m:incest":["m:inseki","m:low_incest"],"x:incest":["x:inseki","x:low_incest"],"f:group":["f:fff_threesome","f:ttt_threesome","f:fft_threesome","f:ttf_threesome"],"m:group":["m:mmm_threesome"],"x:group":["x:mmf_threesome","x:mmt_threesome","x:ttm_threesome","x:ffm_threesome","x:mtf_threesome","x:oyakodon","x:shimaidon","x:gang_rape"],"(x|f):group":["f:oyakodon","f:shimaidon","f:multiple_straddling","f:gang_rape","f:layer_cake","f:harem"],"(x|m):group":["m:oyakodon","m:shimaidon","m:multiple_straddling","m:gang_rape","m:layer_cake","m:harem"],"f:yuri":["f:fff_threesome"],"m:yaoi":["m:group","m:mmm_threesome"],"f:futanari":["f:ttt_threesome","f:fft_threesome","f:ttf_threesome","f:full-packaged_futanari"],"f:shemale":["f:ball-less_shemale"],"f:lolicon":["f:kodomo_doushi","x:kodomo_doushi","f:oppai_loli","f:mesugaki","f:low_lolicon"],"m:shotacon":["m:kodomo_doushi","x:kodomo_doushi"],"f:blowjob":["f:multimouth_blowjob","f:blowjob_face","f:deepthroat","f:focus_blowjob"],"m:blowjob":["m:multimouth_blowjob","m:blowjob_face","m:deepthroat","m:focus_blowjob"],"f:handjob":["f:multiple_handjob"],"m:handjob":["m:multiple_handjob"],"f:assjob":["f:multiple_assjob"],"m:assjob":["m:multiple_assjob"],"f:footjob":["f:multiple_footjob"],"m:footjob":["m:multiple_footjob"],"f:paizuri":["f:focus_paizuri"],"m:paizuri":["m:focus_paizuri"],"f:anal":["f:focus_anal","f:anal_intercourse","f:tail_plug"],"m:anal":["m:focus_anal","m:anal_intercourse","m:tail_plug"],"f:rape":["f:gang_rape"],"m:rape":["m:gang_rape"],"f:bondage":["f:fanny_packing","f:shibari"],"m:bondage":["m:fanny_packing","m:shibari"],"f:inflation":["f:cumflation"],"m:inflation":["m:cumflation"],"f:lactation":["f:milking"],"m:lactation":["m:milking"],"f:piercing":["f:nipple_piercing","f:genital_piercing"],"m:piercing":["m:nipple_piercing","m:genital_piercing"],"f:big_breasts":["f:huge_breasts","f:gigantic_breasts"],"f:huge_breasts":["f:gigantic_breasts"],"f:sex_toys":["f:tail_plug"],"m:sex_toys":["m:tail_plug"],"f:swimsuit":["f:bikini"],"m:swimsuit":["m:bikini"],"f:crossdressing":["f:schoolboy_uniform"],"f:monster_girl":["f:zombie"]},"conflict":{"f:females_only":["f:futanari","f:bisexual","f:ttt_threesome","f:fft_threesome","f:ttf_threesome","x:mmf_threesome","x:mmt_threesome","x:ttm_threesome","x:mtf_threesome","x:group","m:*","x:*"],"f:sole_female":["f:ttt_threesome","f:fft_threesome","x:mmt_threesome","x:ttm_threesome","m:mmm_threesome"],"f:sole_dickgirl":["f:fff_threesome","f:ttt_threesome","f:ttf_threesome","x:mmf_threesome","x:ttm_threesome","m:mmm_threesome"]},"possibleConflict":{"f:dark_skin":["f:tanlines"],"m:dark_skin":["m:tanlines"],"f:lolicon":["f:small_breasts"],"f:breast_feeding":["f:nipple_stimulation"]},"combo":{"f:kemonomimi":["f:horse_girl","f:dog_girl","f:mouse_girl","f:bunny_girl","f:catgirl","f:cowgirl","c:amiya","c:rosmontis","c:suzuran","c:shamare","c:schwarz"],"f:tail":["f:horse_girl","c:suzuran","c:schwarz","c:yuko_yoshida"],"f:leotard":["f:bunny_girl"],"f:horns":["f:oni","c:yuko_yoshida"],"f:horse_girl":["p:uma_musume_pretty_derby"],"f:halo":["p:blue_archive"],"f:zombie":["p:zombie_land_saga"],"f:hair_buns":["c:ayumu_uehara","c:yoshiko_tsushima","c:chisato_arashi","c:ceylon"],"f:twintails":["c:yu_takasaki","c:rurino_osawa","c:sayaka_murano","c:nico_yazawa","c:nozomi_tojo","c:ruby_kurosawa","c:ria_kazuno","c:arisa_ichigaya","c:himari_uehara","c:ako_udagawa","c:reona_nyubara","c:tsukushi_futaba","c:kotone_fujita"],"f:ponytail":["c:eli_ayase","c:honoka_kosaka","c:kanan_matsuura","c:seira_kazuno","c:ren_hazuki","c:saaya_yamabuki","c:nijika_ijichi","c:schwarz"],"f:very_long_hair":["c:hitori_gotou","c:nijika_ijichi","c:euphyllia_magenta"],"f:lolicon":["c:suzuran","c:shamare"],"f:wings":["c:remilia_scarlet","c:flandre_scarlet"],"f:vampire":["c:remilia_scarlet","c:flandre_scarlet"],"f:demon_girl":["c:yuko_yoshida"],"f:thick_eyebrows":["c:suletta_mercury"],"f:glasses":["c:junna_hoshimi"],"f:beauty_mark":["c:misuzu_hataya"],"m:crossdressing":["c:mizuki_akiyama"]}};\nconst getTagLintRules = () => {\n  const shortNamespace = new Map([[\'p\', \'parody\'], [\'c\', \'character\'], [\'g\', \'group\'], [\'a\', \'artist\'], [\'m\', \'male\'], [\'f\', \'female\'], [\'x\', \'mixed\'], [\'o\', \'other\']].map(([short, full]) => [new RegExp(`\\\\b${short}\\\\b(?=.*:)`), full]));\n  // 将缩写的命名空间转回全拼\n  const getTagName = tag => {\n    let fullTag = tag;\n    for (const re of shortNamespace.keys()) if (re.test(fullTag)) {\n      fullTag = fullTag.replace(re, shortNamespace.get(re));\n    }\n    return fullTag;\n  };\n  const createRuleMap = (map, reverse = false) => {\n    const ruleMap = new Map();\n    if (reverse) for (let [targetTag, tags] of Object.entries(map)) {\n      targetTag = getTagName(targetTag);\n      for (let tag of tags) {\n        tag = getTagName(tag);\n        if (ruleMap.has(tag)) ruleMap.get(tag).add(targetTag);else ruleMap.set(tag, new Set([targetTag]));\n      }\n    } else for (const [tag, targetTag] of Object.entries(map)) ruleMap.set(getTagName(tag), new Set(targetTag.map(getTagName)));\n    return ruleMap;\n  };\n  return {\n    prerequisite: createRuleMap(rules.prerequisite, true),\n    conflict: createRuleMap(rules.conflict),\n    possibleConflict: createRuleMap(rules.possibleConflict),\n    // 写的时候为了可以根据不同作品分类而没有反转\n    // 但为了减少代码，在打包时反转了下，所以在用时得再反转回去\n    combo: createRuleMap(rules.combo, true)\n  };\n};\n\n/** 拆分多个命名空间的标签 */\nconst splitTagNamespace = tag => {\n  if (!tag.startsWith(\'(\')) return [tag];\n  const [, namespaces, tagName] = /\\((.+?)\\)(.+)/.exec(tag);\n  return namespaces.split(\'|\').map(namespace => `${namespace}${tagName}`);\n};\n\n/** 判断是否缺少指定命名空间下的标签 */\nconst isMissingNamespace = (tagList, ...namespaces) => {\n  for (const namespace of namespaces) for (const tag of tagList) if (tag.startsWith(namespace)) return false;\n  return true;\n};\n\n/** 检查标签是否存在 */\nconst hasTag = (tagList, tagName) => {\n  if (tagName.startsWith(\'(\')) for (const tag of splitTagNamespace(tagName)) if (tagList.has(tag)) return true;\n  if (tagName.endsWith(\':*\')) return !isMissingNamespace(tagList, tagName.split(\':*\')[0]);\n  return tagList.has(tagName);\n};\n\n/** 判断是否缺少指定标签 */\nconst isMissingTags = (tagList, ...tags) => {\n  for (const tag of tags) if (tagList.has(tag)) return false;\n  return true;\n};\n\nexports.getTagLintRules = getTagLintRules;\nexports.hasTag = hasTag;\nexports.isMissingNamespace = isMissingNamespace;\nexports.isMissingTags = isMissingTags;\nexports.splitTagNamespace = splitTagNamespace;\n';break;case"main":n="\nconst solidJs = require('solid-js');\nconst web = require('solid-js/web');\nconst helper = require('helper');\nconst store = require('solid-js/store');\nconst Manga = require('components/Manga');\nconst Toast = require('components/Toast');\nconst IconButton = require('components/IconButton');\nconst fflate = require('fflate');\nconst request = require('request');\nconst Fab = require('components/Fab');\n\n// src/index.ts\nvar triggerOptions = !web.isServer && solidJs.DEV ? { equals: false, name: \"trigger\" } : { equals: false };\nvar triggerCacheOptions = !web.isServer && solidJs.DEV ? { equals: false, internal: true } : triggerOptions;\nvar TriggerCache = class {\n  #map;\n  constructor(mapConstructor = Map) {\n    this.#map = new mapConstructor();\n  }\n  dirty(key) {\n    if (web.isServer) return;\n    this.#map.get(key)?.$$();\n  }\n  dirtyAll() {\n    if (web.isServer) return;\n    for (const trigger of this.#map.values()) trigger.$$();\n  }\n  track(key) {\n    if (!solidJs.getListener()) return;\n    let trigger = this.#map.get(key);\n    if (!trigger) {\n      const [$, $$] = solidJs.createSignal(void 0, triggerCacheOptions);\n      this.#map.set(key, trigger = { $, $$, n: 1 });\n    } else trigger.n++;\n    solidJs.onCleanup(() => {\n      if (trigger.n-- === 1)\n        queueMicrotask(() => trigger.n === 0 && this.#map.delete(key));\n    });\n    trigger.$();\n  }\n};\n\n// src/index.ts\nvar $KEYS = Symbol(\"track-keys\");\nvar ReactiveSet = class extends Set {\n  #triggers = new TriggerCache();\n  constructor(values) {\n    super();\n    if (values) for (const v of values) super.add(v);\n  }\n  [Symbol.iterator]() {\n    return this.values();\n  }\n  get size() {\n    this.#triggers.track($KEYS);\n    return super.size;\n  }\n  has(value) {\n    this.#triggers.track(value);\n    return super.has(value);\n  }\n  keys() {\n    return this.values();\n  }\n  *values() {\n    this.#triggers.track($KEYS);\n    for (const value of super.values()) {\n      yield value;\n    }\n  }\n  *entries() {\n    this.#triggers.track($KEYS);\n    for (const entry of super.entries()) {\n      yield entry;\n    }\n  }\n  forEach(callbackfn, thisArg) {\n    this.#triggers.track($KEYS);\n    super.forEach(callbackfn, thisArg);\n  }\n  add(value) {\n    if (!super.has(value)) {\n      super.add(value);\n      solidJs.batch(() => {\n        this.#triggers.dirty(value);\n        this.#triggers.dirty($KEYS);\n      });\n    }\n    return this;\n  }\n  delete(value) {\n    const result = super.delete(value);\n    if (result) {\n      solidJs.batch(() => {\n        this.#triggers.dirty(value);\n        this.#triggers.dirty($KEYS);\n      });\n    }\n    return result;\n  }\n  clear() {\n    if (super.size) {\n      super.clear();\n      solidJs.batch(() => {\n        this.#triggers.dirtyAll();\n      });\n    }\n  }\n};\n\nconst MdSettings = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M19.5 12c0-.23-.01-.45-.03-.68l1.86-1.41c.4-.3.51-.86.26-1.3l-1.87-3.23a.987.987 0 0 0-1.25-.42l-2.15.91c-.37-.26-.76-.49-1.17-.68l-.29-2.31c-.06-.5-.49-.88-.99-.88h-3.73c-.51 0-.94.38-1 .88l-.29 2.31c-.41.19-.8.42-1.17.68l-2.15-.91c-.46-.2-1-.02-1.25.42L2.41 8.62c-.25.44-.14.99.26 1.3l1.86 1.41a7.3 7.3 0 0 0 0 1.35l-1.86 1.41c-.4.3-.51.86-.26 1.3l1.87 3.23c.25.44.79.62 1.25.42l2.15-.91c.37.26.76.49 1.17.68l.29 2.31c.06.5.49.88.99.88h3.73c.5 0 .93-.38.99-.88l.29-2.31c.41-.19.8-.42 1.17-.68l2.15.91c.46.2 1 .02 1.25-.42l1.87-3.23c.25-.44.14-.99-.26-1.3l-1.86-1.41c.03-.23.04-.45.04-.68m-7.46 3.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdClose = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7A.996.996 0 1 0 5.7 7.11L10.59 12 5.7 16.89a.996.996 0 1 0 1.41 1.41L12 13.41l4.89 4.89a.996.996 0 1 0 1.41-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdFileDownload = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M16.59 9H15V4c0-.55-.45-1-1-1h-4c-.55 0-1 .45-1 1v5H7.41c-.89 0-1.34 1.08-.71 1.71l4.59 4.59c.39.39 1.02.39 1.41 0l4.59-4.59c.63-.63.19-1.71-.7-1.71M5 19c0 .55.45 1 1 1h12c.55 0 1-.45 1-1s-.45-1-1-1H6c-.55 0-1 .45-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst getExtName = mime => /.+\\/([^;]+)/.exec(mime)?.[1] ?? 'jpg';\n\n/** 下载按钮 */\nconst DownloadButton = () => {\n  const [statu, setStatu] = solidJs.createSignal('button.download');\n  const handleDownload = async () => {\n    const headers = {\n      Accept: 'image/avif,image/webp,image/apng,image/svg+xml,image/*,*/*;q=0.8',\n      'User-Agent': navigator.userAgent,\n      Referer: window.location.href\n    };\n    const fileData = {};\n    const {\n      length\n    } = Manga.imgList();\n    const imgIndexNum = `${length}`.length;\n    for (let i = 0; i < length; i += 1) {\n      setStatu(`${i}/${length}`);\n      const img = Manga.imgList()[i];\n      if (Manga.store.option.translation.onlyDownloadTranslated && img.translationType !== 'show') continue;\n      const index = `${i}`.padStart(imgIndexNum, '0');\n      const url = img.translationType === 'show' ? img.translationUrl : img.src;\n      let data;\n      let fileName;\n      try {\n        const res = await request.request(url, {\n          headers,\n          responseType: 'blob',\n          errorText: `${helper.t('alert.download_failed')}: ${index}`\n        });\n        data = res.response;\n        fileName = `${index}.${getExtName(data.type)}`;\n      } catch {\n        fileName = `${index} - ${helper.t('alert.download_failed')}`;\n      }\n      fileData[fileName] = new Uint8Array((await data?.arrayBuffer()) ?? []);\n    }\n    if (Object.keys(fileData).length === 0) {\n      Toast.toast.warn(helper.t('alert.no_img_download'));\n      setStatu('button.download');\n      return;\n    }\n    setStatu('button.packaging');\n    const zipped = fflate.zipSync(fileData, {\n      level: 0,\n      comment: window.location.href\n    });\n    helper.saveAs(new Blob([zipped]), `${Manga.store.title || document.title}.zip`);\n    setStatu('button.download_completed');\n    Toast.toast.success(helper.t('button.download_completed'));\n  };\n  const tip = solidJs.createMemo(() => helper.t(statu()) || `${helper.t('button.downloading')} - ${statu()}`);\n  return web.createComponent(IconButton.IconButton, {\n    get tip() {\n      return tip();\n    },\n    onClick: handleDownload,\n    get enabled() {\n      return statu() !== 'button.download';\n    },\n    get children() {\n      return web.createComponent(MdFileDownload, {});\n    }\n  });\n};\n\nlet dom$1;\n\n/**\n * 显示漫画阅读窗口\n */\nconst useManga = async initProps => {\n  GM_addStyle(`\n    #comicRead {\n      position: fixed;\n      top: 0;\n      left: 0;\n      transform: scale(0);\n\n      width: 100%;\n      height: 100%;\n\n      font-size: 16px;\n\n      opacity: 0;\n\n      transition: opacity 300ms, transform 0s 300ms;\n    }\n\n    #comicRead[show] {\n      transform: scale(1);\n      opacity: 1;\n      transition: opacity 300ms, transform 100ms;\n    }\n\n    /* 防止其他扩展的元素显示到漫画上来 */\n    #comicRead[show] ~ :not(#fab, #toast, .comicread-ignore) {\n      display: none !important;\n      pointer-events: none !important;\n      visibility: hidden !important;\n      opacity: 0 !important;\n      z-index: 1 !important;\n    }\n  `);\n  const [props, setProps] = store.createStore({\n    imgList: [],\n    show: false,\n    ...initProps\n  });\n  dom$1 = helper.mountComponents('comicRead', () => web.createComponent(Manga.Manga, props));\n  dom$1.style.setProperty('z-index', '2147483647', 'important');\n\n  // 确保 toast 可以显示在漫画之上\n  const toastDom = helper.querySelector('#toast');\n  if (toastDom) dom$1.after(toastDom);\n  const htmlStyle = document.documentElement.style;\n  let lastOverflow = htmlStyle.overflow;\n  helper.createEffectOn(helper.createRootMemo(() => props.show && props.imgList.length > 0), show => {\n    if (show) {\n      dom$1.setAttribute('show', '');\n      lastOverflow = htmlStyle.overflow;\n      htmlStyle.setProperty('overflow', 'hidden', 'important');\n      htmlStyle.setProperty('scrollbar-width', 'none', 'important');\n    } else {\n      dom$1.removeAttribute('show');\n      htmlStyle.overflow = lastOverflow;\n      htmlStyle.removeProperty('scrollbar-width');\n    }\n  }, {\n    defer: true\n  });\n  const ExitButton = () => web.createComponent(IconButton.IconButton, {\n    get tip() {\n      return helper.t('button.exit');\n    },\n    onClick: () => props.onExit?.(),\n    get children() {\n      return web.createComponent(MdClose, {});\n    }\n  });\n  setProps({\n    onExit: () => setProps('show', false),\n    editButtonList(list) {\n      // 在设置按钮上方放置下载按钮\n      list.splice(-1, 0, DownloadButton);\n      return [...list,\n      // 再在最下面添加分隔栏和退出按钮\n      Manga.buttonListDivider, ExitButton];\n    }\n  });\n  return [setProps, props];\n};\n\nconst MdMenuBook = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M17.5 4.5c-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5-1.45 0-2.99.22-4.28.79C1.49 5.62 1 6.33 1 7.14v11.28c0 1.3 1.22 2.26 2.48 1.94.98-.25 2.02-.36 3.02-.36 1.56 0 3.22.26 4.56.92.6.3 1.28.3 1.87 0 1.34-.67 3-.92 4.56-.92 1 0 2.04.11 3.02.36 1.26.33 2.48-.63 2.48-1.94V7.14c0-.81-.49-1.52-1.22-1.85-1.28-.57-2.82-.79-4.27-.79M21 17.23c0 .63-.58 1.09-1.2.98-.75-.14-1.53-.2-2.3-.2-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5.92 0 1.83.09 2.7.28.46.1.8.51.8.98z\"></path><path d=\"M13.98 11.01c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.54-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.71-.83.66c-1.62-.19-3.39-.04-4.73.39-.08.01-.16.03-.23.03m0 2.66c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.53-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.71-.83.66c-1.62-.19-3.39-.04-4.73.39a1 1 0 0 1-.23.03m0 2.66c-.32 0-.61-.2-.71-.52-.13-.39.09-.82.48-.94 1.53-.5 3.53-.66 5.36-.45.41.05.71.42.66.83s-.42.7-.83.66c-1.62-.19-3.39-.04-4.73.39a1 1 0 0 1-.23.03\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdImageSearch = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M18 15v4c0 .55-.45 1-1 1H5c-.55 0-1-.45-1-1V7c0-.55.45-1 1-1h3.02c.55 0 1-.45 1-1s-.45-1-1-1H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-5c0-.55-.45-1-1-1s-1 .45-1 1m-2.5 3H6.52c-.42 0-.65-.48-.39-.81l1.74-2.23a.5.5 0 0 1 .78-.01l1.56 1.88 2.35-3.02c.2-.26.6-.26.79.01l2.55 3.39c.25.32.01.79-.4.79m3.8-9.11c.48-.77.75-1.67.69-2.66-.13-2.15-1.84-3.97-3.97-4.2A4.5 4.5 0 0 0 11 6.5c0 2.49 2.01 4.5 4.49 4.5.88 0 1.7-.26 2.39-.7l2.41 2.41c.39.39 1.03.39 1.42 0s.39-1.03 0-1.42zM15.5 9a2.5 2.5 0 0 1 0-5 2.5 2.5 0 0 1 0 5\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdImportContacts = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M17.5 4.5c-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5-1.45 0-2.99.22-4.28.79C1.49 5.62 1 6.33 1 7.14v11.28c0 1.3 1.22 2.26 2.48 1.94.98-.25 2.02-.36 3.02-.36 1.56 0 3.22.26 4.56.92.6.3 1.28.3 1.87 0 1.34-.67 3-.92 4.56-.92 1 0 2.04.11 3.02.36 1.26.33 2.48-.63 2.48-1.94V7.14c0-.81-.49-1.52-1.22-1.85-1.28-.57-2.82-.79-4.27-.79M21 17.23c0 .63-.58 1.09-1.2.98-.75-.14-1.53-.2-2.3-.2-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5.92 0 1.83.09 2.7.28.46.1.8.51.8.98z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdCloudDownload = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M19.35 10.04A7.49 7.49 0 0 0 12 4C9.11 4 6.6 5.64 5.35 8.04A5.994 5.994 0 0 0 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96M17 13l-4.65 4.65c-.2.2-.51.2-.71 0L7 13h3V9h4v4z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nlet dom;\nconst useFab = async initProps => {\n  GM_addStyle(`\n    #fab {\n      --text-bg: transparent;\n\n      position: fixed;\n      right: 3vw;\n      bottom: 6vh;\n\n      font-size: clamp(12px, 1.5vw, 16px);\n    }\n  `);\n  const [props, setProps] = store.createStore({\n    ...initProps\n  });\n  const FabIcon = () => {\n    switch (props.progress) {\n      case undefined:\n        {\n          // 没有内容的书\n          return MdImportContacts;\n        }\n      case 1:\n      case 2:\n        {\n          // 有内容的书\n          return MdMenuBook;\n        }\n      default:\n        {\n          return props.progress > 1 ? MdCloudDownload : MdImageSearch;\n        }\n    }\n  };\n  dom = helper.mountComponents('fab', () => web.createComponent(Fab.Fab, web.mergeProps(props, {\n    get children() {\n      return props.children ?? web.createComponent(web.Dynamic, {\n        get component() {\n          return FabIcon();\n        }\n      });\n    }\n  })));\n  dom.style.setProperty('z-index', '2147483646', 'important');\n  return [setProps, props];\n};\n\nconst MdAutoFixHigh = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"m20.45 6 .49-1.06L22 4.45a.5.5 0 0 0 0-.91l-1.06-.49L20.45 2a.5.5 0 0 0-.91 0l-.49 1.06-1.05.49a.5.5 0 0 0 0 .91l1.06.49.49 1.05c.17.39.73.39.9 0M8.95 6l.49-1.06 1.06-.49a.5.5 0 0 0 0-.91l-1.06-.48L8.95 2a.492.492 0 0 0-.9 0l-.49 1.06-1.06.49a.5.5 0 0 0 0 .91l1.06.49L8.05 6c.17.39.73.39.9 0m10.6 7.5-.49 1.06-1.06.49a.5.5 0 0 0 0 .91l1.06.49.49 1.06a.5.5 0 0 0 .91 0l.49-1.06 1.05-.5a.5.5 0 0 0 0-.91l-1.06-.49-.49-1.06c-.17-.38-.73-.38-.9.01m-1.84-4.38-2.83-2.83a.996.996 0 0 0-1.41 0L2.29 17.46a.996.996 0 0 0 0 1.41l2.83 2.83c.39.39 1.02.39 1.41 0L17.7 10.53c.4-.38.4-1.02.01-1.41m-3.5 2.09L12.8 9.8l1.38-1.38 1.41 1.41z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdAutoFixOff = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"m22 3.55-1.06-.49L20.45 2a.5.5 0 0 0-.91 0l-.49 1.06-1.05.49a.5.5 0 0 0 0 .91l1.06.49.49 1.05a.5.5 0 0 0 .91 0l.49-1.06L22 4.45c.39-.17.39-.73 0-.9m-7.83 4.87 1.41 1.41-1.46 1.46 1.41 1.41 2.17-2.17a.996.996 0 0 0 0-1.41l-2.83-2.83a.996.996 0 0 0-1.41 0l-2.17 2.17 1.41 1.41zM2.1 4.93l6.36 6.36-6.17 6.17a.996.996 0 0 0 0 1.41l2.83 2.83c.39.39 1.02.39 1.41 0l6.17-6.17 6.36 6.36a.996.996 0 1 0 1.41-1.41L3.51 3.51a.996.996 0 0 0-1.41 0c-.39.4-.39 1.03 0 1.42\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdFlashOn = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M7 3v9c0 .55.45 1 1 1h2v7.15c0 .51.67.69.93.25l5.19-8.9a.995.995 0 0 0-.86-1.5H13l2.49-6.65A.994.994 0 0 0 14.56 2H8c-.55 0-1 .45-1 1\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdFlashOff = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M16.12 11.5a.995.995 0 0 0-.86-1.5h-1.87l2.28 2.28zm.16-8.05c.33-.67-.15-1.45-.9-1.45H8c-.55 0-1 .45-1 1v.61l6.13 6.13zm2.16 14.43L4.12 3.56a.996.996 0 1 0-1.41 1.41L7 9.27V12c0 .55.45 1 1 1h2v7.15c0 .51.67.69.93.25l2.65-4.55 3.44 3.44c.39.39 1.02.39 1.41 0 .4-.39.4-1.02.01-1.41\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdLockOpen = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M12 13c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m6-5h-1V6c0-2.76-2.24-5-5-5-2.28 0-4.27 1.54-4.84 3.75-.14.54.18 1.08.72 1.22a1 1 0 0 0 1.22-.72A2.996 2.996 0 0 1 12 3c1.65 0 3 1.35 3 3v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2m0 11c0 .55-.45 1-1 1H7c-.55 0-1-.45-1-1v-8c0-.55.45-1 1-1h10c.55 0 1 .45 1 1z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst MdLock = (props = {}) => (() => {\n  var _el$ = web.template(`<svg xmlns=http://www.w3.org/2000/svg viewBox=\"0 0 24 24\"stroke=currentColor fill=currentColor stroke-width=0><path d=\"M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2m-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2M9 8V6c0-1.66 1.34-3 3-3s3 1.34 3 3v2z\">`)();\n  web.spread(_el$, props, true, true);\n  return _el$;\n})();\n\nconst useSpeedDial = (options, setOptions) => {\n  const DefaultButton = props => web.createComponent(IconButton.IconButton, {\n    placement: \"left\",\n    showTip: true,\n    get tip() {\n      return props.showName ?? (helper.t(`site.add_feature.${props.optionName}`) || props.optionName);\n    },\n    onClick: () => setOptions({\n      [props.optionName]: !options[props.optionName]\n    }),\n    get children() {\n      return props.children ?? (options[props.optionName] ? web.createComponent(MdAutoFixHigh, {}) : web.createComponent(MdAutoFixOff, {}));\n    }\n  });\n  const list = Object.keys(options).map(optionName => {\n    switch (optionName) {\n      case 'hiddenFAB':\n      case 'option':\n        return null;\n      case 'autoShow':\n        return () => web.createComponent(DefaultButton, {\n          optionName: \"autoShow\",\n          get showName() {\n            return helper.t('site.add_feature.auto_show');\n          },\n          get children() {\n            return web.memo(() => !!options.autoShow)() ? web.createComponent(MdFlashOn, {}) : web.createComponent(MdFlashOff, {});\n          }\n        });\n      case 'lockOption':\n        return () => web.createComponent(DefaultButton, {\n          optionName: \"lockOption\",\n          get showName() {\n            return helper.t('site.add_feature.lock_option');\n          },\n          get children() {\n            return web.memo(() => !!options.lockOption)() ? web.createComponent(MdLock, {}) : web.createComponent(MdLockOpen, {});\n          }\n        });\n      default:\n        if (typeof options[optionName] !== 'boolean') return null;\n        return () => web.createComponent(DefaultButton, {\n          optionName: optionName\n        });\n    }\n  }).filter(Boolean);\n  return list;\n};\n\n/** 判断版本号1是否小于版本号2 */\nconst versionLt = (version1, version2) => {\n  const v1 = version1.split('.').map(Number);\n  const v2 = version2.split('.').map(Number);\n  for (let i = 0; i < 3; i++) {\n    const num1 = v1[i] ?? 0;\n    const num2 = v2[i] ?? 0;\n    if (num1 !== num2) return num1 < num2;\n  }\n  return false;\n};\n/** 在版本号1小于版本号2时显示提示。确保从旧版本跳级上来的用户不会错过 */\nconst VersionTip = props => // 确保从旧版本直接更新上来的用户可以看到改动提示\nweb.createComponent(solidJs.Show, {\n  get when() {\n    return versionLt(props.v1, props.v2);\n  },\n  get children() {\n    return props.children;\n  }\n});\n\nconst migrationOption = async (name, editFn) => {\n  try {\n    const option = await GM.getValue(name);\n    if (!option) throw new Error(`GM.getValue Error: not found ${name}`);\n    await editFn(option, () => GM.setValue(name, option));\n  } catch (error) {\n    helper.log.error(`migration ${name} option error:`, error);\n  }\n};\n\n/** 重命名配置项 */\nconst renameOption = async (name, list) => migrationOption(name, (option, save) => {\n  for (const itemText of list) {\n    const [path, newName] = itemText.split(' => ');\n    helper.byPath(option, path, (parent, key) => {\n      helper.log('rename Option', itemText);\n      if (newName) Reflect.set(parent, newName, parent[key]);\n      Reflect.deleteProperty(parent, key);\n    });\n  }\n  return save();\n});\n\n/** 旧版本配置迁移 */\nconst migration = async () => {\n  // 任何样式修改都得更新 css 才行，干脆直接删了\n  GM.deleteValue('ehTagColorizeCss');\n  GM.deleteValue('ehTagSortCss');\n  const values = await GM.listValues();\n\n  // 8 => 9\n  for (const key of values) {\n    switch (key) {\n      case 'Version':\n      case 'Languages':\n      case 'ehTagColorizeCss':\n      case 'ehTagSortCss':\n        continue;\n      case 'Hotkeys':\n        {\n          await renameOption(key, [\n          // 原本上下快捷键是混在一起的，现在分开后要迁移太麻烦了，应该也没多少人改，就直接删了\n          'turn_page_up => ', 'turn_page_down => ', 'turn_page_right => scroll_right', 'turn_page_left => scroll_left']);\n          break;\n        }\n      default:\n        await migrationOption(key, (option, save) => {\n          if (typeof option.option?.scrollMode !== 'boolean') return;\n          option.option.scrollMode = {\n            enabled: option.option.scrollMode,\n            spacing: option.option.scrollModeSpacing,\n            imgScale: option.option.scrollModeImgScale,\n            fitToWidth: option.option.scrollModeFitToWidth\n          };\n          return save();\n        });\n    }\n  }\n\n  // 9.3 => 9.4\n  await migrationOption('ehentai', (option, save) => {\n    if (!Reflect.has(option, 'hotkeys_page_turn')) return;\n    option.hotkeys = option.hotkeys_page_turn;\n    Reflect.deleteProperty(option, 'hotkeys_page_turn');\n    return save();\n  });\n};\n\n/** 处理版本更新相关 */\nconst handleVersionUpdate = async () => {\n  const version = await GM.getValue('Version');\n  if (!version) return GM.setValue('Version', GM.info.script.version);\n  if (version === GM.info.script.version) return;\n\n  // 每次版本更新都执行一遍迁移\n  await migration();\n\n  // 只在语言为中文时弹窗提示最新更新内容\n  if (helper.lang() === 'zh') {\n    Toast.toast(() => /* eslint-disable i18next/no-literal-string */[(() => {\n      var _el$ = web.template(`<h2>🥳 ComicRead 已更新到 v`)();\n        _el$.firstChild;\n      web.insert(_el$, () => GM.info.script.version, null);\n      return _el$;\n    })(), web.template(`<h3>新增`)(), web.template(`<ul><li>支持 NoyAcg`)(), web.template(`<h3>修复`)(), web.template(`<ul><li><p>修复放大后拖拽不跟手的 bug </p></li><li><p>修复拷贝漫画解锁隐藏漫画不支持移动端的 bug`)(), web.createComponent(VersionTip, {\n      v1: version,\n      v2: '10.8.0',\n      get children() {\n        return [web.template(`<h3>改动`)(), web.template(`<ul><li>ehentai 悬浮标签列表的透明度调节<br>由「鼠标滚轮」改为「Shift + 鼠标滚轮」`)()];\n      }\n    })] /* eslint-enable i18next/no-literal-string */, {\n      id: 'Version Tip',\n      type: 'custom',\n      duration: Number.POSITIVE_INFINITY,\n      // 手动点击关掉通知后才不会再次弹出\n      onDismiss: () => GM.setValue('Version', GM.info.script.version)\n    });\n\n    // 监听储存的版本数据的变动，如果和当前版本一致就关掉弹窗\n    // 防止在更新版本后一次性打开多个页面，不得不一个一个关过去\n    const listenerId = await GM.addValueChangeListener('Version', async (_, __, newVersion) => {\n      if (newVersion !== GM.info.script.version) return;\n      Toast.toast.dismiss('Version Tip');\n      await GM.removeValueChangeListener(listenerId);\n    });\n  } else await GM.setValue('Version', GM.info.script.version);\n};\n\n/** 清理多余的配置项 */\nconst clear = (options, defaultOptions) => {\n  let isClear = false;\n  for (const key of Object.keys(options)) {\n    if (Reflect.has(defaultOptions, key)) continue;\n    Reflect.deleteProperty(options, key);\n    isClear = true;\n  }\n  return isClear;\n};\n\n/**\n * 对修改站点配置的相关方法的封装\n * @param name 站点名\n * @param defaultOptions 默认配置\n */\nconst useSiteOptions = async (name, defaultOptions = {}) => {\n  const _defaultOptions = {\n    option: undefined,\n    defaultOption: undefined,\n    autoShow: true,\n    lockOption: false,\n    hiddenFAB: false,\n    ...defaultOptions\n  };\n  const saveOptions = await GM.getValue(name);\n  const options = store.createMutable(helper.assign(_defaultOptions, saveOptions));\n  const setOptions = async newOptions => {\n    const lockOption = options.lockOption;\n    if (newOptions) Object.assign(options, newOptions);\n    if (lockOption && newOptions?.lockOption !== false) return;\n    // 只保存和默认设置不同的部分\n    return GM.setValue(name, helper.difference(options, _defaultOptions));\n  };\n  const isStored = saveOptions !== undefined;\n  // 如果当前站点没有存储配置，就补充上去\n  if (!isStored) await GM.setValue(name, {});\n  // 否则检查是否有多余的配置\n  else if (clear(options, _defaultOptions)) await setOptions();\n  return {\n    /** 站点配置 */\n    options,\n    /** 修改站点配置 */\n    setOptions,\n    /** 是否存过配置 */\n    isStored\n  };\n};\n\nconst [hotkeys, setHotkeys] = solidJs.createSignal({});\n\n/**\n * 对基础的初始化操作的封装\n * @param name 站点名\n * @param defaultOptions 默认配置\n */\nconst useInit = async (name, defaultOptions = {}) => {\n  await helper.setInitLang();\n  await handleVersionUpdate();\n  const {\n    options,\n    setOptions,\n    isStored\n  } = await useSiteOptions(name, defaultOptions);\n  const [setFab, fabProps] = await useFab({\n    tip: helper.t('other.read_mode'),\n    speedDial: useSpeedDial(options, setOptions),\n    show: false\n  });\n  setHotkeys(await GM.getValue('Hotkeys', {}));\n  Manga.setDefaultHotkeys(_hotkeys => ({\n    ..._hotkeys,\n    enter_read_mode: ['v']\n  }));\n  const [setManga, mangaProps] = await useManga({\n    imgList: [],\n    option: options.option,\n    defaultOption: options.defaultOption,\n    onOptionChange: option => setOptions({\n      option\n    }),\n    hotkeys: hotkeys(),\n    onHotkeysChange(newValue) {\n      GM.setValue('Hotkeys', newValue);\n      setHotkeys(newValue);\n    }\n  });\n  const [comicMap, setComicMap] = store.createStore({});\n  const [nowComic, switchComic] = solidJs.createSignal('');\n  const setImgList = (id, i, url) => {\n    // XXX: 之后用 Array.with() 替换\n    const newImgList = [...comicMap[id].imgList];\n    newImgList[i] = url;\n    setComicMap(id, 'imgList', newImgList);\n  };\n  const nowImgList = helper.createRootMemo(() => {\n    const comic = comicMap[nowComic()];\n    if (!comic?.imgList) return undefined;\n    if (!comic.adList?.size) return comic.imgList;\n    return comic.imgList.filter((_, i) => !comic.adList?.has(i));\n  });\n  helper.createEffectOn(nowImgList, list => list && setManga('imgList', list));\n\n  /** 当前已取得 url 的图片数量 */\n  const loadImgNum = helper.createRootMemo(() => nowImgList()?.filter(Boolean)?.length);\n\n  // 设置 Fab 的显示进度\n  helper.createEffectOn([loadImgNum, () => Manga.loadingImgList().size, () => nowImgList()?.length], ([doneNum, loadNum, totalNum]) => {\n    if (doneNum === undefined || totalNum === undefined) return setFab({\n      progress: undefined\n    });\n    if (totalNum === 0) return setFab({\n      progress: 0,\n      tip: `${helper.t('other.loading_img')} - ${doneNum}/${totalNum}`\n    });\n\n    // 加载图片 url 阶段的进度\n    if (doneNum < totalNum) return setFab({\n      progress: doneNum / totalNum,\n      tip: `${helper.t('other.loading_img')} - ${doneNum}/${totalNum}`\n    });\n\n    // 图片加载阶段的进度\n    if (loadNum < totalNum) return setFab({\n      progress: 1 + loadNum / totalNum,\n      tip: `${helper.t('other.img_loading')} - ${loadNum}/${totalNum}`\n    });\n    return setFab({\n      progress: 1 + loadNum / totalNum,\n      tip: helper.t('other.read_mode'),\n      show: !options.hiddenFAB && undefined\n    });\n  });\n  let menuId;\n  /** 更新显示/隐藏悬浮按钮的菜单项 */\n  const updateHideFabMenu = async () => {\n    await GM.unregisterMenuCommand(menuId);\n    menuId = await GM.registerMenuCommand(options.hiddenFAB ? helper.t('other.fab_show') : helper.t('other.fab_hidden'), async () => {\n      await setOptions({\n        ...options,\n        hiddenFAB: !options.hiddenFAB\n      });\n      setFab('show', !options.hiddenFAB && undefined);\n      await updateHideFabMenu();\n    });\n  };\n  await GM.registerMenuCommand(helper.t('site.show_settings_menu'), () => setFab({\n    show: true,\n    focus: true,\n    tip: helper.t('site.settings_tip'),\n    children: web.createComponent(MdSettings, {}),\n    onBackdropClick: () => setFab({\n      show: false,\n      focus: false\n    })\n  }));\n\n  /** 当前是否还需要判断 autoShow */\n  const needAutoShow = {\n    val: true\n  };\n  const loadComic = async (id = nowComic()) => {\n    if (!Reflect.has(comicMap, id)) throw new Error('comic id error');\n    try {\n      setComicMap(id, 'imgList', []);\n      const newImgList = await comicMap[id].getImgList();\n      if (newImgList.length === 0) throw new Error(helper.t('alert.fetch_comic_img_failed'));\n      setComicMap(id, 'imgList', newImgList);\n    } catch (error) {\n      setComicMap(id, 'imgList', undefined);\n      helper.log.error(error);\n      throw error;\n    }\n  };\n  const showComic = async (id = nowComic()) => {\n    if (!Reflect.has(comicMap, id)) throw new Error('comic id error');\n    if (id !== nowComic()) switchComic(id);\n    switch (comicMap[id].imgList?.length) {\n      case 0:\n        return Toast.toast.warn(helper.t('alert.repeat_load'), {\n          duration: 1500\n        });\n      case undefined:\n        {\n          try {\n            await loadComic(id);\n            needAutoShow.val = false;\n          } catch (error) {\n            return Toast.toast.error(error.message);\n          }\n        }\n    }\n    setManga('show', true);\n  };\n  const init = () => {\n    setFab({\n      onClick: showComic,\n      show: !options.hiddenFAB && undefined\n    });\n    if (needAutoShow.val && options.autoShow) setTimeout(showComic);\n    (async () => {\n      await GM.registerMenuCommand(helper.t('other.enter_comic_read_mode'), () => fabProps.onClick?.());\n      await updateHideFabMenu();\n    })();\n    helper.linstenKeydown(e => {\n      const code = helper.getKeyboardCode(e);\n      if (Manga.hotkeysMap()[code] !== 'enter_read_mode') return;\n      e.stopPropagation();\n      e.preventDefault();\n      fabProps.onClick?.();\n    });\n  };\n  return {\n    options,\n    setOptions,\n    setFab,\n    setManga,\n    mangaProps,\n    fabProps,\n    needAutoShow,\n    isStored,\n    comicMap,\n    setComicMap,\n    setImgList,\n    nowComic,\n    switchComic,\n    showComic,\n    loadComic,\n    /** 设置对应漫画的加载函数 */\n    setComicLoad(getImgList, id = '') {\n      setComicMap(id, {\n        imgList: undefined,\n        getImgList\n      });\n      if (menuId === undefined) return init();\n    },\n    dynamicLoad: (loadImgFn, length, id = '') => async () => {\n      if (comicMap[id].imgList?.length) return comicMap[id].imgList;\n      setComicMap(id, 'imgList', Array.from({\n        length: typeof length === 'number' ? length : length()\n      }).fill(''));\n      // eslint-disable-next-line no-async-promise-executor\n      await new Promise(async resolve => {\n        try {\n          await loadImgFn((i, url) => resolve(setImgList(id, i, url)));\n        } catch (error) {\n          Toast.toast.error(error.message);\n        }\n      });\n      return comicMap[id].imgList;\n    }\n  };\n};\n\n/**\n * 通过监视点击等会触发动态加载的事件，在触发后执行指定动作\n * @param update 动态加载后的重新加载\n */\nconst autoUpdate = update => {\n  const refresh = helper.singleThreaded(update);\n  for (const eventName of ['click', 'popstate']) window.addEventListener(eventName, refresh, {\n    capture: true\n  });\n  refresh();\n};\n\n/** 对简单站点的通用解 */\nconst universal = async ({\n  name,\n  wait: waitFn,\n  getImgList,\n  onPrev,\n  onNext,\n  onExit,\n  getCommentList,\n  initOptions,\n  SPA\n}) => {\n  if (SPA?.isMangaPage) await helper.wait(SPA?.isMangaPage);\n  if (waitFn) await helper.wait(waitFn);\n  const fnMap = await useInit(name, initOptions);\n  const {\n    options,\n    setComicLoad,\n    setManga,\n    setFab,\n    needAutoShow,\n    setComicMap,\n    showComic\n  } = fnMap;\n  setComicLoad(() => getImgList(fnMap));\n  if (onExit) setManga({\n    onExit(isEnd) {\n      onExit?.(isEnd);\n      setManga({\n        show: false\n      });\n    }\n  });\n  if (!SPA) {\n    if (onNext ?? onPrev) setManga({\n      onNext,\n      onPrev\n    });\n    if (getCommentList) setManga({\n      commentList: await getCommentList()\n    });\n    return;\n  }\n  const {\n    isMangaPage,\n    getOnPrev,\n    getOnNext\n  } = SPA;\n  const handlePageurl = SPA?.handlePageurl ?? (location => location.href);\n  let lastUrl = '';\n  autoUpdate(async () => {\n    if (!(await helper.wait(() => handlePageurl(window.location) !== lastUrl, 5000))) return;\n    lastUrl = handlePageurl(window.location);\n    if (isMangaPage && !(await isMangaPage())) {\n      setFab('show', false);\n      setManga({\n        show: false\n      });\n      setComicMap('', 'imgList', undefined);\n      return;\n    }\n    if (waitFn) await helper.wait(waitFn);\n    setManga({\n      onPrev: undefined,\n      onNext: undefined\n    });\n    needAutoShow.val = options.autoShow;\n    setComicMap('', 'imgList', undefined);\n    if (needAutoShow.val && options.autoShow) await showComic('');\n    await Promise.all([(async () => getCommentList && setManga({\n      commentList: await getCommentList()\n    }))(), (async () => getOnPrev && setManga({\n      onPrev: await helper.wait(getOnPrev, 5000)\n    }))(), (async () => getOnNext && setManga({\n      onNext: await helper.wait(getOnNext, 5000)\n    }))()]);\n  });\n};\n\nObject.defineProperty(exports, \"toast\", {\n  enumerable: true,\n  get: () => Toast.toast\n});\nObject.defineProperty(exports, \"request\", {\n  enumerable: true,\n  get: () => request.request\n});\nexports.ReactiveSet = ReactiveSet;\nexports.handleVersionUpdate = handleVersionUpdate;\nexports.hotkeys = hotkeys;\nexports.renameOption = renameOption;\nexports.setHotkeys = setHotkeys;\nexports.universal = universal;\nexports.useInit = useInit;\nexports.useSiteOptions = useSiteOptions;\nexports.useSpeedDial = useSpeedDial;\n";break;default:n=GM_getResourceText(e.replaceAll("/","|"))}if(!n)throw new Error(`外部模块 ${e} 未在 @Resource 中声明`);if(e.startsWith("worker/")&&supportWorker)try{const t=`\nconst exports = {};\nconst Comlink = require('comlink');\n${n}\nComlink.expose(exports);\n`.replaceAll(/const (\w+?) = require\('(.+?)'\);/g,((e,n,t)=>`\nlet ${n} = {};\n(function (exports, module) { ${GM_getResourceText(t)} }) (\n  ${n},\n  {\n    set exports(value) { ${n} = value },\n    get exports() { return ${n} }\n  }\n);`)),o=URL.createObjectURL(new Blob([t],{type:"text/javascript"}));setTimeout(URL.revokeObjectURL,0,o);const a=new Worker(o);return void(unsafeWindow[tempName][e]=require("comlink").wrap(a))}catch{supportWorker=!1}let t=`\n    (function (process, require, exports, module, ${gmApiList.join(", ")}) {\n      ${n}\n    })(\n      window['${tempName}'].process,\n      window['${tempName}'].require,\n      window['${tempName}']['${e}'],\n      ((module) => ({\n        set exports(value) {\n          module['${e}'] = value;\n        },\n        get exports() {\n          return module['${e}'];\n        },\n      }))(window['${tempName}']),\n      ${gmApiList.map((e=>`window['${tempName}'].${e}`)).join(", ")}\n    );\n  `;unsafeWindow[tempName]=crsLib,unsafeWindow[tempName][e]={},evalCode(t),Reflect.deleteProperty(unsafeWindow,tempName)},require=e=>{const n={value:!0},t=()=>{};t.default={};const o=new Proxy(t,{get(t,a){if("__esModule"===a)return n;if("default"===a)return o;crsLib[e]||selfImportSync(e);const r=crsLib[e];return Reflect.has(crsLib[e],"default")&&Reflect.has(crsLib[e].default,a)?r.default?.[a]:r?.[a]},apply(n,t,o){crsLib[e]||selfImportSync(e);const a=crsLib[e];return("function"==typeof a.default?a.default:a)(...o)},construct(n,t){crsLib[e]||selfImportSync(e);const o=crsLib[e];return new("function"==typeof o.default?o.default:o)(...t)}});return o};crsLib.require=require;const languages=require("helper/languages"),otherSite=require("userscript/otherSite"),helper=require("helper"),main=require("main");let options;try{switch(window.location.hostname){case"bbs.yamibo.com":{const e=require("solid-js/web"),n=require("solid-js"),t=require("main"),o=require("helper");(async()=>{const{options:a,setComicLoad:r,showComic:s,loadComic:i,setManga:l,needAutoShow:c}=await t.useInit("yamibo",{"记录阅读进度":!0,"关闭快捷导航的跳转":!0,"修正点击页数时的跳转判定":!0,"固定导航条":!0,"自动签到":!0});if(GM_addStyle(`#fab { --fab: #6E2B19; }\n\n    ${a.固定导航条?".header-stackup { position: fixed !important }":""}\n\n    .historyTag {\n      white-space: nowrap;\n\n      border: 2px solid #6e2b19;\n    }\n\n    a.historyTag {\n      font-weight: bold;\n\n      margin-left: 1em;\n      padding: 1px 4px;\n\n      color: #6e2b19;\n      border-radius: 4px 0 0 4px;\n    }\n    a.historyTag:last-child {\n      border-radius: 4px;\n    }\n\n    div.historyTag {\n      display: initial;\n\n      margin-left: -.4em;\n      padding: 1px;\n\n      color: RGB(255, 237, 187);\n      border-radius: 0 4px 4px 0;\n      background-color: #6e2b19;\n    }\n\n    #threadlisttableid tbody:nth-child(2n) div.historyTag {\n      color: RGB(255, 246, 215);\n    }\n\n    /* 将「回复/查看」列加宽一点 */\n    .tl .num {\n      width: 80px !important;\n    }\n    `),unsafeWindow.discuz_uid&&"0"!==unsafeWindow.discuz_uid&&a.自动签到&&(async()=>{const e=(new Date).toLocaleDateString("zh-CN");if(e===localStorage.getItem("signDate"))return;const n=o.querySelector('#scbar_form > input[name="formhash"]')?.value;if(n)try{const o=await fetch(`plugin.php?id=zqlj_sign&sign=${n}`),a=await o.text();if(!/成功！|打过卡/.test(a))throw new Error("自动签到失败");t.toast.success("自动签到成功"),localStorage.setItem("signDate",e)}catch{t.toast.error("自动签到失败")}})(),a.关闭快捷导航的跳转&&o.querySelector("#qmenu a")?.setAttribute("href","javascript:;"),/thread(-\d+){3}|mod=viewthread/.test(document.URL)){for(const e of o.querySelectorAll('img[file*="sinaimg.cn"]'))e.setAttribute("referrerpolicy","no-referrer");const e=unsafeWindow.fid??Number(new URLSearchParams(o.querySelector("h2 > a")?.href).get("fid")??"-1");if(30===e||37===e){!o.querySelector(".pg > .prev")||(c.val=!1);let e=o.querySelectorAll(":is(.t_fsz, .message) img");const n=()=>{let n=e.length;for(;n--;){const t=e[n],o=t.getAttribute("file");o&&t.src!==o&&(t.setAttribute("src",o),t.setAttribute("lazyloaded","true")),(t.src.includes("static/image")||t.complete&&t.naturalHeight&&t.naturalWidth&&t.naturalHeight<500&&t.naturalWidth<500)&&e.splice(n,1)}return e.map((e=>e.src))};r(n),l({onLoading(e,n){if(n&&n.width<500&&n.height<500)return i()},onExit(e){e&&o.scrollIntoView(".psth, .rate, #postlist > div:nth-of-type(2)"),l("show",!1)}}),o.querySelector("div.pti > div.authi")&&(o.querySelector("div.pti > div.authi").insertAdjacentHTML("beforeend",'<span class="pipe show">|</span><a id="comicReadMode" class="show" href="javascript:;">漫画阅读</a>'),document.getElementById("comicReadMode")?.addEventListener("click",(()=>s()))),o.querySelector("#threadindex")&&o.hijackFn("ajaxinnerhtml",(()=>{e=o.querySelectorAll(".t_fsz img"),0!==e.length&&0!==n().length&&a.autoShow&&s()}));const d=o.querySelector(".ptg.mbm.mtn > a");if(d){const e=d.href.split("id=")[1],n=/(?<=<th>\s<a href="thread-)\d+(?=-)/g;let o=[];const a=async(r=1)=>{const s=[...(await t.request(`/misc.php?mod=tag&id=${e}&type=thread&page=${r}`)).responseText.matchAll(n)].map((([e])=>Number(e)));o=o.concat(s);const i=o.indexOf(unsafeWindow.tid);return s.length>0&&(-1===i||!o[i+1])?a(r+1):l({onPrev:o[i-1]?()=>window.location.assign(`thread-${o[i-1]}-1-1.html`):void 0,onNext:o[i+1]?()=>window.location.assign(`thread-${o[i+1]}-1-1.html`):void 0})};setTimeout(a)}}if(a.记录阅读进度){const e=unsafeWindow.tid??new URLSearchParams(window.location.search).get("tid")??/\/thread-(\d+)-\d+-\d+.html/.exec(window.location.pathname)?.[1];if(!e)return;let n;try{const o=await t.request(`/api/mobile/index.php?module=viewthread&tid=${e}`,{responseType:"json",errorText:"获取帖子回复数时出错",noTip:!0});n=Number.parseInt(o.response?.Variables?.thread?.allreplies,10)}catch{}const a=Number.parseInt(o.querySelector("#pgt strong")?.textContent??o.querySelector("#dumppage")?.value??"1",10),r=await o.useCache((e=>{e.createObjectStore("history",{keyPath:"tid"})})),s=await r.get("history",`${e}`);if(s&&a<s.lastPageNum)return;const i=o.querySelectorAll(s?.lastAnchor&&a===s.lastPageNum?`#${s.lastAnchor} ~ div`:"#postlist > div, .plc.cl");if(0===i.length)return;let l=0;const c=e=>{l&&window.clearTimeout(l),l=window.setTimeout((async()=>{l=0,await r.set("history",e)}),200)},d=new IntersectionObserver((t=>{const o=t.find((e=>e.isIntersecting));if(!o)return;const r=i.indexOf(o.target);if(-1!==r){for(const e of i.splice(0,r+1))d.unobserve(e);c({tid:`${e}`,lastPageNum:a,lastReplies:n||s?.lastReplies||0,lastAnchor:o.target.id})}}),{rootMargin:"-160px"});for(const e of i)d.observe(e)}}else if(/forum(-\d+){2}|mod=forumdisplay/.test(document.URL)){if(a.修正点击页数时的跳转判定){const e=o.querySelectorAll(".tps>a");let n=e.length;for(;n--;)e[n].setAttribute("onClick","atarget(this)")}if(a.记录阅读进度){const t=await o.useCache((e=>{e.createObjectStore("history",{keyPath:"tid"})})),a=!document.querySelector("#flk"),[r,s]=n.createSignal(!1),i=()=>s((e=>!e));let l="tbody[id^=normalthread]",c=e=>e.id.split("_")[1],d=(e,n)=>`thread-${n}-${e.lastPageNum}-1.html#${e.lastAnchor}`;a&&(l=".threadlist li.list",c=e=>new URLSearchParams(e.children[1].getAttribute("href")).get("tid"),d=(e,n)=>`forum.php?mod=viewthread&tid=${n}&extra=page%3D1&mobile=2&page=${e.lastPageNum}#${e.lastAnchor}`);for(const s of o.querySelectorAll(l)){const i=c(s);e.render((()=>{const[l,c]=n.createSignal();o.createEffectOn(r,(()=>t.get("history",i).then(c)));const p=n.createMemo((()=>l()?d(l(),i):"")),g=n.createMemo((()=>!a&&l()?Number(s.querySelector(".num a").innerHTML)-l().lastReplies:0));return e.createComponent(n.Show,{get when(){return Boolean(l())},get children(){return e.createComponent(n.Show,{when:a,get children(){return n=e.template("<li><a>回第<!>页")(),t=n.firstChild,(o=t.firstChild.nextSibling).nextSibling,e.addEventListener(t,"click",unsafeWindow.atarget,!0),t.style.setProperty("color","unset"),e.insert(t,(()=>l()?.lastPageNum),o),e.effect((()=>e.setAttribute(t,"href",p()))),n;var n,t,o},get fallback(){return[(t=e.template("<a class=historyTag>回第<!>页 ")(),o=t.firstChild.nextSibling,o.nextSibling,e.addEventListener(t,"click",unsafeWindow.atarget,!0),e.insert(t,(()=>l()?.lastPageNum),o),e.effect((()=>e.setAttribute(t,"href",p()))),t),e.createComponent(n.Show,{get when(){return g()>0},get children(){var n=e.template("<div class=historyTag>+")();return n.firstChild,e.insert(n,g,null),n}})];var t,o}})}})}),a?s.children[3]:s.getElementsByTagName("th")[0])}document.addEventListener("visibilitychange",i),o.querySelector("#autopbn")?.addEventListener("click",i)}}})().catch((e=>o.log.error(e))),e.delegateEvents(["click"]);break}case"www.yamibo.com":{if(!window.location.pathname.includes("/manga/view-chapter"))break;const e=new URLSearchParams(window.location.search).get("id");if(!e)break;const n=Number(helper.querySelector("section div:first-of-type div:last-of-type").innerHTML.split("：")[1]);if(Number.isNaN(n))throw new Error(helper.t("site.changed_load_failed"));const t=async n=>{const t=await main.request(`https://www.yamibo.com/manga/view-chapter?id=${e}&page=${n}`);return/(?<=<img id=['"]imgPic['"].+?src=['"]).+?(?=['"])/.exec(t.responseText)[0].replaceAll("&amp;","&").replaceAll("http://","https://")},o=e=>helper.plimit(helper.createSequence(n).map((n=>async()=>e(n,await t(n+1)))));options={name:"newYamibo",getImgList:({dynamicLoad:e})=>e(o,n)(),onNext:helper.querySelectorClick("#btnNext"),onPrev:helper.querySelectorClick("#btnPrev"),onExit:e=>e&&helper.scrollIntoView("#w1")};break}case"comic.idmzj.com":case"comic.dmzj.com":case"manhua.idmzj.com":case"manhua.dmzj.com":{const e=require("solid-js/web"),n=require("solid-js"),t=require("main"),o=require("userscript/dmzjApi"),a=require("helper");(async()=>{const r=async()=>{const[,e,n]=window.location.pathname.split(/\/|\./);e||t.toast.error("漫画数据获取失败",{duration:Number.POSITIVE_INFINITY,throw:new Error("获取漫画拼音简称失败")});return{comicId:await o.getComicId(e),chapterId:n}},s=e=>{const n=a.querySelector(e);if(n?.textContent)return()=>n.click()};await t.universal({name:"dmzj",getImgList:async()=>(await(async()=>{await a.waitDom("#qiehuan_txt"),await a.wait((()=>{const e=a.querySelector("#qiehuan_txt");if(e)return"切换到上下滚动阅读"!==e.textContent||void e.click()}))})(),await a.waitDom(".comic_wraCon img"),a.querySelectorAll(".comic_wraCon img").map((e=>e.src))),onExit:e=>e&&a.scrollIntoView("#hd"),async getCommentList(){const{comicId:e,chapterId:n}=await r();return o.getViewpoint(e,n)},SPA:{isMangaPage:()=>/^\/[^/]*?\/?$/.test(window.location.pathname)?(async()=>{if(await a.waitDom(".commentBox"),!a.querySelector(".cartoon_online_border > img"))return!1;a.querySelector(".cartoon_online_border").innerHTML="获取漫画数据中";for(const e of a.querySelectorAll(".odd_anim_title ~ *"))e.remove();const{comicId:t}=await r();return e.render((()=>{const a=o.useComicDetail(t);return e.createComponent(n.For,{get each(){return a.chapters},children:({name:o,list:r})=>{return[(l=e.template('<div class=photo_part><div class=h2_title2><span class="h2_icon h2_icon22"></span><h2> ')(),c=l.firstChild.firstChild.nextSibling,d=c.firstChild,e.insert(c,(()=>a.title),d),e.insert(c,"连载"===o?"在线漫画全集":`漫画其它版本：${o}`,null),l),(s=e.template("<div class=cartoon_online_border_other><ul></ul><div class=clearfix>")(),i=s.firstChild,s.style.setProperty("margin-top","-8px"),e.insert(i,e.createComponent(n.For,{each:r,children:({title:n,id:o,updatetime:r})=>{return s=e.template("<li><a target=_blank>")(),i=s.firstChild,e.setAttribute(i,"title",n),e.setAttribute(i,"href",`https://m.dmzj.com/view/${t}/${o}.html`),e.insert(i,n),e.effect((()=>i.classList.toggle("color_red",!(r!==a.last_updatetime)))),s;var s,i}})),s)];var s,i,l,c,d}})}),a.querySelector(".middleright_mr")),!1})():/^\/.*?\/\d+\.shtml$/.test(window.location.pathname),getOnPrev:()=>s(".display_left #prev_chapter"),getOnNext:()=>s(".display_right #next_chapter")}})})().catch((e=>a.log.error(e)));break}case"m.idmzj.com":case"m.dmzj.com":{const e=require("dmzjDecrypt"),n=require("userscript/dmzjApi"),t=require("main"),o=require("helper");(async()=>{switch(window.location.pathname.split("/")[1]){case"info":{if(Reflect.has(unsafeWindow,"obj_id"))return;const n=Number.parseInt(window.location.pathname.split("/")[2],10);if(Number.isNaN(n))return document.body.innerHTML="",document.body.insertAdjacentHTML("beforeend",'\n            请手动输入漫画名进行搜索 <br />\n            <input type="search"> <button>搜索</button> <br />\n            <div id="list" />\n          '),void o.querySelector("button").addEventListener("click",(async()=>{const e=o.querySelector("input")?.value;if(!e)return;const n=await t.request(`https://s.acg.dmzj.com/comicsum/search.php?s=${e}`,{errorText:"搜索漫画时出错"}),a=JSON.parse(n.responseText.slice(20,-1));o.querySelector("#list").innerHTML=a.map((({id:e,comic_name:n,comic_author:t,comic_url:o})=>`\n                <b>《${n}》<b/>——${t}\n                <a href="${o}">Web端</a>\n                <a href="https://m.dmzj.com/info/${e}.html">移动端</a>\n              `)).join("<br />")}));const a=await t.request(`https://v4api.idmzj.com/comic/detail/${n}?uid=2665531&disable_level=1`,{errorText:"获取漫画数据失败"}),{comicInfo:{last_updatetime:r,title:s,chapters:i}}=e(a.responseText);document.title=s,document.body.insertAdjacentHTML("beforeend",`<h1>${s}</h1>`);for(const e of Object.values(i)){let t=`<h2>${e.title}</h2>`,o=e.data.length;for(;o--;)t+=`<a target="_blank" title="${e.data[o].chapter_title}" href="https://m.dmzj.com/view/${n}/${e.data[o].chapter_id}.html" ${e.data[o].updatetime===r?'style="color:red"':""}>${e.data[o].chapter_title}</a>`;document.body.insertAdjacentHTML("beforeend",t)}document.body.childNodes[0].remove(),GM_addStyle("\n          h1 {\n            margin: 0 -20vw;\n          }\n\n          h1,\n          h2 {\n            text-align: center;\n          }\n\n          body {\n            padding: 0 20vw;\n          }\n\n          a {\n            display: inline-block;\n\n            min-width: 4em;\n            margin: 0 1em;\n\n            line-height: 2em;\n            white-space: nowrap;\n          }\n        ");break}case"view":{if(unsafeWindow.comic_id)return GM_addStyle(".subHeader{display:none !important}"),void await t.universal({name:"dmzj",getImgList:()=>o.querySelectorAll("#commicBox img").map((e=>e.dataset.original)).filter(Boolean),getCommentList:()=>n.getViewpoint(unsafeWindow.subId,unsafeWindow.chapterId),onNext:o.querySelectorClick("#loadNextChapter"),onPrev:o.querySelectorClick("#loadPrevChapter")});const e=document.createElement("p");let a,r,s;e.textContent="正在加载中，请坐和放宽，若长时间无反应请刷新页面",document.body.append(e);try{[,r,s]=/(\d+)\/(\d+)/.exec(window.location.pathname),a=await n.getChapterInfo(r,s)}catch(n){throw t.toast.error("获取漫画数据失败",{duration:Number.POSITIVE_INFINITY}),e.textContent=n.message,n}e.textContent="加载完成，即将进入阅读模式";const{folder:i,chapter_name:l,next_chap_id:c,prev_chap_id:d,comic_id:p,page_url:g}=a;document.title=`${l} ${i.split("/").at(1)}`;const{setManga:_,setComicLoad:m}=await t.useInit("dmzj");_({onExit:void 0,onNext:c?()=>{window.location.href=`https://m.dmzj.com/view/${p}/${c}.html`}:void 0,onPrev:d?()=>{window.location.href=`https://m.dmzj.com/view/${p}/${d}.html`}:void 0,editButtonList:e=>e}),m((()=>g.length>0?g:(e.innerHTML='无法获得漫画数据，请通过 <a href="https://github.com/hymbz/ComicReadScript/issues" target="_blank">Github</a> 或 <a href="https://sleazyfork.org/zh-CN/scripts/374903-comicread/feedback#post-discussion" target="_blank">Greasy Fork</a> 进行反馈',[]))),_("commentList",await n.getViewpoint(r,s));break}}})().catch((e=>o.log.error(e)));break}case"www.idmzj.com":case"www.dmzj.com":{const e=require("userscript/dmzjApi"),n=require("main"),t=require("helper"),o=e=>{if(e)return()=>{window.open(window.location.href.replace(/(?<=\/)\d+(?=\.html)/,`${e}`),"_self")}};(async()=>{await t.waitDom(".head_wz");const a=t.querySelector(".head_wz [id]")?.id,r=/(?<=\/)\d+(?=\.html)/.exec(window.location.pathname)?.[0];if(!a||!r)return;const{setManga:s,setComicLoad:i}=await n.useInit("dmzj");try{const{next_chap_id:n,prev_chap_id:t,page_url:l}=await e.getChapterInfo(a,r);i((()=>l)),s({onNext:o(n),onPrev:o(t)})}catch{n.toast.error("获取漫画数据失败",{duration:Number.POSITIVE_INFINITY})}})().catch((e=>t.log.error(e)));break}case"exhentai.org":case"e-hentai.org":{const web=require("solid-js/web"),solidJs=require("solid-js"),main=require("main"),detectAd=require("userscript/detectAd"),helper=require("helper"),store=require("solid-js/store"),Manga=require("components/Manga"),ehTagRules=require("userscript/ehTagRules"),escHandler=[],setEscHandler=(e,n)=>{escHandler.push(Object.assign(n,{order:e})),escHandler.sort(((e,n)=>n.order-e.order))};let hasStyle=!1;const addQuickFavorite=(favoriteButton,root,apiUrl,position)=>{hasStyle||(hasStyle=!0,GM_addStyle('\n      .comidread-favorites {\n        position: absolute;\n        z-index: 75;\n        left: 0;\n\n        overflow: auto;\n        align-content: center;\n\n        box-sizing: border-box;\n        width: 100%;\n        padding-left: 0.6em;\n\n        border: none;\n        border-radius: 0;\n      }\n\n      .comidread-favorites-item {\n        cursor: pointer;\n\n        display: flex;\n        align-items: center;\n\n        width: 100%;\n        margin: 1em 0;\n\n        text-align: left;\n        overflow-wrap: anywhere;\n      }\n\n      .comidread-favorites-item > input {\n        pointer-events: none;\n        margin: 0 0.5em 0 0;\n      }\n\n      .comidread-favorites-item > div {\n        flex-shrink: 0;\n\n        width: 15px;\n        height: 15px;\n        margin: 0 0.5em 0 0;\n\n        background-image: url("https://ehgt.org/g/fav.png");\n        background-repeat: no-repeat;\n      }\n\n      .gl1t > .comidread-favorites {\n        padding: 1em 1.5em;\n      }\n    ')),root.style.position="relative",root.style.height="100%";const[show,setShow]=solidJs.createSignal(!1),[favorites,setFavorites]=solidJs.createSignal([]),updateFavorite=async()=>{try{const e=await main.request(apiUrl,{errorText:helper.t("site.ehentai.fetch_favorite_failed")}),n=[...helper.domParse(e.responseText).querySelectorAll(".nosel > div")];10===n.length&&(n[0].querySelector("input").checked=!1),setFavorites(n)}catch{main.toast.error(helper.t("site.ehentai.fetch_favorite_failed")),setFavorites([])}};let hasRender=!1;const renderDom=()=>{if(hasRender)return;hasRender=!0;const FavoriteItem=(e,index)=>{const checked=e.querySelector("input").checked,handleClick=async()=>{if(checked)return;setShow(!1);const formData=new FormData;formData.append("favcat",10===index()?"favdel":`${index()}`),formData.append("apply","Apply Changes"),formData.append("favnote",""),formData.append("update","1");const res=await main.request(apiUrl,{method:"POST",data:formData,errorText:helper.t("site.ehentai.change_favorite_failed")});main.toast.success(helper.t("site.ehentai.change_favorite_success"));const updateCode=/\nif\(window.opener.document.+\n/.exec(res.responseText)?.[0]?.replaceAll("window.opener.document","window.document");updateCode&&eval(updateCode),await updateFavorite()};return _el$=web.template("<div class=comidread-favorites-item><input type=radio>")(),_el$2=_el$.firstChild,_el$.$$click=handleClick,_el$2.checked=checked,web.insert(_el$,web.createComponent(solidJs.Show,{get when(){return index()<=9},get children(){var e=web.template("<div>")();return web.effect((n=>null!=(n=`0px -${2+19*index()}px`)?e.style.setProperty("background-position",n):e.style.removeProperty("background-position"))),e}}),null),web.insert(_el$,(()=>e.textContent?.trim()),null),_el$;var _el$,_el$2};let background="rgba(0, 0, 0, 0)",dom=root;for(;"rgba(0, 0, 0, 0)"===background;)background=getComputedStyle(dom).backgroundColor,dom=dom.parentElement;web.render((()=>web.createComponent(solidJs.Show,{get when(){return show()},get children(){var e=web.template("<span class=comidread-favorites>")();return null!=background?e.style.setProperty("background",background):e.style.removeProperty("background"),web.insert(e,web.createComponent(solidJs.For,{get each(){return favorites()},children:FavoriteItem,get fallback(){return web.template("<h3>loading...")()}})),web.effect((n=>{var t=position[1]-position[0]+"px",o=`${position[0]}px`;return t!==n.e&&(null!=(n.e=t)?e.style.setProperty("height",t):e.style.removeProperty("height")),o!==n.t&&(null!=(n.t=o)?e.style.setProperty("top",o):e.style.removeProperty("top")),n}),{e:void 0,t:void 0}),e}})),root)},rawClick=favoriteButton.onclick;favoriteButton.onclick=null,favoriteButton.addEventListener("mousedown",(async e=>{if(1===e.buttons||4===e.buttons){if(e.stopPropagation(),e.preventDefault(),e.shiftKey||e.ctrlKey||e.altKey||e.metaKey||4===e.buttons)return rawClick.call(favoriteButton,e);renderDom(),setShow((e=>!e)),show()&&await updateFavorite()}}))},quickFavorite=e=>{if("gallery"!==e)switch(e){case"t":for(const e of helper.querySelectorAll(".gl1t")){const n=e.querySelector("[id^=posted_]"),t=e.firstElementChild.getBoundingClientRect().bottom-e.getBoundingClientRect().top,o=e.lastElementChild.getBoundingClientRect().top-e.getBoundingClientRect().top,a=/http.+?(?=')/.exec(n.getAttribute("onclick"))[0];addQuickFavorite(n,e,a,[t,o])}break;case"e":for(const e of helper.querySelectorAll(".gl1e")){const n=e.nextElementSibling.querySelector("[id^=posted_]"),t=Number.parseInt(getComputedStyle(e).height,10),o=/http.+?(?=')/.exec(n.getAttribute("onclick"))[0];addQuickFavorite(n,e,o,[0,t])}}else{const e=helper.querySelector("#gdf"),n=helper.querySelector("#gd3");addQuickFavorite(e,n,`${unsafeWindow.popbase}addfav`,[0,e.firstElementChild.offsetTop])}};web.delegateEvents(["click"]);const associateNhentai=async(e,n,t)=>{if(!helper.querySelector("#gdc > .cs:is(.ct2, .ct3)"))return;const o=document.getElementById("gn");if(!o||!helper.querySelector("#taglist tbody"))return void((document.getElementById("taglist")?.children.length??1)>0&&main.toast.error(helper.t("site.ehentai.html_changed_nhentai_failed")));const[a,r]=solidJs.createSignal(),s=o.textContent.replaceAll(/\s+-/g," "),i=()=>{return(e=web.template("<tr><td class=tc>nhentai:")()).firstChild,web.insert(e,web.createComponent(solidJs.Show,{get when(){return a()?.length},get fallback(){return(e=web.template("<td class=tc>")()).style.setProperty("text-align","left"),web.effect((()=>e.innerHTML=(()=>{if(void 0===a())return"searching...";if(null===a()){const e=`https://nhentai.net/search/?q=${s}`;return helper.t("site.ehentai.nhentai_failed",{nhentai:`<a href='${e}' target="_blank"> <u> nhentai </u> </a>`})}return 0===a().length?"null":void 0})())),e;var e},get children(){var e=web.template("<td>")();return web.insert(e,web.createComponent(solidJs.For,{get each(){return a()},children:({id:e,title:n})=>{return t=web.template("<div class=gtl><a>")(),o=t.firstChild,web.setAttribute(t,"id",`td_nh:${e}`),t.style.setProperty("opacity","1.0"),web.setAttribute(o,"id",`nh:${e}`),web.setAttribute(o,"href",`https://nhentai.net/g/${e}/`),web.setAttribute(o,"onclick",`return toggle_tagmenu(1, 'nh:${e}',this)`),web.insert(o,e),web.effect((()=>web.setAttribute(t,"title",n.japanese||n.english))),t;var t,o}})),e}}),null),e;var e};web.render(i,helper.querySelector("#taglist tbody")),helper.hijackFn("tag_update_vote",(()=>web.render(i,helper.querySelector("#taglist tbody"))));try{r((await main.request(`https://nhentai.net/api/galleries/search?query=${s}`,{responseType:"json",errorText:helper.t("site.ehentai.nhentai_error"),noTip:!0})).response.result)}catch{r(null)}if(!a()?.length)return;const l={j:"jpg",p:"png",g:"gif",w:"webp",b:"bmp"};for(const{id:t,images:o,num_pages:r,media_id:s}of a()){const a=`nh:${t}`;n(e((e=>{helper.plimit(o.pages.map(((n,t)=>async()=>{const o=await main.request(`https://i.nhentai.net/galleries/${s}/${t+1}.${l[n.t]}`,{headers:{Referer:`https://nhentai.net/g/${s}`},responseType:"blob"}),a=URL.createObjectURL(o.response);e(t,a)})))}),r,a),a)}const c=document.getElementById("tagmenu_act"),d=e=>web.createComponent(solidJs.For,{get each(){return e.children},children:e=>[web.template('<img src=https://ehgt.org/g/mr.gif class=mr alt=">">')(),e]});let p;helper.hijackFn("_refresh_tagmenu_act",((e,[n])=>{if(p?.(),!n.id.startsWith("nh:"))return e(n);c.children.length>0&&(c.innerHTML=""),p=web.render((()=>web.createComponent(d,{get children(){return[(e=web.template("<a target=_blank>")(),e.innerText=" Jump to nhentai",web.effect((()=>web.setAttribute(e,"href",n.href))),e),web.createComponent(t,{get id(){return n.id}})];var e}})),c)}))},hotkeysPageTurn=e=>{"gallery"===e?(setEscHandler(0,(()=>!unsafeWindow.selected_tagname||unsafeWindow.toggle_tagmenu())),helper.linstenKeydown((e=>{switch(e.key){case"ArrowRight":case"d":return e.preventDefault(),helper.querySelector(".ptt td:last-child:not(.ptdd)")?.click();case"ArrowLeft":case"a":return e.preventDefault(),helper.querySelector(".ptt td:first-child:not(.ptdd)")?.click()}if(unsafeWindow.selected_tagid)switch(e.key){case"ArrowUp":return e.preventDefault(),unsafeWindow?.tag_vote_up();case"ArrowDown":return e.preventDefault(),unsafeWindow?.tag_vote_down()}}))):helper.linstenKeydown((e=>{switch(e.key){case"ArrowRight":case"d":return e.preventDefault(),helper.querySelector("#unext")?.click();case"ArrowLeft":case"a":return e.preventDefault(),helper.querySelector("#uprev")?.click()}}))},getTagSetHtml=async e=>{const n=e?`/mytags?tagset=${e}`:"/mytags",t=await main.request(n,{fetch:!0});return helper.domParse(t.responseText)},collectTags=(e,n=[])=>{const t=e.querySelector("#tagcolor").value.slice(1)||"0",[,...o]=[...e.getElementById("usertags_outer").children];for(const e of o){const o=Number(e.id.split("usertag_")[1]),a=e.querySelector(`#tagpreview_${o}`),{color:r,borderColor:s}=a.style;let[i,l]=a.title.split(":");switch(i){case"female":case"male":case"mixed":i="gender"}const c=Number.parseInt(e.querySelector(`#tagcolor_${o}`).value.slice(1)||t,16);n.push({e:e,id:o,title:a.title,color:c,fontColor:r,borderColor:s,group:i,name:l,weight:Number(e.querySelector("input[id^=tagweight_]").value),watch:e.querySelector(`#tagwatch_${o}`).checked,hidden:e.querySelector(`#taghide_${o}`).checked,order:-1})}return n},sortTagList=e=>{const n=new Intl.Collator,t=(e,t)=>e.color!==t.color?t.color-e.color:e.group!==t.group?n.compare(e.group,t.group):e.hidden!==t.hidden?e.hidden?1:-1:e.watch!==t.watch?e.watch?-1:1:e.weight!==t.weight?t.weight-e.weight:n.compare(e.name,t.name);let o=-e.length;for(const n of e.sort(t))n.order=o++;return e},getMyTags=async()=>{const e=[],n=await getTagSetHtml();await Promise.all([...n.querySelectorAll("#tagset_outer select option")].map((async t=>{const o=t.selected?n:await getTagSetHtml(t.value);o.querySelector("#tagset_enable")?.checked&&e.push(o)})));const t=[];for(const n of e)collectTags(n,t);return sortTagList(t)},handleMyTagsChange=new Set,updateMyTags=async()=>{const e=await getMyTags();for(const n of handleMyTagsChange)await n(e)},buildTagList=(e,n)=>`\n${[...e].map((e=>`${n}${CSS.escape(e)}`)).join(",\n")}\n`,updateTagColor=async e=>{const n={},t={},o={};for(const a of e){const{color:e,borderColor:r,fontColor:s}=a,i=a.title.replaceAll(" ","_");(n[e]||=new Set).add(i),(t[r]||=new Set).add(i),(o[s]||=new Set).add(i)}let a="";for(const[e,t]of Object.entries(n))a+=`:is(${buildTagList(t,"#td_")})`,a+=`{ background: #${Number(e).toString(16).padStart(6,"0")}; }\n\n`;for(const[e,n]of Object.entries(t))a+=`:is(${buildTagList(n,"#td_")}).gt`,a+=`{ border-color: ${e}; }\n\n`;for(const[e,n]of Object.entries(o))a+=`:is(${buildTagList(n,"#td_")}):not(.gt)`,a+=`{ border-color: ${e}; }\n\n`,a+=`#taglist a:is(${buildTagList(n,"#ta_")})`,a+=`{ color: ${e} !important; position: relative; }\n\n`;return a+='\n    /* 禁用 eh 的变色效果 */\n    #taglist a[id] { color: var(--tag) !important; position: relative; }\n    #taglist a[id]:hover { color: var(--tag-hover) !important; }\n\n    #taglist a[id]::after {\n      content: "";\n      background: var(--color);\n      width: 100%;\n      position: absolute;\n      left: 0;\n      height: 2px;\n      bottom: -7px;\n    }\n    .tup { --color: var(--tup) }\n    .tdn { --color: var(--tdn) }\n    #taglist a[id][style="color: blue;"] { --color: blue; }\n\n    /* 避免被上一行的下划线碰到 */\n    #taglist div:is(.gt, .gtl, .gtw) { margin-top: 1px; }\n  ',await GM.setValue("ehTagColorizeCss",a),a},colorizeTag=async e=>{switch(handleMyTagsChange.add(updateTagColor),e){case"gallery":{let e="https://exhentai.org"===location.origin?"--tag: #DDDDDD; --tag-hover: #EEEEEE; --tup: #00E639; --tdn: #FF3333;":"--tag: #5C0D11; --tag-hover: #8F4701; --tup: green; --tdn: red;";return e=`#taglist { ${e} }\n\n`,e+=await helper.getGmValue("ehTagColorizeCss",updateMyTags),GM_addStyle(e)}case"mytags":updateMyTags(),helper.hijackFn("usertag_callback",helper.debounce(updateMyTags))}},quickRating=e=>{let n;switch(e){case"gallery":case"mytags":case"mpv":return;case"e":n=helper.querySelectorAll("#favform > table > tbody > tr");break;case"m":case"p":case"l":n=helper.querySelectorAll("#favform > table > tbody > tr").slice(1);break;case"t":n=helper.querySelectorAll(".gl1t")}GM_addStyle("\n    .comidread-quick-rating {\n      position: absolute;\n      width: 100%;\n      height: 100%;\n      pointer-events: click;\n    }\n  ");const t=["0,0,7,16","8,0,15,16","16,0,23,16","24,0,31,16","32,0,39,16","40,0,47,16","48,0,55,16","56,0,63,16","64,0,71,16","72,0,79,16"],o=(e,n)=>{let t=Math.round(n+1);const o=16*Math.ceil(t/2)-80;t=t%2==1?-21:-1,e.style.backgroundPosition=`${o}px ${t}px`},a=(e,n,a)=>{let r=n.style.backgroundPosition;web.render((()=>{return s=web.template("<span class=comidread-quick-rating><img src=https://ehgt.org/g/blank.gif><map>")(),i=s.firstChild,l=i.nextSibling,s.$$mouseout=()=>{n.style.backgroundPosition=r},web.setAttribute(s,"data-index",a),web.setAttribute(i,"usemap",`#rating-${a}`),web.setAttribute(l,"name",`rating-${a}`),web.insert(l,web.createComponent(solidJs.For,{each:t,children:(t,a)=>{return(s=web.template("<area shape=rect>")()).$$click=async()=>{const t=await(async(e,n)=>{try{const t=await main.request(e,{errorText:helper.t("site.ehentai.change_rating_failed"),noTip:!0}),o=/api_url = "(.+?)".+?gid = (\d+).+?token = "(.+?)".+?apiuid = (\d+).+?apikey = "(.+?)"/s.exec(t.responseText);if(!o)throw new Error(helper.t("site.ehentai.change_rating_failed"));const[,a,r,s,i,l]=o,c=await main.request(a,{method:"POST",responseType:"json",data:JSON.stringify({method:"rategallery",rating:`${n}`,apikey:l,apiuid:i,gid:r,token:s}),fetch:!0,noTip:!0});return main.toast.success(`${helper.t("site.ehentai.change_rating_success")}: ${c.response.rating_usr}`),c.response}catch{throw main.toast.error(helper.t("site.ehentai.change_rating_failed")),new Error(helper.t("site.ehentai.change_rating_failed"))}})(e.querySelector("a").href,a()+1);n.className=t.rating_cls,o(n,2*t.rating_usr-1),r=n.style.backgroundPosition},s.$$mouseover=()=>o(n,a()),web.setAttribute(s,"coords",t),s;var s}})),s;var s,i,l}),n)};for(const[e,t]of n.entries()){const n=[...t.querySelectorAll(".ir")].at(-1);n&&n.addEventListener("mouseenter",(()=>a(t,n,e)),{once:!0})}};web.delegateEvents(["mouseout","mouseover","click"]);const MDLaunch=(e={})=>{return n=web.template('<svg xmlns=http://www.w3.org/2000/svg viewBox="0 0 24 24"stroke=currentColor fill=currentColor stroke-width=0><path d="M18 19H6c-.55 0-1-.45-1-1V6c0-.55.45-1 1-1h5c.55 0 1-.45 1-1s-.45-1-1-1H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-6c0-.55-.45-1-1-1s-1 .45-1 1v5c0 .55-.45 1-1 1M14 4c0 .55.45 1 1 1h2.59l-9.13 9.13a.996.996 0 1 0 1.41 1.41L19 6.41V9c0 .55.45 1 1 1s1-.45 1-1V3h-6c-.55 0-1 .45-1 1">')(),web.spread(n,e,!0,!0),n;var n},quickTagDefine=e=>{if("gallery"!==e)return;const n=store.createMutable({});GM_addStyle("\n    #comidread-tag-define {\n      position: absolute;\n      z-index: 1;\n      top: 0;\n      left: 0;\n      width: 100%;\n      text-align: start;\n      padding: 0 1em;\n      box-sizing: border-box;\n    }\n\n    #taglist {\n      position: relative;\n    }\n\n    #comidread-tag-define h1 {\n      border-bottom: 1px solid #a2a9b1;\n      margin: 0.4em 0;\n    }\n\n    #comidread-tag-define h1 svg {\n      height: 0.7em;\n      margin-left: 0.2em;\n    }\n\n    #comidread-tag-define ul {\n      margin: 0.3em 0 0 1.6em;\n      padding: 0;\n    }\n\n    #comidread-tag-define li {\n      margin-bottom: 0.2em;\n    }\n\n    #comidread-tag-define div a {\n      text-decoration: underline;\n    }\n\n    #comidread-tag-define dd {\n      margin-left: 1.6em;\n    }\n\n    #comidread-tag-define dl {\n      margin-top: 0.2em;\n      margin-bottom: 0.5em;\n    }\n  ");const[t,o]=solidJs.createSignal(!1),a=helper.querySelector("#taglist");let r="rgba(0, 0, 0, 0)",s=a;for(;"rgba(0, 0, 0, 0)"===r;)r=getComputedStyle(s).backgroundColor,s=s.parentElement;web.render((()=>web.createComponent(solidJs.Show,{get when(){return t()},get children(){var e=web.template("<span id=comidread-tag-define>")();return null!=r?e.style.setProperty("background",r):e.style.removeProperty("background"),web.insert(e,(()=>n[unsafeWindow.selected_tagname]??web.template("<h3>loading...")())),web.effect((n=>null!=(n=`${a.scrollHeight}px`)?e.style.setProperty("height",n):e.style.removeProperty("height"))),e}})),a),unsafeWindow.tag_define=async()=>{if(unsafeWindow.selected_tagname){if(t())return o(!1);o(!0);try{await(async e=>{if(Reflect.has(n,e))return;const t=`https://ehwiki.org/wiki/${e.replaceAll(/[a-z]+:\s?/gi,"")}`,o=await main.request(t,{noCheckCode:!0});if(200!==o.status)return void(n[e]=(a=web.template("<h3>")(),web.insert(a,(()=>`${o.status} - ${o.statusText}`)),a));var a;const r=helper.domParse(o.responseText).querySelector("#mw-content-text");for(const e of r.querySelectorAll('img[src^="/"]'))e.setAttribute("src",`https://ehwiki.org${e.getAttribute("src")}`);for(const e of r.getElementsByTagName("a")){const n=e.getAttribute("href")??"";n.startsWith("/")&&e.setAttribute("href",`https://ehwiki.org${n}`),e.target="_blank"}for(const e of r.querySelectorAll(".thumb"))e.remove();var s,i;n[e]=[(s=web.template("<h1><a target=_blank>")(),i=s.firstChild,web.setAttribute(i,"href",t),web.insert(i,e,null),web.insert(i,web.createComponent(MDLaunch,{}),null),s),r]})(unsafeWindow.selected_tagname)}catch(e){console.error(e),o(!1)}}},setEscHandler(2,(()=>!t()||o(!1)))},MdPictureInPicture='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke="currentColor" fill="currentColor" stroke-width="0"><path d="M18 7h-6c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V8c0-.55-.45-1-1-1m3-4H3c-1.1 0-2 .9-2 2v14c0 1.1.9 1.98 2 1.98h18c1.1 0 2-.88 2-1.98V5c0-1.1-.9-2-2-2m-1 16.01H4c-.55 0-1-.45-1-1V5.98c0-.55.45-1 1-1h16c.55 0 1 .45 1 1v12.03c0 .55-.45 1-1 1"/></svg>',getDomPosition=e=>{const n=e.getBoundingClientRect(),t=getComputedStyle(e),o=Number.parseFloat(t.borderLeftWidth),a=Number.parseFloat(t.paddingLeft),r=Number.parseFloat(t.paddingTop),s=Number.parseFloat(t.borderTopWidth);return{left:n.left+o+a,top:n.top+s+r,width:t.width,height:t.height}},floatTagList=(e,n)=>{if("gallery"!==e)return;const t=helper.querySelector("#gd4"),o=getComputedStyle(t);let a="rgba(0, 0, 0, 0)",r=t;for(;"rgba(0, 0, 0, 0)"===a;)a=getComputedStyle(r).backgroundColor,r=r.parentElement;const{borderColor:s}=getComputedStyle(helper.querySelector("#gdt"));GM_addStyle(`\n      #comicread-tag-box {\n        position: fixed;\n        z-index: 2147483647;\n\n        font-size: 12px;\n        text-align: justify;\n\n        background: ${a};\n        box-shadow: 0 0 15px -3px #0004;\n      }\n\n      #comicread-tag-box > #gd4 {\n        margin: 0;\n        padding: 0;\n        border: none;\n      }\n\n      #comicread-tag-box > #ehs-introduce-box {\n        position: relative;\n        width: 161px;\n        height: 100%;\n        border-left: ${`1px solid ${s}`};\n      }\n\n      /* 确保始终显示在最上层，防止和其他脚本冲突 */\n      #ehs-introduce-box { z-index: 1; }\n\n      #comicread-tag-box-placeholder {\n        cursor: pointer;\n\n        float: left;\n        display: flex;\n        grid-area: gd4;\n        justify-content: center;\n\n        margin: 0 0 0 10px;\n        padding: 0 0 0 5px;\n\n        border-right: 1px solid ${s};\n        border-left: 1px solid ${s};\n      }\n\n      #comicread-tag-box-placeholder svg {\n        width: 17em;\n        opacity: 0.5;\n      }\n\n      /* 防止在窗口变小时确认按钮被挤出范围 */\n      #tagmenu_new {\n        width: fit-content;\n      }\n    `);const{store:i,setState:l,_setState:c,_state:d}=helper.useStore({open:!1,top:0,left:0,opacity:1,mouse:{x:0,y:0},bound:{width:0,height:0}}),p=(e,n,t)=>{e.top=helper.clamp(0,n,e.bound.height),e.left=helper.clamp(0,t,e.bound.width)},g=e=>{c("opacity",helper.clamp(.5,e,1))};g(Number(localStorage.getItem("floatTagListOpacity"))||1),document.addEventListener("pointermove",(e=>{l((n=>{n.mouse.x=e.clientX,n.mouse.y=e.clientY}))}));const _=()=>{l((e=>{e.bound.width=window.innerWidth-t.clientWidth,e.bound.height=window.innerHeight-t.clientHeight,e.top=helper.clamp(0,e.top,e.bound.height),e.left=helper.clamp(0,e.left,e.bound.width)}))};window.addEventListener("resize",_),_(),helper.useStyleMemo("#comicread-tag-box",{display:()=>i.open?void 0:"none",top:()=>`${i.top}px`,left:()=>`${i.left}px`,opacity:()=>i.opacity});const m=t.cloneNode();m.id="comicread-tag-box-placeholder",m.style.display="none",m.addEventListener("click",(()=>c("open",!1))),m.innerHTML=MdPictureInPicture,t.before(m);const h=document.createElement("div");h.id="comicread-tag-box",h.classList.add("comicread-ignore"),document.body.append(h),h.addEventListener("wheel",(e=>{e.shiftKey&&(e.stopPropagation(),e.preventDefault(),g(i.opacity+(e.deltaY>0?-.05:.05)),localStorage.setItem("floatTagListOpacity",`${i.opacity}`))}),{passive:!1});const u={top:0,left:0};let f,b;helper.useDrag({ref:t,handleDrag({type:e,xy:[o,a],initial:[r,s]}){switch(e){case"down":if(!i.open){const e=getDomPosition(t);l((n=>{n.top=e.top,n.left=e.left}))}u.top=i.top,u.left=i.left;break;case"up":l((e=>{if(n.show)return;const t=m.getBoundingClientRect();helper.approx(e.top,t.top,50)&&helper.approx(e.left,t.left,50)&&(e.open=!1)}));break;case"move":l((e=>{p(e,u.top+a-s,u.left+o-r),e.open=!0}))}},handleClick:(e,n)=>n.click(),skip:e=>!e.target.matches("#gd4, #taglist, #gwrd, td+td, [id^=comidread] *:not(a)")});helper.createEffectOn((()=>i.open),(e=>{if((()=>{if(f)return;if(f=helper.querySelector("#ehs-introduce-box"),!f)return;b=f.parentElement;const e=helper.querySelector(".eh-syringe-lite-auto-complete-list");e&&(e.classList.add("comicread-ignore"),e.style.zIndex="2147483647",document.body.append(e)),helper.hijackFn("toggle_tagmenu",(()=>unsafeWindow.selected_tagname||helper.querySelector("#ehs-introduce-box .ehs-close")?.click()))})(),e){const{height:e,width:n}=o;m.style.cssText=`height: ${e}; width: ${n};`,h.style.height=e,t.style.width=n,h.append(t),f&&h.append(f),document.activeElement.blur()}else m.style.cssText="display: none;",t.style.width="",m.after(t),f&&b.append(f),Manga.focus()}),{defer:!0}),Manga.setDefaultHotkeys((e=>({...e,float_tag_list:["q"]}))),setEscHandler(0,(()=>!i.open||c("open",!1))),helper.linstenKeydown((e=>{const n=helper.getKeyboardCode(e);"float_tag_list"===Manga.hotkeysMap()[n]&&(e.stopPropagation(),e.preventDefault(),l((e=>{e.open=!e.open,e.open&&p(e,e.mouse.y-t.clientHeight/2,e.mouse.x-t.clientWidth/2)})))})),helper.hijackFn("tag_from_field",((e,n)=>(i.open&&document.activeElement.blur(),e(...n))));const w=helper.querySelector("#newtagfield");w.addEventListener("pointerenter",(()=>i.open&&w.focus()));const y=e=>{const n=(e=>{const n=helper.querySelector(`a[href=${CSS.escape(e)}]`);if(n)return n.title||n.id.slice(3).replaceAll("_"," ")})(e.dataTransfer.getData("text"));n&&(e.preventDefault(),w.value.includes(n)||(w.value+=`${n}, `))};w.addEventListener("drop",y);const v=helper.querySelector("#taglist");v.addEventListener("dragover",(e=>e.preventDefault())),v.addEventListener("dragenter",(e=>e.preventDefault())),v.addEventListener("drop",y)},updateSortCss=e=>{let n="tr a :is(.gltm, .glink + div:not([class])) { display: flex; }";for(const{title:t,order:o}of e)n+=`\n.gt[title="${t}"] { order: ${o}; }`;return GM.setValue("ehTagSortCss",n)},sortTags=async e=>{switch(handleMyTagsChange.add(updateSortCss),e){case"p":case"l":case"t":return GM_addStyle(await helper.getGmValue("ehTagSortCss",updateMyTags));case"mytags":{let e;const n=n=>{let t=`\n          #usertags_outer { display: flex; flex-direction: column; }\n          #usertags_outer > div { margin: unset; }\n          #usertag_0 { order: -${n.length}; }`;for(const{order:e,id:o}of n)t+=`\n#usertag_${o} { view-transition-name: _${o}; order: ${e}; }`;e||=GM_addElement("style",{textContent:t}),e.textContent=t};handleMyTagsChange.add((e=>{if(!document.startViewTransition)return n(e);document.startViewTransition((()=>n(e)))}))}}},tagLint=e=>{if("gallery"!==e)return;const n=helper.querySelector("#gdc > .cs:is(.ct2, .ct3, .ct9)"),t=ehTagRules.getTagLintRules(),[o,a]=solidJs.createSignal({});GM_addStyle("\n    #comidread-tag-lint [id^=td_] {\n      display: inline-block;\n      float: none;\n    }\n  ");const r=e=>{return n=web.template("<div><a>")(),(t=n.firstChild).$$click=e=>e.preventDefault(),web.insert(t,(()=>e.name)),web.effect((o=>{var a,r,s=`td_${e.name}`,i=(a=e.name,void 0===(r=e.weak)?document.getElementById(`td_${a}`)?.className:r?"gtl":"gt"),l=`ta_${e.name}`,c=`https://exhentai.org/tag/${e.name.replaceAll("_","+")}`;return s!==o.e&&web.setAttribute(n,"id",o.e=s),i!==o.t&&web.className(n,o.t=i),l!==o.a&&web.setAttribute(t,"id",o.a=l),c!==o.o&&web.setAttribute(t,"href",o.o=c),o}),{e:void 0,t:void 0,a:void 0,o:void 0}),n;var n,t},s=e=>{const n=ehTagRules.splitTagNamespace(e.name);return web.createComponent(solidJs.Show,{get when(){return n.length>1},get fallback(){return r(e)},get children(){var t=web.template("<span>「<!> 」")(),o=t.firstChild.nextSibling;return o.nextSibling,web.insert(t,web.createComponent(solidJs.For,{each:n,children:(n,t)=>[web.memo((()=>web.memo((()=>!!t()))()?` ${helper.t("other.or")} `:"")),web.createComponent(r,{name:n,get weak(){return e.weak}})]}),o),t}})},i=e=>{const[n,t,o]=e.text.split("[tag]");return web.createComponent(solidJs.Show,{get when(){return e.warnList?.size},get children(){return web.createComponent(solidJs.For,{get each(){return[...e.warnList.entries()]},children:([a,r])=>{return i=web.template("<li>")(),web.insert(i,n,null),web.insert(i,web.createComponent(s,{name:a}),null),web.insert(i,t,null),web.insert(i,web.createComponent(solidJs.For,{each:r,children:n=>web.createComponent(s,{name:n,get weak(){return e.weak}})}),null),web.insert(i,o,null),i;var i}})}})};let l,c;const d=helper.singleThreaded((()=>{const e={},[r,d]=(()=>{const e=new Set,n=new Set;for(const t of helper.querySelectorAll("#taglist [id^=td_]")){const[o]=t.getElementsByTagName("a");o.classList.contains("tdn")||(o.classList.contains("tup")||t.classList.contains("gt")?e.add(t.id.slice(3)):t.classList.contains("gtl")&&n.add(t.id.slice(3)))}return[e,n]})(),p=new Set([...r,...d]),g=(n,o,a=!1)=>{const s=t[o];if(s.has(n))for(const t of s.get(n)){if(ehTagRules.hasTag(a?r:p,t)===a)continue;e[o]||=new Map([[n,[]]]);const s=e[o];s.has(n)||s.set(n,[]),s.get(n).push(t)}};for(const e of p)g(e,"prerequisite",!0),g(e,"conflict"),n&&g(e,"possibleConflict"),g(e,"combo",!0);const _=(n,t)=>{e.other||=[],e.other.push([n,t])};helper.querySelector("#gdc > .cs.ct2")&&ehTagRules.isMissingNamespace(p,"parody")&&_(helper.t("eh_tag_lint.miss_parody"),["parody:original"]),n&&ehTagRules.isMissingTags(p,"female:females_only","female:futanari","female:shemale")&&ehTagRules.isMissingNamespace(p,"male","mixed")&&_(helper.t("eh_tag_lint.miss_female"),["female:females_only"]),a(e),l?.isConnected||(l=document.createElement("div"),l.id="comidread-tag-lint",helper.querySelector("#taglist").append(l)),c?.(),c=web.render((()=>web.createComponent(solidJs.Show,{get when(){return Object.keys(o()).length},get children(){return[web.template("<hr>")(),(e=web.template("<ul>")(),web.insert(e,web.createComponent(solidJs.For,{get each(){return o().other},children:([e,n])=>{return t=web.template("<li>")(),web.insert(t,e,null),web.insert(t,web.createComponent(solidJs.For,{each:n,children:e=>web.createComponent(s,{name:e,weak:!0})}),null),t;var t}}),null),web.insert(e,web.createComponent(i,{get warnList(){return o().prerequisite},get text(){return helper.t("eh_tag_lint.prerequisite")},weak:!1}),null),web.insert(e,web.createComponent(i,{get warnList(){return o().conflict},get text(){return helper.t("eh_tag_lint.conflict")}}),null),web.insert(e,web.createComponent(i,{get warnList(){return o().possibleConflict},get text(){return helper.t("eh_tag_lint.possible_conflict")}}),null),web.insert(e,web.createComponent(i,{get warnList(){return o().combo},get text(){return helper.t("eh_tag_lint.combo")},weak:!0}),null),e)];var e}})),l)}));d(),helper.hijackFn("tag_update_vote",d)};web.delegateEvents(["click"]),(async()=>{let e;if(e=Reflect.has(unsafeWindow,"display_comment_field")?"gallery":"/mytags"===location.pathname?"mytags":Reflect.has(unsafeWindow,"mpvkey")?"mpv":helper.querySelector('option[value="t"]')?.parentElement?.value,!e)return;const{options:n,setComicLoad:t,dynamicLoad:o,showComic:a,comicMap:r,setComicMap:s,setImgList:i,setFab:l,setManga:c,mangaProps:d}=await main.useInit("ehentai",{associate_nhentai:!0,hotkeys:!0,detect_ad:!0,quick_favorite:!0,colorize_tag:!1,quick_rating:!0,quick_tag_define:!0,float_tag_list:!1,auto_adjust_option:!1,tag_lint:!1,autoShow:!1});if("mpv"===e)return t((()=>{const e=helper.querySelectorAll(".mimg[id]");return o((async e=>{const n=unsafeWindow.imagelist;helper.plimit(n.map(((t,o)=>async()=>{const t=()=>n[o].i;for(;!t();)Reflect.has(n[o],"xhr")||(unsafeWindow.load_image(o+1),unsafeWindow.next_possible_request=0),await helper.wait(t);e(o,t())})),void 0,4)}),e.length)()}));if(helper.linstenKeydown((e=>{if("Escape"===e.key)for(const n of escHandler)if(!0!==n())return e.stopImmediatePropagation()})),n.colorize_tag&&(colorizeTag(e),sortTags(e)),n.float_tag_list&&helper.requestIdleCallback((()=>floatTagList(e,d))),-1!==unsafeWindow.apiuid&&n.quick_favorite&&helper.requestIdleCallback((()=>quickFavorite(e))),n.quick_rating&&helper.requestIdleCallback((()=>quickRating(e)),1e3),n.quick_tag_define&&helper.requestIdleCallback((()=>quickTagDefine(e)),1e3),n.tag_lint&&helper.requestIdleCallback((()=>tagLint(e)),1e3),n.auto_adjust_option&&!helper.querySelector("#gdc > .cs:is(.ct2, .ct3, .ct9)")){let e={pageNum:1,imgRecognition:{enabled:!1}};n.option&&(e=helper.assign(n.option,e)),c({option:e})}if("gallery"!==e)return;const p=document.getElementById("gd5"),g=e=>{const n=solidJs.createMemo((()=>{const n=r[e.id]?.imgList,t=n?.filter(Boolean).length;switch(n?.length){case void 0:return" Load comic";case t:return" Read";default:return` loading - ${t}/${n.length}`}}));return(t=web.template("<a href=javascript:;>")()).$$click=async n=>{await(e.onClick?.(n)),a(e.id)},web.insert(t,n),t;var t};n.associate_nhentai&&helper.requestIdleCallback((()=>associateNhentai(o,t,g)),1e3);let _=0;_=Number(helper.querySelector(".gtb .gpc")?.textContent?.replaceAll(",","").match(/\d+/g)?.at(-1)),Number.isNaN(_)&&(_=Number(/(?<=<td class="gdt2">)\d+(?= pages<\/td>)/.exec((await main.request(window.location.href)).responseText)?.[0])),Number.isNaN(_)&&main.toast.error(helper.t("site.changed_load_failed"));const m=[],h=[],u=[],f=n.detect_ad&&document.getElementById("ta_other:extraneous_ads");if(f){s("",{adList:new main.ReactiveSet});const e=[];for(const n of helper.querySelectorAll("#gdt a")){const t=Number(/.+-(\d+)/.exec(n.href)?.[1])-1;if(Number.isNaN(t))return;h[t]=n.href;const o=n.querySelector("[title]");u[t]=o.title.split(/：|: /)[1],e[t]="IMG"===o.tagName?o:/url\("(.+)"\)/.exec(o.style.backgroundImage)[1]}await detectAd.getAdPageByFileName(u,r[""].adList),0===r[""].adList.size&&await detectAd.getAdPageByContent(e,r[""].adList),helper.useStyle(helper.createRootMemo((()=>r[""]?.adList?.size?[...r[""].adList].map((e=>`a[href="${h[e]}"] [title]:not(:hover) {\n              filter: blur(8px);\n              clip-path: border-box;\n              backdrop-filter: blur(8px);\n            }`)).join("\n"):"")))}const b=async e=>{const n=await main.request(e,{fetch:!0,errorText:helper.t("site.ehentai.fetch_img_page_source_failed")},10);try{return/id="img" src="(.+?)"/.exec(n.responseText)[1]}catch{throw new Error(helper.t("site.ehentai.fetch_img_url_failed"))}},[w,y]=solidJs.createSignal(`1-${_}`),v=helper.createRootMemo((()=>helper.extractRange(w(),m.length))),$=Number(helper.querySelector(".ptt td:nth-last-child(2)").textContent);t(o((async e=>{if(h.length!==$){const e=await helper.plimit(helper.createSequence($).map((e=>()=>(async(e=0)=>{const n=await main.request(`${window.location.pathname}${e?`?p=${e}`:""}`,{fetch:!0,errorText:helper.t("site.ehentai.fetch_img_page_url_failed")}),t=[...n.responseText.matchAll(/<a href="(.{20,50})"><(img alt=.+?|div><div |div )title=".+?: (.+?)"/gm)].map((([,e,n])=>[e,n]));if(0===t.length){if(n.responseText.includes("Your IP address has been temporarily banned for excessive"))throw new Error(helper.t("site.ehentai.ip_banned"));throw new Error(helper.t("site.ehentai.fetch_img_page_url_failed"))}return t})(e))));h.length=0,u.length=0;for(const n of e)for(const[e,t]of n)h.push(e),u.push(t)}await helper.plimit([...v()].map(((n,t)=>async()=>{n<0||(m[n]||=await b(h[n]),e(t,m[n]))}))),f&&(await detectAd.getAdPageByFileName(u,r[""].adList),await detectAd.getAdPageByContent(m,r[""].adList))}),(()=>v().size))),web.render((()=>{const e=p.children[6]?.classList.contains("gsp"),n=e=>{e.shiftKey&&(y(prompt(helper.t("other.page_range"))??`1-${_}`),s("","imgList",void 0))};return(t=web.template('<p class="g2 gsp"><img src=https://ehgt.org/g/mr.gif>')()).firstChild,t.$$click=n,t.style.setProperty("padding-bottom","0"),null!=(e?0:void 0)?t.style.setProperty("padding-top",e?0:void 0):t.style.removeProperty("padding-top"),web.insert(t,web.createComponent(g,{id:""}),null),t;var t}),p),n.hotkeys&&hotkeysPageTurn(e);const x=helper.singleThreaded((async(e,n)=>{const t=await(async e=>{const n=await main.request(e,{errorText:helper.t("site.ehentai.fetch_img_page_source_failed")}),t=/nl\('(.+?)'\)/.exec(n.responseText)?.[1];if(!t)throw new Error(helper.t("site.ehentai.fetch_img_url_failed"));const o=new URL(e);return o.searchParams.set("nl",t),o.href})(h[n]);let o="";for(;!o||!await helper.testImgUrl(o);)o=await b(t),helper.log(`重新获取第 ${n} 页图片的地址\n${m[n]} ->\n${o}`),main.toast(`重新获取第 ${n} 页图片的地址`);m[n]=o,h[n]=t,i("",n,o)}));c({onExit(e){e&&helper.scrollIntoView("#cdiv"),c("show",!1)},onLoading(e,n){if(!n||"error"!==n.loadType)return;const t=m.indexOf(n.src);return-1!==t?x(t):void 0},title:helper.querySelector("#gj")?.textContent||helper.querySelector("#gn")?.textContent}),l("initialShow",n.autoShow)})().catch((e=>helper.log.error(e))),web.delegateEvents(["click"]);break}case"nhentai.net":{const e=require("solid-js/web"),n=require("main"),t=require("userscript/detectAd"),o=require("helper"),a={j:"jpg",p:"png",g:"gif",w:"webp",b:"bmp"};(async()=>{const{options:r,setFab:s,setManga:i,setComicLoad:l,showComic:c,comicMap:d,setComicMap:p}=await n.useInit("nhentai",{auto_page_turn:!0,block_totally:!0,open_link_new_page:!0,detect_ad:!0});if(Reflect.has(unsafeWindow,"gallery")){i({onExit(e){e&&o.scrollIntoView("#comment-container"),i("show",!1)}});const _=unsafeWindow._n_app.options.media_server;l((()=>_gallery.images.pages.map(((e,n)=>`https://i${_}.nhentai.net/galleries/${_gallery.media_id}/${n+1}.${a[e.t]}`)))),s("initialShow",r.autoShow);const m=((g=e.template('<a href=javascript:; id=comicReadMode class="btn btn-secondary"><i class="fa fa-book"></i> Read')()).$$click=()=>c(),g);document.getElementById("download").after(m);r.detect_ad&&o.querySelector("#tags .tag.tag-144644")&&(p("","adList",new n.ReactiveSet),await t.getAdPageByContent(o.querySelectorAll(".thumb-container img").map((e=>e.dataset.src)),d[""].adList),o.createEffectOn((()=>d[""].imgList),(e=>e?.length&&t.getAdPageByContent(e,d[""].adList))),o.useStyle((()=>{if(!d[""]?.adList?.size)return"";return[...d[""].adList].map((e=>`\n            .thumb-container:nth-of-type(${e+1}):not(:hover) {\n              filter: blur(8px);\n              clip-path: border-box;\n            }`)).join("\n")})))}else{var g;if(document.getElementsByClassName("gallery").length>0){if(r.open_link_new_page)for(const e of o.querySelectorAll('a:not([href^="javascript:"])'))e.setAttribute("target","_blank");const e=(unsafeWindow?._n_app??unsafeWindow?.n)?.options?.blacklisted_tags;if(void 0===e&&n.toast.error(o.t("site.nhentai.tag_blacklist_fetch_failed")),r.block_totally&&e?.length&&GM_addStyle(".blacklisted.gallery { display: none; }"),r.auto_page_turn){let t=o.querySelector("a.next")?.href;if(!t)return;GM_addStyle("\n        hr { bottom: 1px; box-sizing: border-box; margin: -1em auto 2em; }\n        hr:last-child { position: relative; animation: load .8s linear alternate infinite; }\n        hr:not(:last-child) { display: none; }\n        @keyframes load { 0% { width: 100%; } 100% { width: 0; } }\n      ");const a=new Set(e),r=document.getElementById("content"),s=o.singleThreaded((async()=>{if(!t)return;const e=await n.request(t,{fetch:!0,errorText:o.t("site.nhentai.fetch_next_page_failed")}),s=o.domParse(e.responseText);history.replaceState(null,"",t);const l=s.querySelector(".index-container");for(const e of l.querySelectorAll(".gallery")){for(const n of e.getElementsByTagName("img"))n.setAttribute("src",n.dataset.src);e.dataset.tags.split(" ").map(Number).some((e=>a.has(e)))&&e.classList.add("blacklisted")}const c=s.querySelector(".pagination");t=c.querySelector("a.next")?.href,r.append(l,c);const d=document.createElement("hr");r.append(d),i.disconnect(),i.observe(d),t||(d.style.animationPlayState="paused")}),!1);s();const i=new IntersectionObserver((e=>e[0].isIntersecting&&s()));i.observe(r.lastElementChild),o.querySelector("section.pagination")&&r.append(document.createElement("hr"))}}}})().catch((e=>o.log.error(e))),e.delegateEvents(["click"]);break}case"yuri.website":{const e=require("main"),n=require("helper");(async()=>{const{options:t,setManga:o,setComicLoad:a,showComic:r,comicMap:s,needAutoShow:i}=await e.useInit("yurifans",{"自动签到":!0});if(t.自动签到&&(async()=>{if(!globalThis.b2token)return;const n=(new Date).toLocaleDateString("zh-CN");if(n!==localStorage.getItem("signDate"))try{const t=await e.request("/wp-json/b2/v1/userMission",{method:"POST",noTip:!0,headers:{Authorization:`Bearer ${b2token}`}}),o=JSON.parse(t.responseText);if(!o?.mission?.date&&Number.isNaN(Number(o)))throw new Error("签到失败");e.toast("自动签到成功"),localStorage.setItem("signDate",n)}catch{e.toast.error("自动签到失败")}})(),n.querySelector('a.post-list-cat-item[title="在线区-漫画"]'))if(n.querySelector(".content-hidden")){const e=n.querySelector(".content-hidden").getElementsByTagName("img");await n.wait((()=>e.length),1e3)&&a((()=>[...e].map((e=>e.src))))}else if(n.querySelector(".xControl")){i.val=!1;const e=async n=>{r(n),o({onPrev:Reflect.has(s,n-1)?()=>e(n-1):void 0,onNext:Reflect.has(s,n+1)?()=>e(n+1):void 0})};for(const[t,o]of n.querySelectorAll(".xControl > a").entries()){const n=o.parentElement.nextElementSibling;a((()=>[...n.getElementsByTagName("img")].map((e=>e.dataset.src??""))),t),o.addEventListener("click",(()=>""!==n.getAttribute("style")&&e(t)))}}else await n.wait((()=>n.querySelectorAll(".entry-content img").length)),a((()=>n.querySelectorAll(".entry-content img").map((e=>e.dataset.src||e.src))))})();break}case"mangacopy.com":case"copymanga.site":case"copymanga.info":case"copymanga.net":case"copymanga.org":case"copymanga.tv":case"copymanga.com":case"www.mangacopy.com":case"www.copymanga.site":case"www.copymanga.info":case"www.copymanga.net":case"www.copymanga.org":case"www.copymanga.tv":case"www.copymanga.com":{const e=require("solid-js/web"),n=require("solid-js"),t=require("main"),o=require("helper"),a={webp:"1",region:"1","User-Agent":"COPY/2.0.7|",version:"2.0.7",source:"copyApp",referer:"com.copymanga.app-2.0.7"},r=e=>{let n;const r=new CSSStyleSheet;document.adoptedStyleSheets.push(r);const s=async()=>{n||(async()=>{n=document.createElement("a");const e=await o.wait((()=>o.querySelector(".table-default-right")));n.target="_blank",e.insertBefore(n,e.firstElementChild);const t=document.createElement("span");t.textContent="最後閱讀：",e.insertBefore(t,e.firstElementChild)})(),n.textContent="獲取中",n.removeAttribute("href");const s=await t.request(`/api/v3/comic2/${e}/query?platform=3`,{responseType:"json",fetch:!1,headers:a}),i=s.response?.results?.browse;if(!i)return void(n.textContent=null===i?"無":"未返回數據");const l=i.chapter_id;l?(await r.replace(`ul a[href*="${l}"] {\n        color: #fff !important;\n        background: #1790E6;\n      }`),n.href=`${window.location.pathname}/chapter/${l}`,n.textContent=i.chapter_name):n.textContent="接口異常"};setTimeout(s),document.addEventListener("visibilitychange",s)},s=async(r,s)=>{const{response:{results:i}}=await t.request(`/comicdetail/${r}/chapters`,{responseType:"json",errorText:"加載漫畫目錄失敗",headers:a,fetch:!1}),l=await(async(e,n,t)=>{const o=await crypto.subtle.decrypt({name:"AES-CBC",iv:(new TextEncoder).encode(t)},await crypto.subtle.importKey("raw",(new TextEncoder).encode(n),{name:"AES-CBC"},!1,["decrypt"]),new Uint8Array(e.match(/.{1,2}/g).map((e=>Number.parseInt(e,16)))).buffer);return JSON.parse((new TextDecoder).decode(o))})(i.slice(16),unsafeWindow.dio||"xxxmanga.woo.key",i.slice(0,16));o.log(l);const{build:{type:c},groups:d}=l,p=t=>{const a=Object.fromEntries(c.map((({id:e})=>[e,[]])));for(const e of t.chapters)a[e.type].push(e);if(s){for(const e of o.querySelectorAll(".van-divider"))e.remove();return i=e.template('<div class="detailsTextContentTabs van-tabs van-tabs--line">')(),e.insert(i,e.createComponent(n.For,{each:c,children:({id:o,name:s})=>e.createComponent(n.Show,{get when(){return a[o].length},get children(){return[(c=e.template('<div class=van-tabs__wrap><div role=tablist class="van-tabs__nav van-tabs__nav--line"><div role=tab class="van-tab van-tab--active"><span class="van-tab__text van-tab__text--ellipsis"><span></span></span></div><div class=van-tabs__line>')(),d=c.firstChild,p=d.firstChild,g=p.firstChild.firstChild,_=p.nextSibling,d.style.setProperty("background","transparent"),e.insert(g,s),_.style.setProperty("width","0.24rem"),_.style.setProperty("transform","translateX(187.5px) translateX(-50%)"),_.style.setProperty("transition-duration","0.3s"),c),(i=e.template('<div class=van-tab__pane><div class="chapterList van-grid">')(),l=i.firstChild,l.style.setProperty("padding-left","0.24rem"),e.insert(l,e.createComponent(n.For,{get each(){return a[o]},children:n=>{return o=e.template('<div class="chapterItem oneLines van-grid-item"><a class="van-grid-item__content van-grid-item__content--center"><span class=van-grid-item__text>')(),a=o.firstChild,s=a.firstChild,o.style.setProperty("flex-basis","25%"),o.style.setProperty("padding-right","0.24rem"),o.style.setProperty("margin-top","0.24rem"),e.insert(s,(()=>n.name)),e.effect((s=>{var i=!(t.last_chapter.uuid!==n.id),l=`/comic/${r}/chapter/${n.id}`;return i!==s.e&&o.classList.toggle("red",s.e=i),l!==s.t&&e.setAttribute(a,"href",s.t=l),s}),{e:void 0,t:void 0}),o;var o,a,s}})),i)];var i,l,c,d,p,g,_}})})),i}var i,l,d,p,g,_,m,h;return[(h=e.template("<span>")(),e.insert(h,(()=>t.name)),h),(l=e.template('<div class=table-default><div class=table-default-title><ul class="nav nav-tabs"role=tablist></ul><div class=table-default-right><span>更新內容：</span><a target=_blank></a><span>更新時間：</span><span></span></div></div><div class=table-default-box><div class=tab-content>')(),d=l.firstChild,p=d.firstChild,g=p.nextSibling.firstChild.nextSibling,_=g.nextSibling.nextSibling,m=d.nextSibling.firstChild,e.insert(p,e.createComponent(n.For,{each:c,children:({id:n,name:o})=>{return r=e.template("<li class=nav-item><a class=nav-link data-toggle=tab role=tab aria-selected=false>")(),s=r.firstChild,e.insert(s,o),e.effect((r=>{var i=!(0!==a[n].length),l=`#${t.path_word}${o}`;return i!==r.e&&s.classList.toggle("disabled",r.e=i),l!==r.t&&e.setAttribute(s,"href",r.t=l),r}),{e:void 0,t:void 0}),r;var r,s}})),e.insert(g,(()=>t.last_chapter.name)),e.insert(_,(()=>t.last_chapter.datetime_created)),e.insert(m,e.createComponent(n.For,{each:c,children:({id:o,name:s})=>{return i=e.template('<div role=tabpanel class="tab-pane fade"><ul>')(),l=i.firstChild,e.insert(l,e.createComponent(n.For,{get each(){return a[o]},children:n=>{return t=e.template("<a target=_blank><li>")(),o=t.firstChild,t.style.setProperty("display","block"),e.insert(o,(()=>n.name)),e.effect((o=>{var a=`/comic/${r}/chapter/${n.id}`,s=n.name;return a!==o.e&&e.setAttribute(t,"href",o.e=a),s!==o.t&&e.setAttribute(t,"title",o.t=s),o}),{e:void 0,t:void 0}),t;var t,o}})),e.effect((()=>e.setAttribute(i,"id",`${t.path_word}${s}`))),i;var i,l}})),e.effect((()=>e.setAttribute(g,"href",`/comic/${r}/chapter/${t.last_chapter.comic_id}`))),l)]};e.render((()=>e.createComponent(n.For,{get each(){return Object.values(d)},children:p})),s?o.querySelector(".detailsTextContent"):o.querySelector(".upLoop"));for(const e of o.querySelectorAll(".upLoop .table-default-title"))e.querySelector(".nav-link:not(.disabled)")?.click()};(async()=>{const e=document.cookie.split("; ").find((e=>e.startsWith("token=")))?.replace("token=","");e&&Reflect.set(a,"Authorization",`Token ${e}`);let n="",i="";if(window.location.href.includes("/chapter/")?[,,n,,i]=window.location.pathname.split("/"):window.location.href.includes("/comicContent/")&&([,,,n,i]=window.location.pathname.split("/")),n&&i){const{setComicLoad:e,setManga:r}=await t.useInit("copymanga"),s=o.querySelector("main .img+.title");s&&(s.textContent="ComicRead 提示您：你訪問的內容暫不存在，請點選右下角按鈕嘗試加載漫畫"),e((async()=>{s&&(s.textContent="漫畫加載中，請坐和放寬");const e=await t.request(`/api/v3/comic/${n}/chapter2/${i}?platform=3`,{responseType:"json",headers:a});if(s){s.textContent="漫畫加載成功🥳";const{chapter:{next:t,prev:o,name:a},comic:{name:i}}=e.response.results;document.title=`${i} - ${a} - 拷貝漫畫 拷贝漫画`,r({onNext:t?()=>window.location.assign(`/comic/${n}/chapter/${t}`):void 0,onPrev:o?()=>window.location.assign(`/comic/${n}/chapter/${o}`):void 0})}const o=[],{words:l,contents:c}=e.response.results.chapter;for(let e=0;e<c.length;e++)o[l[e]]=c[e].url.replace(/(?<=.*(\/|\.))c800x/,"c1500x");return o})),r({onNext:o.querySelectorClick(".comicContent-next a:not(.prev-null)"),onPrev:o.querySelectorClick(".comicContent-prev:not(.index,.list) a:not(.prev-null)")});const l=async()=>{const e=window.location.pathname.split("/").at(-1);return(await t.request(`/api/v3/roasts?chapter_id=${e}&limit=100&offset=0&_update=true`,{responseType:"json",errorText:"获取漫画评论失败"})).response.results.list.map((({comment:e})=>e))};r({commentList:await l()})}else if(!i&&window.location.href.includes("/comic/")){if(n=window.location.href.split("/comic/")[1],!n)return;let t=!1;const a=window.location.href.includes("/h5/");if(a?(await o.wait((()=>"none"===o.querySelector(".van-toast__text")?.parentElement?.style.display)),await o.wait((()=>o.querySelector(".isBan")?.textContent?.includes("不提供閱覽")),1e3)&&(t=!0)):t=Boolean(o.querySelector(".wargin")?.textContent?.includes("不提供閱覽"))||!await o.wait((()=>o.querySelector(".upLoop .table-default-title")),1e3),t){const e=o.querySelector(".isBan, .wargin");e&&(e.style.textDecoration="line-through"),await s(n,a)}!a&&e&&r(n)}})();break}case"www.ponpomu.com":options={name:"terraHistoricus",wait:()=>Boolean(helper.querySelector(".comic-page-container img")),getImgList:()=>helper.querySelectorAll(".comic-page-container img").map((e=>e.dataset.srcset)),SPA:{isMangaPage:()=>window.location.href.includes("/comic/"),getOnPrev:()=>helper.querySelectorClick(".prev-btn:not(.invisible) a"),getOnNext:()=>helper.querySelectorClick(".next-btn:not(.invisible) a")}};break;case"manhua.zaimanhua.com":{const e=()=>unsafeWindow.__NUXT__.data.getChapters?.data?.chapterInfo?.page_url;options={name:"zaiManHua",wait:e,getImgList:e,onNext:helper.querySelectorClick("#prev_chapter"),onPrev:helper.querySelectorClick("#next_chapter")};break}case"terra-historicus.hypergryph.com":{const e=()=>`https://terra-historicus.hypergryph.com/api${window.location.pathname}`,n=n=>async()=>{const t=await main.request(`${e()}/page?pageNum=${n+1}`);return JSON.parse(t.responseText).data.url};options={name:"terraHistoricus",wait:()=>Boolean(helper.querySelector(".HG_COMIC_READER_main")),async getImgList(){const t=(await main.request(e(),{responseType:"json"})).response.data.pageInfos;if(0===t.length&&window.location.pathname.includes("episode"))throw new Error("获取图片列表时出错");return helper.plimit(helper.createSequence(t.length).map(n))},SPA:{isMangaPage:()=>window.location.href.includes("episode"),getOnPrev:()=>helper.querySelectorClick("footer .HG_COMIC_READER_prev a"),getOnNext:()=>helper.querySelectorClick("footer .HG_COMIC_READER_prev+.HG_COMIC_READER_buttonEp a")}};break}case"tw.manhuagui.com":case"m.manhuagui.com":case"www.mhgui.com":case"www.manhuagui.com":{if(!/\/comic\/\d+\/\d+\.html/.test(window.location.pathname))break;let comicInfo;try{const dataScript=helper.querySelectorAll("body > script:not([src])").find((e=>e.innerHTML.startsWith("window[")));if(!dataScript)throw new Error(helper.t("site.changed_load_failed"));comicInfo=JSON.parse(eval(dataScript.innerHTML.slice(26)).match(/(?<=.*?\(){.+}/)[0])}catch{main.toast.error(helper.t("site.changed_load_failed"));break}GM_addStyle("#smh-msg-box { z-index: 2147483647 !important }");const handlePrevNext=e=>{if(0===e)return;const n=window.location.pathname.replace(/(?<=\/)\d+(?=\.html)/,`${e}`);return()=>window.location.assign(n)};options={name:"manhuagui",getImgList(){const e=Object.entries(comicInfo.sl).map((e=>`${e[0]}=${e[1]}`)).join("&");if(comicInfo.files)return comicInfo.files.map((n=>`${unsafeWindow.pVars.manga.filePath}${n}?${e}`));if(comicInfo.images){const{origin:n}=new URL(helper.querySelector("#manga img").src);return comicInfo.images.map((t=>`${n}${t}?${e}`))}return main.toast.error(helper.t("site.changed_load_failed"),{throw:!0}),[]},onNext:handlePrevNext(comicInfo.nextId),onPrev:handlePrevNext(comicInfo.prevId)};break}case"www.manhuadb.com":if(!Reflect.has(unsafeWindow,"img_data_arr"))break;options={name:"manhuaDB",getImgList:()=>unsafeWindow.img_data_arr.map((e=>`${unsafeWindow.img_host}/${unsafeWindow.img_pre}/${e.img}`)),onPrev:()=>unsafeWindow.goNumPage("pre"),onNext:()=>unsafeWindow.goNumPage("next")};break;case"www.manhuaren.com":case"m.1kkk.com":case"www.1kkk.com":case"tel.dm5.com":case"en.dm5.com":case"www.dm5.cn":case"www.dm5.com":{if(!Reflect.has(unsafeWindow,"DM5_CID"))break;const imgNum=unsafeWindow.DM5_IMAGE_COUNT??unsafeWindow.imgsLen;if(!(Number.isSafeInteger(imgNum)&&imgNum>0)){main.toast.error(helper.t("site.changed_load_failed"));break}const getPageImg=async i=>{const res=await unsafeWindow.$.ajax({type:"GET",url:"chapterfun.ashx",data:{cid:unsafeWindow.DM5_CID,page:i,key:unsafeWindow.$("#dm5_key").length>0?unsafeWindow.$("#dm5_key").val():"",language:1,gtk:6,_cid:unsafeWindow.DM5_CID,_mid:unsafeWindow.DM5_MID,_dt:unsafeWindow.DM5_VIEWSIGN_DT,_sign:unsafeWindow.DM5_VIEWSIGN}});return eval(res)},handlePrevNext=(e,n)=>helper.querySelectorClick((()=>helper.querySelector(e)??helper.querySelectorAll(".view-bottom-bar a").find((e=>e.textContent?.includes(n)))));options={name:"dm5",getImgList:({dynamicLoad:e})=>Array.isArray(unsafeWindow.newImgs)&&unsafeWindow.newImgs.every(helper.isUrl)?unsafeWindow.newImgs:e((async e=>{const n=new Set;for(;n.size<imgNum;)for(const t of await getPageImg(n.size+1))n.has(t)||(n.add(t),e(n.size-1,t))}),imgNum)(),onPrev:handlePrevNext(".logo_1","上一章"),onNext:handlePrevNext(".logo_2","下一章"),onExit:e=>e&&helper.scrollIntoView(".postlist")};break}case"www.wn01.uk":case"www.wn05.cc":case"www.wn04.cc":case"www.wn03.cc":case"www.wnacg.com":case"wnacg.com":{const e=helper.querySelector("#bodywrap a.btn");if(e&&(e.style.setProperty("background-color","#607d8b"),e.style.setProperty("background-image","none")),!Reflect.has(unsafeWindow,"imglist"))break;options={name:"wnacg",getImgList:()=>unsafeWindow.imglist.filter((({caption:e})=>"喜歡紳士漫畫的同學請加入收藏哦！"!==e)).map((({url:e})=>new URL(e,window.location.origin).href))};break}case"www.mangabz.com":case"mangabz.com":{if(!Reflect.has(unsafeWindow,"MANGABZ_CID"))break;const imgNum=unsafeWindow.MANGABZ_IMAGE_COUNT??unsafeWindow.imgsLen;if(!(Number.isSafeInteger(imgNum)&&imgNum>0)){main.toast.error(helper.t("site.changed_load_failed"));break}const getPageImg=async i=>{const res=await unsafeWindow.$.ajax({type:"GET",url:"chapterimage.ashx",data:{cid:unsafeWindow.MANGABZ_CID,page:i,key:"",_cid:unsafeWindow.MANGABZ_CID,_mid:unsafeWindow.MANGABZ_MID,_dt:unsafeWindow.MANGABZ_VIEWSIGN_DT,_sign:unsafeWindow.MANGABZ_VIEWSIGN}});return eval(res)},handlePrevNext=(e,n)=>helper.querySelectorClick((()=>helper.querySelector(e)??helper.querySelectorAll(".bottom-bar-tool a").find((e=>e.textContent?.includes(n)))));options={name:"mangabz",getImgList:({dynamicLoad:e})=>e((async e=>{const n=new Set;for(;n.size<imgNum;)for(const t of await getPageImg(n.size+1))n.has(t)||(n.add(t),e(n.size-1,t))}),imgNum)(),onNext:handlePrevNext('body > .container a[href^="/"]:last-child',"下一"),onPrev:handlePrevNext('body > .container a[href^="/"]:first-child',"上一")};break}case"komiic.com":{const e="\n        query imagesByChapterId($chapterId: ID!) {\n          imagesByChapterId(chapterId: $chapterId) {\n            id\n            kid\n            height\n            width\n            __typename\n          }\n        }",n=async()=>{const n=/chapter\/(\d+)/.exec(window.location.pathname)?.[1];if(!n)throw new Error(helper.t("site.changed_load_failed"));return(await main.request("/api/query",{method:"POST",responseType:"json",headers:{"content-type":"application/json"},data:JSON.stringify({operationName:"imagesByChapterId",variables:{chapterId:`${n}`},query:e})})).response.data.imagesByChapterId.map((({kid:e})=>`https://komiic.com/api/image/${e}`))},t=e=>async()=>(await helper.waitDom(".v-bottom-navigation__content"),helper.querySelectorClick(".v-bottom-navigation__content > button:not([disabled])",e));options={name:"komiic",getImgList:n,SPA:{isMangaPage:()=>/comic\/\d+\/chapter\/\d+\/images\//.test(window.location.href),getOnPrev:t("上一"),getOnNext:t("下一")}};break}case"mangadex.org":options={name:"mangadex",async getImgList(){const e=window.location.pathname.split("/").at(2),{response:{baseUrl:n,chapter:{data:t,hash:o}}}=await main.request(`https://api.mangadex.org/at-home/server/${e}?forcePort443=false`,{responseType:"json"});return t.map((e=>n+"/data/"+o+"/"+e))},SPA:{isMangaPage:()=>/^\/chapter\/.+/.test(window.location.pathname),getOnPrev:()=>helper.querySelectorClick('#chapter-selector > a[href^="/chapter/"]:nth-of-type(1)'),getOnNext:()=>helper.querySelectorClick('#chapter-selector > a[href^="/chapter/"]:nth-of-type(2)'),handlePageurl:e=>e.href.replace(/(?<=\/chapter\/.+?)\/.*/,"")}};break;case"noy1.top":options={name:"NoyAcg",async getImgList(){const[,,e]=window.location.hash.split("/"),n=(await helper.wait((()=>helper.querySelector(".lazy-load-image-background img")))).src.split(e)[0],t=await helper.wait((()=>helper.querySelectorAll(".lazy-load-image-background").length));return helper.range(t,(t=>`${n}${e}/${t+1}.webp`))},SPA:{isMangaPage:()=>window.location.hash.startsWith("#/read/")}};break;case"8.twobili.com":case"a.twobili.com":case"articles.onemoreplace.tw":case"www.comicabc.com":{const e=["/online/","/ReadComic/","/comic/"];if(!e.some((e=>location.pathname.startsWith(e))))break;const n=()=>[...unsafeWindow.xx.matchAll(/(?<= s=").+?(?=")/g)].map((([e])=>decodeURIComponent(e)));options={name:"8comic",getImgList:n,onNext:helper.querySelectorClick("#nextvol"),onPrev:helper.querySelectorClick("#prevvol")};break}case"m.77mh.me":case"www.77mh.me":case"m.77mh.xyz":case"www.77mh.xyz":case"m.77mh.nl":case"www.77mh.nl":if(!Reflect.has(unsafeWindow,"msg"))break;options={name:"77mh",async getImgList(){const e=unsafeWindow.img_qianz??unsafeWindow.ImgSvrList;return unsafeWindow.msg.split("|").map((n=>`${e}${n}`))},onNext:helper.querySelectorClick("#pnpage > a","下一"),onPrev:helper.querySelectorClick("#pnpage > a","上一")};break;case"relamanhua.org":case"www.relamanhua.org":case"www.2024manga.com":{if(!window.location.pathname.includes("/chapter/")&&!document.querySelector(".disData[contentkey]"))break;const e=async()=>{const[,,e,,n]=window.location.pathname.split("/");return(await main.request(`https://mapi.fgjfghkk.club/api/v3/comic/${e}/chapter/${n}?platform=1&_update=true`,{responseType:"json"})).response.results.chapter.contents.map((({url:e})=>e.replace(".h800x.",".h1500x.")))};options={name:"relamanhua",getImgList:e,onNext:helper.querySelectorClick(".comicContent-next a:not(.prev-null)"),onPrev:helper.querySelectorClick(".comicContent-prev:not(.index,.list) a:not(.prev-null)")};break}case"hitomi.la":options={name:"hitomi",wait:()=>Reflect.has(unsafeWindow.galleryinfo,"files"),getImgList:()=>(unsafeWindow.galleryinfo?.files).map((e=>unsafeWindow.url_from_url_from_hash(unsafeWindow.galleryinfo.id,e,"webp",void 0,"a")))};break;case"shupogaki.moe":case"hoshino.one":case"niyaniya.moe":{const e=async e=>new Promise((n=>{const t=new XMLHttpRequest;t.responseType="blob",t.open("GET",e),t.onload=()=>{n(URL.createObjectURL(t.response))},t.send()})),n=()=>window.location.href.includes("/g/");options={name:"schale",async getImgList({dynamicLoad:t}){const[,,o,a]=window.location.pathname.split("/"),r=await main.request(`https://api.schale.network/books/detail/${o}/${a}`,{fetch:!0,responseType:"json"}),[[s,{id:i,public_key:l}]]=Object.entries(r.response.data).filter((([e,n])=>Number(e)&&n.id&&n.public_key)).sort((([,e],[,n])=>n.size-e.size)),{created_at:c,updated_at:d}=r.response,p=await main.request(`https://api.schale.network/books/data/${o}/${a}/${i}/${l}?v=${d??c}&w=${s}`,{fetch:!0,responseType:"json"}),{base:g,entries:_}=p.response;return t((async t=>{for(const[o,{path:a,dimensions:r}]of _.entries()){if(!n)break;const s=performance.now();t(o,await e(`${g}${a}?w=${r[0]}`)),await helper.sleep(500-(performance.now()-s))}}),_.length)()},SPA:{isMangaPage:n}};break}case"kemono.su":case"kemono.party":{const e=require("main"),n=require("helper");(async()=>{if(!location.pathname.includes("/post/"))return;const{options:t,setComicLoad:o,showComic:a,switchComic:r,needAutoShow:s}=await e.useInit("kemono",{autoShow:!1,defaultOption:{pageNum:1},load_original_image:!0});o((()=>n.querySelectorAll(".post__thumbnail a").map((e=>e.href))),"original"),o((()=>n.querySelectorAll(".post__thumbnail img").map((e=>e.src))),"thumbnail"),n.createEffectOn((()=>t.load_original_image),((e,n)=>{if(!n)return r(e?"original":"thumbnail");s.val=t.autoShow,a(e?"original":"thumbnail")}));const i=new Set(["zip","rar","7z","cbz","cbr","cb7"]);for(const e of n.querySelectorAll(".post__attachment a")){if(!i.has(e.href.split(".").pop()))continue;const n=document.createElement("a");n.href=`https://comic-read.pages.dev/?url=${encodeURIComponent(e.href)}`,n.textContent=e.textContent.replace("Download ","ComicReadPWA - "),n.className=e.className,n.style.opacity=".6",e.parentNode.insertBefore(n,e.nextElementSibling)}})();break}case"nekohouse.su":options={name:"nekohouse",getImgList:()=>helper.querySelectorAll(".fileThumb").map((e=>e.getAttribute("href"))),initOptions:{autoShow:!1,defaultOption:{pageNum:1}}};break;case"nicomanga.com":case"weloma.art":case"welovemanga.one":{if(!helper.querySelector("#listImgs, .chapter-content"))break;const e=async()=>{const n=helper.querySelectorAll("img.chapter-img:not(.ls-is-cached)").map((e=>(e.dataset.src??e.dataset.srcset??e.dataset.original??e.src).trim()));return n.length>0&&n.every((e=>!/loading.*\.gif/.test(e)))?n:(await helper.sleep(500),e())};options={name:"welovemanga",getImgList:e,onNext:helper.querySelectorClick(".rd_top-right.next:not(.disabled)"),onPrev:helper.querySelectorClick(".rd_top-left.prev:not(.disabled)")};break}case"comic-read.pages.dev":unsafeWindow.GM_xmlhttpRequest=GM_xmlhttpRequest,unsafeWindow.toast=main.toast;break;default:(async()=>{if(void 0!==await GM.getValue(window.location.hostname))return requestIdleCallback(otherSite.otherSite);const e=await GM.registerMenuCommand((e=>{switch(e){case"en":return"Enter simple reading mode";case"ru":return"Включить простой режим чтения";default:return"使用简易阅读模式"}})(await languages.getInitLang()),(async()=>!await otherSite.otherSite()&&GM.unregisterMenuCommand(e)))})()}options&&main.universal(options)}catch(e){helper.log.error(e)}