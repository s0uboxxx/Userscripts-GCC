// ==UserScript==
// @name                 Netflix Plus
// @name:ja              Netflix Plus
// @name:zh-CN           Netflix Plus
// @name:zh-TW           Netflix Plus
// @namespace            http://tampermonkey.net/
// @version              2.15
// @description          Enable best audio and video and more features on Netflix
// @description:ja       Netflixで最高の音質と画質、そしてもっと多くの機能を体験しましょう
// @description:zh-CN    在 Netflix 上开启最佳音视频质量和更多功能
// @description:zh-TW    在 Netflix 上啓用最佳影音品質和更多功能
// @author               TGSAN
// @match                https://www.netflix.com/*
// @icon                 https://www.google.com/s2/favicons?sz=64&domain=netflix.com
// @run-at               document-start
// @sandbox              raw
// @grant                unsafeWindow
// @grant                GM_setValue
// @grant                GM_getValue
// @grant                GM_registerMenuCommand
// @grant                GM_unregisterMenuCommand
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Netflix20Plus.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Netflix20Plus.meta.js
// ==/UserScript==
(async()=>{"use strict";let e,t=self.window;self.unsafeWindow?(console.log("[Netflix Plus] use unsafeWindow mode"),t=self.unsafeWindow):console.log("[Netflix Plus] use window mode (your userscript extensions not support unsafeWindow)");{const e=document.createElement("meta");e.httpEquiv="Cache-Control",e.content="no-cache",t.document.head.appendChild(e)}{const e=document.createElement("meta");e.httpEquiv="Pragma",e.content="no-cache",t.document.head.appendChild(e)}{const e=document.createElement("meta");e.httpEquiv="Expires",e.content="-1",t.document.head.appendChild(e)}let n=!0;function s(){if(n=!1,null==e)for(let n of t.document.getElementsByTagName("script"))if(n.src&&n.src.indexOf("cadmium-playercore")>-1){e=n;break}let s=document.createElement("script");s.src="https://www.cloudmoe.com/static/userscript/netflix-plus/cadmium-playercore.js",s.async=e.async,s.id=e.id,e.replaceWith(s)}t.Function.prototype.callNetflixPlusOriginal=t.Function.prototype.call,t.Function.prototype.call=function(...e){if(n){let e=this.toString();if(e.length>1e6&&e.indexOf("h264mpl")>-1&&e.indexOf("videoElementNetflixPlus")<0)return console.log("PlayerCore found len: "+e.length),void s()}return this.callNetflixPlusOriginal(...e)},void 0!==t.netflix&&void 0!==t.netflix.player&&(!function(e,t=1500){let n=function(){let e=document.createElement("div");return e.style.position="fixed",e.style.top="20px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.padding="10px 20px",e.style.backgroundColor="rgba(250, 250, 250, 1.0)",e.style.color="rgba(32, 32, 32, 1.0)",e.style.fontSize="12px",e.style.textAlign="center",e.style.fontWeight="600",e.style.zIndex="9999",e.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.25)",e.style.borderRadius="30px",e.style.opacity="0.0",e.style.transition="opacity 0.5s",document.body.appendChild(e),e}();n.innerText=e,setTimeout((function(){n.style.opacity="1.0",setTimeout((function(){n.style.opacity="0.0",setTimeout((function(){document.body.removeChild(n)}),500)}),t)}),1)}('Netflix Plus is executing too late and is being forced to run, which may cause issues.\n\nRefresh the page while holding down the "Shift" key to resolve the issue.',1e4),console.warn("The user script is executing too late and is being forced to run, which may cause issues."),s()),t._videoElementNetflixPlus,Object.defineProperty(t,"videoElementNetflixPlus",{get:function(){return t._videoElementNetflixPlus},set:function(e){let n=t._videoElementNetflixPlus;t._videoElementNetflixPlus=e,e.addEventListener("playing",(function(){if(n===e)return;if(!t.globalOptions.setMaxBitrate)return;let s=function(e){return document.evaluate(e,document,null,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue},i=function(){t.dispatchEvent(new KeyboardEvent("keydown",{keyCode:83,ctrlKey:!0,altKey:!0,shiftKey:!0})),t.dispatchEvent(new KeyboardEvent("keydown",{keyCode:66,ctrlKey:!0,altKey:!0,shiftKey:!0}));const o=s("//div[text()='Video Bitrate / VMAF']"),l=s("//div[text()='Audio Bitrate']"),a=s("//button[text()='Override']");o&&l&&a?([o,l].forEach((function(e){let t=e.parentElement;t.querySelectorAll("select").forEach((function(e){e.removeAttribute("disabled")}));let n=t.querySelectorAll("select > option");for(var s=0;s<n.length-1;s++)n[s].removeAttribute("selected");n[n.length-1].setAttribute("selected","selected")})),setTimeout((function(){a.click()}),100),n=e):setTimeout(i,100)};i()}))}}),t.modifyFilterNetflixPlus=function(e,n,s){let i="playready"===s?30:0;return t.globalOptions.useprk&&(e.push("h264mpl30-dash-playready-prk-qc"),e.push("h264mpl31-dash-playready-prk-qc"),e.push("h264mpl40-dash-playready-prk-qc")),30==i?(t.globalOptions.useddplus&&(e.push("ddplus-2.0-dash"),e.push("ddplus-5.1-dash"),e.push("ddplus-5.1hq-dash"),e.push("ddplus-atmos-dash")),t.globalOptions.usehevc&&(e=e.filter((e=>{if(!new RegExp(/main10-L5/g).test(JSON.stringify(e)))return e}))),t.globalOptions.usef12k&&(e=e.filter((e=>{if(!new RegExp(/hevc-main10-L.*-dash-cenc-prk-do/g).test(JSON.stringify(e)))return e}))),t.globalOptions.usef4k&&(e.push("hevc-main10-L30-dash-cenc"),e.push("hevc-main10-L31-dash-cenc"),e.push("hevc-main10-L40-dash-cenc"),e.push("hevc-main10-L41-dash-cenc"))):(t.globalOptions.useFHD&&(e.push("playready-h264mpl40-dash"),e.push("playready-h264hpl40-dash"),e.push("vp9-profile0-L40-dash-cenc"),e.push("av1-main-L50-dash-cbcs-prk"),e.push("av1-main-L51-dash-cbcs-prk")),t.globalOptions.useHA&&e.push("heaac-5.1-dash"),t.globalOptions.usedef||(t.globalOptions.useav1&&(e.push("av1-main-L20-dash-cbcs-prk"),e.push("av1-main-L21-dash-cbcs-prk"),e=(e=e.filter((e=>{if(!new RegExp(/h264/g).test(JSON.stringify(e)))return e}))).filter((e=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(e)))return e}))),t.globalOptions.usevp9&&(e.push("vp9-profile0-L21-dash-cenc"),e=(e=e.filter((e=>{if(!new RegExp(/h264/g).test(JSON.stringify(e)))return e}))).filter((e=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(e)))return e}))),t.globalOptions.useAVCH&&(e=(e=(e=e.filter((e=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(e)))return e}))).filter((e=>{if(!new RegExp(/h264mp/g).test(JSON.stringify(e)))return e}))).filter((e=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(e)))return e}))),t.globalOptions.useAVC&&(e=(e=(e=e.filter((e=>{if(!new RegExp(/vp9-profile/g).test(JSON.stringify(e)))return e}))).filter((e=>{if(!new RegExp(/h264hp/g).test(JSON.stringify(e)))return e}))).filter((e=>{if(!new RegExp(/av1-main/g).test(JSON.stringify(e)))return e}))))),t.globalOptions.useallSub&&(n.showAllSubDubTracks=1),t.globalOptions.closeimsc&&(e=e.filter((e=>{if(!new RegExp(/imsc1.1/g).test(JSON.stringify(e)))return e}))),[e,n,s]};const i=class{constructor(e,t){this.script=e,this.target=t,this._cancel=!1,this._replace=null,this._stop=!1}preventDefault(){this._cancel=!0}stopPropagation(){this._stop=!0}replacePayload(e){this._replace=e}};let o=[];t.addBeforeScriptExecuteListener=e=>{if("function"!=typeof e)throw new Error("Event handler must be a function.");o.push(e)},t.removeBeforeScriptExecuteListener=e=>{let t=o.length;for(;t--;)o[t]===e&&o.splice(t,1)};const l=(e,n)=>{if("SCRIPT"!==e.tagName)return;const s=new i(e,n);if("function"==typeof t.onbeforescriptexecute)try{t.onbeforescriptexecute(s)}catch(e){console.error(e)}for(const e of o){if(s._stop)break;try{e(s)}catch(e){console.error(e)}}s._cancel?(e.textContent="",e.remove()):"string"==typeof s._replace&&(e.textContent=s._replace)};new MutationObserver((e=>{for(const t of e)for(const e of t.addedNodes)l(e,t.target)})).observe(document,{childList:!0,subtree:!0});const a=[["setMaxBitrate","Automatically select best bitrate available"],["useallSub","Show all audio-tracks and subs"],["closeimsc","Use SUP subtitle replace IMSC subtitle"],["useDDPandHA","Enable Dolby and HE-AAC 5.1 Audio"],["useFHDAndAVCH","Focus 1080P and High-AVC"]];let r=[];async function u(e){let n=await GM_getValue("NETFLIX_PLUS_"+e);return"boolean"==typeof n?n:t.globalOptions[e]}async function c(e,n){let s=await u(n);return t.globalOptions[n]=s,await GM_registerMenuCommand((await u(n)?"✅":"🔲")+" "+e,(async function(){await GM_setValue("NETFLIX_PLUS_"+n,!s),t.globalOptions[n]=!s,p()}))}async function p(){for(let e of r)await GM_unregisterMenuCommand(e);r=[];for(let e of a)r.push(await c(e[1],e[0]))}t.globalOptions={useFHDAndAVCH:!1,useDDPandHA:!0,setMaxBitrate:!0,useallSub:!0,get useddplus(){return t.globalOptions.useDDPandHA},useAVC:!1,get useFHD(){return t.globalOptions.useFHDAndAVCH},usedef:!1,get useHA(){return t.globalOptions.useDDPandHA},get useAVCH(){return t.globalOptions.useFHDAndAVCH},usevp9:!1,useav1:!1,useprk:!0,usehevc:!1,usef4k:!0,usef12k:!1,closeimsc:!0},t.globalOptions.useFHDAndAVCH=!await async function(){let e=!1;t.MSMediaKeys&&(e=!0);t.WebKitMediaKeys&&(e=!0);let n=[{videoCapabilities:[{contentType:"video/mp4;codecs=avc1.42E01E",robustness:"HW_SECURE_ALL"}]}];try{await navigator.requestMediaKeySystemAccess("com.widevine.alpha.experiment",n),e=!0}catch{}return console.log("Supported advanced DRM: "+e),e}(),t.onbeforescriptexecute=function(n){let s=document.getElementsByTagName("script");if(0!==s.length)for(let n=0;s.length>n;n++){let i=s[n];if(i.src.includes("cadmium-playercore")){e=i,console.warn("parsing playercore dom"),t.onbeforescriptexecute=null;break}}},p()})();