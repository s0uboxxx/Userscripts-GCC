// ==UserScript==
// @name         Telegram Web - Allow Saving Content
// @namespace    c0d3r
// @license      MIT
// @version      0.5
// @description  Bypass Telegram's saving content restrictions for media and text; batch download media from selected messages
// @author       c0d3r
// @match        https://web.telegram.org/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=telegram.org
// @grant        unsafeWindow
// @grant        GM_addStyle
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Telegram20Web2020Allow20Saving20Content.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Telegram20Web2020Allow20Saving20Content.meta.js
// ==/UserScript==
function downloadMediaFromMessage(e){var t;e.media&&(t=e.media.document||e.media.photo),t&&unsafeWindow.appDownloadManager.downloadToDisc({media:t})}function slowDown(e,t,n,o,a){setTimeout((function(){n.disabled=!0,n.style.opacity=.6,o.textContent=".."+(e+1)+"..",a.textContent="ðŸ•”",downloadMediaFromMessage(t)}),1e3*e)}async function downloadSingleMedia(e,t){downloadMediaFromMessage(await unsafeWindow.mtprotoMessagePort.getMessageByPeer(e,t))}async function downloadSelectedMedia(){var e=await unsafeWindow.appImManager.chat.selection.getSelectedMessages(),t=0,n=document.querySelector("#batch-btn"),o=n.querySelector(".i18n"),a=n.querySelector(".mytgico");e.forEach((function(i,s){i.media&&(i.media.document||i.media.photo)&&(slowDown(t,i,n,o,a),t++),s===e.length-1&&setTimeout((function(){n.disabled=!1,n.style.opacity=1,o.textContent="D/L",a.textContent="ðŸ“¥"}),1e3*t)}))}!function(){"use strict";if(window.location.pathname.startsWith("/a/"))window.location.replace(window.location.href.replace(".org/a/",".org/k/"));else{var e,t,n=document.querySelector("#column-center"),o=["photo","audio","video","voice-message","media-round","grouped-item","document-container","sticker"],a=!1;GM_addStyle(".no-forwards .bubbles, .bubble, .bubble-content { -webkit-user-select: text!important; -moz-user-select: text!important; user-select: text!important; }");var i=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(e){"copy"!==e&&i.apply(this,arguments)},n.addEventListener("mouseup",(function(n){if(2===n.button&&(a=!1,document.querySelector(".no-forwards"))){var i=n.target.closest("[data-mid]");i&&o.some((function(e){return i.classList.contains(e)}))&&(e=i.dataset.mid,t=i.dataset.peerId,a=!0)}})),new MutationObserver((function(n){n.forEach((function(n){n.addedNodes.forEach((function(n){"bubble-contextmenu"===n.id&&a&&(n.querySelector(".btn-menu-item").insertAdjacentHTML("beforebegin",'<div class="btn-menu-item rp-overflow" id="down-btn"><span class="mytgico btn-menu-item-icon" style="font-size: 16px;">ðŸ“¥</span><span class="i18n btn-menu-item-text">Download</span></div>'),n.querySelector("#down-btn").addEventListener("click",(function(){downloadSingleMedia(t,e)}))),n.classList&&n.classList.contains("selection-wrapper")&&(n.querySelector(".selection-container-left").insertAdjacentHTML("beforeend",'&nbsp;&nbsp;<button class="btn-primary btn-transparent text-bold" id="batch-btn" title="Download Media"><span class="mytgico" style="padding-bottom: 2px;">ðŸ“¥</span>&nbsp;<span class="i18n">D/L</span></button>'),n.querySelector("#batch-btn").addEventListener("click",(function(){downloadSelectedMedia()})))}))}))})).observe(n,{subtree:!0,childList:!0})}}();