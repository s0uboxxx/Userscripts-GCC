// ==UserScript==
// @name            计时器掌控者|视频广告跳过|视频广告加速器
// @name:en         TimerHooker
// @namespace       https://gitee.com/HGJing/everthing-hook/
// @version         1.0.62
// @description     控制网页计时器速度|加速跳过页面计时广告|视频快进（慢放）|跳过广告|支持几乎所有网页.
// @description:en  it can hook the timer speed to change.
// @include         *
// @require         https://greasyfork.org/scripts/372672-everything-hook/code/Everything-Hook.js?version=881251
// @author          Cangshi
// @match           http://*/*
// @run-at          document-start
// @grant           none
// @license         GPL-3.0-or-later
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/E8AEA1E697B6E599A8E68E8CE68EA7E880857CE8A786E9A291E5B9BFE5918AE8B7B3E8BF877CE8A786E9A291E5B9BFE5918AE58AA0E9809FE599A8.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/E8AEA1E697B6E599A8E68E8CE68EA7E880857CE8A786E9A291E5B9BFE5918AE8B7B3E8BF877CE8A786E9A291E5B9BFE5918AE58AA0E9809FE599A8.meta.js
// ==/UserScript==
window.isDOMLoaded=!1,window.isDOMRendered=!1,document.addEventListener("readystatechange",(function(){"interactive"!==document.readyState&&"complete"!==document.readyState||(window.isDOMLoaded=!0)})),function(e){var t=[],n=[],i={},o=function(t,o,a){return{applyUI:function(){var t="._th-container ._th-item{margin-bottom:3px;position:relative;width:0;height:0;cursor:pointer;opacity:.3;background-color:aquamarine;border-radius:100%;text-align:center;line-height:30px;-webkit-transition:all .35s;-o-transition:all .35s;transition:all .35s;right:30px}._th-container ._th-item,._th-container ._th-click-hover,._th_cover-all-show-times ._th_times{-webkit-box-shadow:-3px 4px 12px -5px black;box-shadow:-3px 4px 12px -5px black}._th-container:hover ._th-item._item-x2{margin-left:18px;width:40px;height:40px;line-height:40px}._th-container:hover ._th-item._item-x-2{margin-left:17px;width:38px;height:38px;line-height:38px}._th-container:hover ._th-item._item-xx2{width:36px;height:36px;margin-left:16px;line-height:36px}._th-container:hover ._th-item._item-xx-2{width:32px;height:32px;line-height:32px;margin-left:14px}._th-container:hover ._th-item._item-reset{width:30px;line-height:30px;height:30px;margin-left:10px}._th-click-hover{position:relative;-webkit-transition:all .5s;-o-transition:all .5s;transition:all .5s;height:45px;width:45px;cursor:pointer;opacity:.3;border-radius:100%;background-color:aquamarine;text-align:center;line-height:45px;right:0}._th-container:hover{left:-5px}._th-container{font-size:12px;-webkit-transition:all .5s;-o-transition:all .5s;transition:all .5s;left:-35px;top:20%;position:fixed;-webkit-box-sizing:border-box;box-sizing:border-box;z-index:100000;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}._th-container ._th-item:hover{opacity:.8;background-color:#5fb492;color:aliceblue}._th-container ._th-item:active{opacity:.9;background-color:#1b3a26;color:aliceblue}._th-container:hover ._th-click-hover{opacity:.8}._th-container:hover ._th-item{opacity:.6;right:0}._th-container ._th-click-hover:hover{opacity:.8;background-color:#5fb492;color:aliceblue}._th_cover-all-show-times{position:fixed;top:0;right:0;width:100%;height:100%;z-index:99999;opacity:1;font-weight:900;font-size:30px;color:#4f4f4f;background-color:rgba(0,0,0,0.1)}._th_cover-all-show-times._th_hidden{z-index:-99999;opacity:0;-webkit-transition:1s all;-o-transition:1s all;transition:1s all}._th_cover-all-show-times ._th_times{width:300px;height:300px;border-radius:50%;background-color:rgba(127,255,212,0.51);text-align:center;line-height:300px;position:absolute;top:50%;right:50%;margin-top:-150px;margin-right:-150px}",n=(1/o._percentage).toFixed(2),i='<div class="_th-container">\n    <div class="_th-click-hover _item-input">\n        x'+n+'\n    </div>\n    <div class="_th-item _item-x2">&gt;</div>\n    <div class="_th-item _item-x-2">&lt;</div>\n    <div class="_th-item _item-xx2">&gt;&gt;</div>\n    <div class="_th-item _item-xx-2">&lt;&lt;</div>\n    <div class="_th-item _item-reset">O</div>\n</div>\n<div class="_th_cover-all-show-times _th_hidden">\n    <div class="_th_times">x'+n+"</div>\n</div>",a=document.createElement("style");if(a.setAttribute("type","text/css"),a.styleSheet)a.styleSheet.cssText=t;else{var r=document.createTextNode(t);a.appendChild(r)}var c=document.createElement("div");c.innerHTML=i;var l={"_item-input":function(){changeTime()},"_item-x2":function(){changeTime(2,0,!0)},"_item-x-2":function(){changeTime(-2,0,!0)},"_item-xx2":function(){changeTime(0,2)},"_item-xx-2":function(){changeTime(0,-2)},"_item-reset":function(){changeTime(0,0,!1,!0)}};Object.keys(l).forEach((function(e){var t=l[e],n=c.getElementsByClassName(e)[0];n&&(n.onclick=t)})),e.isDOMLoaded?(document.head.appendChild(a),document.body.appendChild(c),e.isDOMRendered=!0,console.log("Time Hooker Works!")):document.addEventListener("readystatechange",(function(){"interactive"!==document.readyState&&"complete"!==document.readyState||e.isDOMRendered||(document.head.appendChild(a),document.body.appendChild(c),e.isDOMRendered=!0,console.log("Time Hooker Works!"))}))},applyGlobalAction:function(t){t.changeTime=function(n,i,a,r){if(r)e.timer.change(1);else if(e.timer){var c;if(n||i)if(a&&n){if(1/o._percentage<=1&&n<0)return;c=1/(1/o._percentage+n)}else i<=0&&(i=1/-i),c=1/(1/o._percentage*i);else{var l=prompt("输入欲改变计时器变化倍率（当前："+1/o._percentage+"）");if(null==l)return;if(isNaN(parseFloat(l)))return alert("请输入正确的数字"),void t.changeTime();if(parseFloat(l)<=0)return alert("倍率不能小于等于0"),void t.changeTime();c=1/parseFloat(l)}t.change(c)}},e.changeTime=t.changeTime},applyHooking:function(){var e=this;t.hookReplace(window,"setInterval",(function(t){return e.getHookedTimerFunction("interval",t)})),t.hookReplace(window,"setTimeout",(function(t){return e.getHookedTimerFunction("timeout",t)})),t.hookBefore(window,"clearInterval",(function(t,n){e.redirectNewestId(n)})),t.hookBefore(window,"clearTimeout",(function(t,n){e.redirectNewestId(n)}));var n=this.getHookedDateConstructor();t.hookClass(window,"Date",n,"_innerDate",["now"]),Date.now=function(){return(new Date).getTime()},t.hookedToString(o._Date.now,Date.now);var i=Object.prototype.toString;Object.prototype.toString=function(){"use strict";return this instanceof o._mDate?"[object Date]":i.call(this)},t.hookedToString(i,Object.prototype.toString),t.hookedToString(o._setInterval,setInterval),t.hookedToString(o._setTimeout,setTimeout),t.hookedToString(o._clearInterval,clearInterval),o._mDate=window.Date,this.hookShadowRoot()},getHookedDateConstructor:function(){return function(){if(1!==arguments.length)if(arguments.length>1){var e;switch(arguments.length){case 2:e=new o._Date(arguments[0],arguments[1]);break;case 3:e=new o._Date(arguments[0],arguments[1],arguments[2]);break;case 4:e=new o._Date(arguments[0],arguments[1],arguments[2],arguments[3]);break;case 5:e=new o._Date(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4]);break;case 6:e=new o._Date(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5]);break;default:e=new o._Date(arguments[0],arguments[1],arguments[2],arguments[3],arguments[4],arguments[5],arguments[6])}Object.defineProperty(this,"_innerDate",{configurable:!1,enumerable:!1,value:e,writable:!1})}else{var t=(o._Date.now()-o.__lastDatetime)*(1/o._percentage);Object.defineProperty(this,"_innerDate",{configurable:!1,enumerable:!1,value:new o._Date(o.__lastMDatetime+t),writable:!1})}else Object.defineProperty(this,"_innerDate",{configurable:!1,enumerable:!1,value:new o._Date(arguments[0]),writable:!1})}},getHookedTimerFunction:function(e,t){var n="_"+e+"Ids";return function(){var e=o.genUniqueId(),i=arguments[0];"string"==typeof i&&(arguments[0]=i+=";timer.notifyExec("+e+")"),"function"==typeof i&&(arguments[0]=function(){var t=i.apply(this,arguments);return o.notifyExec(e),t});var a=arguments[1];arguments[1]*=o._percentage;var r=t.apply(window,arguments);return o[n][r]={args:arguments,originMS:a,originId:r,nowId:r,uniqueId:e,oldPercentage:o._percentage,exceptNextFireTime:o._Date.now()+a},r}},redirectNewestId:function(e){var t=e[0];o._intervalIds[t]&&(e[0]=o._intervalIds[t].nowId,delete o._intervalIds[t]),o._timeoutIds[t]&&(e[0]=o._timeoutIds[t].nowId,delete o._timeoutIds[t])},registerShortcutKeys:function(e){addEventListener("keydown",(function(t){switch(t.keyCode){case 57:(t.ctrlKey||t.altKey)&&e.changeTime();break;case 190:case 187:t.ctrlKey?e.changeTime(2,0,!0):t.altKey&&e.changeTime(0,2);break;case 188:case 189:t.ctrlKey?e.changeTime(-2,0,!0):t.altKey&&e.changeTime(0,-2);break;case 48:(t.ctrlKey||t.altKey)&&e.changeTime(0,0,!1,!0)}}))},percentageChangeHandler:function(e){a.ergodicObject(o,o._intervalIds,(function(t,n){t.args[1]=Math.floor((t.originMS||1)*e),this._clearInterval.call(window,t.nowId),t.nowId=this._setInterval.apply(window,t.args)})),a.ergodicObject(o,o._timeoutIds,(function(t,n){var i=this._Date.now(),o=t.exceptNextFireTime,a=t.oldPercentage,r=o-i;r<0&&(r=0);var c=Math.floor(e/a*r);t.args[1]=c,t.exceptNextFireTime=i+c,t.oldPercentage=e,this._clearTimeout.call(window,t.nowId),t.nowId=this._setTimeout.apply(window,t.args)}))},hookShadowRoot:function(){var e=Element.prototype.attachShadow;t.hookAfter(Element.prototype,"attachShadow",(function(e,t,i){return n.push(i),i}),!1),t.hookedToString(e,Element.prototype.attachShadow)},hookDefine:function(){const e=this;t.hookBefore(Object,"defineProperty",(function(t,n){var i=n[2],o=n[0],a=n[1];e.hookDefineDetails(o,a,i).forEach(((e,t)=>{n[t]=e}))})),t.hookBefore(Object,"defineProperties",(function(t,n){var i=n[1],o=n[0];o&&o instanceof Element&&Object.keys(i).forEach((t=>{var a=i[t],r=e.hookDefineDetails(o,t,a);n[0]=r[0],delete i[t],i[r[1]]=r[2]}))}))},hookDefineDetails:function(e,t,n){return n&&e&&e instanceof Element&&"string"==typeof t&&t.indexOf("on")>=0&&(n.configurable=!0),e instanceof HTMLVideoElement&&"playbackRate"===t&&(n.configurable=!0,console.warn("[Timer Hook]","已阻止默认操作视频倍率"),t="playbackRate_hooked"),[e,t,n]},suppressEvent:function(e,n){e&&(delete e["on"+n],delete e["on"+n],delete e["on"+n],e["on"+n]=void 0),i[n]||(t.hookBefore(EventTarget.prototype,"addEventListener",(function(e,t){var i=t[0];n===i&&(console.warn(n,"event suppressed."),t[0]+="suppressed")}),!1),i[n]=!0)},changePlaybackRate:function(e,t){delete e.playbackRate,delete e.playbackRate,delete e.playbackRate,e.playbackRate=t,1!==t&&o.defineProperty.call(Object,e,"playbackRate",{configurable:!0,get:function(){return 1},set:function(){}})}}},a=function(){let t=e.parent!==e;try{t=t&&"FRAMESET"!==e.parent.document.body.tagName}catch(e){}return t},r=function(t){e.addEventListener("message",(function(e){var n=e.data;"changePercentage"===(n.type||"")&&t(n.percentage||0)}))},c=function(e){var t=document.querySelectorAll("iframe")||[],n=document.querySelectorAll("frame");if(t.length)for(var i=0;i<t.length;i++)t[i].contentWindow.postMessage({type:"changePercentage",percentage:e},"*");if(n.length)for(var o=0;o<n.length;o++)n[o].contentWindow.postMessage({type:"changePercentage",percentage:e},"*")},l=function(e,t,i){var o=e.querySelectorAll(t);return o=Array.prototype.slice.call(o||[]),i&&n.forEach((function(e){o=o.concat(l(e,t,!1))})),o};e.eHook&&e.eHook.plugins({name:"timer",mount:function(e){t.forEach((function(t){e.urlMatching(location.href,"http.*://.*"+t+".*")&&(window.Worker=void 0,console.log("Worker disabled"))}));var n=this,i={_intervalIds:{},_timeoutIds:{},_auoUniqueId:1,__percentage:1,_setInterval:window.setInterval,_clearInterval:window.clearInterval,_clearTimeout:window.clearTimeout,_setTimeout:window.setTimeout,_Date:window.Date,__lastDatetime:(new Date).getTime(),__lastMDatetime:(new Date).getTime(),videoSpeedInterval:1e3,defineProperty:Object.defineProperty,defineProperties:Object.defineProperties,genUniqueId:function(){return this._auoUniqueId++},notifyExec:function(e){var t=this;e&&Object.values(this._timeoutIds).filter((function(t){return t.uniqueId===e})).forEach((function(e){t._clearTimeout.call(window,e.nowId),delete t._timeoutIds[e.originId]}))},init:function(){var t=this,i=o(n,t,e);i.hookDefine(),i.applyHooking(),Object.defineProperty(t,"_percentage",{get:function(){return t.__percentage},set:function(e){return e===t.__percentage||(i.percentageChangeHandler(e),t.__percentage=e),e}}),a()?(console.log("[TimeHooker]","loading inner window..."),r(function(e){console.log("[TimeHooker]","Inner Changed",e),this.change(e)}.bind(this))):(console.log("[TimeHooker]","loading outer window..."),i.applyUI(),i.applyGlobalAction(t),i.registerShortcutKeys(t))},change:function(e){this.__lastMDatetime=this._mDate.now(),this.__lastDatetime=this._Date.now(),this._percentage=e;var t=document.getElementsByClassName("_th-click-hover"),n=document.getElementsByClassName("_th_times"),i=(1/this._percentage).toFixed(2);(t[0]||{}).innerHTML="x"+i,(n[0]||{}).innerHTML="x"+i;var o=document.getElementsByClassName("_th_cover-all-show-times")[0]||{};o.className="_th_cover-all-show-times",this._setTimeout.bind(window)((function(){o.className="_th_cover-all-show-times _th_hidden"}),100),this.changeVideoSpeed(),c(e)},changeVideoSpeed:function(){var t=o(n,this,e),i=1/this._percentage;i>16&&(i=16),i<.065&&(i=.065);var a=l(document,"video",!0)||[];if(a.length)for(var r=0;r<a.length;r++)t.changePlaybackRate(a[r],i)}};return i.init(),i}})}(window);