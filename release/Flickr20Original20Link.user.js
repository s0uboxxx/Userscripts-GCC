// ==UserScript==
// @name        Flickr Original Link
// @namespace   https://greasyfork.org/scripts/1190-flickr-original-link
// @include 	/flickr\.com/
// @version	6.0
// @grant       GM_getValue
// @grant       GM_setValue
// @grant 	GM_addStyle
// @require 	https://code.jquery.com/jquery-3.3.1.min.js
// @description  Show direct links to download biggest Flickr image available and some other sizes.
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Flickr20Original20Link.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Flickr20Original20Link.meta.js
// ==/UserScript==
var postfix="_d.jpg",prefix="DOWNLOAD ",isChecked_openLink="",isChecked_alwaysShow="",key_openLink="flickr_openLink",key_alwaysShow="flickr_alwaysShow",value_openLink=!1,value_alwaysShow=!1,imageSizeOrder=["9k","8k","7k","6k","5k","4k","3k","2k","o","k","h","l","b","c","z"],globalObserver=null;function log(e){console.log(e)}function getSetting(){log("Begin get settings"),value_openLink=GM_getValue(key_openLink,!1),value_alwaysShow=GM_getValue(key_alwaysShow,!1),value_openLink?(postfix=".",isChecked_openLink=' checked="checked" ',prefix="OPEN "):(postfix="_d.",isChecked_openLink="",prefix="DOWNLOAD "),isChecked_alwaysShow=value_alwaysShow?' checked="checked" ':""}function checkAlwaysShow(){value_alwaysShow&&$("div.interaction-view").css("opacity","1"),$("div.interaction-bar").css("bottom","1.1em")}function action_single_page(){if($(".commonButton").length>0)return!1;$.get(document.URL,(function(e){for(var t=e.match(/modelExport: {.+?"sizes":{.+?}}/i),i=t[0].match(/"width":"?\d+"?,"height":"?\d+"?,/gi),o=t[0].match(/"displayUrl":"[^"]+"/gi),n=o.length,a=0;a<n;a++)i[a]=i[a].replace(/"width":(\d+),"height":(\d+),/i,"$1 x $2"),o[a]=o[a].replace(/"displayUrl":"([^"]+)"/i,"$1").replace(/\\/g,"").replace(/(_[0-9a-z]+)\.([a-z]{3,4})/i,"$1"+postfix+"$2");var r=$(".sub-photo-right-row1").filter(":first"),l='<div><a class="commonButton bigButton" href="'+o[n-1]+'">'+prefix+i[n-1]+" px</a>";for(a=n-2;a>=n-7&&a>=0;--a)l+='<a class="commonButton smallButton" href="'+o[a]+'">'+i[a]+" px</a>";l+="</div>",r.prop("outerHTML",l+r.prop("outerHTML"))}))}function getLinkFromSource(e){if(null!==e){var t=e.match(/"sizes":.+?}}/gi);if(null===t)return!1;var i=e.match(/"datePosted":"\d+"/gi);null==i&&log("cannot find any dates");var o=$("div.photo-list-photo-view");"album"==type&&(o=$("div.photo-card-view div.foot")),log("Number of photo in this page: "+o.length);for(var n=0;n<o.length;n++){var a=$(o[n]);if(!(a.find(".myFuckingLink").filter(":first").length>0)){a.html(a.html()+'<a class="myFuckingLink"></a>');for(var r=0;r<imageSizeOrder.length;++r){var l=t[n].match(new RegExp('"'+imageSizeOrder[r]+'".*?:{"displayUrl":"([^"]+)","width":(\\d+),"height":(\\d+)',"i"));if(null!==l){var c=a.find(".myFuckingLink");c.attr("href",l[1].replace(/\\/g,"").replace(/(_[0-9a-z]+)\.([a-z]{3,4})/i,"$1"+postfix+"$2"));var s=i[n].match(/\d+/i),p=new Date(1e3*new Number(s));c.attr("title",prefix+l[2]+" x "+l[3]+" | Upload: "+p.toLocaleDateString()),c.html(prefix+l[2]+" x "+l[3]);break}}}}}}function action_normal_page(e){var t=$("#content")[0],i="none",o=0,n=null,a=function(e){var t=$("div.photo-list-photo-view");if("album"==e&&(t=$("div.photo-card-view")),document.URL==i){if(t.length==o)return!1;checkAlwaysShow(),log("Number of thumb: "+(o=t.length)),getLinkFromSource(n)}else{var a=t.find("a").filter(":first");if(a.length<1)return!1;checkAlwaysShow(),n=null,i=document.URL;var r=a.attr("href");console.time("GetSource"),$("#content").append('<div id="loadingIndicator" style="position:fixed;left:5px;bottom:2em;display:block;background-color:pink;border:solid;padding:3px">Getting original link<br>Please wait...</div>'),log("Begin get source 1: "+r),$.get(r,(function(e){var t=e.match(/<a\s+class=.+?entry-type.+?href='([^']+)/i)[1];log("Begin get source 2: "+(t=t.replace("/albums/","/sets/"))),$.get(t,(function(e){log("Got final source: "+t),console.timeEnd("GetSource"),$("#loadingIndicator").remove(),getLinkFromSource(n=e)}))}))}};a(e),(globalObserver=new MutationObserver((function(t,i){a(e)}))).observe(t,{childList:!0,subtree:!0})}function flickr_mouseenter(){var e=$(this);if(e.find(".myFuckingLink").filter(":first").length>0)return e.off("mouseenter"),!1;var t=e.find("a").filter(":first").attr("href");if(null==t)return!1;e.append('<a class="myFuckingLink">(Link loading...)</a>'),$.get(t,(function(t){var i=t.match(/"displayUrl":"([^"]+)","width":(\d+),"height":(\d+)[^}]+}}/i),o=i[1].replace(/\\/g,"").replace(/(_[0-9a-z]+)\.([a-z]{3,4})/i,"$1"+postfix+"$2"),n=prefix+i[2]+" x "+i[3]+" Upload: ",a=e.find(".myFuckingLink");a.attr("href",o),a.attr("title",n),a.html(n)}))}function action_hover_page(){var e=$("body")[0],t=0;(globalObserver=new MutationObserver((function(e,i){var o=$("div.photo-list-photo-view");if(o.length==t)return!1;log("Number of thumb: "+o.length),t=o.length,checkAlwaysShow(),o.mouseenter(flickr_mouseenter)}))).observe(e,{childList:!0,subtree:!0})}function pageType(){var e="none",t=$("html").attr("class");return console.log("HTML class: "+t),null!==t.match(/html-photo-page.+scrappy-view/i)?e="single":null!==t.match(/html-(search-photos-unified|group-pool)-page-view/i)?e="hover":$("div.photo-list-photo-view").filter(":first").length>0?e="normal":$("div.photo-list-view").filter(":first").length>0&&(e="album"),console.log("Page type: "+e),e}log("Begin flickr script");var prevType="none",type="none",oldUrl="none",count=0;function kickStart(){oldUrl=document.URL,type=pageType(),getSetting(),checkAlwaysShow();var e=".myFuckingLink{position:absolute;z-index:999999;left:3px;bottom:0px;width:100%;display:block;color:white!important;} .myFuckingLink:hover{background-color:rgba(100, 100, 255,0.65)!important} .commonButton{display: inline-block;border-radius: 0.5em;margin: 0.2em;padding: 0.5em;font-size: 90%;height: fit-content;} .bigButton{background-color: lightgreen} .smallButton{background-color:pink}";"album"==type&&(e=".myFuckingLink{position:absolute;z-index:999999;left:5px;bottom:0px;width:100%;display:block;} .myFuckingLink:hover{background-color:rgba(100, 100, 255,0.65)!important} .commonButton{display: inline-block;border-radius: 0.5em;margin: 0.2em;padding: 0.5em;font-size: 90%;height: fit-content;} .bigButton{background-color: lightgreen} .smallButton{background-color:pink}"),GM_addStyle(e),$(".myOptionBox").remove(),$("ul.nav-menu:first").append('<li class="myOptionBox"><div style="color:pink;padding:1px"><input id="optionbox_openLink" type="checkbox"'+isChecked_openLink+'style="margin:2px"/>Open image link in browser<br><input id="optionbox_alwaysShow" type="checkbox"'+isChecked_alwaysShow+'style="margin:2px"/>Always show image information in Photostream</div></li>'),$("#optionbox_openLink").change((function(){GM_setValue(key_openLink,$(this).prop("checked"))})),$("#optionbox_alwaysShow").change((function(){GM_setValue(key_alwaysShow,$(this).prop("checked"))})),"single"==type?action_single_page():"normal"==type||"album"==type?action_normal_page(type):"hover"==type&&action_hover_page()}log("Kickstart");var timestamp="1469473824",number=new Number(timestamp),t=new Date(1e3*number);log("Time number: "+t.toLocaleDateString("vi-VN")),kickStart();var target=$("html")[0],config={childList:!1,attributes:!0},observer=new MutationObserver((function(e,t){oldUrl!=document.URL&&(null!==globalObserver&&globalObserver.disconnect(),kickStart())}));observer.observe(target,config);