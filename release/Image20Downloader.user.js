// ==UserScript==
// @name         Image Downloader
// @name:zh-CN   图片下载器
// @name:zh-TW   图片下载器
// @name:ja   画像ダウンローダー
// @name:ko   이미지 다운로더
// @name:de   Image Downloader
// @name:es   Image Downloader
// @name:eo   Image Downloader
// @name:fr   Image Downloader
// @name:it   Image Downloader
// @name:ru   Image Downloader
// @name:vi   Image Downloader
// @name:pt-BR   Image Downloader
// @name:id   Image Downloader
// @name:ar   Image Downloader
// @name:bg   Image Downloader
// @name:cs   Image Downloader
// @name:tr   Image Downloader
// @name:el   Image Downloader
// @name:hu   Image Downloader
// @name:th   Image Downloader
// @namespace       http://tampermonkey.net/
// @description     Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:zh-CN   可以在绝大多数网站提取并批量下载图片。抓取能力大提升！现在可以抓取，H5游戏素材（4399），图库网站（千库网、包图网），漫画网站（腾讯漫画、b站漫画），文库网站（道客巴巴、豆丁），以及其他右键失效或者图片不能另存的网站，用脚本均可以提取并下载。额外功能：zip下载/自动大图。详细见脚本描述(目前适合chrome/firefox+tampermonkey，其他组合多少有问题）
// @description:zh-TW   可以在绝大多数网站提取并批量下载图片。抓取能力大提升！现在可以抓取，H5游戏素材（4399），图库网站（千库网、包图网），漫画网站（腾讯漫画、b站漫画），文库网站（道客巴巴、豆丁），以及其他右键失效或者图片不能另存的网站，用脚本均可以提取并下载。额外功能：zip下载/自动大图。详细见脚本描述(目前适合chrome/firefox+tampermonkey，其他组合多少有问题）
// @description:ja      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:ko      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:de      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:es      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:eo      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:fr      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:it      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:ru      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:vi      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:pt-BR   Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:id      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:ar      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:bg      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:cs      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:tr      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:el      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:hu      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @description:th      Images can be extracted and batch downloaded from most websites. Especially for websites the right click fails or image can not save. Extra features: zip download / auto-enlarge image. See the script description at info page (suitable for chrome/firefox+tampermonkey)
// @version         2.90
// @author          桃源隐叟-The hide oldman in taoyuan mountain
// @connect  *
// @connect  *://*/*
// @grant   GM_openInTab
// @grant   GM_registerMenuCommand
// @grant   GM_setValue
// @grant   GM_getValue
// @grant   GM_deleteValue
// @grant   GM_xmlhttpRequest
// @grant   GM_download
// @require https://unpkg.com/hotkeys-js@3.9.4/dist/hotkeys.min.js
// @require https://cdn.bootcdn.net/ajax/libs/jszip/3.7.1/jszip.min.js
// @require https://cdn.bootcdn.net/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js
// @run-at  document-end
// @match   *://*/*
// @include *
// @match   https://www.bilibili.com/
// @match   https://588ku.com/
// @homepageURL https://github.com/taoyuancun123/modifyText/blob/master/modifyText.js
// @supportURL  https://greasyfork.org/zh-CN/scripts/419894/feedback
// @run-at      document-start
// @license GPLv3
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Image20Downloader.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Image20Downloader.meta.js
// ==/UserScript==
(function(){"use strict";var lang="Netscape"==navigator.appName?navigator.language:navigator.userLanguage,langSet,localization={zh:{selectAll:"全选",downloadBtn:"下载",downloadMenuText:"打开脚本(Alt+w)",zipDownloadBtn:"zip下载",selectAlert:"请至少选中一张图片。",fetchTip:"准备抓取canvas图片",fetchCount1:"抓取canvas图片第",fetchCount2:"张",fetchDoneTip1:"已选(0/",fetchDoneTip1Type2:"已选(",fetchDoneTip2:")张图片",regRulePlace:"输入待替换正则",regReplacePlace:"输入替换它的字符串或者函数",zipOptionDesc:"勾选使用zip下载后，会请求跨域权限，否则zip下载基本下载不到图片。",zipCheckText:"使用zip下载",downloadUrlFile:"下载图片地址",moreSetting:"更多设置",autoBitImgModule:"自动大图设置模块",defaultSettingRule:"设置默认规则",exportCustomRule:"导出自定规则",importCustomRule:"导入自定规则",fold:"收起",inputFilenameTip:"输入文件名",extraGrab:"强力抓取"},en:{selectAll:"selectAll",downloadBtn:"download",downloadMenuText:"Open(Alt+w)",zipDownloadBtn:"zip Download",selectAlert:"Please at last select one image.",fetchTip:"Ready to fetch canvas image.",fetchCount1:"Fetch the",fetchCount2:" canvas image.",fetchDoneTip1:"(0/",fetchDoneTip1Type2:"(",fetchDoneTip2:") Images selected",regRulePlace:"enter reg express",regReplacePlace:"enter replace string or function",zipOptionDesc:"when zip option checked,will request cors right,otherwise zipDownload can not get pics",zipCheckText:"Use ZipDownload",downloadUrlFile:"Download Imgs Url",moreSetting:"More Setting",autoBitImgModule:"AutoBigImageModule",defaultSettingRule:"SetDefaultRule",exportCustomRule:"exportCustomRule",importCustomRule:"importCustomRule",fold:"fold",inputFilenameTip:"input filename",extraGrab:"Extra Grab"}};langSet=lang.toLowerCase().includes("zh-")?localization.zh:localization.en;const autoBigImage={bigImageArray:[],defaultRules:[{originReg:/(?<=(.+sinaimg\.(?:cn|com)\/))([\w\.]+)(?=(\/.+))/i,replacement:"large",tip:"for weib.com"},{originReg:/(?<=(.+alicdn\.(?:cn|com)\/.+\.(jpg|jpeg|gif|png|bmp|webp)))_.+/i,replacement:"",tip:"for alibaba web"},{originReg:/(.+alicdn\.(?:cn|com)\/.+)(\.\d+x\d+)(\.(jpg|jpeg|gif|png|bmp|webp)).*/i,replacement:(e,t,n,l)=>t+l,tip:"for 1688"},{originReg:/(?<=(.+360buyimg\.(?:cn|com)\/))(\w+\/)(?=(.+\.(jpg|jpeg|gif|png|bmp|webp)))/i,replacement:"n0/",tip:"for jd"},{originReg:/(?<=(.+hdslb\.(?:cn|com)\/.+\.(jpg|jpeg|gif|png|bmp|webp)))@.+/i,replacement:"",tip:"for bilibili"},{originReg:/th(\.wallhaven\.cc\/)(?!full).+\/(\w{2}\/)([\w\.]+)(\.jpg)/i,replacement:(e,t,n,l)=>"w"+t+"full/"+n+"wallhaven-"+l+".jpg",tip:"for wallhaven"},{originReg:/th(\.wallhaven\.cc\/)(?!full).+\/(\w{2}\/)([\w\.]+)(\.jpg)/i,replacement:(e,t,n,l)=>"w"+t+"full/"+n+"wallhaven-"+l+".png",tip:"for wallhaven"},{originReg:/(.*\.twimg\.\w+\/.+\&name=*)(.*)/i,replacement:(e,t,n,l)=>t+"orig",tip:"for twitter"},{originReg:/(shonenjump\.com\/.*\/)poster_thumb(\/.*)/,replacement:"$1poster$2",tip:"for www.shonenjump.com"},{originReg:/(qzone\.qq\.com.*!!\/.*)$/,replacement:"$1/0",tip:"for Qzone"},{originReg:/(.*wordpress\.com.*)(\?w=\d+)$/,replacement:"$1",tip:"for wordpress"}],defaultRulesChecked:[],userRules:[],userRulesChecked:[],replace(e){let t=this;t.bigImageArray=[];let n=Array.from(new Set(e)).filter((e=>e&&e));t.setRulesChecked(),n.forEach((function(e,n){if(e.includes("data:image/"))return void t.bigImageArray.push(e);t.defaultRules.forEach(((n,l)=>{if("checked"!==t.defaultRulesChecked[l])return void t.bigImageArray.push(e);let a=e.replace(n.originReg,n.replacement);a!==e?(t.bigImageArray.push(e),t.bigImageArray.push(a)):t.bigImageArray.push(e)})),t.userRules.forEach(((n,l)=>{if("checked"!==t.userRulesChecked[l])return void t.bigImageArray.push(e);let a=e.replace(n.originReg,n.replacement);a!==e?(t.bigImageArray.push(e),t.bigImageArray.push(a)):t.bigImageArray.push(e)}))}))},getBigImageArray(e){return this.replace(e),Array.from(new Set(this.bigImageArray))},showDefaultRules(){let e=this,t=document.body.querySelector(".tyc-set-domain-default");e.setRulesChecked(),this.defaultRules.forEach(((n,l)=>{let a=`<div class="tyc-set-replacerule">\n                            <input type="checkbox" name="active" class="tyc-default-active" ${e.defaultRulesChecked[l]}>\n                            <input type="text" name="regrule" placeholder="${langSet.regRulePlace}" class="tyc-search-title" value="${n.originReg}">\n                            <input type="text" name="replace" placeholder="${langSet.regReplacePlace}" class="tyc-search-url" value="${n.replacement}">\n                            <span class="tyc-default-tip">${n.tip}</span>\n                    </div>\n                `;t.insertAdjacentHTML("beforeend",a)}))},showRules(e,t,n,l){let a=this,i=document.body.querySelector("."+e);a.setRulesChecked(),a.setCustomRules(),a[t].forEach(((e,t)=>{let c=`<div class="tyc-set-replacerule">\n                            <input type="checkbox" name="active" class="${l}" ${a[n][t]}>\n                            <input type="text" name="regrule" placeholder="${langSet.regRulePlace}" class="tyc-search-title" value="${e.originReg}">\n                            <input type="text" name="replace" placeholder="${langSet.regReplacePlace}" class="tyc-search-url" value="${e.replacement}">\n                            <span class="tyc-default-tip">${e.tip}</span>\n                    </div>\n                `;i.insertAdjacentHTML("beforeend",c)}))},onclickShowDefaultBtn(){let e=document.body.querySelector(".tyc-set-domain-default");"none"===e.style.display||""===e.style.display?e.style.display="flex":e.style.display="none"},oncheckChange(){let e=document.body.querySelectorAll(".tyc-default-active");this.defaultRulesChecked=[],e.forEach(((e,t)=>{e.checked?this.defaultRulesChecked.push("checked"):this.defaultRulesChecked.push("")})),GM_setValue("defaultRulesChecked",this.defaultRulesChecked)},oncheckChangeCustom(){let e=document.body.querySelectorAll(".tyc-custom-active");this.userRulesChecked=[],e.forEach(((e,t)=>{e.checked?this.userRulesChecked.push("checked"):this.userRulesChecked.push("")})),GM_setValue("userRulesChecked",this.userRulesChecked)},setRulesChecked(){if(GM_getValue("defaultRulesChecked")){if(this.defaultRulesChecked=GM_getValue("defaultRulesChecked"),this.defaultRulesChecked.length<this.defaultRules.length){let e=this.defaultRules.length-this.defaultRulesChecked.length;for(let t=0;t<e;t++)this.defaultRulesChecked.push("checked")}}else this.defaultRules.forEach((e=>{this.defaultRulesChecked.push("checked")})),GM_setValue("defaultRulesChecked",this.defaultRulesChecked);GM_getValue("userRulesChecked")&&GM_getValue("userRulesChecked").length>0?this.userRulesChecked=GM_getValue("userRulesChecked"):(this.userRules.forEach((e=>{this.userRulesChecked.push("checked")})),GM_setValue("userRulesChecked",this.userRulesChecked))},getCustomRules(event){let that=autoBigImage,file=document.querySelector("#tycfileElem").files[0],fileReader=new FileReader;fileReader.onload=e=>{let result=e.target.result;that.userRules=eval(result),GM_deleteValue("userRulesChecked"),that.setRulesChecked(),GM_setValue("userRules",result),document.body.querySelector(".tyc-set-domain-custom").innerHTML="",that.showRules("tyc-set-domain-custom","userRules","userRulesChecked","tyc-custom-active")},fileReader.readAsText(file,"GB2312")},setCustomRules(){if(GM_getValue("userRules"))try{this.userRules=eval(GM_getValue("userRules"))}catch(e){GM_setValue("userRules","")}},exportCustomRules(){}};var preImgSrcs=[];let originalSrcDescriptor=Object.getOwnPropertyDescriptor(HTMLImageElement.prototype,"src");var domainName=document.domain.split("."),downloadFileName,shortCutString="alt+W";function extraGrab(){Object.defineProperty(HTMLImageElement.prototype,"src",{get:function(){return originalSrcDescriptor.get.call(this)},set:function(e){preImgSrcs.includes(e)||preImgSrcs.push(e),originalSrcDescriptor.set.call(this,e)}})}function shortcutFunction(){if(null!=document.querySelector(".tyc-image-container"))try{document.querySelector(".tyc-image-container").remove()}catch{}else wrapper()}function wrapper(){downloadFileName=domainName[domainName.length-2];var e=(new Date).getTime().toString();downloadFileName+=e.substring(7,e.length);try{document.querySelector(".tyc-image-container").remove()}catch{}var t=[],n=document.body.innerHTML,l=[],a=[],i=[],c=[],o=[],r=[];try{var s=new JSZip,u=s.folder("pics")}catch{}try{let v=document.getElementsByTagName("img"),S=document.getElementsByTagName("canvas");for(let C=0;C<v.length;C++)if(t.includes(v[C].src)||t.push(v[C].src),""!==v[C].srcset){let q=v[C].srcset.split(","),M=q[0].match(/\S+/gi)[0];for(let $=0;$<q.length-1;$++){if(parseInt(q[$].match(/\S+/gi)[1])>parseInt(q[$+1].match(/\S+/gi)[1])){M=q[$].match(/\S+/gi)[0];break}M=q[$+1].match(/\S+/gi)[0]}t.includes(M)||t.push(M)}for(let T=0;T<preImgSrcs.length;T++)t.includes(preImgSrcs[T])||t.push(preImgSrcs[T]);let k=n.match(/(?<=background-image:\s*url\()(\S+)(?=\))/g);try{for(let I=0;I<k.length;I++)k[I].includes("&quot;")?t.push(k[I].replace(/&quot;/g,"")):k[I].includes("'")&&t.push(k[I].replace(/'/g,""))}catch(z){console.log(z)}if(window.location.href.includes("hathitrust.org")){let A=document.querySelectorAll(".image img");if(A.length>0){let _=document.createElement("canvas");t=[];for(let B=0;B<A.length;B++)_.width=A[B].width,_.height=A[B].height,_.getContext("2d").drawImage(A[B],0,0),t.push(_.toDataURL("image/png"));document.querySelector(".select-all").style="position:relative;width:15px;height:15px;"}}if(window.location.href.toString().includes("manga.bilibili.com/")){let G='<iframe style="display:none;" id="tyc-insert-iframe"></iframe>';null==document.getElementById("tyc-insert-iframe")&&(document.body.insertAdjacentHTML("afterbegin",G),document.getElementById("tyc-insert-iframe").contentDocument.body.insertAdjacentHTML("afterbegin",'<canvas id="tyc-insert-canvas"></canvas>'),document.body.getElementsByTagName("canvas")[0].__proto__.toBlob=document.getElementById("tyc-insert-iframe").contentDocument.getElementById("tyc-insert-canvas").__proto__.toBlob)}let R=t.length;if(S.length>0){langSet.fetchTip;var d=0;for(let V=0;V<S.length;V++){function N(e){let n=new FileReader;n.onloadend=function(e){let n=e.target.result;n.includes("data:image")&&(t.includes(n)||(t[R+V]=n),d++,document.querySelector(".num-tip").innerText=`${langSet.fetchCount1} ${d}/${S.length} ${langSet.fetchCount2}`,d===S.length&&(h(),p()))},n.readAsDataURL(e)}S[V].toBlob(N)}}else`${langSet.fetchDoneTip1}${t.length}${langSet.fetchDoneTip2}`}catch(D){console.log(D)}let g=`<style>\n        .tyc-image-container{\n            color:black;\n            position:fixed;\n            top:0px;\n            left:10%;\n            width:80vw;\n            z-index:2147483645;\n            background-color: #dedede;\n            border: 1px solid #aaa;\n            overflow:scroll;height:100%;\n        }\n\n        .tyc-image-container button{\n            border:1px solid #aaa;\n            border-radius:5px;\n            height:32px;line-height:32px;\n            margin:0px;padding:0 5px;\n        }\n\n        .tyc-image-container button:hover{\n            background-color: #f50;\n            color: #fff;\n        }\n\n        .control-section{\n            width:80vw;\n            z-index:2147483646;\n            position:fixed;\n            top:0px;\n            left:10%;\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            line-height:40px;\n            background:#eee;border:1px solid #aaa;border-radius:2px;\n        }\n\n        .control-section-sub{\n            display: flex;\n            margin-bottom: 5px;\n        }\n\n        .tyc-normal-section{\n            display: flex;\n            align-items: center;\n            flex-direction: row;\n            flex-wrap: wrap;\n            align-content: normal;\n            justify-content: flex-start;\n            font-size:10px;\n        }\n\n        .tyc-normal-section *{\n            padding-top:2px;\n        }\n\n        .btn-download{\n            border:1px solid #aaa;border-radius:5px;\n            height:32px;line-height:32px;\n            margin:0px;padding:0 5px;\n        }\n        .btn-zipDownload{\n            border:1px solid #aaa;border-radius:5px;\n            height:32px;line-height:32px;\n            margin:0px;padding:0 5px;\n        }\n        .btn-close{\n            font-size:20px;position:absolute;\n            right:30px;top:4px;\n            height:32px;line-height:32px;\n            margin:0px;\n            border-radius:10px;border:1px solid #aaa;\n            width:30px;\n        }\n\n        .tyc-image-wrapper{\n            margin-top:82px;display:flex;justify-content:center;\n            align-items:center;flex-wrap:wrap;\n        }\n\n        .tyc-input-checkbox{\n            background-color: initial;\n            cursor: default;\n            appearance: auto;\n            box-sizing: border-box;\n            margin: 3px 3px 3px 4px;\n            padding: initial;\n            border: initial;\n        }\n\n        .tyc-extend-set{\n            padding: 10px;\n            border-top: 1px solid rgba(100,100,100,0.1);\n        }\n\n        .tyc-extend-set{\n            display: none;\n            align-items: stretch;\n            flex-direction: column;\n            justify-content: flex-start;\n            flex-wrap: nowrap;\n            padding: 5px;\n            width: auto;\n        }\n\n        .tyc-extend-set-container{\n            display: flex;\n            align-items: flex-start;\n            flex-direction: column;\n            justify-content: flex-start;\n            flex-wrap: nowrap;\n            align-content: normal;\n            border: 1px solid rgba(100,100,100,0.5);\n            padding: 5px;\n            margin-bottom: 5px;\n        }\n\n        .tyc-autobigimg-set{\n            display: flex;\n            align-items: flex-start;\n            flex-direction: column;\n            justify-content: flex-start;\n            flex-wrap: nowrap;\n            align-content: normal;\n            border: 1px solid rgba(100,100,100,0.5);\n            padding: 5px;\n        }\n\n        .tyc-set-domain{\n            display: flex;\n            align-items: flex-start;\n            flex-direction: column;\n            justify-content: flex-start;\n            flex-wrap: nowrap;\n            align-content: normal;\n            margin: 5px;\n            padding: 5px;\n            border: 1px solid rgba(100,100,100,0.3);\n            width: 95%;\n            max-height: 150px;\n            overflow: scroll;\n        }\n\n        .tyc-abi-title{\n            display: flex;\n            flex-direction: row;\n            align-items: center;\n            justify-content: space-around;\n            width: 100%;\n        }\n\n        .tyc-abi-domain-title{\n            display: flex;\n            flex-direction: row;\n            align-items: center;\n            justify-content: space-between;\n            width: 95%;\n            border-bottom: 1px solid #ddd;\n        }\n        .tyc-set-replacerule{\n            display: flex;\n            flex-direction: row;\n            justify-content: flex-start;\n            align-items: center;\n            margin-bottom: 3px;\n            flex-wrap: wrap;\n        }\n\n        .tyc-set-replacerule *,.tyc-set-replacerule button{\n            margin-left: 5px;\n        }\n\n        .tyc-set-domain-default{\n            height: 200px;\n            overflow: scroll;\n            display: none;\n        }\n    </style>\n    <div class="tyc-image-container">\n        <div class="control-section">\n            <div class="control-section-sub tyc-normal-section">\n                <input class="select-all tyc-input-checkbox" type="checkbox" name="select-all" value="select-all">${langSet.selectAll}\n                <button class="btn-download" style="margin-left:5px;">${langSet.downloadBtn}</button>\n                <button class="btn-zipDownload" style="margin-left:5px;">${langSet.zipDownloadBtn}</button>\n                <span style="margin-left:10px;" class="num-tip">${langSet.fetchDoneTip1}${t.length}${langSet.fetchDoneTip2}</span>\n                <input type="text" class="tyc-file-name" style="height:15px;width:80px;margin-left:25px;font-size:10px;" value="${downloadFileName}">\n                <input type="text" class="shortCutString" style="height:15px;width:80px;margin-left:25px;font-size:10px;" value="${shortCutString}">-ShortCut\n                <button cstyle="margin-left:10px;" class="btn-close" >X</button>\n            </div>\n\n\n            <div style="line-height:12px;" class="control-section-sub tyc-normal-section">\n                <div style="float:left;display:block;">\n                <input type="checkbox" class="width-check img-check tyc-input-checkbox" name="width-check" value="width-check">Width:\n                <input type="text" class="width-value-min" size="1" style="height:15px;width:50px;"\n                    min="0" max="9999" value="0">-\n                    <input type="text" class="width-value-max" size="1" style="height:15px;width:50px;"\n                    min="0" max="9999" value="3000">\n                </div>\n\n                <div style="float:left;margin-left:30px;display:block;">\n                    <input type="checkbox" class="height-check img-check tyc-input-checkbox" name="height-check" value="height-check">Height:\n                    <input type="text" class="height-value-min" size="1" style="height:15px;width:50px;"\n                        min="0" max="9999" value="0">-\n                        <input type="text" class="height-value-max" size="1" style="height:15px;width:50px;"\n                        min="0" max="9999" value="3000">\n                </div>\n\n                <div style="float:left;margin-left:30px;display:block;" class="tyc-extra-grab">\n                    <input type="checkbox" class="extra-grab-check img-check tyc-input-checkbox" name="extra-grab-check" value="extra-grab-check">\n                    <span>${langSet.extraGrab}</span>\n                </div>\n\n                <div style="float:left;margin-left:30px;display:block;" class="tyc-download-url">\n                    <button class="tyc-download-url-btn">${langSet.downloadUrlFile}</button>\n                </div>\n\n\n                <div style="float:left;margin-left:30px;display:block;" class="tyc-extend-btn">\n                    <span>${langSet.moreSetting} </span>\n                    <span style="top: 3px;position: relative;">\n                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-double-down" viewBox="0 0 16 16">\n                            <path fill-rule="evenodd" d="M1.646 6.646a.5.5 0 0 1 .708 0L8 12.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>\n                            <path fill-rule="evenodd" d="M1.646 2.646a.5.5 0 0 1 .708 0L8 8.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>\n                        </svg>\n                    </span>\n                </div>\n            </div>\n            <div class="tyc-extend-set control-section-sub">\n                <div class="tyc-autobigimg-set tyc-extend-set-container">\n                    <div class="tyc-abi-title">\n                        <div>\n                            ${langSet.autoBitImgModule}\n                        </div>\n                        <div>\n                            <button class="tyc-default-rule-show">${langSet.defaultSettingRule}</button>\n                        </div>\n\n                        <div>\n                        <button>${langSet.exportCustomRule}</button>\n                    </div>\n\n                        <div>\n                            <input type="file" id="tycfileElem" multiple accept="text/plain" style="display:none">\n                            <button id="tyc-file-select">${langSet.importCustomRule}</button>\n                        </div>\n\n                    </div>\n                    <div class="tyc-set-domain tyc-set-domain-custom">\n                    </div>\n                    <div class="tyc-set-domain tyc-set-domain-default">\n                    </div>\n                </div>\n\n            </div>\n        </div>\n        <div class="tyc-image-wrapper" >\n        </div>\n    </div>`;function p(){o=t,o=autoBigImage.getBigImageArray(o),function(){null!=GM_getValue("width-check")&&(document.querySelector(".width-check").checked=GM_getValue("width-check"));null!=GM_getValue("height-check")&&(document.querySelector(".height-check").checked=GM_getValue("height-check"));null!=GM_getValue("extra-grab-check")&&(document.querySelector(".extra-grab-check").checked=GM_getValue("extra-grab-check"));GM_getValue("width-value-min")&&(document.querySelector(".width-value-min").value=GM_getValue("width-value-min")),GM_getValue("width-value-max")&&(document.querySelector(".width-value-max").value=GM_getValue("width-value-max")),GM_getValue("height-value-min")&&(document.querySelector(".height-value-min").value=GM_getValue("height-value-min")),GM_getValue("height-value-max")&&(document.querySelector(".height-value-max").value=GM_getValue("height-value-max")),GM_getValue("shortCutString")&&(document.querySelector(".shortCutString").value=GM_getValue("shortCutString"))}(),document.querySelector(".width-check").checked&&(o=o.filter(x)),document.querySelector(".height-check").checked&&(o=o.filter(w)),(r=o).forEach(((e,t)=>{if(!e.includes("data:image"))try{let n=window.location.origin+"/";GM_xmlhttpRequest({method:"get",url:e,headers:{referer:n},responseType:"blob",onload:function(e){var n=e.response;let l=new FileReader;l.onloadend=function(e){let n=e.target.result;n.startsWith("data:image")&&(r[t]=n)},l.readAsDataURL(n)}})}catch(e){}})),o.forEach(((e,t)=>{window.location.href.includes("huaban.com")&&e.includes("/webp")&&(e=e.replace(/\/webp/g,"/png"));let n=`<div class="tyc-img-item-container-${t}" style="text-align:center;font-size:0px;\n    margin:5px;border:1px solid #99d;border-radius:3px;\n    ">\n    <img class="tyc-image-preview" src="${e}"/ style="width:auto;height:200px;" data-value="${t}"></div>`;document.querySelector(".tyc-image-wrapper").insertAdjacentHTML("beforeend",n);let l=document.querySelector(`.tyc-img-item-container-${t} .tyc-image-preview`).naturalWidth,a=document.querySelector(`.tyc-img-item-container-${t} .tyc-image-preview`).naturalHeight,i='\n            <div class="tyc-image-info-container" style="font-size:0px;background-color:rgba(100,100,100,0.6);height:30px;position:relative;">\n\n\n    </div>\n            ',c=document.querySelector(`.tyc-img-item-container-${t}`),o=(c.getBoundingClientRect().width,`\n            <span style="font-size:16px;position:absolute;left:calc(50% - 80px);top:7px;">${l}X${a}</span>\n            `),r=`\n    <span style="position:absolute;right:calc(50% - 30px);top:2px;border:1px solid #333;\n    width:26px;height:26px;border-radius:20px;" class="fullscreen-image" data-value="${t}">\n    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrows-fullscreen" viewBox="0 0 16 16"  style="position:absolute;top:4px;right:4px;width:18px;height:18px;" data-value="${t}">\n        <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344 0a.5.5 0 0 1 .707 0l4.096 4.096V11.5a.5.5 0 1 1 1 0v3.975a.5.5 0 0 1-.5.5H11.5a.5.5 0 0 1 0-1h2.768l-4.096-4.096a.5.5 0 0 1 0-.707zm0-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707zm-4.344 0a.5.5 0 0 1-.707 0L1.025 1.732V4.5a.5.5 0 0 1-1 0V.525a.5.5 0 0 1 .5-.5H4.5a.5.5 0 0 1 0 1H1.732l4.096 4.096a.5.5 0 0 1 0 .707z"/>\n    </svg>\n    </span>\n    <span style="position:absolute;right:calc(50% - 60px);top:2px;border:1px solid #333;\n    width:26px;height:26px;border-radius:20px;\n    " class="download-direct">\n    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16" style="position:absolute;top:5px;right:5px;">\n      <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>\n      <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>\n    </svg>\n    </span>\n\n    `,s='\n            <span style="position:absolute;right:calc(50% - 15px);top:2px;border:1px solid #333;\n    width:26px;height:26px;border-radius:20px;\n    " class="download-direct">\n    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-download" viewBox="0 0 16 16" style="position:absolute;top:5px;right:5px;">\n      <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>\n      <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>\n    </svg>\n    </span>\n            ';c.insertAdjacentHTML("beforeend",i);let u=c.querySelector("div"),d=parseInt(c.getBoundingClientRect().width);d>120?(u.insertAdjacentHTML("beforeend",o),u.insertAdjacentHTML("beforeend",r)):d<=120&&d>=50?(u.insertAdjacentHTML("beforeend",r),u.getElementsByClassName("fullscreen-image")[0].style.right="50%",u.getElementsByClassName("download-direct")[0].style.right="calc(50% - 30px)"):u.insertAdjacentHTML("beforeend",s)}))}function h(){i=[],l=[],document.querySelector(".num-tip").innerText=`${langSet.fetchDoneTip1Type2}${l.length}/${t.length}${langSet.fetchDoneTip2}`,document.querySelector(".tyc-image-wrapper").innerHTML=""}function m(e){return"download-direct"==e.className}function y(e){return"fullscreen-image"==e.className}function f(e,t){let n=[];return t.forEach(((t,l)=>{n.push(e[t])})),n}function x(e){let t=new Image;if(t.src=e,t.width>=parseInt(document.querySelector(".width-value-min").value)&&t.width<=parseInt(document.querySelector(".width-value-max").value))return e}function w(e){let t=new Image;if(t.src=e,t.height>=parseInt(document.querySelector(".height-value-min").value)&&t.height<=parseInt(document.querySelector(".height-value-max").value))return e}function b(e){let t=[];return e.forEach(((e,n)=>{e.startsWith("data:image")&&e.includes("base64")&&t.push(e)})),t}document.body.insertAdjacentHTML("afterbegin",g),autoBigImage.showDefaultRules(),autoBigImage.showRules("tyc-set-domain-custom","userRules","userRulesChecked","tyc-custom-active"),document.querySelector(".tyc-image-wrapper").style=`margin-top:${document.querySelector(".control-section").clientHeight}px`,document.body.onclick=e=>{let n=e.path||e.composedPath&&e.composedPath();if("IMG"==e.target.nodeName&&"tyc-image-preview"===e.target.className){let e=n.find((e=>"tyc-image-preview"===e.classList[0])),s=parseInt(e.dataset.value),u=n.find((e=>e.className===`tyc-img-item-container-${s}`)),d=u.getElementsByClassName("tyc-image-info-container")[0];l.includes(s)?(l.splice(l.indexOf(s),1),u.style.border="1px solid #99d",d.style.backgroundColor="rgba(100,100,100,0.6)"):(l.push(s),u.style.border="1px solid #f50",d.style.backgroundColor="rgba(88, 158, 255, 0.8)"),a=l,document.querySelector(".num-tip").innerText=`${langSet.fetchDoneTip1Type2}${l.length}/${t.length}${langSet.fetchDoneTip2}`,i=f(o,l),c=b(c=f(r,a))}else if("show-big-image"===e.target.parentElement.className)try{document.querySelector(".show-big-image").remove()}catch{}else if("bi-download"==e.target.classList[1]||null!=n.find(m)){let e,t=n.find((e=>{try{return e.className.includes("tyc-img-item-container")}catch{}})).getElementsByTagName("img")[0].src;e=t.indexOf("/")>0?t.substring(t.lastIndexOf("/")+1,t.lastIndexOf(".")):t;let l=document.querySelector(".tyc-file-name").value||"pic";saveAs(t,l)}else if("bi-arrows-fullscreen"==e.target.classList[1]||null!=n.find(y)){let e=n.find((e=>{try{return e.className.includes("tyc-img-item-container")}catch{}})).getElementsByTagName("img")[0].src;try{let t=document.querySelector(".show-big-image");if(t.getElementsByTagName("img")[0].src===e)return void t.remove();t.remove()}catch{}document.body.insertAdjacentHTML("beforeend",'\n        <div class="show-big-image" style="position:fixed;left:30%;top:30%;z-index:2147483647;">\n        </div>\n    ');let t=`<img src="${e}"/>`;document.querySelector(".show-big-image").insertAdjacentHTML("beforeend",t);let l=document.querySelector(".show-big-image img"),a=(window.innerWidth-l.width)/2,i=(window.innerHeight-l.height)/2;document.querySelector(".show-big-image").style.left=a+"px",document.querySelector(".show-big-image").style.top=i+"px",(l.width>window.innerWidth||l.height>window.innerHeight)&&(document.querySelector(".show-big-image").style.overflow="scroll",l.width>window.innerWidth&&(document.querySelector(".show-big-image").style.left="0px",document.querySelector(".show-big-image").style.width=window.innerWidth+"px"),l.height>window.innerHeight&&(document.querySelector(".show-big-image").style.top="0px",document.querySelector(".show-big-image").style.height=window.innerHeight+"px"))}},document.querySelector(".btn-close").onclick=e=>{document.querySelector(".tyc-image-container").remove()},document.querySelector(".btn-download").onclick=async e=>{if(i.length>=1){for(let e=0;e<i.length;e++){await new Promise(((e,t)=>{setTimeout((()=>{e(1)}),200)}));let t=document.querySelector(".tyc-file-name").value||"pic";console.log(`${t}-${e}`),saveAs(i[e],`${t}-${e}`)}}else alert(`${langSet.selectAlert}`)},document.querySelector(".btn-zipDownload").onclick=e=>{try{c.length>=1?(c.forEach((async(e,t)=>{let n=e.substring(e.indexOf("image/")+6,e.indexOf(";"));n=n.includes("svg")?"svg":n;let l=`${document.querySelector(".tyc-file-name").value||"pic"}-${t}.${n}`;u.file(l,e.split(",")[1],{base64:!0})})),s.generateAsync({type:"blob"}).then((function(e){let t=document.querySelector(".tyc-file-name").value||"pic";saveAs(e,`${t}.zip`),s.remove("pics"),u=s.folder("pics")}))):alert(`${langSet.selectAlert}`)}catch(e){}},document.body.onchange=e=>{e.target.className.includes("width-check")&&GM_setValue("width-check",e.target.checked),e.target.className.includes("height-check")&&GM_setValue("height-check",e.target.checked),e.target.className.includes("extra-grab-check")&&(GM_setValue("extra-grab-check",e.target.checked),document.querySelector(".extra-grab-check").checked),e.target.className.includes("tyc-default-active")&&autoBigImage.oncheckChange(),e.target.className.includes("tyc-custom-active")&&autoBigImage.oncheckChangeCustom(),"INPUT"===e.target.nodeName&&"text"===e.target.type&&e.target.className.includes("value")&&GM_setValue(e.target.className,e.target.value),"INPUT"===e.target.nodeName&&"text"===e.target.type&&e.target.className.includes("shortCutString")&&(GM_setValue(e.target.className,e.target.value),hotkeys(e.target.value,wrapper)),(e.target.className.includes("width-check")||e.target.className.includes("height-check")||"INPUT"===e.target.nodeName&&"text"===e.target.type&&e.target.className.includes("value"))&&(h(),p())},document.querySelector(".select-all").onchange=e=>{document.querySelector(".select-all").checked?(i=o,c=b(r)):(i=f(o,l),c=f(r,a)),document.querySelector(".num-tip").innerText=`${langSet.fetchDoneTip1Type2}${i.length}/${o.length}${langSet.fetchDoneTip2}`},document.querySelector(".tyc-extend-btn").onclick=e=>{document.querySelector(".tyc-extend-btn").classList.contains("extend-open")?(document.querySelector(".tyc-extend-btn").classList.remove("extend-open"),document.querySelector(".tyc-extend-set").style.display="none",document.querySelector(".tyc-extend-btn").style.color="black",document.querySelector(".tyc-extend-btn").innerHTML=`<span>${langSet.moreSetting}</span>\n                <span style="top: 3px;position: relative;">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-double-down" viewBox="0 0 16 16">\n                        <path fill-rule="evenodd" d="M1.646 6.646a.5.5 0 0 1 .708 0L8 12.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>\n                        <path fill-rule="evenodd" d="M1.646 2.646a.5.5 0 0 1 .708 0L8 8.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>\n                    </svg>\n                </span> `):(document.querySelector(".tyc-extend-btn").classList.add("extend-open"),document.querySelector(".tyc-extend-set").style.display="flex",document.querySelector(".tyc-extend-btn").style.color="#f50",document.querySelector(".tyc-extend-btn").innerHTML=`<span>${langSet.fold} </span>\n                <span style="top: 3px;position: relative;">\n                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-double-up" viewBox="0 0 16 16">\n                    <path fill-rule="evenodd" d="M7.646 2.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 3.707 2.354 9.354a.5.5 0 1 1-.708-.708l6-6z"/>\n                    <path fill-rule="evenodd" d="M7.646 6.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1-.708.708L8 7.707l-5.646 5.647a.5.5 0 0 1-.708-.708l6-6z"/>\n                    </svg>\n                </span> `)},document.querySelector(".tyc-default-rule-show").onclick=autoBigImage.onclickShowDefaultBtn,document.querySelector("#tyc-file-select").onclick=e=>{document.querySelector("#tycfileElem").click()},document.querySelector("#tycfileElem").onchange=autoBigImage.getCustomRules,document.querySelector(".tyc-download-url-btn").onclick=e=>{let t=new Blob([i.join("\n")],{type:"text/plain",endings:"native"});saveAs(t,"urls.txt")},p()}null!=GM_getValue("shortCutString")&&(shortCutString=GM_getValue("shortCutString")),GM_registerMenuCommand(langSet.downloadMenuText,wrapper),hotkeys(shortCutString,shortcutFunction),GM_getValue("extra-grab-check")&&extraGrab()})();