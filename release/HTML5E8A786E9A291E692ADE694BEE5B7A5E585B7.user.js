// ==UserScript==
// @name       HTML5视频播放工具
// @name:en	   HTML5 Video Playing Tools
// @name:it    Strumenti di riproduzione video HTML5
// @description 视频截图；切换画中画；缓存视频；万能网页全屏；添加快捷键：快进、快退、暂停/播放、音量、下一集、切换(网页)全屏、上下帧、播放速度。支持视频站点：油管、TED、优.土、QQ、B站、西瓜视频、爱奇艺、A站、PPTV、芒果TV、咪咕视频、新浪、微博、网易[娱乐、云课堂、新闻]、搜狐、风行、百度云视频等；直播：twitch、斗鱼、YY、虎牙、龙珠、战旗。可增加自定义站点
// @description:en Enable hotkeys for HTML5 playback: video screenshot; enable/disable picture-in-picture; copy cached video; send any video to full screen or browser window size; fast forward, rewind, pause/play, volume, skip to next video, skip to previous or next frame, set playback speed. Video sites supported: YouTube, TED, Youku, QQ.com, bilibili, ixigua, iQiyi, support mainstream video sites in mainland China; Live broadcasts: Twitch, Douyu.com, YY.com, Huya.com. Custom sites can be added
// @description:it Abilita tasti di scelta rapida per riproduzione HTML5: screenshot del video; abilita/disabilita picture-in-picture; copia il video nella cache; manda qualsiasi video a schermo intero o a dimensione finestra del browser; avanzamento veloce, riavvolgimento, pausa/riproduzione, imposta velocità di riproduzione. Siti video supportati: YouTube, TED, Supporto dei siti video mainstream nella Cina continentale. È possibile aggiungere siti personalizzati
// @homepage https://bbs.kafan.cn/thread-2093014-1-1.html
// @match    https://*.qq.com/*
// @exclude  https://user.qzone.qq.com/*
// @match    https://www.weiyun.com/video_*
// @match    https://v.youku.com/v_play/*
// @match    https://v.youku.com/v_show/id_*
// @match    https://vku.youku.com/live/*
// @match    https://video.tudou.com/v/*
// @match    https://www.iqiyi.com/*
// @match    https://live.bilibili.com/*
// @match    https://www.bilibili.com/*
// @match    https://www.ixigua.com/*
// @match    https://www.toutiao.com/video/*
// @match    https://www.acfun.cn/*
// @match    https://live.acfun.cn/live/*
// @match    http://v.pptv.com/show/*
// @match    https://v.pptv.com/show/*
// @match    https://www.miguvideo.com/*
// @match    https://tv.sohu.com/*
// @match    https://film.sohu.com/album/*
// @match    https://www.mgtv.com/*
// @version    1.9.9
// @match    https://pan.baidu.com/*
// @match    https://yun.baidu.com/*
// @match    https://*.163.com/*
// @match    https://*.icourse163.org/*
// @match    http://video.sina.*/*
// @match    https://video.sina.*/*
// @match    http://k.sina.*/*
// @match    https://k.sina.*/*
// @match    https://weibo.com/*
// @match    https://*.weibo.com/*
// @match    https://pan.baidu.com/*
// @match    https://yun.baidu.com/*
// @match    http://v.ifeng.com/*
// @match    https://v.ifeng.com/*
// @match    http://news.mtime.com/*
// @match    http://video.mtime.com/*
// @GM_info
// @match    https://www.youtube.com/*
// @match    https://www.ted.com/talks/*
// @match    https://www.twitch.tv/*

// @match    https://www.yy.com/*
// @match    https://www.huya.com/*
// @match    https://v.douyu.com/*
// @match    https://www.douyu.com/*
// @match    https://live.douyin.com/*
// @match    https://www.douyin.com/*

// @match    https://www.longzhu.com/*
// @match    https://www.zhanqi.tv/*
// @run-at     document-start
// @require    https://cdn.staticfile.org/vue/2.6.11/vue.min.js
// @require    https://cdn.staticfile.org/jquery/3.6.0/jquery.min.js
// @grant      GM_addStyle
// @include    */play*
// @include    *play/*
// @grant      window.onurlchange
// @grant      unsafeWindow
// @grant      GM_download
// @grant      GM_openInTab
// @grant      GM_notification
// @grant      GM_registerMenuCommand
// @grant      GM_setValue
// @grant      GM_getValue
// @namespace  https://greasyfork.org/users/7036
// @license    MIT
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/HTML5E8A786E9A291E692ADE694BEE5B7A5E585B7.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/HTML5E8A786E9A291E692ADE694BEE5B7A5E585B7.meta.js
// ==/UserScript==
"use strict";const curLang=navigator.language.slice(0,2),i18n={zh:{console:"%c脚本[%s] 反馈：%s\n%s",cacheStoringError:"直接媒体类型（如MP4格式）缓存无效果！",cacheStoringConfirm:"视频切片数据能否缓存？检测方法：刷新页面，已观看视频片段不产生网络流量则可缓存。如果能缓存视频切片，选择确认直接缓存全部视频时段；点取消则按默认缓冲区大小进行缓冲。",cantOpenPIP:"无法进入画中画模式!错误:\n",cantExitPIP:"无法退出画中画模式!错误：\n",rememberRateMenuOption:"记忆播放速度",speedRate:"播放速度 ",ready:"准备就绪！ 待命中.",mainPageOnly:"只处理主页面",download:"下载: ",videoLag:"视频卡顿",fullScreen:"全屏",helpMenuOption:"脚本功能快捷键表",helpBody:"双击：切换（网页）全屏         鼠标中键：快进5秒\n\nP：视频截图    i：切换画中画   M：(停止)缓存视频(hls.js)\n← →方向键：快退、快进5秒;   方向键 + shift: 20秒\n↑ ↓方向键：音量调节   ESC：退出（网页）全屏\n空格键：暂停/播放      N：播放下一集\n回车键：切换全屏;      回车键 + shift: 切换网页全屏\nC(抖音V)：加速0.1倍  X(抖音S)：减速0.1倍  Z(抖音A)：切换加速状态\nD：上一帧     F：下一帧(youtube.com用E键)"},en:{console:"%cScript[%s] Feedback：%s\n%s",cacheStoringError:"Trying to cache direct media types (such as MP4 format) has no effect!",cacheStoringConfirm:"Do you want all segments of the video to be cached? The detection method used is as follows: when the page is refreshed, the watched video clips will be cached so that no additional network traffic is generated. If you want all segments of the videos to be cached, select OK; or select Cancel to buffer a portion of the video based on the default buffer size (which is the default browser behavior).",cantOpenPIP:"Unable to access picture-in-picture mode! Error：\n",cantExitPIP:"Unable to exit picture-in-picture mode! Error：\n",rememberRateMenuOption:"Remember video playback speed",speedRate:"Speed rate ",ready:" ready！ Waiting for you commands.",mainPageOnly:"Process the main page only",download:"Download: ",videoLag:"Video lag",fullScreen:"Full screen",helpMenuOption:"Hotkeys list:",helpBody:"Double-click: activate full screen.\nMiddle mouse button: fast forward 5 seconds\n\nP key： Take a screenshot\nI key： Enter/Exit picture-in-picture mode\nM key： Enable/disable caching of video(hls.js)\n\nArrow keys ← and →： Fast forward or rewind by 5 seconds\nShift + Arrow keys ← and →： Fast forward or rewind 20 seconds\nArrow keys ↑ and ↓： Raise or lower the volume\n\nESC： Exit full screen (or exit video enlarged to window size)\nSpacebar： Stop/Play\nEnter： Enable/disable full screen video\nShift + Enter: Set/unset video enlarged to window size\n\nN key： Play the next video (if any)\nC key： Speed up video playback by 0.1\nX key: Slow down video playback by 0.1\nZ key, Set video playback speed: 1.0 ←→ X\nD key: Previous frame\nF key: Next frame (except on YouTube)\nE key: Next frame (YouTube only)"},it:{console:"%cScript[%s] Feedback：%s\n%s",cacheStoringError:"Cercare di memorizzazione nella cache tipi di media diretti (come ad esempio il formato MP4) non ha alcuna efficacia!",cacheStoringConfirm:"Vuoi che tutti i segmenti del video siano memorizzati nella cache? Il metodo di rilevamento utilizzato è il seguente: all'aggiornamento della pagina, i video clip guardati saranno memorizzati nella cache in modo da non generare ulteriore traffico di rete. Se vuoi che tutti i segmenti dei video siano memorizzati nella cache, seleziona OK; seleziona invece Annulla per bufferizzare una parte del video in base alla dimensione predefinita del buffer (come da comportamento predefinito del browser).",cantOpenPIP:"Impossibile accedere alla modalità picture-in-picture! Errore：\n",cantExitPIP:"Impossibile uscire dalla modalità picture-in-picture! Errore：\n",rememberRateMenuOption:"Memorizza la velocità di riproduzione dei video",speedRate:"Velocità di riproduzione ",ready:"Pronto！ In attesa dei comandi dell'utente.",mainPageOnly:"Elaborazione della sola pagina principale",download:"Scarica: ",videoLag:"Ritardo del video",fullScreen:"Schermo intero",helpMenuOption:"Elenco dei tasti di scelta rapida",helpBody:"Doppio clic: attiva lo schermo intero\nPulsante centrale del mouse: avanzamento rapido di 5 secondi\n\nTasto P: Esegui uno screenshot\nTasto I： Attiva modalità picture-in-picture\nTasto M： Attiva/disattiva memorizzazione del video nella cache(hls.js)\n\nTasti freccia ← e →： Avanza o riavvolgi di 5 secondi\nShift + Tasti freccia ← e →: Avanza o riavvolgi di 20 secondi\nTasti freccia ↑ e ↓： Alza o abbassa il volume\nESC： Esci da schermo intero\nBarra spaziatrice: Ferma/Riproduci\nInvio： Attiva/disattiva ingrandimento del video a schermo intero\nShift + Invio: Attiva/disattiva ingrandimento del video a dimensione della finestra\n\nTasto N： Riproduzione del video successivo (se presente)\nTasto C: Velocizza riproduzione video di 0,1\nTasto X: Rallenta riproduzione video di 0,1\nTasto Z, Impostare la velocità di riproduzione video: 1,0 ←→ X\nTasto D: Vai al frame precedente\nTasto F: Vai al frame successivo (escluso YouTube)\nTasto E: Vai al frame successivo (solo su YouTube)"}},MSG=i18n[curLang]||i18n.en,w=unsafeWindow||window,{host:host,pathname:path}=location,d=document,find=[].find;let $msg,v,_fp,_fs,by;const observeOpt={childList:!0,subtree:!0},noopFn=function(){},validEl=e=>e&&e.offsetWidth>1,q=(e,t=d)=>t.querySelector(e),r1=(e,t)=>e.test(t)&&RegExp.$1,log=console.log.bind(console,MSG.console,"color:#c3c;font-size:1.2em",GM_info.script.name,GM_info.script.homepage),gmFuncOfCheckMenu=(e,t,n=!0)=>{const i=GM_getValue(t,n);return i&&(e="√  "+e),GM_registerMenuCommand(e,(()=>{GM_setValue(t,!i),location.reload()})),i},sleep=e=>new Promise((t=>{setTimeout(t,e)})),hookAttachShadow=e=>{try{const t=Element.prototype.attachShadow;Element.prototype.attachShadow=function(n){n.mode="open";const i=t.call(this,n);return e(i),i}}catch(e){console.error("Hack attachShadow error",e)}},getStyle=(e,t)=>{if(e.style[t])return e.style[t];if(getComputedStyle){const n=getComputedStyle(e,"");return t=t.replace(/([A-Z])/g,"-$1").toLowerCase(),n&&n.getPropertyValue(t)}},doClick=e=>{"string"==typeof e&&(e=q(e)),e&&(e.click?e.click():e.dispatchEvent(new MouseEvent("click")))},clickDualButton=e=>{e.nextSibling&&"none"===getStyle(e,"display")?doClick(e.nextSibling):doClick(e)},polling=(e,t,n=!0)=>{const i="string"==typeof t?q.bind(null,t):t,a=setInterval((()=>{const t=i();t&&(n&&clearInterval(a),e(t))}),300);return a},goNextMV=()=>{const e=location.pathname,t=e.match(/(\d+)(\D*)$/),n=+t[1]+1;location.assign(e.slice(0,t.index)+n+t[2])},firefoxVer=r1(/Firefox\/(\d+)/,navigator.userAgent),isEdge=/ Edge?\//.test(navigator.userAgent),fakeUA=e=>Object.defineProperty(navigator,"userAgent",{value:e,writable:!1,configurable:!1,enumerable:!0}),getMainDomain=e=>{const t=e.split(".");let n=t.length-2;return/^(com?|cc|tv|net|org|gov|edu)$/.test(t[n])&&n--,t[n]},inRange=(e,t,n)=>Math.max(t,e)==Math.min(e,n),adjustRate=e=>{e+=v.playbackRate,v.playbackRate=e<.1?.1:e>16?16:+e.toFixed(2)},adjustVolume=e=>{e+=v.volume,inRange(e,0,1)&&(v.volume=+e.toFixed(2))},tip=e=>{if($msg?.get(0)?.offsetHeight||($msg=$('<div style="max-width:455px;min-width:333px;background:#EEE;color:#111;height:22px;top:-30px;left:50%;transform:translate(-50%, 0); border-radius:8px;border:1px solid orange;text-align:center;font-size:15px;position:fixed;z-index:2147483647"></div>').appendTo(by)),!e?.length)return;const t=15*e.length;$msg.stop(!0,!0).text(e).css({width:`${t}px`}).animate({top:"190px"}).animate({top:"+=9px"},1900).animate({top:"-30px"})},ua_chrome="Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/99.0.3626.121 Safari/537.36",u=getMainDomain(host),cfg={isLive:!1,disableDBLClick:!1,isClickOnVideo:!1,multipleV:!1,isNumURL:!1},bus=new Vue;void 0===window.onurlchange&&(history.pushState=(e=>function(){const t=e.apply(this,arguments);return window.dispatchEvent(new Event("pushstate")),window.dispatchEvent(new Event("urlchange")),t})(history.pushState),history.replaceState=(e=>function(){const t=e.apply(this,arguments);return window.dispatchEvent(new Event("replacestate")),window.dispatchEvent(new Event("urlchange")),t})(history.replaceState),window.addEventListener("popstate",(()=>{window.dispatchEvent(new Event("urlchange"))})));class FullScreen{constructor(e){let t=d.exitFullscreen||d.webkitExitFullscreen||d.mozCancelFullScreen||d.msExitFullscreen||noopFn;this.exit=t.bind(d),t=e.requestFullscreen||e.webkitRequestFullScreen||e.mozRequestFullScreen||e.msRequestFullScreen||noopFn,this.enter=t.bind(e)}static isFull(){return!!(d.fullscreen||d.webkitIsFullScreen||d.mozFullScreen||d.fullscreenElement||d.webkitFullscreenElement||d.mozFullScreenElement)}toggle(){FullScreen.isFull()?this.exit():this.enter()}}class FullPage{constructor(e){this._isFull=!1,this.container=e||FullPage.getPlayerContainer(v),GM_addStyle(".gm-fp-body .gm-fp-zTop {\n\t\t\t\tposition: relative !important;\n\t\t\t\tz-index: 2147483646 !important;\n\t\t\t}\n\t\t\t.gm-fp-wrapper, .gm-fp-body{ overflow:hidden !important; }\n\t\t\t.gm-fp-wrapper .gm-fp-innerBox {\n\t\t\t\twidth: 100% !important;\n\t\t\t\theight: 100% !important;\n\t\t\t}\n\t\t\t.gm-fp-wrapper {\n\t\t\t\tdisplay: block !important;\n\t\t\t\tposition: fixed !important;\n\t\t\t\twidth: 100% !important;\n\t\t\t\theight: 100% !important;\n\t\t\t\tpadding: 0 !important;\n\t\t\t\tmargin: 0 !important;\n\t\t\t\ttop: 0 !important;\n\t\t\t\tleft: 0 !important;\n\t\t\t\tbackground: #000 !important;\n\t\t\t\tz-index: 2147483646 !important;\n\t\t\t}")}static getPlayerContainer(e){let t=e,n=t.parentNode;const{clientWidth:i,clientHeight:a}=t;do{t=n,n=t.parentNode}while(n&&n!==by&&n.clientWidth-i<5&&n.clientHeight-a<5);return t}static isFull(e){return w.innerWidth-e.clientWidth<5&&w.innerHeight-e.clientHeight<5}toggle(){this.container.contains(v)||(this.container=FullPage.getPlayerContainer(v)),bus.$emit("switchFP",!this._isFull),by.classList.toggle("gm-fp-body");let e=v;for(;e!=this.container;)e.classList.toggle("gm-fp-innerBox"),e=e.parentNode;for(e.classList.toggle("gm-fp-wrapper"),e=e.parentNode;e!=by;)e.classList.toggle("gm-fp-zTop"),e=e.parentNode;this._isFull=!this._isFull}}const cacheMV={check(){const e=v.buffered,t=e.length-1;return this.iEnd=e.end(t),this.mode?this.iEnd>v.duration-55:e.start(0)>=this.playPos||this.iEnd>v.duration-55},finish(){v.removeEventListener("canplaythrough",this.onChache),v.currentTime=this.playPos,this.chached=!1,setTimeout((e=>v.pause()),99),HTMLMediaElement.prototype.play=this.rawPlay},onChache(){this.check()?this.finish():v.currentTime=this.iEnd},exec(){!cfg.isLive&&v&&(v.src.startsWith("http")?alert(MSG.cacheStoringError):(this.mode=confirm(MSG.cacheStoringConfirm),this.chached=!0,v.pause(),this.rawPlay=HTMLMediaElement.prototype.play,HTMLMediaElement.prototype.play=()=>new Promise(noopFn),this.playPos=v.currentTime,v.addEventListener("canplaythrough",this.onChache),this.check(),v.currentTime=this.iEnd))}};cacheMV.onChache=cacheMV.onChache.bind(cacheMV);const actList=new Map;actList.set(90,(e=>{1==v.playbackRate||0==v.playbackRate?v.playbackRate=+localStorage.mvPlayRate||1.3:v.playbackRate=1})).set(88,adjustRate.bind(null,-.1)).set(67,adjustRate.bind(null,.1)).set(40,adjustVolume.bind(null,-.1)).set(38,adjustVolume.bind(null,.1)).set(37,(e=>{v.currentTime-=5})).set(1061,(e=>{v.currentTime-=20})).set(39,(e=>{v.currentTime+=5})).set(1063,(e=>{v.currentTime+=20})).set(68,(e=>{v.currentTime-=.03,v.pause()})).set(70,(e=>{v.currentTime+=.03,v.pause()})).set(32,(e=>{cfg.btnPlay?clickDualButton(cfg.btnPlay):v.paused?v.play():v.pause()})).set(13,(e=>{_fs?_fs.toggle():clickDualButton(cfg.btnFS)})).set(1037,(e=>{self!=top?top.postMessage({id:"gm-h5-toggle-iframeWebFull"},"*"):_fp?_fp.toggle():clickDualButton(cfg.btnFP)})).set(1051,noopFn).set(27,(e=>{FullScreen.isFull()?_fs?_fs.exit():clickDualButton(cfg.btnFS):self!=top?top.postMessage({id:"gm-h5-is-iframeWebFull"},"*"):FullPage.isFull(v)&&(_fp?_fp.toggle():clickDualButton(cfg.btnFP))})).set(73,(e=>{d.pictureInPictureElement?d.exitPictureInPicture().catch((e=>{alert(MSG.cantExitPIP+e)})):v.requestPictureInPicture().catch((e=>{alert(MSG.cantOpenPIP+e)}))})).set(80,(e=>{const t=d.createElement("canvas");t.width=v.videoWidth,t.height=v.videoHeight,t.getContext("2d").drawImage(v,0,0,t.width,t.height),t.toBlob((e=>{const t=URL.createObjectURL(e);GM_download({url:t,name:Date.now().toString(36)+".png",onloadend:e=>{URL.revokeObjectURL(t)}})}))})).set(77,(e=>{cacheMV.chached?cacheMV.finish():cacheMV.exec()})).set(78,(e=>{self!=top?top.postMessage({id:"gm-h5-play-next"},"*"):cfg.btnNext?doClick(cfg.btnNext):cfg.isNumURL&&goNextMV()}));const app={rawProps:new Map,shellEvent(){const e=cfg.isClickOnVideo?v:cfg.mvShell;e.addEventListener("mousedown",(e=>{1==e.button&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),cfg.isLive||(actList.has(39)?actList.get(39)():v.currentTime+=5))})),!cfg.disableDBLClick&&e.addEventListener("dblclick",(e=>{e.target.closest("svg,img,button")||(e.stopPropagation(),e.stopImmediatePropagation(),this.checkUI(),actList.get(1037)())}))},setShell(){const e=this.getDPlayer()||this.getArtplayer()||this.getVjsPlayer()||cfg.shellCSS&&q(cfg.shellCSS)||(top!=self?by:FullPage.getPlayerContainer(v));e&&cfg.mvShell!==e&&(cfg.mvShell=e,this.shellEvent())},checkMV(){if(this.vList){const e=this.findMV();e&&e!=v&&(v=e,cfg.btnPlay=cfg.btnNext=cfg.btnFP=cfg.btnFS=_fs=_fp=null,!cfg.isLive&&GM_getValue("remberRate",!0)&&(v.playbackRate=+localStorage.mvPlayRate||1,v.addEventListener("ratechange",(e=>{v.playbackRate&&1!=v.playbackRate&&(localStorage.mvPlayRate=v.playbackRate)}))),this.setShell())}return validEl(cfg.mvShell)||(cfg.mvShell=null,this.setShell()),this.checkUI(),v},getArtplayer(){const e=v.parentNode;return!(!v.matches(".art-video")||!e.matches(".art-video-player"))&&(cfg.btnFP=q(".art-control-fullscreenWeb",e),cfg.btnFS=q(".art-control-fullscreen",e),e.closest("body > *")?.classList.add("gm-dp-zTop"),e)},getDPlayer(){if(!v.matches(".dplayer-video"))return!1;const e=v.closest(".dplayer");return e&&(cfg.btnFP=q(".dplayer-full-in-icon > span",e),cfg.btnFS=q(".dplayer-full-icon",e),e.closest("body > *").classList.add("gm-dp-zTop")),e},getVjsPlayer(){const e=v.closest(".video-js");return e&&(cfg.btnFS=q(".vjs-control-bar > button.vjs-button:nth-last-of-type(1)"),cfg.webfullCSS='.vjs-control-bar > button.vjs-button[title$="全屏"]:nth-last-of-type(2)'),e},hotKey(e){const t=e.target;if(e.ctrlKey||e.metaKey||e.altKey||"true"==t.contentEditable||/INPUT|TEXTAREA|SELECT/.test(t.nodeName))return;if(e.shiftKey&&![13,37,39].includes(e.keyCode))return;if(e.shiftKey&&27==e.keyCode)return;if(cfg.isLive&&[37,39,78,77,88,67,90].includes(e.keyCode))return;if(!this.checkMV())return;if(!e.shiftKey&&cfg.mvShell&&cfg.mvShell.contains(t)&&[32,37,39].includes(e.keyCode))return;const n=e.shiftKey?e.keyCode+1024:e.keyCode;actList.has(n)&&(e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),actList.get(n)(e),[67,88,90].includes(e.keyCode)&&tip(MSG.speedRate+v.playbackRate))},checkUI(){cfg.webfullCSS&&!validEl(cfg.btnFP)&&(cfg.btnFP=q(cfg.webfullCSS)),cfg.btnFP?_fp=null:_fp||self!=top||(_fp=new FullPage(cfg.mvShell)),cfg.fullCSS&&!validEl(cfg.btnFS)&&(cfg.btnFS=q(cfg.fullCSS)),cfg.btnFS?_fs=null:_fs||(_fs=new FullScreen(v)),!cfg.nextCSS||validEl(cfg.btnNext)&&cfg.btnNext.matches(cfg.nextCSS)||(cfg.btnNext=q(cfg.nextCSS)),cfg.playCSS&&!validEl(cfg.btnPlay)&&(cfg.btnPlay=q(cfg.playCSS))},onGrowVList(){if(this.vList.length!=this.vCount){if(this.viewObserver)for(let e of this.vList)this.vSet.has(e)||this.viewObserver.observe(e);else{const e={rootMargin:"0px",threshold:.9};this.viewObserver=new IntersectionObserver(this.onIntersection.bind(this),e);for(let e of this.vList)this.viewObserver.observe(e)}this.vSet=new Set(this.vList),this.vCount=this.vList.length}},onIntersection(e){if(this.vList.length<2)return;const t=find.call(e,(e=>e.isIntersecting));t&&v!=t.target&&(v=t.target,_fs=new FullScreen(v),_fp=new FullPage(v),bus.$on("switchFP",(async e=>{sleep(200),e||v.scrollIntoView()})),bus.$emit("switchMV"))},bindEvent(){clearInterval(this.timer);for(const[e,t]of this.rawProps)Reflect.defineProperty(HTMLVideoElement.prototype,e,t);this.rawProps.clear(),this.rawProps=null,$(cfg.adsCSS).remove(),by=d.body,log("bind event\n",v),bus.$emit("foundMV");const e=gmFuncOfCheckMenu(MSG.rememberRateMenuOption,"remberRate");window.addEventListener("urlchange",(async t=>{await sleep(1990),this.checkMV(),e&&(v.playbackRate=+localStorage.mvPlayRate||1),bus.$emit("urlchange")})),top!=self&&(top.postMessage({id:"gm-h5-init-MVframe"},"*"),window.addEventListener("message",(e=>{if(e.source&&e.data&&e.data.id&&"gm-h5-toggle-fullScreen"===e.data.id)_fs?_fs.toggle():clickDualButton(cfg.btnFS)}),!1)),$(v).one("canplaythrough",(t=>{cfg.isLive||(e&&(v.playbackRate=+localStorage.mvPlayRate||1),v.addEventListener("ratechange",(t=>{e&&v.playbackRate&&1!=v.playbackRate&&(localStorage.mvPlayRate=v.playbackRate)}))),this.checkMV(),bus.$emit("canplay")})),$(by).keydown(this.hotKey.bind(this)),cfg.mvShell?this.shellEvent():this.setShell(),this.checkUI(),cfg.multipleV&&(new MutationObserver(this.onGrowVList.bind(this)).observe(by,observeOpt),this.vCount=0,this.onGrowVList())},init(){const e=EventTarget.prototype.addEventListener;EventTarget.prototype.addEventListener=function(...t){if(!("dblclick"==t[0]&&!t[1].toString().includes("actList.get(1037)")||"ratechange"==t[0]&&"baidu"==u&&!t[1].toString().includes("localStorage.mvPlayRate")))return e.apply(this,t)};for(const e of this.rawProps.keys())this.rawProps.set(e,Reflect.getOwnPropertyDescriptor(HTMLMediaElement.prototype,e));this.vList=d.getElementsByTagName("video");const t=e=>cfg.cssMV?e.matches(cfg.cssMV):e.offsetWidth>9;this.findMV=find.bind(this.vList,t),this.timer=polling((e=>{v=e,this.bindEvent()}),this.findMV),hookAttachShadow((async e=>{bus.$emit("addShadowRoot",e),await sleep(600),v||(v=q("video",e))&&(log("Found MV in ShadowRoot\n",v,e),cfg.shellCSS||(cfg.mvShell=e.host),this.bindEvent(),this.vList=e.getElementsByTagName("video"),this.findMV=find.bind(this.vList,t))}))}};let router={ted(){cfg.fullCSS="button[title=Fullscreen]"},youtube(){GM_addStyle(".gm-fp-body #player-container-inner{padding-top:0!important}\n\t\t\t.gm-fp-body #player-container-outer{\n\t\t\t\tmax-width:100%!important;\n\t\t\t\tmargin:0!important;\n\t\t\t}"),cfg.shellCSS="#player",cfg.playCSS="button.ytp-play-button",cfg.nextCSS="a.ytp-next-button",cfg.fullCSS="button.ytp-fullscreen-button",cfg.isClickOnVideo=!0,actList.delete(32),actList.set(69,actList.get(70)).delete(70)},douyin(){cfg.isLive=host.startsWith("live."),cfg.fullCSS=".xgplayer-fullscreen",cfg.isLive||(GM_addStyle(".xgplayer-progress-cache{background-color:green!important}"),actList.set(65,actList.get(90)).delete(90),actList.set(83,actList.get(88)).delete(88),actList.set(86,actList.get(67)).delete(67))},qq(){if(self!=top&&("v.qq.com"==host||"video.qq.com"==host))throw MSG.mainPageOnly;actList.delete(32),cfg.shellCSS="#player",cfg.nextCSS=".txp_btn_next_u",cfg.webfullCSS=".txp_btn_fake",cfg.fullCSS=".txp_btn_fullscreen",app.rawProps.set("playbackRate",1)},youku(){actList.delete(37),actList.delete(39),host.startsWith("vku.")?(bus.$on("canplay",(()=>{cfg.isLive=!q(".spv_progress")})),cfg.fullCSS=".live_icon_full"):(bus.$on("foundMV",(()=>{$(document).unbind("keyup")})),cfg.shellCSS="#ykPlayer",cfg.webfullCSS=".kui-webfullscreen-icon-0",cfg.fullCSS=".kui-fullscreen-icon-0",cfg.nextCSS=".kui-next-icon-0")},bilibili(){cfg.isLive=host.startsWith("live."),cfg.isLive||(actList.delete(32),bus.$on("addShadowRoot",(e=>{"BWP-VIDEO"===e.host.nodeName&&(app.vList=d.getElementsByTagName("bwp-video"),app.findMV=find.bind(app.vList,(e=>e.offsetWidth>9)),v=e.host,app.bindEvent())})),cfg.shellCSS='div[aria-label="哔哩哔哩播放器"]',cfg.nextCSS=".bpx-player-ctrl-next",cfg.webfullCSS=".bpx-player-ctrl-web",cfg.fullCSS=".bpx-player-ctrl-full")},iqiyi(){cfg.fullCSS=".iqp-btn-fullscreen:not(.fake__click)",cfg.nextCSS=".iqp-btn-next"},pptv(){cfg.fullCSS=".w-zoom-container > div",cfg.webfullCSS=".w-expand-container > div",cfg.nextCSS=".w-next"},mgtv(){cfg.fullCSS="mango-screen",cfg.webfullCSS="mango-webscreen > a",cfg.nextCSS="mango-control-playnext-btn"},ixigua(){cfg.fullCSS='div[aria-label="全屏"]',cfg.nextCSS=".xgplayer-control-item.control_playnext",GM_addStyle(".gm-fp-body .xgplayer{padding-top:0!important} .gm-fp-wrapper #player_default{max-height: 100%!important} h1.title~a, .videoTitle h1~a{ padding-left:12px; color:blue; }"),bus.$on("foundMV",(()=>{const e=w._SSR_HYDRATED_DATA.anyVideo.gidInformation.packerData,t=(e.video||e).videoResource.normal.video_list,n=document.title.split(" - ")[0],i=Object.keys(t).map((e=>`<a href="${t[e].main_url}" download="${n}_${t[e].definition}.mp4" target="_blank">${t[e].definition}</a>`)).join("　　　");$(".videoTitle h1, h1.title").text(MSG.download).after(i)}))},miguvideo(){cfg.nextCSS=".next-btn",cfg.fullCSS=".zoom-btn",cfg.shellCSS=".mod-player"},baidu(){app.rawProps.set("playbackRate",1)},weibo(){cfg.multipleV=path.startsWith("/u/")},acfun(){cfg.nextCSS=".btn-next-part .control-btn",cfg.webfullCSS=".fullscreen-web",cfg.fullCSS=".fullscreen-screen"},163:()=>(cfg.multipleV=host.startsWith("news."),GM_addStyle("div.video,video{max-height: 100% !important;}"),host.split(".").length>3),sohu(){cfg.nextCSS="li.on[data-vid]+li a",cfg.fullCSS=".x-fullscreen-btn",cfg.webfullCSS=".x-pagefs-btn"},fun(){cfg.nextCSS=".btn-item.btn-next"},le(){GM_addStyle(".gm-fp-body .le_head{display:none!important}"),cfg.cssMV="#video video",cfg.shellCSS="#video",cfg.nextCSS=".hv_ico_next";const e=e=>{v.offsetWidth||Object.values(v.attributes).reverse().some((e=>{if(""==v.getAttribute(e.name))return v.removeAttribute(e.name),!0}))};bus.$on("urlchange",e),bus.$once("canplay",e)},agedm(){actList.set(78,(e=>{location.href=location.href.replace(/\d+$/,(e=>++e))}))},nnyy(){GM_registerMenuCommand(MSG.videoLag,(()=>{v.pause();const e=v.currentTime,t=v.buffered;v.currentTime=t.end(t.length-1)+1,$(v).one("progress",(t=>{v.currentTime=e,v.play()}))})),cfg.nextCSS=".playlist .on + li a"},douban(){cfg.nextCSS="a.next-series"},hanmidy(){cfg.nextCSS=`a[href="${path}"]+a`}};router[u]||(router={douyu(){cfg.adsCSS='a[href*="wan.douyu.com"]',cfg.isLive=!host.startsWith("v."),cfg.isLive?(cfg.cssMV=".layout-Player video",cfg.shellCSS="#js-player-video",cfg.webfullCSS=".wfs-2a8e83",cfg.fullCSS=".fs-781153",cfg.playCSS="div[class|=play]","/"!=path&&$((e=>{q(".u-specialStateInput").checked=!0}))):bus.$on("addShadowRoot",(async function(e){e.host.matches("#demandcontroller-bar")&&(await sleep(600),cfg.shellCSS="div[fullscreen].video",cfg.btnFP=q(".ControllerBar-PageFull",e),cfg.btnFS=q(".ControllerBar-WindowFull",e))}))},yy(){cfg.isLive=!path.startsWith("/x/"),cfg.isLive&&(cfg.fullCSS=".yc__fullscreen-btn",cfg.webfullCSS=".yc__cinema-mode-btn",cfg.playCSS=".yc__play-btn")},huya(){if(firefoxVer&&firefoxVer<57)return!0;cfg.disableDBLClick=!0,cfg.webfullCSS=".player-fullpage-btn",cfg.fullCSS=".player-fullscreen-btn",cfg.playCSS="#player-btn",cfg.adsCSS="#player-subscribe-wap,#wrap-income",polling(doClick,".login-tips-close"),localStorage["sidebar/ads"]="{}",localStorage["sidebar/state"]=0},twitch(){cfg.isLive=!path.startsWith("/videos/"),cfg.fullCSS="button[data-a-target=player-fullscreen-button]",cfg.webfullCSS=".player-controls__right-control-group > div:nth-child(4) > button",cfg.playCSS="button[data-a-target=player-play-pause-button]"},longzhu(){cfg.fullCSS="a.ya-screen-btn"},zhanqi(){localStorage.lastPlayer="h5",cfg.fullCSS=".video-fullscreen"}},router[u]&&(cfg.isLive=cfg.isLive||!host.startsWith("v."),(!w.chrome||isEdge)&&fakeUA(ua_chrome))),cfg.isLive=cfg.isLive||host.startsWith("live."),Reflect.defineProperty(navigator,"plugins",{get:()=>({length:0})}),GM_registerMenuCommand(MSG.helpMenuOption,alert.bind(w,MSG.helpBody)),router[u]&&router[u]()||app.init(),router[u]||cfg.isNumURL||(cfg.isNumURL=/[_\W]\d+(\/|\.[a-z]{3,8})?$/.test(path));