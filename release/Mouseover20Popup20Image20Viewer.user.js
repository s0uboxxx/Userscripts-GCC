// ==UserScript==
// @name        Mouseover Popup Image Viewer
// @namespace   https://github.com/tophf
// @description Shows images and videos behind links and thumbnails.
//
// @include     *
// @run-at      document-start
//
// @grant       GM_addElement
// @grant       GM_download
// @grant       GM_getValue
// @grant       GM_getValues
// @grant       GM_openInTab
// @grant       GM_registerMenuCommand
// @grant       GM_unregisterMenuCommand
// @grant       GM_setClipboard
// @grant       GM_setValue
// @grant       GM_xmlhttpRequest
//
// @grant       GM.getValue
// @grant       GM.openInTab
// @grant       GM.registerMenuCommand
// @grant       GM.unregisterMenuCommand
// @grant       GM.setClipboard
// @grant       GM.setValue
// @grant       GM.xmlHttpRequest
//
// @version     1.4.6
// @author      tophf
//
// @original-version 2017.9.29
// @original-author  kuehlschrank
//
// @connect     *
// CSP check:
// @connect     self
// rule installer in config dialog:
// @connect     github.com
// big/trusted hostings for the built-in rules with "q":
// @connect     deviantart.com
// @connect     facebook.com
// @connect     fbcdn.com
// @connect     flickr.com
// @connect     gfycat.com
// @connect     googleusercontent.com
// @connect     gyazo.com
// @connect     imgur.com
// @connect     instagr.am
// @connect     instagram.com
// @connect     prnt.sc
// @connect     prntscr.com
// @connect     user-images.githubusercontent.com
//
// @supportURL  https://github.com/tophf/mpiv/issues
// @icon        https://raw.githubusercontent.com/tophf/mpiv/master/icon.png
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Mouseover20Popup20Image20Viewer.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Mouseover20Popup20Image20Viewer.meta.js
// ==/UserScript==
"use strict";let cfg,elSetup,nonce,ai={rule:{}};const doc=document,hostname=location.hostname,dotDomain="."+hostname,isFF=CSS.supports("-moz-appearance","none"),AudioContext=window.AudioContext||function(){},{from:arrayFrom,isArray:isArray}=Array,PREFIX="mpiv-",NOAA_ATTR="data-no-aa",STATUS_ATTR=`${PREFIX}status`,MSG=Object.assign({},...["getViewSize","viewSize"].map((e=>({[e]:`${PREFIX}${e}`})))),WHEEL_EVENT="onwheel"in doc?"wheel":"mousewheel",SETTLE_TIME=50,RX_HAS_CODE=/(^|[^-\w])return[\W\s]/,RX_EVAL_BLOCKED=/'Trusted(Script| Type)'|unsafe-eval/,RX_MEDIA_URL=/^(?!data:)[^?#]+?\.(avif|bmp|jpe?g?|gif|mp4|png|svgz?|web[mp])($|[?#])/i,BLANK_PIXEL="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",ZOOM_MAX=16,SYM_U=Symbol("u"),FN_ARGS={s:["m","node","rule"],c:["text","doc","node","rule"],q:["text","doc","node","rule"],g:["text","doc","url","m","rule","node","cb"]};let trustedHTML,trustedScript;"undefined"!=typeof GM&&GM.xmlHttpRequest||(this.GM={__proto__:null,info:GM_info}),GM.getValue||(GM.getValue=GM_getValue),GM.setValue||(GM.setValue=GM_setValue),GM.openInTab||(GM.openInTab=GM_openInTab),GM.registerMenuCommand||"function"!=typeof GM_registerMenuCommand||(GM.registerMenuCommand=GM_registerMenuCommand),GM.unregisterMenuCommand||"function"!=typeof GM_unregisterMenuCommand||(GM.unregisterMenuCommand=GM_unregisterMenuCommand),GM.setClipboard||(GM.setClipboard=GM_setClipboard),GM.xmlHttpRequest||(GM.xmlHttpRequest=GM_xmlhttpRequest);const App={isEnabled:!0,isImageTab:!1,globalStyle:"",popupStyleBase:"",tabfix:/\.(dumpoir|greatfon|picuki)\.com$/.test(dotDomain),NOP:/\.(facebook|instagram|chrome|google)\.com$/.test(dotDomain)&&(()=>{}),activate(e,t){const{match:o,node:n,rule:i,url:a}=e,r="auto"===cfg.start,s=cfg.videoCtrl&&isVideo(n);elSetup&&console.info({node:n,rule:i,url:a,match:o}),r&&s&&!Events.ctrl||(ai.node&&App.deactivate(),ai=e,ai.force=Events.ctrl,ai.gNum=0,ai.zooming=cfg.css.includes(`${PREFIX}zooming`),Util.suppressTooltip(),Calc.updateViewSize(),Events.ctrl=!1,Events.toggle(!0),Events.trackMouse(t),ai.force&&(r||"ctrl"===cfg.start||"context"===cfg.start)?App.start():!r&&!cfg.preload||s||i.manual?Status.set("ready"):App.belate(r))},belate(e){cfg.preload?(ai.preloadStart=e?now():-1,App.start(),Status.set("+preloading")):ai.timer=setTimeout(App.start,cfg.delay)},checkProgress({start:e}={}){const t=ai.popup;if(!t)return;const o=ai.nwidth=t.naturalWidth||t.videoWidth||ai.popupLoaded&&innerWidth/2,n=ai.nheight=t.naturalHeight||t.videoHeight||ai.popupLoaded&&innerHeight/2;if(n)return App.canCommit(o,n);e&&(clearInterval(ai.timerProgress),ai.timerProgress=setInterval(App.checkProgress,150))},canClose:(e=ai.popup)=>!e||(isVideo(e)?!cfg.keepVids:document.fullscreenElement!==e),canCommit(e,t){if(!ai.force&&ai.rect&&!ai.gItems&&Math.max(e/(ai.rect.width||1),t/(ai.rect.height||1))<cfg.scale)return App.deactivate(),!1;App.stopTimers();let o=ai.preloadStart;return o<0&&!ai.force||!ai.popup?void 0:(o>0&&(o+=cfg.delay-now())>0?ai.timer=setTimeout(App.checkProgress,o):e&&t||!(ai.urls||[]).length?App.commit():App.handleError({type:"error"}),!0)},async commit(){const e=ai.popupShown=ai.popup,t=cfg.waitLoad&&isFunction(e.decode);if(t&&(await e.decode(),e!==ai.popup))return;Status.set("-preloading"),App.updateStyles(),Calc.measurePopup();(!("auto"===cfg.zoom||App.isImageTab&&cfg.imgtab)||void 0===App.toggleZoom({keepScale:!0}))&&Popup.move(),Bar.updateName(),Bar.updateDetails(),Status.set(!ai.popupLoaded&&"loading"),ai.large=ai.nwidth>e.clientWidth+ai.extras.w||ai.nheight>e.clientHeight+ai.extras.h,ai.large&&(Status.set("+large"),isFF&&e.complete&&!t&&(e.style.backgroundImage=`url('${e.src}')`)),ai.preloadStart<0&&isFunction(e.play)&&e.play().catch(now)},deactivate({wait:e}={}){App.stopTimers(!0),ai.req&&tryCatch(ai.req.abort),ai.tooltip&&(ai.tooltip.node.title=ai.tooltip.text),Status.set(!1),Bar.set(!1),Events.toggle(!1),Popup.destroy(),e&&(App.isEnabled=!1,setTimeout(App.enable,200)),ai={rule:{}}},enable(){App.isEnabled=!0},handleError(e,t=ai.rule){if(t&&"skip"===t.onerror)return;if(ai.imageUrl&&!ai.xhr&&!ai.imageUrl.startsWith(location.origin+"/")&&"https:"===location.protocol&&CspSniffer.init)return void Popup.create(ai.imageUrl,ai.pageUrl,e);const o=Util.formatError(e,t);t&&ai.urls&&ai.urls.length||console.warn(...o),ai.urls&&ai.urls.length?(ai.url=ai.urls.shift(),ai.url?(App.stopTimers(),App.startSingle()):App.deactivate()):ai.node&&(Status.set("error"),Bar.set(o.message,"error"))},onMessage(e){if("string"==typeof e.data&&e.data===MSG.getViewSize){e.stopImmediatePropagation();for(const t of doc.getElementsByTagName("iframe"))if(t.contentWindow===e.source){const o=Calc.frameSize(t,window).join(":");return void e.source.postMessage(`${MSG.viewSize}:${o}`,"*")}}},onMessageChild(e){if(e.source===parent&&"string"==typeof e.data&&e.data.startsWith(MSG.viewSize)){e.stopImmediatePropagation(),removeEventListener("message",App.onMessageChild,!0);const[t,o,n,i]=e.data.split(":").slice(1).map(parseFloat);t&&o&&(ai.view={w:t,h:o,x:n,y:i})}},start(){App.updateStyles(),ai.gallery?App.startGallery():App.startSingle()},startSingle(){Status.loading(),ai.force&&ai.preloadStart<0?App.commit():(ai.imageUrl=null,!ai.rule.follow||ai.rule.q||ai.rule.s?ai.rule.q&&!isArray(ai.urls)?App.startFromQ():(Popup.create(ai.url),Ruler.runC()):Req.findRedirect())},async startFromQ(){try{const{responseText:e,doc:t,finalUrl:o}=await Req.getDoc(ai.url),n=Ruler.runQ(e,t,o);if(!n)return void App.handleError(['The "q" rule did not produce any URL.',"\nRemote doc: %o",t]);if(RuleMatcher.isFollowableUrl(n,ai.rule)){const e=RuleMatcher.find(n,ai.node,{noHtml:!0});if(!e||!e.url)throw`Couldn't follow URL: ${n}`;Object.assign(ai,e),App.startSingle()}else Popup.create(n,o),Ruler.runC(e,t)}catch(e){App.handleError(e)}},async startGallery(){Status.loading();try{const e=ai.url,t=await Req.getDoc("gallery"!==ai.rule.s&&e),o=await new Promise((e=>{const o=ai.gallery(t.responseText,t.doc,t.finalUrl,ai.match,ai.rule,ai.node,e);void 0!==o&&e(o)}));if(ai.url!==e)return;if(ai.gNum=o.length,ai.gItems=o.length&&o,!ai.gItems)throw"Empty gallery";{const e=o.index;ai.gIndex=e>=0&&o[e]?+e:Gallery.findIndex("string"==typeof e?e:ai.url),setTimeout(Gallery.next)}}catch(e){App.handleError(e)}},stopTimers(e){for(const t of["timer","timerStatus",e&&"timerBar"])clearTimeout(ai[t]);clearInterval(ai.timerProgress)},toggleZoom({keepScale:e}={}){const t=ai.popup;if(t&&ai.scales&&!(ai.scales.length<2))return ai.zoomed=!ai.zoomed,ai.scale=ai.zoomed&&Calc.scaleForFirstZoom(e)||ai.scales[0],ai.zooming&&t.classList.add(`${PREFIX}zooming`),Popup.move(),Bar.updateDetails(),Status.set(!!ai.zoomed&&"zoom"),ai.zoomed},updateStyles(){Util.addStyle("global",(App.globalStyle||createGlobalStyle())+cfg._getCss()),Util.addStyle("rule",ai.rule.css||"")}},Bar={set(e,t,o){let n=ai.bar;if("string"!=typeof e)return $remove(n),void(ai.bar=null);const i=!n&&0;n||(n=ai.bar=$new("div",{id:`${PREFIX}bar`,className:`${PREFIX}${t}`})),ai.barText=e,App.updateStyles(),Bar.updateDetails(),Bar.setText(cfg.uiInfoCaption||"error"===t||"xhr"===t?e:""),$dataset(n,"prefix",o),setTimeout(Bar.show,0,i),n.parentNode||(doc.body.appendChild(n),Util.forceLayout(n))},setText(e){/<([a-z][-a-z]*)[^<>]*>[^<>]*<\/\1\s*>/i.test(e)?ai.bar.innerHTML=trustedHTML?trustedHTML(e):e:ai.bar.textContent=e},show(e){const t=ai.bar;!e&&(!cfg.uiInfo||0!==e&&cfg.uiInfoOnce)||ai.barShown||(clearTimeout(ai.timerBar),t.classList.add("mpiv-show"),$dataset(t,"force",2===e?"":null),ai.timerBar=!e&&setTimeout(Bar.hide,1e3*cfg.uiInfoHide),ai.barShown=!0)},hide(e){const t=ai.bar;t&&(e||cfg.uiInfo&&!t.dataset.force)&&ai.barShown&&($dataset(t,"force",2===e?"":null),t.classList.remove("mpiv-show"),ai.barShown=!1)},updateName(){const{gItems:e,gIndex:t,gNum:o}=ai;if(e){const n=e[t],i=!e.some((e=>e.desc)),a=[e.title&&(!t||i)&&!`${n.desc||""}`.includes(e.title)&&e.title||"",n.desc].filter(Boolean).join(" - ");Bar.set(a.trim()||" ","gallery",o>1?`${t+1}/${o}`:null)}else"caption"in ai?Bar.set(ai.caption,"caption"):ai.tooltip?Bar.set(ai.tooltip.text,"tooltip"):Bar.set(" ","info")},updateDetails(){if(!ai.bar)return;const e=ai.rotate,t=ai.nwidth&&`${Math.round(100*ai.scale)}%${ai.flipX||ai.flipY?`, ${ai.flipX?"⇆":""}${ai.flipY?"⇅":""}`:""}${e?", "+(e>180?e-360:e)+"°":""}, ${ai.nwidth} x ${ai.nheight} px, ${Math.round(ai.nwidth*ai.nheight/1e6*100)/100} MP, ${Calc.aspectRatio(ai.nwidth,ai.nheight)}`.replace(/\x20/g," ");ai.bar.dataset.zoom===t&&ai.nwidth||($dataset(ai.bar,"zoom",t||null),Bar.show())}},Calc={aspectRatio(e,t){for(let o,n=e/t,i=0;;){if(i++,o=Math.round(e*i/t),o>10&&i>10||o>100||i>100)return n.toFixed(2);if(Math.abs(o/i-n)<.01)return`${o}:${i}`}},frameSize(e,t){if(!e)return;const o=e.getBoundingClientRect();return[Math.min(o.right,t.innerWidth)-Math.max(o.left,0),Math.min(o.bottom,t.innerHeight)-Math.max(o.top,0),o.left<0?-o.left:0,o.top<0?-o.top:0]},generateScales(e){let[t,o]=e<1?[e,1]:[1,e];const n=cfg.zoomStep/100,i=[t];if(1!==e){const e=o/t,a=Math.log(e)/Math.log(n)|0,r=a&&Math.pow(e,1/a);for(let e=a;--e>0;)i.push(t*=r);i.push(t=o)}for(;(t*=n)<=16;)i.push(t);return i},measurePopup(){let{popup:e,nwidth:t,nheight:o}=ai;if(e.setAttribute("style","display:inline !important;"+App.popupStyleBase),e.clientWidth>t){const n=0|clamp(e.clientWidth,t,innerWidth/2);o=ai.nheight=n/t*o|0,t=ai.nwidth=n,e.style.cssText=`width: ${t}px !important; height: ${o}px !important;`}else e.style.cssText="";e.classList.add(`${PREFIX}show`);const n=getComputedStyle(e),i=2*sumProps(n.outlineOffset,n.outlineWidth),a=sumProps(n.paddingLeft,n.paddingRight,n.borderLeftWidth,n.borderRightWidth),r=sumProps(n.paddingTop,n.paddingBottom,n.borderTopWidth,n.borderBottomWidth),s=i+sumProps(n.marginLeft,n.marginRight),l=i+sumProps(n.marginTop,n.marginBottom);ai.extras={inw:a,inh:r,outw:s,outh:l,o:i/2,w:a+s,h:r+l};const c=Math.min((ai.view.w-ai.extras.w)/ai.nwidth,(ai.view.h-ai.extras.h)/ai.nheight)||1,p=!cfg.fit&&cfg.scales.length;let u=Math.min(1,c),d="all"===cfg.fit&&c||"no"===cfg.fit&&1||u;if(p){const e=[];for(const t of cfg.scales){const o=parseFloat(t)||c;e.push(o),p&&"string"==typeof t&&(t.includes("!")&&(u=o),t.includes("*")&&(d=o))}ai.scales=e.sort(compareNumbers).filter(Calc.scaleBiggerThan,u)}else ai.scales=Calc.generateScales(c);ai.scale="auto"===cfg.zoom?d:Math.min(1,c),ai.scaleFit=c,ai.scaleZoom=d},rect(){const{node:e,rule:t}=ai;let o=t.rect&&e.closest(t.rect);if(o)return o.getBoundingClientRect();const n=(o=e).firstElementChild?document.elementsFromPoint(ai.cx,ai.cy):[];let i,a=0,r=0;do{const e=o.getBoundingClientRect(),t=e.width*e.height;t>a&&(a=t,i=e)}while((o=n[r++])&&e.contains(o));return i},scaleBiggerThan(e,t,o){return e>=this&&(!t||Math.abs(e-o[t-1])>.01)},scaleIndex(e){const t=ai.scales.indexOf(ai.scale);if(t>=0)return t+e;for(let t=ai.scales.length,o=e>0?0:t-1;o>=0&&o<t;o+=e)if(Math.sign(ai.scales[o]-ai.scale)===e)return o;return-1},scaleForFirstZoom(e){const t=ai.scaleZoom;return e||t!==ai.scale?t:ai.scales.find((e=>e>t))},updateViewSize(){const e="BackCompat"===doc.compatMode?doc.body:doc.documentElement;if(ai.view={w:e.clientWidth,h:e.clientHeight,x:0,y:0},window===top)return;const[t,o]=Calc.frameSize(frameElement,parent)||[];t&&o?ai.view={w:t,h:o,x:0,y:0}:(addEventListener("message",App.onMessageChild,!0),parent.postMessage(MSG.getViewSize,"*"))}};class Config{constructor({data:e,save:t}){"string"==typeof e&&(e=tryJSON(e)),"object"==typeof e&&e||(e={});const{DEFAULTS:o}=Config;if(e.fit=["all","large","no",""].includes(e.fit)?e.fit:(e.scales||0).length&&`${e.scales}`!=`${o.scales}`?"":"large",e.version!==o.version){"string"==typeof e.hosts&&(e.hosts=e.hosts.split("\n").map((e=>tryJSON(e)||e)).filter(Boolean)),!0!==e.close&&!1!==e.close||(e.zoomOut=e.close?"auto":"stay");for(const t in o)typeof e[t]!=typeof o[t]&&(e[t]=o[t]);3===e.version&&0===e.scales[0]&&(e.scales[0]="0!");for(const t in e)t in o||delete e[t];e.version=o.version,t&&GM.setValue("cfg",e)}Object.keys(cfg||{}).some((t=>/^ui|^(css|globalStatus)$/.test(t)&&cfg[t]!==e[t]))&&(App.globalStyle=""),isArray(e.scales)||(e.scales=[]),e.scales=[...new Set(e.scales)].sort(((e,t)=>parseFloat(e)-parseFloat(t))),Object.assign(this,o,e)}static async load(e){return e.data=await GM.getValue("cfg"),new Config(e)}_getCss(){const{css:e}=this;return e.includes("{")?e:`#${PREFIX}-popup {${e}}`}}Config.DEFAULTS={__proto__:null,center:!1,css:"",delay:500,fit:"",globalStatus:!1,hosts:[{name:"No popup for YouTube thumbnails",d:"www.youtube.com",e:"ytd-rich-item-renderer *, ytd-thumbnail *",s:""},{name:"No popup for SVG/PNG icons",d:"",e:"img[src*='icon']",r:"//[^/]+/.*\\bicons?\\b.*\\.(?:png|svg)",s:""}],imgtab:!1,keepOnBlur:!1,keepVids:!1,mute:!1,night:!1,preload:!1,scale:1.05,scales:["0!",.125,.25,.5,.75,1,1.5,2,2.5,3,4,5,8,16],start:"auto",startAlt:"context",startAltShown:!1,uiBackgroundColor:"#ffffff",uiBackgroundOpacity:100,uiBorderColor:"#000000",uiBorderOpacity:100,uiBorder:0,uiFadein:!0,uiFadeinGallery:!0,uiInfo:!0,uiInfoCaption:!0,uiInfoHide:3,uiInfoOnce:!0,uiShadowColor:"#000000",uiShadowOpacity:80,uiShadow:20,uiShadowOnLoad:!0,uiPadding:0,uiMargin:0,version:6,videoCtrl:!0,waitLoad:!1,xhr:!0,zoom:"context",zoomOut:"auto",zoomStep:133};const CspSniffer={csp:null,selfUrl:location.origin+"/",init(){this.busy=new Promise((e=>{const t=new XMLHttpRequest;t.open("get",location),t.timeout=Math.max(2e3,2*(performance.timing.responseEnd-performance.timeOrigin)),t.onreadystatechange=()=>{t.readyState>=t.HEADERS_RECEIVED&&(this.csp=this._parse([t.getResponseHeader("content-security-policy"),$prop('meta[http-equiv="Content-Security-Policy"]',"content")].filter(Boolean).join(",")),this.init=this.busy=t.onreadystatechange=null,t.abort(),e())},t.send()}))},async check(e,t){t&&this.init&&this.init(),this.busy&&await this.busy;const o=Util.isVideoUrl(e);let n;if(this.csp){const t=this.csp[o?"media":"img"];t.some(this._srcMatches,e)||(n=[n,"blob","data"].find((e=>t.includes(`${e}:`))))}return[n||ai.xhr,o]},_parse(e){if(!e)return;const t={},o=/(?:^|[;,])\s*(?:(default|img|media|script)-src|require-(trusted)-types-for) ([^;,]+)/g;for(let n;n=o.exec(e);)t[n[1]||n[2]]=n[3].trim().split(/\s+/);(t.script||[]).find((e=>/^'nonce-(.+)'$/.test(e)))&&(nonce=RegExp.$1),(t.trusted||[]).includes("'script'")&&(App.NOP=()=>{}),t.img||(t.img=t.default||[]),t.media||(t.media=t.default||[]);for(const e of[t.img,t.media])e.forEach(((t,o)=>{"*"!==t&&t.includes("*")&&(e[o]=new RegExp((/^\w+:/.test(t)?"^":"^\\w+://")+t.replace(/[.+?^$|()[\]{}]/g,"\\$&").replace(/(\\\.)?(\*)(\\\.)?/g,((e,t,o,n)=>`${t?"\\.?":""}[^:/]*${n?"\\.?":""}`)).replace(/[^/]$/,"$&/")))}));return t},_srcMatches(e){return e instanceof RegExp?e.test(this):"*"===e||e&&this.startsWith(e)&&(e.endsWith("/")||"/"===this[e.length])||"'self'"===e&&this.startsWith(CspSniffer.selfUrl)}},Events={ctrl:!1,hoverData:null,hoverTimer:0,ignoreKeyHeld:!1,onMouseOver(e){let t=e.target;Events.ignoreKeyHeld=e.shiftKey,!App.isEnabled||e.shiftKey||ai.zoomed||t===ai.popup||t===doc.body||t===doc.documentElement||t===elSetup||ai.gallery&&ai.rectHovered||!App.canClose()||(t.shadowRoot&&(t=Events.pierceShadow(t,e.clientX,e.clientY)),Events.hoverData={e:e,node:t,start:now()},Events.hoverTimer=Events.hoverTimer||setTimeout(Events.onMouseOverThrottled,50),t.addEventListener("mouseout",Events.onMouseOutThrottled))},onMouseOverThrottled(e){const{start:t,e:o,node:n,nodeOut:i}=Events.hoverData||{};if(!n||n===i&&(Events.hoverData=null,1))return;const a=e?0:t+50-now();if(Events.hoverTimer=a>10&&setTimeout(Events.onMouseOverThrottled,a))return;Events.hoverData=null,Ruler.rules||Ruler.init();const r=RuleMatcher.adaptiveFind(n);r&&r.url&&r.node!==ai.node&&App.activate(r,o)},onMouseOut(e){e.relatedTarget||cfg.keepOnBlur||e.shiftKey||!App.canClose()||App.deactivate()},onMouseOutThrottled(e){const t=Events.hoverData;t&&(t.nodeOut=this),this.removeEventListener("mouseout",Events.onMouseOutThrottled),Events.hoverTimer=0},onMouseOutShadow(e){const t=e.target.shadowRoot;t&&(t.removeEventListener("mouseover",Events.onMouseOver),t.removeEventListener("mouseout",Events.onMouseOutShadow))},onMouseMove(e){if(Events.trackMouse(e),!e.shiftKey)if(ai.zoomed||ai.rectHovered||!App.canClose()){if(ai.zoomed){Popup.move();const{cx:e,cy:t,view:{w:o,h:n}}=ai,i=o/6,a=n/6,r=e<i||e>o-i||t<a||t>n-a;Status.set((r?"+":"-")+"edge")}}else App.deactivate()},onMouseDown({shiftKey:e,button:t,target:o}){t||o!==ai.popup||!ai.popup.controls||!e&&App.canClose()?2===t||e||(App.deactivate({wait:!0}),doc.addEventListener("mouseup",App.enable,{once:!0})):ai.controlled=ai.zoomed=!0},onMouseScroll(e){const t=(e.deltaY||-e.wheelDelta)<0?1:-1;if(ai.zoomed)Events.zoomInOut(t);else if(ai.gNum>1&&ai.popup)Gallery.next(-t);else if("wheel"===cfg.zoom&&t>0&&ai.popup)App.toggleZoom();else if(App.canClose())return void App.deactivate();dropEvent(e)},onKeyDown(e){const t=describeKey(e),o=ai.popupShown;if(o||"^Control"!==t||(addEventListener("keyup",Events.onKeyUp,!0),Events.ctrl=!0),!o&&"^ContextMenu"===t)return Events.onContext.call(this,e);if(o&&!e.repeat){switch(t){case"+Shift":if(ai.shiftKeyTime)return;return ai.shiftKeyTime=now(),Status.set("+shift"),cfg.uiInfo&&Bar.show(1),void(isVideo(o)&&(o.controls=!0));case"KeyA":o.toggleAttribute(NOAA_ATTR);break;case"ArrowRight":case"KeyJ":Gallery.next(1);break;case"ArrowLeft":case"KeyK":Gallery.next(-1);break;case"KeyC":ai.bar.firstChild?(Bar.setText(""),Bar.hide(0)):(Bar.setText(ai.barText),Bar.show(2));break;case"KeyD":Req.saveFile();break;case"KeyF":o!==document.fullscreenElement?o.requestFullscreen():document.exitFullscreen();break;case"KeyH":case"KeyV":case"KeyL":case"KeyR":if(!o)return;if("KeyH"===t||"KeyV"===t){const e=!!(ai.rotate%180)^"KeyH"===t?"flipX":"flipY";ai[e]=!ai[e]}else ai.rotate=((ai.rotate||0)+90*("KeyL"===t?-1:1)+360)%360;Bar.updateDetails(),Popup.move();break;case"KeyI":(ai.barShown?Bar.hide:Bar.show)(2);break;case"KeyM":isVideo(o)&&(o.muted=!o.muted);break;case"KeyN":ai.night=o.classList.toggle(`${PREFIX}night`);break;case"KeyT":GM.openInTab(Util.tabFixUrl()||o.src),App.deactivate();break;case"Minus":case"NumpadSubtract":ai.zoomed?Events.zoomInOut(-1):App.toggleZoom();break;case"Equal":case"NumpadAdd":ai.zoomed?Events.zoomInOut(1):App.toggleZoom();break;case"Escape":App.deactivate({wait:!0});break;case"!Alt":return;default:return void App.deactivate({wait:!0})}dropEvent(e)}},onKeyUp(e){const t=ai.popupShown||!1;"Control"===e.key&&(t||removeEventListener("keyup",Events.onKeyUp,!0),setTimeout((()=>Events.ctrl=!1))),t&&"Shift"===e.key&&ai.shiftKeyTime?(Status.set("-shift"),cfg.uiInfo&&Bar.hide(1),t.controls&&(t.controls=!1),ai.controlled||!isFF&&now()-ai.shiftKeyTime>500?ai.controlled=!1:t&&(ai.zoomed||!1!==ai.rectHovered)?App.toggleZoom():App.deactivate({wait:!0}),ai.shiftKeyTime=0):"Control"!==describeKey(e)||t||Events.ignoreKeyHeld||"ctrl"!==cfg.start&&"context"!==cfg.start&&!ai.rule.manual||(dropEvent(e),Events.hoverData&&(Events.hoverData.e=e,Events.onMouseOverThrottled(!0)),ai.node&&(ai.force=!0,App.start()))},onContext(e){if(Events.ignoreKeyHeld)return;const t=ai.popupShown;"context"===cfg.zoom&&t&&App.toggleZoom()?dropEvent(e):t||cfg.videoCtrl&&isVideo(ai.node)&&!Events.ctrl||!("context"===cfg.start||"contextMK"===cfg.start||"contextM"===cfg.start&&2===e.button||"contextK"===cfg.start&&2!==e.button||"auto"===cfg.start&&ai.rule.manual)?t&&setTimeout(App.deactivate,50,{wait:!0}):(ai.node||Events.hoverData||Events.onMouseOver(e),Events.onMouseOverThrottled(!0),ai.node&&(ai.force=!0,App.start(),dropEvent(e)))},onVisibility(e){Events.ctrl=!1},pierceShadow(e,t,o){for(let n;n=e.shadowRoot;){n.addEventListener("mouseover",Events.onMouseOver,{passive:!0}),n.addEventListener("mouseout",Events.onMouseOutShadow);const i=n.elementFromPoint(t,o);if(!i||i===e)break;e=i}return e},toggle(e){const t=e?"addEventListener":"removeEventListener",o={passive:!0,capture:!0};window[t]("mousemove",Events.onMouseMove,o),window[t]("mouseout",Events.onMouseOut,o),window[t]("mousedown",Events.onMouseDown,o),window[t]("keyup",Events.onKeyUp,!0),window[t](WHEEL_EVENT,Events.onMouseScroll,{passive:!1,capture:!0}),ai.node.removeEventListener("mouseout",Events.onMouseOutThrottled)},trackMouse(e){const t=ai.cx=e.clientX,o=ai.cy=e.clientY,n=ai.rect||(ai.rect=Calc.rect());ai.rectHovered=t>n.left-2&&t<n.right+2&&o>n.top-2&&o<n.bottom+2},zoomInOut(e){const t=Calc.scaleIndex(e),o=ai.scales.length;t>=0&&t<o&&(ai.scale=ai.scales[t]);const n=cfg.zoomOut;if(t<=0&&"stay"!==n){if(ai.scaleFit<.99*ai.scale)ai.scales.unshift(ai.scale=ai.scaleFit);else if((t<=0&&"close"===n||t<0&&!ai.rectHovered)&&ai.gNum<2)return void App.deactivate({wait:!0});ai.zoomed="unzoom"!==n}else ai.popup.classList.toggle(`${PREFIX}zoom-max`,ai.scale>=4&&t>=o-1);ai.zooming&&ai.popup.classList.add(`${PREFIX}zooming`),Popup.move(),Bar.updateDetails()}},Gallery={makeParser:e=>isFunction(e)?e:Gallery.defaultParser,findIndex:e=>Math.max(0,ai.gItems.findIndex((({url:t})=>isArray(t)?t.includes(e):t===e))),next(e){e&&(ai.gIndex=Gallery.nextIndex(e));const t=ai.gItem=ai.gItems[ai.gIndex];isArray(t.url)?(ai.urls=t.url.slice(1),ai.url=t.url[0]):(ai.urls=null,ai.url=t.url),ai.gItemNext=ai.gItems[Gallery.nextIndex(e||1)],App.startSingle(),Bar.updateName(),e&&Bar.show(0)},nextIndex:e=>(ai.gIndex+e+ai.gNum)%ai.gNum,defaultParser(e,t,o,n,i){const{g:a}=i,r=a.index,s=a.entry,l=ensureArray(a.caption),c=a.image||"img",p=a.title,u=("string"==typeof a.fix?Util.newFunction("s","isURL",a.fix):a.fix)||(e=>e.trim()),d=[...$$(s||c,t)],m=d.map((function(e){const t={};try{const n=s?$(c,e):e;t.url=u(Req.findImageUrl(n,o),!0),t.desc=l.map(g,e).filter(Boolean).join(" - ")}catch(e){}return t.url&&t})).filter(Boolean);return m.title=function(){const e=$(p,t);return e&&u(e.getAttribute("content")||e.textContent)||""}(),m.index=RX_HAS_CODE.test(r)?Util.newFunction("items","node",r)(m,ai.node):"string"==typeof r?Req.findImageUrl(tryCatch($,r,t),o):null==r?Math.max(0,d.indexOf(ai.node)):r,m;function g(e){const t=e?$(e,this)||h(e,this.previousElementSibling)||h(e,this.nextElementSibling):this;return t&&u(Ruler.runCHandler.default(t)||t.textContent)}function h(e,t){if(t&&!t.matches(s))return t.matches(e)?t:$(e,t)}}},Menu=window===top&&GM.registerMenuCommand&&{curAltName:"",unreg:GM.unregisterMenuCommand,makeAltName:()=>Menu.unreg?"MPIV: auto-start is "+("auto"===cfg.start?"ON":"OFF"):"MPIV: toggle auto-start",register(){GM.registerMenuCommand("MPIV: configure",setup),Menu.registerAlt()},registerAlt(){cfg.startAltShown&&(Menu.curAltName=Menu.makeAltName(),GM.registerMenuCommand(Menu.curAltName,Menu.onAltToggled))},reRegisterAlt(){const e=Menu.curAltName;e&&Menu.unreg&&Menu.unreg(e),e&&!Menu.unreg||Menu.registerAlt()},onAltToggled(){"auto"===cfg.start?cfg.start=cfg.startAlt||(cfg.startAlt="context"):(cfg.startAlt=cfg.start,cfg.start="auto"),Menu.reRegisterAlt()}},Popup={async create(e,t,o){let n,i=ai.popup;const a=i&&!cfg.uiFadeinGallery&&ai.gItems&&!ai.zooming;if(a&&i===document.fullscreenElement?Popup.destroyBlob():i&&(Popup.destroy(),i=null),ai.imageUrl=e,!e)return;const r=ai;let s,[l,c]=await CspSniffer.check(e,o);if(ai!==r)return;if(!l&&o)return void App.handleError(o);if(Object.assign(ai,{pageUrl:t,xhr:l}),l&&([e,c]=await Req.getImage(e,t,l).catch(App.handleError)||[]),ai!==r||!e||c&&(s=await GM.getValue("volume"),ai!==r))return;i?(i.src=n=BLANK_PIXEL,i.classList.remove("mpiv-show"),i.removeAttribute("style"),ai.popupShown=null,ai.popupLoaded=!1):i=ai.popup=c?PopupVideo.create(s):$new("img"),i.id=`${PREFIX}popup`,i.src=e,i.addEventListener("error",App.handleError),(ai.night=null!=ai.night?ai.night:cfg.night)&&i.classList.add(`${PREFIX}night`),ai.zooming&&i.addEventListener("transitionend",Popup.onZoom),$dataset(i,"galleryFlip",a?"":null),i.toggleAttribute("loaded",!!a);const p=ai.popover||"function"==typeof i.showPopover&&$("[popover]:popover-open");ai.popover=p&&p.getBoundingClientRect().width&&($css(p,{opacity:0}),p)||null,i.parentElement!==doc.body&&doc.body.insertBefore(i,ai.bar&&ai.bar.parentElement===doc.body&&ai.bar||null),await 0,ai.popup===i&&!1!==App.checkProgress({start:!0})&&(!n&&i.complete?Popup.onLoad.call(i):c||i.addEventListener("load",Popup.onLoad,{once:!0}))},destroy(){const e=ai.popup;e&&(e.removeEventListener("load",Popup.onLoad),e.removeEventListener("error",App.handleError),ai.popover&&(ai.popover.style.removeProperty("opacity"),ai.popover=null),isFunction(e.pause)&&e.pause(),e.remove(),Popup.destroyBlob(),ai.zoomed=ai.popup=ai.popupLoaded=null)},destroyBlob(){ai.blobUrl&&(setTimeout(URL.revokeObjectURL,50,ai.blobUrl),ai.blobUrl=null)},move(){let e,t;const{cx:o,cy:n,extras:i,view:a}=ai,r=a.w-i.outw,s=a.h-i.outh,l=ai.scale*ai.nwidth+i.inw,c=ai.scale*ai.nheight+i.inh,p=ai.rotate%180,u=p?c:l,d=p?l:c;if(!ai.zoomed&&ai.gNum<2&&!cfg.center){const o=ai.rect,n=(o.left+o.right)/2,i=(o.top+o.bottom)/2;r-o.right-40>u||u<o.left-40?(d<s-60&&(t=clamp(i-d/2,30,s-d-30)),e=n>r/2?o.left-40-u:o.right+40):(s-o.bottom-40>d||d<o.top-40)&&(u<r-60&&(e=clamp(n-u/2,30,r-u-30)),t=i>s/2?o.top-40-d:o.bottom+40)}null==e&&(e=r>u?(r-u)/2+a.x:(r-u)*clamp(5/3*((o-a.x)/r-.2),0,1)),null==t&&(t=s>d?(s-d)/2+a.y:(s-d)*clamp(5/3*((n-a.y)/s-.2),0,1));const m=p?(l-c)/2:0;e+=i.o-m,t+=i.o+m,$css(ai.popup,{transform:`translate(${Math.round(e)}px, ${Math.round(t)}px) rotate(${ai.rotate||0}deg) scale(${ai.flipX?-1:1},${ai.flipY?-1:1})`,width:`${Math.round(l)}px`,height:`${Math.round(c)}px`})},onLoad(){if(this===ai.popup){this.setAttribute("loaded",""),ai.popupLoaded=!0,Status.set("-loading");let e=ai.gItem;e&&(e.url=this.src),(e=ai.gItemNext)&&Popup.preload(this,e)}},onZoom(){this.classList.remove(`${PREFIX}zooming`)},async preload(e,t,o=t.url,n=$new("img")){if(ai.gItemNext=null,isArray(o))for(const i=o;e===ai.popup&&t.url===i&&(o=i[0]);){const{type:e}=await new Promise((e=>{n.src=o,n.onload=n.onerror=e}));if(i[0]===o&&i.shift(),"load"===e){t.url=o;break}}else n.src=o}},PopupVideo={create:e=>(ai.bufBar=!1,ai.bufStart=now(),$new("video",{autoplay:-1!==ai.preloadStart,controls:!0,muted:cfg.mute||"suspended"===(new AudioContext).state,loop:!0,volume:clamp(+e||.5,0,1),onprogress:PopupVideo.progress,oncanplaythrough:PopupVideo.progressDone,onvolumechange:PopupVideo.rememberVolume})),progress(){const{duration:e}=this;if(e&&this.buffered.length&&now()-ai.bufStart>2e3){const t=Math.round(this.buffered.end(0)/e*100);ai.bar&&(ai.bufBar|=t>0&&t<50)&&Bar.set(`${t}% of ${Math.round(e)}s`,"xhr")}},progressDone(){this.onprogress=this.oncanplaythrough=null,ai.bar&&ai.bar.classList.contains(`${PREFIX}xhr`)&&Bar.set(!1),Popup.onLoad.call(this)},rememberVolume(){GM.setValue("volume",this.volume)}},Ruler={init(){const e=new Map,t=cfg.hosts||[],o=t.filter(((e,t,o)=>!t||!Util.deepEqual(e,o[t-1])));o.length<t.length&&GM.setValue("cfg",cfg);const n=Ruler.rules=o.map(Ruler.parse,e).filter(Boolean),i="function"==typeof GM_addElement,a=nonce||(nonce=($("script[nonce]")||{}).nonce||"")||i,r=a&&`${GM_info.script.name}${Math.random()}`,s=[],l=[`window[${JSON.stringify(r)}]=[`];for(const[t,o]of e.entries())RX_EVAL_BLOCKED.test(o)?(a&&l.push(s.length?",":"","[",n.indexOf(t),",{",...Object.keys(FN_ARGS).map((e=>RX_HAS_CODE.test(t[e])&&`${e}(${FN_ARGS[e]}){${t[e]}},`)).filter(Boolean),"}]"),s.push(t)):App.handleError("Invalid custom host rule:",t);if(s.length){let e,t;if(a){const o=i?GM_addElement:(e,{textContent:t})=>document.head.appendChild(Object.assign(document.createElement(e),{textContent:trustedScript?trustedScript(t):t,nonce:nonce}));l.push("]; document.currentScript.remove();"),o("script",{textContent:l.join("")}),e=(t=unsafeWindow)[r]||isFF&&(t=t.wrappedJSObject)[r]}if(e){for(const[t,o]of e)Object.assign(n[t],o);delete t[r]}else console.warn("Site forbids compiling JS code in these custom rules",s)}switch(dotDomain.match(/[^.]+(?=\.com?(?:\.[^.]+)?$)|[^.]+\.[^.]+$|$/)[0]){case"4chan.org":n.push({e:'.is_catalog .thread a[href*="/thread/"], .catalog-thread a[href*="/thread/"]',q:".op .fileText a",css:"#post-preview{display:none}"});break;case"amazon":n.push({r:/.+?images\/I\/.+?\./,s:e=>doc.getElementById("universal-hover")?"":e[0]+"jpg",css:"#zoomWindow{display:none!important;}"});break;case"bing":n.push({e:'a[m*="murl"]',r:/murl&quot;:&quot;(.+?)&quot;/,s:"$1",html:!0});break;case"deviantart":n.push({e:'a[href*="/art/"] img[src*="/v1/"]',r:/^(.+)\/v1\/\w+\/[^/]+\/(.+)-\d+.(\.\w+)(\?.+)/,s:([,e,t,o,n],i)=>{let a=Util.getReactChildren(i.closest("a"),"props.deviation.media.types");return a&&(a=a.find((e=>"fullview"===e.t)))&&`${e}${a.c?a.c.replace("<prettyName>",t):`/v1/fill/w_${a.w},h_${a.h}/${t}-fullview${o}`}${n}`}},{e:".dev-view-deviation img",s:()=>[$(".dev-page-download").href,$(".dev-content-full").src].filter(Boolean)},{e:"a[data-hook=deviation_link]",q:"link[as=image]"});break;case"discord":n.push({u:"||discordapp.net/external/",r:/\/https?\/(.+)/,s:"//$1",follow:!0});break;case"dropbox":n.push({r:/(.+?&size_mode)=\d+(.*)/,s:"$1=5$2"});break;case"facebook":n.push({e:'a[href^="/photo/?"], a[href^="https://www.facebook.com/photo"]',s:(e,t)=>(e=Util.getReactChildren(t.parentNode))&&pick(e,(e[0]?"0.props.linkProps":"props")+".passthroughProps.origSrc")});break;case"flickr":pick(unsafeWindow,"YUI_config.flickr.api.site_key")&&n.push({r:/flickr\.com\/photos\/[^/]+\/(\d+)/,s:e=>`https://www.flickr.com/services/rest/?${new URLSearchParams({photo_id:e[1],api_key:unsafeWindow.YUI_config.flickr.api.site_key,method:"flickr.photos.getSizes",format:"json",nojsoncallback:1}).toString()}`,q:e=>JSON.parse(e).sizes.size.pop().source,anonymous:!0});break;case"github":n.push({r:new RegExp([/(avatars.+?&s=)\d+/,/(raw\.github)(\.com\/.+?\/img\/.+)$/,/\/(github)(\.com\/.+?\/)blob\/([^/]+\/.+?\.(?:avif|webp|png|jpe?g|bmp|gif|cur|ico|svg))$/].map((e=>e.source)).join("|")),s:e=>"https://"+(e[1]?`${e[1]}460`:e[2]?`${e[2]}usercontent${e[3]}`:$(".AppHeader-context-item > .octicon-lock")?`${e[4]}${e[5]}raw/${e[6]}`:`raw.${e[4]}usercontent${e[5]}${e[6]}`)});break;case"google":/[&?]tbm=isch(&|$)/.test(location.search)&&n.push({e:'a[href*="imgres?imgurl="] img',s:(e,t)=>new URLSearchParams(t.closest("a").search).get("imgurl"),follow:!0},{e:"[data-tbnid] a:not([href])",s:(e,t)=>{const o=$('a[jsaction*="mousedown"]',t.closest("[data-tbnid]"))||t;new MutationObserver(((e,n)=>{n.disconnect(),App.isEnabled=!0,t.alt=o.innerText;const{left:i,top:a}=t.getBoundingClientRect();Events.onMouseOver({target:$("img",t),clientX:i,clientY:a})})).observe(t,{attributes:!0,attributeFilter:["href"]}),o.dispatchEvent(new MouseEvent("mousedown",{bubbles:!0})),o.dispatchEvent(new MouseEvent("mouseup",{bubbles:!0}))}});break;case"instagram":n.push({e:'a[href*="/p/"],article [role="button"][tabindex="0"],article [role="button"][tabindex="0"] div',s:(e,t,o)=>{let n,i,a,r,s;(location.pathname.startsWith("/p/")||location.pathname.startsWith("/tv/"))&&(r=$("img[srcset], video",t.parentNode),r&&(isVideo(r)||parseFloat(r.sizes)>900)&&(s=(r.srcset||r.currentSrc).split(",").pop().split(" ")[0])),!s&&(a=t.closest('a[href*="/p/"], article'))&&(i="A"===a.tagName?a:$('a[href*="/p/"]',a));const l=i&&pick(n,"edge_sidecar_to_children.edges.length")||i&&pick(n,"carousel_media_count");return Ruler.toggle(o,"q",n),Ruler.toggle(o,"g",i&&(l>1||/<\w+[^>]+carousel/i.test(i.innerHTML))),o.follow=!o.g,o._data=n,o._img=r,!(!i&&!s)&&`${s||i.href}${o.g?"?__a=1&__d=dis":""}`},c:(e,t,o,n)=>n._getCaption(n._data)||(n._img||0).alt||"",follow:!0,_q:'meta[property="og:video"]',_g(e,t,o,n,i){const a=tryJSON(e),r=pick(a,"graphql.shortcode_media")||pick(a,"items.0"),s=pick(r,"edge_sidecar_to_children.edges",(e=>e.map((e=>({url:e.node.video_url||e.node.display_url})))))||pick(r,"carousel_media",(e=>e.map((e=>({url:pick(e,"video_versions.0.url")||pick(e,"image_versions2.candidates.0.url")})))));return s.title=i._getCaption(r)||"",s},_getCaption:e=>pick(e,"caption.text")||pick(e,"edge_media_to_caption.edges.0.node.text")});break;case"reddit":n.push({u:"||i.reddituploads.com/"},{e:'[data-url*="i.redd.it"] img[src*="thumb"]',s:(e,t)=>$propUp(t,"data-url")},{r:/preview(\.redd\.it\/\w+\.(jpe?g|png|gif))/,s:"https://i$1"});break;case"stackoverflow":n.push({e:".post-tag, .post-tag img",s:""});break;case"startpage":n.push({r:/[&?]piurl=([^&]+)/,s:"$1",follow:!0});break;case"tumblr":n.push({e:"div.photo_stage_img, div.photo_stage > canvas",s:(e,t)=>/http[^"]+/.exec(t.style.cssText+t.getAttribute("data-img-src"))[0],follow:!0});break;case"twitter":n.push({e:".grid-tweet > .media-overlay",s:(e,t)=>t.previousElementSibling.src,follow:!0})}n.push({r:/[/?=](https?%3A%2F%2F[^&]+)/i,s:"$1",follow:!0,onerror:"skip"},{u:["||500px.com/photo/","||cl.ly/","||cweb-pix.com/","//ibb.co/","||imgcredit.xyz/image/"],r:/\.\w+\/.+/,q:'meta[property="og:image"]'},{u:"attachment.php",r:/attachment\.php.+attachmentid/},{u:"||abload.de/image",q:"#image"},{u:"||deviantart.com/art/",s:(e,t)=>/\b(film|lit)/.test(t.className)||/in Flash/.test(t.title)?"":e.input,q:['#download-button[href*=".jpg"]','#download-button[href*=".jpeg"]','#download-button[href*=".gif"]','#download-button[href*=".png"]',"#gmi-ResViewSizer_fullimg","img.dev-content-full"]},{u:"||dropbox.com/s",r:/com\/sh?\/.+\.(jpe?g|gif|png)/i,q:(e,t)=>$prop("img.absolute-center","src",t).replace(/(size_mode)=\d+/,"$1=5")||!1},{r:/[./]ebay\.[^/]+\/itm\//,q:e=>e.match(/https?:\/\/i\.ebayimg\.com\/[^.]+\.JPG/i)[0].replace(/~~60_\d+/,"~~60_57")},{u:"||i.ebayimg.com/",s:(e,t)=>$(".zoom_trigger_mask",t.parentNode)?"":e.input.replace(/~~60_\d+/,"~~60_57")},{u:"||fastpic.",s:(e,t,o)=>{const n=t.closest("a"),i=decodeURIComponent(Req.findImageUrl(n||t)).replace(/\/i(\d+)\.(\w+\.\w+\/)\w+/,"/$2$1").replace(/^\w+:\/\/fastpic[^/]+((?:\/\d+){3})\/\w+(\/\w+\.\w+).*/,"https://fastpic.org/view$1$2.html");return Ruler.toggle(o,"q",i.includes(".html")),n||i.includes(".png")?i:[i,i.replace(/\.jpe?g/,".png")]},_q:'img[src*="/big/"]'},{u:"||flickr.com/photos/",r:/photos\/([0-9]+@N[0-9]+|[a-z0-9_-]+)\/([0-9]+)/,s:e=>e.input.indexOf("/sizes/")<0&&`https://www.flickr.com/photos/${e[1]}/${e[2]}/sizes/sq/`,q:(e,t)=>{const o=$$(".sizes-list a",t);return"https://www.flickr.com"+o[o.length-1].getAttribute("href")},follow:!0},{u:"||flickr.com/photos/",r:/\/sizes\//,q:"#allsizes-photo > img"},{u:"||gfycat.com/",r:/(gfycat\.com\/)(gifs\/detail\/|iframe\/)?([a-z]+)/i,s:"https://$1$3",q:'meta[content$=".webm"], #webmsource, source[src$=".webm"], .actual-gif-image'},{u:["||googleusercontent.com/proxy","||googleusercontent.com/gadgets/proxy"],r:/\.com\/(proxy|gadgets\/proxy.+?(http.+?)&)/,s:e=>e[2]?decodeURIComponent(e[2]):e.input.replace(/w\d+-h\d+($|-p)/,"w0-h0")},{u:["||googleusercontent.com/","||ggpht.com/"],s:e=>e.input.includes("webcache.")?"":e.input.replace(/\/s\d{2,}-[^/]+|\/w\d+-h\d+/,"/s0").replace(/([&?]sz)?=[-\w]+([&#].*)?/,"")},{u:"||gravatar.com/",r:/([a-z0-9]{32})/,s:"https://gravatar.com/avatar/$1?s=200"},{u:"//gyazo.com/",r:/\bgyazo\.com\/\w{32,}(\.\w+)?/,s:(e,t,o)=>Ruler.toggle(o,"q",!e[1])?e.input:`https://i.${e[0]}`,_q:'link[rel="image_src"]'},{u:"||hostingkartinok.com/show-image.php",q:".image img"},{u:["||imagecurl.com/images/","||imagecurl.com/viewer.php"],r:/(?:images\/(\d+)_thumb|file=(\d+))(\.\w+)/,s:"https://imagecurl.com/images/$1$2$3"},{u:"||imagebam.com/",r:/^(https:\/\/)thumbs\d+(\.imagebam\.com\/).*?([^/]+)_t\./,s:"$1www$2view/$3",q:"img.main-image"},{u:"||www.imagebam.com/view/",q:"img.main-image"},{u:"||imageban.ru/thumbs",r:/(.+?\/)thumbs(\/\d+)\.(\d+)\.(\d+\/.*)/,s:"$1out$2/$3/$4"},{u:["||imageban.ru/show","||imageban.net/show","||ibn.im/"],q:"#img_main"},{u:"||imageshack.us/img",r:/img(\d+)\.(imageshack\.us)\/img\\1\/\d+\/(.+?)\.th(.+)$/,s:"https://$2/download/$1/$3$4"},{u:"||imageshack.us/i/",q:"#share-dl"},{u:"||imageteam.org/img",q:'img[alt="image"]'},{u:["||imagetwist.com/","||imageshimage.com/"],r:/(\/\/|^)[^/]+\/[a-z0-9]{8,}/,q:"img.pic",xhr:!0},{u:"||imageupper.com/i/",q:"#img",xhr:!0},{u:"||imagevenue.com/",q:'a[data-toggle="full"] img'},{u:"||imagezilla.net/show/",q:"#photo",xhr:!0},{u:["||images-na.ssl-images-amazon.com/images/","||media-imdb.com/images/"],r:/images\/.+?\.jpg/,s:"/V1\\.?_.+?\\.//g"},{u:"||imgbox.com/",r:/\.com\/([a-z0-9]+)$/i,q:"#img",xhr:"imgbox.com"!==hostname},{u:"||imgclick.net/",r:/\.net\/(\w+)/,q:"img.pic",xhr:!0,post:e=>`op=view&id=${e[1]}&pre=1&submit=Continue%20to%20image...`},{u:".imgcredit.xyz/",r:/^https?(:.*\.xyz\/\d[\w/]+)\.md(.+)/,s:["https$1$2","https$1.png"]},{u:["||imgflip.com/i/","||imgflip.com/gif/"],r:/\/(i|gif)\/([^/?#]+)/,s:e=>`https://i.imgflip.com/${e[2]}${"i"===e[1]?".jpg":".mp4"}`},{u:["||imgur.com/a/","||imgur.com/gallery/"],s:"gallery",async g(){let e=`https://imgur.com/ajaxalbums/getimages/${ai.url.split(/[/?#]/)[4]}/hit.json?all=true`,t=tryJSON((await Req.gmXhr(e)).responseText)||0,o=(t.data||0).images||[];o[0]||(t=(await Req.gmXhr(ai.url)).responseText.match(/postDataJSON=(".*?")<|$/)[1],t=tryJSON(tryJSON(t))||0,o=t.media);const n=[];for(const t of o){const o=t.metadata||t;n.push({url:t.url||(e=`https://i.imgur.com/${t.hash}`)&&(".gif"===t.ext&&!1!==t.animated?[`${e}.webm`,`${e}.mp4`,e]:e+t.ext),desc:[o.title,o.description].filter(Boolean).join(" - ")})}return n[0]&&t.title&&!`${n[0].desc||""}`.includes(t.title)&&(n.title=t.title),n}},{u:"||imgur.com/",r:/((?:[a-z]{2,}\.)?imgur\.com\/)((?:\w+,)+\w*)/,s:"gallery",g:(e,t,o,n)=>n[2].split(",").map((e=>({url:`https://i.${n[1]}${e}.jpg`})))},{u:"||imgur.com/",r:/([a-z]{2,}\.)?imgur\.com\/(r\/[a-z]+\/|[a-z0-9]+#)?([a-z0-9]{5,})($|\?|\.(mp4|[a-z]+))/i,s:(e,t)=>{if(/memegen|random|register|search|signin/.test(e.input))return"";const o=t.closest("a");if(o&&o!==t&&/(i\.([a-z]+\.)?)?imgur\.com\/(a\/|gallery\/)?/.test(o.href))return!1;const n=e[3].replace(/(.{7})[hlmtbs]$/,"$1"),i=e[5]?e[5].replace(/gifv?/,"webm"):"jpg",a=`https://i.${(e[1]||"").replace("www.","")}imgur.com/${n}.`;return"webm"===i?[`${a}webm`,`${a}mp4`,`${a}gif`]:a+i}},{u:["||instagr.am/p/","||instagram.com/p/","||instagram.com/tv/"],s:e=>e.input.substr(0,e.input.lastIndexOf("/")).replace("/liked_by","")+"/?__a=1&__d=dis",q:e=>(e=tryJSON(e))&&(e=pick(e,"graphql.shortcode_media")||pick(e,"items.0")||0)&&(e.video_url||e.display_url||pick(e,"video_versions.0.url")||pick(e,"carousel_media.0.image_versions2.candidates.0.url")||pick(e,"image_versions2.candidates.0.url")),rect:"div.PhotoGridMediaItem",c:e=>(e=tryJSON(e))&&(pick(e,"items.0.caption.text")||pick(e,"graphql.shortcode_media.edge_media_to_caption.edges.0.node.text")||"")},{u:["||livememe.com/","||lvme.me/"],r:/\.\w+\/([^.]+)$/,s:"http://i.lvme.me/$1.jpg"},{u:"||lostpic.net/image",q:".image-viewer-image img"},{u:"||makeameme.org/meme/",r:/\/meme\/([^/?#]+)/,s:"https://media.makeameme.org/created/$1.jpg"},{u:"||photobucket.com/",r:/(\d+\.photobucket\.com\/.+\/)(\?[a-z=&]+=)?(.+\.(jpe?g|png|gif))/,s:"https://i$1$3",xhr:!dotDomain.endsWith(".photobucket.com")},{u:"||piccy.info/view3/",r:/(.+?\/view3)\/(.*)\//,s:"$1/$2/orig/",q:"#mainim"},{u:"||pimpandhost.com/image/",r:/(.+?\/image\/[0-9]+)/,s:"$1?size=original",q:"img.original"},{u:["||pixroute.com/","||imgspice.com/"],r:/\.html$/,q:"img[id]",xhr:!0},{u:"||postima",r:/postima?ge?\.org\/image\/\w+/,q:['a[href*="dl="]',"#main-image"]},{u:["||prntscr.com/","||prnt.sc/"],r:/\.\w+\/.+/,q:'meta[property="og:image"]',xhr:!0},{u:"||radikal.ru/",r:/\.ru\/(fp|.+?\.html)|^(.+?)t\.jpg/,s:(e,t,o)=>e[2]&&/radikal\.ru[\w%/]+?(\.\w+)/.test($propUp(t,"href"))?e[2]+RegExp.$1:Ruler.toggle(o,"q",e[1])?e.input:[e[2]+".jpg",e[2]+".png"],_q:e=>e.match(/https?:\/\/\w+\.radikal\.ru[\w/]+\.(jpg|gif|png)/i)[0]},{u:"||tumblr.com",r:/_500\.jpg/,s:["/_500/_1280/",""]},{u:"||twimg.com/media/",r:/.+?format=(jpe?g|png|gif)/i,s:"$0&name=orig"},{u:"||twimg.com/media/",r:/.+?\.(jpe?g|png|gif)/i,s:"$0:orig"},{u:"||twimg.com/1/proxy",r:/t=([^&_]+)/i,s:e=>atob(e[1]).match(/http.+/)},{u:"||twimg.com/",r:/\/profile_images/i,s:"/_(reasonably_small|normal|bigger|\\d+x\\d+)\\././g"},{u:"||pic.twitter.com/",r:/\.com\/[a-z0-9]+/i,q:e=>e.match(/https?:\/\/twitter\.com\/[^/]+\/status\/\d+\/photo\/\d+/i)[0],follow:!0},{u:"||twitpic.com/",r:/\.com(\/show\/[a-z]+)?\/([a-z0-9]+)($|#)/i,s:"https://twitpic.com/show/large/$2"},{u:"||wiki",r:/\/(?:thumb|images)\/.+\.(?:jpe?g|gif|png|svg)/i,s:e=>e.input.replace(/\/(thumb(?=\/)|\d+px[^/]+(?=$|\?))/g,"").replace(/\/(scale-to-width(-[a-z]+)?\/\d+|(zoom-crop|smart)(\/(width|height)\/\d+)+)/g,"/"),xhr:!hostname.includes("wiki")},{u:"||ytimg.com/vi/",r:/(.+?\/vi\/[^/]+)/,s:"$1/0.jpg",rect:".video-list-item"},{u:"/viewer.php?file=",r:/(.+?)\/viewer\.php\?file=(.+)/,s:"$1/images/$2",xhr:!0},{u:"/thumb_",r:/\/albums.+\/thumb_[^/]/,s:"/thumb_//"},{u:[".th.jp",".th.gif",".th.png"],r:/(.+?\.)th\.(jpe?g?|gif|png|svg|webm)$/i,s:"$1$2",follow:!0},{r:RX_MEDIA_URL})},format(e,{expand:t}={}){const o=Util.stringify(e,null," ");return t?o.replace(/^{\s+/g,"{"):o.replace(/\n\s*/g," ").replace(/^({)\s|\s+(})$/g,"$1$2")},fromElement(e){const t=e.textContent.trim();if(t.startsWith("{")&&t.endsWith("}")&&/[{,]\s*"[degqrsu]"\s*:\s*"/.test(t)){const e=tryJSON(t);return e&&Object.keys(e).some((e=>/^[degqrsu]$/.test(e)))&&e}},isValidE2:([e,t])=>e.trim()&&"string"==typeof t&&t.trim(),parse(e){const t=this instanceof Map;try{if("string"==typeof e&&(e=JSON.parse(e)),"d"in e&&"string"!=typeof e.d)e.d=void 0;else if(t&&e.d&&!hostname.includes(e.d))return!1;let{e:o}=e;if(null!=o){if(o="string"==typeof o?o.trim():isArray(o)?o.join(",").trim():Object.entries(o).every(Ruler.isValidE2)&&o,!o)throw new Error('Invalid syntax for "e". Examples: "e": ".image" or "e": [".image1", ".image2"] or "e": {".parent": ".image"} or "e": {".parent1": ".image1", ".parent2": ".image2"}');t&&(e.e=o||void 0)}let n=t?e:{};e.r&&(n.r=new RegExp(e.r,"i")),App.NOP&&(n={});for(const o of Object.keys(FN_ARGS))if(RX_HAS_CODE.test(e[o])){const i=Util.newFunction(...FN_ARGS[o],e[o]);i===App.NOP&&t?t&&this.set(e,"unsafe-eval"):n[o]=i}return e}catch(o){return t?(this.set(e,o),e):o}},runC(e,t=document){const o=Ruler.runCHandler[typeof ai.rule.c]||Ruler.runCHandler.default;ai.caption=o(e,t)},runCHandler:{function:(e,t)=>ai.rule.c(e||t.documentElement.outerHTML,t,ai.node,ai.rule),string:(e,t)=>{const o=$many(ai.rule.c,t);return o?o.getAttribute("content")||o.getAttribute("title")||o.textContent:""},default:(e,t,o=ai.node)=>(ai.tooltip||0).text||o.alt||$propUp(o,"title")||Req.getFileName(o.tagName===(ai.popup||0).tagName?ai.url:o.src||$propUp(o,"href"))},runQ(e,t,o){let n;if(isFunction(ai.rule.q))n=ai.rule.q(e,t,ai.node,ai.rule),isArray(n)&&(ai.urls=n.slice(1),n=n[0]);else{const e=$many(ai.rule.q,t);n=Req.findImageUrl(e,o)}return n},runE(e,t,o){let n,i,a,r;for(const s in t)if((n=o.closest(s))&&(i=$(t[s],n)))if(i===o)a=!0;else if(r=RuleMatcher.adaptiveFind(i,{rules:[e]}))return r;return a},runS(e,t,o){let n,i=[];for(const n of ensureArray(t.s))i.push("string"==typeof n?Util.decodeUrl(Ruler.substituteSingle(n,o)):isFunction(n)?n(o,e,t):n);if(!(t.q&&i.length>1))return isArray(n=i[0])&&(n=i=n),""===n?i:n&&arrayFrom(new Set(i),Util.decodeUrl);console.warn('Rule discarded: "s" array is not allowed with "q"\n%o',t)},runU(e,t){const o=e[SYM_U]||(e[SYM_U]=UrlMatcher(e.u));return o.fn.call(o.data,t)},substituteSingle(e,t){if(!t||null==t.input)return e;if(e.startsWith("/")&&!e.startsWith("//")){const o=e.search(/[^\\]\//)+1,n=e.lastIndexOf("/"),i=new RegExp(e.slice(1,o),e.slice(n+1));return t.input.replace(i,e.slice(o+1,n))}if(t.length&&e.includes("$")){const o=Math.floor(Math.log10(t.length))+1;e=e.replace(/\$(\d{1,3})/g,((e,n)=>{for(let e=o;e>=0;e--){const o=0|n.slice(0,e);if(o<t.length)return(t[o]||"")+n.slice(e)}return e}))}return e},toggle:(e,t,o)=>(e[t]=o?e[`_${t}`]:null,o)},RuleMatcher={adaptiveFind(e,t){const o=e.tagName,n=e.currentSrc||e.src||"",i="IMG"===o||"VIDEO"===o&&Util.isVideoUrlExt(n);let a,r,s;if("A"!==o&&(s=i&&!n.startsWith("data:")&&Util.rel2abs(n),r=RuleMatcher.find(s,e,t)),!r&&(a=e.closest("A"))){const e=a.dataset;s=e.expandedUrl||e.fullUrl||e.url||a.href||"",s=s.includes("//t.co/")?"https://"+a.textContent:s,s=!s.startsWith("data:")&&s,r=RuleMatcher.find(s,a,t)}return!r&&i&&(r={node:e,rule:{},url:n}),r},find(e,t,{noHtml:o,rules:n,skipRules:i}={}){let a,r,s,l;for(const c of n||Ruler.rules){let p,u;if(i&&i.includes(c)||c.u&&(!e||!Ruler.runU(c,e))||!n&&(p=c.e)&&!(u="string"==typeof p?t.matches(p):Ruler.runE(c,p,t)))continue;if(u&&u.url)return u;const{r:d,s:m}=c;let g=null!=m;if(l=!(o&&c===ai.rule)&&(d||g)&&c.html&&(s||(s=t.outerHTML)),d?u=l?d.exec(l):e&&d.exec(e):(u=[""],u[0]=u.input=l||e||"",u.index=0),!u)continue;if(""===m)return{};if(!g&&!i&&(a?r:r="IMG"===(a=t.tagName)||"VIDEO"===a))continue;g&="gallery"!==m;const h=g?Ruler.runS(t,c,u):[u.input];if(h)return RuleMatcher.makeInfo(g,c,u,t,i,h)}},makeInfo(e,t,o,n,i,a){let r,s=`${a[0]}`;const l=s&&e&&!t.q&&RuleMatcher.isFollowableUrl(s,t);if(s?s=Util.rel2abs(s):r={},l&&(r=RuleMatcher.find(s,n,{skipRules:[...i||[],t]})),!r&&(!l||RX_MEDIA_URL.test(s))){const e=cfg.xhr&&t.xhr;r={match:o,node:n,rule:t,url:s,urls:a.length>1?a.slice(1):null,gallery:t.g&&Gallery.makeParser(t.g),post:isFunction(t.post)?t.post(o):t.post,xhr:null!=e?e:isSecureContext&&!s.startsWith(location.protocol)}}return r},isFollowableUrl(e,t){const o=t.follow;return isFunction(o)?o(e):o}},Req={gmXhr:(e,t={})=>(ai.req&&tryCatch(ai.req.abort),new Promise(((o,n)=>{const{anonymous:i}=ai.rule||{};function a(t){ai.req=null,t.status<400&&!t.error?o(t):n(`Server error ${t.status} ${t.error}\nURL: ${e}`)}ai.req=GM.xmlHttpRequest(Object.assign({url:e,anonymous:i,withCredentials:!i,method:"GET",timeout:3e4},t,{onload:a,onerror:a,ontimeout(){ai.req=null,n(`Timeout fetching ${e}`)}}))}))),async getDoc(e){if(!e)return{doc:doc,finalUrl:location.href,responseText:doc.documentElement.outerHTML};const t=await(ai.post?Req.gmXhr(e,{method:"POST",data:ai.post,headers:{"Content-Type":"application/x-www-form-urlencoded",Referer:e}}):Req.gmXhr(e));return t.doc=$parseHtml(t.responseText),t},async getImage(e,t,o=ai.xhr){ai.bufBar=!1,ai.bufStart=now();const n=await Req.gmXhr(e,{responseType:"blob",headers:{Accept:"image/png,image/*;q=0.8,*/*;q=0.5",Referer:t||(isFunction(o)?o():e)},onprogress:Req.getImageProgress});Bar.set(!1);const i=Req.guessMimeType(n);let a=n.response;if(!a)throw"Empty response";a.type!==i&&(a=a.slice(0,a.size,i));return["blob"===o?ai.blobUrl=URL.createObjectURL(a):await Req.blobToDataUrl(a),i.startsWith("video")]},getImageProgress(e){if(!ai.bufBar&&now()-ai.bufStart>3e3&&e.loaded/e.total<.5&&(ai.bufBar=!0),ai.bufBar){const t=e.loaded/e.total*100|0,o=e.total/1024|0;Bar.set(`${t}% of ${o} kiB`,"xhr")}},async findRedirect(){try{const{finalUrl:e}=await Req.gmXhr(ai.url,{method:"HEAD",headers:{Referer:location.href.split("#",1)[0]}}),t=RuleMatcher.find(e,ai.node,{noHtml:!0});if(!t||!t.url)throw`Couldn't follow redirection target: ${e}`;Object.assign(ai,t),App.startSingle()}catch(e){App.handleError(e)}},async saveFile(){const e=ai.popup.src||ai.popup.currentSrc;let t=Req.getFileName(ai.imageUrl||e);if(t.includes(".")||(t+=".jpg"),e.startsWith("blob:")||e.startsWith("data:"))$new("a",{href:e,download:t}).dispatchEvent(new MouseEvent("click"));else{Status.set("+loading");const o=()=>Status.set("-loading"),n="function"==typeof GM_download;(n?GM_download:GM.xmlHttpRequest)({url:e,name:t,headers:{Referer:e},method:"get",responseType:"blob",overrideMimeType:"application/octet-stream",onerror:e=>{Bar.set(`Could not download ${t}: ${e.error||e.message||e}.`,"error"),o()},onprogress:Req.getImageProgress,onload({response:e}){if(o(),!n){const o=Object.assign(document.createElement("a"),{href:URL.createObjectURL(e),download:t});o.dispatchEvent(new MouseEvent("click")),setTimeout(URL.revokeObjectURL,1e4,o.href)}}})}},getFileName:e=>decodeURIComponent(e).split(/[#?&]/,1)[0].split("/").pop(),blobToDataUrl:e=>new Promise(((t,o)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=o,n.readAsDataURL(e)})),guessMimeType({responseHeaders:e,finalUrl:t}){if(/Content-Type:\s*(\S+)/i.test(e)&&!RegExp.$1.includes("text/plain"))return RegExp.$1;switch((Util.extractFileExt(t)||"jpg").toLowerCase()){case"bmp":return"image/bmp";case"gif":return"image/gif";case"jpe":case"jpeg":case"jpg":return"image/jpeg";case"mp4":return"video/mp4";case"png":return"image/png";case"svg":return"image/svg+xml";case"tif":case"tiff":return"image/tiff";case"webm":return"video/webm";default:return"application/octet-stream"}},findImageUrl(e,t){if(!e)return;let o;const n=e.getAttribute("data-src")||e.getAttribute("src")||e.getAttribute("data-m4v")||e.getAttribute("href")||e.getAttribute("content")||(o=e.outerHTML).includes("http")&&o.match(/https?:\/\/[^\s"<>]+?\.(jpe?g|gif|png|svg|web[mp]|mp4)[^\s"<>]*|$/i)[0];return!!n&&Util.rel2abs(Util.decodeHtmlEntities(n),$prop("base[href]","href",e.ownerDocument)||t)}},Status={set(e){if(!e&&!cfg.globalStatus)return void(ai.node&&ai.node.removeAttribute(STATUS_ATTR));const t=cfg.globalStatus?PREFIX:"",o=e&&/^[+-]/.test(e)&&e[0],n=e&&`${t}${o?e.slice(1):e}`,i=cfg.globalStatus?doc.documentElement:"edge"===n?ai.popup:ai.node;if(!i)return;const a=cfg.globalStatus?"class":STATUS_ATTR,r=(i.getAttribute(a)||"").trim(),s=new Set(r?r.split(/\s+/):[]);switch(o){case"-":s.delete(n);break;case!1:for(const e of s)e.startsWith(t)&&e!==n&&s.delete(e);case"+":n&&s.add(n)}const l=[...s].join(" ");l!==r&&i.setAttribute(a,l)},loading(e){e?ai.popupLoaded||Status.set("+loading"):(clearTimeout(ai.timerStatus),ai.timerStatus=setTimeout(Status.loading,50,!0))}},UrlMatcher=(()=>{const e=/[.+*?(){}[\]^$|]/g,t=/[^\w%._-]/y,o=t.source;return t=>{const i=[];for(const n of ensureArray(t)){const t=n.startsWith("||"),r=!t&&n.startsWith("|"),d=n.endsWith("^");let m,g=n.slice(2*t+r,-d||void 0);if(g.includes("^")){let n="";for(const e of g.split("^"))e.length>n.length&&(n=e);const i=new RegExp((r?"^":"")+(t?"^(([^/:]+:)?//)?([^./]*\\.)*?":"")+g.replace(e,"\\$&").replace(/\\\^/g,o)+(d?`(?:${o}|$)`:""),"i");g=[n,i],m=c}else if(r)m=d?s:p;else if(t){const e=g.indexOf("/"),t=e>0?g.slice(0,e):g;g=[g,t,e>0,d],m=u}else m=d?a:l;i.push({fn:m,data:g})}return i.length>1?{fn:n,data:i}:i[0]};function n(e){return this.some(i,e)}function i(e){return e.fn.call(e.data,this)}function a(e){return e.endsWith(this)||e.length>this.length&&e.indexOf(this,e.length-this.length-1)>=0&&r(e)}function r(e,o=e.length-1){return t.lastIndex=o,t.test(e)}function s(e){return e.startsWith(this)&&(e.length===this.length||e.length===this.length+1&&r(e))}function l(e){return e.includes(this)}function c(e){return e.includes(this[0])&&this[1].test(e)}function p(e){return e.startsWith(this)}function u(e){return e.includes(this[0])&&d.call(this,e)}function d(e){let t=e.indexOf("//");if(t&&":"!==e[t-1])return;t=t<0?0:t+2;const o=e.slice(t,(e.indexOf("/",t)+1||e.length+1)-1),[n,i,a,s]=this;let l=a?o.length-i.length:0;for(;;l++){if(l=o.indexOf(i,l),l<0)return;if(!l||"."===o[l-1])break}if(l+=t,e.lastIndexOf(n,l)!==l)return;const c=l+n.length;return!s||c===o.length||c===e.length||r(e,c)}})(),Util={addStyle(e,t){const o=`${PREFIX}style:${e}`,n=doc.getElementById(o)||t&&$new("style",{id:o});if(n)return n.textContent!==t&&(n.textContent=t),n.parentElement!==doc.head&&doc.head.appendChild(n),n},color:(e,t=cfg[`ui${e}Opacity`])=>(e.startsWith("#")?e:cfg[`ui${e}Color`])+(256+Math.round(t/100*255)).toString(16).slice(1),decodeHtmlEntities:e=>e.replace(/&quot;/g,'"').replace(/&apos;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),decodeUrl(e){if(!e||"string"!=typeof e)return e;const t=e.indexOf("%"),o=e.indexOf(":");return t>=0&&(t<o||o<0)?decodeURIComponent(e):e},deepEqual(e,t){if(!e||!t||"object"!=typeof e||typeof e!=typeof t)return e===t;if(isArray(e))return isArray(t)&&e.length===t.length&&e.every(((e,o)=>Util.deepEqual(e,t[o])));const o=Object.keys(e);return o.length===Object.keys(t).length&&o.every((o=>Util.deepEqual(e[o],t[o])))},extractFileExt:e=>(e=RX_MEDIA_URL.exec(e))&&e[1],forceLayout(e){e.clientHeight},formatError(e,t){const o=isArray(e),n=o?e[0]:e.message,{url:i,imageUrl:a}=ai;let r;e=n?e:(e.readyState?"Request failed.":"error"===e.type&&"File can't be displayed."+($('div[bgactive*="flashblock"]',doc)?" Check Flashblock settings.":""))||e;const s=[r="%c%s%c","font-weight:bold",o?n:e,"font-weight:normal",(r+="\nNode: %o",ai.node),(r+="\nRule: %o",t),i&&(r+="\nURL: %s",i),a&&a!==i&&(r+="\nFile: %s",a),...o?(r+=e[1],e.slice(2)):[],e.stack].filter(Boolean);return s[0]=r,s.message=n||e,s},getReactChildren(e,t){isFF&&(e=e.wrappedJSObject||e);for(const o of Object.keys(e))if("string"==typeof o&&o.startsWith("__reactProps"))return(e=e[o].children)&&(t?pick(e,t):e)},isVideoUrl:e=>e.startsWith("data:video")||Util.isVideoUrlExt(e),isVideoUrlExt:e=>(e=Util.extractFileExt(e))&&/^(webm|mp4)$/i.test(e),newFunction(...e){try{return App.NOP||(trustedScript?window.eval(trustedScript(`(function anonymous(${e.slice(0,-1).join(",")}){${e.slice(-1)[0]}})`)):new Function(...e))}catch(e){if(!RX_EVAL_BLOCKED.test(e.message))throw e;return App.NOP=()=>{},App.NOP}},rel2abs(e,t=location.href){try{return/^(data:|blob:|[-\w]+:\/\/)/.test(e)?e:new URL(e,t).href}catch(t){return e}},stringify(...e){const t=Array.prototype,{toJSON:o}=t;o&&(t.toJSON=null);const n=JSON.stringify(...e);return o&&(t.toJSON=o),n},suppressTooltip(){for(const e of[ai.node.parentNode,ai.node,ai.node.firstElementChild]){const t=(e||0).title;if(t&&t!==e.textContent&&!doc.title.includes(t)&&!/^https?:\S+$/.test(t)){ai.tooltip={node:e,text:t},e.title="";break}}},tabFixUrl(){const{tabfix:e=App.tabfix}=ai.rule;return e&&"IMG"===ai.popup.tagName&&!ai.xhr&&flattenHtml(`data:text/html;charset=utf8,\n      <style>\n        body {\n          margin: 0;\n          padding: 0;\n          background: #222;\n        }\n        .fit {\n          overflow: hidden\n        }\n        .fit > img {\n          max-width: 100vw;\n          max-height: 100vh;\n        }\n        body > img {\n          margin: auto;\n          position: absolute;\n          left: 0;\n          right: 0;\n          top: 0;\n          bottom: 0;\n        }\n      </style>\n      <body class=fit>\n        <img onclick="document.body.classList.toggle('fit')" src="${ai.popup.src}">\n      </body>\n    `).replace(/\x20?([:>])\x20/g,"$1").replace(/#/g,"%23")}};async function setup({rule:e}={}){if(!isFunction(doc.body.attachShadow))return void alert("Cannot show MPIV config dialog: the browser is probably too old.\nYou can edit the script's storage directly in your userscript manager.");const t=setup.RULE||(setup.RULE=Symbol("rule"));let o,n,i=(elSetup||0).shadowRoot,{blankRuleElement:a}=setup,r=0,s=0,l=0,c=0;const p=setup.UI=new Proxy({},{get:(e,t)=>i.getElementById(t)});function u(e){o=e,function(){for(const e of $$("input[id], select[id], textarea[id]",i))e.id in o&&(e["checkbox"===e.type?"checked":"value"]=o[e.id]);for(const e of $$('input[type="range"]',i))e.oninput();for(const e of $$('a[href^="http"]',i))Object.assign(e,{target:"_blank",rel:"noreferrer noopener external"});p.delay.valueAsNumber=o.delay/1e3,p.scale.valueAsNumber=Math.round(100*clamp(o.scale-1,0,1)),p.start.onchange()}(),b(),function(){const e=p._rules;e.addEventListener("input",h),e.addEventListener("focusin",f),e.addEventListener("paste",f),a=setup.blankRuleElement=setup.blankRuleElement||e.firstElementChild.cloneNode(),a.nextElementSibling&&(e.textContent="",e.appendChild(a.cloneNode()));for(const t of o.hosts||[]){const o=a.cloneNode();o.value="string"==typeof t?t:Ruler.format(t),e.appendChild(o),h({target:o})}const t=p._search;t.oninput=()=>{setup.search=t.value;const o=t.value.toLowerCase();for(const t of e.children)t.hidden=o&&!t.value.toLowerCase().includes(o)},t.value=setup.search||"",t.value&&t.oninput()}(),requestAnimationFrame((()=>{p.css.style.minHeight=clamp(p.css.scrollHeight,40,elSetup.clientHeight/4)+"px"}))}function d(e){const t="_apply"===this.id;if(e&&("_ok"===this.id||t)&&(cfg=o=m({save:!0,clone:t}),Ruler.init(),Menu.reRegisterAlt(),t))return b();$remove(elSetup),elSetup=null}function m({save:e,clone:t}={}){let o={};for(const e of $$("input[id], select[id]",i))o[e.id]="checkbox"===e.type?e.checked:"number"===e.type||"range"===e.type?e.valueAsNumber:e.value||"";return Object.assign(o,{css:p.css.value.trim(),delay:1e3*p.delay.valueAsNumber,hosts:g(),scale:clamp(p.scale.valueAsNumber/100,0,1)+1,scales:p.scales.value.trim().split(/[,;]*\s+/).map((e=>e.replace(",","."))).filter((e=>!isNaN(parseFloat(e))))}),t&&(o=JSON.parse(Util.stringify(o))),new Config({data:o,save:e})}function g(){return[...p._rules.children].map((e=>[e.value.trim(),e[t]])).sort(((e,t)=>e[0]<t[0]?-1:e[0]>t[0]?1:0)).map((([e,t])=>t||e)).filter(Boolean)}function h({target:e}){let o,n,i;const r=e.previousElementSibling;if(e.value){o=Ruler.parse(e.value),n=o instanceof Error&&(o.message||String(o));const t=!n&&o&&"string"==typeof o.d&&!/^[-.a-z0-9]*$/i.test(o.d);i=[t&&'Disabled due to invalid characters in "d"',n].filter(Boolean).join("\n"),e.classList.toggle("invalid-domain",t),e.classList.toggle("matching-domain",!!o.d&&hostname.includes(o.d)),r||e.insertAdjacentElement("beforebegin",a.cloneNode())}else r&&(r.focus(),e.remove());e[t]=!n&&o,e.title=i,e.setCustomValidity(n||"")}async function f({target:e,relatedTarget:o}){if(e!==this){if(await new Promise(setTimeout),e[t]&&e.rows<2){let o=e.selectionStart;const n=e.value=Ruler.format(e[t],{expand:!0});o+=n.slice(0,o).match(/^\s*/gm).reduce(((e,t)=>e+t.length),0),e.setSelectionRange(o,o),e.rows=n.match(/^/gm).length}this.contains(o)||(o=[...$$('[style*="height"]',this)].find((t=>t!==e)))}}function b(){p.scales.value=o.scales.join(" ").trim()||Config.DEFAULTS.scales.join(" "),p._css.textContent=cfg._getCss()}elSetup||(elSetup=$new("div",{contentEditable:!0}),i=elSetup.attachShadow({mode:"open"}),i.append(...createSetupElement()),function(){p._mover.onmousedown=e=>{e.button||eventModifiers(e)||(n||(n=p._cssSetup.sheet,n.insertRule(":host {}"),n=n.cssRules[1]),addEventListener("mousemove",t,!0),addEventListener("mouseup",o,!0),addEventListener("keydown",a,!0),r=e.x-l,s=e.y-c,$css(n,{opacity:.75}))},p._apply.onclick=p._cancel.onclick=p._ok.onclick=p._x.onclick=d,p._export.onclick=e=>{dropEvent(e),GM.setClipboard(Util.stringify(m(),null,"  ")),p._exportNotification.hidden=!1,setTimeout((()=>p._exportNotification.hidden=!0),1e3)},p._import.onclick=e=>{dropEvent(e);const t=prompt("Paste settings:");t&&u(new Config({data:t}))},p._install.onclick=setupRuleInstaller;const e=p._cssApp;p._reveal.onclick=t=>{t.preventDefault(),e.hidden=!e.hidden,e.hidden||(e.value||(App.updateStyles(),e.value=App.globalStyle.trim(),e.setSelectionRange(0,0)),e.focus())},p.start.onchange=function(){p["mpiv-setup"].dataset.start=this.value},p.xhr.onclick=({target:e})=>e.checked||confirm($propUp(e,"title"));for(const e of $$('[type="color"]',i))e.oninput=g,e.elSwatch=e.nextElementSibling,e.elOpacity=p[e.id.replace("Color","Opacity")],e.elOpacity.elColor=e;function t({x:e,y:t}){e=l=clamp(e-r,-innerWidth+4*CSS_SETUP_X,elSetup.clientWidth-CSS_SETUP_X),t=c=clamp(t-s,0,innerHeight-3*CSS_SETUP_X),$css(n,{transform:`translate(${e}px, ${t}px)`}),p._ul.style.maxHeight=`calc(100vh - ${CSS_SETUP_MAX_Y+t-CSS_SETUP_X}px)`}function o(){removeEventListener("mousemove",t,!0),removeEventListener("mouseup",o,!0),removeEventListener("keydown",a,!0),$css(n,{opacity:""})}function a(e){"Escape"!==e.key||eventModifiers(e)||(e.stopPropagation(),t({x:r,y:s}),o())}function g(){this.elSwatch.style.setProperty("--color",Util.color(this.value,this.elOpacity.valueAsNumber))}for(const e of $$('[type="range"]',i))e.oninput=b,e.onblur=h,e.addEventListener("focusin",f);function h(e){this.elEdit&&e.relatedTarget!==this.elEdit&&this.elEdit.onblur(e)}function f(){if(this.elEdit)return;const{min:e,max:t,step:o,value:n}=this;this.elEdit=$new("input",{value:n,min:e,max:t,step:o,className:"range-edit",style:`left: ${this.offsetLeft}px; margin-top: ${this.offsetHeight+1}px`,type:"number",elRange:this,onblur:w,oninput:y}),this.insertAdjacentElement("afterend",this.elEdit)}function b(){this.title=(this.dataset.title||"").replace("$",this.value),this.elColor&&this.elColor.oninput(),this.elEdit&&(this.elEdit.valueAsNumber=this.valueAsNumber)}function w(e){e.relatedTarget!==this.elRange&&(this.remove(),this.elRange.elEdit=null)}function y(){this.elRange.valueAsNumber=this.valueAsNumber,this.elRange.oninput()}i.addEventListener("keydown",(e=>!e.altKey&&!e.metaKey&&e.stopPropagation()),!0)}()),elSetup.parentElement!==doc.body&&(u(await Config.load({save:!0})),doc.body.append(elSetup)),e&&function(e){const o=p._rules.children;let n=[...o].find((o=>Util.deepEqual(o[t],e)));if(!n){n=o[0],n[t]=e,n.value=Ruler.format(e),n.hidden=!1;o[Math.max(0,g().indexOf(e))].insertAdjacentElement("afterend",n),o[0].insertAdjacentElement("beforebegin",a.cloneNode())}const i=n.getBoundingClientRect();(i.bottom<0||i.bottom>n.parentNode.offsetHeight)&&n.scrollIntoView();n.classList.add("highlight"),n.addEventListener("animationend",(()=>n.classList.remove("highlight")),{once:!0}),n.focus()}(e)}function setupClickedRule(e){let t;const o=e.target.closest("blockquote, code, pre");o&&!e.button&&!eventModifiers(e)&&(t=Ruler.fromElement(o))&&(dropEvent(e),setup({rule:t}))}async function setupRuleInstaller(e){dropEvent(e);const t=setup.UI._rules2;let o;this.disabled=!0,this.textContent="Loading...";try{o=function({doc:e}){return[...$$("#wiki-body tr",e)].map((e=>[e.cells[0].textContent.trim(),Ruler.fromElement(e.cells[1])])).filter((([e,t])=>e&&t&&(!t.d||hostname.includes(t.d)))).sort((([e],[t])=>(e=e.toLowerCase())<(t=t.toLowerCase())?-1:e>t?1:0))}(await Req.getDoc(this.parentElement.href)),this.textContent="Rules loaded.";const e=$new("select",{size:8,style:"width: 100%",ondblclick:t=>t.target!==e&&i(t),onkeyup:e=>"Enter"===e.key&&i(e)},o.map((function([e,t]){return $new("option",{textContent:e,title:Ruler.format(t,{expand:!0}).replace(/^{|\s*}$/g,"").split("\n").slice(0,12).map(n).filter(Boolean).join("\n")})}))),a=e.selectedIndex=function(){const e=`.${hostname}.`;let t=0,n=0,i=0;for(const[a,{d:r}]of o){let o=10*!(!r||!hostname.includes(r));for(const t of a.toLowerCase().split(/[^a-z\d.-]+/i))o+=e.includes(`.${t}.`)&&t.length;o>t&&(t=o,n=i),i++}return n}();t.append($new("div#_installHint",["Double-click the rule (or select and press Enter) to add it. ","Click ",$new("code","Apply")," or ",$new("code","OK")," to confirm."]),e),a&&requestAnimationFrame((()=>{const t=e.selectedOptions[0].offsetTop-e.offsetTop;e.scrollTo(0,t-e.offsetHeight/2)})),e.focus()}catch(e){t.textContent="Error loading rules: "+(e.message||e)}function n(e,t,o){return 9===t&&o.length>10?"...":t>10?"":(e.length>100?e.slice(0,100)+"...":e).replace(/^\s/,"")}function i(e){eventModifiers(e)||setup({rule:o[e.currentTarget.selectedIndex][1]})}}const CSS_SETUP_X=20,CSS_SETUP_MAX_Y=200,CSS_SETUP=`\n  :host {\n    all: initial !important;\n    position: fixed !important;\n    z-index: 2147483647 !important;\n    top: ${CSS_SETUP_X}px !important;\n    right: 20px !important;\n    padding: 1.5em !important;\n    color: #000 !important;\n    --bg: #eee;\n    background: var(--bg) !important;\n    box-shadow: 5px 5px 25px 2px #000 !important;\n    width: 33em !important;\n    border: 1px solid black !important;\n    display: flex !important;\n    flex-direction: column !important;\n  }\n  main {\n    font: 12px/15px sans-serif;\n  }\n  main:not([data-start=auto]) [data-start-auto] {\n    opacity: .5;\n  }\n  table {\n    text-align:left;\n  }\n  ul {\n    min-height: 430px;\n    max-height: calc(100vh - ${CSS_SETUP_MAX_Y}px);\n    margin: 0 0 15px 0;\n    padding: 0;\n    list-style: none;\n  }\n  li {\n    margin: 0;\n    padding: .25em 0;\n  }\n  li.options {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n  }\n  li.row {\n    align-items: start;\n    flex-wrap: wrap;\n  }\n  li.row label {\n    display: flex;\n    flex-direction: row;\n    align-items: center;\n  }\n  li.row input {\n    margin-right: .25em;\n  }\n  li.stretch label {\n    flex: 1;\n    white-space: nowrap;\n  }\n  li.stretch label > span {\n    display: flex;\n    flex-direction: row;\n    flex: 1;\n  }\n  label {\n    display: inline-flex;\n    flex-direction: column;\n  }\n  label:not(:last-child) {\n    margin-right: 1em;\n  }\n  input, select {\n    min-height: 1.3em;\n    box-sizing: border-box;\n  }\n  input[type=checkbox] {\n    margin-left: 0;\n  }\n  input[type=number] {\n    width: 4em;\n  }\n  input:not([type=checkbox])  {\n    padding: 0 .25em;\n  }\n  input[type=range] {\n    flex: 1;\n    width: 100%;\n    margin: 0 .25em;\n    padding: 0;\n    filter: saturate(0);\n    opacity: .5;\n  }\n  u + input[type=range] {\n    max-width: 3em;\n  }\n  input[type=range]:hover {\n    filter: none;\n    opacity: 1;\n  }\n  input[type=color] {\n    position: absolute;\n    width: calc(1.5em + 2px);\n    opacity: 0;\n    cursor: pointer;\n  }\n  u {\n    position: relative;\n    flex: 0 0 1.5em;\n    height: 1.5em;\n    border: 1px solid #888;\n    pointer-events: none;\n    color: #888;\n    background-image:\n      linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%),\n      linear-gradient(45deg, currentColor 25%, transparent 25%, transparent 75%, currentColor 75%);\n    background-size: .5em .5em;\n    background-position: 0 0, .25em .25em;\n  }\n  u::after {\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    content: "";\n    background-color: var(--color);\n  }\n  .range-edit {\n    position: absolute;\n    box-shadow: 0 0.25em 1em #000;\n    z-index: 99;\n  }\n  textarea {\n    resize: vertical;\n    margin: 1px 0;\n    font: 11px/1.25 Consolas, monospace;\n  }\n  :invalid {\n    background-color: #f002;\n    border-color: #800;\n  }\n  code {\n    font-weight: bold;\n  }\n  a {\n    text-decoration: none;\n    color: LinkText;\n    cursor: pointer;\n  }\n  a:hover {\n    text-decoration: underline;\n  }\n  button {\n    padding: .2em .5em;\n    margin-right: 1em;\n  }\n  kbd {\n    padding: 1px 6px;\n    font-weight: bold;\n    font-family: Consolas, monospace;\n    border: 1px solid #888;\n    border-radius: 3px;\n    box-shadow: inset 1px 1px 5px #8888, .25px .5px 2px #0008;\n  }\n  .column {\n    display: flex;\n    flex-direction: column;\n  }\n  .flex {\n    display: flex;\n  }\n  .highlight {\n    animation: 2s fade-in cubic-bezier(0, .75, .25, 1);\n    animation-fill-mode: both;\n  }\n  #_rules > * {\n    word-break: break-all;\n  }\n  #_rules > :not(:focus) {\n    overflow: hidden; /* prevents wrapping in FF */\n  }\n  .invalid-domain {\n    opacity: .5;\n  }\n  .matching-domain {\n    border-color: #56b8ff;\n    background: #d7eaff;\n  }\n  #_mover {\n    cursor: move;\n    user-select: none;\n    position: absolute;\n    top: 0;\n    left: 8px;\n    right: 24px;\n    height: 24px;\n    text-align: center;\n    background: linear-gradient(transparent 10px, currentColor 10px, currentColor 11px, transparent 11px,\n      transparent 13px, currentColor 13px, currentColor 14px, transparent 14px);\n  }\n  #_mover::after {\n    content: 'MPIV ${GM.info.script.version}';\n    font: bold 20px/1.3 sans;\n    background: var(--bg);\n    padding: 0 1ex;\n  }\n  #_x {\n    position: absolute;\n    top: 0;\n    right: 0;\n    padding: 4px 8px;\n    cursor: pointer;\n    user-select: none;\n  }\n  #_x:hover {\n    background-color: #8884;\n  }\n  #_cssApp {\n    color: seagreen;\n  }\n  #_exportNotification {\n    color: green;\n    font-weight: bold;\n    position: absolute;\n    bottom: 4px;\n    right: 26px;\n  }\n  #_installHint {\n    color: green;\n  }\n  #_usage {\n    display: flex;\n    flex-wrap: wrap;\n    align-items: flex-start;\n    gap: 1em;\n  }\n  #_usage th {\n    font-weight: normal;\n    padding-right: .5em;\n  }\n  #_usage tr:nth-last-child(n + 2) > :not(br) {\n    white-space: pre-line;\n    border-bottom: 1px dotted #8888;\n  }\n  #_usage kbd {\n    font-family: monospace;\n    font-weight: bold;\n  }\n  @keyframes fade-in {\n    from { background-color: deepskyblue }\n    to {}\n  }\n  @media (prefers-color-scheme: dark) {\n    :host {\n      color: #aaa !important;\n      --bg: #333 !important;\n    }\n    a {\n      color: deepskyblue;\n    }\n    button {\n      background: linear-gradient(-5deg, #333, #555);\n      border: 1px solid #000;\n      box-shadow: 0 2px 6px #181818;\n      border-radius: 3px;\n      cursor: pointer;\n    }\n    button:hover {\n      background: linear-gradient(-5deg, #333, #666);\n    }\n    textarea, input, select {\n      background: #111;\n      color: #BBB;\n      border: 1px solid #555;\n    }\n    input[type=checkbox] {\n      filter: invert(1);\n    }\n    input[type=range] {\n      filter: invert(1) saturate(0);\n    }\n    input[type=range]:hover {\n      filter: invert(1);\n    }\n    kbd {\n      border-color: #666;\n    }\n    @supports (-moz-appearance: none) {\n      input[type=checkbox],\n      input[type=range],\n      input[type=range]:hover {\n        filter: none;\n      }\n    }\n    .range-edit {\n      box-shadow: 0 .5em 1em .5em #000;\n    }\n    .matching-domain {\n      border-color: #0065af;\n      background: #032b58;\n      color: #ddd;\n    }\n    #_cssApp {\n      color: darkseagreen;\n    }\n    #_installHint {\n      color: greenyellow;\n    }\n    ::-webkit-scrollbar {\n      width: 14px;\n      height: 14px;\n      background: #333;\n    }\n    ::-webkit-scrollbar-button:single-button {\n      background: radial-gradient(circle at center, #555 40%, #333 40%)\n    }\n    ::-webkit-scrollbar-track-piece {\n      background: #444;\n      border: 4px solid #333;\n      border-radius: 8px;\n    }\n    ::-webkit-scrollbar-thumb {\n      border: 3px solid #333;\n      border-radius: 8px;\n      background: #666;\n    }\n    ::-webkit-resizer {\n      background: #111 linear-gradient(-45deg, transparent 3px, #888 3px, #888 4px, transparent 4px, transparent 6px, #888 6px, #888 7px, transparent 7px) no-repeat;\n      border: 2px solid transparent;\n    }\n  }\n`;function createSetupElement(){const e="https://github.com/tophf/mpiv/wiki/",t="Leave it empty and click Apply or OK to restore the default values.",o=(e,t,o)=>$new("a",Object.assign({target:"_blank"},t&&{href:t},o),e),n=(e,t,o="",n)=>$new("label",Object.assign({title:o},n),[$new("input",{id:t,type:"checkbox"}),e]),i=e=>"{"===e[0]?$new("kbd",e.slice(1,-1)):e,a=(e,t="",o=0,n=100,i=1,a="range")=>$new("input",{id:e,min:o,max:n,step:i,type:a,"data-title":t}),r=(e,t,o)=>$new("label",[e,$new("select",{id:t},Object.entries(o).map((([e,t])=>$new("option",Object.assign({value:e},"object"==typeof t?t:{textContent:t})))))]),s=([e,t])=>$new("tr",e?[$new("th",((e=e.split(/(\n)/))[0]=$new("b",e[0]))&&e),$new("td",t.split(/({.+?})/).map(i))]:$new("br")),l='...when the "popup shows" option is "automatically"',c={"data-start-auto":""};return[$new("style#_cssSetup",CSS_SETUP),$new("style#_css"),$new(`main#${PREFIX}setup`,[$new("#_mover"),$new("#_x","x"),$new("ul#_ul.column",[$new("details",{style:"order:1; padding-top: .5em;"},[$new("summary",{style:"cursor: pointer"},$new("b","Help & hotkeys...")),$new("#_usage",[$new("table",[["Activate","hover the target"],["Deactivate","move cursor off target, or click, or zoom out fully"],["Ignore target","hold {Shift} ⏵ hover the target ⏵ release the key"],["Freeze popup","hold {Shift} ⏵ leave the target ⏵ release the key"],["Force-activate\n(videos or small pics)","hold {Ctrl} ⏵ hover the target ⏵ release the key"]].map(s)),$new("table",[["Start zooming","configurable (automatic or via right-click)\nor tap {Shift} while popup is visible"],["Zoom","mouse wheel"],[],["Rotate",'{L} {r} for "left" or "right"'],["Flip/mirror",'{h} {v} for "horizontal" or "vertical"'],["Previous/next\n(in album)","mouse wheel, {j} {k} or {←} {→} keys"]].map(s)),$new("table",[["Antialiasing","{a}"],["Caption in info","{c}"],["Download","{d}"],["Fullscreen","{f}"],["Info","{i}"],["Mute","{m}"],["Night mode","{n}"],["Open in tab","{t}"]].map(s))])]),$new("li.options.stretch",[r("Popup shows on","start",{context:"Right-click / ≡ / Ctrl",contextMK:"Right-click / ≡",contextM:"Right-click",contextK:{textContent:"≡ key",title:"≡ is the Menu key (near the right Ctrl)"},ctrl:"Ctrl",auto:"automatically"}),$new("label",{title:l,...c},["after, sec",a("delay","seconds",.05,10,.05,"number")]),$new("label",{title:"(if the full version of the hovered image is ...% larger)"},["if larger, %",a("scale",null,0,100,1,"number")]),r("Zoom activates on","zoom",{context:"Right click / Shift",wheel:"Wheel up / Shift",shift:"Shift",auto:"automatically"}),r("...and zooms to","fit",{all:"fit to window",large:"fit if larger",no:"100%","":{textContent:"custom",title:"Use custom scale factors"}})]),$new("li.options",[$new("label",["Zoom step, %",a("zoomStep",null,100,400,1,"number")]),r("When fully zoomed out:","zoomOut",{stay:"stay in zoom mode",auto:"stay if still hovered",unzoom:"undo zoom mode",close:"close popup"}),$new("label",{style:"flex: 1",title:`\n              Scale factors to use when “zooms to” selector is set to “custom”.\n              0 = fit to window,\n              0! = same as 0 but also removes smaller values,\n              * after a value marks the default zoom factor, for example: 1*\n              The popup won't shrink below the image's natural size or window size for bigger mages.\n              ${t}\n            `.trim().replace(/\n\s+/g,"\r")},["Custom scale factors:",$new("input#scales",{placeholder:t})])]),$new("li.options.row",[$new([n("Centered*","center","...or try to keep the original link/thumbnail unobscured by the popup"),n("Preload on hover*","preload","Provides smoother experience but increases network traffic"),n("Require Ctrl key for video*","videoCtrl",l,c),n("Mute videos*","mute",'Hotkey: "m" in the popup'),n("Keep playing video*","keepVids","...until you press Esc key or click elsewhere"),n("Keep preview on blur*","keepOnBlur","i.e. when mouse pointer moves outside the page")]),$new([n("Show complete image*","waitLoad","...or immediately show a partial image while still loading"),n("Shadow only when complete*","uiShadowOnLoad","...to avoid showing the semi-transparent background while still loading from a slow site"),$new("div.flex",{style:"align-items:center"},[n("Info: show for","uiInfo",'Hotkey: "i" (or hold "Shift") in the popup'),$new("input#uiInfoHide",{min:1,step:"any",type:"number"}),"sec"]),n("Info: only once*","uiInfoOnce","...or every time the info changes"),n("Info: caption*","uiInfoCaption",'Hotkey: "c" in the popup'),n("Fade-in transition","uiFadein"),n("Fade-in transition in gallery","uiFadeinGallery")]),$new([n("Night mode*","night",'Hotkey: "n" in the popup'),n("Run in image tabs","imgtab"),n("Spoof hotlinking*","xhr","Disable only if you spoof the HTTP headers yourself"),n("Set status on <html>*","globalStatus","Causes slowdowns so don't enable unless you explicitly use it in your custom CSS"),n("Auto-start switch in menu*","startAltShown","Show a switch for 'auto-start' mode in userscript manager menu")])]),$new("li.options.stretch",[$new("label",["Background",$new("span",[$new("input#uiBackgroundColor",{type:"color"}),$new("u"),a("uiBackgroundOpacity","Opacity: $%")])]),$new("label",["Border color, opacity, size",$new("span",[$new("input#uiBorderColor",{type:"color"}),$new("u"),a("uiBorderOpacity","Opacity: $%"),a("uiBorder","Border size: $px",0,20)])]),$new("label",["Shadow color, opacity, size",$new("span",[$new("input#uiShadowColor",{type:"color"}),$new("u"),a("uiShadowOpacity","Opacity: $%"),a("uiShadow",'Shadow blur radius: $px\n"0" disables the shadow.',0,20)])]),$new("label",["Padding",$new("span",a("uiPadding","Padding: $px"))]),$new("label",["Margin",$new("span",a("uiMargin","Margin: $px"))])]),$new("li",[o("Custom CSS:",`${e}Custom-CSS`)," e.g. ",$new("b","#mpiv-popup { animation: none !important }"),o("View the built-in CSS","",{id:"_reveal",tabIndex:0,style:"float: right",title:"You can copy parts of it to override them in your custom CSS"}),$new(".column",[$new("textarea#css",{spellcheck:!1}),$new("textarea#_cssApp",{spellcheck:!1,hidden:!0,readOnly:!0,rows:30})])]),$new("li.flex",{style:"justify-content: space-between;"},[$new("div",o("Custom host rules:",`${e}Custom-host-rules`)),$new("div",{style:"white-space: pre-line"},["To disable, put any symbol except ",$new("code","a..z 0..9 - ."),'\nin "d" value, for example ',$new("code",'"d": "!foo.com"')]),$new("div",$new("input#_search",{type:"search",placeholder:"Search",style:"width: 10em; margin-left: 1em"}))]),$new("li",{style:"margin-left: -3px; margin-right: -3px; overflow-y: auto; padding-left: 3px; padding-right: 3px;"},[$new("div#_rules.column",$new("textarea",{spellcheck:!1,rows:1}))]),$new("li#_rules2")]),$new("div.flex",[$new("button#_ok",{accessKey:"o"},"OK"),$new("button#_apply",{accessKey:"a"},"Apply"),$new("button#_cancel","Cancel"),$new("a",{href:`${e}Rules`,style:"margin: 0 auto"},$new("button#_install",{style:"color: inherit"},"Find rule...")),$new("button#_import","Import"),$new("button#_export",{style:"margin: 0"},"Export"),$new("div#_exportNotification",{hidden:!0},"Copied to clipboard")])])]}function createGlobalStyle(){return App.globalStyle=(String.raw`
#\mpiv-bar {
  position: fixed;
  z-index: 2147483647;
  top: 0;
  left: 0;
  right: 0;
  text-align: center;
  font-family: sans-serif;
  font-size: 15px;
  font-weight: bold;
  background: #0005;
  color: white;
  padding: 4px 10px;
  text-shadow: .5px .5px 2px #000;
  transition: opacity 1s ease .25s;
  opacity: 0;
}
#\mpiv-bar[data-force] {
  transition: none;
}
#\mpiv-bar.\mpiv-show {
  opacity: 1;
}
#\mpiv-bar[data-zoom][data-prefix]::before {
  content: "[" attr(data-prefix) "] ";
  color: gold;
}
#\mpiv-bar[data-zoom]:not(:empty)::after {
  content: " (" attr(data-zoom) ")";
  opacity: .8;
}
#\mpiv-bar[data-zoom]:empty::after {
  content: attr(data-zoom);
}
#\mpiv-popup.\mpiv-show {
  display: inline;
}
#\mpiv-popup {
  display: none;
  cursor: none;
  box-shadow: none;
${cfg.uiFadein?String.raw`
  animation: .2s \mpiv-fadein both;
  transition: box-shadow .25s, background-color .25s;
  `:""}
${App.popupStyleBase="\n  border: none;\n  box-sizing: border-box;\n  background-size: cover;\n  position: fixed;\n  z-index: 2147483647;\n  padding: 0;\n  margin: 0;\n  top: 0;\n  left: 0;\n  width: auto;\n  height: auto;\n  transform-origin: center;\n  max-width: none;\n  max-height: none;\n"}
}
#\mpiv-popup.\mpiv-show {
  ${cfg.uiBorder?`border: ${cfg.uiBorder}px solid ${Util.color("Border")};`:""}
  ${cfg.uiPadding?`padding: ${cfg.uiPadding}px;`:""}
  ${cfg.uiMargin?`margin: ${cfg.uiMargin}px;`:""}
}
#\mpiv-popup.\mpiv-show${cfg.uiShadowOnLoad?"[loaded]":""} {
  background-color: ${Util.color("Background")};
  ${cfg.uiShadow?`box-shadow: 2px 4px ${cfg.uiShadow}px 4px ${Util.color("Shadow")};`:""}
}
#\mpiv-popup[data-gallery-flip] {
  animation: none;
  transition: none;
}
#\mpiv-popup[${NOAA_ATTR}],
#\mpiv-popup.\mpiv-zoom-max {
  image-rendering: pixelated;
}
#\mpiv-popup.\mpiv-night:not(#\\0) {
  box-shadow: 0 0 0 ${Math.max(screen.width,screen.height)}px #000;
}
body:has(#\mpiv-popup.\mpiv-night)::-webkit-scrollbar {
  background: #000;
}
#\mpiv-setup {
}
@keyframes \mpiv-fadein {
  from {
    opacity: 0;
    border-color: transparent;
  }
  to {
    opacity: 1;
  }
}
`+(cfg.globalStatus?String.raw`
:root.\mpiv-loading:not(.\mpiv-preloading) *:hover {
  cursor: progress !important;
}
:root.\mpiv-edge #\mpiv-popup {
  cursor: default;
}
:root.\mpiv-error *:hover {
  cursor: not-allowed !important;
}
:root.\mpiv-ready *:hover,
:root.\mpiv-large *:hover {
  cursor: zoom-in !important;
}
:root.\mpiv-shift *:hover {
  cursor: default !important;
}
`:String.raw`
[\mpiv-status~="loading"]:not([\mpiv-status~="preloading"]):hover {
  cursor: progress;
}
[\mpiv-status~="edge"]:hover {
  cursor: default;
}
[\mpiv-status~="error"]:hover {
  cursor: not-allowed;
}
[\mpiv-status~="ready"]:hover,
[\mpiv-status~="large"]:hover {
  cursor: zoom-in;
}
[\mpiv-status~="shift"]:hover {
  cursor: default;
}
`)).replace(/\\mpiv-status/g,STATUS_ATTR).replace(/\\mpiv-/g,PREFIX),App.popupStyleBase=App.popupStyleBase.replace(/;/g,"!important;"),App.globalStyle}const clamp=(e,t,o)=>e<t?t:e>o?o:e,compareNumbers=(e,t)=>e-t,flattenHtml=e=>e.trim().replace(/\n\s*/g,""),dropEvent=e=>(e.preventDefault(),e.stopPropagation()),ensureArray=e=>isArray(e)?e:[e],eventModifiers=e=>(e.altKey?"!":"")+(e.ctrlKey?"^":"")+(e.metaKey?"#":"")+(e.shiftKey?"+":""),describeKey=e=>eventModifiers(e)+(e.key&&e.key.length>1?e.key:e.code),isFunction=e=>"function"==typeof e,isVideo=e=>e&&"VIDEO"===e.tagName,now=performance.now.bind(performance),sumProps=(...e)=>{let t=0;for(const o of e)t+=parseFloat(o)||0;return t},tryCatch=(e,...t)=>{try{return e(...t)}catch(e){}},tryJSON=e=>tryCatch(JSON.parse,e),pick=(e,t,o)=>{if(e&&t)for(const o of t.split(".")){if(!e)break;e=e[o]}return o&&void 0!==e?o(e):e},$=(e,t=doc)=>t.querySelector(e)||!1,$$=(e,t=doc)=>t.querySelectorAll(e),$new=(e,t,o)=>{"string"!=typeof e&&(o=t,t=e,e=""),o||null==t||"[object Object]"==={}.toString.call(t)||(o=t,t=null);const n="fragment"===e,[,i,a,r]=e.match(/^(\w*)(?:#([^.]+))?(?:\.(.+))?$/),s=n?doc.createDocumentFragment():doc.createElement(i||"div");if(a&&(s.id=a),r&&(s.className=r.replace(/\./g," ")),t)for(const[e,o]of Object.entries(t))e.startsWith("data-")?null!=o&&s.setAttribute(e,o):s[e]=o;return null!=o&&(isArray(o)?s.append(...o.filter(Boolean)):o instanceof Node?s.appendChild(o):s.textContent=o),s},$css=(e,t)=>Object.entries(t).forEach((([t,o])=>e.style.setProperty(t,o,"important"))),$parseHtml=e=>(new DOMParser).parseFromString(e,"text/html"),$many=(e,t)=>{for(const o of ensureArray(e)){const e=o&&$(o,t);if(e)return e}},$prop=(e,t,o=doc)=>(o=$(e,o))&&o[t]||"",$propUp=(e,t)=>(e=e.closest(`[${t}]`))&&(t.startsWith("data-")?e.getAttribute(t):e[t])||"",$remove=e=>e&&e.remove(),$dataset=({dataset:e},t,o)=>null==o?delete e[t]:e[t]=o;if((async()=>{cfg=await Config.load({save:!0}),doc.body||await new Promise((e=>new MutationObserver(((t,o)=>doc.body&&(o.disconnect(),e()))).observe(document,{subtree:!0,childList:!0})));const e=doc.body.firstElementChild;e&&(App.isImageTab=e===doc.body.lastElementChild&&e.matches("img, video"),App.isEnabled=cfg.imgtab||!App.isImageTab),Menu&&Menu.register(),addEventListener("mouseover",Events.onMouseOver,!0),addEventListener("contextmenu",Events.onContext,!0),addEventListener("keydown",Events.onKeyDown,!0),addEventListener("visibilitychange",Events.onVisibility,!0),addEventListener("blur",Events.onVisibility,!0),["greasyfork.org","github.com"].includes(hostname)&&addEventListener("click",setupClickedRule,!0),addEventListener("message",App.onMessage,!0)})(),window.trustedTypes){const e=window.trustedTypes,t="createPolicy",o=e[t];e[t]=function n(i,a){let r;const s=o.call(e,i,a);return(trustedHTML||a[r="createHTML"]&&(trustedHTML=s[r].bind(s)))&&(trustedScript||a[r="createScript"]&&(trustedScript=s[r].bind(s)))&&e[t]===n&&delete e[t],s}}