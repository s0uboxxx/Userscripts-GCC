// ==UserScript==
// @name                Pixiv Previewer
// @namespace           https://github.com/Ocrosoft/PixivPreviewer
// @version             3.7.29
// @description         Display preview images (support single image, multiple images, moving images); Download animation(.zip); Sorting the search page by favorite count(and display it). Updated for the latest search page.
// @description:zh-CN   显示预览图（支持单图，多图，动图）；动图压缩包下载；搜索页按热门度（收藏数）排序并显示收藏数，适配11月更新。
// @description:ja      プレビュー画像の表示（単一画像、複数画像、動画のサポート）; アニメーションのダウンロード（.zip）; お気に入りの数で検索ページをソートします（そして表示します）。 最新の検索ページ用に更新されました。
// @description:zh_TW   顯示預覽圖像（支持單幅圖像，多幅圖像，運動圖像）； 下載動畫（.zip）; 按收藏夾數對搜索頁進行排序（並顯示）。 已為最新的搜索頁面適配。
// @author              Ocrosoft
// @match               *://www.pixiv.net/*
// @grant               unsafeWindow
// @grant               GM.xmlHttpRequest
// @grant               GM_xmlhttpRequest
// @license             GPLv3
// @icon                https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&size=32&url=https://www.pixiv.net
// @icon64              https://t0.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&size=64&url=https://www.pixiv.net
// @require             https://update.greasyfork.org/scripts/515994/1478507/gh_2215_make_GM_xhr_more_parallel_again.js
// @downloadURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Pixiv20Previewer.user.js
// @updateURL https://raw.githubusercontent.com/s0uboxxx/Userscripts-GCC/release/release/Pixiv20Previewer.meta.js
// ==/UserScript==
function ILog(){this.prefix="",this.v=function(t){e<=this.LogLevel.Verbose&&console.log(this.prefix+t)},this.i=function(t){e<=this.LogLevel.Info&&console.info(this.prefix+t)},this.w=function(t){e<=this.LogLevel.Warning&&console.warn(this.prefix+t)},this.e=function(t){e<=this.LogLevel.Error&&console.error(this.prefix+t)},this.d=function(t){e<=this.LogLevel.Verbose&&console.log(t)},this.setLogLevel=function(t){e=t},this.LogLevel={Verbose:0,Info:1,Warning:2,Error:3};let e=this.LogLevel.Warning}var GM__xmlHttpRequest,iLog=new ILog;function base64ArrayBuffer(e,t,o){for(var n,i="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=new Uint8Array(e),s=o%3,l=t+o-s,g=t;g<l;g+=3)i+=r[(16515072&(n=a[g]<<16|a[g+1]<<8|a[g+2]))>>18]+r[(258048&n)>>12]+r[(4032&n)>>6]+r[63&n];return 1==s?i+=r[(252&(n=a[l]))>>2]+r[(3&n)<<4]+"==":2==s&&(i+=r[(64512&(n=a[l]<<8|a[l+1]))>>10]+r[(1008&n)>>4]+r[(15&n)<<2]+"="),i}function ZipImagePlayer(e){this.op=e,this._URL=window.URL||window.webkitURL||window.MozURL||window.MSURL,this._Blob=window.Blob||window.WebKitBlob||window.MozBlob||window.MSBlob,this._BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,this._Uint8Array=window.Uint8Array||window.WebKitUint8Array||window.MozUint8Array||window.MSUint8Array,this._DataView=window.DataView||window.WebKitDataView||window.MozDataView||window.MSDataView,this._ArrayBuffer=window.ArrayBuffer||window.WebKitArrayBuffer||window.MozArrayBuffer||window.MSArrayBuffer,this._maxLoadAhead=0,this._URL||(this._debugLog("No URL support! Will use slower data: URLs."),this._maxLoadAhead=10),this._Blob||this._error("No Blob support"),this._Uint8Array||this._error("No Uint8Array support"),this._DataView||this._error("No DataView support"),this._ArrayBuffer||this._error("No ArrayBuffer support"),this._isSafari=Object.prototype.toString.call(window.HTMLElement).indexOf("Constructor")>0,this._loadingState=0,this._dead=!1,this._context=e.canvas.getContext("2d"),this._files={},this._frameCount=this.op.metadata.frames.length,this._debugLog("Frame count: "+this._frameCount),this._frame=0,this._loadFrame=0,this._frameImages=[],this._paused=!1,this._loadTimer=null,this._startLoad(),this.op.autoStart?this.play():this._paused=!0}GM__xmlHttpRequest="undefined"!=typeof GM_xmlhttpRequest?GM_xmlhttpRequest:GM.xmlHttpRequest,ZipImagePlayer.prototype={_trailerBytes:3e4,_failed:!1,_mkerr:function(e){var t=this;return function(){t._error(e)}},_error:function(e){throw this._failed=!0,Error("ZipImagePlayer error: "+e)},_debugLog:function(e){this.op.debug&&console.log(e)},_load:function(e,t,o){var n=this,i=new XMLHttpRequest;if(i.addEventListener("load",(function(r){n._dead||(n._debugLog("Load: "+e+" "+t+" status="+i.status),200==i.status?(n._debugLog("Range disabled or unsupported, complete load"),e=0,t=i.response.byteLength,n._len=t,n._buf=i.response,n._bytes=new n._Uint8Array(n._buf)):(206!=i.status&&n._error("Unexpected HTTP status "+i.status),i.response.byteLength!=t&&n._error("Unexpected length "+i.response.byteLength+" (expected "+t+")"),n._bytes.set(new n._Uint8Array(i.response),e)),o&&o.apply(n,[e,t]))}),!1),i.addEventListener("error",this._mkerr("Fetch failed"),!1),i.open("GET",this.op.source),i.responseType="arraybuffer",null!=e&&null!=t){var r=e+t;i.setRequestHeader("Range","bytes="+e+"-"+(r-1)),this._isSafari&&(i.setRequestHeader("Cache-control","no-cache"),i.setRequestHeader("If-None-Match",Math.random().toString()))}i.send()},_startLoad:function(){var e=this;this.op.source?$.ajax({url:this.op.source,type:"HEAD"}).done((function(t,o,n){if(!e._dead){e._pHead=0,e._pNextHead=0,e._pFetch=0;var i=parseInt(n.getResponseHeader("Content-Length"));if(!i)return e._debugLog("HEAD request failed: invalid file length."),e._debugLog("Falling back to full file mode."),void e._load(null,null,(function(t,o){e._pTail=0,e._pHead=o,e._findCentralDirectory()}));e._debugLog("Len: "+i),e._len=i,e._buf=new e._ArrayBuffer(i),e._bytes=new e._Uint8Array(e._buf);var r=i-e._trailerBytes;r<0&&(r=0),e._pTail=i,e._load(r,i-r,(function(t,o){e._pTail=t,e._findCentralDirectory()}))}})).fail(this._mkerr("Length fetch failed")):this._loadNextFrame()},_findCentralDirectory:function(){var e=new this._DataView(this._buf,this._len-22,22);101010256!=e.getUint32(0,!0)&&this._error("End of Central Directory signature not found");var t=e.getUint16(10,!0),o=e.getUint32(12,!0),n=e.getUint32(16,!0);n<this._pTail?this._load(n,this._pTail-n,(function(){this._pTail=n,this._readCentralDirectory(n,o,t)})):this._readCentralDirectory(n,o,t)},_readCentralDirectory:function(e,t,o){for(var n=new this._DataView(this._buf,e,t),i=0,r=0;r<o;r++){33639248!=n.getUint32(i,!0)&&this._error("Invalid Central Directory signature");var a=n.getUint16(i+10,!0),s=n.getUint32(i+24,!0),l=n.getUint16(i+28,!0),g=n.getUint16(i+30,!0),p=n.getUint16(i+32,!0),d=n.getUint32(i+42,!0);0!=a&&this._error("Unsupported compression method"),i+=46;for(var u=new this._Uint8Array(this._buf,e+i,l),c="",h=0;h<l;h++)c+=String.fromCharCode(u[h]);i+=l+g+p,this._files[c]={off:d,len:s}}this._pHead>=this._pTail?(this._pHead=this._len,$(this).triggerHandler("loadProgress",[this._pHead/this._len]),this._loadNextFrame()):(this._loadNextChunk(),this._loadNextChunk())},_loadNextChunk:function(){if(!(this._pFetch>=this._pTail)){var e=this._pFetch,t=this.op.chunkSize;this._pFetch+t>this._pTail&&(t=this._pTail-this._pFetch),this._pFetch+=t,this._load(e,t,(function(){e==this._pHead?(this._pNextHead?(this._pHead=this._pNextHead,this._pNextHead=0):this._pHead=e+t,this._pHead>=this._pTail&&(this._pHead=this._len),$(this).triggerHandler("loadProgress",[this._pHead/this._len]),this._loadTimer||this._loadNextFrame()):this._pNextHead=e+t,this._loadNextChunk()}))}},_fileDataStart:function(e){var t=new DataView(this._buf,e,30);return e+30+t.getUint16(26,!0)+t.getUint16(28,!0)},_isFileAvailable:function(e){var t=this._files[e];return t||this._error("File "+e+" not found in ZIP"),!(this._pHead<t.off+30)&&this._pHead>=this._fileDataStart(t.off)+t.len},_loadNextFrame:function(){if(!this._dead){var e=this._loadFrame;if(!(e>=this._frameCount)){var t=this.op.metadata.frames[e];if(!this.op.source)return this._loadFrame+=1,void this._loadImage(e,t.file,!1);if(this._isFileAvailable(t.file)){this._loadFrame+=1;var o,n=this._fileDataStart(this._files[t.file].off),i=n+this._files[t.file].len,r=this.op.metadata.mime_type||"image/png";if(this._URL){var a,s;if(this._buf.slice)a=this._buf.slice(n,i);else a=new this._ArrayBuffer(this._files[t.file].len),new this._Uint8Array(a).set(this._bytes.subarray(n,i));try{s=new this._Blob([a],{type:r})}catch(e){this._debugLog("Blob constructor failed. Trying BlobBuilder... ("+e.message+")");var l=new this._BlobBuilder;l.append(a),s=l.getBlob()}o=this._URL.createObjectURL(s),this._loadImage(e,o,!0)}else o="data:"+r+";base64,"+base64ArrayBuffer(this._buf,n,i-n),this._loadImage(e,o,!1)}}}},_loadImage:function(e,t,o){var n=this,i=new Image,r=this.op.metadata.frames[e];i.addEventListener("load",(function(){n._debugLog("Loaded "+r.file+" to frame "+e),o&&n._URL.revokeObjectURL(t),n._dead||(n._frameImages[e]=i,$(n).triggerHandler("frameLoaded",e),0==n._loadingState&&n._displayFrame.apply(n),e>=n._frameCount-1?(n._setLoadingState(2),n._buf=null,n._bytes=null):!n._maxLoadAhead||e-n._frame<n._maxLoadAhead?n._loadNextFrame():n._loadTimer||(n._loadTimer=setTimeout((function(){n._loadTimer=null,n._loadNextFrame()}),200)))})),i.src=t},_setLoadingState:function(e){this._loadingState!=e&&(this._loadingState=e,$(this).triggerHandler("loadingStateChanged",[e]))},_displayFrame:function(){if(!this._dead){var e=this,t=this.op.metadata.frames[this._frame];this._debugLog("Displaying frame: "+this._frame+" "+t.file);var o=this._frameImages[this._frame];if(!o)return this._debugLog("Image not available!"),void this._setLoadingState(0);2!=this._loadingState&&this._setLoadingState(1),this.op.autosize&&(this._context.canvas.width==o.width&&this._context.canvas.height==o.height||(this._context.canvas.width=o.width,this._context.canvas.height=o.height)),this._context.clearRect(0,0,this.op.canvas.width,this.op.canvas.height),this._context.drawImage(o,0,0),$(this).triggerHandler("frame",this._frame),this._paused||(this._timer=setTimeout((function(){e._timer=null,e._nextFrame.apply(e)}),t.delay))}},_nextFrame:function(e){if(this._frame>=this._frameCount-1){if(!this.op.loop)return void this.pause();this._frame=0}else this._frame+=1;this._displayFrame()},play:function(){this._dead||this._paused&&($(this).triggerHandler("play",[this._frame]),this._paused=!1,this._displayFrame())},pause:function(){this._dead||this._paused||(this._timer&&clearTimeout(this._timer),this._paused=!0,$(this).triggerHandler("pause",[this._frame]))},rewind:function(){this._dead||(this._frame=0,this._timer&&clearTimeout(this._timer),this._displayFrame())},stop:function(){this._debugLog("Stopped!"),this._dead=!0,this._timer&&clearTimeout(this._timer),this._loadTimer&&clearTimeout(this._loadTimer),this._frameImages=null,this._buf=null,this._bytes=null,$(this).triggerHandler("stop")},getCurrentFrame:function(){return this._frame},getLoadedFrames:function(){return this._frameImages.length},getFrameCount:function(){return this._frameCount},hasError:function(){return this._failed}};var checkJQuery=function(){let e=["http://code.jquery.com/jquery-2.1.4.min.js","https://ajax.aspnetcdn.com/ajax/jquery/jquery-2.1.4.min.js","https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js","https://cdn.staticfile.org/jquery/2.1.4/jquery.min.js","https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"];function t(){try{let e=unsafeWindow;return e.jQuery&&!e.$&&(e.$=e.jQuery),$(),!0}catch(e){return!1}}function o(n,i){if(n>=e.length)return iLog.e("无法加载 JQuery，正在退出。"),void i(!1);let r=function(e){let t=-1!=location.href.indexOf("https://"),o=-1!=e.indexOf("https://");return t&&!o?e.replace("http://","https://"):!t&&o?e.replace("https://","http://"):e}(e[n]);iLog.i("尝试第 "+(n+1)+" 个 JQuery CDN："+r+"。");let a=function(e){let t=document.createElement("script");return t.src=e,document.head.appendChild(t),t}(r);setTimeout((function(){t()?(iLog.i("已加载 JQuery。"),i(!0)):(iLog.w("无法访问。"),a.remove(),o(n+1,i))}),100)}return new Promise((function(e){t()?(iLog.i("已加载 jQuery。"),e(!0)):(iLog.i("未发现 JQuery，尝试加载。"),o(0,e))}))};let Lang={auto:-1,zh_CN:0,en_US:1,ru_RU:2,ja_JP:3},Texts={};Texts[Lang.zh_CN]={install_title:"欢迎使用 PixivPreviewer v",install_body:'<div style="position: absolute;left: 50%;top: 30%;font-size: 20px; color: white;transform:translate(-50%,0);"><p style="text-indent: 2em;">欢迎反馈问题和提出建议！><a style="color: green;" href="https://greasyfork.org/zh-CN/scripts/30766-pixiv-previewer/feedback" target="_blank">反馈页面</a><</p><br><p style="text-indent: 2em;">如果您是第一次使用，推荐到<a style="color: green;" href="https://greasyfork.org/zh-CN/scripts/30766-pixiv-previewer" target="_blank"> 详情页 </a>查看脚本介绍。</p></div>',upgrade_body:"<h3>（重要）关于排序功能</h3>&nbsp&nbsp首先感谢各位的使用，由于最近比较忙，抱歉现在才做出回应。如果各位最近使用过排序功能，可能或多或少都遇到过搜索结果为 0 的问题，下面简单说一下原因和后续的应对方案。<br>&nbsp&nbsp脚本的原理是获取指定页面内所有作品的收藏量，再进行排序。Pixiv 最近对短时间内获取作品信息进行了次数限制，表现为所有请求返回错误，导致显示 0 个作品。以排序三页为例，由于没有批量接口，脚本会向 Pixiv 请求多达 180 个作品的收藏量数据，这对一般限制每分钟访问 30~60 次的请求限制来说非常多了，所以也希望大家能够理解 Pixiv 的做法，同时不要将页数设置得太大。<br>&nbsp&nbsp至于应对方案，目前有以下几种：<ul><li>1.遵循接口限制，可能排序一页要花费一分钟。</li><li>2.使用第三方服务，目前看来也没有服务能够提供批量，或者能顶得住这么多请求的。</li><li>3.用服务器提供收藏量的短时间缓存，并遵循接口限制，成本和风险很高。</li><li>禁用脚本的排序功能。</li></ul>&nbsp&nbsp最后再次感谢大家的使用，如果对上述问题有好的建议，欢迎在 GreasyFork/Github 上提出。最后的最后，这个版本目前可以正常使用排序功能，如果后面突然无法正常使用或者关闭了排序功能，也希望各位能够理解。",setting_language:"语言",setting_preview:"预览",setting_animePreview:"动图预览",setting_sort:"排序（仅搜索页生效）",setting_anime:"动图下载（动图预览及详情页生效）",setting_origin:"预览时优先显示原图（慢）",setting_previewDelay:"延迟显示预览图（毫秒）",setting_previewByKey:"使用按键控制预览图展示（Ctrl）",setting_previewByKeyHelp:"开启后鼠标移动到图片上不再展示预览图，按下Ctrl键才展示，同时“延迟显示预览”设置项不生效。",setting_maxPage:"每次排序时统计的最大页数",setting_hideWork:"隐藏收藏数少于设定值的作品",setting_hideAiWork:"隐藏 AI 生成作品",setting_hideFav:"排序时隐藏已收藏的作品",setting_hideFollowed:"排序时隐藏已关注画师作品",setting_hideByTag:"排序时隐藏指定标签的作品",setting_hideByTagPlaceholder:"输入标签名，多个标签用','分隔",setting_clearFollowingCache:"清除缓存",setting_clearFollowingCacheHelp:"关注画师信息会在本地保存一天，如果希望立即更新，请点击清除缓存",setting_followingCacheCleared:"已清除缓存，请刷新页面。",setting_blank:"使用新标签页打开作品详情页",setting_turnPage:"使用键盘←→进行翻页（排序后的搜索页）",setting_save:"保存设置",setting_reset:"重置脚本",setting_resetHint:"这会删除所有设置，相当于重新安装脚本，确定要重置吗？",setting_novelSort:"小说排序",setting_novelMaxPage:"小说排序时统计的最大页数",setting_novelHideWork:"隐藏收藏数少于设定值的作品",setting_novelHideFav:"排序时隐藏已收藏的作品",sort_noWork:"没有可以显示的作品（隐藏了 %1 个作品）",sort_getWorks:"正在获取第%1/%2页作品",sort_getBookmarkCount:"获取收藏数：%1/%2",sort_getPublicFollowing:"获取公开关注画师",sort_getPrivateFollowing:"获取私有关注画师",sort_filtering:"过滤%1收藏量低于%2的作品",sort_filteringHideFavorite:"已收藏和",sort_fullSizeThumb:"全尺寸缩略图（搜索页、用户页）",nsort_getWorks:"正在获取第1%/2%页作品",nsort_sorting:"正在按收藏量排序",nsort_hideFav:"排序时隐藏已收藏的作品",nsort_hideFollowed:"排序时隐藏已关注作者作品",text_sort:"排序"},Texts[Lang.en_US]={install_title:"Welcome to PixivPreviewer v",install_body:'<div style="position: absolute;left: 50%;top: 30%;font-size: 20px; color: white;transform:translate(-50%,0);"><p style="text-indent: 2em;">Feedback questions and suggestions are welcome! ><a style="color: green;" href="https://greasyfork.org/zh-CN/scripts/30766-pixiv-previewer/feedback" target="_blank">Feedback Page</a><</p><br><p style="text-indent: 2em;">If you are using it for the first time, it is recommended to go to the<a style="color: green;" href="https://greasyfork.org/zh-CN/scripts/30766-pixiv-previewer" target="_blank"> Details Page </a>to see the script introduction.</p></div>',upgrade_body:"<h3>(Important) About the sorting function</h3>&nbsp&nbspFirst of all, thank you for using it. I'm very busy recently, so I'm sorry to respond now. If you have used the sorting function recently, you may have encountered the problem that the search result is 0 more or less. Let me briefly explain the reasons and follow-up solutions. <br>&nbsp&nbsp The principle of the script is to obtain the collections of all works in the specified page, and then sort them. Pixiv recently limited the number of times to obtain work information in a short period of time, which showed that all requests returned errors, resulting in the display of 0 works. Taking sorting three pages as an example, since there is no batch interface, the script will request the collection data of up to 180 works from Pixiv, which is very much for the general limit of 30~60 visits per minute, so I hope You can understand Pixiv's approach, and don't make the page count too large. <br>&nbsp&nbsp As for the solutions, there are currently the following: <ul><li>1. Following the interface restrictions, it may take a minute to sort a page. </li><li>2. Using third-party services, it seems that there is no service that can provide batches, or can withstand so many requests. </li><li>3. It is costly and risky to use the server to provide a short-term cache of collections and follow interface restrictions. </li><li>Disable sorting of scripts. </li></ul>&nbsp&nbsp Finally, thank you again for your use. If you have good suggestions for the above problems, you are welcome to put forward them on GreasyFork/Github. Finally, the sorting function can be used normally in this version. If the sorting function suddenly cannot be used normally or the sorting function is turned off, I hope you can understand.",setting_language:"Language",setting_preview:"Preview",setting_animePreview:"Animation preview",setting_sort:"Sorting (Search page)",setting_anime:"Animation download (Preview and Artwork page)",setting_origin:"Display original image when preview (slow)",setting_previewDelay:"Delay of display preview image(Million seconds)",setting_previewByKey:"Use keys to control the preview image display (Ctrl)",setting_previewByKeyHelp:'After enabling it, move the mouse to the picture and no longer display the preview image. Press the Ctrl key to display it, and the "Delayed Display Preview" setting item does not take effect.',setting_maxPage:"Maximum number of pages counted per sort",setting_hideWork:"Hide works with bookmark count less than set value",setting_hideAiWork:"Hide AI works",setting_hideFav:"Hide favorites when sorting",setting_hideFollowed:"Hide artworks of followed artists when sorting",setting_hideByTag:"Hide artworks by tag",setting_hideByTagPlaceholder:"Input tag name, multiple tags separated by ','",setting_clearFollowingCache:"Cache",setting_clearFollowingCacheHelp:"The folloing artists info. will be saved locally for one day, if you want to update immediately, please click this to clear cache",setting_followingCacheCleared:"Success, please refresh the page.",setting_blank:"Open works' details page in new tab",setting_turnPage:"Use ← → to turn pages (Search page)",setting_save:"Save",setting_reset:"Reset",setting_resetHint:"This will delete all settings and set it to default. Are you sure?",setting_novelSort:"Sorting (Novel)",setting_novelMaxPage:"Maximum number of pages counted for novel sorting",setting_novelHideWork:"Hide works with bookmark count less than set value",setting_novelHideFav:"Hide favorites when sorting",sort_noWork:"No works to display (%1 works hideen)",sort_getWorks:"Getting artworks of page: %1 of %2",sort_getBookmarkCount:"Getting bookmark count of artworks：%1 of %2",sort_getPublicFollowing:"Getting public following list",sort_getPrivateFollowing:"Getting private following list",sort_filtering:"Filtering%1works with bookmark count less than %2",sort_filteringHideFavorite:" favorited works and ",sort_fullSizeThumb:"Display not cropped images.(Search page and User page only.)",nsort_getWorks:"Getting novels of page: 1% of 2%",nsort_sorting:"Sorting by bookmark cound",nsort_hideFav:"Hide favorites when sorting",nsort_hideFollowed:"Hide artworks of followed authors when sorting",text_sort:"sort"},Texts[Lang.ru_RU]={install_title:"Добро пожаловать в PixivPreviewer v",install_body:'<div style="position: absolute;left: 50%;top: 30%;font-size: 20px; color: white;transform:translate(-50%,0);"><p style="text-indent: 2em;">Вопросы и предложения приветствуются! ><a style="color: green;" href="https://greasyfork.org/zh-CN/scripts/30766-pixiv-previewer/feedback" target="_blank">Страница обратной связи</a><</p><br><p style="text-indent: 2em;">Если вы используете это впервые, рекомендуется перейти к<a style="color: green;" href="https://greasyfork.org/zh-CN/scripts/30766-pixiv-previewer" target="_blank"> Странице подробностей </a>, чтобы посмотреть введение в скрипт.</p></div>',upgrade_body:Texts[Lang.en_US].upgrade_body,setting_language:"Язык",setting_preview:"Предпросмотр",setting_animePreview:Texts[Lang.en_US].setting_animePreview,setting_sort:"Сортировка (Страница поиска)",setting_anime:"Анимация скачивания (Страницы предпросмотра и Artwork)",setting_origin:"При предпросмотре, показывать изображения с оригинальным качеством (медленно)",setting_previewDelay:"Задержка отображения предпросмотра изображения (Миллион секунд)",setting_previewByKey:Texts[Lang.en_US].setting_previewByKey,setting_previewByKeyHelp:Texts[Lang.en_US].setting_previewByKeyHelp,setting_maxPage:"Максимальное количество страниц, подсчитанных за сортировку",setting_hideWork:"Скрыть работы с количеством закладок меньше установленного значения",setting_hideAiWork:Texts[Lang.en_US].setting_hideAiWork,setting_hideFav:"При сортировке, скрыть избранное",setting_hideFollowed:"При сортировке, скрыть работы художников на которых подписаны",setting_hideByTag:Texts[Lang.en_US].setting_hideByTag,setting_hideByTagPlaceholder:Texts[Lang.en_US].setting_hideByTagPlaceholder,setting_clearFollowingCache:"Кэш",setting_clearFollowingCacheHelp:"Следующая информация о художниках будет сохранена локально в течение одного дня, если вы хотите обновить её немедленно, нажмите на эту кнопку, чтобы очистить кэш",setting_followingCacheCleared:"Готово, обновите страницу.",setting_blank:"Открывать страницу с описанием работы на новой вкладке",setting_turnPage:"Использовать ← → для перелистывания страниц (Страница поиска)",setting_save:"Сохранить",setting_reset:"Сбросить",setting_resetHint:"Это удалит все настройки и установит их по умолчанию. Продолжить?",setting_novelSort:Texts[Lang.en_US].setting_novelSort,setting_novelMaxPage:Texts[Lang.en_US].setting_novelMaxPage,setting_novelHideWork:"Скрыть работы с количеством закладок меньше установленного значения",setting_novelHideFav:"При сортировке, скрыть избранное",sort_noWork:"Нет работ для отображения (%1 works hidden)",sort_getWorks:"Получение иллюстраций страницы: %1 из %2",sort_getBookmarkCount:"Получение количества закладок artworks：%1 из %2",sort_getPublicFollowing:"Получение публичного списка подписок",sort_getPrivateFollowing:"Получение приватного списка подписок",sort_filtering:"Фильтрация %1 работ с количеством закладок меньше чем %2",sort_filteringHideFavorite:" избранные работы и ",sort_fullSizeThumb:"Показать неотредактированное изображение (Страницы поиска и Artwork)",nsort_getWorks:Texts[Lang.en_US].nsort_getWorks,nsort_sorting:Texts[Lang.en_US].nsort_sorting,nsort_hideFav:Texts[Lang.en_US].nsort_hideFav,nsort_hideFollowed:Texts[Lang.en_US].nsort_hideFollowed,text_sort:Texts[Lang.en_US].text_sort},Texts[Lang.ja_JP]={install_title:"Welcome to PixivPreviewer v",install_body:'<div style="position: absolute;left: 50%;top: 30%;font-size: 20px; color: white;transform:translate(-50%,0);"><p style="text-indent: 2em;"ご意見や提案は大歓迎です! ><a style="color: green;" href="https://greasyfork.org/ja/scripts/30766-pixiv-previewer/feedback" target="_blank">フィードバックページ</a><</p><br><p style="text-indent: 2em;">初めて使う場合は、<a style="color: green;" href="https://greasyfork.org/ja/scripts/30766-pixiv-previewer" target="_blank"> 詳細ページ </a>でスクリプトの紹介を見ることをお勧めします。</p></div>',upgrade_body:"<h3>(注意！) 並べ替え機能について</h3>&nbsp&nbspご利用いただきありがとうございます。最近はとても忙しく、返信が遅れてしまい申し訳ありません。最近並べ替え機能を使っている場合、検索結果が0になることがあるかもしれません。その理由と対策を簡単に説明させていただきます。 <br>&nbsp&nbsp このスクリプトは、指定されたページ内のすべての作品のコレクションを取得し、それらを並べ替えるのものです。最近、Pixivは短時間に作品情報を取得する回数を制限し、すべてのリクエストがエラーを返すことがあり、検索結果が0件と表示されることがあります。例えば、3ページを並べ替える場合、スクリプトは最大180件の作品のコレクションデータをPixivからリクエストすることになりますが、一般的には30〜60回/分の制限があるため、Pixivの仕様を理解していただき、これを回避するため一気にソートするページの値をを大きくしないでください。  <br>&nbsp&nbsp 解決策として、現在以下のような方法を考えています：<ul><li>1. インターフェイスの制限に従って、1ページのソートに1分ほどかかることがあります。</li><li>2. サードパーティのサービスを利用するものの、バッチ処理ができるサービスがないようですし、それだけのリクエストに耐えられるものもなさそうです。</li><li>3. サーバーを使ってコレクションの短期キャッシュを提供し、インターフェイスの制限に従うことは、コストがかかる上にリスクも伴います。</li><li>スクリプトのソート機能を無効にする。</li></ul>&nbsp&nbsp 最後に、改めてご利用いただきありがとうございます。上記の問題について良い提案があれば、GreasyFork/Githubでお気軽に提案してください。最後に、このバージョンではソート機能が正常に使用できます。ただし、ソート機能が突然正常に使用できなくなったり、ソート機能がオフになった場合は、ご理解いただけると幸いです。",setting_language:"言語",setting_preview:"プレビュー機能",setting_animePreview:"うごイラプレビュー",setting_sort:"ソート",setting_anime:"うごイラダウンロード",setting_origin:"最大サイズの画像を表示する(遅くなる可能性がある)",setting_previewDelay:"カーソルを重ねてからプレビューするまでの遅延(ミリ秒)",setting_previewByKey:"キーでプレビュー画像の表示を制御する (Ctrl)",setting_previewByKeyHelp:'これを有効にすると、画像にマウスを移動してもプレビュー画像が表示されなくなります。Ctrlキーを押すと表示され、 "遅延表示プレビュー" の設定項目は無効になります。',setting_maxPage:"ソートするときに取得する最大ページ数",setting_hideWork:"一定以下のブクマーク数の作品を非表示にする",setting_hideAiWork:"AIの作品を非表示にする",setting_hideFav:"ブックマーク数をソート時に非表示にする",setting_hideFollowed:"ソート時にフォローしているアーティストの作品を非表示",setting_hideByTag:Texts[Lang.en_US].setting_hideByTag,setting_hideByTagPlaceholder:Texts[Lang.en_US].setting_hideByTagPlaceholder,setting_clearFollowingCache:"キャッシュ",setting_clearFollowingCacheHelp:"フォローしているアーティストの情報がローカルに1日保存されます。すぐに更新したい場合は、このキャッシュをクリアしてください。",setting_followingCacheCleared:"成功しました。ページを更新してください。",setting_blank:"作品の詳細ページを新しいタブで開く",setting_turnPage:"← → を使用してページをめくる（検索ページ）",setting_save:"Save",setting_reset:"Reset",setting_resetHint:"これにより、すべての設定が削除され、デフォルトに設定されます。よろしいですか？",setting_novelSort:"ソート（小説）",setting_novelMaxPage:"小説のソートのページ数の最大値",setting_novelHideWork:"設定値未満のブックマーク数の作品を非表示",setting_novelHideFav:"ソート時にお気に入りを非表示",sort_noWork:"表示する作品がありません（%1 作品が非表示）",sort_getWorks:"ページの作品を取得中：%1 / %2",sort_getBookmarkCount:"作品のブックマーク数を取得中：%1 / %2",sort_getPublicFollowing:"公開フォロー一覧を取得中",sort_getPrivateFollowing:"非公開フォロー一覧を取得中",sort_filtering:"ブックマーク数が%2未満の作品%1件をフィルタリング",sort_filteringHideFavorite:" お気に入り登録済みの作品および  ",sort_fullSizeThumb:"トリミングされていない画像を表示（検索ページおよびユーザーページのみ）。",nsort_getWorks:"小説のページを取得中：1% / 2%",nsort_sorting:"ブックマーク数で並べ替え",nsort_hideFav:"ソート時にお気に入りを非表示",nsort_hideFollowed:"ソート時にフォロー済み作者の作品を非表示",text_sort:"ソート"};let LogLevel={None:0,Error:1,Warning:2,Info:3,Elements:4};function DoLog(e,t){if(e<=g_logLevel){let o="%c",n="";e==LogLevel.Error?(o+="[Error]",n="color:#ff0000"):e==LogLevel.Warning?(o+="[Warning]",n="color:#ffa500"):e==LogLevel.Info?(o+="[Info]",n="color:#000000"):e==LogLevel.Elements&&(o+="Elements",n="color:#000000"),e!=LogLevel.Elements?console.log(o+t,n):console.log(t),++g_logCount>512&&(g_logCount=0)}}let g_settings,g_language=Lang.zh_CN,g_version="3.7.10",g_csrfToken="",g_logCount=0,g_pageType=-1,g_artworkUrl="/artworks/#id#",g_getArtworkUrl="/ajax/illust/#id#/pages",g_getUgoiraUrl="/ajax/illust/#id#/ugoira_meta",g_getNovelUrl="/ajax/search/novels/#key#?word=#key#&p=#page#",g_mousePos={x:0,y:0},g_loadingImage="https://pp-1252089172.cos.ap-chengdu.myqcloud.com/loading.gif",initialUrl=location.href,g_defaultSettings={lang:-1,enablePreview:1,enableAnimePreview:1,enableSort:1,enableAnimeDownload:1,original:0,previewDelay:200,previewByKey:0,previewKey:17,previewFullScreen:0,pageCount:3,favFilter:0,aiFilter:0,hideFavorite:0,hideFollowed:0,hideByTag:0,hideByTagList:"",linkBlank:1,pageByKey:0,fullSizeThumb:0,enableNovelSort:1,novelPageCount:3,novelFavFilter:0,novelHideFavorite:0,novelHideFollowed:0,logLevel:1,version:g_version},g_logLevel=LogLevel.Error,g_maxXhr=64,g_sortComplete=!0,PageType={Search:0,BookMarkNew:1,Discovery:2,Member:3,Home:4,Ranking:5,NewIllust:6,R18:7,BookMark:8,Stacc:9,Artwork:10,NovelSearch:11,SearchTop:12,PageTypeCount:13},Pages={},ReturnMapSample={loadingComplete:!1,controlElements:[],forceUpdate:!1},ControlElementsAttributesSample={illustId:0,illustType:0,pageCount:1,title:"",userId:0,userName:"",bookmarkCount:0};function findToolbarCommon(){let e=$("#root").find("ul:last").get(0);return e||$("#__next").find("ul:last").get(0)}function findToolbarOld(){return $("._toolmenu").get(0)}function convertThumbUrlToSmall(e){let t="c/540x540_70/img-master",o="_master";return e.replace(/c\/.*\/custom-thumb/,t).replace("_custom",o).replace(/c\/.*\/img-master/,t).replace("_square",o)}function processElementListCommon(e){$.each(e,(function(e,t){let o=$(t),n={illustId:0,illustType:0,pageCount:1},i=o.find("a:first"),r=i.children("div:first").find("svg:first"),a=i.children("div:last").find("span:last");if(null==i)return void DoLog(LogLevel.Warning,"Can not found img or imageLink, skip this.");let s=i.attr("href");if(null==s)return void DoLog(LogLevel.Warning,"Invalid href, skip this.");let l=s.match(/artworks\/(\d+)/);if(!l)return void DoLog(LogLevel.Error,"Get illustId failed, skip this list item!");n.illustId=l[1],r.length>0&&(n.illustType=2),a.length>0&&(n.pageCount=parseInt(a.text()));let g=o.children("div:first");0==g.children().length?o.children("div").length>1&&(g=$(o.children("div").get(1))):g=g.children("div:first"),g.attr({illustId:n.illustId,illustType:n.illustType,pageCount:n.pageCount}),g.addClass("pp-control")}))}function replaceThumbCommon(e){$.each(e,((e,t)=>{let o=(t=$(t)).find("img");if(0==o.length)return iLog.w("No img in the control element."),!0;let n=o.attr("src"),i=convertThumbUrlToSmall(n);n!=i&&o.attr("src",i).css("object-fit","contain")}))}function findLiByImgTag(){let e=[];return $.each($("img"),((t,o)=>{let n=$(o),i=n.parent().parent().parent();if(""!=i.attr("data-gtm-value")&&i.attr("href")&&-1!=i.attr("href").indexOf("/artwork"))for(let t=0;t<10&&(n=n.parent(),0!=n.length);++t)if("LI"==n.get(0).tagName||"UL"==n.parent().get(0).tagName){e.push(n);break}})),e}function CheckUrlTest(){let e=["http://www.pixiv.net","http://www.pixiv.net","https://www.pixiv.net","https://www.pixiv.net/","https://www.pixiv.net/?lang=en","https://www.pixiv.net/search.php?s_mode=s_tag&word=miku","https://www.pixiv.net/search.php?word=VOCALOID&s_mode=s_tag_full","https://www.pixiv.net/discovery","https://www.pixiv.net/discovery?x=1","https://www.pixiv.net/member.php?id=3207350","https://www.pixiv.net/member_illust.php?id=3207350&type=illust","https://www.pixiv.net/bookmark.php?id=3207350&rest=show","https://www.pixiv.net/ranking.php?mode=daily&content=ugoira","https://www.pixiv.net/ranking.php?mode=daily","https://www.pixiv.net/new_illust.php","https://www.pixiv.net/new_illust.php?x=1","https://www.pixiv.net/cate_r18.php","https://www.pixiv.net/cate_r18.php?x=1","https://www.pixiv.net/bookmark.php","https://www.pixiv.net/bookmark.php?x=1","https://www.pixiv.net/stacc?mode=unify","https://www.pixiv.net/artworks/77996773","https://www.pixiv.net/artworks/77996773#preview","https://www.pixiv.net/tags/miku/novels"];for(let t=0;t<e.length;t++)for(let o=0;o<PageType.PageTypeCount;o++)Pages[o].CheckUrl(e[t])&&(console.log(e[t]),console.log("["+t+"] is "+Pages[o].PageTypeString))}function preventDefault(e){e.preventDefault()}Pages[PageType.Search]={PageTypeString:"SearchPage",CheckUrl:function(e){return/^https?:\/\/www.pixiv.net\/tags\/.*\/(artworks|illustrations|manga)/.test(e)||/^https?:\/\/www.pixiv.net\/en\/tags\/.*\/(artworks|illustrations|manga)/.test(e)},ProcessPageElements:function(){let e={loadingComplete:!1,controlElements:[]},t=$("section");DoLog(LogLevel.Info,"Page has "+t.length+" <section>."),DoLog(LogLevel.Elements,t);let o=-1,n=0;if(0==t.length)return iLog.e("No suitable <section>!"),e;$.each(t,((e,t)=>{$(t).find("aside").length>0?o=e:n=e})),iLog.v("premium: "+o),iLog.v("result: "+n);let i=$(t[n]).find("ul"),r=i.find("li").toArray();if(-1!=o){let e=$(t[o]).find("ul").find("li");r=r.concat(e.toArray())}if(-1!=o){let e=$(t[o]).find("aside");$.each(e.children(),((e,t)=>{"ul"!=t.tagName.toLowerCase()?t.remove():$(t).css("-webkit-mask","0")})),e.next().remove()}return processElementListCommon(r),e.controlElements=$(".pp-control"),this.private.pageSelector=i.next().get(0),null==this.private.pageSelector&&(this.private.pageSelector=i.parent().next().get(0)),e.loadingComplete=!0,this.private.imageListConrainer=i.get(0),DoLog(LogLevel.Info,"Process page elements complete."),DoLog(LogLevel.Elements,e),this.private.returnMap=e,e},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarCommon()},HasAutoLoad:!0,GetImageListContainer:function(){return this.private.imageListConrainer},GetFirstImageElement:function(){return $(this.private.imageListConrainer).find("li").get(0)},GetPageSelector:function(){return this.private.pageSelector},private:{imageListContainer:null,pageSelector:null,returnMap:null}},Pages[PageType.BookMarkNew]={PageTypeString:"BookMarkNewPage",CheckUrl:function(e){return/^https:\/\/www.pixiv.net\/bookmark_new_illust.php.*/.test(e)||/^https:\/\/www.pixiv.net\/bookmark_new_illust_r18.php.*/.test(e)},ProcessPageElements:function(){let e={loadingComplete:!1,controlElements:[]},t=$("section");if(DoLog(LogLevel.Info,"Page has "+t.length+" <section>."),DoLog(LogLevel.Elements,t),processElementListCommon(t.find("ul").find("li")),e.controlElements=$(".pp-control"),e.loadingComplete=!0,DoLog(LogLevel.Info,"Process page elements complete."),DoLog(LogLevel.Elements,e),this.private.returnMap=e,g_settings.fullSizeThumb){if(!this.private.returnMap.loadingComplete)return;replaceThumbCommon(this.private.returnMap.controlElements)}return e},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarCommon()},HasAutoLoad:!0,private:{returnMap:null}},Pages[PageType.Discovery]={PageTypeString:"DiscoveryPage",CheckUrl:function(e){return/^https?:\/\/www.pixiv.net\/discovery.*/.test(e)},ProcessPageElements:function(){let e={loadingComplete:!1,controlElements:[]},t=$(".gtm-illust-recommend-zone");return t.length>0?(DoLog(LogLevel.Info,"Found container div."),DoLog(LogLevel.Elements,t),processElementListCommon(t.find("ul").children("li")),e.controlElements=$(".pp-control"),e.loadingComplete=!0,DoLog(LogLevel.Info,"Process page elements complete."),DoLog(LogLevel.Elements,e),this.private.returnMap=e,e):(DoLog(LogLevel.Error,"Can not found container div."),e)},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarCommon()},HasAutoLoad:!0,private:{returnMap:null}},Pages[PageType.Member]={PageTypeString:"MemberPage/MemberIllustPage/MemberBookMark",CheckUrl:function(e){return/^https?:\/\/www.pixiv.net\/(en\/)?users\/\d+/.test(e)},ProcessPageElements:function(){let e={loadingComplete:!1,controlElements:[]},t=findLiByImgTag();DoLog(LogLevel.Elements,t);let o=$("section");if(DoLog(LogLevel.Info,"Page has "+o.length+" <section>."),DoLog(LogLevel.Elements,o),processElementListCommon(t),e.controlElements=$(".pp-control"),e.loadingComplete=!0,DoLog(LogLevel.Info,"Process page elements complete."),DoLog(LogLevel.Elements,e),this.private.returnMap=e,g_settings.fullSizeThumb){if(!this.private.returnMap.loadingComplete)return;replaceThumbCommon(this.private.returnMap.controlElements)}return e},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarCommon()},HasAutoLoad:!0,private:{returnMap:null}},Pages[PageType.Home]={PageTypeString:"HomePage",CheckUrl:function(e){return/https?:\/\/www.pixiv.net\/?$/.test(e)||/https?:\/\/www.pixiv.net\/en\/?$/.test(e)||/https?:\/\/www.pixiv.net\/cate_r18\.php$/.test(e)||/https?:\/\/www.pixiv.net\/en\/cate_r18\.php$/.test(e)},ProcessPageElements:function(){let e={loadingComplete:!1,controlElements:[]};if(processElementListCommon(findLiByImgTag()),e.controlElements=$(".pp-control"),e.loadingComplete=!0,DoLog(LogLevel.Info,"Process page elements complete."),DoLog(LogLevel.Elements,e),this.private.returnMap=e,g_settings.fullSizeThumb){if(!this.private.returnMap.loadingComplete)return;replaceThumbCommon(this.private.returnMap.controlElements)}return e},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarCommon()},HasAutoLoad:!0,private:{returnMap:null}},Pages[PageType.Ranking]={PageTypeString:"RankingPage",CheckUrl:function(e){return/^https?:\/\/www.pixiv.net\/ranking.php.*/.test(e)},ProcessPageElements:function(){let e={loadingComplete:!1,controlElements:[]},t=$("._work");return DoLog(LogLevel.Info,"Found .work, length: "+t.length),DoLog(LogLevel.Elements,t),t.each((function(t,o){let n=$(o),i={illustId:0,illustType:0,pageCount:1},r=n.attr("href");if(null==r||""===r)return void DoLog("Can not found illust id, skip this.");let a=r.match(/artworks\/(\d+)/);a?(i.illustId=a[1],n.hasClass("multiple")&&(i.pageCount=n.find(".page-count").find("span").text()),n.hasClass("ugoku-illust")&&(i.illustType=2),n.attr({illustId:i.illustId,illustType:i.illustType,pageCount:i.pageCount}),e.controlElements.push(o)):DoLog("Can not found illust id, skip this.")})),e.loadingComplete=!0,DoLog(LogLevel.Info,"Process page elements complete."),DoLog(LogLevel.Elements,e),this.private.returnMap=e,e},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarOld()},HasAutoLoad:!0,private:{returnMap:null}},Pages[PageType.NewIllust]={PageTypeString:"NewIllustPage",CheckUrl:function(e){return/^https?:\/\/www.pixiv.net\/new_illust.php.*/.test(e)},ProcessPageElements:function(){let e={loadingComplete:!1,controlElements:[]};if(processElementListCommon(findLiByImgTag()),e.controlElements=$(".pp-control"),e.loadingComplete=!0,DoLog(LogLevel.Info,"Process page elements complete."),DoLog(LogLevel.Elements,e),this.private.returnMap=e,g_settings.fullSizeThumb){if(!this.private.returnMap.loadingComplete)return;replaceThumbCommon(this.private.returnMap.controlElements)}return e},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarCommon()},HasAutoLoad:!0,private:{returnMap:null}},Pages[PageType.R18]={PageTypeString:"R18Page",CheckUrl:function(e){return/^https?:\/\/www.pixiv.net\/cate_r18.php.*/.test(e)},ProcessPageElements:function(){},GetToolBar:function(){},HasAutoLoad:!1},Pages[PageType.BookMark]={PageTypeString:"BookMarkPage",CheckUrl:function(e){return/^https:\/\/www.pixiv.net\/bookmark.php\/?$/.test(e)},ProcessPageElements:function(){let e={loadingComplete:!1,controlElements:[]},t=$(".image-item");return DoLog(LogLevel.Info,"Found images, length: "+t.length),DoLog(LogLevel.Elements,t),t.each((function(t,o){let n=$(o),i=n.find("._work");if(0===i.length)return void DoLog(LogLevel.Warning,"Can not found ._work, skip this.");let r={illustId:0,illustType:0,pageCount:1},a=i.attr("href");if(null==a||""===a)return void DoLog(LogLevel.Warning,"Can not found illust id, skip this.");let s=a.match(/artworks\/(\d+)/);if(!s)return void DoLog(LogLevel.Warning,"Can not found illust id, skip this.");r.illustId=s[1],i.hasClass("multiple")&&(r.pageCount=n.find(".page-count").find("span").text()),i.hasClass("ugoku-illust")&&(r.illustType=2);let l=n.children("a:first");l.attr({illustId:r.illustId,illustType:r.illustType,pageCount:r.pageCount}),e.controlElements.push(l.get(0))})),e.loadingComplete=!0,DoLog(LogLevel.Info,"Process page elements complete."),DoLog(LogLevel.Elements,e),this.private.returnMap=e,e},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarOld()},HasAutoLoad:!1,private:{returnMap:null}},Pages[PageType.Stacc]={PageTypeString:"StaccPage",CheckUrl:function(e){return/^https:\/\/www.pixiv.net\/stacc.*/.test(e)},ProcessPageElements:function(){let e={loadingComplete:!1,controlElements:[]},t=$("._work");return DoLog(LogLevel.Info,"Found .work, length: "+t.length),DoLog(LogLevel.Elements,t),t.each((function(t,o){let n=$(o),i={illustId:0,illustType:0,pageCount:1},r=n.attr("href");if(null==r||""===r)return void DoLog("Can not found illust id, skip this.");let a=r.match(/illust_id=(\d+)/);a?(i.illustId=a[1],n.hasClass("multiple")&&(i.pageCount=n.find(".page-count").find("span").text()),n.hasClass("ugoku-illust")&&(i.illustType=2),n.attr({illustId:i.illustId,illustType:i.illustType,pageCount:i.pageCount}),e.controlElements.push(o)):DoLog("Can not found illust id, skip this.")})),e.loadingComplete=!0,DoLog(LogLevel.Info,"Process page elements complete."),DoLog(LogLevel.Elements,e),this.private.returnMap=e,e},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarOld()},HasAutoLoad:!0,private:{returnMap:null}},Pages[PageType.Artwork]={PageTypeString:"ArtworkPage",CheckUrl:function(e){return/^https:\/\/www.pixiv.net\/artworks\/.*/.test(e)||/^https:\/\/www.pixiv.net\/en\/artworks\/.*/.test(e)},ProcessPageElements:function(){let e=$("main").find("figure").find("canvas");$("main").find("figure").find("canvas").length>0&&(this.private.needProcess=!0,e.addClass("pp-canvas"));let t={loadingComplete:!1,controlElements:[]};if(processElementListCommon(findLiByImgTag()),t.controlElements=$(".pp-control"),t.loadingComplete=!0,DoLog(LogLevel.Info,"Process page elements complete."),DoLog(LogLevel.Elements,t),this.private.returnMap=t,g_settings.fullSizeThumb){if(!this.private.returnMap.loadingComplete)return;replaceThumbCommon(this.private.returnMap.controlElements)}return t},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarCommon()},HasAutoLoad:!0,Work:function(){if(this.private.needProcess){$(".pp-canvas");let e=$('div[role="presentation"]:last').find("button");parseInt($("header").css("height")),parseInt($("header").css("padding-top")),parseInt($("header").css("padding-bottom")),parseInt($("header").css("margin-top")),parseInt($("header").css("margin-bottom")),parseInt($("header").css("border-bottom-width")),parseInt($("header").css("border-top-width"));!function(e){if(!g_settings.enableAnimeDownload)return;let t=e.clone().css({bottom:"50px",padding:0,width:"48px",height:"48px",opacity:"0.4",cursor:"pointer"});function o(){}t.get(0).innerHTML='<svg viewBox="0 0 120 120" style="width: 40px; height: 40px; stroke-width: 10; stroke-linecap: round; stroke-linejoin: round; border-radius: 24px; background-color: black; stroke: limegreen; fill: none;" class="_3Fo0Hjg"><polyline points="60,30 60,90"></polyline><polyline points="30,60 60,90 90,60"></polyline></svg></button>',$(window).on("resize",o),e.after(t),t.mouseover((function(){$(this).css("opacity","0.2")})).mouseleave((function(){$(this).css("opacity","0.4")})).click((function(){let e="",t=location.href.match(/artworks\/(\d+)/);t?(e=t[1],DoLog(LogLevel.Info,"IllustId="+e),$.ajax(g_getUgoiraUrl.replace("#id#",e),{method:"GET",success:function(e){DoLog(LogLevel.Elements,e),1!=e.error?window.open("_blank").location=e.body.originalSrc:DoLog(LogLevel.Error,"Server response an error: "+e.message)},error:function(){DoLog(LogLevel.Error,"Request zip file failed!")}})):DoLog(LogLevel.Error,"Can not found illust id!")}))}(e)}},private:{needProcess:!1,returnMap:null}},Pages[PageType.NovelSearch]={PageTypeString:"NovelSearchPage",CheckUrl:function(e){return/^https:\/\/www.pixiv.net\/tags\/.*\/novels/.test(e)||/^https:\/\/www.pixiv.net\/en\/tags\/.*\/novels/.test(e)},ProcessPageElements:function(){let e={loadingComplete:!1,controlElements:[]};return $("section:first").find("ul:first").length>0&&(e.loadingComplete=!0),this.private.returnMap=e,e},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarCommon()},GetPageSelector:function(){return $("section:first").find("nav:first")},HasAutoLoad:!1,private:{returnMap:null}},Pages[PageType.SearchTop]={PageTypeString:"SearchTopPage",CheckUrl:function(e){return/^https?:\/\/www.pixiv.net(\/en)?\/tags\/[^/*]/.test(e)},ProcessPageElements:function(){let e={loadingComplete:!1,controlElements:[]},t=$("section");DoLog(LogLevel.Info,"Page has "+t.length+" <section>."),DoLog(LogLevel.Elements,t);let o=-1,n=0;if(0==t.length)return iLog.e("No suitable <section>!"),e;t.length>1&&(o=0,n=1),iLog.v("premium: "+o),iLog.v("result: "+n);let i=$(t[n]).find("ul"),r=i.find("li").toArray();if(-1!=o){let e=$(t[o]).find("ul").find("li");r=r.concat(e.toArray())}if(-1!=o){let e=$(t[o]).find("aside");$.each(e.children(),((e,t)=>{"ul"!=t.tagName.toLowerCase()?t.remove():$(t).css("-webkit-mask","0")})),e.next().remove()}return processElementListCommon(r),e.controlElements=$(".pp-control"),this.private.pageSelector=i.next().get(0),null==this.private.pageSelector&&(this.private.pageSelector=i.parent().next().get(0)),e.loadingComplete=!0,this.private.imageListConrainer=i.get(0),DoLog(LogLevel.Info,"Process page elements complete."),DoLog(LogLevel.Elements,e),this.private.returnMap=e,e},GetProcessedPageElements:function(){return null==this.private.returnMap?this.ProcessPageElements():this.private.returnMap},GetToolBar:function(){return findToolbarCommon()},HasAutoLoad:!1,GetImageListContainer:function(){return this.private.imageListConrainer},GetFirstImageElement:function(){return $(this.private.imageListConrainer).find("li").get(0)},GetPageSelector:function(){return this.private.pageSelector},private:{imageListContainer:null,pageSelector:null,returnMap:null}};const wheelOpt={passive:!1},wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel";function disableScroll(){window.addEventListener(wheelEvent,preventDefault,wheelOpt)}function enableScroll(){window.removeEventListener(wheelEvent,preventDefault,wheelOpt)}let autoLoadInterval=null;function PixivPreview(){let e="";function t(){let t=Pages[g_pageType].GetProcessedPageElements();function l(){let e=$(".pp-main");0!=e.length&&("none"==e.css("display")?(iLog.i("Show main."),n(),e.show(),g_settings.previewFullScreen&&disableScroll()):(iLog.i("Hide main."),e.hide(),enableScroll()))}function g(){let e=$(".pp-main");0!=e.length&&"none"==e.css("display")&&(iLog.i("Show main."),n(),e.show(),g_settings.previewFullScreen&&disableScroll())}t.loadingComplete?(g_settings.previewByKey&&($(document).unbind("keydown"),$(document).keydown((e=>{e.keyCode==g_settings.previewKey&&l()}))),$(t.controlElements).mouseenter((function(t){if(t.ctrlKey)return;let o=(new Date).getTime(),s=parseInt(null==g_settings.previewDelay?g_defaultSettings.previewDelay:g_settings.previewDelay),p=$(this),d=p.attr("illustId"),u=p.attr("illustType"),c=p.attr("pageCount");if(null==d)return void DoLog(LogLevel.Error,"Can not found illustId in this element's attrbutes.");if(null==u)return void DoLog(LogLevel.Error,"Can not found illustType in this element's attrbutes.");if(null==c)return void DoLog(LogLevel.Error,"Can not found pageCount in this element's attrbutes.");if(e=d,2==u&&!g_settings.enableAnimePreview)return void iLog.i("Anime preview disabled.");g_mousePos={x:t.pageX,y:t.pageY};let h=$(document.createElement("div")).addClass("pp-main").attr("illustId",d).css({position:"absolute","z-index":"999999",left:g_mousePos.x+"px",top:g_mousePos.y+"px","border-style":"solid","border-color":"#6495ed","border-width":"2px","border-radius":"20px",width:"48px",height:"48px","background-image":"url(https://pp-1252089172.cos.ap-chengdu.myqcloud.com/transparent.png)",display:"none","text-align":"center"});if($(".pp-main").remove(),$("body").append(h),g_settings.previewFullScreen&&(h.css({background:"#ffffff80",position:"fixed"}),h.click((e=>{$(e.target).hasClass("pp-image")||l()}))),!g_settings.previewByKey){let e=s-((new Date).getTime()-o);e>0?setTimeout(g,e):g()}let f=$(new Image).addClass("pp-loading").attr("src",g_loadingImage).css({position:"absolute","border-radius":"20px",left:"0px",top:"0px"});h.append(f);let m=$(new Image).addClass("pp-image").css({height:"0px",width:"0px",display:"none","border-radius":"20px"});h.append(m);let v=$(new Image).addClass("pp-original").attr("src","https://source.pixiv.net/www/images/pixivcomic-favorite.png").css({position:"absolute",bottom:"5px",right:"5px",display:"none"});h.append(v),v.click((function(){window.open($(h).children("img")[1].src)}));let _=$('<div class="pp-pageCount" style="display: flex;-webkit-box-align: center;align-items: center;box-sizing: border-box;margin-left: auto;height: 20px;color: rgb(255, 255, 255);font-size: 10px;line-height: 12px;font-weight: bold;flex: 0 0 auto;padding: 4px 6px;background: rgba(0, 0, 0, 0.32);border-radius: 10px;margin-top:5px;margin-right:5px;"><svg viewBox="0 0 9 10" width="9" height="10" style="stroke: none;line-height: 0;font-size: 0px;fill: currentcolor;"><path d="M8,3 C8.55228475,3 9,3.44771525 9,4 L9,9 C9,9.55228475 8.55228475,10 8,10 L3,10 C2.44771525,10 2,9.55228475 2,9 L6,9 C7.1045695,9 8,8.1045695 8,7 L8,3 Z M1,1 L6,1 C6.55228475,1 7,1.44771525 7,2 L7,7 C7,7.55228475 6.55228475,8 6,8 L1,8 C0.44771525,8 0,7.55228475 0,7 L0,2 C0,1.44771525 0.44771525,1 1,1 Z"></path></svg><span style="margin-left:2px;" class="pp-page">0/0</span></div>').css({position:"absolute",top:"0px",display:"none",right:"0px",display:"none"});h.append(_),$(".pp-main").mouseleave((function(e){g_settings.previewFullScreen||$(this).remove()}));let L="";L=2==u?g_getUgoiraUrl.replace("#id#",d):g_getArtworkUrl.replace("#id#",d),$.ajax(L,{method:"GET",success:function(t){if(DoLog(LogLevel.Info,"Got artwork urls:"),DoLog(LogLevel.Elements,t),!0!==t.error)if(d==e)if(2==u){let o=t.body.src,r=t.body.originalSrc,s=t.body.mime_type,l=t.body.frames;DoLog(LogLevel.Info,"Process urls complete."),DoLog(LogLevel.Info,o),DoLog(LogLevel.Info,r),function(t,o,r,s,l,g){i=g,null==l&&(l=!1);g_settings.original=l?1:0,g_settings.previewFullScreen||$(".pp-image").mouseenter((function(){disableScroll()})).mouseleave((function(){enableScroll()}));a&&a.stop();a=function(e){var t=document.createElement("canvas"),o={canvas:t,chunkSize:3e5,loop:!0,autoStart:!0,debug:!1};if(e)for(var n in e)o[n]=e[n];var i=new ZipImagePlayer(o);return i.canvas=t,i}({source:t,metadata:{mime_type:r,frames:s}}),$(a.canvas).mouseenter((function(){disableScroll()})).mouseleave((function(){enableScroll()})),$(a).on("frameLoaded",(function(t,o){if(i!=e)return;if(0!=o)return;let r=$(".pp-image");r.after(a.canvas),r.remove();let s=$(a.canvas);s.addClass("pp-image"),$(".pp-loading").css("display","none");let l=t.currentTarget._frameImages[0].width,g=t.currentTarget._frameImages[0].height;s.attr({width:l,height:g}).css({"border-radius":"20px"}),s.attr({originWidth:l,originHeight:g}),n()}))}(o,0,s,l,g_settings.original,d)}else{let e=[],o=[];for(let n=0;n<t.body.length;n++)e.push(t.body[n].urls.regular),o.push(t.body[n].urls.original);DoLog(LogLevel.Info,"Process urls complete."),DoLog(LogLevel.Elements,e),DoLog(LogLevel.Elements,o),r(e,0,o,g_settings.original,d)}else DoLog(LogLevel.Info,"Drop this preview request.");else DoLog(LogLevel.Error,"Server responsed an error: "+t.message)},error:function(e){DoLog(LogLevel.Error,"Request image urls failed!"),e&&DoLog(LogLevel.Elements,e)}})})),$(t.controlElements).mouseleave((function(e){if(g_settings.previewByKey)return;let t=$(this),o=t.attr("illustId"),n=(t.attr("illustType"),t.attr("pageCount"),$(e.relatedTarget)),i=!1;for(;n.hasClass("pp-main")&&n.attr("illustId")==o&&(i=!0),!(n.parent().length<1);)n=n.parent();i||$(".pp-main").remove()})),$(t.controlElements).mousemove((function(e){e.ctrlKey||4&e.buttons||(g_mousePos.x=e.pageX,g_mousePos.y=e.pageY,g_settings.previewByKey&&"none"!=$(".pp-main").css("display")||n())})),Pages[g_pageType].HasAutoLoad&&null==autoLoadInterval&&(autoLoadInterval=setInterval(s,1e3),DoLog(LogLevel.Info,"Auto load interval set.")),unsafeWindow.PreviewCallback=o,DoLog(LogLevel.Info,"Callback function was inserted."),DoLog(LogLevel.Elements,unsafeWindow.PreviewCallback),DoLog(LogLevel.Info,"Preview enable succeed!")):DoLog(LogLevel.Error,"Page not load, should not call Preview!")}function o(e,t){DoLog(LogLevel.Info,"iframe callback, width: "+e+", height: "+t);let o=n();$(".pp-loading").hide(),$(".pp-iframe").css({width:o.width,height:o.height}).show()}function n(){let e=document.documentElement.clientWidth,t=document.documentElement.clientHeight,o=0,n=document.body.scrollTop+document.documentElement.scrollTop,i=0,r=0;$(".pp-main").find("canvas").length>0?(i=null==$(".pp-image").get(0)?0:$(".pp-image").get(0).width,r=null==$(".pp-image").get(0)?0:$(".pp-image").get(0).height):($(".pp-image").css({width:"",height:""}),i=null==$(".pp-image").get(0)?0:$(".pp-image").get(0).width,r=null==$(".pp-image").get(0)?0:$(".pp-image").get(0).height);let a=48,s=48;if(g_settings.previewFullScreen)return a=e,s=r/i*a,s>t&&(s=t,a=s/r*i),s-=5,a-=5,$(".pp-image").css({height:s+"px",width:a+"px"}),$(".pp-main").css({left:"0px",top:"0px",width:e-5,height:t-5}),{width:a,height:s};let l=g_mousePos.x>e/2;return i>0&&r>0&&(a=l?g_mousePos.x-30:e-g_mousePos.x-30,s=r/i*a,s>t&&(s=t,a=s/r*i),a-=5,s-=5,$(".pp-image").css({height:s+"px",width:a+"px"}),$(".pp-loading").css({left:a/2-24+"px",top:s/2-24+"px"})),n+s<=g_mousePos.y&&(n=g_mousePos.y-s-30),o=l?g_mousePos.x-a-30:g_mousePos.x+30,$(".pp-main").css({left:o+"px",top:n+"px",width:a,height:s}),{width:a,height:s}}let i="";function r(t,o,a,s,l){i=l,t&&0!==t.length?null==o||o<0||o>=t.length?DoLog(LogLevel.Error,"Index("+o+") out of range, can not view images!"):(null!=a&&0!==a.length||(DoLog(LogLevel.Warning,"Original array is null, replace it with regular array."),a=t),a.length<t&&(DoLog(LogLevel.Warning,"Original array's length is less than regular array, replace it with regular array."),a=t),null==s&&(s=!1),a.length>1&&($(".pp-page").text(o+1+"/"+t.length),$(".pp-pageCount").show()),s?$(".pp-image").addClass("original"):$(".pp-image").removeClass("original"),g_settings.original=s?1:0,$(".pp-original, .pp-pageCount").hide(),null!=$(".pp-image").attr("index")&&$(".pp-image").attr("pageCount")==t.length||($(".pp-image").attr("pageCount",t.length),$(".pp-image").on("click",(function(e){let o=$(this),n=o.hasClass("original"),i=o.attr("index");if(i=null==i?0:parseInt(i),e.ctrlKey)n=!n,r(t,i,a,n,l);else if(e.shiftKey)window.open(a[i]);else{if(1==t.length)return;++i>=t.length&&(i=0),r(t,i,a,n,l);for(let e=i+1;e<t.length&&e<=i+3;e++){(new Image).src=n?a[e]:t[e]}}})),$(".pp-image").bind("mousewheel",(function(e){let o=$(this),n=o.hasClass("original"),i=o.attr("index");if(i=null==i?0:parseInt(i),1!=t.length){e.originalEvent.wheelDelta<0?++i>=t.length&&(i=0):--i<0&&(i=t.length-1),r(t,i,a,n,l);for(let e=i+1;e<t.length&&e<=i+3;e++){(new Image).src=n?a[e]:t[e]}}})),g_settings.previewFullScreen||$(".pp-image").mouseenter((function(){disableScroll()})).mouseleave((function(){enableScroll()})),$(".pp-image").on("load",(function(){if(i!=e)return void DoLog(LogLevel.Info,"(2)Drop this preview request.");let r=$(this),s=(n(),r.hasClass("original"));$(".pp-loading").css("display","none"),$(".pp-image").css("display",""),t.length>1&&$(".pp-pageCount").show(),s&&$(".pp-original").show();for(let e=o+1;e<t.length&&e<=o+3;e++){(new Image).src=s?a[e]:t[e]}})).on("error",(function(){DoLog(LogLevel.Error,"Load image failed!")}))),$(".pp-image").attr("src",s?a[o]:t[o]).attr("index",o)):DoLog(LogLevel.Error,"Regular url array is null, can not view images!")}var a;function s(){if(null==Pages[g_pageType].GetProcessedPageElements())return void DoLog(LogLevel.Error,"Call ProcessPageElements first!");let e=Pages[g_pageType].GetProcessedPageElements(),o=Pages[g_pageType].ProcessPageElements();if(o.loadingComplete){if(e.controlElements.length!=o.controlElements.length||o.forceUpdate)return DoLog(LogLevel.Info,"Page loaded "+(o.controlElements.length-e.controlElements.length)+" new work(s)."),g_settings.linkBlank&&$(o.controlElements).find("a").attr("target","_blank"),SetTargetBlank(o),function(){let e=Pages[g_pageType].GetProcessedPageElements();e.loadingComplete?($(e.controlElements).unbind("mouseenter").unbind("mouseleave").unbind("mousemove"),autoLoadInterval&&(clearInterval(autoLoadInterval),autoLoadInterval=null),DoLog(LogLevel.Info,"Preview disable succeed!")):DoLog(LogLevel.Error,"Page not load, should not call Preview!")}(),void t();if(e.controlElements.length>o.controlElements.length)return DoLog(LogLevel.Warning,"works become less?"),void(Pages[g_pageType].private.returnMap=e)}DoLog(LogLevel.Info,"Page not change.")}t()}let imageElementTemplate=null;function PixivSK(e){(g_settings.pageCount<1||g_settings.favFilter<0)&&(g_settings.pageCount=1,g_settings.favFilter=0);let t=0,o="https://www.pixiv.net/ajax/search/",n=0,i=[],r=0;if(g_pageType!=PageType.Search)return;let a=function(e){$("#progress").text(Texts[g_language].sort_getWorks.replace("%1",t+1).replace("%2",g_settings.pageCount));let i=o.replace(/p=\d+/,"p="+n);if(-1!=location.href.indexOf("?")){let e=location.href.split("?")[1];e=e.replace(/^p=\d+/,""),e=e.replace(/&p=\d+/,""),i+="&"+e}-1==i.indexOf("order=")&&(i+="&order=date_d"),-1==i.indexOf("mode=")&&(i+="&mode=all"),-1==i.indexOf("s_mode=")&&(i+="&s_mode=s_tag_full"),DoLog(LogLevel.Info,"getWorks url: "+i);let r=new XMLHttpRequest;r.open("GET",i,!0),r.onload=function(t){e(r)},r.onerror=function(e){DoLog(LogLevel.Error,"Request search page error!")},r.send(null)};function s(e,t,o){return new Promise((function(n,i){null==o&&(o=0);let r=[];$.ajax("https://www.pixiv.net/ajax/user/"+e+"/following?offset="+o+"&limit=100&rest="+t,{async:!0,success:function(i){if(null==i||i.error)return DoLog(LogLevel.Error,"Following response contains an error."),void n([]);0!=i.body.users.length?($.each(i.body.users,(function(e,t){r.push(t.userId)})),s(e,t,o+100).then((function(e){n(r.concat(e))}))):n([])},error:function(){DoLog(LogLevel.Error,"Request following failed."),n([])}})}))}let l=function(){return new Promise((function(e,t){g_settings.hideFollowed||e(),new Promise((function(e,t){let o="";try{o=dataLayer[0].user_id}catch(t){return DoLog(LogLevel.Error,"Get user id failed."),void e([])}$("#progress").text(Texts[g_language].sort_getPublicFollowing);let n=GetLocalStorage("followingOfUid-"+o)||GetCookie("followingOfUid-"+o);null==n||"null"==n?s(o,"show").then((function(t){$("#progress").text(Texts[g_language].sort_getPrivateFollowing),s(o,"hide").then((function(n){let i=t.concat(n);SetLocalStorage("followingOfUid-"+o,i),e(i)}))})):e(n)})).then((function(t){let o=[],n=0;$(i).each((function(e,i){let r=!1;for(let e=0;e<t.length;e++)if(t[e]==i.userId){r=!0;break}r?n++:o.push(i)})),i=o,DoLog(LogLevel.Info,n+" works were hide."),DoLog(LogLevel.Elements,i),e()}))}))};if(0===n){let e=location.href;-1==e.indexOf("&p=")&&-1==e.indexOf("?p=")&&(DoLog(LogLevel.Warning,"Can not found page in url."),-1==e.indexOf("?")?(e+="?p=1",DoLog(LogLevel.Info,'Add "?p=1": '+e)):(e+="&p=1",DoLog(LogLevel.Info,'Add "&p=1": '+e)));let t=e.match(/\/tags\/([^/]*)\//),i="";if(!t)return void DoLog(LogLevel.Error,"Can not found search key word!");DoLog(LogLevel.Info,"Search key word: "+i),i=t[1];let r=e.match(/p=(\d*)/)[1];n=parseInt(r),DoLog(LogLevel.Info,"Current page: "+n);let a=e.match(/tags\/.*\/(.*)[?$]/)[1];o+=a+"/",o+=i+"?word="+i+"&p="+n,DoLog(LogLevel.Info,"Current url: "+o)}else DoLog(LogLevel.Error,"???");let g=Pages[PageType.Search].GetImageListContainer();$(g).hide().before('<div id="loading" style="width:100%;text-align:center;"><img src="'+g_loadingImage+'" /><p id="progress" style="text-align: center;font-size: large;font-weight: bold;padding-top: 10px;">0%</p></div>');{let e=Pages[PageType.Search].GetPageSelector();if(null==e)return void DoLog(LogLevel.Error,"Can not found page selector!");if($(e).find("a").length>2){let t=$(e).find("a").get(1),o=[],i="Previewer";for(let e=0;e<9;e++){let n=t.cloneNode(!0);$(n).find("span").text(i[e]),o.push(n)}for($(e).find("button").remove();$(e).find("a").length>2;)$(e).find("a:first").next().remove();for(let t=0;t<9;t++)$(e).find("a:last").before(o[t]);$(e).find("a").attr("href","javascript:;");let r=location.href;-1==r.indexOf("&p=")&&-1==r.indexOf("?p=")&&(-1==r.indexOf("?")?r+="?p=1":r+="&p=1");let a=r.replace(/p=\d+/,"p="+(n-g_settings.pageCount>1?n-g_settings.pageCount:1)),s=r.replace(/p=\d+/,"p="+(n+g_settings.pageCount));DoLog(LogLevel.Info,"Previous page url: "+a),DoLog(LogLevel.Info,"Next page url: "+s);let l=$(e).find("a:first");l.before(l.clone()),l.remove();let g=$(e).find("a:last");g.before(g.clone()),g.remove(),$(e).find("a:first").attr("href",a).addClass("pp-prevPage"),$(e).find("a:last").attr("href",s).addClass("pp-nextPage")}let o=function(e){let s=!1;try{let t=JSON.parse(e.responseText);if(!t.hasOwnProperty("error"))return void DoLog(LogLevel.Error,'Key "error" not found!');if(!1!==t.error)return void DoLog(LogLevel.Error,"ajax error!");{let e;t.body.illustManga?e=t.body.illustManga.data:t.body.manga?e=t.body.manga.data:t.body.illust&&(e=t.body.illust.data),e.length>0?i=i.concat(e):s=!0}}catch(t){DoLog(LogLevel.Error,"A invalid json string!"),DoLog(LogLevel.Info,e.responseText)}if(n++,t++,s&&(iLog.w(LogLevel.Warning,"No artworks found, ignore "+(g_settings.pageCount-t)+" pages."),n+=g_settings.pageCount-t,t=g_settings.pageCount),t==g_settings.pageCount){DoLog(LogLevel.Info,"Load complete, start to load bookmark count."),DoLog(LogLevel.Elements,i);let e=[],t=new Set;for(let o=0;o<i.length;o++)i[o].id&&!t.has(i[o].id)?(e.push(i[o]),t.add(i[o].id)):iLog.w("ignore work: "+i[o].id);i=e,r=i.length,DoLog(LogLevel.Info,"Clear ad container complete."),DoLog(LogLevel.Elements,i),u(0)}else a(o)};a(o)}let p=[],d=0;let u=function(e){if(e>=i.length)c();else{0===p.length&&function(){p.length=0;let e=function(e){let t=null;try{t=JSON.parse(e.responseText)}catch(e){return DoLog(LogLevel.Error,"Parse json failed!"),void DoLog(LogLevel.Element,e)}if(t){let o="",n=e.finalUrl.match(/illust_id=(\d+)/);if(!n)return void DoLog(LogLevel.Error,"Can not get illust id from url: "+e.finalUrl);o=n[1];let r=-1;for(let e=0;e<g_maxXhr;e++)if(p[e].illustId==o){r=e;break}if(-1==r)return void DoLog(LogLevel.Error,"This url not match any request!");if(p[r].complete=!0,t.error)DoLog(LogLevel.Error,"Some error occured: "+t.message);else{let e=t.body.illust_details.bookmark_user_total;i[d+r].bookmarkCount=parseInt(e),DoLog(LogLevel.Info,"IllustId: "+o+", bookmarkCount: "+e)}let a=0,s=0;for(let e=0;e<g_maxXhr;e++)p[e].complete&&(a++,""!=p[e].illustId&&s++);$("#loading").find("#progress").text(Texts[g_language].sort_getBookmarkCount.replace("%1",d+s).replace("%2",i.length)),a==g_maxXhr&&(d+=g_maxXhr,u(d))}},t=function(e){let t="",o=e.finalUrl.match(/illust_id=(\d+)/);if(!o)return void DoLog(LogLevel.Error,"Can not get illust id from url: "+e.finalUrl);t=o[1],DoLog(LogLevel.Error,"Send request failed, set this illust("+t+")'s bookmark count to 0!");let n=-1;for(let e=0;e<g_maxXhr;e++)if(p[e].illustId==t){n=e;break}if(-1==n)return void DoLog("This url not match any request!");i[d+n].bookmarkCount=0,p[n].complete=!0;let r=0,a=0;for(let e=0;e<g_maxXhr;e++)p[e].complete&&(r++,""!=p[e].illustId&&a++);$("#loading").find("#progress").text(Texts[g_language].sort_getBookmarkCount.replace("%1",d+a).replace("%2",i.length)),r==g_maxXhr&&(d+=g_maxXhr,u(d+g_maxXhr))};for(let o=0;o<g_maxXhr;o++)p.push({illustId:"",complete:!1,onabort:t,onerror:t,onload:e,ontimeout:t})}();for(let t=0;t<g_maxXhr;t++){if(e+t>=i.length){p[t].complete=!0,p[t].illustId="";continue}let o=i[e+t].id,n="https://www.pixiv.net/touch/ajax/illust/details?illust_id="+o;p[t].illustId=o,p[t].complete=!1,GM__xmlHttpRequest({method:"GET",url:n,anonymous:!0,onabort:p[t].onerror,onerror:p[t].onerror,onload:p[t].onload,ontimeout:p[t].onerror})}}},c=function(){new Promise((function(e,t){DoLog(LogLevel.Info,"Start sort."),DoLog(LogLevel.Elements,i);let o=Texts[g_language].sort_filtering.replace("%2",g_settings.favFilter);o=o.replace("%1",g_settings.hideFavorite?Texts[g_language].sort_filteringHideFavorite:""),$("#progress").text(o);let n=[],r=new Set(g_settings.hideByTagList.replace("，",",").split(","));$(i).each((function(e,t){return(t.bookmarkCount?t.bookmarkCount:0)<g_settings.favFilter||!(!g_settings.hideFavorite||!t.bookmarkData)||1==g_settings.aiFilter&&2==t.aiType||!(!g_settings.hideByTag||!t.tags.some((e=>r.has(e))))||void n.push(t)})),i=n,l().then((function(){i.sort((function(e,t){let o=e.bookmarkCount,n=t.bookmarkCount;return o||(o=0),n||(n=0),o>n?-1:o<n?1:0})),DoLog(LogLevel.Info,"Sort complete."),DoLog(LogLevel.Elements,i),e()}))})).then((function(){let t=Pages[PageType.Search].GetImageListContainer(),o=Pages[PageType.Search].GetFirstImageElement();if($(o).find("[data-mouseover]").removeAttr("data-mouseover"),null==imageElementTemplate){imageElementTemplate=o.cloneNode(!0);let e=$(imageElementTemplate).find(".pp-control");if(null==e)return void iLog.w("Cannot found some elements!");let t=e.find("a:first"),n=t.find("img:first"),i=n.parent(),r=t.parent(),a=e.next();null!=n&&null!=i&&null!=t&&null!=r&&null!=a||DoLog(LogLevel.Error,"Can not found some elements!");let s=$("<a></a>");0==a.children().length?a.append(s):s=a.children("a:first");let l=a.next(),g=l.find("a:first"),p=l.find("a:last"),d=p,u=$(l.find("img").get(0)),c=t.next().find("svg"),h=t.children("div:last"),f=h.clone();f.css({top:"auto",bottom:"0px",width:"65%"}),h.parent().append(f),n.addClass("ppImg"),t.addClass("ppImageLink"),s.addClass("ppTitleLink"),g.addClass("ppAuthorLinkProfileImage"),p.addClass("ppAuthorLink"),d.addClass("ppAuthorName"),u.addClass("ppAuthorImage"),c.attr("class",c.attr("class")+" ppBookmarkSvg"),h.addClass("ppAdditionTag"),f.addClass("ppBookmarkCount"),n.attr("src","");let m=n.next();0!=m.length&&"SVG"==m.get(0).tagName&&m.remove(),h.empty(),f.empty(),c.find("path:first").css("fill","rgb(31, 31, 31)"),c.find("path:last").css("fill","rgb(255, 255, 255)"),i.find("svg").remove(),g_settings.linkBlank&&(t.attr("target","_blank"),s.attr("target","_blank"),g.attr("target","_blank"),p.attr("target","_blank"))}$(t).empty();for(let e=0;e<i.length;e++){let o=$(imageElementTemplate.cloneNode(!0)),n=i[e].url;if(g_settings.fullSizeThumb&&(n=convertThumbUrlToSmall(i[e].url)),o.find(".ppImg").attr("src",n).css("object-fit","contain"),o.find(".ppImageLink").attr("href","/artworks/"+i[e].id),o.find(".ppTitleLink").attr("href","/artworks/"+i[e].id).text(i[e].title),o.find(".ppAuthorLink, .ppAuthorLinkProfileImage").attr("href","/member.php?id="+i[e].userId).attr({userId:i[e].userId,profileImageUrl:i[e].profileImageUrl,userName:i[e].userName}),o.find(".ppAuthorName").text(i[e].userName),o.find(".ppAuthorImage").parent().attr("titile",i[e].userName),o.find(".ppAuthorImage").attr("src",i[e].profileImageUrl),o.find(".ppBookmarkSvg").attr("illustId",i[e].id),i[e].bookmarkData&&(o.find(".ppBookmarkSvg").find("path").css("fill","rgb(255, 64, 96)"),o.find(".ppBookmarkSvg").attr("bookmarkId",i[e].bookmarkData.id)),0!==i[e].xRestrict){let e='<div style="margin-top: 2px; margin-left: 2px;"><div style="color: rgb(255, 255, 255);font-weight: bold;font-size: 10px;line-height: 1;padding: 3px 6px;border-radius: 3px;background: rgb(255, 64, 96);">R-18</div></div>';o.find(".ppAdditionTag").append(e)}if(i[e].pageCount>1){let t='<div style="display: flex;-webkit-box-align: center;align-items: center;box-sizing: border-box;margin-left: auto;height: 20px;color: rgb(255, 255, 255);font-size: 10px;line-height: 12px;font-weight: bold;flex: 0 0 auto;padding: 4px 6px;background: rgba(0, 0, 0, 0.32);border-radius: 10px;"><svg viewBox="0 0 9 10" width="9" height="10" style="stroke: none;line-height: 0;font-size: 0px;fill: currentcolor;"><path d="M8,3 C8.55228475,3 9,3.44771525 9,4 L9,9 C9,9.55228475 8.55228475,10 8,10 L3,10 C2.44771525,10 2,9.55228475 2,9 L6,9 C7.1045695,9 8,8.1045695 8,7 L8,3 Z M1,1 L6,1 C6.55228475,1 7,1.44771525 7,2 L7,7 C7,7.55228475 6.55228475,8 6,8 L1,8 C0.44771525,8 0,7.55228475 0,7 L0,2 C0,1.44771525 0.44771525,1 1,1 Z"></path></svg><span style="margin-left: 2px;">'+i[e].pageCount+"</span></div>";o.find(".ppAdditionTag").append(t)}let r='<div style="margin-bottom: 6px; margin-left: 2px;"><div style="color: rgb(7, 95, 166);font-weight: bold;font-size: 13px;line-height: 1;padding: 3px 6px;border-radius: 3px;background: rgb(204, 236, 255);">'+i[e].bookmarkCount+" likes</div></div>";if(o.find(".ppBookmarkCount").append(r),2==i[e].illustType){let e='<svg viewBox="0 0 24 24" style="width: 48px; height: 48px;stroke: none;fill: rgb(255, 255, 255);line-height: 0;font-size: 0px;vertical-align: middle;position:absolute;"><circle cx="12" cy="12" r="10" style="fill: rgb(0, 0, 0);fill-opacity: 0.4;"></circle><path d="M9,8.74841664 L9,15.2515834 C9,15.8038681 9.44771525,16.2515834 10,16.2515834 C10.1782928,16.2515834 10.3533435,16.2039156 10.5070201,16.1135176 L16.0347118,12.8619342 C16.510745,12.5819147 16.6696454,11.969013 16.3896259,11.4929799 C16.3034179,11.3464262 16.1812655,11.2242738 16.0347118,11.1380658 L10.5070201,7.88648243 C10.030987,7.60646294 9.41808527,7.76536339 9.13806578,8.24139652 C9.04766776,8.39507316 9,8.57012386 9,8.74841664 Z"></path></svg>';o.find(".ppImg").after(e)}$(t).append(o)}$(".ppBookmarkSvg").parent().on("click",(function(e){if(""==g_csrfToken)return DoLog(LogLevel.Error,"No g_csrfToken, failed to add bookmark!"),void alert("获取 Token 失败，无法添加，请到详情页操作。");let t=0;e.ctrlKey&&(t=1);let o=$(this).children("svg:first"),n=o.attr("illustId"),i=o.attr("bookmarkId");null==i||""==i?(DoLog(LogLevel.Info,"Add bookmark, illustId: "+n),$.ajax("/ajax/illusts/bookmarks/add",{method:"POST",contentType:"application/json;charset=utf-8",headers:{"x-csrf-token":g_csrfToken},data:'{"illust_id":"'+n+'","restrict":'+t+',"comment":"","tags":[]}',success:function(e){if(DoLog(LogLevel.Info,"addBookmark result: "),DoLog(LogLevel.Elements,e),e.error)return void DoLog(LogLevel.Error,"Server returned an error: "+e.message);let t=e.body.last_bookmark_id;DoLog(LogLevel.Info,"Add bookmark success, bookmarkId is "+t),o.attr("bookmarkId",t),o.find("path").css("fill","rgb(255, 64, 96)")}})):(DoLog(LogLevel.Info,"Delete bookmark, bookmarkId: "+i),$.ajax("/rpc/index.php",{method:"POST",headers:{"x-csrf-token":g_csrfToken},data:{mode:"delete_illust_bookmark",bookmark_id:i},success:function(e){DoLog(LogLevel.Info,"delete bookmark result: "),DoLog(LogLevel.Elements,e),e.error?DoLog(LogLevel.Error,"Server returned an error: "+e.message):(DoLog(LogLevel.Info,"Delete bookmark success."),o.attr("bookmarkId",""),o.find("path:first").css("fill","rgb(31, 31, 31)"),o.find("path:last").css("fill","rgb(255, 255, 255)"))}})),o.parent().focus()})),$(".ppAuthorLink").on("mouseenter",(function(e){let t=$(this);let o=!1;$.ajax("https://www.pixiv.net/ajax/user/"+t.attr("userId")+"?full=1",{method:"GET",async:!1,success:function(e){0==e.error&&e.body.isFollowed&&(o=!0)}}),$(".pp-authorDiv").remove();let n=$('<div class="pp-authorDiv"><div class="ppa-main" style="position: absolute; top: 0px; left: 0px; border-width: 1px; border-style: solid; z-index: 1; border-color: rgba(0, 0, 0, 0.08); border-radius: 8px;"><div class=""style="    width: 336px;    background-color: rgb(255, 255, 255);    padding-top: 24px;    flex-flow: column;"><div class=""style=" display: flex; align-items: center; flex-flow: column;"><a class="ppa-authorLink"><div role="img"size="64"class=""style=" display: inline-block; width: 64px; height: 64px; border-radius: 50%; overflow: hidden;"><img class="ppa-authorImage" width="64"height="64"style="object-fit: cover; object-position: center top;"></div></a><a class="ppa-authorLink"><div class="ppa-authorName" style=" line-height: 24px; font-size: 16px; font-weight: bold; margin: 4px 0px 0px;"></div></a><div class=""style=" margin: 12px 0px 24px;"><button type="button"class="ppa-follow"style=" padding: 9px 25px; line-height: 1; border: none; border-radius: 16px; font-weight: 700; background-color: #0096fa; color: #fff; cursor: pointer;"><span style="margin-right: 4px;"><svg viewBox="0 0 8 8"width="10"height="10"class=""style=" stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 2;"><line x1="1"y1="4"x2="7"y2="4"></line><line x1="4"y1="1"x2="4"y2="7"></line></svg></span>关注</button></div></div></div></div></div>');$("body").append(n);let i=function e(t){if(t.offsetParent){let o=e(t.offsetParent);return{offsetTop:t.offsetTop+o.offsetTop,offsetLeft:t.offsetLeft+o.offsetLeft}}return{offsetTop:t.offsetTop,offsetLeft:t.offsetLeft}}(this);n.find(".ppa-main").css({top:i.offsetTop-196+"px",left:i.offsetLeft-113+"px"}),n.find(".ppa-authorLink").attr("href","/member.php?id="+t.attr("userId")),n.find(".ppa-authorImage").attr("src",t.attr("profileImageUrl")),n.find(".ppa-authorName").text(t.attr("userName")),o&&(n.find(".ppa-follow").get(0).outerHTML='<button type="button" class="ppa-follow followed" data-click-action="click" data-click-label="follow" style="padding: 9px 25px;line-height: 1;border: none;border-radius: 16px;font-size: 14px;font-weight: 700;cursor: pointer;">关注中</button>'),n.find(".ppa-follow").attr("userId",t.attr("userId")),n.on("mouseleave",(function(e){$(this).remove()})).on("mouseenter",(function(){$(this).addClass("mouseenter")})),n.find(".ppa-follow").on("click",(function(){let e=$(this).attr("userId");$(this).hasClass("followed")?$.ajax("https://www.pixiv.net/rpc_group_setting.php",{method:"POST",headers:{"x-csrf-token":g_csrfToken},data:"mode=del&type=bookuser&id="+e,success:function(e){DoLog(LogLevel.Info,"delete bookmark result: "),DoLog(LogLevel.Elements,e),"bookuser"==e.type?$(".ppa-follow").get(0).outerHTML='<button type="button"class="ppa-follow"style=" padding: 9px 25px; line-height: 1; border: none; border-radius: 16px; font-weight: 700; background-color: #0096fa; color: #fff; cursor: pointer;"><span style="margin-right: 4px;"><svg viewBox="0 0 8 8"width="10"height="10"class=""style=" stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 2;"><line x1="1"y1="4"x2="7"y2="4"></line><line x1="4"y1="1"x2="4"y2="7"></line></svg></span>关注</button>':DoLog(LogLevel.Error,"Delete follow failed!")}}):$.ajax("https://www.pixiv.net/bookmark_add.php",{method:"POST",headers:{"x-csrf-token":g_csrfToken},data:"mode=add&type=user&user_id="+e+"&tag=&restrict=0&format=json",success:function(e){DoLog(LogLevel.Info,"addBookmark result: "),DoLog(LogLevel.Elements,e),0===e.length?$(".ppa-follow").get(0).outerHTML='<button type="button" class="ppa-follow followed" data-click-action="click" data-click-label="follow" style="padding: 9px 25px;line-height: 1;border: none;border-radius: 16px;font-size: 14px;font-weight: 700;cursor: pointer;">关注中</button>':DoLog(LogLevel.Error,"Follow failed!")}})}))})).on("mouseleave",(function(e){setTimeout((function(){$(".pp-authorDiv").hasClass("mouseenter")||$(".pp-authorDiv").remove()}),200)})),0===i.length&&($(t).show().get(0).outerHTML='<div class=""style="display: flex;align-items: center;justify-content: center; height: 408px;flex-flow: column;"><div class=""style="margin-bottom: 12px;color: rgba(0, 0, 0, 0.16);"><svg viewBox="0 0 16 16"size="72"style="fill: currentcolor;height: 72px;vertical-align: middle;"><path d="M8.25739 9.1716C7.46696 9.69512 6.51908 10 5.5 10C2.73858 10 0.5 7.76142 0.5 5C0.5 2.23858 2.73858 0 5.5 0C8.26142 0 10.5 2.23858 10.5 5C10.5 6.01908 10.1951 6.96696 9.67161 7.75739L11.7071 9.79288C12.0976 10.1834 12.0976 10.8166 11.7071 11.2071C11.3166 11.5976 10.6834 11.5976 10.2929 11.2071L8.25739 9.1716ZM8.5 5C8.5 6.65685 7.15685 8 5.5 8C3.84315 8 2.5 6.65685 2.5 5C2.5 3.34315 3.84315 2 5.5 2C7.15685 2 8.5 3.34315 8.5 5Z"transform="translate(2.25 2.25)"fill-rule="evenodd"clip-rule="evenodd"></path></svg></div><span class="sc-LzMCO fLDUzU">'+Texts[g_language].sort_noWork.replace("%1",r)+"</span></div>"),$("#loading").remove(),$(t).show(),Pages[PageType.Search].ProcessPageElements(),$(document).keydown((function(e){if(1==g_settings.pageByKey)if(39==e.keyCode){let e=$(".pp-nextPage");if(e.length<1||"hidden"==e.attr("hidden"))return;location.href=e.attr("href")}else if(37==e.keyCode){let e=$(".pp-prevPage");if(e.length<1||"hidden"==e.attr("hidden"))return;location.href=e.attr("href")}})),e&&e()}))}}function PixivNS(e){function t(){let e=$("section:first").find("ul:first");return 0==e.length?(DoLog(LogLevel.Error,"Can not found novel list."),null):e}function o(){return location.search.substr(1).replace(/&?p=\d+/,"")}function n(e,t){if(null==e||null==t)return null;let n=e.find(".pns-link:first").attr("href").replace(/id=\d+/g,"id="+t.id);if(e.find(".pns-link").attr("href",n),e.find(".pns-img").attr("src",t.url),t.seriesId){let o=e.find(".pns-series").attr("href").replace(/\d+$/,t.seriesId);e.find(".pns-series").text(t.seriesTitle).attr("title",t.seriesTitle).attr("href",o)}else e.find(".pns-series").hide();e.find(".pns-title").text(t.title).attr("title",t.title),e.find(".pns-title").parent().attr("title",t.title);let i=e.find(".pns-author").attr("href").replace(/\d+$/,t.userId);e.find(".pns-author").text(t.userName).attr("href",i),e.find(".pns-author-img").attr("href",i).find("img").attr("src",t.profileImageUrl),e.find(".pns-text-count").text(t.textCount+"文字"),0==t.bookmarkCount?e.find(".pns-bookmark-div").hide():e.find(".pns-bookmark-count").text(t.bookmarkCount);let r=e.find(".pns-tag-list"),a=o();a.length>0&&(a="?"+a),$.each(t.tags,(function(e,t){let o=$('<span"><a style="color: rgb(61, 118, 153);" href="/tags/'+encodeURIComponent(t)+"/novels"+a+'">'+t+"</a></span>");"R-18"!=t&&"R-18G"!=t||o.find("a").css({color:"rgb(255, 64, 96)","font-weight":"bold"}).text(t),r.append(o)})),e.find(".pns-desc").html(t.description).attr("title",e.find(".pns-desc").text());let s=e.find(".pns-like");return s.attr("novel-id",t.id),t.bookmarkData&&(s.attr("bookmark-id",t.bookmarkData.id),s.find("path:first").css("color","rgb(255, 64, 96)"),s.find("path:last").css("fill","rgb(255, 64, 96)")),s.click((function(){if($(this).attr("disable"))return;let e=$(this).attr("bookmark-id"),t=$(this).attr("novel-id");e?function(e,t){if(""==g_csrfToken)return iLog.e("No g_csrfToken, failed to add bookmark!"),void alert("获取 Token 失败，无法添加，请到详情页操作。");e.attr("disable","disable"),iLog.i("delete bookmark: "+t),$.ajax("/ajax/novels/bookmarks/delete",{method:"POST",headers:{"x-csrf-token":g_csrfToken},data:{del:1,book_id:t},success:function(t){iLog.i("delete novel bookmark result: "),iLog.d(t),t.error?iLog.e("Server returned an error: "+t.message):(iLog.i("delete novel bookmark success"),e.removeAttr("bookmark-id"),e.find("path:first").css("color","rgb(31, 31, 31)"),e.find("path:last").css("fill","rgb(255, 255, 255)"),e.removeAttr("disable"))},error:function(){e.removeAttr("disable")}})}($(this),e):function(e,t,o){if(""==g_csrfToken)return iLog.e("No g_csrfToken, failed to add bookmark!"),void alert("获取 Token 失败，无法添加，请到详情页操作。");e.attr("disable","disable"),iLog.i("add bookmark: "+t),$.ajax("/ajax/novels/bookmarks/add",{method:"POST",contentType:"application/json;charset=utf-8",headers:{"x-csrf-token":g_csrfToken},data:'{"novel_id":"'+t+'","restrict":'+o+',"comment":"","tags":[]}',success:function(t){if(iLog.i("add novel bookmark result: "),iLog.d(t),t.error)return void iLog.e("Server returned an error: "+t.message);let o=t.body;iLog.i("Add novel bookmark success, bookmarkId is "+o),e.attr("bookmark-id",o),e.find("path:first").css("color","rgb(255, 64, 96)"),e.find("path:last").css("fill","rgb(255, 64, 96)"),e.removeAttr("disable")},error:function(){e.removeAttr("disable")}})}($(this),t,0),$(this).blur()})),g_settings.linkBlank&&e.find("a").attr("target","_blank"),e}function i(e,t,n,r){null==r&&(r=n-t);let a=location.origin+g_getNovelUrl.replace(/#key#/g,e).replace(/#page#/g,t),s=o();s.length>0&&(a+="&"+s),l(Texts[g_language].nsort_getWorks.replace("1%",r-n+t+1).replace("2%",r));let g=[];function p(o,a){o&&o.body&&o.body.novel&&o.body.novel.data&&(g=g.concat(o.body.novel.data)),t==n-1?a(g):i(e,t+1,n,r).then((function(e){e&&e.length>0&&(g=g.concat(e)),a(g)}))}return new Promise((function(e,o){$.ajax({url:a,success:function(t){p(t,e)},error:function(){DoLog(LogLevel.Error,"get novel page "+t+" failed!"),p(null,e)}})}))}function r(e){let o=t();if(null==o)return;let i=function(e){if(!e)return null;if(0==e.length)return DoLog(LogLevel.Error,"Empty list, can not create template."),null;let t=e.children().eq(0).clone(!0),o=t.children().eq(0).children().eq(0);o.find("a:first").addClass("pns-link"),o.find("img:first").addClass("pns-img");let n=t.children().eq(0).children().eq(1).children().eq(0),i=n.children().eq(0);if(i.children().length>1)i.children().eq(0).addClass("pns-series");else{let e=$('<a class="pns-series" href="/novel/series/000000"></a>');e.css({display:"inline-block","white-space":"nowrap","text-overflow":"ellipsis",overflow:"hidden","max-width":"100%","line-height":"22px","font-size":"14px","text-decoration":"none"}),$("head").append("<style>.pns-series:visited{color:rgb(173,173,173)}</style>"),i.prepend(e)}i.children().eq(1).children().eq(0).addClass("pns-title").addClass("pns-link"),n.find(".gtm-novel-searchpage-result-user:first").addClass("pns-author-img"),n.find(".gtm-novel-searchpage-result-user:last").addClass("pns-author");let r=n.children().eq(2).children().eq(0),a=r.children().eq(2);if(a.find("span:first").addClass("pns-text-count"),a.find("span").length<2){let e=a.find(".pns-text-count");e.append('<span class="pns-bookmark-count"><span><div class="sc-eoqmwo-1 grSeZG"><span class="sc-14heosd-0 gbNjEj"><svg viewBox="0 0 12 12" size="12" class="sc-14heosd-1 YtZop"><path fill-rule="evenodd" clip-rule="evenodd" d="M9 0.75C10.6569 0.75 12 2.09315 12 3.75C12 7.71703 7.33709 10.7126 6.23256 11.3666C6.08717 11.4526 5.91283 11.4526 5.76744 11.3666C4.6629 10.7126 0 7.71703 0 3.75C0 2.09315 1.34315 0.75 3 0.75C4.1265 0.75 5.33911 1.60202 6 2.66823C6.66089 1.60202 7.8735 0.75 9 0.75Z"></path></svg></span><span class="sc-eoqmwo-2 dfUmJJ">2,441</span></div></span></span>'),a.find(".pns-bookmark-count").addClass(e.get(0).className)}else a.find("span:last").addClass("pns-bookmark-count").parent().addClass("pns-bookmark-div");r.children().eq(0).empty().addClass("pns-tag-list"),r.children().eq(1).children().eq(0).addClass("pns-desc");let s=n.children().eq(2).children().eq(1),l=s.find("svg");return l.attr("class",l.attr("class")+" pns-like"),s.find("path:first").css("color","rgb(31, 31, 31)"),s.find("path:last").css("fill","rgb(255, 255, 255)"),t}(o);if(null==i)return;let r=[];$.each(e,(function(e,t){let o=n(i.clone(!0),t);null!=o&&r.push(o)})),o.empty(),$.each(r,(function(e,t){$(t).css("display","block"),o.append(t)})),s()}function a(){let e=t();null!=e?e.hide().before('<div id="loading" style="width:100%;text-align:center;"><img src="'+g_loadingImage+'" /><p id="progress" style="text-align: center;font-size: large;font-weight: bold;padding-top: 10px;">0%</p></div>'):iLog.e("Can not found novel section!")}function s(){let e=t();null!=e?($("#loading").remove(),e.show()):iLog.e("Can not found novel section!")}function l(e){$("#progress").text(e)}!function(){let e=function(){let e=location.pathname.match(/\/tags\/(.+)\/novels/);return e?e[1]:""}();if(0==e.length)return void DoLog(LogLevel.Error,"Parse key word error.");let t=function(){let e=location.search.match(/p=(\d+)/);return e?parseInt(e[1]):1}();if("off"==$(".gtm-novel-searchpage-gs-toggle-button").attr("data-gtm-label"))return a(),$(".gtm-novel-searchpage-gs-toggle-button").parent().next().text(),$("#loading").find("#progress").text('由于启用了 "'+$(".gtm-novel-searchpage-gs-toggle-button").parent().next().text()+'"，无法进行排序。'),void setTimeout((()=>s()),3e3);a(),function(){let e=Pages[PageType.NovelSearch].GetPageSelector();if(0==e.length)return void iLog.e("can not found page selector!");let t=e.find("a:first").clone().attr("aria-disabled","false").removeAttr("hidden").addClass("pp-prevPage"),o=e.find("a:last").clone().attr("aria-disabled","false").removeAttr("hidden").addClass("pp-nextPage"),n=e.find("a").eq(1).clone().removeAttr("href"),i=location.href,r=i.match(/[?&]p=(\d+)/),a=1;r?a=parseInt(r[1]):""==location.search?i+="?p=1":i+="&p=1",1==a&&t.attr("hidden","hidden"),e.empty();let s=a-g_settings.novelPageCount;t.attr("href",i.replace("?p="+a,"?p="+s).replace("&p="+a,"&p="+s)),e.append(t);let l="Previewer";for(let t=0;t<9;++t){let o=n.clone().text(l[t]);e.append(o)}let g=a+g_settings.novelPageCount;o.attr("href",i.replace("?p="+a,"?p="+g).replace("&p="+a,"&p="+g)),e.append(o)}(),$(document).keydown((function(e){if(1==g_settings.pageByKey)if(39==e.keyCode){let e=$(".pp-nextPage");if(e.length<1||"hidden"==e.attr("hidden"))return;location.href=e.attr("href")}else if(37==e.keyCode){let e=$(".pp-prevPage");if(e.length<1||"hidden"==e.attr("hidden"))return;location.href=e.attr("href")}})),i(e,t,t+g_settings.novelPageCount).then((function(e){r(function(e){l(Texts[g_language].nsort_sorting),e.sort((function(e,t){let o=e.bookmarkCount,n=t.bookmarkCount;return o||(o=0),n||(n=0),o>n?-1:o<n?1:0}));let t=[];return $.each(e,(function(e,o){let n=o.bookmarkCount;return n||(n=0),n<g_settings.novelFavFilter||!(!g_settings.novelHideFavorite||!o.bookmarkData)||void t.push(o)})),t}(e))}))}()}function SetLocalStorage(e,t){localStorage.setItem(e,JSON.stringify(t))}function GetLocalStorage(e){const t=localStorage.getItem(e);return t||null}function SetCookie(e,t,o){let n=180;o&&(n=o);let i=new Date;i.setTime(i.getTime()+24*n*60*60*1e3);let r=JSON.stringify(t);document.cookie=e+"="+r+";expires="+i.toGMTString()+";path=/"}function GetCookie(e){let t,o=new RegExp("(^| )"+e+"=([^;]*)(;|$)");return(t=document.cookie.match(o))?unescape(t[2]):null}function ShowInstallMessage(){$("#pp-bg").remove();let e=$('<div id="pp-bg"></div>').css({width:document.documentElement.clientWidth+"px",height:document.documentElement.clientHeight+"px",position:"fixed","z-index":999999,"background-color":"rgba(0,0,0,0.8)",left:"0px",top:"0px"});$("body").append(e),e.get(0).innerHTML='<img id="pps-close"src="https://pp-1252089172.cos.ap-chengdu.myqcloud.com/Close.png"style="position: absolute; right: 35px; top: 20px; width: 32px; height: 32px; cursor: pointer;"><div style="position: absolute;width: 40%;left: 30%;top: 25%;font-size: 25px; text-align: center; color: white;">'+Texts[g_language].install_title+g_version+"</div><br>"+Texts[g_language].install_body,$("#pps-close").click((function(){$("#pp-bg").remove()}))}function ShowUpgradeMessage(){$("#pp-bg").remove();let e=$('<div id="pp-bg"></div>').css({width:document.documentElement.clientWidth+"px",height:document.documentElement.clientHeight+"px",position:"fixed","z-index":999999,"background-color":"rgba(0,0,0,0.8)",left:"0px",top:"0px"});$("body").append(e);let t=Texts[g_language].upgrade_body;e.get(0).innerHTML='<img id="pps-close"src="https://pp-1252089172.cos.ap-chengdu.myqcloud.com/Close.png"style="position: absolute; right: 35px; top: 20px; width: 32px; height: 32px; cursor: pointer;"><div style="position: absolute;width: 40%;left: 30%;top: 25%;font-size: 25px; text-align: center; color: white;">'+Texts[g_language].install_title+g_version+'</div><br><div style="position:absolute;left:50%;top:30%;font-size:20px;color:white;transform:translate(-50%,0);height:50%;overflow:auto;">'+t+"</div>",$("#pps-close").click((function(){$("#pp-bg").remove()}))}function FillNewSetting(e){let t=!1;return $.each(g_defaultSettings,(function(o,n){null==e[o]&&(e[o]=g_defaultSettings[o],t=!0)})),{st:e,change:t}}function GetSettings(){let e,t=GetLocalStorage("PixivPreview")||GetCookie("PixivPreview");if(null==t||"null"==t)e=g_defaultSettings,SetLocalStorage("PixivPreview",e),ShowUpgradeMessage();else{e=JSON.parse(t);let o=FillNewSetting(e);o.change&&(e=o.st,SetLocalStorage("PixivPreview",e)),e.version!=g_version&&(ShowUpgradeMessage(),e.version=g_version,SetLocalStorage("PixivPreview",e))}return e}function ShowSetting(){let e=document.documentElement.clientWidth,t=document.documentElement.clientHeight;$("#pp-bg").remove();let o=$('<div id="pp-bg"></div>').css({width:e+"px",height:t+"px",position:"fixed","z-index":999999,"background-color":"rgba(0,0,0,0.8)",left:"0px",top:"0px"});$("body").append(o);let n=GetSettings(),i='<div style="color: white; font-size: 1em;"><img id="pps-close" src="https://pp-1252089172.cos.ap-chengdu.myqcloud.com/Close.png" style="position: absolute; right: 35px; top: 20px; width: 32px; height: 32px; cursor: pointer;"><div style="position: absolute; height: 60%; left: 50%; top: 10%; overflow-y: auto; transform: translate(-50%, 0%);"><ul id="pps-ul" style="list-style: none; padding: 0; margin: 0;"></ul></div><div style="margin-top: 10px;position: absolute;bottom: 10%;width: 100%;text-align: center;"><button id="pps-save" style="font-size: 25px; border-radius: 12px; height: 48px; min-width: 138px; max-width: 150px; background-color: green; color: white; margin: 0 32px 0 32px; cursor: pointer; border: none;">'+Texts[g_language].setting_save+'</button><button id="pps-reset" style="font-size: 25px; border-radius: 12px; height: 48px; min-width: 138px; max-width: 150px; background-color: darkred; color: white; margin: 0 32px 0 32px; cursor: pointer; border: none;">'+Texts[g_language].setting_reset+"</button></div></div>";o.get(0).innerHTML=i;let r=$("#pps-ul");function a(e){return'<img id="'+e+'" src="https://pp-1252089172.cos.ap-chengdu.myqcloud.com/On.png" style="height: 32px; cursor: pointer; margin-right: 20px; vertical-align: middle;"/>'}function s(e){return'<input id="'+e+'" style="font-size: 24px; padding: 0; margin-right: 16px; border-width: 0px; width: 64px; text-align: center;"/>'}function l(e,t){r.append('<li style="font-size: 25px; padding-bottom: 5px;">'+e+t+"</li>")}r.empty(),l('<select id="'+"pps-lang"+'" style="font-size: 20px; margin-right: 10px;"></select>',Texts[g_language].setting_language),l(a("pps-fullSizeThumb"),Texts[g_language].sort_fullSizeThumb),l("","&nbsp"),l(a("pps-preview"),Texts[g_language].setting_preview),l(a("pps-animePreview"),Texts[g_language].setting_animePreview),l(a("pps-anime"),Texts[g_language].setting_anime),l(a("pps-original"),Texts[g_language].setting_origin),l(s("pps-previewDelay"),Texts[g_language].setting_previewDelay),l(a("pps-previewByKey"),Texts[g_language].setting_previewByKey),$("#pps-previewByKey").attr("title",Texts[g_language].setting_previewByKeyHelp),l("","&nbsp"),l(a("pps-sort"),Texts[g_language].setting_sort),l(s("pps-maxPage"),Texts[g_language].setting_maxPage),l(s("pps-hideLess"),Texts[g_language].setting_hideWork),l(a("pps-hideAi"),Texts[g_language].setting_hideAiWork),l(a("pps-hideBookmarked"),Texts[g_language].setting_hideFav),l(a("pps-hideFollowed"),Texts[g_language].setting_hideFollowed+'&nbsp<button id="pps-clearFollowingCache" style="cursor:pointer;background-color:gold;border-radius:12px;border:none;font-size:20px;padding:3px 10px;" title="'+Texts[g_language].setting_clearFollowingCacheHelp+'">'+Texts[g_language].setting_clearFollowingCache+"</button>"),l(a("pps-hideByTag"),Texts[g_language].setting_hideByTag),l('<input id="pps-hideByTagList" style="font-size: 18px;padding: 0;border-width: 0px;text-align: center;width: 95%;" placeholder="'+Texts[g_language].setting_hideByTagPlaceholder+'">',""),l(a("pps-newTab"),Texts[g_language].setting_blank),l(a("pps-pageKey"),Texts[g_language].setting_turnPage),l("","&nbsp"),l(a("pps-novelSort"),Texts[g_language].setting_novelSort),l(s("pps-novelMaxPage"),Texts[g_language].setting_novelMaxPage),l(s("pps-novelHideWork"),Texts[g_language].setting_novelHideWork),l(a("pps-novelHideBookmarked"),Texts[g_language].setting_novelHideFav);let g="https://pp-1252089172.cos.ap-chengdu.myqcloud.com/On.png",p="https://pp-1252089172.cos.ap-chengdu.myqcloud.com/Off.png";$("#pps-preview").attr("src",n.enablePreview?g:p).addClass(n.enablePreview?"on":"off").css("cursor: pointer"),$("#pps-animePreview").attr("src",n.enableAnimePreview?g:p).addClass(n.enableAnimePreview?"on":"off").css("cursor: pointer"),$("#pps-sort").attr("src",n.enableSort?g:p).addClass(n.enableSort?"on":"off").css("cursor: pointer"),$("#pps-anime").attr("src",n.enableAnimeDownload?g:p).addClass(n.enableAnimeDownload?"on":"off").css("cursor: pointer"),$("#pps-original").attr("src",n.original?g:p).addClass(n.original?"on":"off").css("cursor: pointer"),$("#pps-previewDelay").val(n.previewDelay),$("#pps-previewByKey").attr("src",n.previewByKey?g:p).addClass(n.original?"on":"off").css("cursor: pointer"),$("#pps-maxPage").val(n.pageCount),$("#pps-hideLess").val(n.favFilter),$("#pps-hideAi").attr("src",n.aiFilter?g:p).addClass(n.aiFilter?"on":"off").css("cursor: pointer"),$("#pps-hideBookmarked").attr("src",n.hideFavorite?g:p).addClass(n.hideFavorite?"on":"off").css("cursor: pointer"),$("#pps-hideFollowed").attr("src",n.hideFollowed?g:p).addClass(n.hideFollowed?"on":"off").css("cursor: pointer"),$("#pps-hideByTag").attr("src",n.hideByTag?g:p).addClass(n.hideFollowed?"on":"off").css("cursor: pointer"),$("#pps-hideByTagList").val(n.hideByTagList),$("#pps-newTab").attr("src",n.linkBlank?g:p).addClass(n.linkBlank?"on":"off").css("cursor: pointer"),$("#pps-pageKey").attr("src",n.pageByKey?g:p).addClass(n.pageByKey?"on":"off").css("cursor: pointer"),$("#pps-fullSizeThumb").attr("src",n.fullSizeThumb?g:p).addClass(n.fullSizeThumb?"on":"off").css("cursor: pointer"),$("#pps-novelSort").attr("src",n.enableNovelSort?g:p).addClass(n.enableNovelSort?"on":"off").css("cursor: pointer"),$("#pps-novelMaxPage").val(n.novelPageCount),$("#pps-novelHideWork").val(n.novelFavFilter),$("#pps-novelHideBookmarked").attr("src",n.novelHideFavorite?g:p).addClass(n.novelHideFavorite?"on":"off").css("cursor: pointer"),$("#pps-lang").append('<option value="-1">Auto</option>').append('<option value="'+Lang.zh_CN+'">简体中文</option>').append('<option value="'+Lang.en_US+'">English</option>').append('<option value="'+Lang.ru_RU+'">Русский язык</option>').append('<option value="'+Lang.ja_JP+'">日本語</option>').val(null==g_settings.lang?Lang.auto:g_settings.lang),$("#pps-ul").find("img").click((function(){let e=$(this);e.hasClass("on")?e.attr("src",p).removeClass("on").addClass("off"):e.attr("src",g).removeClass("off").addClass("on")})),$("#pps-clearFollowingCache").click((function(){SetLocalStorage("followingOfUid-"+dataLayer[0].user_id,null,-1),alert(Texts[g_language].setting_followingCacheCleared)})),$("#pps-save").click((function(){""===$("#pps-maxPage").val()&&$("#pps-maxPage").val(g_defaultSettings.pageCount),""==$("#pps-hideLess").val()&&$("#pps-hideLess").val(g_defaultSettings.favFilter),SetLocalStorage("PixivPreview",{lang:$("#pps-lang").val(),enablePreview:$("#pps-preview").hasClass("on")?1:0,enableAnimePreview:$("#pps-animePreview").hasClass("on")?1:0,enableSort:$("#pps-sort").hasClass("on")?1:0,enableAnimeDownload:$("#pps-anime").hasClass("on")?1:0,original:$("#pps-original").hasClass("on")?1:0,previewDelay:parseInt($("#pps-previewDelay").val()),previewByKey:$("#pps-previewByKey").hasClass("on")?1:0,pageCount:parseInt($("#pps-maxPage").val()),favFilter:parseInt($("#pps-hideLess").val()),aiFilter:$("#pps-hideAi").hasClass("on")?1:0,hideFavorite:$("#pps-hideBookmarked").hasClass("on")?1:0,hideFollowed:$("#pps-hideFollowed").hasClass("on")?1:0,hideByTag:$("#pps-hideByTag").hasClass("on")?1:0,hideByTagList:$("#pps-hideByTagList").val(),linkBlank:$("#pps-newTab").hasClass("on")?1:0,pageByKey:$("#pps-pageKey").hasClass("on")?1:0,fullSizeThumb:$("#pps-fullSizeThumb").hasClass("on")?1:0,enableNovelSort:$("#pps-novelSort").hasClass("on")?1:0,novelPageCount:parseInt($("#pps-novelMaxPage").val()),novelFavFilter:parseInt($("#pps-novelHideWork").val()),novelHideFavorite:$("#pps-novelHideBookmarked").hasClass("on")?1:0,version:g_version}),location.href=location.href})),$("#pps-reset").click((function(){let e=Texts[g_language].setting_resetHint;confirm(e)&&(SetLocalStorage("PixivPreview",null),location.href=location.href)})),$("#pps-close").click((function(){$("#pp-bg").remove()}))}function SetTargetBlank(e){if(g_settings.linkBlank){let t=[];$.each(e.controlElements,(function(e,o){"A"==o.tagName&&t.push(o)})),$.each($(e.controlElements).find("a"),(function(e,o){t.push(o)})),$.each(t,(function(e,t){$(t).attr({target:"_blank",rel:"external"}),g_pageType!=PageType.Home&&g_pageType!=PageType.Member&&g_pageType!=PageType.Artwork&&g_pageType!=PageType.BookMarkNew||t.addEventListener("click",(function(e){e.stopPropagation()}))}))}}let loadInterval=null,itv=null;function AutoDetectLanguage(){if(g_language=Lang.auto,g_settings&&g_settings.lang&&(g_language=g_settings.lang),g_language==Lang.auto){let e=$("html").attr("lang");g_language=e&&-1!=e.indexOf("zh")?Lang.zh_CN:e&&-1!=e.indexOf("ja")?Lang.ja_JP:Lang.en_US}}function Load(){for(let e=0;e<PageType.PageTypeCount;e++)if(Pages[e].CheckUrl(location.href)){g_pageType=e;break}if(!(g_pageType>=0))return DoLog(LogLevel.Info,"Unsupported page."),void clearInterval(loadInterval);DoLog(LogLevel.Info,"Current page is "+Pages[g_pageType].PageTypeString);let e=Pages[g_pageType].GetToolBar();if(e){if(DoLog(LogLevel.Elements,e),clearInterval(loadInterval),window.onresize=function(){if($("#pp-bg").length>0){let e=document.documentElement.clientWidth,t=document.documentElement.clientHeight;$("#pp-bg").css({width:e+"px",height:t+"px"})}},AutoDetectLanguage(),g_settings=GetSettings(),AutoDetectLanguage(),0===$("#pp-sort").length&&!g_settings?.enableSort){const o=e.firstChild.cloneNode(!0);o.innerHTML="";const n=document.createElement("button");n.id="pp-sort",n.style.cssText="background-color: rgb(0, 0, 0); margin-top: 5px; opacity: 0.8; cursor: pointer; border: none; padding: 0px; border-radius: 24px; width: 48px; height: 48px;",n.innerHTML=`<span style="color: white;vertical-align: text-top;">${Texts[g_language].text_sort}</span>`,o.appendChild(n),e.appendChild(o),$(n).click((function(){this.disabled=!0,t(!0),setTimeout((()=>{this.disabled=!1}),7e3)}))}if(0===$("#pp-settings").length){const t=e.firstChild.cloneNode(!0);t.innerHTML="";const o=document.createElement("button");o.id="pp-settings",o.style.cssText="background-color: rgb(0, 0, 0); margin-top: 5px; opacity: 0.8; cursor: pointer; border: none; padding: 12px; border-radius: 24px; width: 48px; height: 48px;",o.innerHTML='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 1000 1000" enable-background="new 0 0 1000 1000" xml:space="preserve" style="fill: white;"><metadata> Svg Vector Icons : http://www.sfont.cn </metadata><g><path d="M377.5,500c0,67.7,54.8,122.5,122.5,122.5S622.5,567.7,622.5,500S567.7,377.5,500,377.5S377.5,432.3,377.5,500z"></path><path d="M990,546v-94.8L856.2,411c-8.9-35.8-23-69.4-41.6-100.2L879,186L812,119L689,185.2c-30.8-18.5-64.4-32.6-100.2-41.5L545.9,10h-94.8L411,143.8c-35.8,8.9-69.5,23-100.2,41.5L186.1,121l-67,66.9L185.2,311c-18.6,30.8-32.6,64.4-41.5,100.3L10,454v94.8L143.8,589c8.9,35.8,23,69.4,41.6,100.2L121,814l67,67l123-66.2c30.8,18.6,64.5,32.6,100.3,41.5L454,990h94.8L589,856.2c35.8-8.9,69.4-23,100.2-41.6L814,879l67-67l-66.2-123.1c18.6-30.7,32.6-64.4,41.5-100.2L990,546z M500,745c-135.3,0-245-109.7-245-245c0-135.3,109.7-245,245-245s245,109.7,245,245C745,635.3,635.3,745,500,745z"></path></g></svg>',t.appendChild(o),e.appendChild(t),$(o).click((function(){ShowSetting()}))}g_pageType!=PageType.Search&&g_pageType!=PageType.NovelSearch||$.get(location.href,(function(e){let t=e.match(/token":"([a-z0-9]{32})/);t.length>0?(g_csrfToken=t[1],DoLog(LogLevel.Info,"Got g_csrfToken: "+g_csrfToken)):DoLog(LogLevel.Error,"Can not get g_csrfToken, so you can not add works to bookmark when sorting has enabled.")})),itv=setInterval((function(){let e=Pages[g_pageType].ProcessPageElements();e.loadingComplete&&(DoLog(LogLevel.Info,"Process page comlete, sorting and prevewing begin."),DoLog(LogLevel.Elements,e),clearInterval(itv),SetTargetBlank(e),t())}),500)}else DoLog(LogLevel.Warning,"Get toolbar failed.");function t(e=!1){try{g_pageType==PageType.Artwork?(Pages[g_pageType].Work(),g_settings.enablePreview&&PixivPreview()):g_pageType==PageType.Search?g_settings.enableSort||e?(g_sortComplete=!1,PixivSK((function(){g_sortComplete=!0,g_settings.enablePreview&&PixivPreview()}))):g_settings.enablePreview&&PixivPreview():g_pageType==PageType.NovelSearch?(g_settings.enableNovelSort||e)&&PixivNS():g_settings.enablePreview&&PixivPreview()}catch(e){DoLog(LogLevel.Error,"Unknown error: "+e)}}}function startLoad(){loadInterval=setInterval(Load,1e3),setInterval((function(){if(location.href!=initialUrl){if(!g_sortComplete)return void(location.href=location.href);$(".pp-main").length>0&&$(".pp-main").remove(),initialUrl=location.href,clearInterval(loadInterval),clearInterval(itv),clearInterval(autoLoadInterval),autoLoadInterval=null,g_pageType=-1,loadInterval=setInterval(Load,300)}}),1e3)}let inChecking=!1,jqItv=setInterval((function(){inChecking||(inChecking=!0,checkJQuery().then((function(e){e&&(clearInterval(jqItv),startLoad()),inChecking=!1})))}),1e3);